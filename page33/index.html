<!DOCTYPE html>
<html lang="ru">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Ivan Grishaev's blog</title>
  <meta name="description" content="Writing on programming, education, books and negotiations.
">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/custom.css">
  <link rel="canonical" href="https://grishaev.me/page33/">
  <link rel="alternate" type="application/rss+xml" title="Ivan Grishaev's blog" href="https://grishaev.me/feed.xml">

  <link rel="shortcut icon" type="image/x-icon" href="/assets/static/favicons/favicon.ico">

  <script type="text/javascript" src="/assets/typo.js"></script>

</head>


  <body>
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-33533163-2', 'auto');
    ga('send', 'pageview');

</script>

    <header class="site-header">

    <div class="wrapper flex-container">

        <div>
            <a href="/">
                <img src="/assets/static/photo-round-small.png" alt="Ivan Grishaev">
            </a>
        </div>

        <div class="flex-container-vert" style="margin-left: 15px; width: 80%">

            <div class="flex-container full-width">
                <p style="margin-bottom: 5px">Ivan Grishaev's blog</p>
                <div class="flex-huge"></div>
                <div >
<form id="search-form"
      target="_blank"
      style="display: inline"
      method="get"
      action="https://www.google.com/search">

    <input name="sitesearch"
           value="grishaev.me"
           type="hidden">

    <input type="text"
           required="required"
           name="q"
           placeholder="Google search..."
           autocomplete="off">

    <button style="border: none; background-color: transparent; cursor: pointer;"
            type="submit">&#x1f50d;</button>

</form>
</div>
            </div>

            <p><small>Writing on programming, education, books and negotiations.
</small></p>

            <div class="flex-container">
                <a class="menu-item" href="/">Home</a>
                <a class="menu-item" href="/about/">About</a>
                <a class="menu-item" href="/bookshelf/">Bookshelf</a>
                <a class="menu-item" href="/feed.xml">RSS</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor" href="/tag/clojure/">Clojure</a>
                <a class="menu-item minor" href="/tag/emacs/">Emacs</a>
                <a class="menu-item minor" href="/tag/python/">Python</a>
                <a class="menu-item minor" href="/tag/programming/">Programming</a>
                <a class="menu-item minor" href="/interview/">Interview</a>
                <a class="menu-item minor" href="/video/">Video</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor hl" href="/clojure-in-prod/">Книга «Clojure на производстве»</a>
            </div>

        </div>
    </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="home">

    <ul class="post-list">
        
        <li>

            <h2>
                <a class="post-link" href="/telegram/">Телеграм</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2016-06-20T00:00:00+00:00">
        Jun 20, 2016
    </time>

    <a href="/tag/telegram/" rel="tag">telegram</a>

</div>


            <div class="entry">
                
                    <p>Ох уж этот Телеграм. Все чаще разыгрывается сцена:</p>

<p>– Такую ссылку прислали в телеграме, ржака! добавь в друзья, скину</p>

<p>– У меня нет телеграма.</p>

<p>– А че так, у всех же есть?</p>

<p>– Не хочу.</p>

<p>– Почему?</p>

<p>Это пост-ответ. Если коротко – все меседжеры говно и отстой. Использование
любого – необходимое зло, которое нужно минимизировать.</p>

<p>Меседжер отвлекает нотификациями. Каждая программа считает долгом уведомить о
новом сообщении. У меня почти все нотификации выключены. Знаю людей, у которых
пачка алертов загораживает половину экрана, а им нормально. Из динамика
постоянное квакание, пикание. Такой расклад снижает продуктивность вдвое.</p>

<p>В хороших фирмах, например, Студии Лебедева или Мосигре меседжеры
запрещены. Нужно спросить – пиши письмо или двигай булками в соседний
кабинет. Совсем срочно – звони.</p>

<p>Устанавливая новый месаджер, мы не удаляем старые. Я бы с радостью снес Скайп,
но не могу, потому что кое-кто мне еще в него пишет. Зачем ставить еще что-то
новое? Была проблема, стало две проблемы.</p>

<p>Почти у всех программ проблема с историей. Она либо пропадает, либо тормозит
так, что проматывать невозможно.</p>

<p>Меседжеров развелось как грибов после дождя, потому что это модно и технически
не сложно. Ни один из них не прошел должную выдежку временем лет в 10-15, как
Линукс, Си, Лисп, Питон, Хаскел.</p>

<p>Администрация меседжеров кладет на безопасность, потому что никого это не
интересует. Безопасность не несет денег, только если это не главная цель
продукта. Если у компании есть выбор, на что потратить усилия команды – на
закрытие дыры или на улучшенный обмен фоточками, выберут второе.</p>

<p>В Скайпе есть дыры, которые живут годами. У людей уводят аккаунты и шантажируют
владельцев, а техподдержка отписывает стандартные шаблоны.</p>

<p>Главная проблема меседжеров в том, что любой из них – сеть с единым центральным
узлом. Датацентров может быть несколько, но это ничего не меняет. Технология
закрыта, есть один монополист. Никто не может поставить свой сервер с телеграмом
и общаться как ему вздумается.</p>

<p>Давайте на минуту представим, что только одна фирма в мире имеет право
производить телевизоры и что-то транслировать. И еще одна фирма, чтобы делать
телефоны и передавать голос по проводам. А третья фирма владеет патентом на
супер-секретный протокол обмена почтой, и все почтовые сервера в мире – ее.</p>

<p>Меседжеры так и работают. Ты можешь написать сообщение другу используя только
наше тормозное ПО, только по нашему бинарному протоколу, только через наш
дата-центр. Бред же.</p>

<p>Отдельно про Телеграм, чтоб еще раз не вставать.</p>

<p>Телеграм – очередной меседжер, и только. Да, он работает лучше, быстрее, и в
целом учел некоторые ошибки предшественников.</p>

<p>Но.</p>

<p>Это единый центр передачи сообщений. В случае сбоя вы не сможете ни с кем
общаться. Я пишу это в то время, когда Слак не работает в России уже часа 3. А
как Скайп на сутки ложился, помните?</p>

<p>Безопасность? Во-первых, о чем можно говорить, если нет исходного
кода. Во-вторых, телеграм зарегистрирован в Панаме и обязан соблюдать законы
этого государства. В том числе выдавать данные о пользователях по запросам
властей.</p>

<p>Телеграм зависит от операторов сотовой связи, потому что делает ставку на
телефон. Опсосы без проблем сливают данные абонентов органам.</p>

<p>Этот Дуровский пафос! Еще будучи в ВК, Павел любил рассказы о свободе слова и
честных судах. А в это время аккаунты оппозиционеров ломали пачками с
привлечением администраторов.</p>

<p>Примеры хороших распределенных систем – электронная почта, Тор, Биткоин,
торренты, Эрланг. Возможно, люди, стоявшие у их истоков, не стали богачами, но
точно продвинули прогресс вперед.</p>

<p>Они, а не дирекция еще одной программы коротких сообщений.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/cookies/">Подтвеждение кук</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2016-06-20T00:00:00+00:00">
        Jun 20, 2016
    </time>

    <a href="/tag/cookies/" rel="tag">cookies</a>, <a href="/tag/idiots/" rel="tag">idiots</a>

</div>


            <div class="entry">
                
                    <p>В интернете новая болезнь. Сайты уведомляют, что намерены прислать куки и
спрашивает, согласен ли я. Не знаю, кто это выдумал и внедрил, но у тех людей
рак мозга.</p>

<p>Интернет существует лет эдак 30, и все это время сервера спокойно отправляли
куки. Поздно вы, ребята, спохватились! Уведомление об отправке кук выглядит так
же дико, как уведомление о загрузке изображений.</p>

<p>Понятие кук носит технический характер и не имеет отношения к потребителю. Зашел
американец на новостной сайт почитать о выходках Трампа – а ему плашка на весь
экран. Подтверди прием кук. Это же свинство. Куки совершенно не в мире
потребителя.</p>

<p>Запрос о куках плох тем, что сайт выполняет не свою работу. Контроллировать куки
должен браузер. В любом современном браузере можно настроить правила. С каких
сайтов принимать, с каких нет, а где спрашивать подтверждения. Заинтересованный
человек настроит самостоятельно.</p>

<p>Если я нажму “не принимать”, то как удаленный сервер запомнит мой выбор?
Правильно – положит мне куку со значеним “не принимать”. То есть нарушит
обещание! Или запишет флаг в localStorage, что одно и то же.</p>

<p>Несколько выводов из абзацев выше:</p>

<ul>
  <li>Не нужно грузить людей ложной заботой о безопасности.</li>
  <li>Не стоит влезать в чужую зону ответственности.</li>
  <li>Нарушение этих правил приводит ко лжи.</li>
</ul>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/emacs-story/">Рассказ о Емаксе</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2016-06-11T00:00:00+00:00">
        Jun 11, 2016
    </time>

    <a href="/tag/emacs/" rel="tag">emacs</a>

</div>


            <div class="entry">
                
                    <p>В прошлый четверг <a href="/hexlet-emacs">я рассказывал</a> аудитории Хекслета про
Емакс. Представляю читателям блога скомпилированную версию выступления. Рассказ
пересекается с <a href="/emacs">прошлой заметкой</a> о Емаксе.</p>

<p>Сказанное ниже носит общий характер. Это не мануал и не инструкция с шагами что
скачать и куда положить. За этими вопросами пройдите по ссылкам в конце.</p>

<p><img src="/assets/static/emacs/throne.jpg" alt="throne" /></p>

<p><em>Кадр из фильма Трон: наследие. Хакер взламывает кого-то при помощи Емакса. Ему
помогают запущенный тетрис и игра-головоломка о перестановке пирамиды.</em></p>

<h2>

    Содержание

</h2>

<ul id="toc-item-emacs-story">
  <li><a href="#историческая-часть" id="toc-item-emacs-story-историческая-часть">Историческая часть</a></li>
  <li><a href="#отличие-от-вима" id="toc-item-emacs-story-отличие-от-вима">Отличие от Вима</a></li>
  <li><a href="#философия-емакса" id="toc-item-emacs-story-философия-емакса">Философия Емакса</a></li>
  <li><a href="#недостатки-когда-не-следует-использовать-емакс" id="toc-item-emacs-story-недостатки-когда-не-следует-использовать-емакс">Недостатки. Когда не следует использовать Емакс</a></li>
  <li><a href="#достоинства" id="toc-item-emacs-story-достоинства">Достоинства</a></li>
  <li><a href="#как-я-переходил-на-емакс-трудности-мотивация" id="toc-item-emacs-story-как-я-переходил-на-емакс-трудности-мотивация">Как я переходил на Емакс. Трудности, мотивация</a></li>
  <li><a href="#установка" id="toc-item-emacs-story-установка">Установка</a></li>
  <li><a href="#основные-положения" id="toc-item-emacs-story-основные-положения">Основные положения</a></li>
  <li><a href="#конфигурирование" id="toc-item-emacs-story-конфигурирование">Конфигурирование</a></li>
  <li><a href="#коротко-о-пакетах" id="toc-item-emacs-story-коротко-о-пакетах">Коротко о пакетах</a></li>
  <li><a href="#сборки-форки" id="toc-item-emacs-story-сборки-форки">Сборки, форки</a></li>
  <li><a href="#для-чего-я-использую-емакс" id="toc-item-emacs-story-для-чего-я-использую-емакс">Для чего я использую Емакс</a></li>
  <li><a href="#ресурсы" id="toc-item-emacs-story-ресурсы">Ресурсы</a></li>
</ul>

<h3 id="историческая-часть">Историческая часть</h3>

<p>Емакс – это старенький текстовый редактор. Ричард Столлман начал работать над
ним примерно 40 лет назад. Задумайтесь, как это много – больше, чем средний
возраст популярных ресурсов. Емакс – одна из самых старых программ в
айти-индустрии и все еще остается в строю.</p>

<p>Первоначально это были отдельные скрипты на Лиспе для операций с текстом. Позже
Столлман оформил их в отдельную программу. Емакс состоит из двух частей. Это
маленькое ядро, написанное на Си. Ядро отвечает за ввод-вывод и отрисовку
окон. Вторая часть – код на Лиспе для манипуляции с текстом.</p>

<p>В Емаксе используется собственный диалект Лиспа, называемый Elisp (не путать с
EMACS Lisp – это совсем другой диалект). Столлман отверг Common Lisp как
излишне усложненный диалект, а Scheme – как недостаточно мощный. Так появилась
своя реализация.</p>

<p>Технически Elisp имеет серьезные ограничения – никакой многопоточности, нет
хвостовой рекурсии, трудности с замыканиями. Производительность его очень
невысока, примерно как Питон или Руби старых версий. Однако, даже при всех
недостатках языка в нем можно творить потрясные вещи – редактировать код,
управлять процессами, читать новости, RSS, играть в игры и так далее.</p>

<p>Известная шутка о том, что емакс – это операционная система, в которой нет
нормального редактора, косвенно права. Емакс можно рассматривать как рантайм
программ, написанных на ELisp. Примерно как Хром – среда исполнения
Джаваскрипта.</p>

<p>Емакс обязан успехом исключительно Лиспу. Многие пакеты были написаны 10-20 лет
назад, но по-прежнему разрабатываются, проходят рефакторинг.</p>

<p>Подобно Лиспу, у Емакса есть форки и ответвления. Так, в девяностых годах
обанкротилась компания Lucid, программисты которой использовали Емакс. Они
взрастили внутри компании независимую версию редактора. Случилось так, что
разработчики не договорились о правах и лицензиях. Так появился XEmacs – своего
рода улучшенный Емакс. О форках я расскажу ниже.</p>

<p>Подведя черту, можно сказать, что Емакс прошел сорокалетний путь развития и
активно используется программистами сегодня. За этот срок написаны сотни статей,
десятки книг и мануалов. Начать пользоваться Емаксом легко – в него встроен
хороший туториал, на борту большой раздел документации.</p>

<h3 id="отличие-от-вима">Отличие от Вима</h3>

<p>Эти два редактора часто сравнивают друг с другом. Между ними много общего, но
есть и расхождения. Так, оба редактора поощряют отказ от мыши, слепой набор,
автоматизацию действий, не привязывают к конкретному языку, как ИДЕ.</p>

<p>Различия скорее идеологические. Вим следует философии Юникса, стараясь делать
одну задачу, но хорошо – редактировать текст. За счет режимов и общей механике
большинство операций в Виме делаются быстрее. В каждом режиме клавиша имеет
разную функцию. Комбинации становятся емче, нужно меньше клавиш, чтобы задать
комбо.</p>

<p>В Емаксе нет режимов из коробки, поэтому комбинации нуждаются в дополнительных
клавишах (Комманд и Мета), чтобы различать ввод текста и команды. Это делает
комбинации не такими быстрыми в наборе.</p>

<p>Емакс не ограничивает себя только набором текста, наоборот – берет на себя
самые разнообразные задачи, иной раз абсурдные. Каждый должен сам провести грань
– что отдавать на откуп Емаксу, а что – системным утилитам.</p>

<p>Субъективно, Емакс пребывает в более вменяемом состоянии, чем Вим. В сообществе
последнего сильны настроения в духе “взять все и переписать”. В Емаксе такого
нет. Существуют Емакс-пакеты, которые очень точно воспроизводят принципы работы
Вима – режимы, комбинации, исполнение Вим-скриптов.</p>

<h3 id="философия-емакса">Философия Емакса</h3>

<p>Емакс создавался для того, чтобы редактировать текстовые файлы. Однако из-за
Лиспа и развитой подсистемы ввода-вывода вышло так, что Емакс прекрасно работает
с текстом в широком смысле, неважно откуда он поступает.</p>

<p>Это значит, Емакс одинаково хорошо обработает текст, который пришел из сети или
от стороннего процесса. Поскольку в Юникс-среде основной способ передачи
информации – текст, Емакс хорошо подходит для интеграции с системой. Само
собой вышло так, что в Емаксе можно выполнять разные задачи, которые только
косвенно связаны с текстом.</p>

<h3 id="недостатки-когда-не-следует-использовать-емакс">Недостатки. Когда не следует использовать Емакс</h3>

<p>Емакс не идеален. Вот в каких случаях я не рекомендую его использовать.</p>

<ul>
  <li>
    <p>Вам нужен редактор для разовых нужд, в основном копи-пасты. В этом случае
прекрасно подойдет Саблайм.</p>
  </li>
  <li>
    <p>Вы пишете на языке-платформе, неотделимой от ИДЕ. Например, C# или
Java. Пытаться доработать любой другой редактор бессмысленно.</p>
  </li>
  <li>
    <p>Порог входа выше, чем у стандартных редакторов.</p>
  </li>
  <li>
    <p>Для комфортной работы редактор нужно настроить. Настройка может длиться
годами. Главное – не увлекаться.</p>
  </li>
</ul>

<h3 id="достоинства">Достоинства</h3>

<ul>
  <li>
    <p>Работает в разной степени со всеми известными языками и технологиями.</p>
  </li>
  <li>
    <p>Очень гибкая система обработки текста</p>
  </li>
  <li>
    <p>Мощная поддержка процессов. Простота интеграции с любым системным процессом
или утилитой, например, git, docker, psql, grep, ls и т.д.</p>
  </li>
  <li>
    <p>Конфигурирование всего и вся</p>
  </li>
  <li>
    <p>Встроенный терминал, ssh-клиент, почтовик, браузер и масса других утилит</p>
  </li>
  <li>
    <p>Золотые хиты детства – змейка, тетрис! <code class="language-plaintext highlighter-rouge">M-x snake</code> и <code class="language-plaintext highlighter-rouge">M-x tetris</code></p>
  </li>
  <li>
    <p>Единообразие. Каждый буфер, неважно, файл это или список процессов,
подчиняется основным правилам навигации и поиска. Например, вы выполнили поиск
в файле, открылся новый буфер с результатами. Теперь вы можете искать в буфере
результатов, словно в файле! В любом буфере, неважно, файл это или что-то
другое, можно настроить правила подсветки строк. Везде одинаковая навигация,
копирование и вставка. Это дико удобно. Напротив, в стандартных ИДЕ каждое
окно живет по своим особым правилам.</p>
  </li>
</ul>

<h3 id="как-я-переходил-на-емакс-трудности-мотивация">Как я переходил на Емакс. Трудности, мотивация</h3>

<p>Я работаю в Емаксе третий год. Расскажу, как как пришел в него и с какими
трудностями столкнулся.</p>

<p><a href="/assets/static/emacs/emacs.png"><img src="/assets/static/emacs/emacs.png" alt="emacs" /></a></p>

<p><em>Мой Емакс сегодня. По клику большая версия. Слева – дерево файлов, посередине
– эта статья в процессе подготовки, справа – код на Схеме.</em></p>

<p>Давно я использовал Пайчарм, поскольку основной мой язык – Питон. Затем
переключился на Саблайм. Довольно быстро раскачал его плагинами и работал на
равных с теми, остался в ИДЕ.</p>

<p>Зачем нужен был этот дауншифт? Пытался обозначить список необходимых
вещей. Когда у тебя комбайн с сотней функций, трудно понять, что именно из этого
нужно. Принцип минимализма – убираем все, затем понемногу добавляем нужное.</p>

<p>В случае с Саблаймом выяснилось, что для комфортной работы достаточно 5-6
модулей для нескольких языков, интеграции с SVN и Git. Саблайм я до сих пор
считаю программой высочайшего уровня и рекомендую как легкую замену ИДЕ.</p>

<p>Но вот что беспокоило – все авторитетные для меня инженеры работали либо в
Виме, либо в Емаксе. Причем вообще без вариантов (чаще – в Емаксе, но не
суть). Это легко выяснить из интервью, статей, или просто посмотреть dotfiles на
Гитхабе. Так, Емаксом пользуются Гвидо ван Россум (создатель Питона), Джо
Армстронг (Эрланга) , Линус Торвальдс (линукса и Гита), Тед Дзюба
(предприниматель из Долины). Армин Ронахер, чей вклад в Питон неоценим,
используем Вим.</p>

<p>Полагаю, у названных людей есть деньги чтобы купить лицензии на нужные ИДЕ, но
они этого не делают. Линус как-то сказал, что готов купить любую ИДЕ, но его
пальцы уже нельзя переучить после 20 лет Емакса. Гвидо положительно отзывался о
Пайчарме, но добавил, что опять пришел к связке Емакс + pdb (самый базовый
отладчик).</p>

<p>Я пришел к нескольким выводам. Во-первых, ИДЕ действительно помогает на раннем
этапе карьеры. Но на уровне упомянутых программистов это уже не играет особой
роли. Они создали языки и компиляторы без коммерческих средств с месячной
подпиской.</p>

<p>Во-вторых, ИДЕ – это прежде всего бизнес. Адепты Джет-Брейнс расскажут, что без
ИДЕ код пишется плохо, нарушаются бизнес-процессы и страдает бизнес. Их позиция
ясна.</p>

<p>Как показывает практика, компания оставляет за собой право сменить
лицензию. Недавняя шумиха вокруг Джет-Брейнс это доказывает. Я положительно
воспринимаю идею платной подписки, но лишь для тех вещей, которые работают как
черный ящик. Например, Фотошоп и облачные хранилища. Но текстовый редактор –
последний рубеж. Он должен быть всецело моим, и точка.</p>

<p>Наконец, бывают особо критичные случаи, когда без ИДЕ человек оказывается
совершенно проф-непригоден. Один коллега в проекте впал в амнезию, когда Пайчарм
не смог открыть по клику исходники одного хитрого модуля. Другие не мыслят себя
без подсветки и автодополнения. Это полезные вещи, но плохо, когда они
становятся зависимостью.</p>

<p>Я решил переходить на Вим или Емакс, чтобы повысить уровень.</p>

<p>Если коротко, с Вимом не пошло. Занимался им две недели, было страшно
медленно. К концу второй недели я более-менее им овладел, но отходняк был
тяжелый. У меня нет никаких претензий, возможно, я что-то не так делал или
взялся за слишком трудные мануалы. По крайней мере, выучил основные команды и
могу править конфиги на серверах. В будущем планирую второй заход в Вим.</p>

<p>Напротив, с Емаксом пошло проще. Возможно, благодаря <code class="language-plaintext highlighter-rouge">cua-mode</code>. Это такой режим
для новичков, когда основные команды вроде копирования и вставки работают как в
классический редакторах. Долгое время я, за годы привыкший к <code class="language-plaintext highlighter-rouge">Ctrl-X/C/V</code>,
использовал эти же комбинации. Потом перешел на общепринятые в Емаксе.</p>

<h3 id="установка">Установка</h3>

<ul>
  <li>
    <p>Для Мака. Либо <a href="https://emacsformacosx.com/">скачать графическую версию</a>, либо
поставить консольную версию из brew, предварительно обновив формулы.</p>
  </li>
  <li>
    <p>Для линукса. Из пакетов: apt-get, yum.</p>
  </li>
  <li>
    <p>Для Винды. <a href="https://ftp.gnu.org/gnu/emacs/windows/">Скачать бинарники</a>. На
винде осложнения в том, что Емакс нуждается в стандартных Юникс-утилитах ps,
grep, find. Понадобится какой-нибудь Cygwin или аналог.</p>
  </li>
</ul>

<p>Пакет для интеграции с Гитом под названием magit требует Емакс не ниже 24.4. Это
не очень хорошо, так как в старых Убунтах в пакетах указан 24.3. Приходится
заморачиваться со сторонними репозиториями. Для начинающих это неважно.</p>

<h3 id="основные-положения">Основные положения</h3>

<p>Главная смысловая единица в Емаксе – буфер. Это место, где какой-то
текст. Буфер может быть связан с файлом. Буфер произошел от принципа работы с
данными на лентах. Писать каждое изменения на ленту – страшно медленно. Поэтому
считывали данные в память, обрабатывали и записывали поверх.</p>

<p>Буфер может и не быть связан с файлом. Например, это список процессов, результат
поиска в текущем буфере, греп по директории, список файлов, JSON из какого-то
урла, интерактивная справка и так далее.</p>

<p>В момент старта Емакса появляются три стандартных буфера. Это приветствие со
ссылками на документацию. Потом буфер сообщений, своего рода лог. И буфер
scratch для копипасты.</p>

<p>Этот последний буфер особый – в нем можно выполнить любой код на Лиспе и сразу
проверить, какой эффект имеет этот код.</p>

<p>В Емаксе используют особые сокращения для клавиш. C (командная клавиша) означает
Контрол, M (мета-клавиша) означает Альт. Дефис означает одновременное
нажатие. Важно помнить, что 40 лет назад клавиатуры были другие, и клавиша
Command располагалась рядом с пробелом, как сегодня на Маке. Так что Столлман не
виноват!</p>

<p><img src="/assets/static/emacs/keyboard.jpg" alt="keyboard" /></p>

<p><em>Клавиатура тех дней. Обратите внимание на расположение служебных клавиш.</em></p>

<p>Примеры:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">C-x b</code> – нажать вместе Контрол и x, потом b – сменить буфер.</li>
  <li><code class="language-plaintext highlighter-rouge">C-x C-f</code> – нажать одновременно Контрол и x, потом одновременно Контрол и f
– открыть файл.</li>
  <li><code class="language-plaintext highlighter-rouge">M-g g</code> – нажать вместе Альт и g, потом еще раз g – переход на нужную строку
текущего буфера (система спросит номер).</li>
</ul>

<p>Нажатие <code class="language-plaintext highlighter-rouge">C-g</code> прерывает ввод текущей команды.</p>

<p>Комбинаций великое множество: одна только навигация по тексту насчитывает
несколько десятков, а есть еще манипуляции с регистром, параграфами, логической
структурой, специфичные для пакетов операции.</p>

<p>Не нужно стараться запомнить все сразу, это придет постепенно.</p>

<p>Чтобы эффективно работать в Емаксе, желательно освоить две вещи, о которых
упоминал Кирилл в вебинаре по Виму. Первое – перенести клавишу Контрол на
Капс. Это необходимо и вообще не обсуждается. Если нажимать ее в стандартном
положении, рука отвалится из-за сильного напряжения в кисти.</p>

<p>Как сделать это в Маке, <a href="/2015/10/08/2/">я уже писал</a> раньше.</p>

<p>Второе – займитесь слепой печатью. Зайдите на сайт
<a href="http://www.keybr.com/">онлайн-тренажера</a>. Зарегистрируйтесь через соц.сеть,
чтобы накапливалась статистика. Каждый день утром 15 минут печатайте
вслепую. Сначала будет бесить, но статистика покажет медленное продвижение, и
это классно. Вы должны как можно скорее избавиться от стрелочек и пользоваться
только центральной частью клавиатуры.</p>

<p><img src="/assets/static/emacs/chart.png" alt="chart" /></p>

<p><em>Один из графиков моего профиля. Он показывает, что скорость набора медленно, но
растет.</em></p>

<p>В Емаксе нет табов для открытых файлов. Это шокирует тех, кто только начал с ним
работать. Дело в том, что табы не нужны. Когда вы долго работаете, сами по себе
накапливаются открытые буферы (как мы уже знаем, в Емаксе это не только
файлы). Я никогда не выключаю ноут, а только погружаю в сон. К концу второго
месяца в Емаксе примерно 400 буферов. Представьте, что для каждого был бы таб. Я
бы просто ничего не видел из-за них.</p>

<p>Кстати, любителям ИДЕ посвящается – откройте 400 файлов и проверьте, как
поведет себя система. У моего коллеги ноут грелся так, что обжигало руку. А
Емакс потребляет 100 Мб памяти и 10% процессора.</p>

<p>Удивительно, но основные комбинации для перемещения по тексту работают много где
за пределами Емакса – например, в Хроме, почтовом агенте Мака. В Баше по
умолчанию включена раскладка Емакса.</p>

<h3 id="конфигурирование">Конфигурирование</h3>

<p>В Емаксе настраивается все что только возможно. Существует бесконечное число
конфигов, пресетов, сборок, потому что каждый делает это под себя. У опытных
разработчиков на Гитхабе обязательно есть репозиторий с настройками редактора.</p>

<p>Не стоит допускать ошибку и разу ставить сторонние конфиги с кучей пакетов.  Вы
должны понимать, что происходит и как этим управлять. Вы должны знать назначение
каждой строчки вашего конфига. Поэтому оптимальный путь – начать с нуля,
постепенно наращивая конфиг, как жемчужину.</p>

<p>Конфиг в Емаксе – это файл с лисп-кодом. Внутри устанавливаются переменные,
вызываются команды и подключаются пакеты. Как правило, пакеты берут всю работу
на себя, нужно лишь задать им правильные настройки (флаги, пути).</p>

<p>При старте Емакс ищет файл <code class="language-plaintext highlighter-rouge">~/.emacs</code> . Затем – <code class="language-plaintext highlighter-rouge">~/.emacs.d/init.el</code>. <code class="language-plaintext highlighter-rouge">.el</code> –
расширение файлов на Elisp. Обратите внимание, что первый файл не содержит
расширения в имени.</p>

<p>Конфигурация не должна быть завязана на конкретную машину или файловые
пути. Желательно писать ее так, чтобы было легко перенести. Как только она
превысит десять строк, выносите в Гитхаб. Добавьте мейк-файл или шелл-скрипт,
чтобы развернуть ее парой команд.</p>

<p>Вот как ставится моя конфигурация:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Скачать репозиторий куда-то себе</span>
git clone https://github.com/igrishaev/dotfiles.git ~/somewhere

<span class="c"># скопировать папку .emacs.d в домашнюю директорию</span>
<span class="nb">cp</span> <span class="nt">-r</span> ~/somewhere/.emacs.d ~/

<span class="c"># перейти внутрь</span>
<span class="nb">cd</span> ~/.emacs.d

<span class="c"># поставить утилиту Cask</span>
make install-cask

<span class="c"># установить пакеты, перечисленные в cask-файле.</span>
<span class="c"># переменную EMACS нужно задать, если у вас в системе несколько емаксов</span>
<span class="nv">EMACS</span><span class="o">=</span>/path/to/bin/emacs make install-packages
</code></pre></div></div>

<p>Я терпеть не могу длинных навороченных конфигураций со многими файлами. При
малейших обновлениях они ломаются. Конфигурация должна быть максимально
декларативной. Только список необходимых пакетов и установка переменных.</p>

<h3 id="коротко-о-пакетах">Коротко о пакетах</h3>

<p>Для емакса написаны тысячи пакетов, некоторые из которых тянут на полноценные
приложения, исполняемые внутри Лисп-машины.</p>

<p>Пакеты хостятся в репозиториях, у которых следующие имена – <code class="language-plaintext highlighter-rouge">GNU, Melpa,
Marmelade</code>. Как правило, в конфиге указывают их все. Стандартный менеджер
пакетов из поставки Емакса может устанавливать из репозиториев, но не умеет
разруливать зависимости. Поэтому используют либо пакет el-get, либо утилиту
Cask, как в моем случае. Это утилита на Питоне для сопровождения проектов на
ELisp. В ней много всего, в том числе установка зависимостей. Она переопределяет
стандартный менеджер пакетов. Вы пользуетесь как будто стандартным.</p>

<p>Основные пакеты для Емакса без привязки к конкретным языкам:</p>

<ul>
  <li><a href="https://github.com/magit/magit">magit</a> – Интеграция с Гитом</li>
  <li><a href="https://github.com/ancane/emacs-nav">nav</a> – Панель файловой навигации</li>
  <li><a href="https://github.com/auto-complete/auto-complete">auto-complete</a> –
Автодополнение из разных источников</li>
  <li><a href="https://github.com/flycheck/flycheck">flycheck</a> – проверка синтаксиса для
разных языков. Обычно нужен сабмодуль для конкретного языка</li>
  <li><a href="https://github.com/defunkt/markdown-mode">markdown-mode</a> – Маркдаун</li>
  <li><a href="https://github.com/TeMPOraL/nyan-mode">nyan-mode</a> – Нян-кот в твоем Емаксе!</li>
  <li><a href="https://github.com/rolandwalker/simpleclip">simpleclip</a> – Облегчает работу с
системным буфером обмена</li>
  <li><a href="https://github.com/joshwnj/json-mode">json-mode</a> – Подсветка и валидация
джейсона</li>
</ul>

<h3 id="сборки-форки">Сборки, форки</h3>

<p>Я не особо осведомлен насчет сторонних сборок Емакса. Почти все время я работал
со своей конфигурацией на чистом Емаксе, чтобы понять, как все работает.</p>

<p>Как уже упоминал выше, существует XEmacs – альтернативная ветка Емакса. В ней
больше внимания уделено интерфейсу, шрифтам и внешнему виду в целом. Большинство
крупных пакетов разрабатывают так, чтобы они работали в XEmacs тоже.</p>

<p>Проект <a href="https://ergoemacs.github.io/">Эрго-Емакс</a> ставит цель создать
оптимальную клавиатурную раскладку, где наиболее востребованные функции
размещены в нужных местах. Авторы полагают, раскладка повысит производительность
и снизит усталость рук. На этом же сайте тусит сообщество, есть сборник
рецептов, снипетов и все такое.</p>

<p>Наконец, существует <a href="https://github.com/syl20bnr/spacemacs">Spacemacs</a> –
попытка взять лучшее из двух миров. Соединить механику Вима с мощью платформы
Емакса. Простыми словами, это громадный конфиг с пакетами для имитации Вима.</p>

<p>Ставил эту сборку, но не впечатлился. Кое-где были проблемы с цветовой схемой
(текст сливался с фоном), приходилось ставить недостающие пакеты. Если
возможности Вима я выключил, так как не особо им владею, то что я получил в
остатке, кроме нескучной темы?</p>

<p>Судя по репозиторию проекта, работа проделана внушительная, но я не проникся. Да
и вообще, идея смешения мне не нравится. Она наивна по своей природе. Вот есть
Руби и Питон, у них достоинства и недостатки. Давайте возьмем от каждого только
достоинства и получим идеальный язык! Или давайте Мерседес с Ауди смешаем. Или
Виндуз с Маком. Это не работает.</p>

<p>Сложилось впечатление, что в этой сборке выигрывает только Вимер. Для Емаксера
нет ничего нового. Добавлю, любая имитация всегда отстает на шаг-два от
эталона. Когда для Вима запилят новую фичу, она попадет в Spacemacs с
запозданием.</p>

<h3 id="для-чего-я-использую-емакс">Для чего я использую Емакс</h3>

<p>В емаксе можно делать почти все, что угодно, главное – знать меру и не стать
упоротым фанатом.</p>

<p>Надо понимать, что некоторые пакеты имеют скорее не практический, а спортивный
интерес. Например, один тип написал модуль управления кофеваркой по USB. Это
забавно, но не стоит воспринимать всерьез.</p>

<p><img src="/assets/static/emacs/xkcd.png" alt="xkcd" /></p>

<p><em>В Емаксе на все найдется команда.</em></p>

<p>Я использую Емакс для следующего:</p>

<ul>
  <li>
    <p>Программирую в Емаксе на Питоне, Кложе, Джаваскрипте, Ракете, Коммон-Лиспе. В
нем же ковыряю Хаскелл и Гоу. Под каждый язык – пакет или два для
поддержки. Питон, надо сказать, поддерживается очень хорошо. Трудность скорее
в том, какие пакеты для него выбрать из множества. Для Лиспов емакс – родная
среда.</p>
  </li>
  <li>
    <p>Редактирую структурированные файлы: Маркдаун, Json, Yaml, ini, html, css. Где
не хватает коробочных средств, тоже ставлю пакеты.</p>
  </li>
  <li>
    <p>Работаю с системами контроля версий, почти не вылезая в терминал. Смотрю
диффы, блейм, логи. Делаю и мерджу ветки в Емаксе.</p>
  </li>
  <li>
    <p>Изредка читаю онлайн-документацию во встроенном браузере EWW. Это полезно,
когда не хочешь постоянно переключаться из браузера в редактор. Делишь экран
пополам, в слева страничка с доками,справа код – удобно. Емакс умеет
проматывать соседний буфер, не переключаясь из основного.</p>
  </li>
  <li>
    <p>Планирую делать резолв конфликтов при мердже веток встроенным пакетом
emerge. Пока что использую kdiff3.</p>
  </li>
  <li>
    <p>Некоторое время, когда в команде пользовались джаббером, сидел из Емакса. Тоже
удобно, особенно когда обсуждаешь код.</p>
  </li>
  <li>
    <p>Пытался пользоваться почтой с помощью встроенного пакета Gnus – не пошло в
силу однопоточности Лисп-машины. На проверку почты уходит до 10 секунд (у меня
куча папок), за это время ничего нельзя сделать.</p>
  </li>
  <li>
    <p>Запускаю и контролирую процессы с помощью пакета prodigy. Был проект на
микросервисной архитектуре. Чтобы завести его, нужны были штук 6 фейковых
рест-сервисов. Эти заглушки было удобно поднимать и гасить прямо в Емаксе.</p>
  </li>
  <li>
    <p>Порой пользуюсь встроенным терминалом, когда лень открывать основной.</p>
  </li>
  <li>
    <p>Иногда делаю презентации в емаксе: пишу структурированный файл в разметке ORG,
который экспортируется в HTML + reveal.js. Например, вот слайды для доклада о
юнит-тестах:
<a href="https://raw.githubusercontent.com/igrishaev/talks/gh-pages/pytest.org">исходник</a>,
<a href="http://grishaev.me/talks/pytest.html">результат</a>.</p>
  </li>
  <li>
    <p>Рисую ascii-таблицы в org-mode. Параметры таблицы задаются командой. Таблица
ведет себя как лист в Экселе – можно перемещаться по ячейкам, добавлять и
удалять строки и столбцы, сортировать, вставлять формулы. Таблица автоматом
растягивается под данные в ячейках. И при этом копируется как текст. Очень
удобно для документации. Руками вы ее будете рисовать час.</p>
  </li>
</ul>

<p>Пример по шагам:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">M-x org-table-create</code> – система спрашивает размер таблицы, ввожу число строк и
колонок, получаю</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>|   |   |   |   |   |
|---+---+---+---+---|
|   |   |   |   |   |
</code></pre></div></div>

<ul>
  <li>Ввожу данные:</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>|Python   |Ruby   |Perl   |Java   |Common Lisp   |
|---+---+---+---+---|
|1   |2   |  3 | 4  |5   |
</code></pre></div></div>

<ul>
  <li>Нужен еще ряд? Набираю <code class="language-plaintext highlighter-rouge">M-x org-table-insert-row</code>:</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>|Python   |Ruby   |Perl   |Java   |Common Lisp   |
|---+---+---+---+---|
|1   |2   |  3 | 4  |5   |
|  Some long test  | 42   | foo   | bar     |    Another long text|
</code></pre></div></div>

<ul>
  <li>Все съехало, некрасиво. Набираю <code class="language-plaintext highlighter-rouge">M-x org-table-align</code>:</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| Python         | Ruby | Perl | Java | Common Lisp       |
|----------------+------+------+------+-------------------|
| 1              |    2 | 3    | 4    | 5                 |
| Some long test |   42 | foo  | bar  | Another long text |
</code></pre></div></div>

<p>Тадам. И это даже не верхушка айсберга, а самая мелочь из того, что можно делать
в org-mode.</p>

<ul>
  <li>Возвращаюсь к нашему списку. Веду GDT – учет личных и рабочих дел. Давно хочу
написать на эту тему в блог, но пока что отдельным абзацем.</li>
</ul>

<p>Выше я уже не раз упоминал про org-mode. Это что-то вроде офисного пакета,
только для Емакса. В него входит особый язык разметки, работа с таблицами,
всевозможные экспорты.</p>

<p>В языке разметки есть особые TODO-элементы. Им можно менять состояния, причем
воркфлоу вы задаете сами в шапке файла. Им можно выставлять теги, иерархию,
писать комментарии и всякие другие вещи. Но главное, их можно привязывать ко
времени и делать повторяющимися.</p>

<p>В специальном режиме <code class="language-plaintext highlighter-rouge">timeline</code> Емакс покажет задачи на временной полосе, а вам
остается помечать их выполнение. При этом у вас по-прежнему текстовые файлы. Вы
можете поправить все что хотите руками, смотреть дифы.</p>

<p>Перенес все задачи в такой файл и храню его в приватном репозитории. Каждое утро
смотрю, какие задачи меня ждут и стараюсь их выполнять. Задачи можно
архивировать. Емакс вырезает их из файла и переносит в архивный файл с похожим
названием.</p>

<p>Не могу расшарить свой файл, поскольку в нем немало приватных данных, но
примерно это выглядит так:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>** DONE Sign Contract
CLOSED: [2016-03-30 Wed 12:36] SCHEDULED: &lt;2016-03-30 Wed&gt;
- CLOSING NOTE [2016-03-30 Wed 12:36] \\
  signed
** TODO Get Reports
DEADLINE: &lt;2016-06-20 Mon +3m&gt;
- CLOSING NOTE [2016-03-28 Mon 10:52] \\
  got and paid
:PROPERTIES:
:LAST_REPEAT: [2016-03-28 Mon 10:52]
:END:
** DONE IP USN
CLOSED: [2016-04-25 Mon 10:00] DEADLINE: &lt;2016-04-18 Mon&gt;
- CLOSING NOTE [2016-04-25 Mon 10:00] \\
  done
** TODO Visit some secret place
DEADLINE: &lt;2016-03-31 Thu&gt;
** DONE Sber get new card
CLOSED: [2016-04-06 Wed 15:42] SCHEDULED: &lt;2016-04-04 Mon&gt;
- CLOSING NOTE [2016-04-06 Wed 15:42] \\
  got it!
** DONE Add bank account to Paypal
CLOSED: [2016-03-25 Fri 15:39] SCHEDULED: &lt;2016-03-24 Thu&gt;
- CLOSING NOTE [2016-03-25 Fri 15:39] \\
  added
** TODO Sber Deposit
SCHEDULED: &lt;2017-02-06 Mon&gt;
** DONE Phone to Office
SCHEDULED: &lt;2016-03-01 Tue&gt;
- CLOSING NOTE [2016-03-01 Tue 15:02] \\
  phoned
- CLOSING NOTE [2016-02-24 Wed 22:52] \\
  phoned
</code></pre></div></div>

<p>Это бытовые дела – позвонить, подписать, сходить в Сбербанк. Все задачи
группирую по крупным разделам: работа, семья и дети, бизнес, блог, сторонний
проект, новинки. Почти ничего не правлю руками, все сущности создаются командами
и хоткеями.</p>

<p>На временной линии задачи выглядят так:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Friday     10 June 2016
Saturday   11 June 2016
  Scheduled:  TODO Practice Typing                                    :learning:
  Scheduled:  TODO Listen english                                     :learning:
  Scheduled:  TODO Do some secret stuff
  Scheduled:  TODO Pay for one thing
Sunday     12 June 2016
Monday     13 June 2016 W24
Tuesday    14 June 2016
  Scheduled:  TODO Another important task
  Scheduled:  TODO Listen english                                     :learning:
  Deadline:   TODO Publish announce
</code></pre></div></div>

<p>Чтобы успевать как можно больше дел, нужно сделать их регулярными и заставить
систему тебя пинать. Способ выше очень подошел.</p>

<h3 id="ресурсы">Ресурсы</h3>

<ul>
  <li><a href="http://www.gnu.org/software/emacs/tour/">Официальный туториал</a></li>
  <li>Подробнейшая <a href="https://www.emacswiki.org/">вики</a></li>
  <li><a href="http://sachachua.com/blog/">Блог китаянки</a>, у которой конфиг Емакса длиной с
Китайскую Стену</li>
  <li>Довольно свежая <a href="https://www.masteringemacs.org/book">книжка</a></li>
  <li><a href="http://alexott.net/ru/emacs/">Серия статей</a> Алекса Отта</li>
  <li>Раздел на <a href="https://habrahabr.ru/hub/emacs/">Хабрахабре</a></li>
</ul>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/hexlet-emacs/">Сегодня рассказываю про Емакс</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2016-06-09T00:00:00+00:00">
        Jun 9, 2016
    </time>

    <a href="/tag/hexlet/" rel="tag">hexlet</a>, <a href="/tag/slack/" rel="tag">slack</a>, <a href="/tag/emacs/" rel="tag">emacs</a>

</div>


            <div class="entry">
                
                    <p>Сегодня, в четверг 9 июня, в 17:00 по Москве я расскажу про Емакс в
<a href="https://hexlet-ru.slack.com/archives/general">Слак-канале</a> образовательного проекта Хекслет.</p>

<p>Затрону следующие темы:</p>

<ul>
  <li>краткая история Емакса</li>
  <li>основные отличия от Вима</li>
  <li>как я переходил на Емакс, причины и мотивация</li>
  <li>советы новичкам</li>
  <li>плюсы и недостатки</li>
  <li>базовые приемы работы с Емаксом</li>
  <li>расширенные возможности</li>
  <li>для чего использую Емакс</li>
  <li>ресурсы, книги, статьи</li>
  <li>заключение и вопросы</li>
</ul>

<p>Общение займет ориентировочно 2 часа. Позже дамп беседы выложат в
<a href="https://github.com/Hexlet/hexlet-slack-archive/wiki">архивную Вики</a>, а я оформлю в блоге отдельным постом.</p>

<p>Заходите, будет интересно.</p>


                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/meetup6/">Доклады с шестой встречи глубокого рефакторинга</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2016-06-05T00:00:00+00:00">
        Jun 5, 2016
    </time>

    <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/meetup/" rel="tag">meetup</a>, <a href="/tag/deep-refactoring/" rel="tag">deep-refactoring</a>

</div>


            <div class="entry">
                
                    <p>Провели шестую встречу!</p>

<p><img src="/assets/static/meetup6.jpg" alt="meetup" /></p>

<p>Юра Хрусталев рассказал, как мы в проекте внедряли Ансибл:</p>

<iframe width="854" height="480" src="https://www.youtube.com/embed/MwkTKwhQqaE" allowfullscreen=""></iframe>

<p><a href="http://www.slideshare.net/IvanGrishaev/make-ansible">Слайды</a></p>

<p>Миша Вьюков дал советы как продвигать продукты и сообщества в социальных сетях.</p>

<iframe width="854" height="480" src="https://www.youtube.com/embed/CGAXJgERS1I" allowfullscreen=""></iframe>

<p><a href="http://www.slideshare.net/IvanGrishaev/ss-62728521">Слайды</a></p>

<p>Напомню, сообщество тусит в <a href="https://www.facebook.com/groups/deeprefactoring/">группе Фейсбука</a>. Скоро анонс
седьмой встречи. Принимаем заявки на доклады.</p>


                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/python/">Размышления о Питоне</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2016-05-28T00:00:00+00:00">
        May 28, 2016
    </time>

    <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/python/" rel="tag">python</a>

</div>


            <div class="entry">
                
                    <p>Я программирую на Питоне шесть лет. За это время назрели некоторые мысли насчет
языка и его роли в ай-ти. Я решил, что следующим погружением на несколько лет
будет что-то функциональное. Зафиксирую соображения, пока не утратил контекст.</p>

<p>Ниже – попытка обозначить слабые и сильные стороны Питона. Постараюсь, чтоб не
было банальщины в духе “много библиотек и широкое комьюнити”. Все сказанное –
исключительно личное мнение, которое не навязываю никому.</p>

<p>Итак, преимущества:</p>

<h3 id="питон--коммерчески-успешный-язык">Питон – коммерчески успешный язык</h3>

<p>Приятно осознавать, что Питон используют не только в академических и
любительских кругах, но и в бизнесе. Компании доверяют ему деньги. Много фирм
используют Питон – Гугл, Пейпал, Инстаграм, НАСА.</p>

<p>Питон создает рабочие места. Вакансий много, в том числе и в России. Питон –
промышленный язык. Он стоит в одном ряду с Плюсами и Джавой по
востребованности. Разработчик на Питоне имеет шанс попасть в настоящую
разработку продукта. Это не суррогат местного потребления вроде 1С.</p>

<h3 id="питон--очень-легкий-язык">Питон – очень легкий язык</h3>

<p>Вместе с тем, Питон чрезвычайно легко освоить. Основы учатся за неделю. Еще
неделю займут пакеты и подготовка окружения. В итоге, меньше чем за месяц можно
добиться места в проекте.</p>

<p>В Питоне мало сложных тем. Так я называю разелы языка, на изучении которых
останавливаешься отдельно. В Лиспе один сложный момент – макросы. В Скале
больше – трейты, импликты, составные объекты. В Питоне два – декораторы и
метаклассы. В повседневной работе метаклассы не нужны, пожтому остатется только
одна сложность. Разобравшись с декораторами, вы не встретите в языке других
препятствий.</p>

<h3 id="питон-сильно-приблизил-програмирование-к-людям">Питон сильно приблизил програмирование к людям</h3>

<p>Я ни разу не видел, чтобы этот пункт кем-то упоминался. Питон стал языком, с
которым любой инженер, ученый или технарь без навыков программирования могут
решить задачи промышленного уровня. Питон – инструмент решения проблем.</p>

<p>Появились специальные проекты и книги, например,
<a href="http://pythonforengineers.com/pythonforengineersbook/">Python For Engineers</a>,
<a href="http://www.amazon.com/Scientific-Programming-Computational-Science-Engineering/dp/3642024742">A Primer on Scientific Programming with Python</a> и другие. На
работе я видел скрипты на Питоне, написанные людьми, у которых все знание
программирования сводилось к школьной программе. Но скрипты работали,
автоматизировали труд, а значит, экономили время и деньги.</p>

<p>С Питоном управлять машиной стало проще. На каждую задачу найдется копипаста со
Стек-Оверфлоу. Что бы ни загуглили – разбить строку, построить график,
перемножить матрицы – в первых трех ссылках выдачи обязательно будет решение.</p>

<p>Конечно, подобный стиль простителен только не-программистам, когда важно
получить результат, а не надежный поддерживаемый код.</p>

<h3 id="питон--легкий-способ-попасть-в-промышленную-разработку">Питон – легкий способ попасть в промышленную разработку</h3>

<p>Напоминает тезис о том, как попасть в шоу-бизнес через постель. Если вы
занимаетесь чем-то около-айтишным, например, администрированием, сетями,
поддержкой, 1С или старыми языками вроде Дельфи, то Питон – счастливый
билет. Из пунктов выше мы выяснили, это что легкий язык промышленного
уровня. Возможно, он станет той подножкой уходящего поезда, на которую успеете
вскочить, прежде чем расхочется что-то менять и превозмогать.</p>

<p>Абзацем выше я фактически рассказал свою историю. До знакомства с Питоном я
занимался сайтами на CMS, Дельфями и 1С. Конечно, и с этим можно найти
работу. Однако, именно за счет Питона я продвинулся на старой работе, потом
переехал в другой город за 6000 км и попал в Датаарт. Позже нашел удаленку в
Европе.</p>

<h3 id="питон-поддерживает-все-парадигмы-программирования">Питон поддерживает все парадигмы программирования</h3>

<p>Питон удивидельно гибок. Его дизайн и синтаксис в равной степени поддерживают
большинство парадигм. Стандартное ООП, императивный подход,
процедурно-модульный, функциональный.</p>

<p>Каждая парадигма реализована в неполной манере. Так, в ООП нет приватных
переменных и интерфейсов. Двойное подчеркивание – хак и обходится на
раз. Интерфейсы пишут миксинами, но точное следование интерфейсу отследить
невозможно.</p>

<p>Для полноценного ФП не хватает полноценных лямбд и неизменяемых коллекций. В
тройке функцию <code class="language-plaintext highlighter-rouge">reduce</code> запрятали в недра стандартной библиотеки.</p>

<p>Ленивые вычисления, декораторы и перегрузка операторов открывают пространство
для интересных маневров. Питон мимикрирует под самые разные языки, например:</p>

<ul>
  <li>
    <p><a href="https://github.com/akalenuk/fakelisp">Fake Lisp</a> – псевдо-Лисп, забавная попытка писать питонячий код
S-выражениями.</p>
  </li>
  <li>
    <p><a href="https://github.com/billpmurphy/hask">Hask</a> – закос под синтаксис Хаскела. Питонщикам очень полезно
посмотреть, на какие ухищрения пошел автор, чтобы добиться столь точного
сходства.</p>
  </li>
  <li>
    <p><a href="https://github.com/kachayev/fn.py">fn.py</a> – функциональные ништяки из Скалы. Аналогично, очень интересно
взглянуть, что под капотом.</p>
  </li>
</ul>

<p>Резонный вопрос, зачем такая гибкость? Мой ответ – чтобы оттачивать паттерны и
подходы, расширять кругозор, принимать на вооружение лучшие практики из других
языков и платформ.</p>

<p>Например, одна функция из Кложи, портированная в Питон, сэкономит много строк
кода и избавит от досадных багов. Или, встретив новый паттерн, я пробую
реализовать его в Питоне, чтобы оценить, насколько он уживается в рамках
большого проекта.</p>

<p>Закончим с преимуществами. Питон не идеален. Вижу следующие недостатки:</p>

<h3 id="мелкие-огрехи-с-синтаксисом">Мелкие огрехи с синтаксисом</h3>

<p>У Питона лаконичный синтаксис без лишних скобок, точек с запятой и прочей
мишуры, нужной машине, а не человеку. Все же, остаются способы отстрелить ногу и
проверсти час в дебаге, не понимая в чем дело.</p>

<p>Формирование кортежа. Может, кто-то не знает, что круглые скобки вокруг кортежа
носят символический характер. На самом деле он определяется запятой. Возникает
проблема кортежа с одним элементом:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">foo</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span>  <span class="c1"># it's tuple
</span><span class="n">bar</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>    <span class="c1"># it's tuple
</span><span class="n">baz</span> <span class="o">=</span> <span class="mi">1</span>     <span class="c1"># it's int!
</span></code></pre></div></div>

<p>Забыл запятую – получил не кортеж, а число. Оставил на хвосте запятую – не
число, а кортеж. Не страшно, код упадет из-за разных типов. Начнется боль, когда
кортеж строк. Строка и кортеж поддаются общим операциям: итерации, доступу по
индексу, срезу. Код отрабатывает без падений, но выдает неверный
результат. Из-за одной запятой.</p>

<p>Следующий пример. Две строки подряд без запятой сливаются в одну. Это значит,
кортеж</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">statuses</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s">'success'</span><span class="p">,</span>
    <span class="s">'error'</span>
    <span class="s">'timeout'</span><span class="p">,</span>
    <span class="s">'denied'</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div></div>

<p>вырождается в</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="s">'success'</span><span class="p">,</span> <span class="s">'errortimeout'</span><span class="p">,</span> <span class="s">'denied'</span><span class="p">)</span>
</code></pre></div></div>

<p>потому что нет запятой после <code class="language-plaintext highlighter-rouge">'error'</code>. Проверка <code class="language-plaintext highlighter-rouge">'error' in statuses</code> вернет
<code class="language-plaintext highlighter-rouge">False</code>, что есть прямое нарушение бизнес-логики.</p>

<p>Код на Питоне очень хрупкий и нуждается в обильном покрытии тестами. На шестом
году работы с ним я до сих пор не уверен, правильно ли отработает тот или иной
участок кода без теста.</p>

<h3 id="главенство-ооп">Главенство ООП</h3>

<p>Хоть Питон и поддерживает множество парадигм, основной остается ООП. Типичный
фреймворк или библиотека – это набор классов, которые хранят состояние и меняют
друг друга.</p>

<p>Вы когда-нибудь дебажили Джанго? Я да. Это был кастомный бекенд
авторизации. Дебаг длился больше часа и напоминал БСДМ-сессию.</p>

<p>Объекты <code class="language-plaintext highlighter-rouge">Request</code>, <code class="language-plaintext highlighter-rouge">Response</code>, <code class="language-plaintext highlighter-rouge">User</code>, <code class="language-plaintext highlighter-rouge">Session</code> устраивают свальный
грех. Устанавливают ссылки друга несколько раз. Лезут в кэш непонятно
зачем.</p>

<p>Очень странные требования к бекенду авторизации. Метод <code class="language-plaintext highlighter-rouge">.get_user()</code> отдает
объект пользователя. Потом этот пользователь где-то теряется, на него не
остается ссылки. Система запрашивает метод <code class="language-plaintext highlighter-rouge">.get_user_by_id()</code>. Я ведь уже отдал
пользователя, дубина! Значит, нужно или снова лезть в базу или сеть, либо
хранить в классе словарик, что не тред-сейф.</p>

<p>Почему-то в Кложе с ее неизменяемыми коллекциями мне ни разу не приходилось
лазить в сессию, реквест или респонс задним числом и что-то там
править. Изменения в коллекции прокидываются только вперед.</p>

<p>Я не призываю программировать в сплошном ФП-стиле. Признаться, все эти статьи в
духе “Программирование на Питоне в функциональном стиле” выглядят жалко.
Совершенно за уши притянуты редьюсы и трехэтажные лямбды. Такой код не уживается
в рамках проекта и будет выпилен, даже если его удастся как-то протащить.</p>

<p>Это наносит урон функциональному программированию. Распространяется заблуждение,
что ФП – это мапы и лямбды.</p>

<p>В Питон было бы неплохо добавить что-то, что поощряло отказ от
состояния. Например, неизменяемый словарь, больше функций для работы с
коллекциями.</p>

<p>Впрочем, это был бы уже совсем другой язык.</p>

<h3 id="низкая-скорость">Низкая скорость</h3>

<p>Еще год назад говорил, что это не недостаток вовсе. Память дешевая, хостинг
недорогой и прочие отмазки. Сегодня считаю такой ответ уделом дилетанта.</p>

<p>Скорость исполнения важна. Представьте, весь ваш софт на компе написан на
Питоне. Он бы работал раз в 20-30 медленней, об играх и фотошопах пришлось
забыть. Это не просто шаг назад, а откат на несколько поколений.</p>

<p>Недавно мне нужно было парсить лог Nginx, Гугл выдал утилиту <a href="https://github.com/lebinh/ngxtop">ngxtop</a>. Я
не посмотрел, на чем она написана, поставил из пакетов. Лог в несколько гигабайт
она обрабатывала час. Оказался Питон. Утилита на Си распарсила за 5
минут. Неверный выбор стоил потери времени.</p>

<p>Питон долго брал скоростью разработки. Да, работает медленней, зато выкатим
раньше, чем конкурент на Джаве. И вот появляются языки, которые совмещают
скорость кода и скорость разработки. Если писать на <code class="language-plaintext highlighter-rouge">X</code> и <code class="language-plaintext highlighter-rouge">Y</code> по времени
примерно одинаково, а <code class="language-plaintext highlighter-rouge">Y</code> исполняется быстрей в 5 раз, зачем брать <code class="language-plaintext highlighter-rouge">X</code>?</p>

<p>Насчет дополнительного железа. Говорить, что поставить вторую ноду – плевое
дело может лишь тот, кто пишет код и не притрагивается к деплою. Несколько нод
– это распределенная система. Нужен балансировщик, разделение логов, проблемы
синхронизации, согласованные обновления.</p>

<p>В моем личном проекте долго жил Питон, нагрузка постоянно росла. Сервер
задыхался, я не успевал поднимать тарифный план. Затем плюнул и переписал на
Кложе. Не забуду это чувство, когда график CPU упал с 80 до 20 процентов.</p>

<h3 id="гил">ГИЛ</h3>

<p>На упрек в адрес ГИЛа отвечают в духе “он вам не нужен”, “используй
процессы”. Так говорил и я до тех пор, пока не познал, как работает
многопоточность в функциональных языках.</p>

<p>Мы запускаем веб-приложение на Питоне под uWSGI так. Стартует мастер-процесс. Он
управляет воркерами – процессами, в каждом из которых
веб-приложение. Единовременно запущены 16 Джанг, каждая из которых отвечает,
когда другая занята.</p>

<p>Мастер-процесс следит, чтобы все были равны. Убивает тех, кто не отвечает,
выжрал слишком памяти или перетрудился – выработал лимит запросов.</p>

<p>Я считаю этот способ уродливым. Во-первых, налицо недоверие к технологии и ее
нестабильное поведение. При длительной работе процессы текут, даже
мастер-процесс. Это значит, систему нужно перезапускать.</p>

<p>Распараллеливание на процессах лишает общего доступа к памяти, вынуждая
использовать суррогаты вроде Memcache или Redis, в то время как самый
эффективный кеш – общая память.</p>

<p>Мастер-процессы вроде uWSGI и Green Unicorn – дополнительная прокладка в цепи,
по которой проходит запрос. Лишний I/O, точка логирования и падения.</p>

<p>Наконец, с ГИЛом нельзя ничего распараллелить, разве что запросы в
сеть. Функциональные языки лишены этих недостатоков. Неизменяемость коллекций в
Кложе, система каналов в Гоу позволяют рулить многопоточностью без страха
отстрелить ногу. Это выкашивает целый пласт инфраструктуры: костыли в виде
очередей, воркеров и крон-скриптов. И дополнительные системы, чтобы все это
поддерживать.</p>

<h3 id="трудности-распространения">Трудности распространения</h3>

<p>Приложение, написанное на Питоне, трудно распространять. Маленький скриптик
требует интерпретатор определенной версии, виртуальное окружение с кучей
библиотек. На вопрос, как перенести окружение на машину пользователя, нет
точного ответа.</p>

<p>Несколько лет назад я пробовал различные упаковщики: <code class="language-plaintext highlighter-rouge">Py2Exe</code>, <code class="language-plaintext highlighter-rouge">PyInstaller</code>,
<code class="language-plaintext highlighter-rouge">CxFreeze</code>. Собрать без ошибок приложение под Винду смог только
последний. Сделал это очень хорошо: выдал *.msi-инсталлятор, зарегистрировал
системную службу. Но времени на сборку и чтение доков ушло немало. Почему
разработчики Питона не озаботятся тем, чтобы включить в коробку систему
распространения конечного продукта?</p>

<p>Чтобы написал скрипт, запустил сборку и получил архив с исполняемым
файлом. Почему функциональные языки это умеют, а Питон – нет?</p>

<p>Кложа выдает uberjar. Собираю его на Маке, загружаю на хостинг, где кроме Джавы
ничего нет – работает без проблем. Хаскель компилируется в бинарь. Ракет, Раст
– тоже. Коммон Лисп, которому тридцать лет, Карл, делает дамп Лисп-машины в
бинарный файл!</p>

<p>Фактически, чтобы запустить веб-приложение на Питоне, нужно иметь примерно
10.000 *.py-файлов. Если не будет одного, система не заведется. Изолировать это
многообразие можно Докером, но здесь мы кривим душой.</p>

<p>Листая документацию к третьему Питону, обнаружил занятный модуль
<a href="https://docs.python.org/3/library/zipapp.html">zipapp</a>. В первую минуту подумал, что напрасно упрекал язык, дело
сдвинулось с мертвой точки. Оказалось, модуль не поддерживает виртуальное
окружение и сишные библиотеки. Собрать простое приложение с драйвером Постгреса
я не смог.</p>

<h3 id="заключение">Заключение</h3>

<p>Такие получились пункты. Надеюсь, никого не обидел критикой в адрес языка.</p>

<p>Ничуть не жалею, что потратил на Питон столько лет. Пусть следующий язык внесет
в мою жизнь не меньший вклад.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/lisp-comments/">Комментарии к статье о Лиспе</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2016-05-24T00:00:00+00:00">
        May 24, 2016
    </time>

    <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/pfp/" rel="tag">pfp</a>, <a href="/tag/lisp/" rel="tag">lisp</a>

</div>


            <div class="entry">
                
                    
<p>Прочитал статью <a href="http://fprog.ru/2010/issue5/vsevolod-dyomkin-lisp-philosophy/">Лисп – философия разработки</a> от 2010 года. Решил
законспектировать заключительынй раздел с выводами – очень уж понравились.</p>

<blockquote>
  <p>Если рассмотреть каждый отдельный язык, то, как правило, можно найти его
объединяющую идею. […] Для Common Lisp объединяющей идеей на данный момент
является как раз расширяемость.</p>
</blockquote>

<p>Не могу с точностью судить о CL, но расширяемость в Кложе(скрипте) сделана на
высоте. Пожалуй, это единственная экосистема, где любой разработчик может внести
свой контриб в чужой тип или протокол без обезьяних патчей, как в Руби и
Питоне. Напоминает перегрузку операторов, но в масштабах всей Лисп-машины. Это
надо просто попробовать.</p>

<blockquote>
  <p>В то же время у нее [Джавы] есть и сильная сторона, а именно пронизывающая
весь язык модель семантической расширяемости через интерфейсы. Так что в
общем-то не удивительно, что язык Clojure появился именно на Java-платформе…</p>
</blockquote>

<p>Да, единственно хорошая вещь в ООП – это интерфейсы. Недавно я узнал, что в
Кложе(скрипте) вообще все с ног до головы построено на интерфейсах. Это и
придает языку такую мощь.</p>

<blockquote>
  <p>Объектно-ориентированный подход обещал, что базовыми компонентами повторного
использования будут классы и их наборы. Однако, как показывают провалы многих
технологий, таких как JavaBeans, это тупиковое направление. Ведь отдельные
классы не могут быть независимыми компонентами, потому что в этом случае они
рискуют превратиться либо в пространства имен, либо в монолитные монстры,
противореча самой идее декомпозиции, основанной на классах.</p>
</blockquote>

<p>Подпишусь всеми конечностями. Не раз видел: есть жирный класс, нужно создать
похожий. И почему-то разработчик, который вчера заливал про преимущества ООП,
выделяет мышкой и копипастит в соседний модуль. А как же наследование, спрашиваю
я? Все понятно. Классы хоть и похожи, но приведение к общему знаменателю будет
стоить так дорого, что просто невыгодно. И юнит-тестов может не хватить.</p>

<blockquote>
  <p>В тех же языках, где расширяемость затруднена […] есть тенденция к
постепенному включению всего необходимого в стандартную библиотеку или же в
какие-то крупные фреймворки, каждый из которых зачастую развивает собственный
механизм подключения и повторного использования. Здесь структура зависимостей
— это дерево или же несколько отдельных слабо пересекающихся деревьев.</p>
</blockquote>

<p>Вспомнился бедовый Джаваскрипт. Не везет языку. При всех возможностях к
расширению через прототипы, разработчики педалат тысячи микро-модулей по 10
строк каждый. Расширять стандартную библиотеку никто не думает. Так сообщество
двигается <a href="/npm">в пропасть</a>.</p>

<blockquote>
  <p>В этом смысле показателен пример Python, известного своим девизом «Батарейки в
комплекте», который подразумевает наличие в стандартной библиотеке (почти)
всего, что нужно для разработки. […] Обратная сторона медали тут отмечена в
другой цитате: «Пакет, который попадает в стандартную библиотеку, стоит одной
ногой в могиле»</p>
</blockquote>

<p>Меткое замечание. Не случайно автор библиотеки
<a href="http://docs.python-requests.org/en/master/">requests</a>, ставшей де-факто для
HTTP-запросов, заключил с Гвидо неформальное соглашение. Согласно ему,
<code class="language-plaintext highlighter-rouge">requests</code> НЕ включается в стандартную библиотеку (чего так хотелось Гвидо), но
рекомендуется к использованию на страницах официальной документации. Хитрый
мужик! Знал, чем чревато.</p>

<blockquote>
  <p>В Common Lisp для этого [построения расширяемых систем] используются следующие
технологии: макросы для создания мини-языков для декларативного описания
систем, дистрибутивов (в отличие от использования для этих целей внешних
языков, таких как XML)…</p>
</blockquote>

<p>Да, достоинство Лиспов – всегда можно написать доменный язык под любую задачу
благодаря <a href="/code-data">системе макросов</a>. В Лиспе построение XML, HTML, SQL
вырождается в декларативное дерево с одноименными узлами (cdata, div, select).</p>

<p>Кому интересно, загляните и в другие статьи
<a href="http://fprog.ru/">Практики функционального программирования</a>. Актуальность они
не потеряли и еще долго ее сохранят.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/programming-tips/">Полезные практики</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2016-05-16T00:00:00+00:00">
        May 16, 2016
    </time>

    <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/tips/" rel="tag">tips</a>

</div>


            <div class="entry">
                
                    <p>Методом проб и ошибок выработал набор практик, с которыми работаю лучше. Стал
допускать меньше ошибок, легче отслеживаю бизнес-логику, быстрее вношу изменения
в код. Эти практики не следуют строго определенным парадигмам. Наверняка под
каждую придумали паттерн, но я об этом ничего не знаю и расскажу простыми
словами.</p>

<h3 id="первое-указываю-тип-переменной-в-имени">Первое. Указываю тип переменной в имени</h3>

<p>Задаю переменным имена по правилу <code class="language-plaintext highlighter-rouge">&lt;entity&gt;_&lt;type&gt;</code>. Открыв код месячной
давности, сразу вижу, где и какие типы. Даже самая коммерческая ИДЕ порой не
может понять, с чем имеет дело. А с моим правилом именования работать одно
удовольствие.</p>

<p>Применяю его не слепо, а выборочно. Скалярным типам, например, строкам и числам,
не указываю тип, если он ясен из контекста. Выражения <code class="language-plaintext highlighter-rouge">name_str = 'test'</code> или
<code class="language-plaintext highlighter-rouge">age_int = 42</code> избыточны, поскольку имя и возраст вряд ли могут быть чем-то
отличным от строки и целого.</p>

<p>Я добавляю в конце тип, если он неочевиден из контекста. Предположим, из ответа
чужой апихи пришло поле <code class="language-plaintext highlighter-rouge">permission</code>. Что это – строковое имя, числовой код,
булево – понять со стороны невозможно. Все, что я могу – слазить в
документацию или промотать в другое место, чтобы увидеть, что с этим полем
делают дальше.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">permisson</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s">'data'</span><span class="p">][</span><span class="s">'item'</span><span class="p">][</span><span class="s">'permisson'</span><span class="p">]</span>
<span class="c1"># wtf is permisson?
</span></code></pre></div></div>

<p>А ведь достаточно назвать переменную <code class="language-plaintext highlighter-rouge">perm_int</code>, и все станет ясно – это же
числовой код!</p>

<p>Указывать тип стоит везде, где кроется неожиданность. Айдишка объекта может быть
передана строкой, поэтому назову переменную <code class="language-plaintext highlighter-rouge">user_id_str</code>, а дальше преобразую в
инт. Поле может называться <code class="language-plaintext highlighter-rouge">item</code>, а внутри – гуид сущности, а не словарь. И
так далее.</p>

<p>Коллекциям задаю тип без исключений. В Питоне достаточно много разных
коллекций. Чаще всего нас интересует только итерация, но шаг в сторону, и
программа падает.</p>

<p>Примеры? Хотели список, чтобы изменять элементы, а пришел кортеж. Итерация по
множеству проходит в разном порядке. Хеш от списка вызывает исключение. Пройтись
по итератору можно только один раз. И так далее.</p>

<p>Если работаю со словарем с данными о пользователе, называю <code class="language-plaintext highlighter-rouge">user_dict</code>. Список
пользователей – <code class="language-plaintext highlighter-rouge">user_list</code>, множество – <code class="language-plaintext highlighter-rouge">..._set</code> и так далее, принцип,
думаю, понятен. Для кортежей и итераторов окончания <code class="language-plaintext highlighter-rouge">tupl</code>, <code class="language-plaintext highlighter-rouge">iter</code>.</p>

<p>Отдельно стоит упомянуть тип <code class="language-plaintext highlighter-rouge">Queryset</code>, с которым постоянно работаешь в
Джанге. Обозначаю его как <code class="language-plaintext highlighter-rouge">qs</code>. С этим типом сплошная беда. Он всеми силами
мимикрирует под список и кидает в неподходящий момент.</p>

<p>Смотрит коллега в монитор и не понимает, отчего Pytest падает и выводит
следующее:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">assert</span> <span class="p">[</span><span class="il">1L</span><span class="p">,</span> <span class="il">2L</span><span class="p">,</span> <span class="il">3L</span><span class="p">]</span> <span class="o">==</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">long</span> <span class="n">trace</span><span class="p">...</span>
</code></pre></div></div>

<p>Потому что справа список, а слева – квери-сет. Он выводится как список, но не
равен ему.</p>

<p>Отдельным абзацем замечу, что не приемлю лексемы <code class="language-plaintext highlighter-rouge">data</code> в именах
переменных. <code class="language-plaintext highlighter-rouge">user_data</code>, <code class="language-plaintext highlighter-rouge">response_data</code> – ужасные имена. Любая переменная,
даже ноль, уже несет данные. Понятней не стало. Это словарь, список или что?</p>

<p>Добавлять на конце <code class="language-plaintext highlighter-rouge">s</code> тоже нет смысла. Коллекция подразумевает больше одного
элемента. Если не указан тип, я опять в беде: <code class="language-plaintext highlighter-rouge">users</code> – это сет, словарь или
кортеж? Можно ли брать слайс? Подставить в ключ словаря?</p>

<p>Падение на <code class="language-plaintext highlighter-rouge">None</code> (он же <code class="language-plaintext highlighter-rouge">nil, null, undefined</code>, etc) – особая история. В
программировании до сих пор нет понимания, что делать с пустыми типами. Чтобы
обезопасить код, полезно явно задать имя вроде <code class="language-plaintext highlighter-rouge">user_or_none</code> или, для
краткости, <code class="language-plaintext highlighter-rouge">user_none</code>. Это вынудит программиста выполнить проверку перед тем,
как что-то делать с данными.</p>

<h3 id="второе-избегаю-циклов">Второе. Избегаю циклов</h3>

<p>О вреде циклов я <a href="/map">уже писал</a>, и <a href="/potato">не раз</a>. Если коротко, то:</p>

<ul>
  <li>ручное накопление списка или словаря чревато багами</li>
  <li>со временем цикл разрастается, обрастает вложенными <code class="language-plaintext highlighter-rouge">for, if</code></li>
  <li>из-за отступов плохо видно бизнес-логику</li>
  <li>цикл поощрает плохую практику – впендюрить <code class="language-plaintext highlighter-rouge">continue</code> вместо того, чтобы
отфильтровать данные до входа в цикл</li>
  <li>цикл плохо поддается рефакторингу, поскольку затягивает контекст –
коллекцию-результат, локальные переменные, вложенные циклы.</li>
</ul>

<p>Решение – использовать функции высшего порядка <code class="language-plaintext highlighter-rouge">map</code>, <code class="language-plaintext highlighter-rouge">filter</code>. Я отрицательно
отношусь к трехэтажным лямбдам. Использую обычные функции, объявленные через
<code class="language-plaintext highlighter-rouge">def/func/defn</code>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_item_list</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">get_item</span><span class="p">(</span><span class="n">product</span><span class="p">):</span>
        <span class="p">...</span>

<span class="n">item_qs</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">Item</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span>
<span class="k">return</span> <span class="nb">map</span><span class="p">(</span><span class="n">get_item</span><span class="p">,</span> <span class="n">item_qs</span><span class="p">)</span>
</code></pre></div></div>

<p>Я просто объявляю функцию в том месте, где она нужна, и не парюсь за
производительность или дзен. Код становится на рельсы: <em>коллекция –&gt; фильтрация
–&gt; действие –&gt; другая коллекция –&gt; свертка</em>. Появляется ощущение структуры
программы, приходит упорядоченность.</p>

<p>Добавить новое бизнес-правило в такой код очень легко. Это будет или еще один
фильтр, или изменится действие над элементом. В любом случае не съедет весь код,
как в примере ниже:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">items</span> <span class="o">=</span> <span class="n">users</span><span class="p">.</span><span class="n">get_items</span><span class="p">()</span>
<span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">items</span><span class="p">.</span><span class="n">color</span> <span class="o">=</span> <span class="s">'red'</span><span class="p">:</span>
        <span class="k">continue</span>
    <span class="n">res</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="nb">id</span><span class="p">)</span>
</code></pre></div></div>

<p>Приходит эффективный менеджер и говорит, что теперь операция должна выполняться
по всем юзерам. Не вопрос, отвечает программист и тупо сдвигает табом:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">users</span> <span class="o">=</span> <span class="n">get_all_users</span><span class="p">()</span>
<span class="k">for</span> <span class="n">users</span> <span class="ow">in</span> <span class="n">users</span><span class="p">:</span>
    <span class="n">items</span> <span class="o">=</span> <span class="n">users</span><span class="p">.</span><span class="n">get_items</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">items</span><span class="p">.</span><span class="n">color</span> <span class="o">=</span> <span class="s">'red'</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">res</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="nb">id</span><span class="p">)</span>
</code></pre></div></div>

<p>Дифф покажет полную замену кода. Добавить сюда еще пару вложенных условий,
перехват ошибок, запись в лог – и код останется выкинуть на помойку.</p>

<p>Простое правило “дейтвие, коллекция, мап, свертка” работает без нареканий и
легко адаптируется под новые требования.</p>

<h3 id="третье-отлавливаю-ошибки-как-можно-раньше">Третье. Отлавливаю ошибки как можно раньше</h3>

<p>Почти любая операция небезопасна и может кинуть исключение. Проблема в том, что
одновременно писать бизнес-логику и следить за ошибками трудно. Каждая ошибка –
это блок <code class="language-plaintext highlighter-rouge">try-catch</code> и запись в лог, за которыми не видно главную мысль.</p>

<p>Исключения уже вовсе не означают исключительную ситуацию. Они стали
сигналами. Тот же Питон кидает и сам отлавливает определенные исключения в ходе
работы. Эта практика перешла и в бизнес-логику. Например, когда нет прав на
операцию, выбрасывают исключение <code class="language-plaintext highlighter-rouge">PermissionError</code>. Обработчик сверху ловит его
и выводит адекватный результат.</p>

<p>Мне не нравится эта ситуация, потому что она ненадержна. Язык не может внятно
сказать, какие исключения возникают при конкретной операции. Это может быть
описано в документации, но чаще всего выясняется эмпирически.</p>

<p>Не отлавливать свои же исключения неправильно с этической точки зрения. Ты
словно говоришь коллегам – вот написал код, но меня не волнуют ошибки. Да,
упадет, если в ответе нет ключа. Но ты оберни и залогируй. Превозмогай, это не
мои проблемы.</p>

<p>Заворачивать весь код в <code class="language-plaintext highlighter-rouge">try-catch</code> – не выход. Поможет возврат пары, как в
Golang. С небольшим отличием – не <code class="language-plaintext highlighter-rouge">(ok, result_or_error)</code>, как принято в
последнем, а <code class="language-plaintext highlighter-rouge">(err_or_null, result_or_null)</code>, как в Node.js. Второй вариант
логическии правильней.</p>

<p>Заворачиваю функцию в простой декоратор:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">err_result</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">e</span><span class="p">,</span> <span class="bp">None</span>
    <span class="k">return</span> <span class="n">wrapper</span>
</code></pre></div></div>

<p>Или вызываю just-in-place:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">some_func</span><span class="p">(</span><span class="n">foo</span><span class="p">):</span>
    <span class="p">...</span>

<span class="n">err</span><span class="p">,</span> <span class="n">result</span> <span class="o">=</span> <span class="n">err_result</span><span class="p">(</span><span class="n">some_func</span><span class="p">)(</span><span class="mi">42</span><span class="p">)</span>
</code></pre></div></div>

<p>Вариант с мапом. Функция-обработчик раскладывает пару на составные части с
помощью <a href="/destructuring">деструктивного синтаксиса</a>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="n">item_queryset</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">Item</span><span class="p">.</span><span class="nb">filter</span><span class="p">(...)</span>

<span class="k">def</span> <span class="nf">process_item</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
    <span class="p">...</span>

<span class="n">pair_list</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">err_result</span><span class="p">(</span><span class="n">process_item</span><span class="p">),</span> <span class="n">item_queryset</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">process_pair</span><span class="p">((</span><span class="n">err</span><span class="p">,</span> <span class="n">result</span><span class="p">)):</span>
    <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
        <span class="c1"># positive brunch
</span>    <span class="k">if</span> <span class="n">err</span><span class="p">:</span>
        <span class="c1"># negative brunch
</span>
<span class="nb">map</span><span class="p">(</span><span class="n">process_pair</span><span class="p">,</span> <span class="n">pair_list</span><span class="p">)</span>
</code></pre></div></div>

<p>Или отделяю котлеты от мух: разбиваю список пар на плоские списки ошибок и
результатов. Отдельно логирую ошибки. Передаю результаты на дальнейшую
обработку. Так в коде появляется порядок.</p>

<p>Конечно, в случае с одноразовым скриптом я могу завернуть все в глобальный
<code class="language-plaintext highlighter-rouge">try-catch</code>. Но прекрасно отдаю себе отчет в том, какие последствия это имеет в
боевом коде.</p>

<h3 id="заключение">Заключение</h3>

<p>Вот такие принципы я проповедую в текущем проекте. С ними стало работать
легче. Меньше падений на типах, внезапных трейсов.</p>

<p>Повторюсь, описанные принципы не идеальны, но с ними возникает чувство
порядка. Словно код становится на рельсы, а вместе с ним и процесс. Возникает
линейность, предсказуемость действий.</p>

<p>Кто-то скажет, что это не питоник-вэй, что диктатор не велел. Но кому это
интересно? Мы пишем код не для Гвидо или Торвальдса, а для начальников, которые
в гробу видали все паттерны, главное, чтобы код работал.</p>

<p>Допускаю, что прочту этот пост через 2 года и подумаю, каким <em>чудаком</em> я был, но
пока что так.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/requestbin/">Полезный сервис Requestb.in</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2016-05-08T00:00:00+00:00">
        May 8, 2016
    </time>

    <a href="/tag/http/" rel="tag">http</a>, <a href="/tag/webdev/" rel="tag">webdev</a>

</div>


            <div class="entry">
                
                    <p>Наткнулся на полезный сервис <a href="http://requestb.in/">Request Bin</a>.</p>

<p>Частенько бывает, какой-нибудь Твиттер, Фейсбук или Пейпал пингуют ваше
приложение. Шлют нотификации о платежах, событиях. Проблема, что приложение еще
не на сервере, а интегрироваться как-то нужно.</p>

<p>В документации стороннего сервиса часто описаны не все возможные
случаи. Приходится закачивать скрипт-заглушку и писать запросы в файл. Это не
то.</p>

<p>Поможет Request Bin. Идея сервиса гениальна. Вам дают уникальный урл, например,
<code class="language-plaintext highlighter-rouge">http://requestb.in/1j2bq6r1</code>. На все обращения сервис отвечает 200 ОК, а сам
записывает входящий запрос в память. По адресу
<code class="language-plaintext highlighter-rouge">http://requestb.in/1j2bq6r1?inspect</code> сервис покажет последние 20 запросов:
дату, метод, заголовки, параметры.</p>

<p>Полученный урл указываем в настройках стороннего сервиса. Выполняем операции,
смотрим, какие запросы пошли.</p>

<p>При бесплатном использовании запросы хранятся в мемкеше, поэтому в любой момент
данные можно потерять. Впрочем, мои запросы хранятся уже третий день.</p>

<p>Request Bin поддерживает соединение по протоколу HTTPS, правда, с
самоподписанным сертификатом. Это помогло при интеграции с Пейпалом. Последний
требует, чтобы урл начинался с <code class="language-plaintext highlighter-rouge">https://</code>, но не проверяет сертификат.</p>

<p>Сервису есть, что улучшить. Если в теле запроса был json, парсить и показывать
красиво. Сейчас выводит как пришло – в одну строчку. Добавить экспорт запросов
в любой формат. Показывать сырой запрос (т.н. raw HTTP).</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/meetup5/">Доклады с пятой встречи любителей рефакторить</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2016-05-02T00:00:00+00:00">
        May 2, 2016
    </time>

    <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/meetup/" rel="tag">meetup</a>, <a href="/tag/deep-refactoring/" rel="tag">deep-refactoring</a>

</div>


            <div class="entry">
                
                    <p>Провели пятую встречу!</p>

<p>Я рассказал про тесты с фикстурами:</p>

<iframe width="854" height="480" src="https://www.youtube.com/embed/UCVJS6kETk8" allowfullscreen=""></iframe>

<p><a href="http://www.slideshare.net/IvanGrishaev/ss-61568503">Слайды</a></p>

<p>Михаил Хорпяков объяснил, какие вопросы задать работодателю на собеседовании:</p>

<iframe width="854" height="480" src="https://www.youtube.com/embed/DXtZqjGsDXQ" allowfullscreen=""></iframe>

<p><a href="http://www.slideshare.net/IvanGrishaev/10-61570408">Слайды</a></p>

<p>Напомню, сообщество тусит в <a href="https://www.facebook.com/groups/deeprefactoring/">группе Фейсбука</a>. Скоро анонс
шестой встречи. Принимаем заявки на доклады.</p>


                
            </div>

        </li>
        
    </ul>

    <h4>
        
        <a href="/page32" class="previous">&larr;</a>
        
        <span class="page_number ">Страница 33 из 53</span>
        
        <a href="/page34" class="next">&rarr;</a>
        
    </h4>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Ivan Grishaev's blog</li>
          <li><a href="mailto:ivan@grishaev.me">ivan@grishaev.me</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
            <li><a href="https://github.com/igrishaev">GitHub</a></li>
            <li><a href="tg://resolve?domain=igrishaev_blog">Telegram</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Writing on programming, education, books and negotiations.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
