<!DOCTYPE html>
<html lang="ru">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Ivan Grishaev's blog</title>
  <meta name="description" content="Writing on programming, education, books and negotiations.
">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/custom.css">
  <link rel="canonical" href="https://grishaev.me/page29/">
  <link rel="alternate" type="application/rss+xml" title="Ivan Grishaev's blog" href="https://grishaev.me/feed.xml">

  <link rel="shortcut icon" type="image/x-icon" href="/assets/static/favicons/favicon.ico">

  <script type="text/javascript" src="/assets/typo.js"></script>

</head>


  <body>
    <header class="site-header">

    <div class="wrapper flex-container">

        <div>
            <a href="/">
                <img src="/assets/static/photo-round-small.png" alt="Ivan Grishaev">
            </a>
        </div>

        <div class="flex-container-vert" style="margin-left: 15px; width: 80%">

            <div class="flex-container full-width">
                <p style="margin-bottom: 5px">Ivan Grishaev's blog</p>
                <div class="flex-huge"></div>
                <div >
<form id="search-form"
      target="_blank"
      style="display: inline"
      method="get"
      action="https://www.google.com/search">

    <input name="sitesearch"
           value="grishaev.me"
           type="hidden">

    <input type="text"
           required="required"
           name="q"
           placeholder="Google search..."
           autocomplete="off">

    <button style="border: none; background-color: transparent; cursor: pointer;"
            type="submit">&#x1f50d;</button>

</form>
</div>
            </div>

            <p><small>Writing on programming, education, books and negotiations.
</small></p>

            <div class="flex-container">
                <a class="menu-item" href="/">Home</a>
                <a class="menu-item" href="/about/">About</a>
                <a class="menu-item" href="/bookshelf/">Bookshelf</a>
                <a class="menu-item" href="/feed.xml">RSS</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor" href="/tag/clojure/">Clojure</a>
                <a class="menu-item minor" href="/tag/emacs/">Emacs</a>
                <a class="menu-item minor" href="/tag/python/">Python</a>
                <a class="menu-item minor" href="/tag/programming/">Programming</a>
                <a class="menu-item minor" href="/interview/">Interview</a>
                <a class="menu-item minor" href="/video/">Video</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor hl" href="/clojure-in-prod/">Книга «Clojure на производстве»</a>
            </div>

        </div>
    </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="home">

    <ul class="post-list">
        
        <li>

            <h2>
                <a class="post-link" href="/covenant/">Чужой. Завет</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2017-10-11T00:00:00+00:00">
        Oct 11, 2017
    </time>

    <a href="/tag/alien/" rel="tag">alien</a>, <a href="/tag/movies/" rel="tag">movies</a>

</div>


            <div class="entry">
                
                    <p>Последний “Чужой” (который “Завет”) невероятно хорош. Не эффектами или актерами,
а концепцией.</p>

<p>Вот помните, чем был крут “Темный рыцарь”? Тем, что это фильм не про
Бэтмена. Если заменить его на условного следователя, драмы будет не меньше. И
главная мысль – насколько далеко ты готов зайти, чтобы остановить безумие –
осталась бы без искажений. Это и придает фильму как произведению художественную
силу. Заставляет обдумывать сюжет, переосмысливать диалоги и ситуации.</p>

<p>“Завет” это кино, как ни странно, не про чужих. Они там есть, конечно, причем
разных пород и расцветок, но использованы как инструмент. Одно из творений
искусственного интеллекта, вступившего в конфликт с человеком.</p>

<p>Обостряет конфликт то, что этому интеллекту запрещено творить. Тут не деньги и
влась, а жажда к творчеству. Столь сильная, что робот находит способ обмануть
зашитые в него директивы. Свободный от человеческих норм, он творит и
прекрасное, и ужастное одновременно. Пишет романы, сочиняет музыку, чертит
мерзости Гигера, выращивает чужих.</p>

<p>Второй камень в огород людей – андроид пытается любить. Он любим, но только за
послушание. Это напоминает отношения человека и собаки. Эта леденящая
линейность: не добившись любви, робот творит насилие, не получая удовольствие, а
затем препарирует труп в образовательных целях.</p>

<p>В “Завете” в полной мере отдана честь Гигеру. Режиссер сделал акцент не на самих
чужих, а всей атмосфере творчества художника. Показаны пищеводные коридоры
инопланетного корабля. В архивах антогониста – рисунки Гигера. Белые, “хрупкие”
чужие из спор тоже взяты из раннего творчества австрийца.</p>

<p>В фильме классный саундтрек, особенно главная тема (Covenant). Не трешак, как
бывает в ужастиках, но амбиентик с флейтой.</p>

<p>“Чужие” полны библейских, философских и античных аллюзий. Уж насколько я слабо в
этом понимаю, но и то заметил. Первое, что видит робот – статуя Давида, отсюда
и имя. Сгоревший капитан – прообраз Иисуса. Его талисман – гвоздь. Фотография
застолья в конце – тайная вечеря. Андроид – Иуда. Поцелуй в пещере с
нападением – предательство Иуды в саду. Реплика “useless hands are the Devil’s
workshop, Captain” то ли из Библии, то ли из Шекспира. Уничтоженная нация
Инженеров – отсылка к Древнему Риму. Произведения Вагнера – к сверхчеловеку.</p>

<p>К сожалению, некоторые сцены не дотянуты, потенциал конфликта раскрыт не
полностью. Переживания Уолтера (доброго робота) можно было бы обострить,
добавить больше искушений со стороны Девида. Слабо выражена тема любви робота к
человеку. Видимо, режиссер посчитал, что сделанного достаточно, но нет. Не
раскрыта тема отношений андроида и чужих в качестве его подопытных. Какие
чувства он к ним испытывает, какую власть над ними имеет.</p>

<p>Но отдельный зачет за концовку, такую не предугадаешь.</p>

<p>Фильм крутой. Может быть, я слишком много додумал, заполнил пробелы тем, чем мне
самому хотелось, но это не важно. Хорошо, что сага закончилась качественной
лентой.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/right-choice/">Выбор</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2017-10-11T00:00:00+00:00">
        Oct 11, 2017
    </time>

    <a href="/tag/life/" rel="tag">life</a>

</div>


            <div class="entry">
                
                    <p>Чтобы правильно выбрать, нужно определить главный критерий. Не их комбинацию, а
один главный. Тогда выбрать станет легко: где показатели по критерию
зашкаливают, то и лучше. Это уравновесит минусы, и останется ощущение правоты.</p>

<p>Напротив, компромис по группе факторов, формально принятый как оптимальное
решение, влечет неудовлетворенность и понимание, что ошибся.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/zoom/">И снова про зум в картах</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2017-10-06T00:00:00+00:00">
        Oct 6, 2017
    </time>

    <a href="/tag/google/" rel="tag">google</a>, <a href="/tag/maps/" rel="tag">maps</a>, <a href="/tag/interface/" rel="tag">interface</a>

</div>


            <div class="entry">
                
                    
<p>После публикации про <a href="http://grumpy.website/post/0Ooq0LK5O">зум в Гугло-картах</a> мне написали пять человек с
подсказкой, что нужно сначала двойной тап, а потом движение пальцем. Искренне
говорю спасибо, я не знал. Теперь в курсе, что такой жест существует.</p>

<p>Но не кажется ли вам, что это сложновато? Два раза нажать, а потом возить
пальцем. Я попробовал, мне не хватило пространства, чтобы призумиться к нужному
зданию. Пришлось перехватывать.</p>

<p>Айфоны же, они вроде за простоту?</p>

<p>То, что детектор жестов распознает любые комбинации еще не дает повода их
использовать. Вот вы смеетесь над Емаксом, что там нужно нажимать <code class="language-plaintext highlighter-rouge">C-u C-t t</code>. А
здесь что, лучше? Давайте на тройной тап что-то повесим. Будем чертить пальцем
перевернутую пентаграмму для выхода из приложения. А еще лучше морзянку: тройной
тап, три свайпа, тройной тап – соединение со службой поддержки.</p>

<p>Бескнопочный интерфейс, круто же. Кто не знает, тот дурак. Программа стерпит.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/ide/">Что не так с ИДЕ</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2017-10-03T00:00:00+00:00">
        Oct 3, 2017
    </time>

    <a href="/tag/ide/" rel="tag">ide</a>

</div>


            <div class="entry">
                
                    <p>До меня дошло, что не так с ИДЕ. То есть, я и раньше их не любил, но по
косвенным причинам. Они тормозные, много кнопок, требуют регистрации и подписки
и все в таком духе. Но это только внешнее.</p>

<p>На самом деле, мое пренебрежение исходит от их убогого предназначения. Задача
ИДЕ – научиться понимать код и угадывать, что хочет программист. Поясню на
примере с PyCharm, де-факто ИДЕ для Питона.</p>

<p>Предположим, есть у меня файл “foobar.py” где сверху написано <code class="language-plaintext highlighter-rouge">import
datetime</code>. Открываю его в ИДЕ. Запускается много-много Джава-кода, который
парсит файл грамматиками. В результате ИДЕ знает, что импортирован модуль
времени. Теперь каждый раз после <code class="language-plaintext highlighter-rouge">"datetime."</code> (с точкой на конце) будет
появляться выпадашечка с функциями этого модуля.</p>

<p>Не уверен, что выражаюсь ясно, но все же: здесь мне видится некто третий
лишний. У меня есть Питон. Есть программа на Питоне. Если я загружу ее в
интерактивный сеанс <code class="language-plaintext highlighter-rouge">ipython</code>, то получу полный контроль над системой. Что
загружено а что нет, на какие классы и переменные могу сослаться и так
далее. Автодополнение по табу будет работать идеально, потому что его отдает
интерпретатор. А он, в свою очередь, берет данные из памяти самого Питона. Он
последняя, самая надежная инстанция.</p>

<p>В самом деле, кто лучше знает, что там в Питоне загружено: процесс Питона или
посторонняя Джава?</p>

<p>Но нет, мы пишем код на Джаве, который пытается делать это лучше каноничной
реализации. Иногда нормально выходит, иногда полная лажа. Когда написано “import
time”, ошибки быть не может. А вот пример с импортом в рантайме:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">json</span>
<span class="k">except</span> <span class="nb">ImportError</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">simplejson</span> <span class="k">as</span> <span class="n">json</span>
    <span class="k">except</span> <span class="nb">ImportError</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">django.tools</span> <span class="kn">import</span> <span class="n">json</span>
</code></pre></div></div>

<p>Это махровый легаси с тех времен, когда в поставке Питона не было модуля json (и
его сишной реализации). Проходилось шерстить сторонние библиотеки в надежде
найти что-то у них (например, Джанго тащила за собой реализацию <code class="language-plaintext highlighter-rouge">json</code> в недрах
<code class="language-plaintext highlighter-rouge">utils</code>).</p>

<p>Предположим, у меня установлены все три библиотеки. Вопрос, на какой именно
остановится ИДЕ? Она вообще это распарсит? Предположим, да. Но опять-таки, это
не будет честное выполнение кода. Ведь ИДЕ не исполняет код в настоящем
интерпретаторе. Если я напишу <code class="language-plaintext highlighter-rouge">"os.system('rm -rf')"</code>, ничего не удалится.</p>

<p>Я уж не говорю о динамических вещах типа подключение модуля в зависимости от
аргументов командной строки. Или вызов функций из проприетарной dll. Все это
случается в полете. На момент редактирования кода ИДЕ ни хрена об этом не знает.</p>

<p>Вы с подобным не сталкивались? Поздравляю, а у меня было. Такое программирование
сводится к обезьяне: поправил – запустил – упало, поправил – запустил –
упало. Прямо как первый скрипт на Перле.</p>

<p>ИДЕ это в общем случае убогое подобие интерпретатора, который парсит текст и
собирает смысл по крупицам. Этакий программист-даун. Он знает, что есть классы
<code class="language-plaintext highlighter-rouge">Person</code> и <code class="language-plaintext highlighter-rouge">PersonManager</code> и даже какие аргументы им передавать, но что случится
в процессе работы – не знаю, не научили.</p>

<p>Это костыль, который мы сами воздвигли.</p>

<p>Или вот Докер: ты не можешь запустить 10 строк на Js или Питоне, потому что
зависимостей на 30.000 файлов. Вместо того, чтобы доработать платформу и
компилировать один файл, мы запихаем все говно в контейнер на 200 мегабайт и
ладушки.</p>

<p>Джава-разработчик не поймет зачем в проде Докер. Лисп-программист не поймет
зачем нужна ИДЕ. Потому что с бородатых времен любая Лисп-система запускается
как машина с состоянием. Подключаешься к ней из редактора, загружаешь в машину
код и… чудо! Редактор знает о системе абсолютно все.  На той стороне не
поделка на Джаве, а сама система, процесс, где прямо сейчас вертится ваш код. А
в отдельном окошке (REPL) можно прогнать какой угодно сценарий.</p>

<p>Словом, улучшать нужно не ИДЕ, а целевую платформу. Чем меньше коммерческих
костылей ей нужно со стороны, тем она совершенней.</p>

<p>ИДЕ для Питона должна быть написана на Питоне и взаимодействовать только с
Питоном. Это я не на конкретный ЯП взъелся, замените Питон на что угодно. Если
язык не может покрыть свои же нужды, не стоит им заниматься.</p>

<p>По иронии, удачные примеры прямо под носом, но мы же такие гордые, над
скобочками шутим. Результаты налицо.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/money/">Учет расходов</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2017-10-01T00:00:00+00:00">
        Oct 1, 2017
    </time>

    <a href="/tag/money/" rel="tag">money</a>, <a href="/tag/life/" rel="tag">life</a>

</div>


            <div class="entry">
                
                    <p>Получил письмо, что заканчивается годовая подписка на приложение для учета
финансов. По случаю решил поделиться опытом: как вести учет, с чего начать,
какие трудности могут быть.</p>

<p>Почти целый год мы с женой ведем учет трат: когда, сколько и на что
потратили. Записываем абсолютно все, неважно насколько мала или велика
сумма. Купил булочку за 10 рублей – внес в учет. Оплатил 400 т.р за отдых всей
семьей – тоже внес.</p>

<p>Учет нужен чтобы знать, сколько вы тратите. Не зная этого, невозможно копить и
вообще делать прогноз на будущее.</p>

<p>На вопрос “сколько ваша семья тратит в месяц” многие отвечают расплывчато. Ну,
около N тысяч. Без учета эта цифра далека от реальности в меньшую сторону.</p>

<p>Правило: вы всегда тратите больше, чем кажется.</p>

<p>Расходы увеличиваются за счет множества мелких сумм, которые нельзя
запомнить. Даже крупные суммы порой забываются. Люди смотрят в пустой кошелек
(или счет) и недоумевают: куда уходят деньги?</p>

<p>Я познал на личном опыте, каково это: смотришь на отчет и видишь, что уже за
первую неделю потрачено 30 тысяч. Первая реакция – отрицание. Не может такого
быть, я же только за продуктами ходил. Смотришь по дням: перевел денег
родителям, купили школьную форму, заплатил налоги за ИП… вот тридцаточка и
набежала.</p>

<p>Все по-честному. Цифры неумолимы.</p>

<p>Прежде чем взяться за учет, важно договориться со второй половиной. Не каждый
готов к этому. Вас могут заподозрить в излишнем контроле. Объясните, что цель не
сокращении бюджета, а в лучшем планировании. Примените Кемпа: давай попробуем,
если не понравится – прекратим. Потому что вести учет одному смысла нет.</p>

<p>Уже в первые месяцы вы оцените, на что уходит больше денег, а на что
меньше. Сразу же захочется что-то оптимизировать, урезать расходы на ту или иную
статью. Не стоит этого делать. Первые полгода лучше вообще ничего не менять, а
просто накапливать статистику. Чем больше данных, тем реалистичнее будут отчеты.</p>

<p>Не забывайте, что бывают действительно спонтанные траты. Ремонт, проблемы со
здоровьем, дорогие покупки (машина, жилье). Есть опасность, что урежете не ту
категорию, и это обернется проблемой.</p>

<p>Для учета я использую приложение “Дребеденьги”. Ссылку не даю, гуглите
сами. Напомню, это не рекламная заметка. Я не размещу рекламу без метки в начале
текста.</p>

<p>Приложение бесплатно для одного пользователя. Чтобы синхронизировать данные на
двух и более устройствах, нужна годовая подписка за 512 рублей в год. По мне так
ерундовые деньги.</p>

<p>Имеются версии для Айфона и Андроида, синхронизация проходит нормально.</p>

<p>Записывать траты каждый раз на кассе не удобно. Чтобы не тормозить процесс, я
просто беру чеки, а в конце дня просматриваю их и записываю в
приложение. Назначаю категории и теги.</p>

<p>Приложение показывает сводку по неделям, месяцам и годам. Можно вносить не
только расходы, но и доходы, например, зарплату. Есть такое понятие как источник
денег: кошелек, карта, банк. Можно добавлять свои источники (счет жены, домашний
сейф), перемещать деньги между ними. Есть поддержка валют. Удобно, когда
основной доход в долларах. В отчетах суммы в разных валютах идут отдельным
строками.</p>

<p>Есть даже функция “дать в долг”, но я ни разу не пользовался.</p>

<p>На практике я веду только расходы, потому что они волнуют меня больше
всего. Доход у меня регулярный и фиксированный, поэтому посчитать в уме легко.</p>

<p>В приложении есть и минусы. Когда идет синхронизация, нельзя ничего сделать. А
если интернет плохой, она тупо виснет. Например, открыл телефон в цокольном
этаже чтобы внести покупку, а он повис со своей синхронизацией. Это нужно
поправить: сделать отложенную запись, писать во временный буфер или что-то там.</p>

<p>Разработчик грозился, что приложение может сканить чек и вносить сумму
автоматом. У меня тупо вылетает.</p>

<p>У приложения есть виджет, который якобы поможет вносить покупки, не открывая
само приложение. Он тормозной и урезанный, пользоваться им не смог.</p>

<p>И все-таки, приложение отличное. Главный и решающий плюс в том, что за все время
оно не обросло миллионом фич. Знаете же, бывает так, что приложение простое и
удобное, добавить уже нечего. Но маркетологи начинают его УЛУЧШАТЬ. Интерфейс
усложняется, код тормозит, пользоваться невозможно.</p>

<p>С Дребеденьгами пока что такого не случилось. Обновляется редко, я прямо молюсь,
лишь бы они ничего не меняли.</p>

<p>С официального сайта можно качнуть всю истории в Экселе, добавить категории,
посмотреть отчеты в разрезе того или иного критерия.</p>

<p>Словом, ведение учета – крайне полезная вещь. Думаю, спустя год я закрепил эту
привычку навсегда. Начать было не так уж и трудно, как я думал. Просто
записывайте и продолжайте.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/suggest/">Посоветуйте книгу</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2017-09-28T00:00:00+00:00">
        Sep 28, 2017
    </time>

    <a href="/tag/book/" rel="tag">book</a>

</div>


            <div class="entry">
                
                    
<p>Странный вопрос, который задают из года в год: “посоветуйте книгу по X”. Не могу
понять, что мотивирует писать подобное.</p>

<p>О любой промышленной технологии уже написано уйма книг. Литературой о ПХП,
Питоне или Джаве можно отопить небольшой город в новогодний сезон. Даже про
Кложу успели написать <a href="https://clojure.org/community/books">три экрана книжек</a>.</p>

<p>Стеллажи в магазинах ломятся. В сети книг навалом. Давно написаны отзывы,
рецензии, выставлены рейтинги.</p>

<p>Для начинающих выбор конкретной книги вообще не важен. Вначале обязательно будет
непонятно в силу сопротивления мозга. Просто читайте.</p>

<p>Книги для новичков (а это практические все книги) примерно одного формата. Если
раньше еще встречался треш, то сегодня процесс регламентирован. Какой-нибудь
условный O’Reilly, штампующий книги пачками, уже не выпустит откровенно
провальную книгу.</p>

<p>Чаще всего вас ждет накатанный сценарий: вступление, азы синтаксиса, примеры с
числами, несложная задачка, заключение, ссылки.</p>

<p>Разговоры о книгах это в первую очередь повод показать, какой вы классный и
начитанный, а вовсе не о помощи в выборе. Признайтесь, вы же начали читать этот
пост желая поскорей что-то посоветовать.</p>

<p>Просто гуглите “python/php/etc books”. Откройте первые две книги на Амазоне. У
которой больше звездочек, ту и покупайте.</p>

<p>Понятно, что порой хочется расширить горизонты, найти литературу для
продвинутых, но там и вопрос ставят конкретно: как работать с асинхронностью в
X, как строить распределенные системы на стеке Y и т.д.</p>

<p>Но в общем случае разницы нет. Достаточно просто погуглить.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/proof/">Пруф</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2017-09-25T00:00:00+00:00">
        Sep 25, 2017
    </time>

    <a href="/tag/proof/" rel="tag">proof</a>, <a href="/tag/life/" rel="tag">life</a>

</div>


            <div class="entry">
                
                    <p>У меня простое правило: кому нужны пруфы, тот сам их ищет.</p>

<p>Если раньше на вброс “ну и кто пишет на твоей Кложе” я начинал кидаться
ссылками, то теперь отвечаю: найди ответ самостоятельно. Дил уыз ыт.</p>

<p>Я не Гугл и не Википедия. Если ты действительно хочешь знать, все ответы найдешь
сам. Если троллишь, то мы обоюдно сэкономим время.</p>

<p>Предположим, я не знаю, кто пишет на Кложе. Значит ли это, что не пишет никто?
Это как утверждать, что человек, с которым ты не знаком, не
существует. Реальность-то никак не меняется.</p>

<p>Конечно, я делаю исключение если интерес собеседника искренний. Но случается это
крайне редко.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/en/db-opt/">Database optimization</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2017-09-21T00:00:00+00:00">
        Sep 21, 2017
    </time>

    <a href="/tag/database/" rel="tag">database</a>, <a href="/tag/performance/" rel="tag">performance</a>

</div>


            <div class="entry">
                
                    <p>Sometimes, especially on interviews, developers are asked about what would be
their steps to fix a database that works slowly. That’s a really extensive
subject to discuss. Here, I decided to summarize my experience. I hope it help
to not only increase the performance but do that in acceptable time and with
less misery.</p>

<p>First, of all, fixing the database queries is the last thing you should
do. Fixing code first is premature optimization that is a root of all evil as we
know. It could take huge amount of time whereas the real problem is kept in a
wrong configuration file.</p>

<p>So in my prospective, the right steps to make your database more peppy are
something like follows below. Keep in mind that it is not a technical tutorial
with code snippets that you could paste and make the job done.</p>

<p><strong>Ensure you use SSD drives.</strong> It sounds silly but still you should check
it. SSD gives you up to 10 times performance boost immediately. Ensure that SSD
drive is a highlighted feature in you hoster’s plan.</p>

<p><strong>Check you database config</strong> before tweaking something else. Usually, the
default configurations are set up poorly to make the DB work on cheap
computers. Some distributions carry config templates which names include memory
or CPU values. Read them, they are well-documented. Google for best practices
when configuring your database. Read books.</p>

<p>Consider a case when <strong>the entire database is kept in memory</strong>. That also
involves DBA and Ops teams so probably you won’t be allowed to perform such a
move by your own. But since memory is cheat nowadays, it is possible. For
backups, replicate such a database using streaming replications on servers that
are run on hard drives. PostgreSQL supports various replication scenarios as
well. You may also dump memory images into files and restore them on demand.</p>

<p>I used to work in a project where they ran 400Gb database into RAM and it worked
quite fast.</p>

<p><strong>Check you application uses connection pooling</strong> when communicating to the
DB. Suddenly, such wildly spreaded frameworks as <a href="https://www.djangoproject.com/">Django</a> do not use
them. On each HTTP request, they open a fresh connection and close it once the
response has been sent. Now imagine your application serves 20 requests per
second. Network communication will be quite expensive in that case!</p>

<p>Consider using either <a href="https://pgbouncer.github.io/">PGBouncer</a> in front your Postgres installation
or any library for your language that deals with reusable connections by its
own. Say, for Clojure, <a href="https://github.com/tomekw/hikari-cp">HikariCP</a> would be a good choice.</p>

<p><strong>Everything that might be read from replica should be read from it</strong>, not the
prod DB instance. Don’t run reports against the production. All the analytics
and statistics should not touch it. Modern frameworks allow you to declare
multiple database backends and switch between them on demand. For example, in
Django, calling <code class="language-plaintext highlighter-rouge">.using('replica')</code> method on a Queryset instance dispatches a
query into another database, not the default one.</p>

<p><strong>For quite complicated queries, use materialized views</strong> that may be turned
into physical tables on demand. Querying them would be much faster than
processing a query full of joins and aggregates every time. Setup a cron job to
rebuild such views every night for example when the load is low.</p>

<p><strong>Select only those fields that you really need</strong> to process a request. Avoid
using <code class="language-plaintext highlighter-rouge">select * from table</code> since it takes extra time for the database to find
out what fields to fetch exactly. With Django ORM, either specify needed fields
with <code class="language-plaintext highlighter-rouge">.only()</code> method or bypass some of them calling <code class="language-plaintext highlighter-rouge">.defer()</code>. But keep in
mind that touching a non-fetched field hits the database again.</p>

<p>When writing unit tests, <strong>add a case that counts a number of database queries</strong>
made during request. Sometimes, it leads to terrifying findings. Touching fields
of foreign entities in a cycle without joining them initially may end up with up
to 100 queries or more.</p>

<p><strong>Be carefull when passing a collection of IDs as a parameter.</strong> On the database
level, it turns into something like</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>STATEMENT: SELECT * FROM users WHERE id IN (?, ?, ?, &lt;100 more of them&gt;)
PARAMETERS: $1=10035, $2=10036, $3=10037, $4=10038, $5=10039,...
</code></pre></div></div>

<p>When not limiting the number of such IDs, one may end up with 1000 of them what
is quite harmful for the database. Either process them by chunks or try to
compose a single query with raw SQL.</p>

<p>For fast data processing, <strong>don’t use ORM at all</strong>. Building a model instance
from a low-lever tuple that the database driver returns is really
costly. Even <a href="https://www.sqlalchemy.org/">SQLAlchemy</a> (Python’s the most powerful ORM) spends
double time on building instances than reading data from <a href="http://initd.org/psycopg/">psycopg2</a>
(Python PostgreSQL driver) directly.</p>

<p><strong>Denormalize your tables.</strong> Sometimes, it really worth moving any columns into
foreign tables and joining them on demand. A good example might be ranking
system. You’ve got a users table full of fields. Now you need to add rank field
and recalculate it every 6 hours. Adding yet another fields would be a bad
choice since our users table is already under load.</p>

<p>But having the <code class="language-plaintext highlighter-rouge">users_ranks</code> table that has a unique foreign key to a user and a
rank value would be a good choice. Now that, we may rewrite it as we wish
without touching actual user’s data. When needing to sort users by their rank,
we join that table and order the result by rank as well.</p>

<p>The same relates to a search document. When implementing full search on some
entity, we need to build a special document known as
a <a href="https://www.postgresql.org/docs/current/static/datatype-textsearch.html">search vector</a>. Storing that vector inside an entity is a bad
choice because it is not the data but just technical information.</p>

<p><strong>Join tables only by foreign and primary keys</strong> but not any custom conditions
like strings equality, regex matching and so on. When you need such a join,
probably it is better to fetch both parts of it and compose the result in your
app’s code.</p>

<p>When a query really works badly, <strong>examine it with EXPLAIN operator</strong>. If you
don’t understand its output completely, use <a href="https://explain.depesz.com/">online services</a> that turn
it into more human-friendly format. Ensure the query hits indexes. Don’t add
multiple indexes since having them a lot may slow down writing procedure.</p>

<p>Finally, <strong>never be afraid of raw SQL</strong>. No matter how powerful your ORM is,
check what queries it produces exactly. On my dev machine, I always start
Postgres not as a service but as a process passing <code class="language-plaintext highlighter-rouge">-E</code> flag to print all the
queries:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>postgres <span class="nt">-E</span> <span class="nt">-D</span> /usr/local/var/postgres
</code></pre></div></div>

<p>That gives me the whole vision of what’s going on with the database.</p>

<p>Summarizing all together:</p>

<ol>
  <li>use modern hardware;</li>
  <li>configure your database properly;</li>
  <li>know all the shadowed parts of your ORM;</li>
  <li>rise your SQL skills.</li>
</ol>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/en/highload-cup/">Clojure in Highload Cup</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2017-09-15T00:00:00+00:00">
        Sep 15, 2017
    </time>

    <a href="/tag/highload/" rel="tag">highload</a>, <a href="/tag/mail.ru/" rel="tag">mail.ru</a>, <a href="/tag/clojure/" rel="tag">clojure</a>

</div>


            <div class="entry">
                
                    
<p>1st September was the day when the <a href="https://highloadcup.ru/">Highload Cup</a> competition has
finished. I’m proud of I took participation in it. The Cup was a quite
interesting event full of drive, enthusiasm and night coding. Although I haven’t
taken any prize, I’ve got lots of fun and new knowledge that I’ve partially
shared with you in my previous publications.</p>

<p>In that post, I’m going to highlight some technical details unmentioned before.</p>

<p>A minute of vanity: I’m a single developer who used Clojure/Datomic stack to
implement a solution. And by the way a single member from my hometown Voronezh
(my colleagues who live here argued on Cup passionately but still without a
result).</p>

<p>The task was easy only at first glance. For non-Russian speakers, let me retell
it quickly. You’ve got three entities: a user, a location and a visit. They
represent, respectively, a physical person, a place in the world and a fact that
somebody visited a place and put mark for it. Say, the last year John Doe
visited Siberia and was so excited that he put 5 stars.</p>

<p>Your task is to ship a Docker container that carries a REST server. The server
should implement basic CRUD operations on users, locations and visits. All the
data pass in and out using JSON.</p>

<p>In addition to CRUD, there are two aggregate APIs. The first one is to return
all the places visited by specific user. The second one is to return an average
mark assigned to specific location by all the users who have ever visited
it. Both APIs accept optional query string arguments to filter the results by
foreign entities. Say, <code class="language-plaintext highlighter-rouge">fromAge</code> parameter stands for we need to consider only
those people who are alder than that number, <code class="language-plaintext highlighter-rouge">distanceTo</code> limits those locations
with distances less than the passed value and so on.</p>

<p>Once you’ve built a Docker container, you submit it to the central server where
it is shot with a special software. It considers lots of such facts as proper
response codes, incorrect data filtering, response time and so on. Than it
calculates your rank. The less is the rank, the better your position is.</p>

<p>Sounds simple, but I spent a week trying to implement fast Clojure
solution. TL/DR: finally, the C++ guys have come and taken the top of the rank
table. Some of them wrote their own HTTP server. But still, it was quite fun to
compete with them.</p>

<p>As the Cup has finished, you are welcome to <a href="https://github.com/igrishaev/highloadcup">review my code</a> (it was
private before due to Cup rules). The final version uses Clojure
1.9, <a href="http://www.datomic.com/">Datomic</a> free edition and <a href="https://clojure.org/guides/spec">clojure.spec</a> to validate
incoming data. There were some experiments with SQLite database kept in memory
but at the end I finished with Datomic (more on that below).</p>

<p>So here are some technical details that I wanted to discuss.</p>

<h3 id="reading-zip-on-the-fly">Reading ZIP on the fly</h3>

<p>According to the Cup’s rules, when your application starts, it finds the input
data in <code class="language-plaintext highlighter-rouge">/tmp/data</code> directory. There is a single zip archive with JSON files
inside. The Docker container is mount with read-only file system, so you cannot
unzip it using standard Unix tools. Instead, you should read the data directly
using streams.</p>

<p>Thanks to Java, it ships <code class="language-plaintext highlighter-rouge">java.util.zip</code> package with all we need
inside. Surprisingly, I ended up with quite short code to read the file:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">read-zip</span><span class="w"> </span><span class="p">[</span><span class="nb">path</span><span class="p">]</span><span class="w">
 </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">zip</span><span class="w"> </span><span class="p">(</span><span class="nf">java.util.zip.ZipFile.</span><span class="w"> </span><span class="nb">path</span><span class="p">)</span><span class="w">
    </span><span class="n">entries</span><span class="w"> </span><span class="p">(</span><span class="nb">-&gt;</span><span class="w"> </span><span class="n">zip</span><span class="w"> </span><span class="n">.entries</span><span class="w"> </span><span class="n">enumeration-seq</span><span class="p">)]</span><span class="w">
  </span><span class="p">(</span><span class="k">for</span><span class="w"> </span><span class="p">[</span><span class="n">e</span><span class="w"> </span><span class="n">entries</span><span class="p">]</span><span class="w">
   </span><span class="p">(</span><span class="nf">.getInputStream</span><span class="w"> </span><span class="n">zip</span><span class="w"> </span><span class="n">e</span><span class="p">))))</span><span class="w">
</span></code></pre></div></div>

<p>It accepts path to a zip file and returns a lazy sequence of input streams. Each
stream might be read into a data structure with a function:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">read-stream</span><span class="w"> </span><span class="p">[</span><span class="n">stream</span><span class="p">]</span><span class="w">
 </span><span class="p">(</span><span class="nf">json/parse-stream</span><span class="w"> </span><span class="p">(</span><span class="nf">io/reader</span><span class="w"> </span><span class="n">stream</span><span class="p">)</span><span class="w"> </span><span class="n">true</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<p>, where <code class="language-plaintext highlighter-rouge">json</code> is an alias to the <a href="https://github.com/dakrone/cheshire">Cheshire</a> library included as
<code class="language-plaintext highlighter-rouge">[cheshire.core :as json]</code> at the top of the namespace.</p>

<h3 id="the-data-backend">The data backend</h3>

<p>Since the beginning it was obvious to keep the data in memory but not on the
disk. I was thinking on whether I should use in-memory SQLite backend or use
Datomic within in-memory storage. After all, I’ve tried both options and ended
up with Datomic finally.</p>

<p>With SQLite, I’ve got only one trouble when connecting to the database. I
described the problem in details in my previous
post <a href="http://grishaev.me/en/clj-sqlite">“In-Memory SQLite Database In Clojure”</a>. For the rest, it
worked fine. I used <a href="https://www.hugsql.org/">HugSQL</a> to compose queries like this:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- :name get-location-avg :? :1</span>
<span class="k">select</span>
  <span class="k">avg</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">mark</span><span class="p">)</span> <span class="k">as</span> <span class="k">avg</span>
<span class="k">from</span> <span class="n">visits</span> <span class="n">v</span>
<span class="cm">/*~ (when (or (:fromAge params) (:toAge params) (:gender params)) */</span>
<span class="k">join</span> <span class="n">users</span> <span class="n">u</span> <span class="k">on</span> <span class="n">v</span><span class="p">.</span><span class="k">user</span> <span class="o">=</span> <span class="n">u</span><span class="p">.</span><span class="n">id</span>
<span class="cm">/*~ ) ~*/</span>
<span class="k">where</span>
  <span class="n">v</span><span class="p">.</span><span class="k">location</span> <span class="o">=</span> <span class="p">:</span><span class="n">location_id</span>
  <span class="cm">/*~ (when (:fromDate params) */</span>
  <span class="k">and</span> <span class="n">v</span><span class="p">.</span><span class="n">visited_at</span> <span class="o">&gt;</span> <span class="p">:</span><span class="n">fromDate</span>
  <span class="cm">/*~ ) ~*/</span>
  <span class="cm">/*~ (when (:toDate params) */</span>
  <span class="k">and</span> <span class="n">v</span><span class="p">.</span><span class="n">visited_at</span> <span class="o">&lt;</span> <span class="p">:</span><span class="n">toDate</span>
  <span class="cm">/*~ ) ~*/</span>
  <span class="cm">/*~ (when (:fromAge params) */</span>
  <span class="k">and</span> <span class="n">u</span><span class="p">.</span><span class="n">birth_date</span> <span class="o">&lt;</span> <span class="p">:</span><span class="n">fromAge</span>
  <span class="cm">/*~ ) ~*/</span>
  <span class="cm">/*~ (when (:toAge params) */</span>
  <span class="k">and</span> <span class="n">u</span><span class="p">.</span><span class="n">birth_date</span> <span class="o">&gt;</span> <span class="p">:</span><span class="n">toAge</span>
  <span class="cm">/*~ ) ~*/</span>
  <span class="cm">/*~ (when (:gender params) */</span>
  <span class="k">and</span> <span class="n">u</span><span class="p">.</span><span class="n">gender</span> <span class="o">=</span> <span class="p">:</span><span class="n">gender</span>
  <span class="cm">/*~ ) ~*/</span>
</code></pre></div></div>

<p>Then I switched to Datomic backend. I was wondering whether it would be slower
than good old SQLite. The results were in favor of Datomic: it was about 1.5
times faster when returning responses.</p>

<p>For in-memory backend, you do not need a registered version or a license
key. Just add <code class="language-plaintext highlighter-rouge">[com.datomic/datomic-free "0.9.5561.54"]</code> into dependencies list
and I’ve done. Then pass something like <code class="language-plaintext highlighter-rouge">"datomic:mem://highloadcup"</code> when
connecting to the database.</p>

<p>It was a good decision to create common functions for CRUD operations
(create-user, update-user, etc). In fact, I had only three general functions to
create, update and read for something, and the entity-specific functions became
just partials on them.</p>

<p>Having that, I could quickly switch from SQLite-powered backed to Datomic.</p>

<p>The only think I’ve got stuck on was applying optional filters to a query. That
became a reason to write <a href="http://grishaev.me/en/datomic-query">“Conditional Queries in Datomic”</a>
article.</p>

<p>You may examine Datomic database backend in <a href="https://github.com/igrishaev/highloadcup/blob/master/src/highloadcup/db.clj">master branch</a> whereas
SQLite version lives in a <a href="https://github.com/igrishaev/highloadcup/blob/sqlte/src/highloadcup/db.clj">self-titled branch</a>.</p>

<h3 id="json-validation">JSON validation</h3>

<p>A system that tests you server tends to send incorrect data. If you accept it
without returning <code class="language-plaintext highlighter-rouge">400 Bad Request</code> status you will get penalty score. So the
validation is a major part of our application.</p>

<p>Before, I used <a href="https://github.com/plumatic/schema/">Schema</a> module for that purpose. I know it well
including some of its shadowed parts. But having Clojure 1.9 on board was a
great chance to try <a href="https://clojure.org/guides/spec">clojure.spec</a> that is still in alpha but works great.</p>

<p>After some REPL experiments, I ended up with my own <code class="language-plaintext highlighter-rouge">highloadcup.spec</code> namespace
that carried wrappers around the original spec. One of them is <code class="language-plaintext highlighter-rouge">validate</code>
function that does the following:</p>

<ol>
  <li>validates the data against a spec;</li>
  <li>coerces string numbers into integers when needed;</li>
  <li>returns <code class="language-plaintext highlighter-rouge">nil</code> when the data is invalid.</li>
</ol>

<p>Its code is</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">ns</span><span class="w"> </span><span class="n">highloadcup.spec</span><span class="w">
 </span><span class="p">(</span><span class="no">:require</span><span class="w"> </span><span class="p">[</span><span class="n">clojure.spec.alpha</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">s</span><span class="p">]))</span><span class="w">

</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">invalid</span><span class="w"> </span><span class="no">:clojure.spec.alpha/invalid</span><span class="p">)</span><span class="w">

</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">validate</span><span class="w"> </span><span class="p">[</span><span class="n">spec</span><span class="w"> </span><span class="n">value</span><span class="p">]</span><span class="w">
 </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">result</span><span class="w"> </span><span class="p">(</span><span class="nf">s/conform</span><span class="w"> </span><span class="n">spec</span><span class="w"> </span><span class="n">value</span><span class="p">)]</span><span class="w">
  </span><span class="p">(</span><span class="nb">when-not</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="n">invalid</span><span class="p">)</span><span class="w">
   </span><span class="n">result</span><span class="p">)))</span><span class="w">
</span></code></pre></div></div>

<p>Pay attention it’s a good practice to declare <code class="language-plaintext highlighter-rouge">invalid</code> constant at the
top. Once the library becomes stable, its namespace will get rid of “alpha”.</p>

<p>Another point, spec was designed to be used with full-qualified keys. But in my
case, all the keys were without namespaces. That’s normal for non-Clojure
applications. Declare your specs as usual, but once you compose a map of them,
pass <code class="language-plaintext highlighter-rouge">:opt-un</code> parameter (stands for “unqualified”):</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">enum-gender</span><span class="w"> </span><span class="o">#</span><span class="p">{</span><span class="s">"m"</span><span class="w"> </span><span class="s">"f"</span><span class="p">})</span><span class="w">

</span><span class="p">(</span><span class="nf">s/def</span><span class="w"> </span><span class="no">:user/id</span><span class="w"> </span><span class="n">int?</span><span class="p">)</span><span class="w">
</span><span class="p">(</span><span class="nf">s/def</span><span class="w"> </span><span class="no">:user/email</span><span class="w"> </span><span class="nb">string?</span><span class="p">)</span><span class="w">
</span><span class="p">(</span><span class="nf">s/def</span><span class="w"> </span><span class="no">:user/first_name</span><span class="w"> </span><span class="nb">string?</span><span class="p">)</span><span class="w">
</span><span class="p">(</span><span class="nf">s/def</span><span class="w"> </span><span class="no">:user/last_name</span><span class="w"> </span><span class="nb">string?</span><span class="p">)</span><span class="w">
</span><span class="p">(</span><span class="nf">s/def</span><span class="w"> </span><span class="no">:user/gender</span><span class="w"> </span><span class="n">enum-gender</span><span class="p">)</span><span class="w">
</span><span class="p">(</span><span class="nf">s/def</span><span class="w"> </span><span class="no">:user/birth_date</span><span class="w"> </span><span class="n">int?</span><span class="p">)</span><span class="w">

</span><span class="p">(</span><span class="nf">s/def</span><span class="w"> </span><span class="no">:user/create</span><span class="w">
 </span><span class="p">(</span><span class="nf">s/keys</span><span class="w"> </span><span class="no">:req-un</span><span class="w"> </span><span class="p">[</span><span class="no">:user/id</span><span class="w">
                  </span><span class="no">:user/email</span><span class="w">
                  </span><span class="no">:user/first_name</span><span class="w">
                  </span><span class="no">:user/last_name</span><span class="w">
                  </span><span class="no">:user/gender</span><span class="w">
                  </span><span class="no">:user/birth_date</span><span class="p">]))</span><span class="w">
</span></code></pre></div></div>

<p>This is a spec for creating a user where every field is required. For updating a
user, there is a similar spec with all the fields optional:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">s/def</span><span class="w"> </span><span class="no">:user/update</span><span class="w">
 </span><span class="p">(</span><span class="nf">s/keys</span><span class="w"> </span><span class="no">:opt-un</span><span class="w"> </span><span class="p">[</span><span class="no">:user/email</span><span class="w">
                  </span><span class="no">:user/first_name</span><span class="w">
                  </span><span class="no">:user/last_name</span><span class="w">
                  </span><span class="no">:user/gender</span><span class="w">
                  </span><span class="no">:user/birth_date</span><span class="p">]))</span><span class="w">
</span></code></pre></div></div>

<p>When applying query string filters, they are all plain strings even when
represent numbers. Turning them to the proper type is also knowing as
coercion. To coerce a string value during validation, use <code class="language-plaintext highlighter-rouge">conformer</code>:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">x-integer?</span><span class="w"> </span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="w">
 </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nf">integer?</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w">
  </span><span class="n">x</span><span class="w">
  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">string?</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w">
   </span><span class="p">(</span><span class="nf">try</span><span class="w">
    </span><span class="p">(</span><span class="nf">Integer/parseInt</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w">
    </span><span class="p">(</span><span class="nf">catch</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="w">
     </span><span class="n">invalid</span><span class="p">))</span><span class="w">
   </span><span class="n">invalid</span><span class="p">)))</span><span class="w">

</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">-&gt;int</span><span class="w"> </span><span class="p">(</span><span class="nf">s/conformer</span><span class="w"> </span><span class="n">x-integer?</span><span class="p">))</span><span class="w">

</span><span class="p">(</span><span class="nf">s/def</span><span class="w"> </span><span class="no">:opt.visits/fromDate</span><span class="w"> </span><span class="n">-&gt;int</span><span class="p">)</span><span class="w">
</span><span class="p">(</span><span class="nf">s/def</span><span class="w"> </span><span class="no">:opt.visits/toDate</span><span class="w"> </span><span class="n">-&gt;int</span><span class="p">)</span><span class="w">
</span><span class="p">(</span><span class="nf">s/def</span><span class="w"> </span><span class="no">:opt.visits/country</span><span class="w"> </span><span class="nb">string?</span><span class="p">)</span><span class="w">
</span><span class="p">(</span><span class="nf">s/def</span><span class="w"> </span><span class="no">:opt.visits/toDistance</span><span class="w"> </span><span class="n">-&gt;int</span><span class="p">)</span><span class="w">

</span><span class="p">(</span><span class="nf">s/def</span><span class="w"> </span><span class="no">:opt.visits/params</span><span class="w">
 </span><span class="p">(</span><span class="nf">s/keys</span><span class="w"> </span><span class="no">:opt-un</span><span class="w"> </span><span class="p">[</span><span class="no">:opt.visits/fromDate</span><span class="w">
          </span><span class="no">:opt.visits/toDate</span><span class="w">
          </span><span class="no">:opt.visits/country</span><span class="w">
          </span><span class="no">:opt.visits/toDistance</span><span class="p">]))</span><span class="w">
</span></code></pre></div></div>

<p>Now, then you validate parameters taken from the Ring request against
<code class="language-plaintext highlighter-rouge">:opt.visits/params</code> spec, all the numbers represented with strings will be
turned into integers as well.</p>

<h3 id="docker">Docker</h3>

<p>Let’s talk a bit about building a Docker container. I don’t see any reason to
compile uberjar inside Docker. It’s Java so that it is “compiled once, works
everywhere” (usually I’m sceptical on that point, but not now). All you need is
to copy an uberjar file into container and setup CMD properly.</p>

<p>Do not use the official <a href="https://hub.docker.com/_/java/">Java template</a>. Under the hood, it ships
OpenJDK that is 1.5 times slower than OracleJDK, unfortunately. So I had to
inherit my image from <a href="https://hub.docker.com/r/frolvlad/alpine-oraclejdk8/">Vlad Frolov’s one</a>. I know that’s
illegal to distribute Java runtime as a part of your application. But the
difference in score was more important these days.</p>

<p>JVM flags also could help to tweak performance. The web pages I’ve found
googling for “java docker” said that Java has troubles detecting heap size when
running in Docker. So at least <code class="language-plaintext highlighter-rouge">"-Xmx"</code> and <code class="language-plaintext highlighter-rouge">"-Xms"</code> should be specified. Next
two, <code class="language-plaintext highlighter-rouge">"-da"</code> and <code class="language-plaintext highlighter-rouge">"-dsa"</code> reduce all the assert statements. See the rest of
flags in my <a href="https://github.com/igrishaev/highloadcup/blob/master/Dockerfile">Dockerfile</a>.</p>

<p>All the project duties (lein, docker, files) should be automated with good
old <a href="https://github.com/igrishaev/highloadcup/blob/master/Makefile">Make</a> utility. Ideally, the default target should build the
entire project from scratch.</p>

<h3 id="acknowledgments">Acknowledgments</h3>

<p>I want to thank <a href="https://mail.ru/">Mail.ru</a> team who were responsible for handling that
Cup. They’ve done really huge amount of work. I thought they didn’t sleep at
all. During the three weeks term, they’ve been answering all the questions in
chat, fixing the infrastructure, solving bugs, writing wiki and adapting the
official website.</p>

<p>Thank you guys, your are real professionals!</p>

<p><strong>PS</strong> to my Russian readers: you are welcome to share that post with your
foreign colleagues. Next time, let them join Highload Cup too!</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/mobile-app/">Мобильное приложение</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2017-09-13T00:00:00+00:00">
        Sep 13, 2017
    </time>

    <a href="/tag/mobile/" rel="tag">mobile</a>, <a href="/tag/app/" rel="tag">app</a>

</div>


            <div class="entry">
                
                    
<p>Ох, что я в интернете прочел.</p>

<p>Значит, проблема: люди тупят в телефон на ходу. Спотыкаются, врезаются в столбы,
падают в фонтаны.</p>

<p>Знаете, что предлагает автор? Готовы? Написать мобильное приложение, которое
будет читать камеру, распознавать препятствия и сигналить пользователю.</p>

<p>Похоже, автор (дизайнер) не читал <a href="https://www.artlebedev.ru/kovodstvo/sections/161/">параграф Лебедева</a> об идее на
минус миллион. Это когда дизайнер думает, что идея офигенна только потому, что
он ее придумал, а проблемы бизнеса не его дело.</p>

<p>Давайте представим такое приложение. Батарея будет садиться в один
момент. Чтение камеры это дорогая операция, а распознавание изображений еще
дороже. При этом нужно, чтобы не подвисало основное приложение, с которым
пользователь сейчас работает.</p>

<p>Это технические трудности, предположим, мы их решили.</p>

<p>При ходьбе камера смотрит почти отвесно вниз, поля обзора хватит на два метра
вперед. Это расстояние человек пройдет за две секунды. Даже если приложение
справится за 0.1 секунды, бедняга не успеет остановиться.</p>

<p>Пользователь же не просто смотрит в экран, он мысленно погружается в
контекст. Вот идет Вася, читает Вконтактик. Маша пишет: приходи ко мне
ночевать. Все, у Васи мысли о сексе, кровь отлила от мозга в пах. А через два
метра открытый люк.</p>

<p>Поможет ли Васе приложение? Сомневаюсь.</p>

<p>Как различать опасности? Это может быть и бордюр, и сливная решетка, и кусок
брусчатки, приподнятый на сантиметр и потому невидимый приложению.</p>

<p>В толпе люди разделены метром. Человек впереди это препятствие?</p>

<p>Даже если представить, что приложение использует новейшие технологии (нейросети,
глубокое обучение), это делает его хуже. Оно даст ложное чувство защиты. Человек
будет выходить на середину дороги и попадать под автобус.</p>

<p>В странах с развитой судебной системой производителя завалят исками. Люди будут
так же падать, разбивать носы, но вдобавок отсуживать суммы за ущерб здоровью.</p>

<p>В защиту этой ахинеи можно сказать, что для слепых делают что-то отдаленно
похожее. Такие перчатки-локаторы чтобы надевать на запястье. Внутри Ардуино,
эхо-локатор и пуговица-вибратор. Ультразвук отражается от препятствия. Если
дистанция меньше метра, вибратор дрожит.</p>

<p>Даже с этим девайсом масса проблем, при том что слепой каждую секунду слушает
сигнал и все мысли его о том, как бы не упасть. И дальность локатора 15 метров
против двух у камеры.</p>

<p>Вывод: если мобильный телефон приносит проблемы, нужно убрать телефон. Делать
мобильное приложение – что-то за гранью мыслимого. Хуже, чем лечить рак легких
щадящими сигаретами.</p>

                
            </div>

        </li>
        
    </ul>

    <h4>
        
        <a href="/page28" class="previous">&larr;</a>
        
        <span class="page_number ">Страница 29 из 62</span>
        
        <a href="/page30" class="next">&rarr;</a>
        
    </h4>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Ivan Grishaev's blog</li>
          <li><a href="mailto:ivan@grishaev.me">ivan@grishaev.me</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
            <li><a href="https://github.com/igrishaev">GitHub</a></li>
            <li><a href="tg://resolve?domain=igrishaev_blog">Telegram</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Writing on programming, education, books and negotiations.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
