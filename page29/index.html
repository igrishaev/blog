<!DOCTYPE html>
<html lang="ru">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Ivan Grishaev's blog</title>
  <meta name="description" content="Writing on programming, education, books and negotiations.
">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/custom.css">
  <link rel="canonical" href="https://grishaev.me/page29/">
  <link rel="alternate" type="application/rss+xml" title="Ivan Grishaev's blog" href="https://grishaev.me/feed.xml">

  <link rel="shortcut icon" type="image/x-icon" href="/assets/static/favicons/favicon.ico">

  <script type="text/javascript" src="/assets/typo.js"></script>

</head>


  <body>
    <header class="site-header">

    <div class="wrapper flex-container">

        <div>
            <a href="/">
                <img src="/assets/static/photo-round-small.png" alt="Ivan Grishaev">
            </a>
        </div>

        <div class="flex-container-vert" style="margin-left: 15px; width: 80%">

            <div class="flex-container full-width">
                <p style="margin-bottom: 5px">Ivan Grishaev's blog</p>
                <div class="flex-huge"></div>
                <div >
<form id="search-form"
      target="_blank"
      style="display: inline"
      method="get"
      action="https://www.google.com/search">

    <input name="sitesearch"
           value="grishaev.me"
           type="hidden">

    <input type="text"
           required="required"
           name="q"
           placeholder="Google search..."
           autocomplete="off">

    <button style="border: none; background-color: transparent; cursor: pointer;"
            type="submit">&#x1f50d;</button>

</form>
</div>
            </div>

            <p><small>Writing on programming, education, books and negotiations.
</small></p>

            <div class="flex-container">
                <a class="menu-item" href="/">Home</a>
                <a class="menu-item" href="/about/">About</a>
                <a class="menu-item" href="/bookshelf/">Bookshelf</a>
                <a class="menu-item" href="/feed.xml">RSS</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor" href="/tag/clojure/">Clojure</a>
                <a class="menu-item minor" href="/tag/emacs/">Emacs</a>
                <a class="menu-item minor" href="/tag/python/">Python</a>
                <a class="menu-item minor" href="/tag/programming/">Programming</a>
                <a class="menu-item minor" href="/interview/">Interview</a>
                <a class="menu-item minor" href="/video/">Video</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor hl" href="/clojure-in-prod/">Книга «Clojure на производстве»</a>
            </div>

        </div>
    </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="home">

    <ul class="post-list">
        
        <li>

            <h2>
                <a class="post-link" href="/en/highload-cup/">Clojure in Highload Cup</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2017-09-15T00:00:00+00:00">
        Sep 15, 2017
    </time>

    <a href="/tag/highload/" rel="tag">highload</a>, <a href="/tag/mail.ru/" rel="tag">mail.ru</a>, <a href="/tag/clojure/" rel="tag">clojure</a>

</div>


            <div class="entry">
                
                    
<p>1st September was the day when the <a href="https://highloadcup.ru/">Highload Cup</a> competition has
finished. I’m proud of I took participation in it. The Cup was a quite
interesting event full of drive, enthusiasm and night coding. Although I haven’t
taken any prize, I’ve got lots of fun and new knowledge that I’ve partially
shared with you in my previous publications.</p>

<p>In that post, I’m going to highlight some technical details unmentioned before.</p>

<p>A minute of vanity: I’m a single developer who used Clojure/Datomic stack to
implement a solution. And by the way a single member from my hometown Voronezh
(my colleagues who live here argued on Cup passionately but still without a
result).</p>

<p>The task was easy only at first glance. For non-Russian speakers, let me retell
it quickly. You’ve got three entities: a user, a location and a visit. They
represent, respectively, a physical person, a place in the world and a fact that
somebody visited a place and put mark for it. Say, the last year John Doe
visited Siberia and was so excited that he put 5 stars.</p>

<p>Your task is to ship a Docker container that carries a REST server. The server
should implement basic CRUD operations on users, locations and visits. All the
data pass in and out using JSON.</p>

<p>In addition to CRUD, there are two aggregate APIs. The first one is to return
all the places visited by specific user. The second one is to return an average
mark assigned to specific location by all the users who have ever visited
it. Both APIs accept optional query string arguments to filter the results by
foreign entities. Say, <code class="language-plaintext highlighter-rouge">fromAge</code> parameter stands for we need to consider only
those people who are alder than that number, <code class="language-plaintext highlighter-rouge">distanceTo</code> limits those locations
with distances less than the passed value and so on.</p>

<p>Once you’ve built a Docker container, you submit it to the central server where
it is shot with a special software. It considers lots of such facts as proper
response codes, incorrect data filtering, response time and so on. Than it
calculates your rank. The less is the rank, the better your position is.</p>

<p>Sounds simple, but I spent a week trying to implement fast Clojure
solution. TL/DR: finally, the C++ guys have come and taken the top of the rank
table. Some of them wrote their own HTTP server. But still, it was quite fun to
compete with them.</p>

<p>As the Cup has finished, you are welcome to <a href="https://github.com/igrishaev/highloadcup">review my code</a> (it was
private before due to Cup rules). The final version uses Clojure
1.9, <a href="http://www.datomic.com/">Datomic</a> free edition and <a href="https://clojure.org/guides/spec">clojure.spec</a> to validate
incoming data. There were some experiments with SQLite database kept in memory
but at the end I finished with Datomic (more on that below).</p>

<p>So here are some technical details that I wanted to discuss.</p>

<h3 id="reading-zip-on-the-fly">Reading ZIP on the fly</h3>

<p>According to the Cup’s rules, when your application starts, it finds the input
data in <code class="language-plaintext highlighter-rouge">/tmp/data</code> directory. There is a single zip archive with JSON files
inside. The Docker container is mount with read-only file system, so you cannot
unzip it using standard Unix tools. Instead, you should read the data directly
using streams.</p>

<p>Thanks to Java, it ships <code class="language-plaintext highlighter-rouge">java.util.zip</code> package with all we need
inside. Surprisingly, I ended up with quite short code to read the file:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">read-zip</span><span class="w"> </span><span class="p">[</span><span class="nb">path</span><span class="p">]</span><span class="w">
 </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">zip</span><span class="w"> </span><span class="p">(</span><span class="nf">java.util.zip.ZipFile.</span><span class="w"> </span><span class="nb">path</span><span class="p">)</span><span class="w">
    </span><span class="n">entries</span><span class="w"> </span><span class="p">(</span><span class="nb">-&gt;</span><span class="w"> </span><span class="n">zip</span><span class="w"> </span><span class="n">.entries</span><span class="w"> </span><span class="n">enumeration-seq</span><span class="p">)]</span><span class="w">
  </span><span class="p">(</span><span class="k">for</span><span class="w"> </span><span class="p">[</span><span class="n">e</span><span class="w"> </span><span class="n">entries</span><span class="p">]</span><span class="w">
   </span><span class="p">(</span><span class="nf">.getInputStream</span><span class="w"> </span><span class="n">zip</span><span class="w"> </span><span class="n">e</span><span class="p">))))</span><span class="w">
</span></code></pre></div></div>

<p>It accepts path to a zip file and returns a lazy sequence of input streams. Each
stream might be read into a data structure with a function:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">read-stream</span><span class="w"> </span><span class="p">[</span><span class="n">stream</span><span class="p">]</span><span class="w">
 </span><span class="p">(</span><span class="nf">json/parse-stream</span><span class="w"> </span><span class="p">(</span><span class="nf">io/reader</span><span class="w"> </span><span class="n">stream</span><span class="p">)</span><span class="w"> </span><span class="n">true</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<p>, where <code class="language-plaintext highlighter-rouge">json</code> is an alias to the <a href="https://github.com/dakrone/cheshire">Cheshire</a> library included as
<code class="language-plaintext highlighter-rouge">[cheshire.core :as json]</code> at the top of the namespace.</p>

<h3 id="the-data-backend">The data backend</h3>

<p>Since the beginning it was obvious to keep the data in memory but not on the
disk. I was thinking on whether I should use in-memory SQLite backend or use
Datomic within in-memory storage. After all, I’ve tried both options and ended
up with Datomic finally.</p>

<p>With SQLite, I’ve got only one trouble when connecting to the database. I
described the problem in details in my previous
post <a href="http://grishaev.me/en/clj-sqlite">“In-Memory SQLite Database In Clojure”</a>. For the rest, it
worked fine. I used <a href="https://www.hugsql.org/">HugSQL</a> to compose queries like this:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- :name get-location-avg :? :1</span>
<span class="k">select</span>
  <span class="k">avg</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">mark</span><span class="p">)</span> <span class="k">as</span> <span class="k">avg</span>
<span class="k">from</span> <span class="n">visits</span> <span class="n">v</span>
<span class="cm">/*~ (when (or (:fromAge params) (:toAge params) (:gender params)) */</span>
<span class="k">join</span> <span class="n">users</span> <span class="n">u</span> <span class="k">on</span> <span class="n">v</span><span class="p">.</span><span class="k">user</span> <span class="o">=</span> <span class="n">u</span><span class="p">.</span><span class="n">id</span>
<span class="cm">/*~ ) ~*/</span>
<span class="k">where</span>
  <span class="n">v</span><span class="p">.</span><span class="k">location</span> <span class="o">=</span> <span class="p">:</span><span class="n">location_id</span>
  <span class="cm">/*~ (when (:fromDate params) */</span>
  <span class="k">and</span> <span class="n">v</span><span class="p">.</span><span class="n">visited_at</span> <span class="o">&gt;</span> <span class="p">:</span><span class="n">fromDate</span>
  <span class="cm">/*~ ) ~*/</span>
  <span class="cm">/*~ (when (:toDate params) */</span>
  <span class="k">and</span> <span class="n">v</span><span class="p">.</span><span class="n">visited_at</span> <span class="o">&lt;</span> <span class="p">:</span><span class="n">toDate</span>
  <span class="cm">/*~ ) ~*/</span>
  <span class="cm">/*~ (when (:fromAge params) */</span>
  <span class="k">and</span> <span class="n">u</span><span class="p">.</span><span class="n">birth_date</span> <span class="o">&lt;</span> <span class="p">:</span><span class="n">fromAge</span>
  <span class="cm">/*~ ) ~*/</span>
  <span class="cm">/*~ (when (:toAge params) */</span>
  <span class="k">and</span> <span class="n">u</span><span class="p">.</span><span class="n">birth_date</span> <span class="o">&gt;</span> <span class="p">:</span><span class="n">toAge</span>
  <span class="cm">/*~ ) ~*/</span>
  <span class="cm">/*~ (when (:gender params) */</span>
  <span class="k">and</span> <span class="n">u</span><span class="p">.</span><span class="n">gender</span> <span class="o">=</span> <span class="p">:</span><span class="n">gender</span>
  <span class="cm">/*~ ) ~*/</span>
</code></pre></div></div>

<p>Then I switched to Datomic backend. I was wondering whether it would be slower
than good old SQLite. The results were in favor of Datomic: it was about 1.5
times faster when returning responses.</p>

<p>For in-memory backend, you do not need a registered version or a license
key. Just add <code class="language-plaintext highlighter-rouge">[com.datomic/datomic-free "0.9.5561.54"]</code> into dependencies list
and I’ve done. Then pass something like <code class="language-plaintext highlighter-rouge">"datomic:mem://highloadcup"</code> when
connecting to the database.</p>

<p>It was a good decision to create common functions for CRUD operations
(create-user, update-user, etc). In fact, I had only three general functions to
create, update and read for something, and the entity-specific functions became
just partials on them.</p>

<p>Having that, I could quickly switch from SQLite-powered backed to Datomic.</p>

<p>The only think I’ve got stuck on was applying optional filters to a query. That
became a reason to write <a href="http://grishaev.me/en/datomic-query">“Conditional Queries in Datomic”</a>
article.</p>

<p>You may examine Datomic database backend in <a href="https://github.com/igrishaev/highloadcup/blob/master/src/highloadcup/db.clj">master branch</a> whereas
SQLite version lives in a <a href="https://github.com/igrishaev/highloadcup/blob/sqlte/src/highloadcup/db.clj">self-titled branch</a>.</p>

<h3 id="json-validation">JSON validation</h3>

<p>A system that tests you server tends to send incorrect data. If you accept it
without returning <code class="language-plaintext highlighter-rouge">400 Bad Request</code> status you will get penalty score. So the
validation is a major part of our application.</p>

<p>Before, I used <a href="https://github.com/plumatic/schema/">Schema</a> module for that purpose. I know it well
including some of its shadowed parts. But having Clojure 1.9 on board was a
great chance to try <a href="https://clojure.org/guides/spec">clojure.spec</a> that is still in alpha but works great.</p>

<p>After some REPL experiments, I ended up with my own <code class="language-plaintext highlighter-rouge">highloadcup.spec</code> namespace
that carried wrappers around the original spec. One of them is <code class="language-plaintext highlighter-rouge">validate</code>
function that does the following:</p>

<ol>
  <li>validates the data against a spec;</li>
  <li>coerces string numbers into integers when needed;</li>
  <li>returns <code class="language-plaintext highlighter-rouge">nil</code> when the data is invalid.</li>
</ol>

<p>Its code is</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">ns</span><span class="w"> </span><span class="n">highloadcup.spec</span><span class="w">
 </span><span class="p">(</span><span class="no">:require</span><span class="w"> </span><span class="p">[</span><span class="n">clojure.spec.alpha</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">s</span><span class="p">]))</span><span class="w">

</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">invalid</span><span class="w"> </span><span class="no">:clojure.spec.alpha/invalid</span><span class="p">)</span><span class="w">

</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">validate</span><span class="w"> </span><span class="p">[</span><span class="n">spec</span><span class="w"> </span><span class="n">value</span><span class="p">]</span><span class="w">
 </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">result</span><span class="w"> </span><span class="p">(</span><span class="nf">s/conform</span><span class="w"> </span><span class="n">spec</span><span class="w"> </span><span class="n">value</span><span class="p">)]</span><span class="w">
  </span><span class="p">(</span><span class="nb">when-not</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="n">invalid</span><span class="p">)</span><span class="w">
   </span><span class="n">result</span><span class="p">)))</span><span class="w">
</span></code></pre></div></div>

<p>Pay attention it’s a good practice to declare <code class="language-plaintext highlighter-rouge">invalid</code> constant at the
top. Once the library becomes stable, its namespace will get rid of “alpha”.</p>

<p>Another point, spec was designed to be used with full-qualified keys. But in my
case, all the keys were without namespaces. That’s normal for non-Clojure
applications. Declare your specs as usual, but once you compose a map of them,
pass <code class="language-plaintext highlighter-rouge">:opt-un</code> parameter (stands for “unqualified”):</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">enum-gender</span><span class="w"> </span><span class="o">#</span><span class="p">{</span><span class="s">"m"</span><span class="w"> </span><span class="s">"f"</span><span class="p">})</span><span class="w">

</span><span class="p">(</span><span class="nf">s/def</span><span class="w"> </span><span class="no">:user/id</span><span class="w"> </span><span class="n">int?</span><span class="p">)</span><span class="w">
</span><span class="p">(</span><span class="nf">s/def</span><span class="w"> </span><span class="no">:user/email</span><span class="w"> </span><span class="nb">string?</span><span class="p">)</span><span class="w">
</span><span class="p">(</span><span class="nf">s/def</span><span class="w"> </span><span class="no">:user/first_name</span><span class="w"> </span><span class="nb">string?</span><span class="p">)</span><span class="w">
</span><span class="p">(</span><span class="nf">s/def</span><span class="w"> </span><span class="no">:user/last_name</span><span class="w"> </span><span class="nb">string?</span><span class="p">)</span><span class="w">
</span><span class="p">(</span><span class="nf">s/def</span><span class="w"> </span><span class="no">:user/gender</span><span class="w"> </span><span class="n">enum-gender</span><span class="p">)</span><span class="w">
</span><span class="p">(</span><span class="nf">s/def</span><span class="w"> </span><span class="no">:user/birth_date</span><span class="w"> </span><span class="n">int?</span><span class="p">)</span><span class="w">

</span><span class="p">(</span><span class="nf">s/def</span><span class="w"> </span><span class="no">:user/create</span><span class="w">
 </span><span class="p">(</span><span class="nf">s/keys</span><span class="w"> </span><span class="no">:req-un</span><span class="w"> </span><span class="p">[</span><span class="no">:user/id</span><span class="w">
                  </span><span class="no">:user/email</span><span class="w">
                  </span><span class="no">:user/first_name</span><span class="w">
                  </span><span class="no">:user/last_name</span><span class="w">
                  </span><span class="no">:user/gender</span><span class="w">
                  </span><span class="no">:user/birth_date</span><span class="p">]))</span><span class="w">
</span></code></pre></div></div>

<p>This is a spec for creating a user where every field is required. For updating a
user, there is a similar spec with all the fields optional:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">s/def</span><span class="w"> </span><span class="no">:user/update</span><span class="w">
 </span><span class="p">(</span><span class="nf">s/keys</span><span class="w"> </span><span class="no">:opt-un</span><span class="w"> </span><span class="p">[</span><span class="no">:user/email</span><span class="w">
                  </span><span class="no">:user/first_name</span><span class="w">
                  </span><span class="no">:user/last_name</span><span class="w">
                  </span><span class="no">:user/gender</span><span class="w">
                  </span><span class="no">:user/birth_date</span><span class="p">]))</span><span class="w">
</span></code></pre></div></div>

<p>When applying query string filters, they are all plain strings even when
represent numbers. Turning them to the proper type is also knowing as
coercion. To coerce a string value during validation, use <code class="language-plaintext highlighter-rouge">conformer</code>:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">x-integer?</span><span class="w"> </span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="w">
 </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nf">integer?</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w">
  </span><span class="n">x</span><span class="w">
  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">string?</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w">
   </span><span class="p">(</span><span class="nf">try</span><span class="w">
    </span><span class="p">(</span><span class="nf">Integer/parseInt</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w">
    </span><span class="p">(</span><span class="nf">catch</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="w">
     </span><span class="n">invalid</span><span class="p">))</span><span class="w">
   </span><span class="n">invalid</span><span class="p">)))</span><span class="w">

</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">-&gt;int</span><span class="w"> </span><span class="p">(</span><span class="nf">s/conformer</span><span class="w"> </span><span class="n">x-integer?</span><span class="p">))</span><span class="w">

</span><span class="p">(</span><span class="nf">s/def</span><span class="w"> </span><span class="no">:opt.visits/fromDate</span><span class="w"> </span><span class="n">-&gt;int</span><span class="p">)</span><span class="w">
</span><span class="p">(</span><span class="nf">s/def</span><span class="w"> </span><span class="no">:opt.visits/toDate</span><span class="w"> </span><span class="n">-&gt;int</span><span class="p">)</span><span class="w">
</span><span class="p">(</span><span class="nf">s/def</span><span class="w"> </span><span class="no">:opt.visits/country</span><span class="w"> </span><span class="nb">string?</span><span class="p">)</span><span class="w">
</span><span class="p">(</span><span class="nf">s/def</span><span class="w"> </span><span class="no">:opt.visits/toDistance</span><span class="w"> </span><span class="n">-&gt;int</span><span class="p">)</span><span class="w">

</span><span class="p">(</span><span class="nf">s/def</span><span class="w"> </span><span class="no">:opt.visits/params</span><span class="w">
 </span><span class="p">(</span><span class="nf">s/keys</span><span class="w"> </span><span class="no">:opt-un</span><span class="w"> </span><span class="p">[</span><span class="no">:opt.visits/fromDate</span><span class="w">
          </span><span class="no">:opt.visits/toDate</span><span class="w">
          </span><span class="no">:opt.visits/country</span><span class="w">
          </span><span class="no">:opt.visits/toDistance</span><span class="p">]))</span><span class="w">
</span></code></pre></div></div>

<p>Now, then you validate parameters taken from the Ring request against
<code class="language-plaintext highlighter-rouge">:opt.visits/params</code> spec, all the numbers represented with strings will be
turned into integers as well.</p>

<h3 id="docker">Docker</h3>

<p>Let’s talk a bit about building a Docker container. I don’t see any reason to
compile uberjar inside Docker. It’s Java so that it is “compiled once, works
everywhere” (usually I’m sceptical on that point, but not now). All you need is
to copy an uberjar file into container and setup CMD properly.</p>

<p>Do not use the official <a href="https://hub.docker.com/_/java/">Java template</a>. Under the hood, it ships
OpenJDK that is 1.5 times slower than OracleJDK, unfortunately. So I had to
inherit my image from <a href="https://hub.docker.com/r/frolvlad/alpine-oraclejdk8/">Vlad Frolov’s one</a>. I know that’s
illegal to distribute Java runtime as a part of your application. But the
difference in score was more important these days.</p>

<p>JVM flags also could help to tweak performance. The web pages I’ve found
googling for “java docker” said that Java has troubles detecting heap size when
running in Docker. So at least <code class="language-plaintext highlighter-rouge">"-Xmx"</code> and <code class="language-plaintext highlighter-rouge">"-Xms"</code> should be specified. Next
two, <code class="language-plaintext highlighter-rouge">"-da"</code> and <code class="language-plaintext highlighter-rouge">"-dsa"</code> reduce all the assert statements. See the rest of
flags in my <a href="https://github.com/igrishaev/highloadcup/blob/master/Dockerfile">Dockerfile</a>.</p>

<p>All the project duties (lein, docker, files) should be automated with good
old <a href="https://github.com/igrishaev/highloadcup/blob/master/Makefile">Make</a> utility. Ideally, the default target should build the
entire project from scratch.</p>

<h3 id="acknowledgments">Acknowledgments</h3>

<p>I want to thank <a href="https://mail.ru/">Mail.ru</a> team who were responsible for handling that
Cup. They’ve done really huge amount of work. I thought they didn’t sleep at
all. During the three weeks term, they’ve been answering all the questions in
chat, fixing the infrastructure, solving bugs, writing wiki and adapting the
official website.</p>

<p>Thank you guys, your are real professionals!</p>

<p><strong>PS</strong> to my Russian readers: you are welcome to share that post with your
foreign colleagues. Next time, let them join Highload Cup too!</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/mobile-app/">Мобильное приложение</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2017-09-13T00:00:00+00:00">
        Sep 13, 2017
    </time>

    <a href="/tag/mobile/" rel="tag">mobile</a>, <a href="/tag/app/" rel="tag">app</a>

</div>


            <div class="entry">
                
                    
<p>Ох, что я в интернете прочел.</p>

<p>Значит, проблема: люди тупят в телефон на ходу. Спотыкаются, врезаются в столбы,
падают в фонтаны.</p>

<p>Знаете, что предлагает автор? Готовы? Написать мобильное приложение, которое
будет читать камеру, распознавать препятствия и сигналить пользователю.</p>

<p>Похоже, автор (дизайнер) не читал <a href="https://www.artlebedev.ru/kovodstvo/sections/161/">параграф Лебедева</a> об идее на
минус миллион. Это когда дизайнер думает, что идея офигенна только потому, что
он ее придумал, а проблемы бизнеса не его дело.</p>

<p>Давайте представим такое приложение. Батарея будет садиться в один
момент. Чтение камеры это дорогая операция, а распознавание изображений еще
дороже. При этом нужно, чтобы не подвисало основное приложение, с которым
пользователь сейчас работает.</p>

<p>Это технические трудности, предположим, мы их решили.</p>

<p>При ходьбе камера смотрит почти отвесно вниз, поля обзора хватит на два метра
вперед. Это расстояние человек пройдет за две секунды. Даже если приложение
справится за 0.1 секунды, бедняга не успеет остановиться.</p>

<p>Пользователь же не просто смотрит в экран, он мысленно погружается в
контекст. Вот идет Вася, читает Вконтактик. Маша пишет: приходи ко мне
ночевать. Все, у Васи мысли о сексе, кровь отлила от мозга в пах. А через два
метра открытый люк.</p>

<p>Поможет ли Васе приложение? Сомневаюсь.</p>

<p>Как различать опасности? Это может быть и бордюр, и сливная решетка, и кусок
брусчатки, приподнятый на сантиметр и потому невидимый приложению.</p>

<p>В толпе люди разделены метром. Человек впереди это препятствие?</p>

<p>Даже если представить, что приложение использует новейшие технологии (нейросети,
глубокое обучение), это делает его хуже. Оно даст ложное чувство защиты. Человек
будет выходить на середину дороги и попадать под автобус.</p>

<p>В странах с развитой судебной системой производителя завалят исками. Люди будут
так же падать, разбивать носы, но вдобавок отсуживать суммы за ущерб здоровью.</p>

<p>В защиту этой ахинеи можно сказать, что для слепых делают что-то отдаленно
похожее. Такие перчатки-локаторы чтобы надевать на запястье. Внутри Ардуино,
эхо-локатор и пуговица-вибратор. Ультразвук отражается от препятствия. Если
дистанция меньше метра, вибратор дрожит.</p>

<p>Даже с этим девайсом масса проблем, при том что слепой каждую секунду слушает
сигнал и все мысли его о том, как бы не упасть. И дальность локатора 15 метров
против двух у камеры.</p>

<p>Вывод: если мобильный телефон приносит проблемы, нужно убрать телефон. Делать
мобильное приложение – что-то за гранью мыслимого. Хуже, чем лечить рак легких
щадящими сигаретами.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/center/">Центрирование курсора</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2017-09-11T12:45:00+00:00">
        Sep 11, 2017
    </time>

    <a href="/tag/editors/" rel="tag">editors</a>

</div>


            <div class="entry">
                
                    <p><img src="/assets/static/editors.png" alt="editors" /></p>

<p>В редакторах или IDE крайне редко встречается следующая функция.</p>

<p>Предположим, я дописываю код в конец файла. Если кода больше, чем один экран,
текст можно набирать только внизу. Промотать редактор на середину нельзя – файл
закончился, скролл вниз не работает.</p>

<p>Это страшно раздражает. Я привык, что глаза смотрят в центр экрана. Гораздо чаще
мы редактируем старый код нежели пишем новый, поэтому курсор в центре. Долго
смотреть вниз неудобно, устают глаза и шея.</p>

<p>Слева на картинке Саблайм. Файл закончился, набирать текст приходится внизу,
смотаться нельзя. Емакс проматывается в середину сам. Сочетание Ctrl+L
центрирует буфер по требованию, повторное нажатие перематывает вверх, оставляя
одну строчку. Обратите внимание, что буфер кончился, слева нет нумерации строк,
но для перемотки это не проблема.</p>

<p>В VS Code смотаться можно, но при редактировании внизу он проматывает на одну
строчку. Приходится мотать вручную, выполняя работу
машины. Написал-промотал. Емакс же сразу прыгает в центр экрана.</p>

<p>IDEA по умолчанию оставляет задел в пять пустых строчек в конце файла, но ниже
нельзя. Нормальная промотка включается где-то в недрах настроек. Опять же, нет
авто-центрирования.</p>

<p>Раньше я боролся с напастью так: зажимал Энтер и вставлял 50 переносов. Так я
мог проматывать файл ниже его логического конца, а с точки зрения редактора от
все еще продолжался. Время от времени эта дичь попадала в коммиты. Был и другой
вариант – сплющить окно редактора, чтобы оно доходило только до середины
экрана.</p>

<p>Почему об этом думали в 1970-бородатом году, а сейчас никого не волнует?</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/vk/">Вконтакт</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2017-09-11T09:45:00+00:00">
        Sep 11, 2017
    </time>

    <a href="/tag/vk/" rel="tag">vk</a>, <a href="/tag/idiots/" rel="tag">idiots</a>

</div>


            <div class="entry">
                
                    <p>Не могу передать, как меня бесит ВК. В нем все плохо. Дурацкое название с
предлогом. Убогий дизайн, когда нажимаешь на выпадашку, а там одна опция. Но
главная беда как раз в том, ради чего это это создавалось – в общении.</p>

<p>Предположим, хочу повесить объявление в группе жильцов ЖК. В шапке группы жирная
кнопка “написать сообщение”. Открывается диалог:</p>

<p><img src="/assets/static/vk.png" alt="vk" /></p>

<p>Минуточку, мне нужно, чтобы отвечали все, а не только администраторы. Или
остальные тоже могут? Как понять?</p>

<p>Что за ссылка “перейти к диалогу с сообществом”? А сейчас что, не диалог? На
всякий случай нажал, там пустой экран. Ясно, этим не пользуются. Зачем ссылка?</p>

<p>В группе есть “обсуждения”: жильцы второго дома, любители котят и тд. Этакий
форум из нулевых. Объявление в одном обсуждении не увидят в другом.</p>

<p>Сбоку ссылка на чат. Что-то вроде Телеграма, только внутри ВК. Слева личные сообщения.</p>

<p>Черт, как разместить текст, чтобы его прочли все жильцы?</p>

<p>Все засунуто под выпадашки, даже когда места полно. Всюду “еще”, “подробней” и
прочая импотенция.</p>

<p>Что за дизайнеры верстали все это? Кто это проектировал?</p>

<p>Я слышу: сперва добейся, потом предъявляй. Но совершенно
верно <a href="https://www.artlebedev.ru/kovodstvo/business-lynch/2016/04/04/commented/">сказал Лебедев</a>: если известная субстанция приносит много
денег, быть ею от этого она не перестает.</p>


                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/kids/">Дети</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2017-09-08T00:00:00+00:00">
        Sep 8, 2017
    </time>

    <a href="/tag/kids/" rel="tag">kids</a>, <a href="/tag/life/" rel="tag">life</a>

</div>


            <div class="entry">
                
                    <p>Чтобы ребенку было интересно, нужно, чтобы родителю было интересно. Чтобы
ребенку нравилось, нужно, чтобы родителю тоже нравилось.</p>

<p>Удивительно, как много взрослых не понимают этой банальности. Они считают, что
ребенку можно на весь день включить мультики и забыть о его существовании. Что
можно подарить книгу, и типа читай сам. Что можно подарить китайское говно
взамен качественной вещи.</p>

<p>Дети все прекрасно понимают. В силу физиологии они не могут развернуто
сформировать претензию или обиду. Но халтуру чуют за версту. Это особенно
заметно в период с 2 до 3 лет, когда речь еще толком не поставлена, но уже есть
устойчивые вкусы и понимание всего, что происходит вокруг.</p>

<p>Чтобы ребенок с упоением читал, нужно читать ему каждый день несколько
лет. Чтобы с интересом смотрел мультик и понимал сюжет, нужно смотреть вместе с
ним.</p>

<p>Качественная детская продукция мало чем отличается от аналогов для
взрослых. Если это игрушка, она должна иметь приятные пропорции, быть устойчивой
к неаккуратному обращению, не звучать слишком громко. Если техника, то быть
правильно спроектированной, с понятным дизайном, качественной сборкой.</p>

<p>Если это мультфильм, то повествование должно быть последовательным, проблемы
персонажей понятны, хорошо прослеживается главная мысль: обманывать нехорошо или
если накосячил, то исправь.</p>

<p>Никогда не делайте скидку на то, что это ребенок. Он такой же человек, как и
вы. Критерии качества у детей такие же высокие.</p>

<p>Остается печальный случай, когда ребенок потребляет халтуру (вещи, информацию)
из-за отсутствия вкуса у родителей. Увы, эта проблема неразрешима и будет
передана на поколение вперед.</p>

<p>Может, и ваш ребенок одупляет телевизор третий час, пока вы это читаете?</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/grumpy/">Ворчание ягнят</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2017-09-07T00:00:00+00:00">
        Sep 7, 2017
    </time>

    <a href="/tag/grumpy/" rel="tag">grumpy</a>, <a href="/tag/design/" rel="tag">design</a>

</div>


            <div class="entry">
                
                    <p><a href="https://twitter.com/nikitonsky">Никита</a>
и <a href="https://twitter.com/freetonik">Рахим</a> запустили сайт, где можно посетовать на
дебильный
интерфейс. Встречайте, <a href="http://grumpy.website/">Ворчание ягнят</a>. Написан на
Кложе.</p>

<p>Дизайн не моя стихия, и писать в блог про каждую кривую кнопку мне кажется
лишним. Это скорее для Твиттера, но я с ним не дружен. Так что все наболевшее
шлю в приват Никите, а он обещал запостить.</p>

<p>Подписывайтесь по РСС, там будет изредка мелькать и от моего имени.</p>

<p><strong>UPD</strong> стрим в процессе создания:</p>

<iframe width="668" height="510" src="https://www.youtube.com/embed/YZzkQW9Unvo?list=PLdSfLyn35ej-oCU2w8fKfdEih7ME7Jhq8" allowfullscreen=""></iframe>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/firefox/">Фаерфокс</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2017-09-07T00:00:00+00:00">
        Sep 7, 2017
    </time>

    <a href="/tag/firefox/" rel="tag">firefox</a>, <a href="/tag/browsers/" rel="tag">browsers</a>

</div>


            <div class="entry">
                
                    <p>Мне кажется, в недалеком будущем Фаерфокс умрет. Не полностью и не буквально,
конечно. Просто сократит долю рынка настолько, что станет неликвидным. Ему
присвоят звание “жемчужины опен-сорса”, гики будут стенать, причитать и сидеть
на неподдерживаемой версии трехлетней давности, как это случилось с Оперой после
перехода на Веб-кит. На поддержке останутся FF-only легаси-системы.</p>

<p>Кто-то сказал, что браузеры – продукт массового потребления. В целом, они все
работают хорошо и покрывают нужды рядового пользователя. Уже нет проблем с
отрисовкой элементов. Основные усилия уходят на то, чтобы еще теснее
интегрировать браузер с операционной системой и сервисами компаний.</p>

<p>В этом плане все в порядке у Хрома, Сафари и Эджа (который Эксплорер). Гугл
вливает в браузер колоссальные деньги, поскольку Хром – это окно во все
сервисы: рекламу, почту, карты. Сафари связан с Маком и системой Эпла. Эдж,
понятно, по самые уши интегрирован с Виндой, Бингом, Икс-боксом, офисным
пакетом.</p>

<p>Одного браузера недостаточно, нужны сервисы. Свои некоторые программы Гугл
подкрепляет расширениями в Хроме. Так, при открытии Гугло-дока Хром молча ставит
расширения Google Docs, Google Sheets и другие. Так они работают быстрее. А с
чем интегрироваться Фаерфоксу?</p>

<p>На рынке могут появиться разработки для снобов вроде Вивальди. Они обязательно
снискают своего пользователя, но никогда не выйдут на массовый
рынок. Потенциально новый браузер могут предложить только гиганты вроде Амазона
или Фейсбука.</p>

<p>Лично мои претензии к Фаерфоксу в том, что во-первых, он работает медленней
Хрома. Пусть меньше загружены процессор и память, мое время дороже. Второе,
Фаерфокс весь из себя для гиков. Это слегка умиляет, но в долгосрочной
перспективе раздражает, потому что браузер нужен не только для работы, но и
развлечения.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/reality/">Реальность</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2017-09-05T00:00:00+00:00">
        Sep 5, 2017
    </time>

    <a href="/tag/reality/" rel="tag">reality</a>

</div>


            <div class="entry">
                
                    <p>В плане профессии я знаю очень мало.</p>

<p>На Си и Ассемблере писал только в институте, уже ничего не помню.</p>

<p>Плаваю в указателях, памяти, куче. Код на C++ не понимаю.</p>

<p>О нейросетях и машин-лернинге имею самые смутные представления.</p>

<p>Про Биткоин читал только пару бульварных статей.</p>

<p>Знаю три команды из Гита. Путаю, что куда мерджить.</p>

<p>Накупил книжек, поставил пылиться на полку.</p>

<p>Не напишу и пяти строчек на баше без интернетов.</p>

<p>Не дочитал SICP. Хотел сделать все практические задания, слился.</p>

<p>Кнут только в самых влажных мечтах.</p>

<p>Компилятор или язык в жизни не осилю.</p>

<p>Пилил свой проект, бросил.</p>

<p>Пишу на Кложе, но в Джаве ни бум-бум. На Кложе потому, что язык редкий.</p>

<p>Всю жизнь клепаю формочки к базе.</p>

<p>Ненавижу JS, потому что не понимаю его, или наоборот.</p>

<p>Емакс и Лисп чтобы быть не таким как все.</p>

<p>Говорю по-английски с проблемами. Ссу провести вебинар на английском.</p>

<p>Гуглю каждый HTML-тег. Копипащу со Стека.</p>

<p>Умничаю в чате. Высмеиваю мессаджеры, сам же ими пользуюсь.</p>

<p>Не знаю нужных хоткеев, не ставлю клевых программ.</p>

<p>Не трекаю время, непродуктивен. Прокрастинирую.</p>

<p>Разбираюсь только в Лиспе, Мейк-файлах и немного в Постгресе. Тем и живу.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/en/datomic-query/">Conditional Queries in Datomic</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2017-09-01T20:49:00+00:00">
        Sep 1, 2017
    </time>

    <a href="/tag/clojure/" rel="tag">clojure</a>, <a href="/tag/datomic/" rel="tag">datomic</a>, <a href="/tag/sql/" rel="tag">sql</a>

</div>


            <div class="entry">
                
                    <p>Let’s discuss one thing related to Clojure and Datomic that might be a bit
tricky especially if you have never faced it so far.</p>

<p>Imagine you return a list of some entities to the client. It might be a list of
orders, visits or whatever. Usually, when a user is exploring a long list of
something, it’s a good idea to let them filter the list by some criteria: price,
date, age etc. On the server side, you need to apply those filters
conditionally. Say, when the <code class="language-plaintext highlighter-rouge">date_from</code> query string parameter is passed, you
apply it to the query as well or live it untouched otherwise. The same for the
rest of filters.</p>

<p>Things become more tough when filters are applied to foreign entities. For
example, an order references a user, and a user references a department. If the
<code class="language-plaintext highlighter-rouge">department_name</code> parameter has been passed, you should join all the required
tables and filter a proper field.</p>

<p>Joining all the tables even if no filters were supplied is a wrong
approach. Join operations are expensive and should never be performed in vain. A
toolset that joins tables should take into account which ones has already been
added into a query and never link them twice.</p>

<p>Such systems that control the cases mentioned above are names ORMs. They are
pretty complicated and full of ugly code and implicit hacks. But on the top
level they behave quite friendly. Say, in <a href="https://www.djangoproject.com/">Django</a> (a major Python
framework) I would perform something like that:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">query</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">Order</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="nb">all</span><span class="p">()</span>
<span class="n">department_name</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">query_string</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"department_name"</span><span class="p">)</span>
<span class="k">if</span> <span class="n">department_name</span><span class="p">:</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="p">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">user__department_name</span><span class="o">=</span><span class="n">department_name</span><span class="p">)</span>
</code></pre></div></div>

<p>Looks pretty neat. This automatically joins <code class="language-plaintext highlighter-rouge">users</code> and <code class="language-plaintext highlighter-rouge">department</code> tables
under the hood using <code class="language-plaintext highlighter-rouge">inner join</code> SQL clause and puts <code class="language-plaintext highlighter-rouge">department.name = ?</code>
condition into <code class="language-plaintext highlighter-rouge">where</code> section.</p>

<p>People who work with such non-wide spreaded languages as Clojure usually do not
use ORMs. But still, we need to build complicated queries. The community offers
a handful of libraries (<a href="https://github.com/krisajenkins/yesql">YeSQL</a>, <a href="https://github.com/jkk/honeysql">HoneySQL</a>, <a href="https://github.com/korma/Korma">Korma</a>)
where a query is being constructed within data structures: vectors, maps. I’ve
been always against that approach. Before getting more experienced with Clojure,
I felt uncomfortable constructing nested vectors like this one:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[:select [:foo :bar]
 :from :test
 :where [(= :name "test")
         (when age-param
           (&gt; :age age-param))]]
</code></pre></div></div>

<p>The reason why I do not appreciate that is I cannot see the final query behind
brackets and colons. It will definitely fail me once I need to express
something like this (a fragment of a query from production):</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span>
  <span class="n">foo</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
  <span class="n">array_agg</span><span class="p">(</span><span class="n">foo</span><span class="p">.</span><span class="n">type_id</span><span class="p">)</span> <span class="n">filter</span> <span class="p">(</span><span class="k">where</span> <span class="n">foo</span> <span class="k">is</span> <span class="k">not</span> <span class="k">null</span><span class="p">)</span> <span class="k">as</span> <span class="n">type_ids</span><span class="p">,</span>
  <span class="n">foo</span><span class="p">.</span><span class="n">name</span>
<span class="k">from</span> <span class="n">foo_table</span> <span class="k">as</span> <span class="n">foo</span>
</code></pre></div></div>

<p>Modern libraries say it’s easy and fun to express your queries through data
structures, but it is not, really. It becomes a challenge when applying multiple
conditions to a data structure without seeing the final result.</p>

<p>A good approach might be using a templating system. Say, <a href="https://github.com/layerware/hugsql">HugSQL</a>
library allows to inject Clojure snippets into your SQL query. Those snippets
are surrounded with standard SQL comments so they do not break syntax. There
won’t be an error if you copy and paste such a Clojure-instrumented query into
some RDBS administration tool.</p>

<p>Here is an example of declaring such a query:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- :name get-oreders :?</span>
<span class="k">select</span> <span class="n">o</span><span class="p">.</span><span class="o">*</span>
<span class="k">from</span> <span class="n">oreders</span> <span class="n">o</span>
<span class="cm">/*~ (when (:department-name params) ~*/</span>
<span class="k">join</span> <span class="k">user</span> <span class="n">u</span> <span class="k">on</span> <span class="n">o</span><span class="p">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">u</span><span class="p">.</span><span class="n">id</span>
<span class="k">join</span> <span class="n">departments</span> <span class="n">d</span> <span class="k">on</span> <span class="k">user</span><span class="p">.</span><span class="n">department_id</span> <span class="o">=</span> <span class="n">d</span><span class="p">.</span><span class="n">id</span>
<span class="k">where</span>
    <span class="n">d</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="p">:</span><span class="n">department</span><span class="o">-</span><span class="n">name</span>
<span class="cm">/*~ ) ~*/</span>
<span class="k">order</span> <span class="k">by</span> <span class="n">o</span><span class="p">.</span><span class="n">created_at</span><span class="p">;</span>
</code></pre></div></div>

<p>Than it compiles into a Clojure function:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">;; no joins, no filters</span><span class="w">
</span><span class="p">(</span><span class="nf">get-oreders</span><span class="w"> </span><span class="n">db</span><span class="p">)</span><span class="w">

</span><span class="c1">;; causes joins and filtering</span><span class="w">
</span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">dep-name</span><span class="w"> </span><span class="p">(</span><span class="nb">-&gt;</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="no">:params</span><span class="w"> </span><span class="no">:department-name</span><span class="p">)]</span><span class="w">
  </span><span class="p">(</span><span class="nf">get-oreders</span><span class="w"> </span><span class="n">db</span><span class="w"> </span><span class="p">{</span><span class="no">:department-name</span><span class="w"> </span><span class="n">dep-name</span><span class="p">}))</span><span class="w">
</span></code></pre></div></div>

<p>You may go further and include <a href="https://github.com/yogthos/Selmer">Selmer</a>, a template library inspired by
Django. It’s aimed at HTML rendering first but still may be used for any kind of
documents including SQL.</p>

<p>As I see it, a good templating system would be enough to generate SQL that fits
your business logic.</p>

<p>Now I’d like to discuss the same problem when using Datomic instead of classical
RDBS solutions. All the tutorials that I have read do not cover a case then you
need to apply several filters to a query. Suddenly, it may really become a
problem. Let’s return to our example with orders. Once you don’t have any
filters, the query looks simple:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">'</span><span class="p">[</span><span class="no">:find</span><span class="w"> </span><span class="p">(</span><span class="nf">pull</span><span class="w"> </span><span class="n">?o</span><span class="w"> </span><span class="p">[</span><span class="nb">*</span><span class="p">])</span><span class="w">
  </span><span class="no">:in</span><span class="w"> </span><span class="n">$</span><span class="w">
  </span><span class="no">:where</span><span class="w"> </span><span class="p">[</span><span class="n">?o</span><span class="w"> </span><span class="no">:order/number</span><span class="p">]]</span><span class="w">
</span></code></pre></div></div>

<p>But if you’ve got a department name you need to:</p>

<ol>
  <li>inject a new parameter into <code class="language-plaintext highlighter-rouge">:in</code> section;</li>
  <li>inject additional clauses into <code class="language-plaintext highlighter-rouge">:where</code> section;</li>
  <li>prevent joining a user or a department entities twice if you need to filter
by other department or user field.</li>
</ol>

<p>As we’ve seen, once you have a template system, you may render SQL queries as
well. All you need is to write a query, test how does it behaves and then wrap
some parts of it with special conditional tags.</p>

<p>In Datomic, a query is usually a vector of symbols. Moreover, an immutable
one. Thus, you cannot modify a query and adding something in the middle of it
would be difficult. Surely you could wrap a query into an atom or track indexes
where to inject a new item somehow but all of that would be a mess.</p>

<p>What I propose is using a special kind of a query represented as a map with
<code class="language-plaintext highlighter-rouge">:find</code>, <code class="language-plaintext highlighter-rouge">:where</code> and other keys. As
the <a href="http://docs.datomic.com/query.html#list-vs-map">Datomic documentation says</a>, when processing a query, every
vector is turned into a map anyway. If we had a map, it would be easier to
inject new items into it.</p>

<p>To avoid wrapping a map with an atom or redefining it continuously inside <code class="language-plaintext highlighter-rouge">let</code>
clause, there is a great form named <a href="https://clojuredocs.org/clojure.core/cond-%3E">cond-&gt;</a>. It is a mix of both
threading macro and <code class="language-plaintext highlighter-rouge">cond</code> clause. It takes an initial value and a bunch of
predicate/update pairs. If a predicate form evaluates in true, an update form is
fired using the standard threading macro. Thus, an update form should be either
a function or a list where the second argument is missing and will be
substituted with a value from a previous pair.</p>

<p>What’s the most interesting about <code class="language-plaintext highlighter-rouge">cond-&gt;</code> is unlike <code class="language-plaintext highlighter-rouge">cond</code> or <code class="language-plaintext highlighter-rouge">case</code> forms, its
branches are evaluated continuously. Each update form takes a value that a
previous form has produced. In other terms, an initial value goes through
multiple updates without being saved in some temporary variable.</p>

<p>In example below, I’ve got a data set that consists from <code class="language-plaintext highlighter-rouge">user</code>, <code class="language-plaintext highlighter-rouge">location</code> and
<code class="language-plaintext highlighter-rouge">visit</code> entities. Both <code class="language-plaintext highlighter-rouge">user</code> and <code class="language-plaintext highlighter-rouge">location</code> are simple ones and store just
dates, strings and so on. A <code class="language-plaintext highlighter-rouge">visit</code> is a bit more complex. It means that a user
has visited a location and assigned a mark to it. Therefore, a visit references
a user and a location entities as well.</p>

<p>The goal is to get an average mark for a specific location. In addition, such a
value might be filtered by user’s age, gender or location’s country name. Those
parameters come from a query string and could be either totally skipped, passed
partially or completely. I’ve got a function that accepts a location id and a
map of optional parameters:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">location-avg</span><span class="w">
  </span><span class="p">[</span><span class="n">location-id</span><span class="w"> </span><span class="p">{</span><span class="no">:keys</span><span class="w"> </span><span class="p">[</span><span class="n">fromDate</span><span class="w">
                       </span><span class="n">toDate</span><span class="w">
                       </span><span class="n">fromAge</span><span class="w">
                       </span><span class="n">toAge</span><span class="w">
                       </span><span class="n">gender</span><span class="p">]}]</span><span class="w">

</span></code></pre></div></div>

<p>The initial Datomic query:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">query-initial</span><span class="w">
  </span><span class="o">'</span><span class="p">{</span><span class="no">:find</span><span class="w"> </span><span class="p">[(</span><span class="nf">avg</span><span class="w"> </span><span class="n">?mark</span><span class="p">)</span><span class="w"> </span><span class="nb">.</span><span class="p">]</span><span class="w">
    </span><span class="no">:with</span><span class="w"> </span><span class="p">[</span><span class="n">?v</span><span class="p">]</span><span class="w">
    </span><span class="no">:in</span><span class="w"> </span><span class="p">[</span><span class="n">$</span><span class="w"> </span><span class="n">?location</span><span class="p">]</span><span class="w">
    </span><span class="no">:args</span><span class="w"> </span><span class="p">[]</span><span class="w">
    </span><span class="no">:where</span><span class="w"> </span><span class="p">[[</span><span class="n">?v</span><span class="w"> </span><span class="no">:location</span><span class="w"> </span><span class="n">?location</span><span class="p">]</span><span class="w">
            </span><span class="p">[</span><span class="n">?v</span><span class="w"> </span><span class="no">:mark</span><span class="w"> </span><span class="n">?mark</span><span class="p">]]})</span><span class="w">
</span></code></pre></div></div>

<p>Now, here is a long pipeline with comments:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">cond-&gt;</span><span class="w"> </span><span class="n">query-initial</span><span class="w">

  </span><span class="c1">;; First, add two initial arguments: database instance and location reference.</span><span class="w">
  </span><span class="c1">;; This form will always be evaluated.</span><span class="w">
  </span><span class="n">true</span><span class="w">
  </span><span class="p">(</span><span class="nf">update</span><span class="w"> </span><span class="no">:args</span><span class="w"> </span><span class="nb">conj</span><span class="w">
          </span><span class="p">(</span><span class="nf">get-db</span><span class="p">)</span><span class="w">                    </span><span class="c1">;; returns the DB instance</span><span class="w">
          </span><span class="p">[</span><span class="no">:location/id</span><span class="w"> </span><span class="n">location-id</span><span class="p">])</span><span class="w"> </span><span class="c1">;; location reference</span><span class="w">

  </span><span class="c1">;; If either from- or to- date were passed, join the `visit` entity</span><span class="w">
  </span><span class="c1">;; and bind its `visited_at` attribute to the `?visited-at` variable.</span><span class="w">
  </span><span class="p">(</span><span class="nb">or</span><span class="w"> </span><span class="n">fromDate</span><span class="w"> </span><span class="n">toDate</span><span class="p">)</span><span class="w">
  </span><span class="p">(</span><span class="nf">update</span><span class="w"> </span><span class="no">:where</span><span class="w"> </span><span class="nb">conj</span><span class="w">
          </span><span class="o">'</span><span class="p">[</span><span class="n">?v</span><span class="w"> </span><span class="no">:visited_at</span><span class="w"> </span><span class="n">?visited-at</span><span class="p">])</span><span class="w">

  </span><span class="c1">;; If the `fromDate` filter was passed, do the following:</span><span class="w">
  </span><span class="c1">;; 1. add a parameter placeholder into the query;</span><span class="w">
  </span><span class="c1">;; 2. add an actual value to the arguments;</span><span class="w">
  </span><span class="c1">;; 3. add a proper condition against `?visited-at` variable</span><span class="w">
  </span><span class="c1">;; (remember, it was bound above).</span><span class="w">
  </span><span class="n">fromDate</span><span class="w">
  </span><span class="p">(</span><span class="nb">-&gt;</span><span class="w">
   </span><span class="p">(</span><span class="nf">update</span><span class="w"> </span><span class="no">:in</span><span class="w"> </span><span class="nb">conj</span><span class="w"> </span><span class="ss">'?fromDate</span><span class="p">)</span><span class="w">
   </span><span class="p">(</span><span class="nf">update</span><span class="w"> </span><span class="no">:args</span><span class="w"> </span><span class="nb">conj</span><span class="w"> </span><span class="n">fromDate</span><span class="p">)</span><span class="w">
   </span><span class="p">(</span><span class="nf">update</span><span class="w"> </span><span class="no">:where</span><span class="w"> </span><span class="nb">conj</span><span class="w">
           </span><span class="o">'</span><span class="p">[(</span><span class="nb">&gt;</span><span class="w"> </span><span class="n">?visited-at</span><span class="w"> </span><span class="n">?fromDate</span><span class="p">)]))</span><span class="w">

  </span><span class="c1">;; Do the same steps for the `toDate` filter,</span><span class="w">
  </span><span class="c1">;; but the condition slightly differs (&lt; instead of &gt;).</span><span class="w">
  </span><span class="n">toDate</span><span class="w">
  </span><span class="p">(</span><span class="nb">-&gt;</span><span class="w">
   </span><span class="p">(</span><span class="nf">update</span><span class="w"> </span><span class="no">:in</span><span class="w"> </span><span class="nb">conj</span><span class="w"> </span><span class="ss">'?toDate</span><span class="p">)</span><span class="w">
   </span><span class="p">(</span><span class="nf">update</span><span class="w"> </span><span class="no">:args</span><span class="w"> </span><span class="nb">conj</span><span class="w"> </span><span class="n">toDate</span><span class="p">)</span><span class="w">
   </span><span class="p">(</span><span class="nf">update</span><span class="w"> </span><span class="no">:where</span><span class="w"> </span><span class="nb">conj</span><span class="w">
           </span><span class="o">'</span><span class="p">[(</span><span class="nb">&lt;</span><span class="w"> </span><span class="n">?visited-at</span><span class="w"> </span><span class="n">?toDate</span><span class="p">)]))</span><span class="w">

  </span><span class="c1">;; To filter by user's fields, we bind a user reference</span><span class="w">
  </span><span class="c1">;; to the `?user` variable:</span><span class="w">
  </span><span class="p">(</span><span class="nb">or</span><span class="w"> </span><span class="n">fromAge</span><span class="w"> </span><span class="n">toAge</span><span class="w"> </span><span class="n">gender</span><span class="p">)</span><span class="w">
  </span><span class="p">(</span><span class="nf">update</span><span class="w"> </span><span class="no">:where</span><span class="w"> </span><span class="nb">conj</span><span class="w">
          </span><span class="o">'</span><span class="p">[</span><span class="n">?v</span><span class="w"> </span><span class="no">:user</span><span class="w"> </span><span class="n">?user</span><span class="p">])</span><span class="w">

  </span><span class="c1">;; If from/to age filters we passed, bind user's age</span><span class="w">
  </span><span class="c1">;; to the `?birth-date` variable.</span><span class="w">
  </span><span class="p">(</span><span class="nb">or</span><span class="w"> </span><span class="n">fromAge</span><span class="w"> </span><span class="n">toAge</span><span class="p">)</span><span class="w">
  </span><span class="p">(</span><span class="nf">update</span><span class="w"> </span><span class="no">:where</span><span class="w"> </span><span class="nb">conj</span><span class="w">
          </span><span class="o">'</span><span class="p">[</span><span class="n">?user</span><span class="w"> </span><span class="no">:birth_date</span><span class="w"> </span><span class="n">?birth-date</span><span class="p">])</span><span class="w">

  </span><span class="c1">;; Then add placeholders, arguments and where clauses</span><span class="w">
  </span><span class="c1">;; for specific filters: fromAge, if passed...</span><span class="w">
  </span><span class="n">fromAge</span><span class="w">
  </span><span class="p">(</span><span class="nb">-&gt;</span><span class="w">
   </span><span class="p">(</span><span class="nf">update</span><span class="w"> </span><span class="no">:in</span><span class="w"> </span><span class="nb">conj</span><span class="w"> </span><span class="ss">'?fromAge</span><span class="p">)</span><span class="w">
   </span><span class="p">(</span><span class="nf">update</span><span class="w"> </span><span class="no">:args</span><span class="w"> </span><span class="nb">conj</span><span class="w"> </span><span class="p">(</span><span class="nf">age-to-ts</span><span class="w"> </span><span class="n">fromAge</span><span class="p">))</span><span class="w">
   </span><span class="p">(</span><span class="nf">update</span><span class="w"> </span><span class="no">:where</span><span class="w"> </span><span class="nb">conj</span><span class="w">
           </span><span class="o">'</span><span class="p">[(</span><span class="nb">&lt;</span><span class="w"> </span><span class="n">?birth-date</span><span class="w"> </span><span class="n">?fromAge</span><span class="p">)]))</span><span class="w">

  </span><span class="c1">;; ...and the same for toAge.</span><span class="w">
  </span><span class="n">toAge</span><span class="w">
  </span><span class="p">(</span><span class="nb">-&gt;</span><span class="w">
   </span><span class="p">(</span><span class="nf">update</span><span class="w"> </span><span class="no">:in</span><span class="w"> </span><span class="nb">conj</span><span class="w"> </span><span class="ss">'?toAge</span><span class="p">)</span><span class="w">
   </span><span class="p">(</span><span class="nf">update</span><span class="w"> </span><span class="no">:args</span><span class="w"> </span><span class="nb">conj</span><span class="w"> </span><span class="p">(</span><span class="nf">age-to-ts</span><span class="w"> </span><span class="n">toAge</span><span class="p">))</span><span class="w">
   </span><span class="p">(</span><span class="nf">update</span><span class="w"> </span><span class="no">:where</span><span class="w"> </span><span class="nb">conj</span><span class="w">
           </span><span class="o">'</span><span class="p">[(</span><span class="nb">&gt;</span><span class="w"> </span><span class="n">?birth-date</span><span class="w"> </span><span class="n">?toAge</span><span class="p">)]))</span><span class="w">

  </span><span class="c1">;; To filter by gender, bind user's gender to a variable</span><span class="w">
  </span><span class="c1">;; and add a clause:</span><span class="w">
  </span><span class="n">gender</span><span class="w">
  </span><span class="p">(</span><span class="nb">-&gt;</span><span class="w">
   </span><span class="p">(</span><span class="nf">update</span><span class="w"> </span><span class="no">:in</span><span class="w"> </span><span class="nb">conj</span><span class="w"> </span><span class="ss">'?gender</span><span class="p">)</span><span class="w">
   </span><span class="p">(</span><span class="nf">update</span><span class="w"> </span><span class="no">:args</span><span class="w"> </span><span class="nb">conj</span><span class="w"> </span><span class="n">gender</span><span class="p">)</span><span class="w">
   </span><span class="p">(</span><span class="nf">update</span><span class="w"> </span><span class="no">:where</span><span class="w"> </span><span class="nb">conj</span><span class="w">
           </span><span class="o">'</span><span class="p">[</span><span class="n">?user</span><span class="w"> </span><span class="no">:gender</span><span class="w"> </span><span class="n">?gender</span><span class="p">]))</span><span class="w">

  </span><span class="c1">;; The final step is to remap a query (see below).</span><span class="w">
  </span><span class="n">true</span><span class="w">
  </span><span class="n">remap-query</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>Remapping a query is important because the initial data is a bit wrong. The
proper structure for a map query looks as follows:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="no">:query</span><span class="w"> </span><span class="n">&lt;query-map&gt;</span><span class="w">
 </span><span class="no">:args</span><span class="w"> </span><span class="p">[</span><span class="n">db</span><span class="w"> </span><span class="n">location_id</span><span class="w"> </span><span class="n">fromDate</span><span class="w"> </span><span class="n">...</span><span class="p">]}</span><span class="w">
</span></code></pre></div></div>

<p>In my case, I believe it’s simpler to keep one-level map rather than deal with
two levels (<code class="language-plaintext highlighter-rouge">:query</code> first, then <code class="language-plaintext highlighter-rouge">:args</code>). It would force me to use <code class="language-plaintext highlighter-rouge">update-in</code>
instead if just <code class="language-plaintext highlighter-rouge">update</code> and write more code. Here is the <code class="language-plaintext highlighter-rouge">remap-query</code>
function:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">remap-query</span><span class="w">
  </span><span class="p">[{</span><span class="n">args</span><span class="w"> </span><span class="no">:args</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">m</span><span class="p">}]</span><span class="w">
  </span><span class="p">{</span><span class="no">:query</span><span class="w"> </span><span class="p">(</span><span class="nb">dissoc</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="no">:args</span><span class="p">)</span><span class="w">
   </span><span class="no">:args</span><span class="w"> </span><span class="n">args</span><span class="p">})</span><span class="w">
</span></code></pre></div></div>

<p>Finally, let’s check our results. If somebody passes all the filters, the query
will look like:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="no">:query</span><span class="w">
 </span><span class="p">{</span><span class="no">:find</span><span class="w"> </span><span class="p">[(</span><span class="nf">avg</span><span class="w"> </span><span class="n">?mark</span><span class="p">)</span><span class="w"> </span><span class="nb">.</span><span class="p">]</span><span class="n">,</span><span class="w">
  </span><span class="no">:with</span><span class="w"> </span><span class="p">[</span><span class="n">?v</span><span class="p">]</span><span class="n">,</span><span class="w">
  </span><span class="no">:in</span><span class="w"> </span><span class="p">[</span><span class="n">$</span><span class="w"> </span><span class="n">?location</span><span class="w"> </span><span class="n">?fromDate</span><span class="w"> </span><span class="n">?toDate</span><span class="w"> </span><span class="n">?fromAge</span><span class="w"> </span><span class="n">?toAge</span><span class="w"> </span><span class="n">?gender</span><span class="p">]</span><span class="n">,</span><span class="w">
  </span><span class="no">:where</span><span class="w">
  </span><span class="p">[[</span><span class="n">?v</span><span class="w"> </span><span class="no">:location</span><span class="w"> </span><span class="n">?location</span><span class="p">]</span><span class="w">
   </span><span class="p">[</span><span class="n">?v</span><span class="w"> </span><span class="no">:mark</span><span class="w"> </span><span class="n">?mark</span><span class="p">]</span><span class="w">
   </span><span class="p">[</span><span class="n">?v</span><span class="w"> </span><span class="no">:visited_at</span><span class="w"> </span><span class="n">?visited-at</span><span class="p">]</span><span class="w">
   </span><span class="p">[(</span><span class="nb">&gt;</span><span class="w"> </span><span class="n">?visited-at</span><span class="w"> </span><span class="n">?fromDate</span><span class="p">)]</span><span class="w">
   </span><span class="p">[(</span><span class="nb">&lt;</span><span class="w"> </span><span class="n">?visited-at</span><span class="w"> </span><span class="n">?toDate</span><span class="p">)]</span><span class="w">
   </span><span class="p">[</span><span class="n">?v</span><span class="w"> </span><span class="no">:user</span><span class="w"> </span><span class="n">?user</span><span class="p">]</span><span class="w">
   </span><span class="p">[</span><span class="n">?user</span><span class="w"> </span><span class="no">:birth_date</span><span class="w"> </span><span class="n">?birth-date</span><span class="p">]</span><span class="w">
   </span><span class="p">[(</span><span class="nb">&lt;</span><span class="w"> </span><span class="n">?birth-date</span><span class="w"> </span><span class="n">?fromAge</span><span class="p">)]</span><span class="w">
   </span><span class="p">[(</span><span class="nb">&gt;</span><span class="w"> </span><span class="n">?birth-date</span><span class="w"> </span><span class="n">?toAge</span><span class="p">)]</span><span class="w">
   </span><span class="p">[</span><span class="n">?user</span><span class="w"> </span><span class="no">:gender</span><span class="w"> </span><span class="n">?gender</span><span class="p">]]}</span><span class="n">,</span><span class="w">
 </span><span class="no">:args</span><span class="w"> </span><span class="p">[</span><span class="n">&lt;db-object&gt;</span><span class="w"> </span><span class="p">[</span><span class="no">:location/id</span><span class="w"> </span><span class="mi">42</span><span class="p">]</span><span class="w"> </span><span class="mi">1504210734</span><span class="w"> </span><span class="mi">1504280734</span><span class="w"> </span><span class="mi">20</span><span class="w"> </span><span class="mi">30</span><span class="w"> </span><span class="s">"m"</span><span class="p">]}</span><span class="w">
</span></code></pre></div></div>

<p>Now you pass it into <a href="http://docs.datomic.com/clojure/#datomic.api/query">datomic.api/query</a> function that accepts a map-like
query. In my case, the result is something like: <code class="language-plaintext highlighter-rouge">4.18525</code>.</p>

<p>As you have seen, composing complicated queries with Datomic might a bit tricky
due do immutability and differences between string templates and data
structures. But still, Clojure provides rich set of tools for processing
collections. In my case, the standard <code class="language-plaintext highlighter-rouge">cond-&gt;</code> has made all the
pipeline. Neither atoms nor other tricks to track the state were required. There
is a common rule: once you’ve got stuck with a data structure, keep yourself
from inventing “smart” ways to deal with it. There is probably a built-in macro
in <code class="language-plaintext highlighter-rouge">clojure.core</code> for that.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/facebook/">Фейсбук прекрасен</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2017-09-01T00:00:00+00:00">
        Sep 1, 2017
    </time>

    <a href="/tag/idiots/" rel="tag">idiots</a>, <a href="/tag/facebook/" rel="tag">facebook</a>

</div>


            <div class="entry">
                
                    <p>Каждый месяц повторяется печальное событие: мне нужно зайти в ФБ и сделать анонс
митапа. Я тяну время, но часа X не избежать.</p>

<p><img src="/assets/static/facebook.png" alt="facebook" /></p>

<p>Даже не знаю, что может быть хуже Фейсбука: столь тормозной и неорганизованный
сайт еще поискать. При том что денег у них до жопы.</p>

<p>Погрязли в жадности и бюрократизме.</p>

                
            </div>

        </li>
        
    </ul>

    <h4>
        
        <a href="/page28" class="previous">&larr;</a>
        
        <span class="page_number ">Страница 29 из 61</span>
        
        <a href="/page30" class="next">&rarr;</a>
        
    </h4>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Ivan Grishaev's blog</li>
          <li><a href="mailto:ivan@grishaev.me">ivan@grishaev.me</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
            <li><a href="https://github.com/igrishaev">GitHub</a></li>
            <li><a href="tg://resolve?domain=igrishaev_blog">Telegram</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Writing on programming, education, books and negotiations.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
