---
layout: post
title:  "Замеры"
permalink: /measure/
tags: metrics programming charts
---

Если вы долго поддерживаете код, полезно делать замеры: стал ли он быстрее,
медленнее или ничего не изменилось.

Не обязательно замерять каждый коммит. Достаточно делать это каждые N
версий. Даже скромных данных будет достаточно, чтобы понять, где вы свернули не
туда или наоборот — в проекте все круто.

Ниже — замеры драйвера Postgresql в разрезе версий. Разрыв между версиями 0.1.2
и 0.1.11 вызван тем, что в этот период я исправлял то, что не окажет влияния на
производительность. А в 0.1.12 было то, что оказывает, поэтому замер необходим.

Картинка ниже показывает, сколько времени нужно, чтобы забрать данные с сервера
без парсинга. С каждой версией эта метрика уменьшается. Вызвано это ленивым
парсингом. Данные не разбираются сразу, а оборачиваются в класс, который
притворяется словарем. При обращении к ключу происходит разбор поля и сохранение
во внутреннем кэше.

{% include static.html path="measure/1.png" %}

То же самое, но для сложного запроса с полями разных типов:

{% include static.html path="measure/2.png" %}

Последняя версия выигрывает у конкурента на порядок: 59 против 590
милисекунд. Разве не круто, когда оцениваешь разницу визуально?

Другая метрика: число запросов в секунду HTTP сервера, который вынимает из базы
случайные данные и отдает в JSON. Здесь видно, что хотя прирост есть, но на
некоторых платформах число RPS слабо, но проседает. Это потому, что при сбросе
данных в JSON срабатывает тот самый ленивый парсинг, а он отнимает время.

{% include static.html path="measure/3.png" %}

Есть еще одна метрика: очень сложный запрос с принудительным парсингом. Здесь
видно, что он дает о себе знать: с каждой версией цифра повышается.

{% include static.html path="measure/4.png" %}

Из этих картинок можно извлечь пользу, например оценить, где мы выиграли и
потеряли и насколько. В моем случае я считаю, что главное — как можно скорее
забрать данные с сервера и освободить соединение. За это мы платим чуть менее
быстрым парсингом, но ничего — это осознанный выбор.

Другое дело, когда замеров нет в принципе и остается гадать — может, станет
быстрее, а может быть, медленнее. Компьютеры у всех мощные, телефоны меняют
каждый год, поэтому выкатывай, там разберемся. Кажется, большинство программ
обновляют именно так.
