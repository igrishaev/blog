---
layout: post
title: "Датомик"
permalink: /datomic/
tags: programming datomic
---

[datomic]: https://www.datomic.com/

[article]: /en/pg-to-datomic/

Лет семь назад я увлекся [Датомиком][datomic]. Кто не знает, это база данных,
написанная на Сlojure и Java. Среди ее плюсов – неизменяемость (данные только
накапливаются), независимость от времени (можно вернуться в прошлое) и
выразительный язык запросов Datalog, взятый из Пролога.

Я долго ходил вокруг да около, а потом повезло: семья уехала на неделю, и я
провел это время, читая доки и экспериментируя. У меня тогда был пет-проект на
Postgres, и я перевел его на Датомик. Позже я использовал его в других проектах,
в том числе в Хайлоад-капах от Mail.ru. Я [написал статью][article] про миграцию
с Постгреса на Датомик, и она даже попала на главную Хакер-Ньюз.

У Датомика есть важное свойство: он красивый. Бросил взгляд, и сразу мысль – да,
круто. Это изящная абстракция, воздвигнутая на элементарных вещах. Мало
проектов, где эти свойства – изящность и простота – выражены столь же ярко.

Я много играл с Датомиком и даже пытался реализовать его поверх реляционных
баз. Кое-что мне удалось, но поделки я так и не довел до ума. Практика показала,
что скучные Postgres/Maria удобней в работе.

Прежде всего, неизменяемость из коробки не нужна. Там, где нужно хранить
историю, Postgres/Maria справляются за счет триггеров или запросов вида `INSERT
...  FROM UPDATE/INSERT/DELETE`. Когда говорят об исторических данных, у меня
сразу вопрос – как вы ими пользуетесь? Они вообще вам нужны?

Далее: страшные буквы GDPR. Если пользователь хочет удалить свои данные, с
Датомиком будут проблемы. В Датомике атрибуты не меняются, а добавляются новые с
поздним временем. Поэтому, читая один и тот же атрибут в разное время, получим
разные значения. Но GDPR требует, чтобы в базе физически не было личных
данных. Если вы записали в базу атрибут `(42, :user/name "XXXXXX")`, то старый
атрибут `(42, :user/name "Ivan")` остался, и прочитать его – дело техники.

В Датомике есть функция физической очистки атрибутов, но она дорогая и
выполняется во время обслуживания, то есть требует остановки прода.

Можно отключить историю атрибутов, но тогда вопрос – зачем вообще история,
которой так гордится Датомик?

Кто-то скажет: ладно, пусть имя пользователя будет без истории, а остальное с
историей. Практика показывает, что GDPR требует чистки чуть ли не всех
таблиц. Когда мы удаляли пользователей из приложения с короткими видео, то
пришлось шерстить десятки таблиц: профили, лайки, коменты, друзья, подписчики,
обращения, сообщения... это были недели ада. Если представить, что у каждой
таблицы история, ситуация станет еще хуже.

У Датомика никакой поиск, нет сортировки и пагинации. Как с этим жить – решать
вам. Кого ни спрашивал – каждый пилит свои костыли, каждый случай – свое
маленькое приключение.

Есть еще кое-что: Датомик, при всей своей красоте, нарушает доменную область. Я
как-то говорил о том, что главное свойство домена – его ортогональность другим
доменам. Другими словами, у базы и кода на Сlojure разные зоны
ответственности. Датомик стирает эту границу: он превращает базу в хранилище, к
которой только он имеет доступ. Этому есть объяснение, поскольку физически
данные хранятся как бинарные дампы с кусками индексов, и работать с ними умеет
только Датомик.

На практике это выливается в то, что если я хочу поправить записи в Датомике,
нужно писать код на Кложе, который выгребает данные, исправляет и записывает в
базу.

Это резко контрастирует с Postgres/Maria, которые предлагают свои языки и
инструменты для работы с данными. Это и есть домен, когда я могу исправить
данные, не обращаясь к Кложе. Бывает, я сижу в psql днями и неделями,
манипулируя данными на чистом SQL.

Датомик нарушает это правило. Да, у него есть веб-консоль, но по сравнению с
psql она крайне уныла, а до программ уровня PGAdmin или DBeaver ей как до луны.

Датомик как мороженное: он красивый, но позже липнет и затекает туда, где ему не
следует быть. Поэтому я прекратил с ним шашни и продолжаю работать с
Постгресом. И кстати, Постгрес в последние годы просто летит в космос,
нарадоваться не могу.

Выбирая Датомик, имейте в виду вышесказанное.
