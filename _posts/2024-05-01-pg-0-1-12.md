---
layout: post
title:  "PG2 release 0.1.12"
permalink: /en/pg-0-1-12
lang: en
tags: clojure programming postgres sql
---

[docs]: https://github.com/igrishaev/pg2/blob/master/README.md
[pg2]: https://github.com/igrishaev/pg2

[PG2 version 0.1.12][pg2] is out. Aside from internal refactoring, there are
several features I'd like to highlight.

**First**, the library is still getting faster. The latest benchmarks prove
15-30% performance gain when consuming `SELECT` results. The actual value
depends on the nature of a query. Simple queries with 1-2 columns work faster
than before:

{% include static.html path="pg-0.1.12/01.svg" class="svg-chart" %}

Single Column Select

| Platform                    | JDBC.Next  | PG2 0.1.1 | PG2 0.1.2 | PG2 0.1.12 |
|-----------------------------|------------|-----------|-----------|------------|
| core i5 2 GHz Quad-Core 16G | 127.677926 | 43.026307 | 44.36297  | 21.941113  |
| core i9 2,4 GHz 8-Core 32G  | 83.932103  | 39.551719 | 27.672117 | 20.957904  |
| arm m1 10 cores 32G         | 49.340986  | 18.517718 | 14.670815 | 9.468902   |

Queries with many columns are less sensitive to the new parsing algorithm; but
they're still fast:

{% include static.html path="pg-0.1.12/02.svg" class="svg-chart" %}

Complex result select

| Platform                    | JDBC.Next  | PG2 0.1.1  | PG2 0.1.2 | PG2 0.1.12 |
|-----------------------------|------------|------------|-----------|------------|
| core i5 2 GHz Quad-Core 16G | 579.59995  | 273.866142 | 80.352246 | 55.835803  |
| core i9 2,4 GHz 8-Core 32G  | 447.326861 | 270.262248 | 54.34384  | 42.815123  |
| arm m1 10 cores 32G         | 206.371502 | 117.241426 | 30.444798 | 29.92079   |


PG2 is a bit faster when it comes to HTTP server. The chart below measures a
number of RPS of a Jetty server that fetches random data from the database and
sends them as JSON.

{% include static.html path="pg-0.1.12/03.svg" class="svg-chart" %}

The tests were made using `ab` as follows:

~~~bash
ab -n 1000 -c 16 -l http://127.0.0.1:18080/
~~~

| Platform                    | JDBC.Next | PG2 0.1.1 | PG2 0.1.2 | PG2 0.1.12 |
|-----------------------------|-----------|-----------|-----------|------------|
| core i5 2 GHz Quad-Core 16G | 555.55    | 968.51    | 915.93    | 890.62     |
| core i9 2,4 GHz 8-Core 32G  | 1304      | 1909.19   | 1688.72   | 1794.75    |
| arm m1 10 cores 32G         | 1902.31   | 2999.06   | 3026      | 3363.36    |

The second feature is the `:read-only?` connection flag. When it's set to true,
the connection is run in READ ONLY mode, and every transaction explicitly set to
READ ONLY as well. This is useful for connections that read from replicas. A
small demo:




Finally, there is a new reducer called "column" which allows you to get a single
column as a plain vector. For example, we often select IDs only, but the result
is a vector of maps with a single :id field:

...

To get the ids, either you pass the result into (map :id ...) or, which is
better, specify the :column key as follows:

...

Internally, the key submits a reducer object. It fetches the field you want on
the fly as the data rows come from the network. It's more effective than passing
through the result with map the second time.
