---
layout: post
title:  "Мой вклад в clj-http"
permalink: /clj-http/
tags: clojure http
---

[url-pl]:https://github.com/dakrone/clj-http/pull/343/files
[url-clj-http]:https://github.com/dakrone/clj-http
[url-slingshot]:https://github.com/scgilardi/slingshot
[url-compojure-api]:https://github.com/metosin/compojure-api
[url-exc]:https://github.com/metosin/compojure-api/wiki/Exception-handling

В проект [clj-http][url-clj-http] приняли мой
[скромный пулл-реквест][url-pl]. Теперь, если запрос был вызван с флагом
`:throw-exceptions true` и вернулся плохой ответ (статус не 2хх, 3хх), то во
вбрасываемый словарь добавляеся ключ `:type
:clj-http.client/unexceptional-status`. Это на ура работает с библиотекой
[Slingshot][url-slingshot], потому что отлов исключений по полю `:type` стал
негласным стандартом.

Если абзац выше звучит для вас бессмыслецей, расскажу подробней. Изначально в
Кложе идут унылые Java-исключения, которые плохо ложатся на мир структур и
коллекций. Но поскольку Кложа это Лисп, а в Лиспе любая проблема решается его же
силами, умельцы написали библиотеку для альтернативных исключений slingshot.

Библиотека упрощает работу с исключениями до мыслимого предела. Теперь можно
вбрасывать не только объект, унаследованный от Throwable, а вообще что
угодно. Лучше всего подходит словарь. Форма отлова исключения, выброшенного из
slingshot, может иметь разную структуру. Например, предикат, но удобней и короче
будет вектор двух элементов, где первый -- ключ, а второй -- значение.

Если раньше приходилось передавать неочевидный предикат, который проверял, что в
словаре есть поле `status`, и оно числовое:

~~~clojure
(catch
  (fn [response]
    (-> response :statsus integer?))
  ...)
~~~

, то теперь достаточно сравнить так:

~~~clojure
(catch [:type :clj-http.client/unexceptional-status])
~~~

Визуально разницы мало, но селектор по ключу `:type` открывает новые
горизонты. Например, во фреймворке [Compojure API][url-compojure-api], на котором
наш проект, обработка исключений целиком работает на этом принципе. В особом
словаре лежат ключи -- потенциальные варианты `:type`, а значения --
функции-обработчики. Хорошие примеры [в документации][url-exc].

Пока пулл-реквест не приняли, приходилось писать свой костыль для добавления
ключа. Теперь с этим покончено.
