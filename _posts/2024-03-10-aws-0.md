---
layout: post
title:  "Амазон"
permalink: /aws-0/
tags: aws cloud programming
---

{% include toc-aws.md %}

Последние три года я плотно работают с Амазоном. Все больше утверждаюсь в мысли:
для своих нужд я никогда не возьму Амазон, какими бы пряниками он меня не
заманивал.

Двадцать лет назад, когда я только познакомился с AWS, он был набором
сервисов. Если тогда это был город, то сегодня он — целая планета. Число
сервисов выросло на порядок или два, усложнилось взаимодействие между ними.

Разрабатывая на AWS, важно иметь особый навык — знание AWS. Языка
программирования и базы данных уже недостаточно. Нужно понимать концепции AWS,
систему прав и полиси, квоты и много чего другого.

В фирме редко бывает человек, который знает AWS целиком. Чаще всего каждый, как
муравей, видит маленький ландшафтик, и когда начинаются проблемы взаимодействия,
их тяжело расследовать.

AWS — это дичайший вендор-лок, то есть зависимость от поставщика. Байки на тему
"посидим и слезем" остаются байками. Амазон, как пылесос, со временем
перетягивает на себя все решения — файлы, базу, сообщения — и портировать их
обратно очень дорого.

Важно понимать, что второго Амазона в мире нет. Бывают сервисы, которые
повторяют некоторые API Амазона, например S3. Но переехать на что-то другое
целиком будет очень затратно, причем даже не в плане денег, а нервов.

Амазон дорогой. Разумеется, я не могу назвать, сколько платят заказчики, но это
весьма дорого даже по западным меркам. Реляционные базы данных —
дорогие. Лямбды, если их вызывать постоянно — дорогие. Если использовать S3 как
шину данных между сервисами, это тоже дорого.

Пожалуй, моя главная претензия к AWS — его трудно имитировать локально. Когда у
вас Постгрес и Редис, все это запускается в Докере и покрывает 99%
случаев. Постгрес в Докере — это настоящий Постгрес, тот самый, что работает на
серверах. Любую ситуацию можно повторить локально: блокировку транзакций,
медленный запрос, загрузку миллиарда записей, попадание в индекс.

С Амазоном так не получится: сервисы DynamoDB, SNS/SQS или Athena нельзя
запустить в Докере. Можно заткнуть их имитацией, которая выплевывает нужный
JSON, но... это имитация. В проде случается масса вещей, о которых вы и не
подозревали.

Для разработки под Амазон нужно dev-окружение. Это такой же Амазон, только он не
пересекается с продом. Там своя база, инстансы, очереди задач. Вы пишете код,
заливаете в Амазон, гоняете и смотрите логи. Что-то упало — исправляете код и
все по-новой. Это долго, потому что каждый шаг выполняется не мгновенно, а по
нескольку минут.

Разумеется, dev-окружение тарифицируется как обычное. За все нужно
платить. Кроме прода, заказчик платит за 5-10 dev-окружений. Если вы
расчитываете стоимость AWS, умножайте хотя бы на два, чтобы заложить бюджет на
dev-окружения.

Амазон радует крайне неочевидным поведением. Не могу назвать его багами, потому
что оно описано в докуменации. Но документация огромна, читать ее никогда, да и
требует усилий. Каждый раз, разобравшись, думаешь: ну все, теперь сюрпризов не
будет. И буквально через два дня — новая головоломка.

В следующих заметках я расскажу о случаях с AWS, над которыми изрядно поломал
голову. Надеюсь, они будут кому-то полезны и сэкономят нервы.
