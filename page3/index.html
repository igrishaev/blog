<!DOCTYPE html>
<html lang="ru">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Ivan Grishaev's blog</title>
  <meta name="description" content="Writing on programming, education, books and negotiations.
">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/custom.css">
  <link rel="canonical" href="https://grishaev.me/page3/">
  <link rel="alternate" type="application/rss+xml" title="Ivan Grishaev's blog" href="https://grishaev.me/feed.xml">

  <link rel="shortcut icon" type="image/x-icon" href="/assets/static/favicons/favicon.ico">

  <script type="text/javascript" src="/assets/typo.js"></script>

</head>


  <body>
    <header class="site-header">

    <div class="wrapper flex-container">

        <div>
            <a href="/">
                <img src="/assets/static/photo-round-small.png" alt="Ivan Grishaev">
            </a>
        </div>

        <div class="flex-container-vert" style="margin-left: 15px; width: 80%">

            <div class="flex-container full-width">
                <p style="margin-bottom: 5px">Ivan Grishaev's blog</p>
                <div class="flex-huge"></div>
                <div >
<form id="search-form"
      target="_blank"
      style="display: inline"
      method="get"
      action="https://www.google.com/search">

    <input name="sitesearch"
           value="grishaev.me"
           type="hidden">

    <input type="text"
           required="required"
           name="q"
           placeholder="Google search..."
           autocomplete="off">

    <button style="border: none; background-color: transparent; cursor: pointer;"
            type="submit">&#x1f50d;</button>

</form>
</div>
            </div>

            <p><small>Writing on programming, education, books and negotiations.
</small></p>

            <div class="flex-container">
                <a class="menu-item" href="/">Home</a>
                <a class="menu-item" href="/about/">About</a>
                <a class="menu-item" href="/bookshelf/">Bookshelf</a>
                <a class="menu-item" href="/feed.xml">RSS</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor" href="/tag/clojure/">Clojure</a>
                <a class="menu-item minor" href="/tag/emacs/">Emacs</a>
                <a class="menu-item minor" href="/tag/python/">Python</a>
                <a class="menu-item minor" href="/tag/programming/">Programming</a>
                <a class="menu-item minor" href="/interview/">Interview</a>
                <a class="menu-item minor" href="/video/">Video</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor hl" href="/clojure-in-prod/">Книга «Clojure на производстве»</a>
            </div>

        </div>
    </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="home">

    <ul class="post-list">
        
        <li>

            <h2>
                <a class="post-link" href="/de-js-2/">Деджаваскриптизиция (2)</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2022-09-13T00:00:00+00:00">
        Sep 13, 2022
    </time>

    <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/javascript/" rel="tag">javascript</a>, <a href="/tag/blog/" rel="tag">blog</a>, <a href="/tag/disqus/" rel="tag">disqus</a>

</div>


            <div class="entry">
                
                    <p>Сделал то, что намеревался: удалил с сайта все сторонние сервисы. Больше нет социальных кнопок, гугло-аналитики и, самое важное, комментариев Disqus. На страницах вообще нет аякса за тем исключением, когда встроен плеер Ютуба. Красота.</p>

<p>Отдельно расскажу про комментарии. Теперь они встроены в блог, являются его частью, а не лежат на серверах Disqus. Для этого я написал импорт из XML. Ясное дело, на Кложе, <a href="https://github.com/igrishaev/blog/blob/master/clj-comments/src/clj_comments/core.clj">исходники на Гитхабе</a>.</p>

<p>Если вкратце, код пробегает по XML, строит мапы и индексы по ID. Для каждого комментария он создает файл вроде <code class="language-plaintext highlighter-rouge">_comments/2016-08-08-08-27-14.md</code> с содержимым:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>---
id: 2826354744
is_spam: false
is_deleted: false
post: /interview/
date: 2016-08-08T08:27:14Z
author_fullname: 'Александр'
author_nickname: 'VinokurovAlexnader'
author_is_anon: false
---

&lt;p&gt;Вопрос "Есть кортеж из трех элементов. Назначить переменным a, b, c его значения".&lt;/p&gt;
&lt;p&gt;У Вас ответ:&lt;br&gt;a, b, c = [1, 2, 3]&lt;/p&gt;
&lt;p&gt;Но это список, а не кортеж. С кортежом будет вот так:&lt;br&gt;a, b, c = (1, 2, 3)&lt;/p&gt;
</code></pre></div></div>

<p>Всего таких файлов 993. В шаблон заметки я добавил код для вывода комментариев:</p>

<pre><code class="language-jinja2">{% assign comments = site.comments | where:'post', include.permalink %}
{% if comments.size == 0 %}
&lt;center&gt;Комментариев пока нет&lt;/center&gt;
{% else %}
&lt;center&gt;Комментарии&lt;/center&gt;
&lt;div class="comments-block"&gt;
  {% for comment in comments %}
    &lt;div class="comment-block"&gt;
      &lt;p class="comment-lead"&gt;
        &lt;small&gt;
          &lt;em&gt;{{ comment.author_fullname or comment.author_nickname }}, {{ comment.date | date_to_string: "ordinal", "RU" }}&lt;/em&gt;
        &lt;/small&gt;
      &lt;/p&gt;
      &lt;div&gt;{{ comment.content | markdownify }}&lt;/div&gt;
    &lt;/div&gt;
  {% endfor %}
&lt;/div&gt;
{% endif %}
</code></pre>

<p>Получилось неоптимально, потому что на каждый пост происходит линейный поиск. В идеале нужно один раз построить словарь URL =&gt; список комментариев и затем брать оттуда. Но я не настолько хорошо знаю Jekyll и Ruby, чтобы это запилить.</p>

<p>Ради интереса проверьте страницы, где много комментариев, например <a href="/ivi/#comments-block">про сервис IVI</a> или <a href="/interview/#comments-block">про интервью</a>. Лично мне результат нравится: чистенький HTML, минимум CSS, все лаконично. На текущий момент не учитывается структура, но технически это возможно: каждый комментарий знает ID родителя, и однажды их вывод можно улучшить.</p>

<p><img src="/assets/static/aws/de-js2/2.png" /></p>

<p>Теперь главное: как сделать прием комментариев. Мне накидали советов, плюс я гуглил, и все сводится двум решениям: Гитхаб или self-hosted сервис.</p>

<p>Напомню, как работает Гитхаб: люди пишут комменты к какому-либо issue. Зная номер issue, легко выгрести комментарии GET-запросом, сгенерить HTML и вставить под заметкой. <a href="https://blog.rpsl.info/2020/09/how-migrate-comments-from-disqus-to-github/">Выглядит красиво</a>:</p>

<p><img src="/assets/static/aws/de-js2/1.png" /></p>

<p>, но меня тревожат две вещи.</p>

<ol>
  <li>Комментарии лежат в чужом сервисе, который может отвалиться из-за санкций или Роскомнадзора.</li>
  <li>Обязательна авторизация через Гитхаб — не у всех есть учетная запись.</li>
</ol>

<p>Self-hosted-решения вроде <a href="https://remark42.com/">Remark42</a> интересны, но вынуждают держать виртуалку, платить за нее и делать бекапы. Придется возиться.</p>

<p>Я придумал так. Пишем лямбду для Яндекс.Облака (на Кложе с компиляцией Граалем). Лямбда принимает POST-запросы с сайта. На сайте висит статичная форма с полем action=URL нашей лямбды. Отправить форму может любой желающий, даже тот, у кого нет учетки в Гитхабе, Твиттере, Инстаграме и так далее.</p>

<p>Получив запрос, лямбда создает pull request в репозитории блога. Для этого не нужен git: все возможности Гитхаба доступны <a href="https://docs.github.com/en/rest/pulls/pulls#create-a-pull-request">в REST API</a>. Pull request содержит новый файл с комментарием в папке <code class="language-plaintext highlighter-rouge">_comments</code>. Мне приходит письмо. Если норм, я нажимаю Merge, блог собирается и выкатывается новая версия.</p>

<p>Одновременно получается модерация: если кто-то написал дичь, я отклоняю PR, и делу конец.</p>

<p>Открыв PR, лямбда перенаправляет пользователя обратно в блог со словами “спасибо, ваш комментарий скоро появится”.</p>

<p>Вот такую штуку я хочу запилить. А пока что комментации работают только в Телеграме.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/de-js/">Деджаваскриптизиция</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2022-09-11T00:00:00+00:00">
        Sep 11, 2022
    </time>

    <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/javascript/" rel="tag">javascript</a>, <a href="/tag/blog/" rel="tag">blog</a>, <a href="/tag/disqus/" rel="tag">disqus</a>

</div>


            <div class="entry">
                
                    <p>Как вы думаете, сколько запросов делает браузер, пока вы читаете заметку в моем блоге? Я тоже не знал. Десять, двадцать? Что гадать, если можно проверить!</p>

<p>Открываем консоль разработчика, вкладка Network. Виден всякий ajax/js-хлам. Тык правой кнопкой → “Save all as HAR with content”:</p>

<p><img src="/assets/static/aws/de-js/1.png" /></p>

<p>Получаем жирный JSON со всеми запросами. Вот как выдрать из него урлы:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat </span>grishaev.me.har | jq <span class="s1">'.log.entries[].request.url'</span> | <span class="nb">sort</span> <span class="o">&gt;</span> urls.txt
</code></pre></div></div>

<p>Если открыть <code class="language-plaintext highlighter-rouge">urls.txt</code> и удалить адреса с доменом <code class="language-plaintext highlighter-rouge">grishaev.me</code> (коих 5 штук), получится… 69 запросов. Вот они:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://a.disquscdn.com/1662551939/images/noavatar92.png
https://a.disquscdn.com/1662551939/images/noavatar92.png
https://accounts.google.com/o/oauth2/iframe
https://accounts.google.com/o/oauth2/iframerpc?action=checkOrigin&amp;origin=https%3A%2F%2Fdisqus.com&amp;client_id=508198334196-bgmagrg0a2rub674g0shidj8fnd50dji.apps.googleusercontent.com
https://accounts.google.com/o/oauth2/iframerpc?action=issueToken&amp;response_type=token%20id_token&amp;login_hint=AJDLj6J0ayD55kiHpX6FEyK8AjchAx-IxO13rW-0myyrGzenEj7YZFquZJE4XTK6YDPt86Y7SJkVEXs3QpNMeay0bCjiNqDIwg&amp;client_id=508198334196-bgmagrg0a2rub674g0shidj8fnd50dji.apps.googleusercontent.com&amp;origin=https%3A%2F%2Fdisqus.com&amp;scope=profile%20email&amp;ss_domain=https%3A%2F%2Fdisqus.com&amp;include_granted_scopes=true
https://apis.google.com/_/scs/abc-static/_/js/k=gapi.lb.en.z9QjrzsHcOc.O/m=auth2/rt=j/sv=1/d=1/ed=1/rs=AHpOoo8359JQqZQ0dzCVJ5Ui3CZcERHEWA/cb=gapi.loaded_0?le=scs
https://apis.google.com/js/api.js
https://c.disquscdn.com/get?url=https%3A%2F%2Fgrishaev.me%2Fassets%2Fstatic%2Faws%2Fbw%2Fui.png&amp;key=5su7aFyKRIY_tqfWlxdSzw&amp;h=200
https://c.disquscdn.com/get?url=https%3A%2F%2Fgrishaev.me%2Fassets%2Fstatic%2Faws%2Fmail%2F2.png&amp;key=P-FCJdQOuptvsG613K8vJA&amp;h=200
https://c.disquscdn.com/get?url=https%3A%2F%2Fs3.amazonaws.com%2Figrishaev.public%2Fexcel%2Fgood.jpg&amp;key=8OltNCXozdgFxMHmgBTDtQ&amp;h=200
https://c.disquscdn.com/get?url=https%3A%2F%2Fs3.amazonaws.com%2Figrishaev.public%2Ftele%2Fscan.jpg&amp;key=3S4NMvR9Sa2dqAik9FSSBw&amp;h=200
https://c.disquscdn.com/get?url=https%3A%2F%2Fs3.amazonaws.com%2Figrishaev.public%2Fvlc%2Feat.png&amp;key=_fOEu4w6cw03wCawGGrA_Q&amp;h=200
https://c.disquscdn.com/next/current/embed/lang/ru.js
https://c.disquscdn.com/next/current/publisher-admin/assets/img/emoji/funny-512x512.png
https://c.disquscdn.com/next/current/publisher-admin/assets/img/emoji/sad-512x512.png
https://c.disquscdn.com/next/current/publisher-admin/assets/img/emoji/upvote-512x512.png
https://c.disquscdn.com/next/current/recommendations/lang/ru.js
https://c.disquscdn.com/next/embed/alfie_v4.63f1ab6d6b9d5807dc0c94ef3fe0b851.js
https://c.disquscdn.com/next/embed/assets/font/icons.4cc7a703d2fdfe684151ff8ac24d45f1.woff2
https://c.disquscdn.com/next/embed/assets/img/disqus-social-icon-dark.a621bea3e02c9fa04fd3965a3d6f424d.svg
https://c.disquscdn.com/next/embed/assets/img/loader.ba7c86e8b4b6135bb668d05223f8f127.gif
https://c.disquscdn.com/next/embed/assets/img/sprite.ad630a07080a45451f139a7487853ff8.png
https://c.disquscdn.com/next/embed/assets/img/svg-sprite.4da5413f5086c5755b46094b813dbfcd.svg
https://c.disquscdn.com/next/embed/common.bundle.33bc87b2c4f9324203cc85b7dd1d0492.js
https://c.disquscdn.com/next/embed/common.bundle.33bc87b2c4f9324203cc85b7dd1d0492.js
https://c.disquscdn.com/next/embed/lounge.bundle.8d28276e15f31af0eebfd934278922d1.js
https://c.disquscdn.com/next/embed/lounge.bundle.8d28276e15f31af0eebfd934278922d1.js
https://c.disquscdn.com/next/embed/lounge.load.0837a7fb2afa86b68e4ee5098ec9905b.js
https://c.disquscdn.com/next/embed/styles/lounge.4ceaf0673822a0def820ebdc38d84415.css
https://c.disquscdn.com/next/embed/styles/lounge.4ceaf0673822a0def820ebdc38d84415.css
https://c.disquscdn.com/next/recommendations/assets/img/img-placeholder.df52e7638153b73862008d3d0556fdda.png
https://c.disquscdn.com/next/recommendations/common.bundle.a59fbd11efae764ccd959d61e4925fee.js
https://c.disquscdn.com/next/recommendations/common.bundle.a59fbd11efae764ccd959d61e4925fee.js
https://c.disquscdn.com/next/recommendations/recommendations.bundle.926bc472e4859a48daa346b4ba2ab4f4.js
https://c.disquscdn.com/next/recommendations/recommendations.bundle.926bc472e4859a48daa346b4ba2ab4f4.js
https://c.disquscdn.com/next/recommendations/recommendations.load.9d352c9674ae8172f8669d3aa3a905e9.js
https://c.disquscdn.com/next/recommendations/styles/recommendations.10022a97346f1c6e3798931bbd8e4bb5.css
https://c.disquscdn.com/next/recommendations/styles/recommendations.10022a97346f1c6e3798931bbd8e4bb5.css
https://cdn.viglink.com/images/pixel.gif?ch=1&amp;rn=8.95348561821992
https://cdn.viglink.com/images/pixel.gif?ch=2&amp;rn=8.95348561821992
https://connect.facebook.net/en_US/sdk.js
https://disqus.com/api/3.0/discovery/listRecommendations.json?forum=igrishaev&amp;thread=url%3Ahttps%3A%2F%2Fgrishaev.me%2Fen%2Fzippo%2F&amp;limit=8&amp;api_key=E8Uh5l5fHZ6gD8U3KycjAIAk46f68Zw7C6eW8WSjZvCLXebZ7p0r1yrYDrLilk2F
https://disqus.com/api/3.0/forums/details?forum=igrishaev&amp;attach=forumFeatures&amp;api_key=E8Uh5l5fHZ6gD8U3KycjAIAk46f68Zw7C6eW8WSjZvCLXebZ7p0r1yrYDrLilk2F
https://disqus.com/api/3.0/forums/details?forum=igrishaev&amp;attach=forumFeatures&amp;api_key=E8Uh5l5fHZ6gD8U3KycjAIAk46f68Zw7C6eW8WSjZvCLXebZ7p0r1yrYDrLilk2F
https://disqus.com/api/3.0/threadReactions/loadReactions?thread=9335567925&amp;api_key=E8Uh5l5fHZ6gD8U3KycjAIAk46f68Zw7C6eW8WSjZvCLXebZ7p0r1yrYDrLilk2F
https://disqus.com/embed/comments/?base=default&amp;f=igrishaev&amp;t_u=https%3A%2F%2Fgrishaev.me%2Fen%2Fzippo%2F&amp;t_d=Zippo%3A%20additions%20to%20the%20standard%20clojure.zip%20package.&amp;t_t=Zippo%3A%20additions%20to%20the%20standard%20clojure.zip%20package.&amp;s_o=default
https://disqus.com/next/config.js
https://disqus.com/next/config.js
https://disqus.com/next/config.js
https://disqus.com/recommendations/?base=default&amp;f=igrishaev&amp;t_u=https%3A%2F%2Fgrishaev.me%2Fen%2Fzippo%2F&amp;t_d=Zippo%3A%20additions%20to%20the%20standard%20clojure.zip%20package.&amp;t_t=Zippo%3A%20additions%20to%20the%20standard%20clojure.zip%20package.
https://fonts.googleapis.com/css?family=PT+Serif:400,400i,700,700i&amp;display=swap&amp;subset=cyrillic,cyrillic-ext,latin-ext
https://fonts.gstatic.com/s/ptserif/v17/EJRSQgYoZZY2vCFuvAnt66qSVyvVp8NA.woff2
https://fonts.gstatic.com/s/ptserif/v17/EJRVQgYoZZY2vCFuvAFSzr-_dSb_nco.woff2
https://fonts.gstatic.com/s/ptserif/v17/EJRVQgYoZZY2vCFuvAFWzr-_dSb_.woff2
https://glitter.services.disqus.com/urls/?callback=dsqGlitterResponseHandler&amp;forum_shortname=igrishaev&amp;thread_id=9335567925&amp;referer=https%3A%2F%2Fgrishaev.me%2F
https://igrishaev.disqus.com/embed.js
https://igrishaev.disqus.com/recommendations.js
https://io.narrative.io/?companyId=19&amp;id=disqus_id%3Ac6g0c4dk2irns7l&amp;ret=img&amp;ref=https%3A%2F%2Fgrishaev.me%2Fen%2Fzippo%2F
https://links.services.disqus.com/api/ping
https://live.rezync.com/pixel.html?c=4656c20ee35215f78e9273796625d90b&amp;cid=c6g0c4dk2irns7l&amp;pctry=RU&amp;referrer=https%3A%2F%2Fgrishaev.me%2Fen%2Fzippo%2F
https://mc.yandex.ru/metrika/tag.js
https://pippio.com/api/sync?pid=1391&amp;ref=https%3A%2F%2Fgrishaev.me%2Fen%2Fzippo%2F&amp;it=1&amp;iv=c6g0c4dk2irns7l
https://referrer.disqus.com/juggler/event.gif?abe=1&amp;embed_hidden=0&amp;load_time=1311&amp;event=init_embed&amp;thread=9335567925&amp;forum=igrishaev&amp;forum_id=3964395&amp;imp=2l7278t3kf6iha&amp;prev_imp&amp;thread_slug=zippo_additions_to_the_standard_clojurezip_package&amp;user_type=anon&amp;referrer=https%3A%2F%2Fgrishaev.me%2F&amp;theme=next&amp;dnt=0&amp;tracking_enabled=1&amp;experiment=network_default&amp;variant=fallthrough&amp;service=dynamic&amp;promoted_enabled=true&amp;max_enabled=true
https://referrer.disqus.com/juggler/event.js?experiment=network_default&amp;variant=fallthrough&amp;page_referrer=https%3A%2F%2Fgrishaev.me%2F&amp;product=embed&amp;thread=9335567925&amp;thread_id=9335567925&amp;forum=igrishaev&amp;forum_id=3964395&amp;zone=thread&amp;page_url=https%3A%2F%2Fgrishaev.me%2Fen%2Fzippo%2F&amp;service=dynamic&amp;verb=view&amp;object_type=product&amp;object_id=embed&amp;extra_data=%7B%22color_scheme%22%3A%22light%22%2C%22anchor_color%22%3A%22rgb(42%2C122%2C226)%22%2C%22typeface%22%3A%22serif%22%2C%22width%22%3A740%7D&amp;event=activity&amp;imp=2l7278t3kf6iha&amp;prev_imp=&amp;section=default&amp;area=n%2Fa
https://referrer.disqus.com/juggler/stat.gif?event=lounge.loading.view
https://www.google-analytics.com/analytics.js
https://www.gstatic.com/_/mss/boq-identity/_/js/k=boq-identity.IdpIFrameHttp.en_US.z2a12LkW96g.es5.O/d=1/rs=AOaEmlHeSnuHrM44y1tAD9SSj44ODEuRFQ/m=base
https://yastatic.net/es5-shims/0.0.2/es5-shims.min.js
https://yastatic.net/share2/share.js
</code></pre></div></div>

<p>Да, Карл: шестьдесят девять запросов на всякие аналитики, кнопки шаринга и комментарии Disqus. Не знаю, почему некоторые урлы повторяются, выяснять это нет никакого желания. Важное уточнение: 69 – это только в начале. Если промотать страницу и написать комментарий, подгрузится еще пачка скриптов.</p>

<p>С Disqus вообще беда: с недавних пор они внедрили рекламу. Блокировщики справляются, но как-то раз я зашел на сайт из голого Сафари и о…уел от того, что творит Disqus на странице:</p>

<p><img src="/assets/static/aws/de-js/2.jpg" /></p>

<p><img src="/assets/static/aws/de-js/3.jpg" /></p>

<p>На мобиле еще хуже: баннеры выстраиваются вертикально, и нужно мотать два экрана.</p>

<p>Кое-что из этого можно отключить в настройках, но в целом от рекламы нельзя избавиться, не заплатив. Да и не в рекламе дело, а в адском количестве скриптов. Сомневаюсь, что купив подписку, можно убавить их число.</p>

<p><img src="/assets/static/aws/de-js/4.png" /></p>

<p>Ясно одно: это не правильно, нужно исправлять.</p>

<p>Социальные кнопки и гугло-аналитику банально удалю. За кнопки мне стыдно, потому что это рудимент нулевых. Сегодня они встречаются разве что на сайтах, сделанных в говно-CMS вроде Джумлы, Друпала и Вордпресса. Аналитика была б хороша, если б Гугл не плевал на все этические нормы. Выбирая между желанием посмотреть, кто и что читает и приватностью читателей, я предпочту второе.</p>

<p>Самое интересное с комментариями. Не сказать, что мои заметки активно комментируют, но время от времени это случается. Особо приятно получить комментарий от бывших коллег, с которыми когда-то работал. Несколько раз в комментариях писали ценные вещи, и я был искренне благодарен.</p>

<p>У меня возникла идея перенести комментарии Disqus в блог. Технически это возможно: в админке Disqus выгружаем все комментарии, получаем жирный XML-файл (про JSON ребята не слышали). Далее пишем скрипт, который обходит XML и дописывает в файлы с постами. Однажды я уже делал так, <a href="/new-blog/">когда мигрировал</a> с Эгеи (движка на PHP), только вместо XML был дамп MySQL.</p>

<p>Остался последний вопрос: как сделать прием комментариев без Disqus? У меня есть одна мысль, но я опишу ее в другой раз, а пока что послушаю ваши советы.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/clj-repl-part-3/">REPL, Cider, Emacs (часть 3/4)</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2022-09-05T00:00:00+00:00">
        Sep 5, 2022
    </time>

    <a href="/tag/clojure/" rel="tag">clojure</a>, <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/repl/" rel="tag">repl</a>, <a href="/tag/emacs/" rel="tag">emacs</a>, <a href="/tag/cider/" rel="tag">cider</a>

</div>


            <div class="entry">
                
                    
<h2>Все части</h2>

<ul>
  <li><a href="/clj-repl-part-1/">Первая часть</a></li>
  <li><a href="/clj-repl-part-2/">Вторая часть</a></li>
  <li><a href="/clj-repl-part-3/">Третья часть</a></li>
  <li><a href="/clj-repl-part-4/">Четвертая часть</a></li>
</ul>

<h2>

    Оглавление

</h2>

<ul id="toc-item-clojure-repl-toc">
  <li><a href="#пространства-имен" id="toc-item-clojure-repl-toc-пространства-имен">Пространства имен</a></li>
  <li><a href="#переход-к-определению" id="toc-item-clojure-repl-toc-переход-к-определению">Переход к определению</a>    <ul>
      <li><a href="#xref" id="toc-item-clojure-repl-toc-xref">Xref</a></li>
      <li><a href="#imenu" id="toc-item-clojure-repl-toc-imenu">Imenu</a></li>
    </ul>
  </li>
  <li><a href="#тесты-в-cider" id="toc-item-clojure-repl-toc-тесты-в-cider">Тесты в Cider</a></li>
  <li><a href="#отладка-сообщений-nrepl" id="toc-item-clojure-repl-toc-отладка-сообщений-nrepl">Отладка сообщений nREPL</a></li>
  <li><a href="#отладка-кода" id="toc-item-clojure-repl-toc-отладка-кода">Отладка кода</a>    <ul>
      <li><a href="#наивные-способы" id="toc-item-clojure-repl-toc-наивные-способы">Наивные способы</a></li>
      <li><a href="#внедрение-в-чужой-код" id="toc-item-clojure-repl-toc-внедрение-в-чужой-код">Внедрение в чужой код</a></li>
      <li><a href="#подготовка-к-отладке" id="toc-item-clojure-repl-toc-подготовка-к-отладке">Подготовка к отладке</a></li>
      <li><a href="#продвинутый-eval" id="toc-item-clojure-repl-toc-продвинутый-eval">Продвинутый eval</a></li>
      <li><a href="#отладчик-своими-руками" id="toc-item-clojure-repl-toc-отладчик-своими-руками">Отладчик своими руками</a></li>
      <li><a href="#множественная-отладка-теория" id="toc-item-clojure-repl-toc-множественная-отладка-теория">Множественная отладка (теория)</a></li>
      <li><a href="#отладочный-тег" id="toc-item-clojure-repl-toc-отладочный-тег">Отладочный тег</a></li>
    </ul>
  </li>
</ul>

<h2 id="пространства-имен">Пространства имен</h2>

<p>При работе с REPL мы всегда находимся в каком-то пространстве. По умолчанию оно написано в приглашении:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">user=&gt;</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>Если перейти в другое пространство, изменится и приглашение:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">user=&gt;</span><span class="w"> </span><span class="p">(</span><span class="nb">in-ns</span><span class="w"> </span><span class="ss">'foobar</span><span class="p">)</span><span class="w">
</span><span class="n">foobar=&gt;</span><span class="w">
</span></code></pre></div></div>

<p>Код, что мы вводим в REPL, вычисляется в текущем пространстве. Если объявить в модуле <code class="language-plaintext highlighter-rouge">user</code> переменную:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nb">in-ns</span><span class="w"> </span><span class="ss">'user</span><span class="p">)</span><span class="w">
</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">number</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>, а затем сослаться на нее в пространстве <code class="language-plaintext highlighter-rouge">foobar</code>, получим ошибку, что символ <code class="language-plaintext highlighter-rouge">number</code> не найден в текущем контексте:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nb">in-ns</span><span class="w"> </span><span class="ss">'foobar</span><span class="p">)</span><span class="w">
</span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">number</span><span class="p">)</span><span class="w">

</span><span class="n">Syntax</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">compiling</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="p">(</span><span class="nf">repl-chapter</span><span class="no">:localhost:53495</span><span class="p">(</span><span class="nf">clj</span><span class="p">)</span><span class="nb">*</span><span class="no">:1:8440</span><span class="p">)</span><span class="nb">.</span><span class="w">
</span><span class="n">Unable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="nb">resolve</span><span class="w"> </span><span class="nb">symbol</span><span class="err">:</span><span class="w"> </span><span class="n">number</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">context</span><span class="w">
</span></code></pre></div></div>

<p>Другой пример: объявим в модулях <code class="language-plaintext highlighter-rouge">user</code> и <code class="language-plaintext highlighter-rouge">foobar</code> переменные <code class="language-plaintext highlighter-rouge">number</code> со значениями 1 и 2. Теперь одна и та же форма <code class="language-plaintext highlighter-rouge">(inc number)</code> даст разный результат в зависимости от того, какое пространство текущее. Поэтому перед вычислением мы должны убедиться, что находимся в нужном пространстве имен.</p>

<p>Чтобы уберечь нас от подобных ошибок, nREPL учитывает параметр <code class="language-plaintext highlighter-rouge">ns</code> в сообщениях. Когда мы выполняем код при помощи <code class="language-plaintext highlighter-rouge">cider-eval-...</code>, в сообщении, помимо полей <code class="language-plaintext highlighter-rouge">op</code> и <code class="language-plaintext highlighter-rouge">code</code>, передается <code class="language-plaintext highlighter-rouge">ns</code>. Его значение Cider находит из формы <code class="language-plaintext highlighter-rouge">(ns...)</code> в начале файла. Вычисляя форму, сервер временно меняет пространство, и результат совпадает с тем, что ожидают.</p>


                    <p><a href="/clj-repl-part-3/">Read more &rarr;</a></p>
                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/en/zippo/">Zippo: additions to the standard clojure.zip package.</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2022-09-02T00:00:00+00:00">
        Sep 2, 2022
    </time>

    <a href="/tag/clojure/" rel="tag">clojure</a>, <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/zippers/" rel="tag">zippers</a>

</div>


            <div class="entry">
                
                    
<p>The <code class="language-plaintext highlighter-rouge">clojure.zip</code> package is a masterpiece yet misses some utility
functions. For example, finding locations, bulk updates, lookups, breadth-first
traversing and so on. <a href="https://github.com/igrishaev/zippo">Zippo</a>, the library I’m introducing in this post,
brings some bits of missing functionality.</p>

<h3 id="installation">Installation</h3>

<p>Lein:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="n">com.github.igrishaev/zippo</span><span class="w"> </span><span class="s">"0.1.0"</span><span class="p">]</span><span class="w">
</span></code></pre></div></div>

<p>Deps.edn</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="n">com.github.igrishaev/zippo</span><span class="w"> </span><span class="p">{</span><span class="no">:mvn/version</span><span class="w"> </span><span class="s">"0.1.0"</span><span class="p">}}</span><span class="w">
</span></code></pre></div></div>

<h3 id="usage--examples">Usage &amp; examples</h3>

<p>First, import both Zippo and <code class="language-plaintext highlighter-rouge">clojure.zip</code>:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">ns</span><span class="w"> </span><span class="n">zippo.core-test</span><span class="w">
  </span><span class="p">(</span><span class="no">:require</span><span class="w">
   </span><span class="p">[</span><span class="n">clojure.zip</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">zip</span><span class="p">]</span><span class="w">
   </span><span class="p">[</span><span class="n">zippo.core</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">zippo</span><span class="p">]))</span><span class="w">
</span></code></pre></div></div>

<p>Declare a zipper:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">z</span><span class="w">
  </span><span class="p">(</span><span class="nf">zip/vector-zip</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="p">[</span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="p">[[</span><span class="mi">4</span><span class="p">]]]))</span><span class="w">
</span></code></pre></div></div>

<p>Now check out the following Zippo functions.</p>

<h4 id="a-finite-seq-of-locations">A finite seq of locations</h4>

<p>The <code class="language-plaintext highlighter-rouge">loc-seq</code> funtion takes a location and returns a lazy seq of locations
untill it reaches the end:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">locs</span><span class="w"> </span><span class="p">(</span><span class="nf">zippo/loc-seq</span><span class="w"> </span><span class="n">z</span><span class="p">)]</span><span class="w">
  </span><span class="p">(</span><span class="nf">mapv</span><span class="w"> </span><span class="n">zip/node</span><span class="w"> </span><span class="n">locs</span><span class="p">))</span><span class="w">

</span><span class="c1">;; get a vector of notes to reduce the output</span><span class="w">
</span><span class="p">[[</span><span class="mi">1</span><span class="w"> </span><span class="p">[</span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="p">[[</span><span class="mi">4</span><span class="p">]]]</span><span class="w">
 </span><span class="mi">1</span><span class="w">
 </span><span class="p">[</span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="p">]</span><span class="w">
 </span><span class="mi">2</span><span class="w">
 </span><span class="mi">3</span><span class="w">
 </span><span class="p">[[</span><span class="mi">4</span><span class="p">]]</span><span class="w">
 </span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w">
 </span><span class="mi">4</span><span class="p">]</span><span class="w">
</span></code></pre></div></div>

<p>This is quite useful to traverse a zipper without keeping in mind the ending
condition (<code class="language-plaintext highlighter-rouge">zip/end?</code>).</p>

<h4 id="finding-locations">Finding locations</h4>

<p>The <code class="language-plaintext highlighter-rouge">loc-find</code> function looks for the first location that matches a predicate:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">loc</span><span class="w"> </span><span class="p">(</span><span class="nf">zippo/loc-find</span><span class="w">
           </span><span class="n">z</span><span class="w">
           </span><span class="p">(</span><span class="k">fn</span><span class="w"> </span><span class="p">[</span><span class="n">loc</span><span class="p">]</span><span class="w">
             </span><span class="p">(</span><span class="nb">-&gt;</span><span class="w"> </span><span class="n">loc</span><span class="w"> </span><span class="n">zip/node</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="mi">3</span><span class="p">))))]</span><span class="w">

  </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="p">(</span><span class="nf">zip/node</span><span class="w"> </span><span class="n">loc</span><span class="p">))))</span><span class="w">
</span></code></pre></div></div>

<p>Above, we found a location which node equals 3.</p>

<p>The <code class="language-plaintext highlighter-rouge">loc-find-all</code> function finds all the locatins that match the predicate:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">locs</span><span class="w"> </span><span class="p">(</span><span class="nf">zippo/loc-find-all</span><span class="w">
            </span><span class="n">z</span><span class="w">
            </span><span class="p">(</span><span class="nf">zippo/-&gt;loc-pred</span><span class="w"> </span><span class="p">(</span><span class="nf">every-pred</span><span class="w"> </span><span class="n">int?</span><span class="w"> </span><span class="n">even?</span><span class="p">)))]</span><span class="w">

  </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">[</span><span class="mi">2</span><span class="w"> </span><span class="mi">4</span><span class="p">]</span><span class="w">
         </span><span class="p">(</span><span class="nf">mapv</span><span class="w"> </span><span class="n">zip/node</span><span class="w"> </span><span class="n">locs</span><span class="p">))))</span><span class="w">
</span></code></pre></div></div>

<p>Since the predicate accepts a location, you can check its children, siblings and
so on. For example, check if a location belongs to a special kind of parent.</p>

<p>However, most of the time you’re interested in a value (node) rather than a
location. The <code class="language-plaintext highlighter-rouge">-&gt;loc-pred</code> function converts a node predicate, which accepts a
node, into a location predicate. In the example above, the line</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">zippo/-&gt;loc-pred</span><span class="w"> </span><span class="p">(</span><span class="nf">every-pred</span><span class="w"> </span><span class="n">int?</span><span class="w"> </span><span class="n">even?</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<p>makes a location predicate which node is an even integer.</p>

<h4 id="updating-a-zipper">Updating a zipper</h4>

<p>Zippo offers some functions to update a zipper.</p>

<p>The <code class="language-plaintext highlighter-rouge">loc-update</code> one takes a location predicate, an update function and the rest
arguments. Here is how you douple all the even numbers in a nested vector:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">loc</span><span class="w">
      </span><span class="p">(</span><span class="nf">zippo/loc-update</span><span class="w">
       </span><span class="n">z</span><span class="w">
       </span><span class="p">(</span><span class="nf">zippo/-&gt;loc-pred</span><span class="w"> </span><span class="p">(</span><span class="nf">every-pred</span><span class="w"> </span><span class="n">int?</span><span class="w"> </span><span class="n">even?</span><span class="p">))</span><span class="w">
       </span><span class="n">zip/edit</span><span class="w"> </span><span class="nb">*</span><span class="w"> </span><span class="mi">2</span><span class="p">)]</span><span class="w">

  </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="p">[</span><span class="mi">4</span><span class="w"> </span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="p">[[</span><span class="mi">8</span><span class="p">]]]</span><span class="w">
         </span><span class="p">(</span><span class="nf">zip/root</span><span class="w"> </span><span class="n">loc</span><span class="p">))))</span><span class="w">
</span></code></pre></div></div>

<p>For the updating function, one may use <code class="language-plaintext highlighter-rouge">zip/append-child</code> to append a child,
<code class="language-plaintext highlighter-rouge">zip/remove</code> to drop the entire location and so on:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">loc</span><span class="w">
      </span><span class="p">(</span><span class="nf">zippo/loc-update</span><span class="w">
       </span><span class="n">z</span><span class="w">
       </span><span class="p">(</span><span class="k">fn</span><span class="w"> </span><span class="p">[</span><span class="n">loc</span><span class="p">]</span><span class="w">
         </span><span class="p">(</span><span class="nb">-&gt;</span><span class="w"> </span><span class="n">loc</span><span class="w"> </span><span class="n">zip/node</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">[</span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="p">])))</span><span class="w">
       </span><span class="n">zip/append-child</span><span class="w">
       </span><span class="no">:A</span><span class="p">)]</span><span class="w">

  </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="p">[</span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="no">:A</span><span class="p">]</span><span class="w"> </span><span class="p">[[</span><span class="mi">4</span><span class="p">]]]</span><span class="w">
         </span><span class="p">(</span><span class="nf">zip/root</span><span class="w"> </span><span class="n">loc</span><span class="p">))))</span><span class="w">
</span></code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">node-update</code> function is similar but acts on nodes. Instead of <code class="language-plaintext highlighter-rouge">loc-pred</code>
and <code class="language-plaintext highlighter-rouge">loc-fn</code>, it accepts <code class="language-plaintext highlighter-rouge">node-pred</code> and <code class="language-plaintext highlighter-rouge">node-fn</code> what operate on nodes.</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">loc</span><span class="w">
    </span><span class="p">(</span><span class="nf">zippo/node-update</span><span class="w">
     </span><span class="n">z</span><span class="w">
     </span><span class="n">int?</span><span class="w">
     </span><span class="nb">inc</span><span class="p">)]</span><span class="w">
</span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">[</span><span class="mi">2</span><span class="w"> </span><span class="p">[</span><span class="mi">3</span><span class="w"> </span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="p">[[</span><span class="mi">5</span><span class="p">]]]</span><span class="w">
       </span><span class="p">(</span><span class="nf">zip/root</span><span class="w"> </span><span class="n">loc</span><span class="p">))))</span><span class="w">
</span></code></pre></div></div>

<h4 id="slicing-a-zipper-by-layers">Slicing a zipper by layers</h4>

<p>Sometimes, you need to slice a zipper on layers. This is what is better seen on
a chart:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>     +---ROOT---+    ;; layer 1
     |          |
   +-A-+      +-B-+  ;; layer 2
   | | |      | | |
   X Y Z      J H K  ;; layer 3
</code></pre></div></div>

<ul>
  <li>Layer 1 is <code class="language-plaintext highlighter-rouge">[Root]</code>;</li>
  <li>Layer 1 is <code class="language-plaintext highlighter-rouge">[A B]</code>;</li>
  <li>Layer 3 is <code class="language-plaintext highlighter-rouge">[X Y Z J H K]</code></li>
</ul>

<p>The <code class="language-plaintext highlighter-rouge">loc-layers</code> function takes a location and builds a lazy seq of layers. The
first layer is the given location, then its children, the children of children
and so on.</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">layers</span><span class="w">
      </span><span class="p">(</span><span class="nf">zippo/loc-layers</span><span class="w"> </span><span class="n">z</span><span class="p">)]</span><span class="w">

  </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="o">'</span><span class="p">(([</span><span class="mi">1</span><span class="w"> </span><span class="p">[</span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="p">[[</span><span class="mi">4</span><span class="p">]]])</span><span class="w">
           </span><span class="p">(</span><span class="nf">1</span><span class="w"> </span><span class="p">[</span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="p">[[</span><span class="mi">4</span><span class="p">]])</span><span class="w">
           </span><span class="p">(</span><span class="nf">2</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="p">[</span><span class="mi">4</span><span class="p">])</span><span class="w">
           </span><span class="p">(</span><span class="nf">4</span><span class="p">))</span><span class="w">
         </span><span class="p">(</span><span class="k">for</span><span class="w"> </span><span class="p">[</span><span class="n">layer</span><span class="w"> </span><span class="n">layers</span><span class="p">]</span><span class="w">
           </span><span class="p">(</span><span class="k">for</span><span class="w"> </span><span class="p">[</span><span class="n">loc</span><span class="w"> </span><span class="n">layer</span><span class="p">]</span><span class="w">
             </span><span class="p">(</span><span class="nf">zip/node</span><span class="w"> </span><span class="n">loc</span><span class="p">))))))</span><span class="w">
</span></code></pre></div></div>

<h4 id="breadth-first-seq-of-locations">Breadth-first seq of locations</h4>

<p>The <code class="language-plaintext highlighter-rouge">clojure.zip</code> package uses <a href="https://en.wikipedia.org/wiki/Depth-first_search">depth-first method</a> of traversing a
tree. Let’s number the items:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>       +-----ROOT[1]----+
       |                |
 +----A[2]---+     +---B[6]--+
 |     |     |     |    |    |
 X[3] Y[4] Z[5]   J[7] H[8] K[9]
</code></pre></div></div>

<p>This sometimes may end up with an infinity loop when you generate children
on the fly.</p>

<p>The <code class="language-plaintext highlighter-rouge">loc-seq-breadth</code> functions offers the opposite way of traversing a zipper:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>       +-----ROOT[1]----+
       |                |
 +----A[2]---+     +---B[3]--+
 |     |     |     |    |    |
 X[4] Y[5] Z[6]   J[7] H[8] K[9]
</code></pre></div></div>

<p>This is useful to solve some special tasks related to zippers.</p>

<h4 id="lookups">Lookups</h4>

<p>When working with zippers, you often need such functionality as “go
up/left/right until meet something”. For example, from a given location, go up
until a parent has a special attribute. Zippo offers four functions for that,
namely <code class="language-plaintext highlighter-rouge">lookup-up</code>, <code class="language-plaintext highlighter-rouge">lookup-left</code>, <code class="language-plaintext highlighter-rouge">lookup-right</code>, and <code class="language-plaintext highlighter-rouge">lookup-down.</code> All of
them take a location and a predicate:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">loc</span><span class="w">
      </span><span class="p">(</span><span class="nf">zip/vector-zip</span><span class="w"> </span><span class="p">[</span><span class="no">:a</span><span class="w"> </span><span class="p">[</span><span class="no">:b</span><span class="w"> </span><span class="p">[</span><span class="no">:c</span><span class="w"> </span><span class="p">[</span><span class="no">:d</span><span class="p">]]]</span><span class="w"> </span><span class="no">:e</span><span class="p">])</span><span class="w">

      </span><span class="n">loc-d</span><span class="w">
      </span><span class="p">(</span><span class="nf">zippo/loc-find</span><span class="w"> </span><span class="n">loc</span><span class="w">
                      </span><span class="p">(</span><span class="nf">zippo/-&gt;loc-pred</span><span class="w">
                       </span><span class="p">(</span><span class="k">fn</span><span class="w"> </span><span class="p">[</span><span class="nb">node</span><span class="p">]</span><span class="w">
                         </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="nb">node</span><span class="w"> </span><span class="no">:d</span><span class="p">))))</span><span class="w">

      </span><span class="n">loc-b</span><span class="w">
      </span><span class="p">(</span><span class="nf">zippo/lookup-up</span><span class="w"> </span><span class="n">loc-d</span><span class="w">
                       </span><span class="p">(</span><span class="nf">zippo/-&gt;loc-pred</span><span class="w">
                        </span><span class="p">(</span><span class="k">fn</span><span class="w"> </span><span class="p">[</span><span class="nb">node</span><span class="p">]</span><span class="w">
                          </span><span class="p">(</span><span class="nb">and</span><span class="w"> </span><span class="p">(</span><span class="nb">vector?</span><span class="w"> </span><span class="nb">node</span><span class="p">)</span><span class="w">
                               </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="no">:b</span><span class="w"> </span><span class="p">(</span><span class="nb">first</span><span class="w"> </span><span class="nb">node</span><span class="p">))))))]</span><span class="w">

  </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="no">:d</span><span class="w"> </span><span class="p">(</span><span class="nf">zip/node</span><span class="w"> </span><span class="n">loc-d</span><span class="p">)))</span><span class="w">

  </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">[</span><span class="no">:b</span><span class="w"> </span><span class="p">[</span><span class="no">:c</span><span class="w"> </span><span class="p">[</span><span class="no">:d</span><span class="p">]]]</span><span class="w"> </span><span class="p">(</span><span class="nf">zip/node</span><span class="w"> </span><span class="n">loc-b</span><span class="p">))))</span><span class="w">
</span></code></pre></div></div>

<p>In the example above, first we find the <code class="language-plaintext highlighter-rouge">:d</code> location. From there, we go up
until we meet <code class="language-plaintext highlighter-rouge">[:b [:c [:d]]]</code>. If there is no such a location, the result will
be nil.</p>

<h3 id="also-see">Also See</h3>

<p>The code from this library was used for <a href="/en/clojure-zippers/">Clojure Zippers manual</a>
– the complete guide to zippers in Clojure from the very scratch.</p>

<p>© 2022 Ivan Grishaev</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/deformation/">Деформация</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2022-08-27T00:00:00+00:00">
        Aug 27, 2022
    </time>

    <a href="/tag/life/" rel="tag">life</a>, <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/telegram/" rel="tag">telegram</a>

</div>


            <div class="entry">
                
                    <p>Последний месяц я вожусь с ботами для Телеграма. Занятная вещь, и как-нибудь расскажу об этом подробней. А пока что мелкое наблюдение.</p>

<p>Чтобы отсечь спамеров, мой бот выводит задачу уровня <code class="language-plaintext highlighter-rouge">3 + 5</code> и кнопки с ответами. Кнопок шесть: одна правильная, остальные неправильные. Писать текст нельзя, только жать на кнопку. Если ответил верно, ограничения снимаются. После трех ошибок бан.</p>

<p>Код для генерации кнопок я писал впопыхах. Коротко, он такой: взять пять случайных чисел, добавить к ним ответ, перемешать. Но не учел, что в случайных числах может выпасть ответ, из-за чего будет две правильные кнопки. Это случается редко, но все же. Вот один из случаев:</p>

<p><img src="/assets/static/aws/2buttons/1.jpeg" /></p>

<p>Так вот, наблюдение: когда айтишник видит два правильных ответа, у него рвется шаблон. Начинаются фразочки OMG какой ответ правильный!! и прочая истерика. Тут у меня происходит двоемыслие.</p>

<p>С одной стороны, что значит “какой ответ правильный”? Если задача <code class="language-plaintext highlighter-rouge">3 + 5</code> и две кнопки 8, обе из них правильные. Не бывает двух разных цифр 8 — она одна. Поэтому вместо истерики надо жать ту кнопку, которая по душе — ближе, дальше, круглее, — главное, чтобы на ней была восьмерка.</p>

<p>С другой стороны, айтишников легко понять. Мы привыкли, что за текстом на кнопке стоит айдишник, который уходит на сервер, и все рассчитывается по айдишнику. Вполне возможно, у первой кнопки “8” айди <code class="language-plaintext highlighter-rouge">btn_4</code>, а у второй — <code class="language-plaintext highlighter-rouge">btn_9</code>. И не докажешь, что не верблюд.</p>

<p><img src="/assets/static/aws/2buttons/2.jpg" /></p>

<p>Помню, меня страшно бесили тесты по английскому на компе. Нужно было перетащить слова в прочерки, при этом глагол is часто встречался дважды. И хотя я все расставлял правильно, получал ошибку. Оказалось, у каждого слова свой айдишник, а в базе данных задана их последовательность. Имеем два is с номерами 2 и 5. Не так расставил — ошибка.</p>

<p>В итоге скрипт, написанный на коленке, разошелся по школам, сайтам, университетам. Где только я с ним не сталкивался! Даже недавно, во время ковидного дурдома, сын делал английский онлайн, и там была та же проблема.</p>

<p>Происходит деформация: даже если на двух кнопках написано одно и то же, мы не верим. Мы ищем подвох, потому что слишком часто были обмануты. В результате две кнопки 8 кажутся такой же ошибкой, как 3 + 5 = 9.</p>

<p>Сюда же следует отнести штучки JavaScript вроде <code class="language-plaintext highlighter-rouge">[1, 2, 3] == [1, 2, 3]</code>. Только что проверил в консоли — вернет ложь. На JavaScript работают миллионы сайтов и устройств, а конца этому не видно. Весь этот бред так и тянется от стандарта к стандарту.</p>

<p>В результате разработчик настолько привык к граблям технологий, что всячески оправдывает их косяки и ищет злой умысел там, где его нет. Так быть не должно.</p>

<p>Подобно тому, как нужно не курить, не бухать и заниматься спортом, нужно работать с правильными технологиями. Такими, где массив <code class="language-plaintext highlighter-rouge">[1, 2, 3]</code> все-таки равен другому такому же массиву; где нет пяти функций сравнения; где код вернет то, что ожидаешь, а не то, что прописано на сотой странице стандарта. И деформации в голове станет меньше.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/clj-repl-part-2/">REPL, Cider, Emacs (часть 2/4)</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2022-08-20T00:00:00+00:00">
        Aug 20, 2022
    </time>

    <a href="/tag/clojure/" rel="tag">clojure</a>, <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/repl/" rel="tag">repl</a>, <a href="/tag/emacs/" rel="tag">emacs</a>, <a href="/tag/cider/" rel="tag">cider</a>

</div>


            <div class="entry">
                
                    
<h2>Все части</h2>

<ul>
  <li><a href="/clj-repl-part-1/">Первая часть</a></li>
  <li><a href="/clj-repl-part-2/">Вторая часть</a></li>
  <li><a href="/clj-repl-part-3/">Третья часть</a></li>
  <li><a href="/clj-repl-part-4/">Четвертая часть</a></li>
</ul>

<h2>

    Оглавление

</h2>

<ul id="toc-item-clojure-repl-toc">
  <li><a href="#repl-в-редакторе" id="toc-item-clojure-repl-toc-repl-в-редакторе">REPL в редакторе</a>    <ul>
      <li><a href="#недостатки" id="toc-item-clojure-repl-toc-недостатки">Недостатки</a></li>
    </ul>
  </li>
  <li><a href="#знакомство-с-nrepl" id="toc-item-clojure-repl-toc-знакомство-с-nrepl">Знакомство с nREPL</a>    <ul>
      <li><a href="#запуск-nrepl" id="toc-item-clojure-repl-toc-запуск-nrepl">Запуск nREPL</a></li>
      <li><a href="#внутреннее-устройство" id="toc-item-clojure-repl-toc-внутреннее-устройство">Внутреннее устройство</a></li>
      <li><a href="#транспорт" id="toc-item-clojure-repl-toc-транспорт">Транспорт</a></li>
      <li><a href="#middleware" id="toc-item-clojure-repl-toc-middleware">Middleware</a></li>
    </ul>
  </li>
  <li><a href="#подключение-из-clojure" id="toc-item-clojure-repl-toc-подключение-из-clojure">Подключение из Clojure</a>    <ul>
      <li><a href="#коротко-о-bencode" id="toc-item-clojure-repl-toc-коротко-о-bencode">Коротко о Bencode</a></li>
    </ul>
  </li>
  <li><a href="#клиенты-nrepl-для-редакторов" id="toc-item-clojure-repl-toc-клиенты-nrepl-для-редакторов">Клиенты nREPL для редакторов</a></li>
  <li><a href="#emacs-и-cider" id="toc-item-clojure-repl-toc-emacs-и-cider">Emacs и Cider</a>    <ul>
      <li><a href="#первые-шаги" id="toc-item-clojure-repl-toc-первые-шаги">Первые шаги</a></li>
      <li><a href="#выполнение-кода" id="toc-item-clojure-repl-toc-выполнение-кода">Выполнение кода</a></li>
      <li><a href="#dev-секции" id="toc-item-clojure-repl-toc-dev-секции">Dev-секции</a></li>
      <li><a href="#сниппеты" id="toc-item-clojure-repl-toc-сниппеты">Сниппеты</a></li>
    </ul>
  </li>
</ul>

<h2 id="repl-в-редакторе">REPL в редакторе</h2>

<p>До сих пор мы набирали код в терминале, что не совсем удобно. Терминал подходит для коротких команд, но плохо справляется с многострочным вводом. Будет правильно набрать код в редакторе, а затем скопировать в терминал. Код останется в файле, и не придется печатать его в следующий раз.</p>

<p>Со временем вы заметите, что переключение между редактором и терминалом отнимает время. Было бы здорово связать редактор с REPL напрямую. Вы набираете код и с помощью комбинации клавиш выполняете в REPL. В отдельной области редактор показывает результат. С таким подходом нам доступна мощь обеих сред: REPL и редактора.</p>


                    <p><a href="/clj-repl-part-2/">Read more &rarr;</a></p>
                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/web-files/">Веб-файлы</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2022-08-16T00:00:00+00:00">
        Aug 16, 2022
    </time>

    <a href="/tag/ui/" rel="tag">ui</a>, <a href="/tag/dropbox/" rel="tag">dropbox</a>

</div>


            <div class="entry">
                
                    <p>Каждый раз, когда вижу файловый интерфейс в вебе, думаю: почему такой пиздец? Я не люблю материться и делаю это редко. Но когда вижу браузерные поделки, хочется закрыть глаза от отчаяния.</p>

<p>Вот скриншоты с официального сайта Дропбокса. Первая картинка:</p>

<p><img src="/assets/static/aws/web-files/1.jpg" /></p>

<p>Что мы видим? Всюду адская разреженность. Изображение с отступами, сверху и справа два жирных бара. Иконки в барах мелкие и висят в воздухе. Дикая несогласованность элементов: сперва кнопка с надписью, кнопка с многоточием, заголовок, синяя кнопка со стрелкой вниз.</p>

<p>Что делает заголовок среди кнопок? Там не поместится ничего длиннее пары слов. Почему кнопка Share синяя, в чем ее особый статус? Почему выпадашка слева отмечена многоточием, а у Share стрелка вниз?</p>

<p>Зачем колокольчик в окне просмотра файла? Это события, связанные с этим файлом или любые события? Зачем сайдбар справа? Нельзя было уместить жалкие три кнопки наверху?</p>

<p>Другая картинка:</p>

<p><img src="/assets/static/aws/web-files/2.png" /></p>

<p>То же самое: адская разреженность. На месте трех файлов было легко уместить пятнадцать без потери смысла и качества.</p>

<p>Наверху значок лупы, но поля ввода нет. Полагаю, оно появится по клику на лупу. Зачем кликать, если можно сразу нарисовать поле?</p>

<p>Зачем земной шар? Открыть какую-то ссылку? Если да, то какую, и зачем мне туда переходить? Почему бы не разместить гиперссылку с текстом, например, “на сайт”?</p>

<p>Полоса с текстом “Syncing” срезает столько места, что хватило бы на пару файлов.</p>

<p>Третья картинка, но там уже нечего комментировать: сочетание косяков в разных пропорциях.</p>

<p><img src="/assets/static/aws/web-files/3.jpg" /></p>

<p>А вот картинка, открытая в Preview на маке:</p>

<p><img src="/assets/static/aws/web-files/4.jpg" /></p>

<ul>
  <li>заголовок отдельно от кнопок. Влезет даже предложение.</li>
  <li>изображение занимает максимальную площадь</li>
  <li>виджет поиска отрисован с полем ввода</li>
  <li>все иконки одинаковы и пригнаны друг к другу</li>
  <li>по желанию в тулбар можно загнать другие иконки и поменять их местами</li>
  <li>можно сменить показ иконок: только картинка, только текст или вместе.</li>
</ul>

<p>Дело даже не в маке: если взять Total Commander или виндовый Explorer, там то же самое: информация показана компактно и удобно. Могут быть придирки к конкретной программе: скажем, Explorer в режиме значков такой себе, но со списком можно жить. Это уже дело вкуса. Важно, что всем файловым менеджерам свойственна компактность и гибкость в настройках.</p>

<p><img src="/assets/static/aws/web-files/5.png" /></p>

<p>А с вебом беда. Мамкины дизайнеры каждый день видят нормальный интерфейс, но рисуют в Фигме говно. Хотя ничего придумывать не надо: повтори Finder или Explorer, и люди скажут спасибо. Но нет: дизайнер дизайнерит.</p>

<p>Беда не только у Дропбокса. Гугл, Слак и другие тяжеловесы не могут показать файлы в браузере. Каждый раз выходит ужас: растрата места, жирные бары, несогласованные кнопки — тут многоточие, там выпадашка. Иконки либо мелкие, либо гротескно жирные, словно в азбуке для малышей. Ни у одной иконки нет подписи, нужно наводить курсор или жать наудачу.</p>

<p>Невозможно. Считаю, в целях воспитания нужно отобрать у дизайнеров родной файловый менеджер и выдать то, что они производят. Тогда дело быстро пойдет на лад.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/clj-repl-part-1/">REPL, Cider, Emacs (часть 1/4)</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2022-08-09T00:00:00+00:00">
        Aug 9, 2022
    </time>

    <a href="/tag/clojure/" rel="tag">clojure</a>, <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/repl/" rel="tag">repl</a>, <a href="/tag/emacs/" rel="tag">emacs</a>, <a href="/tag/cider/" rel="tag">cider</a>

</div>


            <div class="entry">
                
                    
<h2>Все части</h2>

<ul>
  <li><a href="/clj-repl-part-1/">Первая часть</a></li>
  <li><a href="/clj-repl-part-2/">Вторая часть</a></li>
  <li><a href="/clj-repl-part-3/">Третья часть</a></li>
  <li><a href="/clj-repl-part-4/">Четвертая часть</a></li>
</ul>

<h2>

    Оглавление

</h2>

<ul id="toc-item-clojure-repl-toc">
  <li><a href="#исторический-экскурс" id="toc-item-clojure-repl-toc-исторический-экскурс">Исторический экскурс</a></li>
  <li><a href="#пробуем-repl" id="toc-item-clojure-repl-toc-пробуем-repl">Пробуем REPL</a></li>
  <li><a href="#более-сложный-сценарий" id="toc-item-clojure-repl-toc-более-сложный-сценарий">Более сложный сценарий</a></li>
  <li><a href="#свой-repl" id="toc-item-clojure-repl-toc-свой-repl">Свой REPL</a>    <ul>
      <li><a href="#улучшения" id="toc-item-clojure-repl-toc-улучшения">Улучшения</a>        <ul>
          <li><a href="#выход-из-цикла" id="toc-item-clojure-repl-toc-выход-из-цикла">Выход из цикла</a></li>
          <li><a href="#перехват-исключений" id="toc-item-clojure-repl-toc-перехват-исключений">Перехват исключений</a></li>
          <li><a href="#обработчик-исключения" id="toc-item-clojure-repl-toc-обработчик-исключения">Обработчик исключения</a></li>
          <li><a href="#красивая-печать" id="toc-item-clojure-repl-toc-красивая-печать">Красивая печать</a></li>
          <li><a href="#приглашение" id="toc-item-clojure-repl-toc-приглашение">Приглашение</a></li>
          <li><a href="#переменная-результата" id="toc-item-clojure-repl-toc-переменная-результата">Переменная результата</a></li>
          <li><a href="#многострочный-ввод" id="toc-item-clojure-repl-toc-многострочный-ввод">Многострочный ввод</a></li>
        </ul>
      </li>
      <li><a href="#repl-в-repl" id="toc-item-clojure-repl-toc-repl-в-repl">REPL в REPL</a></li>
      <li><a href="#доступ-к-локальным-переменным" id="toc-item-clojure-repl-toc-доступ-к-локальным-переменным">Доступ к локальным переменным</a></li>
    </ul>
  </li>
  <li><a href="#полезные-функции-repl" id="toc-item-clojure-repl-toc-полезные-функции-repl">Полезные функции REPL</a></li>
</ul>

<p><em>Эта глава расскажет о REPL — фундаментальном свойстве Clojure. Так называют интерактивную работу с языком, когда программу наращивают постепенно. Мы рассмотрим, что такое REPL-driven development и почему, однажды познав, от него трудно отказаться.</em></p>

<p>Аббревиатура REPL происходит от четырех слов: Read, Eval, Print и Loop. Дословно они означают прочитать, выполнить, напечатать и повторить. REPL — устойчивый термин, под которым понимают интерактивный режим программы.</p>

<p>Многие современные языки предлагают интерактивный режим. Как правило, он запускается, если вызвать интерпретатор без параметров. Например, команды <code class="language-plaintext highlighter-rouge">python</code> или <code class="language-plaintext highlighter-rouge">node</code> запустят интерактивные сеансы Python и Node.js. В Ruby для этого служит утилита <code class="language-plaintext highlighter-rouge">irb</code> (где i означает interactive). REPL поддерживают не только интерпретаторы, но и языки, которые компилируются в байт-код (Java, Scala) или машинный код (Haskell, SBCL).</p>

<p>Несмотря на это разнообразие, именно в Лисп-системах REPL имеет решающее значение. Если в Python или Node.js его рассматривают как приятное дополнение, то в Лиспе он необходим. Разработка на любом Лиспе зависит от того, насколько хорошо вы взаимодействуете с REPL. На REPL так или иначе опираются все инструменты и практики, документация, видеоуроки и так далее.</p>

<p>В мире Лиспа ходит понятие REPL-driven development. Это стиль разработки, когда код пишут малыми порциями и запускают в REPL. С таким подходом сразу видно поведение программы. Легче проверить неочевидные случаи, например вызвать функцию с <code class="language-plaintext highlighter-rouge">nil</code> или обратиться к ресурсу, которого не существует.</p>

<p>Другой полезный сценарий для REPL — извлечь данные из сети и исследовать их. Эта задача идеально ложиться на интерактивный режим. Как правило, HTTP-запрос предполагает несколько этапов: его подготовку, отправку, чтение тела и поиск нужных полей. Эти шаги проходят интерактивно методом проб и ошибок. Позже мы рассмотрим пример HTTP-запроса в сеансе REPL.</p>


                    <p><a href="/clj-repl-part-1/">Read more &rarr;</a></p>
                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/en/teleward/">Teleward: a CAPTCHA bot for Telegram in Clojure + GraalVM</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2022-07-18T00:00:00+00:00">
        Jul 18, 2022
    </time>

    <a href="/tag/clojure/" rel="tag">clojure</a>, <a href="/tag/programming/" rel="tag">programming</a>

</div>


            <div class="entry">
                
                    
<p><em>(This is a copy of the readme file from the repository.)</em></p>

<p><a href="https://github.com/igrishaev/teleward">Teleward</a> is a Telegram captcha bot written in Clojure and compiled
with GraalVM native image. Runs on bare Linux/MacOS with no requirements. Fast
and robust.</p>

<h3 id="why">Why</h3>

<p>Telegram chats suffer from spammers who are pretty smart nowadays. They don’t
use bots; instead, they register ordinary accounts and automate them with
Selenium + web-version of Telegram. Personally, I found Shieldy and other bots
useless when dealing with such kind of spammers. This project aims the goal to
finish that mess.</p>

<p>Another reason I opened Teleward for is to try my skills in developing Clojure
applications with GraalVM. Binary applications are nice: they are fast, and they
don’t need installing JDK. At the same time, they’re are still Clojure: REPL is
here, and that’s amazing.</p>

<h3 id="features">Features</h3>

<ul>
  <li>This is Clojure, so you have REPL! During development, you call Telegram API
directly from REPL and see what’s going on.</li>
  <li>The bot can be delivered either as a Jar file or a binary file (with Graal).</li>
  <li>When Graal-compiled, needs no requirements (Java SDK, etc). The binary size is
about 30 Mb.</li>
  <li>At the moment, supports only long polling strategy to obtain messages. The
webhook is to be done soon.</li>
  <li>Keeps all the state in memory and thus doesn’t need any kind of a
database. The only exception is the current offset value which is tracked in a
file.</li>
  <li>Supports English and Russian languages.</li>
  <li>Two captcha styles: normal “1 + 2” and Lisp captcha “(+ 1 2)”.</li>
  <li>The <code class="language-plaintext highlighter-rouge">+</code>, <code class="language-plaintext highlighter-rouge">-</code>, and <code class="language-plaintext highlighter-rouge">*</code> operators are corresponding Unicode characters that
prevent captcha from naive evaluation.</li>
</ul>

<h3 id="algorithm">Algorithm</h3>

<p>The bot listens for all the messages in a group. Once a new pack of messages
arrives, the bot applies the following procedure to each message:</p>

<ul>
  <li>Mark new members as locked.</li>
  <li>Send a captcha message to all members.</li>
  <li>Unless an author of a message is locked, delete that message.</li>
  <li>If a message is short and matches the captcha’s solution, unlock a user and
delete the catpcha message.</li>
  <li>If a locked user has posted three messages with no solution, ban them.</li>
  <li>If a locked user hasn’t solved captcha in time, ban them as well.</li>
</ul>

<p><em>Please note:</em> the bot processes only messages no older than two minutes from
now. In other words, the bot is interested in what is happening now (with a
slight delay), but not in the far past. This is to prevent a sutuation what a
bot had been inactive and then has started to consume messages. Without this
condition, it will send captcha to chat members who have already joined and
confuse them.</p>

<h3 id="java-version">Java version</h3>

<p>To make a Jar artefact, run:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>make uberjar
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">uberjar</code> target calls <code class="language-plaintext highlighter-rouge">lein uberjar</code> and also injects the <code class="language-plaintext highlighter-rouge">VERSION</code> file
into it. The output file is <code class="language-plaintext highlighter-rouge">./target/teleward.jar</code>.</p>

<h3 id="binary-version-linux">Binary version, Linux</h3>

<p>Linux version is built inside a Docker image, namely the
<code class="language-plaintext highlighter-rouge">ghcr.io/graalvm/graalvm-ce</code> one with <code class="language-plaintext highlighter-rouge">native-image</code> extension preinstalled. Run
the following command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>make docker-build
</code></pre></div></div>

<p>The output binary file appears at <code class="language-plaintext highlighter-rouge">./target/teleward</code>.</p>

<h3 id="binary-version-macos">Binary version, MacOS</h3>

<ul>
  <li>
    <p><a href="https://www.graalvm.org/docs/getting-started/">Install GraalVM</a> locally.</p>
  </li>
  <li>
    <p>Install the “native image” extension:</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gu <span class="nb">install </span>native-image
</code></pre></div></div>

<ul>
  <li>Then <code class="language-plaintext highlighter-rouge">make</code> the project:</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>make
</code></pre></div></div>

<h3 id="setting-up-your-bot">Setting Up Your Bot</h3>

<ul>
  <li>
    <p>To run the bot, first you need a token. Contact <code class="language-plaintext highlighter-rouge">@BotFather</code> in Telegram to
create a new bot. Copy the token and don’t share it.</p>
  </li>
  <li>
    <p>Add your new bot into a Telegram group. Promote it to admins. At least the bot
must be able to 1) send messages, 2) delete messages, and 3) ban users.</p>
  </li>
  <li>
    <p>Run the bot locally:</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>teleward <span class="nt">-t</span> &lt;telegram-token&gt; <span class="nt">-l</span> debug
</code></pre></div></div>

<p>If everything is fine, the bot will start consuming messages and print them in
console.</p>

<h3 id="configuration">Configuration</h3>

<p>See the version with <code class="language-plaintext highlighter-rouge">-v</code>, and help with <code class="language-plaintext highlighter-rouge">-h</code>. The bot takes into account plenty
of settings, yet not all of them are available for configuration for now. Below,
we name the most important parameters you will need.</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">-t, --telegram.token</code>: the Telegram token you obtain from
BotFather. Required, can be set via an env variable <code class="language-plaintext highlighter-rouge">TELEGRAM_TOKEN</code>.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">-l, --logging.level</code>: the logging level. Can be <code class="language-plaintext highlighter-rouge">debug, info, error</code>. Default
is <code class="language-plaintext highlighter-rouge">info</code>. In production, most likely you will set <code class="language-plaintext highlighter-rouge">error</code>.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">--telegram.offset-file</code>: where to store offset number for the next
<code class="language-plaintext highlighter-rouge">getUpdates</code> call. Default is <code class="language-plaintext highlighter-rouge">TELEGRAM_OFFSET</code> in the current working
directory.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">--lang</code>: the language for messages. Can be <code class="language-plaintext highlighter-rouge">en, ru</code>, default is <code class="language-plaintext highlighter-rouge">ru</code>.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">--captcha.style</code>: a type of captcha. When <code class="language-plaintext highlighter-rouge">lisp</code>, the captcha looks like a
lisp expression <code class="language-plaintext highlighter-rouge">(+ 4 3)</code>. Any other value type will produce <code class="language-plaintext highlighter-rouge">4 + 3</code>. The
operator is taken randomly.</p>
  </li>
</ul>

<p>Example:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./target/teleward <span class="nt">-t</span> &lt;...&gt; <span class="nt">-l</span> debug <span class="se">\</span>
  <span class="nt">--lang</span><span class="o">=</span>en <span class="nt">--telegram</span>.offset-file<span class="o">=</span>mybot.offset <span class="se">\</span>
  <span class="nt">--captcha</span>.style<span class="o">=</span>normal
</code></pre></div></div>

<p>For the rest of the config, see the <code class="language-plaintext highlighter-rouge">src/teleward/config.clj</code> file.</p>

<h3 id="deploying-on-bare-ubuntu">Deploying on bare Ubuntu</h3>

<ul>
  <li>
    <p>Buy the cheapest VPS machine and SSH to it.</p>
  </li>
  <li>
    <p>Create a user:</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>useradd <span class="nt">-s</span> /bin/bash <span class="nt">-d</span> /home/ivan/ <span class="nt">-m</span> <span class="nt">-G</span> <span class="nb">sudo </span>ivan
<span class="nb">sudo </span>passwd ivan
<span class="nb">mkdir</span> /home/ivan/teleward
</code></pre></div></div>

<ul>
  <li>Compile the file locally and copy it to the machine:</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>scp ./target/teleward ivan@hostname:/home/ivan/teleward/
</code></pre></div></div>

<ul>
  <li>Create a new <code class="language-plaintext highlighter-rouge">systemctl</code> service:</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>mcedit /etc/systemd/system/teleward.service
</code></pre></div></div>

<ul>
  <li>Paste the following config:</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[Unit]
Description = Teleward bot
After = network.target

[Service]
Type = simple
Restart = always
RestartSec = 1
User = ivan
WorkingDirectory = /home/ivan/teleward/
ExecStart = /home/ivan/teleward/teleward -l debug
Environment = TELEGRAM_TOKEN=xxxxxxxxxxxxxx

[Install]
WantedBy = multi-user.target
</code></pre></div></div>

<ul>
  <li>Enable autoload:</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>systemctl <span class="nb">enable </span>teleward
</code></pre></div></div>

<ul>
  <li>Manage the service with commands:</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>systemctl stop teleward
<span class="nb">sudo </span>systemctl start teleward
<span class="nb">sudo </span>systemctl status teleward
</code></pre></div></div>

<p>For Jar, the config file would be almost the same except the <code class="language-plaintext highlighter-rouge">ExecStart</code>
section. There, you specify something like <code class="language-plaintext highlighter-rouge">java -jar teleward.jar ...</code>.</p>

<h3 id="health-check">Health check</h3>

<p>The bot accepts the <code class="language-plaintext highlighter-rouge">/health</code> command which it replies to “OK”.</p>

<h3 id="further-work">Further work</h3>

<ul>
  <li>Implement webhook.</li>
  <li>Add tests.</li>
  <li>Report uptime for <code class="language-plaintext highlighter-rouge">/health</code>.</li>
  <li>More config parameters via CLI args.</li>
  <li>Widnows build.</li>
</ul>

<p>© 2022 Ivan Grishaev</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/failed-podcast/">Невышедший подкаст про Лисп. Работа над ошибками</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2022-07-09T00:00:00+00:00">
        Jul 9, 2022
    </time>

    <a href="/tag/life/" rel="tag">life</a>, <a href="/tag/podcast/" rel="tag">podcast</a>, <a href="/tag/fail/" rel="tag">fail</a>

</div>


            <div class="entry">
                
                    <p><em>История о том, как я участвовал в подкасте про Лисп и Кложу, который не вышел в свет. Это ни в коем случае не обвинения любой из сторон, а попытка понять, что пошло не так. Кроме того, я вынес кое-какие уроки, чтобы подобное не повторилось в будущем.</em></p>

<p>Три месяца назад мне постучались одни Крутые Ребята с предложением выступить в подкасте. Тема — Лисп и Кложа. Назначили дату и время, записали подкаст. Еще до записи кое-что показалось мне странными, но я утешал себя тем, что ребята Крутые и знают, что делают. Поэтому оставил на их усмотрение.</p>

<p>Итак, записали, обменялись любезностями, супер-супер, огонь-огонь. Проходит месяц, другой. Ребята выпускают эпизоды, но моего среди них нет. Я спокойно жду, потому что знаю: у опытных подкастеров эпизоды расписаны на месяц. Кроме того, интересный материал иногда оставляют “в консервах”, то есть на случай, когда ничего интересного нет.</p>

<p>В какой-то момент не стерпел и вежливо спросил, как дела с выпуском. Оба собеседника получили сообщение и… тишина. Проходит семь часов, я аккуратно повторяю вопрос. Наконец отвечают: выпуска не будет. Слово за словом выясняется, что ведущий им недоволен, получилось очень сложно, слушатели не поймут.</p>

<p>Что ж, не будет и бог с ним, бывает. Но удивляюсь, почему нельзя было сказать об этом раньше вместо того, чтобы прятаться? Ведь Ребята такие Крутые: открытые, позитивные, вот это все. Но как только пошло не так, началась тишина.</p>

<p>Безо всяких претензий пишу им: понимаю, не в обиде. Можно выложу у себя в блоге? Для этого нужна дорожка ведущего: во время записи у меня осталась только моя дорожка. Сведу и смонтирую сам. Отвечают: нужно согласие Главного Человека, сейчас спросим его и ответим. Я аж поморщился от этой лжи, потому что у тех, с кем я разговаривал, было достаточно полномочий для принятия решения. Они всем управляют, и вдруг оказывается, нужно спросить. Стоит ли говорить, что через месяц мне никто не ответил.</p>

<p>По итогам событий я сделал следующие выводы.</p>

<p>(1) Перед выступлением нужно изучить аудиторию, понять ее уровень. Уже после согласия я понял, что это популярный подкаст по принципу “все обо всем”. Рассказывать такой аудитории про Кложу и Лисп трудно. Это специфичные технологии, и слушатель должен знать азы программирования. Если этого нет, рассказ про Лисп не принесет удовольствия ни одной из сторон, что и подтвердилось. Во время записи ведущий часто перебивал меня с просьбой объяснить тот или иной момент. Я, напротив, был недоволен, что мы топчемся на месте. К концу второго часа мы наконец выяснили, что код на Лиспе состоит из списков, и в нем есть REPL и макросы. Это десятая часть того, что я мог бы рассказать про Лисп подготовленной аудитории.</p>

<p>(2) Стороны должны согласовать тезисы. Когда я <a href="/podlodka/">выступал в Подлодке</a>, ведущий потребовал с меня тезисы и прислал образец с прошлого выпуска. Это в высшей степени правильно, потому что делает выпуск согласованным: гость и ведущий на одной волне. В случае с Крутыми Ребятами тезисы не понадобились: ведущий сказал, что подготовится сам. Позже он “ради интереса” попросил выслать тезисы для Подлодки, что я и сделал. Однако ни один тезис мы не обсудили.</p>

<p>(3) Если что-то идет не так, надо честно признаться и сказать правду, не дожидаясь разборок. Меня расстроило не то, что эпизод не вышел, а отношение по принципу “молчим, авось отъебется”. Не надо так, потому что со страниц блогов и проектов вы Крутые, и вдруг такое. Реально расстраиваешься.</p>

<p>(4) В то же время, это урок мне. Вдруг я тоже произвожу хорошее впечатление в блоге, а на деле сливаюсь? Не обидел ли я кого нибудь таким же образом? Пишу одно, делаю другое? Есть над чем подумать.</p>

<p>В завершение текста покажу одно видео. Выступает Илья Синельников, тема “Провал — это хорошо”. Одно из немногих видео, которое я <a href="/no-media/">однажды посмотрел</a> и тепло вспоминаю. Если коротко — важно не то, как вы ведете себя, когда все хорошо. Истинно важно — когда дела идут не по плану; тут и проявляется самое важное. Полчаса удовольствия:</p>

<iframe width="885" height="498" src="https://www.youtube.com/embed/PUG7wi4l9to" title="Илья Синельников. Провал — это хорошо" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe>

                
            </div>

        </li>
        
    </ul>

    <h4>
        
        <a href="/page2" class="previous">&larr;</a>
        
        <span class="page_number ">Страница 3 из 60</span>
        
        <a href="/page4" class="next">&rarr;</a>
        
    </h4>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Ivan Grishaev's blog</li>
          <li><a href="mailto:ivan@grishaev.me">ivan@grishaev.me</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
            <li><a href="https://github.com/igrishaev">GitHub</a></li>
            <li><a href="tg://resolve?domain=igrishaev_blog">Telegram</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Writing on programming, education, books and negotiations.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
