<!DOCTYPE html>
<html lang="ru">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Ivan Grishaev's blog</title>
  <meta name="description" content="Writing on programming, education, books and negotiations.
">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/custom.css">
  <link rel="canonical" href="https://grishaev.me/page3/">
  <link rel="alternate" type="application/rss+xml" title="Ivan Grishaev's blog" href="https://grishaev.me/feed.xml">

  <link rel="shortcut icon" type="image/x-icon" href="/assets/static/favicons/favicon.ico">

  <script type="text/javascript" src="/assets/typo.js"></script>

</head>


  <body>
    <header class="site-header">

    <div class="wrapper flex-container">

        <div>
            <a href="/">
                <img src="/assets/static/photo-round-small.png" alt="Ivan Grishaev">
            </a>
        </div>

        <div class="flex-container-vert" style="margin-left: 15px; width: 80%">

            <div class="flex-container full-width">
                <p style="margin-bottom: 5px">Ivan Grishaev's blog</p>
                <div class="flex-huge"></div>
                <div >
<form id="search-form"
      target="_blank"
      style="display: inline"
      method="get"
      action="https://www.google.com/search">

    <input name="sitesearch"
           value="grishaev.me"
           type="hidden">

    <input type="text"
           required="required"
           name="q"
           placeholder="Google search..."
           autocomplete="off">

    <button style="border: none; background-color: transparent; cursor: pointer;"
            type="submit">&#x1f50d;</button>

</form>
</div>
            </div>

            <p><small>Writing on programming, education, books and negotiations.
</small></p>

            <div class="flex-container">
                <a class="menu-item" href="/">Home</a>
                <a class="menu-item" href="/about/">About</a>
                <a class="menu-item" href="/bookshelf/">Bookshelf</a>
                <a class="menu-item" href="/feed.xml">RSS</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor" href="/tag/clojure/">Clojure</a>
                <a class="menu-item minor" href="/tag/emacs/">Emacs</a>
                <a class="menu-item minor" href="/tag/python/">Python</a>
                <a class="menu-item minor" href="/tag/programming/">Programming</a>
                <a class="menu-item minor" href="/interview/">Interview</a>
                <a class="menu-item minor" href="/video/">Video</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor hl" href="/clojure-in-prod/">Книга «Clojure на производстве»</a>
            </div>

        </div>
    </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="home">

    <ul class="post-list">
        
        <li>

            <h2>
                <a class="post-link" href="/clj-repl-part-2/">REPL, Cider, Emacs (часть 2/4)</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2022-08-20T00:00:00+00:00">
        Aug 20, 2022
    </time>

    <a href="/tag/clojure/" rel="tag">clojure</a>, <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/repl/" rel="tag">repl</a>, <a href="/tag/emacs/" rel="tag">emacs</a>, <a href="/tag/cider/" rel="tag">cider</a>

</div>


            <div class="entry">
                
                    
<h2>Все части</h2>

<ul>
  <li><a href="/clj-repl-part-1/">Первая часть</a></li>
  <li><a href="/clj-repl-part-2/">Вторая часть</a></li>
  <li><a href="/clj-repl-part-3/">Третья часть</a></li>
  <li><a href="/clj-repl-part-4/">Четвертая часть</a></li>
</ul>

<h2>

    Оглавление

</h2>

<ul id="toc-item-clojure-repl-toc">
  <li><a href="#repl-в-редакторе" id="toc-item-clojure-repl-toc-repl-в-редакторе">REPL в редакторе</a>    <ul>
      <li><a href="#недостатки" id="toc-item-clojure-repl-toc-недостатки">Недостатки</a></li>
    </ul>
  </li>
  <li><a href="#знакомство-с-nrepl" id="toc-item-clojure-repl-toc-знакомство-с-nrepl">Знакомство с nREPL</a>    <ul>
      <li><a href="#запуск-nrepl" id="toc-item-clojure-repl-toc-запуск-nrepl">Запуск nREPL</a></li>
      <li><a href="#внутреннее-устройство" id="toc-item-clojure-repl-toc-внутреннее-устройство">Внутреннее устройство</a></li>
      <li><a href="#транспорт" id="toc-item-clojure-repl-toc-транспорт">Транспорт</a></li>
      <li><a href="#middleware" id="toc-item-clojure-repl-toc-middleware">Middleware</a></li>
    </ul>
  </li>
  <li><a href="#подключение-из-clojure" id="toc-item-clojure-repl-toc-подключение-из-clojure">Подключение из Clojure</a>    <ul>
      <li><a href="#коротко-о-bencode" id="toc-item-clojure-repl-toc-коротко-о-bencode">Коротко о Bencode</a></li>
    </ul>
  </li>
  <li><a href="#клиенты-nrepl-для-редакторов" id="toc-item-clojure-repl-toc-клиенты-nrepl-для-редакторов">Клиенты nREPL для редакторов</a></li>
  <li><a href="#emacs-и-cider" id="toc-item-clojure-repl-toc-emacs-и-cider">Emacs и Cider</a>    <ul>
      <li><a href="#первые-шаги" id="toc-item-clojure-repl-toc-первые-шаги">Первые шаги</a></li>
      <li><a href="#выполнение-кода" id="toc-item-clojure-repl-toc-выполнение-кода">Выполнение кода</a></li>
      <li><a href="#dev-секции" id="toc-item-clojure-repl-toc-dev-секции">Dev-секции</a></li>
      <li><a href="#сниппеты" id="toc-item-clojure-repl-toc-сниппеты">Сниппеты</a></li>
    </ul>
  </li>
</ul>

<h2 id="repl-в-редакторе">REPL в редакторе</h2>

<p>До сих пор мы набирали код в терминале, что не совсем удобно. Терминал подходит для коротких команд, но плохо справляется с многострочным вводом. Будет правильно набрать код в редакторе, а затем скопировать в терминал. Код останется в файле, и не придется печатать его в следующий раз.</p>

<p>Со временем вы заметите, что переключение между редактором и терминалом отнимает время. Было бы здорово связать редактор с REPL напрямую. Вы набираете код и с помощью комбинации клавиш выполняете в REPL. В отдельной области редактор показывает результат. С таким подходом нам доступна мощь обеих сред: REPL и редактора.</p>


                    <p><a href="/clj-repl-part-2/">Read more &rarr;</a></p>
                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/web-files/">Веб-файлы</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2022-08-16T00:00:00+00:00">
        Aug 16, 2022
    </time>

    <a href="/tag/ui/" rel="tag">ui</a>, <a href="/tag/dropbox/" rel="tag">dropbox</a>

</div>


            <div class="entry">
                
                    <p>Каждый раз, когда вижу файловый интерфейс в вебе, думаю: почему такой пиздец? Я не люблю материться и делаю это редко. Но когда вижу браузерные поделки, хочется закрыть глаза от отчаяния.</p>

<p>Вот скриншоты с официального сайта Дропбокса. Первая картинка:</p>

<p><img src="/assets/static/aws/web-files/1.jpg" /></p>

<p>Что мы видим? Всюду адская разреженность. Изображение с отступами, сверху и справа два жирных бара. Иконки в барах мелкие и висят в воздухе. Дикая несогласованность элементов: сперва кнопка с надписью, кнопка с многоточием, заголовок, синяя кнопка со стрелкой вниз.</p>

<p>Что делает заголовок среди кнопок? Там не поместится ничего длиннее пары слов. Почему кнопка Share синяя, в чем ее особый статус? Почему выпадашка слева отмечена многоточием, а у Share стрелка вниз?</p>

<p>Зачем колокольчик в окне просмотра файла? Это события, связанные с этим файлом или любые события? Зачем сайдбар справа? Нельзя было уместить жалкие три кнопки наверху?</p>

<p>Другая картинка:</p>

<p><img src="/assets/static/aws/web-files/2.png" /></p>

<p>То же самое: адская разреженность. На месте трех файлов было легко уместить пятнадцать без потери смысла и качества.</p>

<p>Наверху значок лупы, но поля ввода нет. Полагаю, оно появится по клику на лупу. Зачем кликать, если можно сразу нарисовать поле?</p>

<p>Зачем земной шар? Открыть какую-то ссылку? Если да, то какую, и зачем мне туда переходить? Почему бы не разместить гиперссылку с текстом, например, “на сайт”?</p>

<p>Полоса с текстом “Syncing” срезает столько места, что хватило бы на пару файлов.</p>

<p>Третья картинка, но там уже нечего комментировать: сочетание косяков в разных пропорциях.</p>

<p><img src="/assets/static/aws/web-files/3.jpg" /></p>

<p>А вот картинка, открытая в Preview на маке:</p>

<p><img src="/assets/static/aws/web-files/4.jpg" /></p>

<ul>
  <li>заголовок отдельно от кнопок. Влезет даже предложение.</li>
  <li>изображение занимает максимальную площадь</li>
  <li>виджет поиска отрисован с полем ввода</li>
  <li>все иконки одинаковы и пригнаны друг к другу</li>
  <li>по желанию в тулбар можно загнать другие иконки и поменять их местами</li>
  <li>можно сменить показ иконок: только картинка, только текст или вместе.</li>
</ul>

<p>Дело даже не в маке: если взять Total Commander или виндовый Explorer, там то же самое: информация показана компактно и удобно. Могут быть придирки к конкретной программе: скажем, Explorer в режиме значков такой себе, но со списком можно жить. Это уже дело вкуса. Важно, что всем файловым менеджерам свойственна компактность и гибкость в настройках.</p>

<p><img src="/assets/static/aws/web-files/5.png" /></p>

<p>А с вебом беда. Мамкины дизайнеры каждый день видят нормальный интерфейс, но рисуют в Фигме говно. Хотя ничего придумывать не надо: повтори Finder или Explorer, и люди скажут спасибо. Но нет: дизайнер дизайнерит.</p>

<p>Беда не только у Дропбокса. Гугл, Слак и другие тяжеловесы не могут показать файлы в браузере. Каждый раз выходит ужас: растрата места, жирные бары, несогласованные кнопки — тут многоточие, там выпадашка. Иконки либо мелкие, либо гротескно жирные, словно в азбуке для малышей. Ни у одной иконки нет подписи, нужно наводить курсор или жать наудачу.</p>

<p>Невозможно. Считаю, в целях воспитания нужно отобрать у дизайнеров родной файловый менеджер и выдать то, что они производят. Тогда дело быстро пойдет на лад.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/clj-repl-part-1/">REPL, Cider, Emacs (часть 1/4)</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2022-08-09T00:00:00+00:00">
        Aug 9, 2022
    </time>

    <a href="/tag/clojure/" rel="tag">clojure</a>, <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/repl/" rel="tag">repl</a>, <a href="/tag/emacs/" rel="tag">emacs</a>, <a href="/tag/cider/" rel="tag">cider</a>

</div>


            <div class="entry">
                
                    
<h2>Все части</h2>

<ul>
  <li><a href="/clj-repl-part-1/">Первая часть</a></li>
  <li><a href="/clj-repl-part-2/">Вторая часть</a></li>
  <li><a href="/clj-repl-part-3/">Третья часть</a></li>
  <li><a href="/clj-repl-part-4/">Четвертая часть</a></li>
</ul>

<h2>

    Оглавление

</h2>

<ul id="toc-item-clojure-repl-toc">
  <li><a href="#исторический-экскурс" id="toc-item-clojure-repl-toc-исторический-экскурс">Исторический экскурс</a></li>
  <li><a href="#пробуем-repl" id="toc-item-clojure-repl-toc-пробуем-repl">Пробуем REPL</a></li>
  <li><a href="#более-сложный-сценарий" id="toc-item-clojure-repl-toc-более-сложный-сценарий">Более сложный сценарий</a></li>
  <li><a href="#свой-repl" id="toc-item-clojure-repl-toc-свой-repl">Свой REPL</a>    <ul>
      <li><a href="#улучшения" id="toc-item-clojure-repl-toc-улучшения">Улучшения</a>        <ul>
          <li><a href="#выход-из-цикла" id="toc-item-clojure-repl-toc-выход-из-цикла">Выход из цикла</a></li>
          <li><a href="#перехват-исключений" id="toc-item-clojure-repl-toc-перехват-исключений">Перехват исключений</a></li>
          <li><a href="#обработчик-исключения" id="toc-item-clojure-repl-toc-обработчик-исключения">Обработчик исключения</a></li>
          <li><a href="#красивая-печать" id="toc-item-clojure-repl-toc-красивая-печать">Красивая печать</a></li>
          <li><a href="#приглашение" id="toc-item-clojure-repl-toc-приглашение">Приглашение</a></li>
          <li><a href="#переменная-результата" id="toc-item-clojure-repl-toc-переменная-результата">Переменная результата</a></li>
          <li><a href="#многострочный-ввод" id="toc-item-clojure-repl-toc-многострочный-ввод">Многострочный ввод</a></li>
        </ul>
      </li>
      <li><a href="#repl-в-repl" id="toc-item-clojure-repl-toc-repl-в-repl">REPL в REPL</a></li>
      <li><a href="#доступ-к-локальным-переменным" id="toc-item-clojure-repl-toc-доступ-к-локальным-переменным">Доступ к локальным переменным</a></li>
    </ul>
  </li>
  <li><a href="#полезные-функции-repl" id="toc-item-clojure-repl-toc-полезные-функции-repl">Полезные функции REPL</a></li>
</ul>

<p><em>Эта глава расскажет о REPL — фундаментальном свойстве Clojure. Так называют интерактивную работу с языком, когда программу наращивают постепенно. Мы рассмотрим, что такое REPL-driven development и почему, однажды познав, от него трудно отказаться.</em></p>

<p>Аббревиатура REPL происходит от четырех слов: Read, Eval, Print и Loop. Дословно они означают прочитать, выполнить, напечатать и повторить. REPL — устойчивый термин, под которым понимают интерактивный режим программы.</p>

<p>Многие современные языки предлагают интерактивный режим. Как правило, он запускается, если вызвать интерпретатор без параметров. Например, команды <code class="language-plaintext highlighter-rouge">python</code> или <code class="language-plaintext highlighter-rouge">node</code> запустят интерактивные сеансы Python и Node.js. В Ruby для этого служит утилита <code class="language-plaintext highlighter-rouge">irb</code> (где i означает interactive). REPL поддерживают не только интерпретаторы, но и языки, которые компилируются в байт-код (Java, Scala) или машинный код (Haskell, SBCL).</p>

<p>Несмотря на это разнообразие, именно в Лисп-системах REPL имеет решающее значение. Если в Python или Node.js его рассматривают как приятное дополнение, то в Лиспе он необходим. Разработка на любом Лиспе зависит от того, насколько хорошо вы взаимодействуете с REPL. На REPL так или иначе опираются все инструменты и практики, документация, видеоуроки и так далее.</p>

<p>В мире Лиспа ходит понятие REPL-driven development. Это стиль разработки, когда код пишут малыми порциями и запускают в REPL. С таким подходом сразу видно поведение программы. Легче проверить неочевидные случаи, например вызвать функцию с <code class="language-plaintext highlighter-rouge">nil</code> или обратиться к ресурсу, которого не существует.</p>

<p>Другой полезный сценарий для REPL — извлечь данные из сети и исследовать их. Эта задача идеально ложиться на интерактивный режим. Как правило, HTTP-запрос предполагает несколько этапов: его подготовку, отправку, чтение тела и поиск нужных полей. Эти шаги проходят интерактивно методом проб и ошибок. Позже мы рассмотрим пример HTTP-запроса в сеансе REPL.</p>


                    <p><a href="/clj-repl-part-1/">Read more &rarr;</a></p>
                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/en/teleward/">Teleward: a CAPTCHA bot for Telegram in Clojure + GraalVM</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2022-07-18T00:00:00+00:00">
        Jul 18, 2022
    </time>

    <a href="/tag/clojure/" rel="tag">clojure</a>, <a href="/tag/programming/" rel="tag">programming</a>

</div>


            <div class="entry">
                
                    
<p><em>(This is a copy of the readme file from the repository.)</em></p>

<p><a href="https://github.com/igrishaev/teleward">Teleward</a> is a Telegram captcha bot written in Clojure and compiled
with GraalVM native image. Runs on bare Linux/MacOS with no requirements. Fast
and robust.</p>

<h3 id="why">Why</h3>

<p>Telegram chats suffer from spammers who are pretty smart nowadays. They don’t
use bots; instead, they register ordinary accounts and automate them with
Selenium + web-version of Telegram. Personally, I found Shieldy and other bots
useless when dealing with such kind of spammers. This project aims the goal to
finish that mess.</p>

<p>Another reason I opened Teleward for is to try my skills in developing Clojure
applications with GraalVM. Binary applications are nice: they are fast, and they
don’t need installing JDK. At the same time, they’re are still Clojure: REPL is
here, and that’s amazing.</p>

<h3 id="features">Features</h3>

<ul>
  <li>This is Clojure, so you have REPL! During development, you call Telegram API
directly from REPL and see what’s going on.</li>
  <li>The bot can be delivered either as a Jar file or a binary file (with Graal).</li>
  <li>When Graal-compiled, needs no requirements (Java SDK, etc). The binary size is
about 30 Mb.</li>
  <li>At the moment, supports only long polling strategy to obtain messages. The
webhook is to be done soon.</li>
  <li>Keeps all the state in memory and thus doesn’t need any kind of a
database. The only exception is the current offset value which is tracked in a
file.</li>
  <li>Supports English and Russian languages.</li>
  <li>Two captcha styles: normal “1 + 2” and Lisp captcha “(+ 1 2)”.</li>
  <li>The <code class="language-plaintext highlighter-rouge">+</code>, <code class="language-plaintext highlighter-rouge">-</code>, and <code class="language-plaintext highlighter-rouge">*</code> operators are corresponding Unicode characters that
prevent captcha from naive evaluation.</li>
</ul>

<h3 id="algorithm">Algorithm</h3>

<p>The bot listens for all the messages in a group. Once a new pack of messages
arrives, the bot applies the following procedure to each message:</p>

<ul>
  <li>Mark new members as locked.</li>
  <li>Send a captcha message to all members.</li>
  <li>Unless an author of a message is locked, delete that message.</li>
  <li>If a message is short and matches the captcha’s solution, unlock a user and
delete the catpcha message.</li>
  <li>If a locked user has posted three messages with no solution, ban them.</li>
  <li>If a locked user hasn’t solved captcha in time, ban them as well.</li>
</ul>

<p><em>Please note:</em> the bot processes only messages no older than two minutes from
now. In other words, the bot is interested in what is happening now (with a
slight delay), but not in the far past. This is to prevent a sutuation what a
bot had been inactive and then has started to consume messages. Without this
condition, it will send captcha to chat members who have already joined and
confuse them.</p>

<h3 id="java-version">Java version</h3>

<p>To make a Jar artefact, run:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>make uberjar
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">uberjar</code> target calls <code class="language-plaintext highlighter-rouge">lein uberjar</code> and also injects the <code class="language-plaintext highlighter-rouge">VERSION</code> file
into it. The output file is <code class="language-plaintext highlighter-rouge">./target/teleward.jar</code>.</p>

<h3 id="binary-version-linux">Binary version, Linux</h3>

<p>Linux version is built inside a Docker image, namely the
<code class="language-plaintext highlighter-rouge">ghcr.io/graalvm/graalvm-ce</code> one with <code class="language-plaintext highlighter-rouge">native-image</code> extension preinstalled. Run
the following command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>make docker-build
</code></pre></div></div>

<p>The output binary file appears at <code class="language-plaintext highlighter-rouge">./target/teleward</code>.</p>

<h3 id="binary-version-macos">Binary version, MacOS</h3>

<ul>
  <li>
    <p><a href="https://www.graalvm.org/docs/getting-started/">Install GraalVM</a> locally.</p>
  </li>
  <li>
    <p>Install the “native image” extension:</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gu <span class="nb">install </span>native-image
</code></pre></div></div>

<ul>
  <li>Then <code class="language-plaintext highlighter-rouge">make</code> the project:</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>make
</code></pre></div></div>

<h3 id="setting-up-your-bot">Setting Up Your Bot</h3>

<ul>
  <li>
    <p>To run the bot, first you need a token. Contact <code class="language-plaintext highlighter-rouge">@BotFather</code> in Telegram to
create a new bot. Copy the token and don’t share it.</p>
  </li>
  <li>
    <p>Add your new bot into a Telegram group. Promote it to admins. At least the bot
must be able to 1) send messages, 2) delete messages, and 3) ban users.</p>
  </li>
  <li>
    <p>Run the bot locally:</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>teleward <span class="nt">-t</span> &lt;telegram-token&gt; <span class="nt">-l</span> debug
</code></pre></div></div>

<p>If everything is fine, the bot will start consuming messages and print them in
console.</p>

<h3 id="configuration">Configuration</h3>

<p>See the version with <code class="language-plaintext highlighter-rouge">-v</code>, and help with <code class="language-plaintext highlighter-rouge">-h</code>. The bot takes into account plenty
of settings, yet not all of them are available for configuration for now. Below,
we name the most important parameters you will need.</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">-t, --telegram.token</code>: the Telegram token you obtain from
BotFather. Required, can be set via an env variable <code class="language-plaintext highlighter-rouge">TELEGRAM_TOKEN</code>.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">-l, --logging.level</code>: the logging level. Can be <code class="language-plaintext highlighter-rouge">debug, info, error</code>. Default
is <code class="language-plaintext highlighter-rouge">info</code>. In production, most likely you will set <code class="language-plaintext highlighter-rouge">error</code>.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">--telegram.offset-file</code>: where to store offset number for the next
<code class="language-plaintext highlighter-rouge">getUpdates</code> call. Default is <code class="language-plaintext highlighter-rouge">TELEGRAM_OFFSET</code> in the current working
directory.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">--lang</code>: the language for messages. Can be <code class="language-plaintext highlighter-rouge">en, ru</code>, default is <code class="language-plaintext highlighter-rouge">ru</code>.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">--captcha.style</code>: a type of captcha. When <code class="language-plaintext highlighter-rouge">lisp</code>, the captcha looks like a
lisp expression <code class="language-plaintext highlighter-rouge">(+ 4 3)</code>. Any other value type will produce <code class="language-plaintext highlighter-rouge">4 + 3</code>. The
operator is taken randomly.</p>
  </li>
</ul>

<p>Example:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./target/teleward <span class="nt">-t</span> &lt;...&gt; <span class="nt">-l</span> debug <span class="se">\</span>
  <span class="nt">--lang</span><span class="o">=</span>en <span class="nt">--telegram</span>.offset-file<span class="o">=</span>mybot.offset <span class="se">\</span>
  <span class="nt">--captcha</span>.style<span class="o">=</span>normal
</code></pre></div></div>

<p>For the rest of the config, see the <code class="language-plaintext highlighter-rouge">src/teleward/config.clj</code> file.</p>

<h3 id="deploying-on-bare-ubuntu">Deploying on bare Ubuntu</h3>

<ul>
  <li>
    <p>Buy the cheapest VPS machine and SSH to it.</p>
  </li>
  <li>
    <p>Create a user:</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>useradd <span class="nt">-s</span> /bin/bash <span class="nt">-d</span> /home/ivan/ <span class="nt">-m</span> <span class="nt">-G</span> <span class="nb">sudo </span>ivan
<span class="nb">sudo </span>passwd ivan
<span class="nb">mkdir</span> /home/ivan/teleward
</code></pre></div></div>

<ul>
  <li>Compile the file locally and copy it to the machine:</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>scp ./target/teleward ivan@hostname:/home/ivan/teleward/
</code></pre></div></div>

<ul>
  <li>Create a new <code class="language-plaintext highlighter-rouge">systemctl</code> service:</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>mcedit /etc/systemd/system/teleward.service
</code></pre></div></div>

<ul>
  <li>Paste the following config:</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[Unit]
Description = Teleward bot
After = network.target

[Service]
Type = simple
Restart = always
RestartSec = 1
User = ivan
WorkingDirectory = /home/ivan/teleward/
ExecStart = /home/ivan/teleward/teleward -l debug
Environment = TELEGRAM_TOKEN=xxxxxxxxxxxxxx

[Install]
WantedBy = multi-user.target
</code></pre></div></div>

<ul>
  <li>Enable autoload:</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>systemctl <span class="nb">enable </span>teleward
</code></pre></div></div>

<ul>
  <li>Manage the service with commands:</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>systemctl stop teleward
<span class="nb">sudo </span>systemctl start teleward
<span class="nb">sudo </span>systemctl status teleward
</code></pre></div></div>

<p>For Jar, the config file would be almost the same except the <code class="language-plaintext highlighter-rouge">ExecStart</code>
section. There, you specify something like <code class="language-plaintext highlighter-rouge">java -jar teleward.jar ...</code>.</p>

<h3 id="health-check">Health check</h3>

<p>The bot accepts the <code class="language-plaintext highlighter-rouge">/health</code> command which it replies to “OK”.</p>

<h3 id="further-work">Further work</h3>

<ul>
  <li>Implement webhook.</li>
  <li>Add tests.</li>
  <li>Report uptime for <code class="language-plaintext highlighter-rouge">/health</code>.</li>
  <li>More config parameters via CLI args.</li>
  <li>Widnows build.</li>
</ul>

<p>© 2022 Ivan Grishaev</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/failed-podcast/">Невышедший подкаст про Лисп. Работа над ошибками</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2022-07-09T00:00:00+00:00">
        Jul 9, 2022
    </time>

    <a href="/tag/life/" rel="tag">life</a>, <a href="/tag/podcast/" rel="tag">podcast</a>, <a href="/tag/fail/" rel="tag">fail</a>

</div>


            <div class="entry">
                
                    <p><em>История о том, как я участвовал в подкасте про Лисп и Кложу, который не вышел в свет. Это ни в коем случае не обвинения любой из сторон, а попытка понять, что пошло не так. Кроме того, я вынес кое-какие уроки, чтобы подобное не повторилось в будущем.</em></p>

<p>Три месяца назад мне постучались одни Крутые Ребята с предложением выступить в подкасте. Тема — Лисп и Кложа. Назначили дату и время, записали подкаст. Еще до записи кое-что показалось мне странными, но я утешал себя тем, что ребята Крутые и знают, что делают. Поэтому оставил на их усмотрение.</p>

<p>Итак, записали, обменялись любезностями, супер-супер, огонь-огонь. Проходит месяц, другой. Ребята выпускают эпизоды, но моего среди них нет. Я спокойно жду, потому что знаю: у опытных подкастеров эпизоды расписаны на месяц. Кроме того, интересный материал иногда оставляют “в консервах”, то есть на случай, когда ничего интересного нет.</p>

<p>В какой-то момент не стерпел и вежливо спросил, как дела с выпуском. Оба собеседника получили сообщение и… тишина. Проходит семь часов, я аккуратно повторяю вопрос. Наконец отвечают: выпуска не будет. Слово за словом выясняется, что ведущий им недоволен, получилось очень сложно, слушатели не поймут.</p>

<p>Что ж, не будет и бог с ним, бывает. Но удивляюсь, почему нельзя было сказать об этом раньше вместо того, чтобы прятаться? Ведь Ребята такие Крутые: открытые, позитивные, вот это все. Но как только пошло не так, началась тишина.</p>

<p>Безо всяких претензий пишу им: понимаю, не в обиде. Можно выложу у себя в блоге? Для этого нужна дорожка ведущего: во время записи у меня осталась только моя дорожка. Сведу и смонтирую сам. Отвечают: нужно согласие Главного Человека, сейчас спросим его и ответим. Я аж поморщился от этой лжи, потому что у тех, с кем я разговаривал, было достаточно полномочий для принятия решения. Они всем управляют, и вдруг оказывается, нужно спросить. Стоит ли говорить, что через месяц мне никто не ответил.</p>

<p>По итогам событий я сделал следующие выводы.</p>

<p>(1) Перед выступлением нужно изучить аудиторию, понять ее уровень. Уже после согласия я понял, что это популярный подкаст по принципу “все обо всем”. Рассказывать такой аудитории про Кложу и Лисп трудно. Это специфичные технологии, и слушатель должен знать азы программирования. Если этого нет, рассказ про Лисп не принесет удовольствия ни одной из сторон, что и подтвердилось. Во время записи ведущий часто перебивал меня с просьбой объяснить тот или иной момент. Я, напротив, был недоволен, что мы топчемся на месте. К концу второго часа мы наконец выяснили, что код на Лиспе состоит из списков, и в нем есть REPL и макросы. Это десятая часть того, что я мог бы рассказать про Лисп подготовленной аудитории.</p>

<p>(2) Стороны должны согласовать тезисы. Когда я <a href="/podlodka/">выступал в Подлодке</a>, ведущий потребовал с меня тезисы и прислал образец с прошлого выпуска. Это в высшей степени правильно, потому что делает выпуск согласованным: гость и ведущий на одной волне. В случае с Крутыми Ребятами тезисы не понадобились: ведущий сказал, что подготовится сам. Позже он “ради интереса” попросил выслать тезисы для Подлодки, что я и сделал. Однако ни один тезис мы не обсудили.</p>

<p>(3) Если что-то идет не так, надо честно признаться и сказать правду, не дожидаясь разборок. Меня расстроило не то, что эпизод не вышел, а отношение по принципу “молчим, авось отъебется”. Не надо так, потому что со страниц блогов и проектов вы Крутые, и вдруг такое. Реально расстраиваешься.</p>

<p>(4) В то же время, это урок мне. Вдруг я тоже произвожу хорошее впечатление в блоге, а на деле сливаюсь? Не обидел ли я кого нибудь таким же образом? Пишу одно, делаю другое? Есть над чем подумать.</p>

<p>В завершение текста покажу одно видео. Выступает Илья Синельников, тема “Провал — это хорошо”. Одно из немногих видео, которое я <a href="/no-media/">однажды посмотрел</a> и тепло вспоминаю. Если коротко — важно не то, как вы ведете себя, когда все хорошо. Истинно важно — когда дела идут не по плану; тут и проявляется самое важное. Полчаса удовольствия:</p>

<iframe width="885" height="498" src="https://www.youtube.com/embed/PUG7wi4l9to" title="Илья Синельников. Провал — это хорошо" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/service-failed/">Сервис не смог</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2022-07-05T00:00:00+00:00">
        Jul 5, 2022
    </time>

    <a href="/tag/services/" rel="tag">services</a>, <a href="/tag/amazon/" rel="tag">amazon</a>, <a href="/tag/leanpub/" rel="tag">leanpub</a>, <a href="/tag/gumroad/" rel="tag">gumroad</a>, <a href="/tag/paypal/" rel="tag">paypal</a>

</div>


            <div class="entry">
                
                    <p>Иные сервисы уведомляют о всякой ерунде — новом дизайне, посте в блоге или просто какой-то дичи — и забывают о важных вещах. Например, проблемах с платежами и авторизацией. Вот три примера из практики.</p>

<p>До известных событий (которые в России нельзя назвать коротким словом) сервис Gumroad регулярно переводил деньги за книгу на Paypal. Как только Палка отвалилась, пропали и выплаты. Однако Gumroad не прислал ни одного письма об этом.</p>

<p>Как программист я понимаю: вызов к PayPal обернут в try/catch, ошибка падает в лог. Ладно, а что потом? Получили сотни ошибок, кто будет с ними разбираться?</p>

<p>По-хорошему надо так: делать задачу на выплату, повторять ее с интервалом в час, день, неделю. Если не вышло — слать пользователю письмо, а не молчать, словно ничего не происходит.</p>

<p>То же самое с Leanpub. У меня там короткая книжка на английском, и раз-два в месяц ее покупают. Выплаты прекратились, все молчком, никаких уведомлений. Неужели так трудно отправить письмо?</p>

<p>Наконец, Амазон. Какое-то время назад я жаловался, что не могу зайти в аккаунт. Думал, что блокирует Амазон, но все оказалось проще. Когда-то давно, подключая двухфакторную авторизацию, я поленился открыть Google Authenticator и выбрал вариант с смс — зря!</p>

<p>Оказалось, сервис, который отправляет смс, теперь не делает этого для российских номеров. Без понятния, как это происходит: возвращает ли он статус 403? Или отдает 200, чтобы молча выкинуть мое смс? И кто виноват? Я, потому что живу в России? Амазон, потому что сервис не работает, а к нему обращаются? Сервис, потому что не смог?</p>

<p>Кто кого должен уведомлять? Амазон меня, потому что дело происходит на странице Амазона? Или смс-сервис уведомляет Амазон, потому что первый не смог? Все сломано: смс не доходит, Амазон об этом не знает, сервис не считает нужным доложить. Скорей всего, записали в лог и забыли.</p>

<p>Как вы поняли, так быть не должно. Клиенту все равно, какие сервисы вызывает ваш сервис. Чей домен открыт в браузере, тот и уведомляет. Во всех случаях письма должны были прислать Gumroad, Leanpub и Amazon — то, что я вижу и с чем работаю. Не нужно переводить стрелки на сторонний сервис, который не смог. В данном случае не смогли упомянутые фирмы.</p>

<p>Все это я переживу, а вот взять на заметку стоит.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/en/clj-format">Use format rather than str</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2022-07-02T00:00:00+00:00">
        Jul 2, 2022
    </time>

    <a href="/tag/clojure/" rel="tag">clojure</a>, <a href="/tag/strings/" rel="tag">strings</a>, <a href="/tag/format/" rel="tag">format</a>

</div>


            <div class="entry">
                
                    <p>I’d like to share a Clojure trick I’ve been using for years. It’s simple, it makes your code safer; I always highlight it when making reviews. The trick is: don’t use the <code class="language-plaintext highlighter-rouge">str</code> function to concatenate strings. Instead, use <code class="language-plaintext highlighter-rouge">format</code>. A couple of examples:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">username</span><span class="w"> </span><span class="s">"Ivan"</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nb">str</span><span class="w"> </span><span class="s">"The user `"</span><span class="w"> </span><span class="n">username</span><span class="w"> </span><span class="s">"` has been created."</span><span class="p">))</span><span class="w">
</span><span class="c1">;; "The user `Ivan` has been created."</span><span class="w">


</span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">user-id</span><span class="w"> </span><span class="mi">5234</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nb">str</span><span class="w"> </span><span class="s">"/files/uploads/"</span><span class="w"> </span><span class="n">user-id</span><span class="p">))</span><span class="w">
</span><span class="c1">;; "/files/uploads/5234"</span><span class="w">
</span></code></pre></div></div>

<p><strong>The first point</strong> in favour of this approach is, <code class="language-plaintext highlighter-rouge">str</code> turns nil into an empty string. Thus, when printing the final message, that’s unclear if a variable was an empty string or <code class="language-plaintext highlighter-rouge">nil</code>:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">username</span><span class="w"> </span><span class="n">nil</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nb">str</span><span class="w"> </span><span class="s">"The user `"</span><span class="w"> </span><span class="n">username</span><span class="w"> </span><span class="s">"` has been created."</span><span class="p">))</span><span class="w">
</span><span class="c1">;; "The user `` has been created."</span><span class="w">
</span></code></pre></div></div>

<p>The difference between these two is important. Say, an empty string means broken validation; a title of a book, a name of a person must not be blank. But if I got nil, most likey I missed the key in a map because of a namespace:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">user</span><span class="w">
  </span><span class="p">{</span><span class="no">:acme.user/id</span><span class="w"> </span><span class="mi">5234</span><span class="w">
   </span><span class="no">:acme.user/name</span><span class="w"> </span><span class="s">"Ivan"</span><span class="p">})</span><span class="w">

</span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">username</span><span class="w"> </span><span class="p">(</span><span class="nb">get</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="no">:id</span><span class="p">)]</span><span class="w">
  </span><span class="n">...</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>or the keyword/string case:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">user</span><span class="w">
  </span><span class="p">(</span><span class="nf">parse-json</span><span class="w"> </span><span class="s">"user.json"</span><span class="p">))</span><span class="w">
</span><span class="c1">;; {"id" 5234 "name" "Ivan"}</span><span class="w">

</span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">username</span><span class="w"> </span><span class="p">(</span><span class="nb">get</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="no">:name</span><span class="p">)]</span><span class="w">
  </span><span class="n">...</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>Now compare it to the <code class="language-plaintext highlighter-rouge">format</code> function. The <code class="language-plaintext highlighter-rouge">nil</code> value becomes <code class="language-plaintext highlighter-rouge">"null"</code> when passed to <code class="language-plaintext highlighter-rouge">format</code>:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">username</span><span class="w"> </span><span class="n">nil</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nf">format</span><span class="w"> </span><span class="s">"The user `%s` has been created."</span><span class="w"> </span><span class="n">username</span><span class="p">))</span><span class="w">
</span><span class="c1">;; "The user `null` has been created."</span><span class="w">

</span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">user-id</span><span class="w"> </span><span class="n">nil</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nf">format</span><span class="w"> </span><span class="s">"/files/uploads/%s"</span><span class="w"> </span><span class="n">user-id</span><span class="p">))</span><span class="w">
</span><span class="c1">;; "/files/uploads/null"</span><span class="w">
</span></code></pre></div></div>

<p>If I had my way, I would produce not <code class="language-plaintext highlighter-rouge">"null"</code> but <code class="language-plaintext highlighter-rouge">"nil"</code> string from <code class="language-plaintext highlighter-rouge">nil</code>, but that’s not so important.</p>

<p><strong>The second point</strong> is much more serious. <code class="language-plaintext highlighter-rouge">Nil</code> values are extremely dangerous when building file paths or URLs. Imagine you’re about to delete files of a person who’s terminating their account. Most likely you store files on disk like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>files/&lt;user-id&gt;/avatars/...
files/&lt;user-id&gt;/attachments/...
files/&lt;user-id&gt;/uploads/...
</code></pre></div></div>

<p>Then you have a function that accepts the <code class="language-plaintext highlighter-rouge">user-id</code> parameter, then builds the right path and does recursive deletion:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">drop-user-files</span><span class="w"> </span><span class="p">[</span><span class="n">user-id</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="nb">path</span><span class="w">
        </span><span class="p">(</span><span class="nb">str</span><span class="w"> </span><span class="s">"files/"</span><span class="w"> </span><span class="n">user-id</span><span class="p">)]</span><span class="w">
    </span><span class="p">(</span><span class="nf">rm-rf-recur</span><span class="w"> </span><span class="nb">path</span><span class="p">)))</span><span class="w">
</span></code></pre></div></div>

<p>If you pass <code class="language-plaintext highlighter-rouge">nil</code> for <code class="language-plaintext highlighter-rouge">user-id</code>, the path will be <code class="language-plaintext highlighter-rouge">"files/"</code>. Running that code will erase all the files of all users which would be a disaster. But if you have used format, the path would have been <code class="language-plaintext highlighter-rouge">"files/null"</code>, which would just have thrown an exception saying there is no such a directory.</p>

<p>One may say: add an assert clause for user-id right before you build a path. Like this:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">drop-user-files</span><span class="w"> </span><span class="p">[</span><span class="n">user-id</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nb">assert</span><span class="w"> </span><span class="n">user-id</span><span class="w"> </span><span class="s">"User-id is empty!"</span><span class="p">)</span><span class="w">
  </span><span class="n">...</span><span class="p">)</span><span class="w">

</span><span class="c1">;; or</span><span class="w">

</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">drop-user-files</span><span class="w"> </span><span class="p">[</span><span class="n">user-id</span><span class="p">]</span><span class="w">
  </span><span class="p">{</span><span class="no">:pre</span><span class="w"> </span><span class="p">[</span><span class="n">user-id</span><span class="p">]}</span><span class="w">
  </span><span class="n">...</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>In practice, you easily forget doing this and recall when the data is lost. I don’t see any reason for skipping that minor fix — change <code class="language-plaintext highlighter-rouge">str</code> to <code class="language-plaintext highlighter-rouge">format</code> — to reduce chances of a disaster.</p>

<p>The same applies to S3 URLs. Although it’s a web-service, we all treat it as a file system. Composing S3 URLs reminds me of ordinary file paths. Again, if you’re about to drop user’s directory with uploads, be aware of the the same thing: <code class="language-plaintext highlighter-rouge">str</code> + <code class="language-plaintext highlighter-rouge">nil</code> for <code class="language-plaintext highlighter-rouge">user-id</code> produce a broken path:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">drop-s3-user-files</span><span class="w"> </span><span class="p">[</span><span class="n">s3-client</span><span class="w"> </span><span class="n">user-id</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="nb">path</span><span class="w">
        </span><span class="p">(</span><span class="nb">str</span><span class="w"> </span><span class="s">"files/"</span><span class="w"> </span><span class="n">user-id</span><span class="p">)]</span><span class="w">
    </span><span class="p">(</span><span class="nf">s3.client/delete-files</span><span class="w"> </span><span class="n">s3-client</span><span class="w"> </span><span class="nb">path</span><span class="p">)))</span><span class="w">
</span></code></pre></div></div>

<p>If you pass <code class="language-plaintext highlighter-rouge">nil</code> into a function that recursively drops S3 files, the data is all gone.</p>

<p>Of course, such an issue can be held with special Java classes like <code class="language-plaintext highlighter-rouge">Path</code> or <code class="language-plaintext highlighter-rouge">URI</code>. But in fact, in Clojure we use them quite rarely. Most often we just concatenate plain strings as it’s enough for the task. It’s simpler and takes less code.</p>

<p>I recommend using <code class="language-plaintext highlighter-rouge">str</code> for one purpose only — to coerce a non-string value to a string. For example:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nb">str</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="c1">;; =&gt; "5"</span><span class="w">
</span><span class="p">(</span><span class="nb">str</span><span class="w"> </span><span class="p">(</span><span class="nf">random-uuid</span><span class="p">))</span><span class="w"> </span><span class="c1">;; =&gt; "154ac...b2642"</span><span class="w">
</span></code></pre></div></div>

<p>Briefly, it’s safe when the <code class="language-plaintext highlighter-rouge">str</code> function accepts strictly one argument. When there are more than one, I feel worried.</p>

<p>I always keep in mind a real story about a guy who owned a small hosting company. He released the <code class="language-plaintext highlighter-rouge">rm -rf $FOO/$BAR</code> command among the whole park. Too sad for him, both of the env vars were unset, nor special bash flags terminating a script were set as well. The command turned into <code class="language-plaintext highlighter-rouge">rm -rf /</code> with known consequences. A couple of missing vars has ruined one’s business. By <code class="language-plaintext highlighter-rouge">str</code>-ing strings, especially when building file paths, you may easily mess up the same way (but I wish you won’t).</p>

<p>Let’s recap:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">str</code> turns <code class="language-plaintext highlighter-rouge">nil</code> into an empty string;</li>
  <li>by reading such a message, you never know if a value was an empty string or nil;</li>
  <li>the difference between these two <strong>does</strong> matter;</li>
  <li>with that behaviour, it’s easy to build a weird file/S3 path and lost the data;</li>
  <li>instead, <code class="language-plaintext highlighter-rouge">format</code> turns <code class="language-plaintext highlighter-rouge">nil</code> into <code class="language-plaintext highlighter-rouge">"null"</code>. This is much better than emptiness and solves the troubles mentioned above;</li>
  <li>use <code class="language-plaintext highlighter-rouge">str</code> only to coerce a value to a string.</li>
</ul>

<p>Safe coding!</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/dobrofile/">Книга на Доброфайле</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2022-06-23T00:00:00+00:00">
        Jun 23, 2022
    </time>

    <a href="/tag/book/" rel="tag">book</a>

</div>


            <div class="entry">
                
                    
<p>Сервис <a href="https://gum.co/clojure-in-prod">Gumroad</a>, где продается электронная версия книги, ожидаемо перестал работать с российскими картами (а также остановил выплаты). Поэтому выкладываю книжку на российской площадке “Доброфайл”:</p>

<p><a href="https://dobrofile.ru/?s=c2f86cd04">https://dobrofile.ru/?s=c2f86cd04</a></p>

<p>Все просто: переходите по ссылке, жмете “купить файл”. Никакой авторизации: ввели емейл и оплатили картой. На почту падает ссылка, которая действует 48 часов. Только что купил сам — работает.</p>

<p>Сервис довольно забавный: простой как лопата, весь такой спартанский. После тормозного, обвешанного скриптами Gumroad воспринимается как глоток воздуха. Админка товара открывается секунду — так можно было?</p>

<p>В общем, покупайте книжку на Доброфайле. В ближайшее время обновлю страницу проекта, публикацию на Хабре и другие места.</p>

<p>Напомню, что книжку, как печатную, так и электронную, всегда можно купить напрямую у меня. Напишите в личку, и я скину архив или вышлю почтой России в любую страну.</p>

<p>А еще я почти закончил черновик второй части, но об этом в следующий раз.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/mail-rules/">Правила пользования почтой</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2022-06-13T00:00:00+00:00">
        Jun 13, 2022
    </time>

    <a href="/tag/work/" rel="tag">work</a>, <a href="/tag/life/" rel="tag">life</a>, <a href="/tag/email/" rel="tag">email</a>

</div>


            <div class="entry">
                
                    <p>Начинающие программисты спрашивают, какую технологию учить: Питон, Джаву и прочее. Отвечая на эти вопросы, часто забываешь об электронной почте. Закрываю упущение: учитесь электронной почте! Это не так просто: вокруг почты сложился особый этикет, о котором не расскажут в онлайн-курсах. Вы должны знать его перед тем, как начнете искать работу.</p>

<p>Прежде всего: в деловой переписке почта важнее мессаджеров. Если есть несколько способов связаться с человеком, сначала пишите на почту. В мессаджер можно писать только по взаимному согласию или если нет других контактов.</p>

<p>Раздражает, когда в личку врывается незнакомый человек и вываливает стену текста. Или, наоборот, пишет сто сообщений словосочетаниями. Если у вас долгий разговор, представьтесь в мессаджере и попросите почту, чтобы написать туда развернутый текст.</p>

<p>В отправителе не должно быть ников вроде “nagibator666” или LenuSiK. Плохо, когда имя сгенерировано по шаблону “фамилия.годрождения”, например <code class="language-plaintext highlighter-rouge">semenova.81@mail.ru</code>. В отправителе должны быть имя и фамилия, желательно на том языке, на котором говорит получатель, скажем, Ivan Grishaev. Имя не должно быть двояким: вместо Alex пишите Alexey или Alexander.</p>

<p>Самое важное правило: <strong>при ответе не цитируйте все письмо</strong>. Прямо сейчас, не читая этот текст до конца, откройте почтовый клиент и поставьте нужную настройку. На маке это последний чекбокс на закладке Composing. Называется он странно, но работает как надо: при ответе будет процитирован только выделенный текст, а если не выделено ничего, то ответ будет по умолчанию пустым.</p>

<p><img src="/assets/static/aws/mail/1.png" /></p>

<p>Не помню, как сделать то же самое в Gmail, но там у меня выработалась привычка: после нажатия кнопки Reply я автоматом выполнял Ctrl-A Delete, чтобы стереть все из поля ввода.</p>

<p>Цитирование письма уходит корнями в прошлое. Раньше почтовые сервера не умели строить цепочки писем. Каждое письмо считалось отдельным. Чтобы был ясен контекст, старое письмо добавлялось цитатой к новому. Это в высшей степени избыточно и неэффективно. Позже письма научились сопоставлять по теме и префиксам <code class="language-plaintext highlighter-rouge">Re</code>, что тоже уродливо. И лишь затем придумали машинные заголовки с идентификаторами, где указано, на что отвечает это письмо.</p>

<p>Беду с цитированием знает каждый, кто работал в больших фирмах. В обсуждении по почте борода старых писем растет как снежный ком, и каждый клиент работает с ними по своим правилам: отступами, тильдами или вертикальными чертами. Рано или поздно в тред отвечает красноглазик с консольным клиентом на Perl, где борода цитат выделена какими-нибудь <code class="language-plaintext highlighter-rouge">&gt;&gt;&gt;</code>. В результате все видят пять экранов мусора с текстом недельной давности. Не недо так.</p>

<p><img src="/assets/static/aws/mail/2.png" /></p>

<p>Заполняйте письмо снизу вверх. Как это понимать? Обычно мы указываем получателя, тему, пишем текст и прикладываем файл. Из всех этих полей обязательно только первое — получатель. Как только он заполнен, легко отправить письмо неверным нажатием или комбинацией клавиш. За подобное письмо стыдно, оно вносит непонимание, приходится в спешке отправлять другое. Этого легко избежать методом “снизу вверх”.</p>

<p>Если вы отправляете файл, сначала приложите файл. Затем напишите текст. Введите тему. И только потом — отправителя. С таким подходом невозможно отправить письмо, пока оно не заполнено.</p>

<p>Что делать, если вы забыли приложить файл? Обычно его отправляют вдогонку со словами “забыл файлик, вот он”. Не делайте так, потому что на стороне получателя файл будет оторван от основного письма. Как его потом найти? Письмо с текстом человек найдет по ключевым словам, но как быть с файлом? Правильно сделать так: отправить повторное письмо с файлом и написать, что прошлое письмо без файла ушло по ошибке и его надо удалить. В этом случае все останутся довольны.</p>

<p>Ближайшая аналогия: вы отправили исходный код, и затем пишете: ой, не хватает одного файлика. Положите его в папку <code class="language-plaintext highlighter-rouge">foobar/lulz</code>, и все заработает. Это непрофессионально. Вы либо сдаете работу, либо нет. Письмо без файла, когда он должен там быть — испорченное письмо. Вместо попыток его исправить отправьте новое, на этот раз правильное.</p>

<p><em>Еще о файлах.</em> Если вы отправляете документы для просмотра, используйте PDF. Не ждите, что у собеседника установлен Word, Excel или Powerpoint — эти программы платные и открываются в сто раз медленней, чем PDF. Исключение возможно, когда вы оба работаете в этих программах.</p>

<p>Архивируйте файлы только в случаях, когда важна структура папок. Например, исходный код проекта. Распаковав архив, собеседник получит систему папок, готовую для сборки. Сжимать текстовые документы не нужно — это повышает энтропию и требует кликов. Не жмите изображения и другие бинарные файлы — экономия будет не более пяти процентов.</p>

<p>Если архиватор, то только zip. Своими rar, tar.gz и прочими платформо-зависимыми штучками вы огорчите получателя.</p>

<p>Файлы больше 10 Мб выносите в облачные хранилища. Желательно такие, что отдают файл по прямой ссылке, например S3. Если ссылка ведет на веб-страницу, где нужно доказать, что ты не робот, это грусть и печаль. По той же причине не пользуйтесь хостингом изображений — там показывают рекламу, открывают дичь в новых вкладках, словом, сплошное издевательство.</p>

<p><em>О композиции.</em> Письмо начинается с обращения, затем с новой строки следует текст. Он состоит из предложений, каждое заканчивается точкой или знаками вопроса или восклицания. Три-пять предложений составляют абзац, которые отделяют пустой строкой. Абзацы обязательны, чтобы дать человеку передохнуть. Письмо заканчивается подписью без точки.</p>

<p>Подпись должна быть короткой, в идеале только имя. В крайнем случае — должность и минимальные контакты: телефон и ник в мессаджерах. Писать туда домашний телефон, номер ICQ и прочую дрянь не нужно. В подписи не должно быть логотипов и ссылок.</p>

<p>Если это вручную написанное письмо, а не рекламная рассылка, его тип должен быть plain text (без форматирования). Никаких болдов, италиков и прочих офисных штучек, ведь текст — уже мощный инструмент. Поток сознания нужно разбить на абзацы или пункты, важные вещи прописать отдельно. В крайнем случае поставить восклицательный знак или выделить звездочками.</p>

<p><em>На одно письмо приходится одна мысль.</em> Нет ничего хуже письма, где просят собрать информацию по пяти пунктам. Очевидно, составить ответ на это письмо стоит всего дня, а то и недели. Если вы отправитель, пошлите пять писем, и желательно с паузами. Если вы получатель, ответьте на первый пункт с просьбой написать вам отдельные письма по остальным вопросам. Конечно, не в грубой манере “перепиши, пес”, а с пояснением, что так вам будет легче ответить.</p>

<p>Как видите, правил вышло прилично. Никто не ждет исполнения их всех, но применять их однозначно стоит. Остановитесь на чем-нибудь простом, например не цитировать все письмо в ответе, а затем каждый месяц вводите новую практику. Через несколько лет вы сами будете учить новичков почтовому этикету.</p>

<p>Важно понимать: оформление письма может сказать о вас многое. Изучая языки программирования и технологии, нужно помнить, что в конечном счете все сводится к общению. Чтобы запрограммировать задачу, ее сперва обсуждают и фиксируют результаты, и только потом садятся за код. Письмо — это первый ход при приеме на работу, и пусть он выглядит достойно.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/no-bw-color/">Черно-белый режим</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2022-06-04T00:00:00+00:00">
        Jun 4, 2022
    </time>

    <a href="/tag/work/" rel="tag">work</a>, <a href="/tag/life/" rel="tag">life</a>, <a href="/tag/monitor/" rel="tag">monitor</a>

</div>


            <div class="entry">
                
                    
<p>Иногда встречаю в интернете статьи о том, как уменьшить вред от гаджетов для глаз. Пишут обычные вещи: уменьшить яркость, включить ночной режим (меньше синего и больше желтого) и в том числе — черно-белый режим, когда цвета меняются на градации серого. Типа, меньше нагрузка на сетчатку и все такое.</p>

<p>Опровергаю: включать черно-белый режим не нужно. Несколько лет назад я <a href="/2015/10/24/1/">проводил эксперимент</a> — включил на ноуте и телефоне такой режим. В MacOS это делается галкой в меню Settings / Accessibility / Display / Color Filters, на айфоне — схожим образом.</p>

<p><img src="/assets/static/aws/bw/ui.png" /></p>

<p>Интерфейс выглядел так:</p>

<p><img src="/assets/static/Screen-Shot-2015-10-24-at-12.07.09.png" /></p>

<p>Почему этого делать не нужно? Ответ — при выключенном цвете нагрузка на глаза, как ни странно, больше. Объяснение этому простое: на сетчатке находятся разные рецепторы, в том числе палочки и колбочки. У них разные функции: первые отвечают за свет, вторые за цвет. Это ортогональные вещи: например, кошки отлично видят в темноте, но хуже нас различают цвета.</p>

<p>Убрав цвет, вы по сути выключаете колбочки, а это две трети сетчатки. Теперь палочки отвечают за поиск иконки или строки кода на мониторе. Я работал в таком режиме и быстро заметил: в черно-белом режиме трудно найти нужный элемент, глаза напрягаются. Выходит обратная вещь — вместо помощи только вредишь глазам.</p>

<p>Восприимчивость к цвету крайне важна. У нас, людей, этот навык крайне развит по сравнению с животными. Кто сорвал красный плод, тот выжил, а кому достался зеленый — увы. Мозг получает колоссальную информацию из цвета, и добровольно лишать себя этого по крайней мере странно.</p>

<p>Возвращаясь к первоначальному вопросу — как защитить глаза от гаджетов в вечернее и ночное время? Очень просто — не пользоваться гаджетами. Ночной там режим или нет, желтый фон, пониженное мерцания — все это ерунда. Экран — это тысяча мелких фонариков, которые светят вам в глаза. Регулируйте гаджет как угодно, сути это не меняет: вы смотрите на источник света, пусть и рассеянный. При любых настройках он будет вреден в вечернее время.</p>

<p>Наоборот, книга и вообще бумага не светятся. Она только отражает свет лампы, но это свет другого рода. Будучи отраженным от бумаги, он не вредит вам.</p>

<p>Это не значит, что я не туплю в экран вечером. Увы, порой случается. Однако понимаю грань допустимого и не обманываю себя режимами. Лучший режим гаджета перед сном — ВЫКЛ.</p>

                
            </div>

        </li>
        
    </ul>

    <h4>
        
        <a href="/page2" class="previous">&larr;</a>
        
        <span class="page_number ">Страница 3 из 60</span>
        
        <a href="/page4" class="next">&rarr;</a>
        
    </h4>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Ivan Grishaev's blog</li>
          <li><a href="mailto:ivan@grishaev.me">ivan@grishaev.me</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
            <li><a href="https://github.com/igrishaev">GitHub</a></li>
            <li><a href="tg://resolve?domain=igrishaev_blog">Telegram</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Writing on programming, education, books and negotiations.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
