<!DOCTYPE html>
<html lang="ru">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Ivan Grishaev's blog</title>
  <meta name="description" content="Writing on programming, education, books and negotiations.
">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/custom.css">
  <link rel="canonical" href="https://grishaev.me/page6/">
  <link rel="alternate" type="application/rss+xml" title="Ivan Grishaev's blog" href="https://grishaev.me/feed.xml">

  <link rel="shortcut icon" type="image/x-icon" href="/assets/static/favicons/favicon.ico">

  <script type="text/javascript" src="/assets/typo.js"></script>

</head>


  <body>
    <header class="site-header">

    <div class="wrapper flex-container">

        <div>
            <a href="/">
                <img id="avatar" src="/assets/static/avatar.jpg" alt="Ivan Grishaev">
            </a>
        </div>

        <div class="flex-container-vert" style="margin-left: 15px; width: 80%">

            <div class="flex-container full-width">
                <p style="margin-bottom: 5px"><a href="/">Ivan Grishaev's blog</a></p>
                <div class="flex-huge"></div>
                <div >
<form id="search-form"
      target="_blank"
      style="display: inline"
      method="get"
      action="https://www.google.com/search">

    <input name="sitesearch"
           value="grishaev.me"
           type="hidden">

    <input type="text"
           required="required"
           name="q"
           placeholder="Google search..."
           autocomplete="off">

    <button style="border: none; background-color: transparent; cursor: pointer;"
            type="submit">&#x1f50d;</button>

</form>
</div>
            </div>

            <p><small>Writing on programming, education, books and negotiations.
</small></p>

            <div class="flex-container">
                <a class="menu-item" href="/">Home</a>
                <a class="menu-item" href="/about/">About</a>
                <a class="menu-item" href="/open-source/">Open Source</a>
                <a class="menu-item" href="/bookshelf/">Bookshelf</a>
                <a class="menu-item" href="/feed.xml">RSS</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor" href="/tag/clojure/">Clojure</a>
                <a class="menu-item minor" href="/tag/emacs/">Emacs</a>
                <a class="menu-item minor" href="/tag/python/">Python</a>
                <a class="menu-item minor" href="/tag/programming/">Programming</a>
                <a class="menu-item minor" href="/interview/">Interview</a>
                <a class="menu-item minor" href="/video/">Video</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor hl" href="/clojure-in-prod/">Книга «Clojure на производстве»</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor hl" href="/clojure-in-prod-2/">Книга «Clojure на производстве», второй том</a>
            </div>

        </div>
    </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="home">

    <ul class="post-list">
        
        <li>

            <h2>
                <a class="post-link" href="/abstractions/">Про абстракции</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2025-04-19T00:00:00+00:00">
        Apr 19, 2025
    </time>

    <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/bingo/" rel="tag">bingo</a>, <a href="/tag/abstractions/" rel="tag">abstractions</a>

</div>


            <div class="entry">
                
                    <p>Как только зашла речь об абстракциях, знайте: дело швах. Абстракции – это
булщит-бинго, в котором линейному разрабу никогда не выиграть. Это штучки для
менеджеров и архитекторов, то есть тех, кто парит над кодом, а не стоит в нем по
колено.</p>

<p>Бывает, разработчики увлекаются и играют в эти шашни: всерьез обсуждают
абстракции. Они забывают, что любая функция – это уже абстракция. Например,
функция поиска простого числа может перебирать числа линейно, с интервалом или
брать из таблицы. Может кешировать. Аналогично с факториалом или числом
Фиббоначи: потребитель не знает, что внутри, поэтому функция абстрактна. Сюда же
списки и хеш-таблицы.</p>

<p>В ООП языках абстракция вообще идет из коробки. Скажем, написал интерфейс
<code class="language-plaintext highlighter-rouge">UserRepo</code> с методом <code class="language-plaintext highlighter-rouge">User getUserById(Integer id)</code> и везде его передаешь. А
потом пишешь классы <code class="language-plaintext highlighter-rouge">JDBCUserRepo</code> и <code class="language-plaintext highlighter-rouge">MongoUserRepo</code>, каждый из которых ходит
куда нужно. Об этом пишут в каждом учебнике по Джаве. Что может быть проще?</p>

<p>Нормальный код в абстракции не нуждается – он и есть абстракция над байткодом
или машкодом. Вот и весь разговор.</p>

<p>Лучшее, что можно сделать в споре про абстракции – это промолчать. Скорее
всего, любителя абстракций отпустит, и он забудет о них так же быстро, как и
вспомнил. И вы спокойно сделаете все как надо. Спорить и лезть на рожон глупо,
потому что повторюсь: абстракции – это булщит-бинго, в котором разработчику
никогда не выиграть.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/salary-tax/">Зарплата до налогов</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2025-04-10T00:00:00+00:00">
        Apr 10, 2025
    </time>

    <a href="/tag/life/" rel="tag">life</a>, <a href="/tag/work/" rel="tag">work</a>, <a href="/tag/salary/" rel="tag">salary</a>, <a href="/tag/tax/" rel="tag">tax</a>

</div>


            <div class="entry">
                
                    <p>Хоть я и не сталкивался, но предупреждаю вот о чем.</p>

<p>Некоторые HR-ы практикуют гниловатый прием: называют зарплату, не договаривая,
что это ДО налогов. В итоге сотруднику платят меньше, а когда он спрашивает
“wtf?”, ему отвечают: это до налогов, дорогой! Как в лучших домах Европы.</p>

<p>Такое случается не только в айти: слышал в том числе от стоматологов. Врача
переманивают лишней двадцаткой и потом вычитают ее налогами. А назад уже поздно:
взяли другого врача, да и ушел не совсем достойно.</p>

<p>Ситуация, конечно, бредовая: русская фирма нанимает русского сотрудника, а
налоги у них как в Европе? Скорее, обычная русская жадность.</p>

<p>Будете устраиваться во всякие ВК-Сберы-Яндексы – имейте в виду.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/pg-awesome/">Реляционная база данных</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2025-04-10T00:00:00+00:00">
        Apr 10, 2025
    </time>

    <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/postgres/" rel="tag">postgres</a>, <a href="/tag/sql/" rel="tag">sql</a>

</div>


            <div class="entry">
                
                    <p>Повторюсь, до чего же это классно: иметь в распоряжении нормальную реляционную
базу данных. Не тридцать микросервисов с HTTP JSON API; не OpenSearch; не Монгу;
не черт знает что еще.</p>

<p>Скажем, у меня условие: отправлять письмо, если у вложенных атрибутов такие-то
значения, плюс у сущностей, на которые ссылается эта сущность, тоже определенные
значения. Эти проверки выливаются в экраны быдлокода. Сначала собрали вложенные
куски, отфильтровали, построили индекс. Взяли айдишки. По ним выгребли другие
сущности, плюс надо следить, что их не 10 тысяч, иначе пляска с
пагинацией. Потом пробегаешь по этим сущностям, строишь индекс. И по двум
индексам находишь ответ: есть совпадения или нет.</p>

<p>Даже на Кложе это приличный быдлокод, который через пару месяцев хрен поймешь:
<code class="language-plaintext highlighter-rouge">map</code>, <code class="language-plaintext highlighter-rouge">map</code>, <code class="language-plaintext highlighter-rouge">filter</code>, <code class="language-plaintext highlighter-rouge">reduce</code>, <code class="language-plaintext highlighter-rouge">map</code>, <code class="language-plaintext highlighter-rouge">group-by</code> – удачной отладки. В
какой-нибудь Джаве с доменами и слоями проще выйти в окно.</p>

<p>А в SQL это запрос в 18 строчек. Функция <code class="language-plaintext highlighter-rouge">json_path_query</code>, которая собирает
вложенные пути, один <code class="language-plaintext highlighter-rouge">left join</code> и пара условий. Все декларативно, нет
переменных и циклов.</p>

<p>Еще один момент: если придет человек и спросит, почему эта штука посчиталась
именно так, то с микросервисами я сосу лапу. Код отработал, и какие структуры
были в памяти, догнать уже невозможно. Раньше я дампил состояние в S3, чтобы
позже скачать его и воспроизвести расчеты. Но это долго! А теперь я выполнил
запрос в PGAdmin, и человек такой: все верно, это у нас надо поправить.</p>

<p>Принцип простой: чтобы стало легче, нужно отстегнуть гири, которые сами же
привязали. Если нет легкого, произвольного доступа к данным, ни о какой удобной
работе нет речи.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/excel-hangs/">Зависание окон в Экселе</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2025-04-10T00:00:00+00:00">
        Apr 10, 2025
    </time>

    <a href="/tag/excel/" rel="tag">excel</a>

</div>


            <div class="entry">
                
                    <p>Работал в Экселе и заметил одну вещь.</p>

<p>В офисном пакете интерфейс устроен по принципу “один файл – одно окно”. Это
значит, если открыто пять файлов, то будет пять окон. А восприятие наше таково,
что каждое окно считается независимым. Технически много окон могут обслуживаться
одним процессом, да. Но когда я вижу окно во весь экран с менюшкой и табиками,
оно ощущается отдельной программой.</p>

<p>Это приводит к странному поведению: во время долгого импорта виснут все окна
Экселя. Я рассуждал так: пока импортируется тяжелый файл, я поработаю с другим
файлом. Но Эксель в этом плане однопоточный: остальные окна тупо ждут, пока
отпустит первое. Может, такое только на Маке, а на Винде проблем нет, спорить не
буду.</p>

<p>Интересно вот что. Сегодня все браузеры работают по принципу “одна вкладка –
один процесс”. Я смутно помню, что этого браузеры, в том числе Хром, часто
вылетали с ошибками, потому что вкладки были на тредах. Сегодня это редкость, а
лет 15 назад было в порядке вещей. Или браузер мог повиснуть на Ютубе или
какой-то упоротой верстке, заморозив все табы. А теперь, когда вкладке плохо, мы
этого даже не замечаем.</p>

<p>Было бы забавно проверить эту модель в современном вебе. Иногда на звонках люди
шарят экран, и я вижу Хром с тремя десятками вкладок. Без преувеличения, не
менее тридцати, потому что табики сжаты до размера иконки. Десятки табов Джиры,
Конфлюэнса и прочей корпоративной жести. А каждая Джира – это, на минуточку, 50
мегабайтов скриптов и запросы на каждый клик. Мне кажется, если бы тридцать Джир
крутились в одном процессе, интернета мы бы вообще не увидели.</p>

<p>И еще одна мысль, которую не знаю, куда приткнуть. Сервер PostgreSQL работает по
принципу “одно соединение – один процесс”. Никаких тредов там нет и в помине,
на каждое подключение делается форк главного процесса. Обмен данными происходит
через shared memory – участок памяти, доступный всем процессам. Что-то вроде
глобальной переменной, только в рамках процессов.</p>

<p>Вроде топорно, но оказывается удобным на практике, потому и дожило до наших
дней.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/why-password/">Зачем пароль?</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2025-04-03T00:00:00+00:00">
        Apr 3, 2025
    </time>

    <a href="/tag/life/" rel="tag">life</a>, <a href="/tag/ui/" rel="tag">ui</a>, <a href="/tag/password/" rel="tag">password</a>

</div>


            <div class="entry">
                
                    <p>Вот что меня удивляет. Когда логинишься в любой сервис, ввода пароля уже
недостаточно. Обязательно спросят код с телефона или почты. В какой-то степени я
с этим согласен, потому что телефон – физическое устройство, им трудно
завладеть, коды одноразовые, их сложнее перехватить.</p>

<p>Хорошо, но зачем тогда вообще пароль? Если мы не доверяем тому, кто ввел пароль,
зачем он нужен? Вроде бы есть проверка, но она не точная как фильтр Блума.</p>

<p>Коды из смс и всякие токены из приложения – все это буквально кричит о кризисе
системы паролей. И вместо того, чтобы закопать стюардессу и отменить пароли,
продолжают их использовать.</p>

<p>Видимо, кто-то считает, что связка “пароль” + “код из смс” безопасней, чем оба
по отдельности, но я в это не верю. Это примерно как вызвать хэш-фукцию десять
раз вместо одного: доказано, что такой подход не приносит пользы.</p>

<p>Телефон уже давно умеет в биометрию и может авторизировать человека где
угодно. Неужели лица и отпечатка пальца недостаточно, чтобы зайти в личный
кабинет? С какой стати человек должен помнить пароли вроде “не менее 8 символов,
не менее двух заглавных букв” и мусора вроде решеток и долларов? И так для
двадцати разных сервисов?</p>

<p>Тем не менее, все бездумно лепят одну и ту же схему: пароль, которому никто не
верит, и коды с телефона. Тут явно нужно что-то менять.</p>

<p>Самое смешное: сейчас вы повозмущаетесь в комментариях, а что потом? Пойдете
пилить форму авторизации с паролем.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/time-shift/">Перевод часов</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2025-04-03T00:00:00+00:00">
        Apr 3, 2025
    </time>

    <a href="/tag/time/" rel="tag">time</a>

</div>


            <div class="entry">
                
                    <p>Трудно поверить, но во многих странах до сих пор живодерский обычай переводить
время на час и обратно. Даже находятся те, кто утверждает, что это полезно для
экономики.</p>

<p>Напомню, что сто пятьдесят лет назад какой-то бюрократ посчитал, что если
зажигать лампочку на час позже, это будет дешевле. О мелочах вроде сорванных
встреч, опозданий и нарушений биоритмов никто не думал.</p>

<p>Поражаюсь, почему люди до сих пор живут с этим бредом? Было совсем другое время,
другое общество, только что вступившее в индустриальную фазу. Сегодня другие
приоритеты. Почему не пересмотреть вопрос, но на этот раз учесть все факторы, а
не только “экономию” нескольких тысяч долларов на всю страну?</p>

<p>Согласен, что зимой нужно корректировать время, но делать это нужно по-другому.</p>

<p>Зимой человек устает больше и спит больше. Поднять и собрать детей в школу зимой
– целый подвиг. А весной или ранней осенью, когда солнце уже показалось,
вставать легче. Отсюда вывод: нужно двигать не циферблат целиком, а распорядок
госучреждений. Например, начинать занятия в школах, садах и госконторах не в 8
утра, а в 9 или хотя бы в 8:30. То есть давать людям лишние 30 минут на сон.</p>

<p>Это честно, потому что затрагивает только тех, кому это нужно. На офисных
работниках, у которых служба начинается в 10, это никак не отразится. У них не
поедет календарь, не придется опаздывать. У стариков не нарушится прием
лекарств. Что может быть лучше?</p>

<p>Пока писал, вспомнил свою жизнь в Чите. Я тогда работал в Энергосбыте, где
служба начиналась в 8 утра, и за опозданиями следили строго. Пара опозданий –
выговор, три и более – лишают премии. Только одна женщина из соседнего отдела
могла приходить к 9 утра, но такую привилегию нужно было выслуживать годами.</p>

<p>Так вот, Чита, зима, поднимаешься в 6:30. За окном ночь. Завтрак, подъем
ребенка, сбор в садик. Едем на санках по морозу -30. Машины нет, да и не каждая
машина заведется, постояв ночь при такой температуре. После сада нужно сесть на
маршрутку, а они все полные. Кое-как добраться до работы, чтобы пересечь
турникет за две минуты до 8 утра. Зайти в кабинет и полчаса отогреваться и
отпиваться чаем. Зато успел, премии не лишат.</p>

<p>Блин, зачем так жить? Зачем рвать задницу ради 8 часов утра? Зачем переводить
часы глобально? Почему нельзя подвинуть распорядок тех контор, которые начинают
рано? То, что в мире сейчас – это какой-то идиотизм от начала до конца.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/read-books/">Книги не устаревают</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2025-04-03T00:00:00+00:00">
        Apr 3, 2025
    </time>

    <a href="/tag/books/" rel="tag">books</a>

</div>


            <div class="entry">
                
                    <p>Удивляюсь, когда говорят: айтишные книги устаревают. Это не так.</p>

<p>Книги об алгоритмах, сетях или азах разработки не устаревают в силу своей
базы. Нет такого, что каждый день придумывают новую сортировку или топологию
дерева. Новый сетевой протокол выходит раз в несколько лет, а не дней. Поэтому
здесь волноваться не о чем.</p>

<p>Если условный Rust меняется каждый день, и код из прошлогодней книги уже не
работает, то это проблема технологии, а не книги. Пусть читатель либо подождет,
пока язык стабилизируется, либо выберет что-то более надежное.</p>

<p>Читая книгу, человек не просто что-то узнает. Он насыщает индекс, обучает свою
нейронную сеть. Даже если он сядет за новую версию технологии, сработает фактор
знакомства: это я уже видел, тут на 70% как в книжке.</p>

<p>Читайте книги!</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/phone-bots/">Телефонные боты</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2025-04-03T00:00:00+00:00">
        Apr 3, 2025
    </time>

    <a href="/tag/life/" rel="tag">life</a>, <a href="/tag/ai/" rel="tag">ai</a>, <a href="/tag/bots/" rel="tag">bots</a>

</div>


            <div class="entry">
                
                    <p>Замечаю еще один забавный паттерн. Звоню в разные фирмы, и как обычно, на входе
голосовое меню. Чтобы узнать то, нажми 1, чтобы это, нажми 2 и так далее. Либо
тыкаешь сразу 0, чтобы попасть на оператора, либо ждешь, пока меню отпустит и
сработает фолбек.</p>

<p>Но когда скрипт переключает на оператора, включается ИИ-бот. “Я голосовой
помощник Иннокентий, какой у вас вопрос?” Говоришь “дай оператора”, и начинаются
расспросы: а по какому вопросу тебе нужен оператор? В точности пенсионер-вахтер.</p>

<p>К чему я это пишу. Ребята, которые внедряют голосовых ботов: не кажется ли вам
странным оставлять голосовое меню из нулевых годов? У вас же вроде ИИ, который
знает и умеет все на свете, и который скоро всех заменит. Но прежде чем попасть
на бота, я должен кликать в голосовом меню? Как-то не сходится. Зачем боту такой
костыль?</p>

<p>То, что голосовые помощники тупы как пробки, нет смысла говорить. Выделяют
ключевые слова и читают то, что уже есть на сайте. Например, спросишь: на какой
премиальный курс я могу рассчитывать, если сумма обмена больше N тысяч евро? И
он диктует текущий курс или расписание отделений.</p>

<p>Беда.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/pg-search/">Postgres как поисковый движок</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2025-04-03T00:00:00+00:00">
        Apr 3, 2025
    </time>

    <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/postgres/" rel="tag">postgres</a>

</div>


            <div class="entry">
                
                    <p>Накину ссылку, которая очень мне помогла:</p>

<p><a href="https://habr.com/ru/companies/sravni/articles/888534/">Postgres как поисковый движок</a></p>

<p>Речь о том, как делать гибридный поиск в Посгресе. Это когда документы ищутся по
разным критериям, ранжируются, а потом объединяются в финальный набор. Как раз
то, над чем я работаю в текущем проекте.</p>

<p>Статья полезна вот чем: до нее я не понимал, как объединять выборки с удалением
дублей. Бывает, один и тот же документ оказывается в разных выборках, и нужно
оставить ту, у которой больше ранг. Пытался сделать это при помощи <code class="language-plaintext highlighter-rouge">UNION</code>, но
из-за ранга дубликаты не удалялись. Чистить их вторым проходом тяжело,
усложняется план.</p>

<p>Так вот: автор предлагает объединение выборок при помощи full outer join и
coalesce среди айдишек прошлых результатов. Звучит непонятно, но если
разобраться, то получается как в примере ниже.</p>

<p>Для сравнения, вот первый запрос, который выбирает документы по условиям и
сортирует по выражению с рангом:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="k">aggregate</span> <span class="k">FROM</span> <span class="n">some_aggregates</span>
    <span class="k">WHERE</span>
        <span class="k">NOT</span> <span class="p">((</span><span class="k">aggregate</span> <span class="o">#&gt;&gt;</span> <span class="n">ARRAY</span><span class="p">[</span><span class="s1">'state'</span><span class="p">])</span> <span class="o">=</span> <span class="s1">':deleted'</span><span class="p">)</span>
        <span class="k">AND</span> <span class="p">(((</span><span class="k">aggregate</span> <span class="o">#&gt;&gt;</span> <span class="n">ARRAY</span><span class="p">[</span><span class="s1">'attrs'</span><span class="p">,</span> <span class="s1">'code'</span><span class="p">])</span> <span class="o">=</span> <span class="s1">'hello'</span><span class="p">)</span>
            <span class="k">OR</span> <span class="p">(</span><span class="k">aggregate</span> <span class="o">@@</span> <span class="s1">'$.attrs."code-name" == "hello"'</span><span class="p">)</span>
            <span class="k">OR</span> <span class="p">((</span><span class="k">aggregate</span> <span class="o">#&gt;&gt;</span> <span class="n">ARRAY</span><span class="p">[</span><span class="s1">'attrs'</span><span class="p">,</span> <span class="s1">'code'</span><span class="p">])</span> <span class="k">ILIKE</span> <span class="s1">'%hello%'</span><span class="p">)</span>
            <span class="k">OR</span> <span class="p">((</span><span class="k">aggregate</span> <span class="o">#&gt;&gt;</span> <span class="n">ARRAY</span><span class="p">[</span><span class="s1">'attrs'</span><span class="p">,</span> <span class="s1">'code-name'</span><span class="p">])</span> <span class="k">ILIKE</span> <span class="s1">'%hello%'</span><span class="p">))</span>

    <span class="k">ORDER</span> <span class="k">BY</span> <span class="k">CASE</span>
        <span class="k">WHEN</span> <span class="p">(</span><span class="k">aggregate</span> <span class="o">#&gt;&gt;</span> <span class="n">ARRAY</span><span class="p">[</span><span class="s1">'attrs'</span><span class="p">,</span> <span class="s1">'code'</span><span class="p">])</span> <span class="o">=</span> <span class="s1">'hello'</span> <span class="k">THEN</span> <span class="mi">0</span>
        <span class="k">WHEN</span> <span class="k">aggregate</span> <span class="o">@@</span> <span class="s1">'$.attrs."code-name" == "hello"'</span> <span class="k">THEN</span> <span class="mi">1</span>
        <span class="k">WHEN</span> <span class="p">(</span><span class="k">aggregate</span> <span class="o">#&gt;&gt;</span> <span class="n">ARRAY</span><span class="p">[</span><span class="s1">'attrs'</span><span class="p">,</span> <span class="s1">'code'</span><span class="p">])</span> <span class="k">ILIKE</span> <span class="s1">'%hello%'</span> <span class="k">THEN</span> <span class="mi">2</span>
        <span class="k">WHEN</span> <span class="p">(</span><span class="k">aggregate</span> <span class="o">#&gt;&gt;</span> <span class="n">ARRAY</span><span class="p">[</span><span class="s1">'attrs'</span><span class="p">,</span> <span class="s1">'code-name'</span><span class="p">])</span> <span class="k">ILIKE</span> <span class="s1">'%hello%'</span> <span class="k">THEN</span> <span class="mi">3</span>
        <span class="k">ELSE</span> <span class="mi">999</span>
    <span class="k">END</span> <span class="k">ASC</span>

    <span class="k">LIMIT</span> <span class="mi">51</span> <span class="k">OFFSET</span> <span class="mi">0</span>
</code></pre></div></div>

<p>На таблице с 1.5 миллионами записей метрики такие: execution=450ms, cost=90000,
что довольно много.</p>

<p>А вот то же самое, но с подходом, который предлагает автор:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="n">sub1</span> <span class="k">as</span> <span class="p">(</span>
    <span class="k">select</span>
        <span class="n">id</span><span class="p">,</span>
        <span class="mi">0</span> <span class="k">as</span> <span class="n">rank</span>
    <span class="k">from</span>
        <span class="n">some_aggregates</span>
    <span class="k">where</span>
        <span class="k">NOT</span> <span class="p">((</span><span class="k">aggregate</span> <span class="o">#&gt;&gt;</span> <span class="n">ARRAY</span><span class="p">[</span><span class="s1">'state'</span><span class="p">])</span> <span class="o">=</span> <span class="s1">':deleted'</span><span class="p">)</span>
        <span class="k">and</span> <span class="p">((</span><span class="k">aggregate</span> <span class="o">#&gt;&gt;</span> <span class="n">ARRAY</span><span class="p">[</span><span class="s1">'attrs'</span><span class="p">,</span> <span class="s1">'code'</span><span class="p">])</span> <span class="o">=</span> <span class="s1">'hello'</span><span class="p">)</span>
    <span class="k">limit</span> <span class="mi">51</span>
<span class="p">),</span>

<span class="n">sub2</span> <span class="k">as</span> <span class="p">(</span>
    <span class="k">select</span>
        <span class="n">id</span><span class="p">,</span>
        <span class="mi">1</span> <span class="k">as</span> <span class="n">rank</span>
    <span class="k">from</span>
        <span class="n">some_aggregates</span>
    <span class="k">where</span>
        <span class="k">NOT</span> <span class="p">((</span><span class="k">aggregate</span> <span class="o">#&gt;&gt;</span> <span class="n">ARRAY</span><span class="p">[</span><span class="s1">'state'</span><span class="p">])</span> <span class="o">=</span> <span class="s1">':deleted'</span><span class="p">)</span>
        <span class="k">and</span> <span class="p">(</span><span class="k">aggregate</span> <span class="o">@@</span> <span class="s1">'$.attrs."code-name" == "hello"'</span><span class="p">)</span>
    <span class="k">limit</span> <span class="mi">51</span>
<span class="p">),</span>

<span class="n">sub3</span> <span class="k">as</span> <span class="p">(</span>
    <span class="k">select</span>
        <span class="n">id</span><span class="p">,</span>
        <span class="mi">2</span> <span class="k">as</span> <span class="n">rank</span>
    <span class="k">from</span>
        <span class="n">some_aggregates</span>
    <span class="k">where</span>
        <span class="k">NOT</span> <span class="p">((</span><span class="k">aggregate</span> <span class="o">#&gt;&gt;</span> <span class="n">ARRAY</span><span class="p">[</span><span class="s1">'state'</span><span class="p">])</span> <span class="o">=</span> <span class="s1">':deleted'</span><span class="p">)</span>
        <span class="k">and</span> <span class="p">((</span><span class="k">aggregate</span> <span class="o">#&gt;&gt;</span> <span class="n">ARRAY</span><span class="p">[</span><span class="s1">'attrs'</span><span class="p">,</span> <span class="s1">'code'</span><span class="p">])</span> <span class="k">ILIKE</span> <span class="s1">'%hello%'</span><span class="p">)</span>
    <span class="k">limit</span> <span class="mi">51</span>
<span class="p">),</span>

<span class="n">sub4</span> <span class="k">as</span> <span class="p">(</span>
    <span class="k">select</span>
        <span class="n">id</span><span class="p">,</span>
        <span class="mi">3</span> <span class="k">as</span> <span class="n">rank</span>
    <span class="k">from</span>
        <span class="n">some_aggregates</span>
    <span class="k">where</span>
        <span class="k">NOT</span> <span class="p">((</span><span class="k">aggregate</span> <span class="o">#&gt;&gt;</span> <span class="n">ARRAY</span><span class="p">[</span><span class="s1">'state'</span><span class="p">])</span> <span class="o">=</span> <span class="s1">':deleted'</span><span class="p">)</span>
        <span class="k">and</span> <span class="p">((</span><span class="k">aggregate</span> <span class="o">#&gt;&gt;</span> <span class="n">ARRAY</span><span class="p">[</span><span class="s1">'attrs'</span><span class="p">,</span> <span class="s1">'code-name'</span><span class="p">])</span> <span class="k">ILIKE</span> <span class="s1">'%hello%'</span><span class="p">)</span>
    <span class="k">limit</span> <span class="mi">51</span>
<span class="p">)</span>

<span class="k">select</span>
    <span class="n">aggs</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
 <span class="n">aggs</span><span class="p">.</span><span class="k">aggregate</span> <span class="o">#&gt;&gt;</span> <span class="n">ARRAY</span><span class="p">[</span><span class="s1">'attrs'</span><span class="p">,</span> <span class="s1">'code'</span><span class="p">],</span>
 <span class="n">aggs</span><span class="p">.</span><span class="k">aggregate</span> <span class="o">#&gt;&gt;</span> <span class="n">ARRAY</span><span class="p">[</span><span class="s1">'attrs'</span><span class="p">,</span> <span class="s1">'code-name'</span><span class="p">],</span>
 <span class="n">sub1</span><span class="p">.</span><span class="n">rank</span><span class="p">,</span>
 <span class="n">sub2</span><span class="p">.</span><span class="n">rank</span><span class="p">,</span>
 <span class="n">sub3</span><span class="p">.</span><span class="n">rank</span><span class="p">,</span>
 <span class="n">sub4</span><span class="p">.</span><span class="n">rank</span><span class="p">,</span>
 <span class="n">aggs</span><span class="p">.</span><span class="k">aggregate</span>
<span class="k">from</span>
    <span class="n">sub1</span>

<span class="k">full</span> <span class="k">outer</span> <span class="k">join</span> <span class="n">sub2</span> <span class="k">on</span> <span class="n">coalesce</span><span class="p">(</span><span class="n">sub1</span><span class="p">.</span><span class="n">id</span><span class="p">)</span> <span class="o">=</span> <span class="n">sub2</span><span class="p">.</span><span class="n">id</span>
<span class="k">full</span> <span class="k">outer</span> <span class="k">join</span> <span class="n">sub3</span> <span class="k">on</span> <span class="n">coalesce</span><span class="p">(</span><span class="n">sub1</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">sub2</span><span class="p">.</span><span class="n">id</span><span class="p">)</span> <span class="o">=</span> <span class="n">sub3</span><span class="p">.</span><span class="n">id</span>
<span class="k">full</span> <span class="k">outer</span> <span class="k">join</span> <span class="n">sub4</span> <span class="k">on</span> <span class="n">coalesce</span><span class="p">(</span><span class="n">sub1</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">sub2</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">sub3</span><span class="p">.</span><span class="n">id</span><span class="p">)</span> <span class="o">=</span> <span class="n">sub4</span><span class="p">.</span><span class="n">id</span>

<span class="k">join</span> <span class="n">some_aggregates</span> <span class="n">aggs</span>
    <span class="k">on</span> <span class="n">coalesce</span><span class="p">(</span><span class="n">sub1</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">sub2</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">sub3</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">sub4</span><span class="p">.</span><span class="n">id</span><span class="p">)</span> <span class="o">=</span> <span class="n">aggs</span><span class="p">.</span><span class="n">id</span>

<span class="k">order</span> <span class="k">by</span>
    <span class="n">sub1</span><span class="p">.</span><span class="n">rank</span><span class="p">,</span> <span class="n">sub2</span><span class="p">.</span><span class="n">rank</span><span class="p">,</span> <span class="n">sub3</span><span class="p">.</span><span class="n">rank</span><span class="p">,</span> <span class="n">sub3</span><span class="p">.</span><span class="n">rank</span> <span class="k">asc</span>

<span class="k">limit</span> <span class="mi">51</span>
</code></pre></div></div>

<p>Хоть он и выглядит длинно, содержит CTE и джоины, но метрики такие:
execution=7ms, cost=15000. Гораздо быстрее первого варианта.</p>

<p>Мораль в том, что короткий запрос не всегда значит быстрый. С помощью
правильного джоина можно отсечь огромную часть выборки, сведя ее нескольким
записям.</p>

<p>Статья на Хабре – перевод вот этого блога:
https://anyblockers.com/posts/postgres-as-a-search-engine</p>

<p>В свою очередь, автор взял идею из блога Supabase:
https://supabase.com/docs/guides/ai/hybrid-search</p>

<p>Тем, кто ковыряеся с Посгресом, будет очень полезно изучить ссылки.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/it-was-a-gay/">Настоящий гей</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2025-04-03T00:00:00+00:00">
        Apr 3, 2025
    </time>

    <a href="/tag/life/" rel="tag">life</a>

</div>


            <div class="entry">
                
                    <p>Встречаюсь с приятелем, и он рассказывает: водил жену в ресторан, и знаешь,
какой официант нас обслуживал? Настоящий гей! Или знакомый врач говорит:
представляешь, вчера на приеме был настоящий гомик! Разумеется, они используют
более резкие термины, но я не привожу, чтобы никого не обидеть.</p>

<p>В такие моменты я оживляюсь и спрашиваю: как ты определил, что это гей? Он
оставил записку с предложением встретиться? Он погладил тебя за руку? Шлепнул по
заднице? Пристал в гардеробе?</p>

<p>Все оказывается банально: этот “гей” был вычурно одет, пользовался косметикой,
говорил с другой интонацией. И все? “Божечки, а разговоров-то было…” (с)</p>

<p>В городской среде сексуальная ориентация и внешность никак не связаны. Можно
спать с мужчинами и носить обычную одежду. Можно носить ошейник и кожаные штаны,
но не иметь связей в принципе.</p>

<p>В случае с официантом причин может быть много. Когда у человека совсем плохо с
женщинами, он может притворяться геем, особенно если работает в женском
коллективе. Это старый прием, потому что к геям девушки относятся по-другому.</p>

<p>Человеку может нравиться ролевая модель гея. Он изображает того, кто не
вписывается в рамки. Ему нравится эпатировать публику, ловить
взгляды. Провоцировать других и писать гневные посты в VK: а сегодня одно быдло
сказало мне… Отсюда прилизанные лаком волосы, мушка на щеке, брошь размером с
кулак.</p>

<p>Не вижу разницы с неформалами, готами и другими ребятами. Везде, если копнуть,
сидит желание выделиться или уход от своих проблем.</p>

<p>Отучайтесь делать выводы об ориентации по внешности. Иначе вы не лучше
деревенского гопника, который выучил, в каком ухе должна быть серьга, в какую
сторону приглаживать челку, и какой фасон джинсов “правильный”. Мир как бы
сложнее этих правил.</p>

                
            </div>

        </li>
        
    </ul>

    <h4>
        
        <a href="/page5" class="previous">&larr;</a>
        
        <span class="page_number ">Страница 6 из 96</span>
        
        <a href="/page7" class="next">&rarr;</a>
        
    </h4>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Ivan Grishaev's blog</li>
          <li><a href="mailto:ivan@grishaev.me">ivan@grishaev.me</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
            <li><a href="https://github.com/igrishaev">GitHub</a></li>
            <li><a href="https://t.me/igrishaev_blog">Telegram</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Writing on programming, education, books and negotiations.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
