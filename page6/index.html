<!DOCTYPE html>
<html lang="ru">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Ivan Grishaev's blog</title>
  <meta name="description" content="Writing on programming, education, books and negotiations.
">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/custom.css">
  <link rel="canonical" href="https://grishaev.me/page6/">
  <link rel="alternate" type="application/rss+xml" title="Ivan Grishaev's blog" href="https://grishaev.me/feed.xml">

  <link rel="shortcut icon" type="image/x-icon" href="/assets/static/favicons/favicon.ico">

  <script type="text/javascript" src="/assets/typo.js"></script>

</head>


  <body>
    <header class="site-header">

    <div class="wrapper flex-container">

        <div>
            <a href="/">
                <img id="avatar" src="/assets/static/avatar.jpg" alt="Ivan Grishaev">
            </a>
        </div>

        <div class="flex-container-vert" style="margin-left: 15px; width: 80%">

            <div class="flex-container full-width">
                <p style="margin-bottom: 5px">Ivan Grishaev's blog</p>
                <div class="flex-huge"></div>
                <div >
<form id="search-form"
      target="_blank"
      style="display: inline"
      method="get"
      action="https://www.google.com/search">

    <input name="sitesearch"
           value="grishaev.me"
           type="hidden">

    <input type="text"
           required="required"
           name="q"
           placeholder="Google search..."
           autocomplete="off">

    <button style="border: none; background-color: transparent; cursor: pointer;"
            type="submit">&#x1f50d;</button>

</form>
</div>
            </div>

            <p><small>Writing on programming, education, books and negotiations.
</small></p>

            <div class="flex-container">
                <a class="menu-item" href="/">Home</a>
                <a class="menu-item" href="/about/">About</a>
                <a class="menu-item" href="/bookshelf/">Bookshelf</a>
                <a class="menu-item" href="/feed.xml">RSS</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor" href="/tag/clojure/">Clojure</a>
                <a class="menu-item minor" href="/tag/emacs/">Emacs</a>
                <a class="menu-item minor" href="/tag/python/">Python</a>
                <a class="menu-item minor" href="/tag/programming/">Programming</a>
                <a class="menu-item minor" href="/interview/">Interview</a>
                <a class="menu-item minor" href="/video/">Video</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor hl" href="/clojure-in-prod/">Книга «Clojure на производстве»</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor hl" href="/clojure-in-prod-2/">Книга «Clojure на производстве», второй том</a>
            </div>

        </div>
    </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="home">

    <ul class="post-list">
        
        <li>

            <h2>
                <a class="post-link" href="/en/pg-version-1.18/">PG2 release 0.1.18</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2024-11-01T00:00:00+00:00">
        Nov 1, 2024
    </time>

    <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/sql/" rel="tag">sql</a>, <a href="/tag/clojure/" rel="tag">clojure</a>, <a href="/tag/postgres/" rel="tag">postgres</a>

</div>


            <div class="entry">
                
                    
<p><a href="https://github.com/igrishaev/pg2">PG2 version 0.1.18</a> is available (it’s a client for Postgres). This
release brings two major features:</p>

<ul>
  <li>built-in pgvector extension support;</li>
  <li>better type mapping between Postgres and Clojure.</li>
</ul>

<h2 id="pgvector-support">PGVector Support</h2>

<p>Pgvector is a <a href="https://github.com/pgvector/pgvector">well known extension</a> for PostgreSQL. It provides a
fast and robust vector type which is quite useful for heavy
computations. Pgvector also provides a sparse version of a vector to save space.</p>

<p>This section covers how to use types provided by the extension with PG2.</p>

<h3 id="vector">Vector</h3>

<p>First, install <code class="language-plaintext highlighter-rouge">pgvector</code> as the official readme file prescribes. Now that you
have it installed, try a simple table with the <code class="language-plaintext highlighter-rouge">vector</code> column:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">conn</span><span class="w">
  </span><span class="p">(</span><span class="nf">jdbc/get-connection</span><span class="w"> </span><span class="p">{</span><span class="n">...</span><span class="p">}))</span><span class="w">

</span><span class="p">(</span><span class="nf">pg/query</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="s">"create temp table test (id int, items vector)"</span><span class="p">)</span><span class="w">

</span><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="s">"insert into test values (1, '[1,2,3]')"</span><span class="p">)</span><span class="w">
</span><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="s">"insert into test values (2, '[1,2,3,4,5]')"</span><span class="p">)</span><span class="w">

</span><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="s">"select * from test order by id"</span><span class="p">)</span><span class="w">

</span><span class="c1">;; [{:id 1, :items "[1,2,3]"} {:id 2, :items "[1,2,3,4,5]"}]</span><span class="w">
</span></code></pre></div></div>

<p>It works, but we got the result unparsed: the <code class="language-plaintext highlighter-rouge">:items</code> field in each row is a
string. This is because, to take a custom type into account when encoding and
decoding data, you need to specify something. Namely, pass the <code class="language-plaintext highlighter-rouge">:with-pgvector?</code>
flag to the config map as follows:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">config</span><span class="w">
  </span><span class="p">{</span><span class="no">:host</span><span class="w"> </span><span class="s">"127.0.0.1"</span><span class="w">
   </span><span class="no">:port</span><span class="w"> </span><span class="mi">5432</span><span class="w">
   </span><span class="no">:user</span><span class="w"> </span><span class="s">"test"</span><span class="w">
   </span><span class="no">:password</span><span class="w"> </span><span class="s">"test"</span><span class="w">
   </span><span class="no">:database</span><span class="w"> </span><span class="s">"test"</span><span class="w">
   </span><span class="no">:with-pgvector?</span><span class="w"> </span><span class="n">true</span><span class="p">})</span><span class="w">

</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">conn</span><span class="w">
  </span><span class="p">(</span><span class="nf">jdbc/get-connection</span><span class="w"> </span><span class="n">config</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<p>Now the strings are parsed into a Clojure vector of <code class="language-plaintext highlighter-rouge">double</code> values:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="s">"select * from test order by id"</span><span class="p">)</span><span class="w">

</span><span class="p">[{</span><span class="no">:id</span><span class="w"> </span><span class="mi">1</span><span class="n">,</span><span class="w"> </span><span class="no">:items</span><span class="w"> </span><span class="p">[</span><span class="mf">1.0</span><span class="w"> </span><span class="mf">2.0</span><span class="w"> </span><span class="mf">3.0</span><span class="p">]}</span><span class="w">
 </span><span class="p">{</span><span class="no">:id</span><span class="w"> </span><span class="mi">2</span><span class="n">,</span><span class="w"> </span><span class="no">:items</span><span class="w"> </span><span class="p">[</span><span class="mf">1.0</span><span class="w"> </span><span class="mf">2.0</span><span class="w"> </span><span class="mf">3.0</span><span class="w"> </span><span class="mf">4.0</span><span class="w"> </span><span class="mf">5.0</span><span class="p">]}]</span><span class="w">
</span></code></pre></div></div>

<p>To insert a vector, pass it as a Clojure vector as well:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="s">"insert into test values ($1, $2)"</span><span class="w">
            </span><span class="p">{</span><span class="no">:params</span><span class="w"> </span><span class="p">[</span><span class="mi">3</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="mi">5</span><span class="p">]]})</span><span class="w">
</span></code></pre></div></div>

<p>It can be also a lazy collection of numbers produced by a <code class="language-plaintext highlighter-rouge">map</code> call:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="s">"insert into test values ($1, $2)"</span><span class="w">
            </span><span class="p">{</span><span class="no">:params</span><span class="w"> </span><span class="p">[</span><span class="mi">4</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="nb">inc</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="mi">5</span><span class="p">])]})</span><span class="w">
</span></code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">vector</code> column above doesn’t have an explicit size. Thus, vectors of any
size can be stored in that column. You can limit the size by providing it in
parentheses:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pg/query</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="s">"create temp table test2 (id int, items vector(5))"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>Now if you pass a vector of a different size, you’ll get an error response from
the database:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="s">"insert into test2 values (1, '[1,2,3]')"</span><span class="p">)</span><span class="w">

</span><span class="c1">;; Server error response: {severity=ERROR, code=22000, file=vector.c, line=77,</span><span class="w">
</span><span class="c1">;; function=CheckExpectedDim, message=expected 5 dimensions, not 3,</span><span class="w">
</span><span class="c1">;; verbosity=ERROR}</span><span class="w">
</span></code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">vector</code> type supports both text and binary modes of PostgreSQL wire
protocol.</p>

<h3 id="sparse-vector">Sparse Vector</h3>

<p>The <code class="language-plaintext highlighter-rouge">pgvector</code> extension provides a special <code class="language-plaintext highlighter-rouge">sparsevec</code> type to store vectors
where only certain elements are filled. All the rest elements are considered as
zero. For example, you have a vector of 1000 items where the 3rd item is 42.001,
and 10th item is 99.123. Storing it as a native vector of 1000 double numbers is
inefficient. It can be written as follows which takes much less:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{3:42.001,10:99.123}/1000
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">sparsevec</code> Postgres type acts exactly like this: internally, it’s a sort of
a map that stores the size (1000) and the <code class="language-plaintext highlighter-rouge">{index -&gt; value}</code> mapping. An
important note is that <strong>indexes are counted from one, not zero</strong> (see the
README.md file of the extension for details).</p>

<p>PG2 provides a special wrapper for a sparse vector. A brief demo:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="s">"create temp table test3 (id int, v sparsevec)"</span><span class="p">)</span><span class="w">

</span><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="s">"insert into test3 values (1, '{2:42.00001,7:99.00009}/9')"</span><span class="p">)</span><span class="w">

</span><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="s">"select * from test3"</span><span class="p">)</span><span class="w">

</span><span class="c1">;; [{:v &lt;SparseVector {2:42.00001,7:99.00009}/9&gt;, :id 1}]</span><span class="w">
</span></code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">v</code> field above is an instance of the <code class="language-plaintext highlighter-rouge">org.pg.type.SparseVector</code>
class. Let’s look at it closer:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">;; put it into a separate variable</span><span class="w">
</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">-sv</span><span class="w">
  </span><span class="p">(</span><span class="nb">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="s">"select * from test3"</span><span class="p">)</span><span class="w">
      </span><span class="nb">first</span><span class="w">
      </span><span class="no">:v</span><span class="p">))</span><span class="w">

</span><span class="p">(</span><span class="nf">type</span><span class="w"> </span><span class="n">-sv</span><span class="p">)</span><span class="w">

</span><span class="n">org.pg.type.SparseVector</span><span class="w">
</span></code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">-sv</code> value has a number of interesting traits. To turn in into a native
Clojure map, just <code class="language-plaintext highlighter-rouge">deref</code> it:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">-sv</span><span class="w">

</span><span class="p">{</span><span class="no">:nnz</span><span class="w"> </span><span class="mi">2</span><span class="n">,</span><span class="w"> </span><span class="no">:index</span><span class="w"> </span><span class="p">{</span><span class="mi">1</span><span class="w"> </span><span class="mf">42.00001</span><span class="n">,</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mf">99.00009</span><span class="p">}</span><span class="n">,</span><span class="w"> </span><span class="no">:dim</span><span class="w"> </span><span class="mi">9</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>It mimics the <code class="language-plaintext highlighter-rouge">nth</code> access as the standard Clojure vector does:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nb">nth</span><span class="w"> </span><span class="n">-sv</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="c1">;; 0.0</span><span class="w">
</span><span class="p">(</span><span class="nb">nth</span><span class="w"> </span><span class="n">-sv</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="c1">;; 42.00001</span><span class="w">
</span><span class="p">(</span><span class="nb">nth</span><span class="w"> </span><span class="n">-sv</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="c1">;; 0.0</span><span class="w">
</span></code></pre></div></div>

<p>To turn in into a native vector, just pass it into the <code class="language-plaintext highlighter-rouge">vec</code> function:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">vec</span><span class="w"> </span><span class="n">-sv</span><span class="p">)</span><span class="w">

</span><span class="p">[</span><span class="mf">0.0</span><span class="w"> </span><span class="mf">42.00001</span><span class="w"> </span><span class="mf">0.0</span><span class="w"> </span><span class="mf">0.0</span><span class="w"> </span><span class="mf">0.0</span><span class="w"> </span><span class="mf">0.0</span><span class="w"> </span><span class="mf">99.00009</span><span class="w"> </span><span class="mf">0.0</span><span class="w"> </span><span class="mf">0.0</span><span class="p">]</span><span class="w">
</span></code></pre></div></div>

<p>There are several ways you can insert a sparse vector into the database. First,
pass an ordinary vector:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="s">"insert into test3 values ($1, $2)"</span><span class="w">
            </span><span class="p">{</span><span class="no">:params</span><span class="w"> </span><span class="p">[</span><span class="mi">2</span><span class="w"> </span><span class="p">[</span><span class="mi">5</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="p">]]})</span><span class="w">
</span></code></pre></div></div>

<p>Internally, zero values get eliminated, and the vector is transformed into a
<code class="language-plaintext highlighter-rouge">SparseVector</code> instance. Now read it back:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="s">"select * from test3 where id = 2"</span><span class="p">)</span><span class="w">

</span><span class="p">[{</span><span class="no">:v</span><span class="w"> </span><span class="n">&lt;SparseVector</span><span class="w"> </span><span class="p">{</span><span class="mi">1</span><span class="no">:5.0,2:2.0,3:6.0,5:2.0,6:5.0</span><span class="p">}</span><span class="n">/8&gt;,</span><span class="w"> </span><span class="no">:id</span><span class="w"> </span><span class="mi">2</span><span class="p">}]</span><span class="w">
</span></code></pre></div></div>

<p>The second way is to pass a <code class="language-plaintext highlighter-rouge">SparseVector</code> instance produced by the
<code class="language-plaintext highlighter-rouge">pg.type/-&gt;sparse-vector</code> function. It accepts the size of the vector and a
mapping of <code class="language-plaintext highlighter-rouge">{index =&gt; value}</code>:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">require</span><span class="w"> </span><span class="o">'</span><span class="p">[</span><span class="n">pg.type</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">t</span><span class="p">])</span><span class="w">

</span><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="s">"insert into test3 values ($1, $2)"</span><span class="w">
            </span><span class="p">{</span><span class="no">:params</span><span class="w"> </span><span class="p">[</span><span class="mi">3</span><span class="w"> </span><span class="p">(</span><span class="nf">t/-&gt;sparse-vector</span><span class="w"> </span><span class="mi">9</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="w"> </span><span class="mf">523.23423</span><span class="w">
                                              </span><span class="mi">7</span><span class="w"> </span><span class="mf">623.52346</span><span class="p">})]})</span><span class="w">
</span></code></pre></div></div>

<p>Finally, you can pass a string representation of a sparse vector:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="s">"insert into test3 values ($1, $2)"</span><span class="w">
            </span><span class="p">{</span><span class="no">:params</span><span class="w"> </span><span class="p">[</span><span class="mi">3</span><span class="w"> </span><span class="s">"{1:5.0,2:2.0,3:6.0,5:2.0,6:5.0}/8"</span><span class="p">]})</span><span class="w">
</span></code></pre></div></div>

<p>Like the <code class="language-plaintext highlighter-rouge">vector</code> type, <code class="language-plaintext highlighter-rouge">sparsevec</code> can be also limited to a certain size:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">create</span> <span class="k">table</span> <span class="p">...</span> <span class="p">(</span><span class="n">id</span> <span class="nb">int</span><span class="p">,</span> <span class="n">items</span> <span class="n">sparsevec</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">sparsevec</code> type supports both binary and text Postgres wire protocol.</p>

<h3 id="custom-schemas">Custom Schemas</h3>

<p>The text above assumes you have the <code class="language-plaintext highlighter-rouge">pgvector</code> extension installed globally
meaning it is hosted in the <code class="language-plaintext highlighter-rouge">public</code> schema. Sometimes though, extensions are
setup per schema. For example only a schema named <code class="language-plaintext highlighter-rouge">sales</code> has access to the
<code class="language-plaintext highlighter-rouge">pgvector</code> extension but nobody else.</p>

<p>If it’s your case and you installed <code class="language-plaintext highlighter-rouge">pgvector</code> into a certain schema, the
standard <code class="language-plaintext highlighter-rouge">:with-pgvector?</code> flag won’t work. By default, PG2 scans the <code class="language-plaintext highlighter-rouge">pg_types</code>
table for the <code class="language-plaintext highlighter-rouge">public.vector</code> and <code class="language-plaintext highlighter-rouge">public.sparsevec</code> types. Since the schema
name is not <code class="language-plaintext highlighter-rouge">public</code> but <code class="language-plaintext highlighter-rouge">sales</code>, you need to specify it by passing a special
option called <code class="language-plaintext highlighter-rouge">:type-map</code>. It’s a map where keys are fully qualified type names
(either a keyword or a string), and values are predefined instances of the
<code class="language-plaintext highlighter-rouge">IProcessor</code> interface:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">config</span><span class="w">
  </span><span class="p">{</span><span class="no">:host</span><span class="w"> </span><span class="s">"127.0.0.1"</span><span class="w">
   </span><span class="no">:port</span><span class="w"> </span><span class="mi">5432</span><span class="w">
   </span><span class="no">:user</span><span class="w"> </span><span class="s">"test"</span><span class="w">
   </span><span class="no">:password</span><span class="w"> </span><span class="s">"test"</span><span class="w">
   </span><span class="no">:database</span><span class="w"> </span><span class="s">"test"</span><span class="w">
   </span><span class="no">:type-map</span><span class="w"> </span><span class="p">{</span><span class="s">"sales.vector"</span><span class="w"> </span><span class="n">t/vector</span><span class="w">
              </span><span class="s">"sales.sparsevec"</span><span class="w"> </span><span class="n">t/sparsevec</span><span class="p">}})</span><span class="w">
</span></code></pre></div></div>

<p>You can rely on keywords as well:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">config</span><span class="w">
  </span><span class="p">{</span><span class="no">:host</span><span class="w"> </span><span class="s">"127.0.0.1"</span><span class="w">
   </span><span class="no">:port</span><span class="w"> </span><span class="mi">5432</span><span class="w">
   </span><span class="no">:user</span><span class="w"> </span><span class="s">"test"</span><span class="w">
   </span><span class="no">:password</span><span class="w"> </span><span class="s">"test"</span><span class="w">
   </span><span class="no">:database</span><span class="w"> </span><span class="s">"test"</span><span class="w">
   </span><span class="no">:type-map</span><span class="w"> </span><span class="p">{</span><span class="no">:sales/vector</span><span class="w"> </span><span class="n">t/vector</span><span class="w">
              </span><span class="no">:sales/sparsevec</span><span class="w"> </span><span class="n">t/sparsevec</span><span class="p">}})</span><span class="w">
</span></code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">t</code> alias references the <code class="language-plaintext highlighter-rouge">pg.type</code> namespace.</p>

<p>Now if you install the extension into the <code class="language-plaintext highlighter-rouge">statistics</code> schema as well, add it
into the map:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">config</span><span class="w">
  </span><span class="p">{</span><span class="no">:host</span><span class="w"> </span><span class="s">"127.0.0.1"</span><span class="w">
   </span><span class="no">:port</span><span class="w"> </span><span class="mi">5432</span><span class="w">
   </span><span class="no">:user</span><span class="w"> </span><span class="s">"test"</span><span class="w">
   </span><span class="no">:password</span><span class="w"> </span><span class="s">"test"</span><span class="w">
   </span><span class="no">:database</span><span class="w"> </span><span class="s">"test"</span><span class="w">
   </span><span class="no">:type-map</span><span class="w"> </span><span class="p">{</span><span class="no">:sales/vector</span><span class="w"> </span><span class="n">t/vector</span><span class="w">
              </span><span class="no">:sales/sparsevec</span><span class="w"> </span><span class="n">t/sparsevec</span><span class="w">
              </span><span class="no">:statistics/vector</span><span class="w"> </span><span class="n">t/vector</span><span class="w">
              </span><span class="no">:statistics/sparsevec</span><span class="w"> </span><span class="n">t/sparsevec</span><span class="p">}})</span><span class="w">
</span></code></pre></div></div>

<p>Should you make a mistake in a fully qualified type name, it will be ignored,
and you’ll get value from the database unparsed. The actual value depends on the
binary encoding and decoding options of a connection. By default, it uses text
protocol so you’ll get a string like “[1, 2, 3]”. For binary encoding and
decoding, you’ll get a byte array that holds raw Postgres payload.</p>

<h2 id="custom-type-processors">Custom Type Processors</h2>

<p>PG2 version 0.1.18 has the entire type system refactored. It introduces a
conception of type processors which allows to connect Postgres types with
Java/Clojure ones with ease.</p>

<p>When reading data from Postgres, the client knows only the OID of a type of a
column. This OID is just an integer number points to a certain type. The default
builtin types are hard-coded in Postgres, and thus their OIDs are known in
advance.</p>

<p>Say, it’s for sure that the <code class="language-plaintext highlighter-rouge">int4</code> type has OID 23, and <code class="language-plaintext highlighter-rouge">text</code> has
OID 25. That’s true for any Postgres installation. Any Postgres client has a
kind of a hash map or a Enum class with these OIDs.</p>

<p>Things get worse when you define custom types. These might be either enums or
complex types defined by extensions: <code class="language-plaintext highlighter-rouge">pgvector</code>, <code class="language-plaintext highlighter-rouge">postgis</code> and so on. You cannot
guess OIDs of types any longer because they are generated in runtime. Their
actual values depend on a specific machine. On prod, the <code class="language-plaintext highlighter-rouge">public.vector</code> type
has OID 10541, on pre-prod it’s 9621, and in Docker you’ll get 1523.</p>

<p>Moreover, a type name is unique only across a schema that’s holding it. You can
easily have two different enum types called <code class="language-plaintext highlighter-rouge">status</code> defined in various
schemas. Thus, relying on a type name is not a good option unless it’s fully
qualified.</p>

<p>To deal with all said above, a new conception of type mapping was introduced.</p>

<p>First, if a certain OID is builtin (meaning it exists the list of predefined
OIDs), it gets processed as before.</p>

<p>When you connect to a database, you can pass a mapping like <code class="language-plaintext highlighter-rouge">{schema.typename =&gt;
Processor}</code>. When pg2 has established a connection, it executes an internal
query to discover type mapping. Namely, it reads the <code class="language-plaintext highlighter-rouge">pg_type</code> table to get OIDs
that have provided schemas and type name. The query looks like this:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span>
    <span class="n">pg_type</span><span class="p">.</span><span class="n">oid</span><span class="p">,</span> <span class="n">pg_namespace</span><span class="p">.</span><span class="n">nspname</span> <span class="o">||</span> <span class="s1">'.'</span> <span class="o">||</span> <span class="n">pg_type</span><span class="p">.</span><span class="n">typname</span> <span class="k">as</span> <span class="k">type</span>
<span class="k">from</span>
    <span class="n">pg_type</span><span class="p">,</span> <span class="n">pg_namespace</span>
<span class="k">where</span>
    <span class="n">pg_type</span><span class="p">.</span><span class="n">typnamespace</span> <span class="o">=</span> <span class="n">pg_namespace</span><span class="p">.</span><span class="n">oid</span>
    <span class="k">and</span> <span class="n">pg_namespace</span><span class="p">.</span><span class="n">nspname</span> <span class="o">||</span> <span class="s1">'.'</span> <span class="o">||</span> <span class="n">pg_type</span><span class="p">.</span><span class="n">typname</span> <span class="k">in</span> <span class="p">(</span>
        <span class="s1">'schema1.type1'</span><span class="p">,</span>
        <span class="s1">'schema2.type2'</span><span class="p">,</span>
        <span class="p">...</span>
    <span class="p">);</span>
</code></pre></div></div>

<p>It returns pairs of OID and the full type name:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>121512 | schema1.type1
 21234 | schema2.type2
</code></pre></div></div>

<p>Now PG2 knows that the OID 121512 specifies <code class="language-plaintext highlighter-rouge">schema1.type1</code> but nothing else.</p>

<p>Finally, from the map <code class="language-plaintext highlighter-rouge">{schema.typename =&gt; Processor}</code> you submitted before, PG2
builds a map <code class="language-plaintext highlighter-rouge">{OID =&gt; Processor}</code>. If the OID is not a default one, it checks
this map trying to find a processor object.</p>

<p>A processor object is an instance of the <code class="language-plaintext highlighter-rouge">org.pg.processor.IProcessor</code>
interface, or, if more precisely, an abstract <code class="language-plaintext highlighter-rouge">AProcessor</code> which is partially
implemented. It has four methods:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">ByteBuffer</span> <span class="nf">encodeBin</span><span class="o">(</span><span class="nc">Object</span> <span class="n">value</span><span class="o">,</span>  <span class="nc">CodecParams</span> <span class="n">codecParams</span><span class="o">);</span>
    <span class="nc">String</span> <span class="nf">encodeTxt</span><span class="o">(</span><span class="nc">Object</span> <span class="n">value</span><span class="o">,</span>  <span class="nc">CodecParams</span> <span class="n">codecParams</span><span class="o">);</span>
    <span class="nc">Object</span> <span class="nf">decodeBin</span><span class="o">(</span><span class="nc">ByteBuffer</span> <span class="n">bb</span><span class="o">,</span> <span class="nc">CodecParams</span> <span class="n">codecParams</span><span class="o">);</span>
    <span class="nc">Object</span> <span class="nf">decodeTxt</span><span class="o">(</span><span class="nc">String</span> <span class="n">text</span><span class="o">,</span>   <span class="nc">CodecParams</span> <span class="n">codecParams</span><span class="o">);</span>
</code></pre></div></div>

<p>Depending on whether you’re decoding (reading) the data or encoding them
(e.g. passing parameters), and the current format (text or binary), a
corresponding method is called. By extending all four methods, you can handle
any type you want.</p>

<p>At the moment, there are about 25 processors implementing standard types:
<code class="language-plaintext highlighter-rouge">int2</code>, <code class="language-plaintext highlighter-rouge">int4</code>, <code class="language-plaintext highlighter-rouge">text</code>, <code class="language-plaintext highlighter-rouge">float4</code>, and so on. Find them in the
<code class="language-plaintext highlighter-rouge">pg-core/src/java/org/pg/processor</code> directory. There is also a couple of
processors for the <code class="language-plaintext highlighter-rouge">pgvector</code> extension in the <code class="language-plaintext highlighter-rouge">pgvector</code> subdirectory.</p>

<p>The next step is to implement processors for the <code class="language-plaintext highlighter-rouge">postgis</code> extension.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/android-mem-2/">Память у Андроида (2)</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2024-11-01T00:00:00+00:00">
        Nov 1, 2024
    </time>

    <a href="/tag/android/" rel="tag">android</a>, <a href="/tag/memory/" rel="tag">memory</a>, <a href="/tag/storage/" rel="tag">storage</a>

</div>


            <div class="entry">
                
                    <p>Продолжение <a href="/android-mem-1/">прошлой заметки</a> про Андроид.</p>

<p>На мой взгляд, 90 процентов всех телефонов страдают от нехватки места. Сценарий
один и тот же: человек покупает телефон и фотографирует каждый угол. Еще
он ставит три мессенджера, и в каждом ему присылают прикольные видосы и
гифки. Проходит полгода, и места не остается.</p>

<p>Человек запускает менеджер очистки, но это сплошное издевательство. Менеджер
говорит: у тебя занято 20 гигов фотками и видео, удаляй сам. А так я могу
очистить временные файлы на сумму 30 мегабайтов.</p>

<p>Я проходил это десять раз, не меньше. Покупаешь телефон маме, жене, детям,
родственникам — и через полгода они приходят к тебе с вопросом “закончилось
место”. Ты скидываешь фотки на комп, и на год тебя оставляют в покое.</p>

<p>Я понимаю, проблему с местом было трудно предсказать, когда Андроид только
вышел. Но на третий-четвертый год это стало очевидно: места никогда не хватает,
аппетиты пользователей растут, ровно и как возможности приложений.</p>

<p>Принято считать, что за местом должен следить пользователь: регулярно смотреть
статистику, удалять файлы, настраивать кеши в мессенджерах. Да, некоторые это
делают. Но как должны справляться с этим обычные люди? Скажем, чтобы настроить
кеш в Телеграме, нужно нажать многоточие, потом гайку, потом смотаться до Data &amp;
Storage, и там выставить опции. Вы считаете, ваша мама это сделает? А потом то
же самое в Вацапе и Вайбере?</p>

<p>Когда я на это жалуюсь, мне говорят — что ты хотел? Тут ничего не поделаешь. А
на самом деле поделать можно много чего.</p>

<p>Заботу о диске должна брать на себя операционная система. Во-первых, если
свободного места меньше 70%, то старые фотки уменьшаются в
разрешении. Современные телефоны производят джипеги по 3-7 магабайтов — такие
фотографии можно печатать в натуральный рост. Это, мягко говоря, избыточно для
экрана размером с ладонь. Когда места перестает хватать, старые фотки сжимаются
до 700 килобайт, освобождая от 2.5 до 5 магабайтов. Сто фоток — полгига.</p>

<p>Разумеется, этот процесс должен действовать тонко, а именно: брать самые
неиспользуемые фотки; пропускать те, которые отмеченные лайком или которые
пользователь часто открывает. Это не подойдет свадебным фотографом, но и
организация фото у таких людей выстроена не так, как у обывателей.</p>

<p>То же самое с видео: если сейчас ночь, и заряд батареи выше порога, то берется
старое видео и перегоняется в низкое разрешение. Как и в случае с джипегами, на
экране размером в ладонь никто не заметит разницы, а это дает 200-300 мегов с
каждого ролика.</p>

<p>Насчет кешей и разбухающих приложений. Ожидать, что человек откроет каждое
приложение и все настроит — идиотизм. Когда системе не хватает места, она
рассылает приложениям системный вызов а-ля “срочно удали кеши”. Можно добавить
параметр — уровень критичности. Если он зеленый, то можно ничего не удалять,
если желтый — удалить все данные, кроме последнего месяца, если красный — то
все.</p>

<p>Вы скажете, что никто не будет этого делать. А между прочим, это в интересах
самих приложений. Потому что если на телефоне 2% свободного места, то
пользоваться условным Телеграмом невозможно. А если каждое приложение освободит
по 200-400 мегабайтов, то в сумме будет пара гигов, и телефон худо-бедно
заработает.</p>

<p>Наконец, самое важное — старые данные можно удалять без спроса пользователя. Да,
вот так просто взять и удалить. Объяснение этому простое: представьте, что
человек собрался в компании и хочет снять видео. А места нет. И у нас выбор:
либо сказать, что места нет и заставить чистить файлы самому, либо удалить
фотографии пятилетней давности, которые человек ни разу не открывал. Что лучше?</p>

<p>В большинстве случаев — второе, потому что человеку интересно то, что происходит
сейчас. Ему важно записать видео именно пока он в компании, а не удалять файлы,
пока остальные веселятся. Интерес к фото и видео можно представить как правую
половину гауссианы: она резко спадает во времени, и нет беды в том, чтобы
подчищать старье за пользователя.</p>

<p>Если хотите, аналогия. Современные телефоны работают как резервуар: сначала он
наполняется, а если вливать больше, то польется мимо. Это неправильно: телефон
должен быть как проточный бассейн с входом и выходом. Когда в него вливается
сверх меры, то с другой стороны выливается.</p>

<p>По такому принципу телефон может работать годами, не вынося владельцу мозг
нехваткой места.</p>

<p>Допускаю, что есть программы, которые умеют что-то подобное, но это сторонние
программы, их нужно ставить, покупать, разбираться с ними. Нет из коробки — нет
как такового. А еще телефон, который вместо двух лет прослужил бы пять, мягко
говоря, не согласуется с бизнес-моделью всяких Гуглов, Ксяоми и прочих.</p>

<p>Хочу лишь показать — многие вещи можно переосмыслить, и технически они
возможны. Дело в бизнесе и отношении к ним.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/android-mem-1/">Память у Андроида (1)</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2024-11-01T00:00:00+00:00">
        Nov 1, 2024
    </time>

    <a href="/tag/android/" rel="tag">android</a>, <a href="/tag/memory/" rel="tag">memory</a>, <a href="/tag/storage/" rel="tag">storage</a>

</div>


            <div class="entry">
                
                    <p>В Андроидах — я имею в виду телефоны — мне не нравится одна вещь, которая там с
рождения. Это вечная борьба с тем, кто и куда пишет: во внутреннюю память или на
сд-карту.</p>

<p>Правило большого пальца: телефон всегда пишет не туда. А если сегодня туда, то
через месяц все слетит. Можно купить огромную SD-карту, чтобы не засорять
память, но телефон будет упорно писать в память, игнорируя карту.</p>

<p>Еще есть настройка, куда по умолчанию ставить приложения. Это тоже важно, потому
что телеграмы-хромы раздуваются до пяти гигов.</p>

<p>Разумеется, в Андроиде нет централизованной настройки, что и куда писать. Нужно
открыть камеру, многоточие, гайки и там выбрать SD-карту. Приложения
настраиваются отдельно — то ли в Google Play, то ли еще где. Перенос приложений
между памятью и картой — это кровавая боль. Нельзя выделить и перенести сразу
десять приложений. Нужно вручную останавливать каждое и переносить.</p>

<p>Пишу это, потому что наболело. Жена пожаловалась, что телефон Xiaomi тормозит. В
нем 32 гига памяти, и дополнительно я вставил карту на 32 гига. Везде указал
приоритет записи на карту. И что вы думаете? Каким-то образом настройки слетели,
и память оказалась забита видео и фотками под ноль. На карте 20 гиг свободного
места, а телефон едва ворочается. Открывает менеджер диска, запускает
сканирование и говорит: могу освободить аж 30 мегабайтов за счет каких-то там
темповых файлов.</p>

<p>Просто какая-то дичь. Что мешает переместить фотки на SD-карту в фоне?
Пользователь ничего не заметит. У нас везде ИИ, всякие модели, предсказание фраз
и покупок — и блин, телефон не может перетащить фотки. Он будет тормозить,
тупить, но ни в коем случае не решит проблему.</p>

<p>Это беда каждого Андроида: за пять тысяч рублей, за пятьдесят, за сто
пятьдесят. Она была пятнадцать лет назад, когда я купил первый смарт на втором
Андроиде. Она есть сейчас, она будет еще через пятнадцать лет.</p>

<p>Я согласен, что иметь память и съемную карту удобно в техническом плане. Но на
практике это напоминает Линукс: вы <strong>можете</strong> настроить что угодно, и поэтому
<strong>всегда будете</strong> настраивать все, что угодно.</p>

<p><a href="/android-mem-2/">Продолжение</a></p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/no-copyright/">Авторское право</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2024-10-29T00:00:00+00:00">
        Oct 29, 2024
    </time>

    <a href="/tag/copyright/" rel="tag">copyright</a>, <a href="/tag/books/" rel="tag">books</a>, <a href="/tag/life/" rel="tag">life</a>

</div>


            <div class="entry">
                
                    <p>Интернет прощается со Стивером — анонимным создателем пиратской библиотеки
Флибуста. Я ей никогда не пользовался, но краем уха слышал о сообществе и
создателе. Его уверенность в своем деле вызывала уважение, ровно как и
добровольный уход из жизни методом эвтаназии — не каждый решится на этот шаг.</p>

<p>Его уход напомнил мне об отношению к авторскому праву. На мой взгляд, любое
авторское право должно быть конечным и не передаваться по наследству. Это
работает так: в течение десяти-двадцати лет ты продаешь книгу, получаешь
гонорар. Но потом она становится достоянием общественности, и ее можно печатать
и продавать кому угодно. Можно снять фильм или сериал, использовать персонажей в
любом сеттинге, не опасаясь судебных исков.</p>

<p>Двадцати лет авторства более чем достаточно, чтобы выручить денег за
произведение. Этого хватит на проживание и пенсию. Может даже хватить на
обучение детям и покупку им квартир-машин.</p>

<p>Более важный факт — авторское право не должно передаваться по наследству. Мне
кажется бредовой ситуация, когда условная внучка Агаты Кристи указывает
издательствам, что и когда печатать, а также вносит правки в соответствии с
повесткой из телевизора. Так и хочется ей сказать: дорогая, а не пошла бы ты в
жопу? Произведения Кристи — классика, с какой стати тебе наживаться на таланте
бабушки?</p>

<p>То же самое я бы сказал Успенскому, который судится из-за персонажей
“Простоквашино”. Формально ты автор, но персонажи ушли в народ, стали
фольклором. Придумай новых персонажей и зарабатывай на них. Хочешь, чтобы как у
Чижа — “всю жизнь получать гонорар”?</p>

<p>То же самое касается фильмов, сериалов, научных статей, книг, комиксов,
фотографий, рисунков… продолжите список сами.</p>

<p>Объяснение простое: каждый продукт основан на опыте прошлых поколений. Общий
уровень развития общества, язык, городской дизайн — все это создает фон, рельеф,
на котором формируются продукты. Посчитать и оценить его
невозможно. Представьте, что Кирилл и Мефодий ожили и требуют отчислений с
каждого продукта за использование кириллицы? Это примерно то, что происходит
сегодня.</p>

<p>То же самое относится к айтишным продуктам. Каждые 10-20 лет разработчик
лишается авторского права на продукт, и он становится общественным. Нужно
уточнить — не на сегодняшний продукт, а его прошлую версию. Другими словами,
Windows 10 по-прежнему остается коммерческой и закрытой, а Windows XP обязаны
передать в общественное достояние. И через 10-15 лет то же самое произойдет с
Windows 10.</p>

<p>Разумеется, сегодня это звучит глупо и даже преступно. Но возможно, появится
государство, где будет иной взгляд на авторское право, и оно сможет
сосуществовать с другими государствами. В конец концов, современный взгляд на
право не должен считаться конечным — по аналогии, еще 300 лет назад люди не
представляли себе общество без рабства. Не нужно быть такими же — все вопросы,
даже самые щекотливые, нужно время от времени пересматривать.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/west-propaganda/">О пропаганде</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2024-10-28T00:00:00+00:00">
        Oct 28, 2024
    </time>

    <a href="/tag/life/" rel="tag">life</a>, <a href="/tag/propaganda/" rel="tag">propaganda</a>, <a href="/tag/1984/" rel="tag">1984</a>

</div>


            <div class="entry">
                
                    <p>Когда западный человек пишет о пропаганде в России, нужно понимать — он знает об
этом из собственной пропаганды.</p>

<p>В понимании европейца жизнь в России выглядит как повесть 1984. На каждом углу
висит монитор, где Путин призывает давить танками Европу. Россиянин, если не
занят на работе, постоянно смотрит внутреннее ТВ. Все каналы информации заняты
только пропагандой. Сеть заполонили фабрики троллей: люди, которые пишут
пропаганду за деньги под видом обывателей.</p>

<p>Это, мягко говоря, не так. Аудитория государственных каналов падает уже много
лет, и ничего поделать с этим нельзя. Популярны онлайн-кинотеатры и тематические
каналы (спорт, сериалы). Фабрики троллей были проблемой лет десять назад во
времена олимпиады в Сочи. От них страдали многие площадки, и со временем кто-то
вообще убрал комментарии, кто-то ввел пост-модерацию, кто-то ужесточил
регистрацию с подтверждением по телефону.</p>

<p>Нужно понимать, что жизнь европейца не отличается от уклада жизни в России. Мы
ведь не на разных планетах, и у нас не разное число голов. Европеец горбатится в
офисе, читает Фейсбук(1) и Твиттер(2), вечером смотрит сериалы и Би-Би-Си. А
Би-Би-Си — то же самое, что Первый канал: площадка, которая освещает повестку
государства. Другими словами, там показывают то, что хочет текущий
режим. Техника и подход разные, смысл одинаков.</p>

<p>Из государственных новостей европеец знает, что в России все заполонила
пропаганда, а любая реплика в интернете оставлена либо ботом, либо оплаченным
троллем. Разумеется, европеец не ходит на российские сайты, не читает их через
гугл-переводчик, не состоит в русских сообществах. Зачем, если по телевизору все
объяснили?</p>

<p>Спорить в данном случае бесполезно, потому что получается взаимоблокирующая
ситуация: собеседник говорит о пропаганде, слушая пропаганду.</p>

<p>Пишу это, потому что неприятно удивлен, услышав подобные речи от человека,
(ранее) уважаемого мной за вклад в айти. Может быть, получится написать об этом
подробней, но не сейчас — сказанного уже достаточно, чтобы хорошенько подумать.</p>

<p><a href="/linux-maintainers/">UPD: продолжение</a></p>

<p><em>1,2 — запрещенные, нежелательные, экстремистские и т.д. организации.</em></p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/pripev/">Разные припевы</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2024-10-28T00:00:00+00:00">
        Oct 28, 2024
    </time>

    <a href="/tag/songs/" rel="tag">songs</a>, <a href="/tag/music/" rel="tag">music</a>

</div>


            <div class="entry">
                
                    <p>Почти любая песня строится по шаблону: куплет, припев, куплет, припев, проигрыш,
припев, припев, припев. Этот принцип лежит во всех песнях Linkin Park, Korn,
Cold, Queen и других исполнителей. Порой видно, что автор удачно сочинил припев,
а с остальным не задалось: куплеты — просто мясо, чтобы занять окно между
припевами.</p>

<p>Но бывают песни, где припевы разные. Слушатель понимает, что это припев по
усилению в музыке, но слова звучат другие. Я это люблю и всегда отмечаю.</p>

<p>На ум приходит пара примеров. Первый — Pink Floyd. Их классические песни
строились иначе: сначала Роджер Уотерс писал стихи, а потом их накладывали на
музыку. Поэтому нет такого, что одно четверостишие повторяется пять раз. Песни:
Time, Echoes, Us plus Them, альбомы Animals, The Wall.</p>

<p>Второй пример — песни Диснея, особенно из “Холодного Сердца”. Я разбирал их на
уроках английского: поразила плотность текста, игра слов, двойной смысл. В этих
песнях разные припевы: хотя опорная фраза повторяется (Let it go, let it go или
For the first time in forever), после нее идут другие слова, которые продолжают
тему куплета. Другие мульты с богатым саундтреком: Покахонтас, Моана.</p>

<p>Горячо советую послушать то и другое.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/pagination/">Пагинация</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2024-10-28T00:00:00+00:00">
        Oct 28, 2024
    </time>

    <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/postgres/" rel="tag">postgres</a>, <a href="/tag/limit/" rel="tag">limit</a>, <a href="/tag/offset/" rel="tag">offset</a>, <a href="/tag/pagination/" rel="tag">pagination</a>, <a href="/tag/backend/" rel="tag">backend</a>

</div>


            <div class="entry">
                
                    <p>Не люблю, когда для обхода данных нужна пагинация. Всякие <code class="language-plaintext highlighter-rouge">LIMIT/OFFSET</code>,
<code class="language-plaintext highlighter-rouge">nextToken</code> и прочие костыли.</p>

<p>Я понимаю, что нельзя отдать все одним запросом, поэтому делается апишка с
пагинацией. Но не понимаю, почему не пишут функцию, которая пагинирует сама и
возвращает ленивую коллекцию. Чтобы раз — зарядил один цикл <code class="language-plaintext highlighter-rouge">for</code>, и оно внутри
само пагинируется: пробрасываются токены, офсеты и остальное.</p>

<p>Я всегда пишу такую функцию, чтобы не бодаться с пагинацией. Ведь что такое
пагинация? Это минное поле багов. Нужно проверить, что не ошибся на единицу, что
нет пересечения в результатах, что проверил последний результат на пустоту, что
не ушел в бесконечный цикл… отловить все это в тестах невозможно. Нужен
реальный источник данных плюс сами данные.</p>

<p>Даже если в языке нет ленивых коллекций, то наверняка есть итераторы или
стримы. Скажем, смотрю на джавный S3 SDK. Есть метод <code class="language-plaintext highlighter-rouge">listObjects</code>, который
вернет до тысячи объектов. Нужен следующий чанк — прокидывай <code class="language-plaintext highlighter-rouge">nextToken</code>. А что
мешало написать метод, который вернет <code class="language-plaintext highlighter-rouge">Iterator&lt;ListObjectResult&gt;</code> или
<code class="language-plaintext highlighter-rouge">Stream&lt;S3Object&gt;</code>? Ведь это же так просто.</p>

<p>Поэтому правило: если нельзя отдать одним запросом, то хотя бы дай функцию,
которая пагинирует сама.</p>

<p>Более широкий тезис: источник данных хорош настолько, насколько легко забрать из
него данные. Скажем, знаете ли вы, насколько кривая апишка у OpenSearch? У него
нет встроенной функции “дай мне все” или “сбрось данные в CSV”. Для забора
данных нужны две апишки. Первая вернет <code class="language-plaintext highlighter-rouge">ScrollID</code> и первый чанк данных. Далее
нужно вызывать другую апишку с этим скроллом, пока не соберешь остальные
данные. При этом ты обязан сообщить время жизни скролла, после которого он
умирает. Время должен прикинуть сам на глазок.</p>

<p>На практике это два экрана кода плюс отладка на стейджинге. После этого на код
запрещено дышать, чтобы не сломалось. На фоне этой мерзости только одно утешение
— Постгрес. Его апишка <code class="language-plaintext highlighter-rouge">COPY</code> гоняет миллионы записей в обе стороны,
поддерживает три(!) формата, простая как лопата, быстрая как не знаю что.</p>

<p>Пагинация все еще необходима из-за ограничений. Но во-первых, ее всегда можно
чем-то прикрыть, а во-вторых — иногда избежать.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/linux-maintainers/">О событиях с Линуксом</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2024-10-28T00:00:00+00:00">
        Oct 28, 2024
    </time>

    <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/life/" rel="tag">life</a>, <a href="/tag/linux/" rel="tag">linux</a>

</div>


            <div class="entry">
                
                    
<p>Очевидно, что <a href="/west-propaganda/">последняя заметка</a> вызвана событиями вокруг Линукса и
русских разработчиков. Скорее всего, вы в курсе, но на всякий случай напомню,
что произошло.</p>

<p>Несколько дней назад один из руководителей Linux Foundation разослал письмо, что
сразу одиннадцать разработчиков лишаются статуса ментейнеров
ядра. Примечательно, что у всех были русские имена, а почта — преимущественно на
домене <code class="language-plaintext highlighter-rouge">mail.ru</code>.</p>

<p>Нужно уточнить, что ментейнер — нечто большее, чем линейный контрибьютор. От
последнего он отличается большими полномочиями, например, имеет право одобрять
патчи контрибьюторов. Ментейнер — это более высокая должность, авторитет,
ответственность.</p>

<p>В том письме были крайне расплывчатые формулировки: санкции, обратитесь к
юристу, сотрудничество с вами “ограничено”, предъявите документацию. Что значит
“ограниченно”? Что за документацию, кому и в какой срок предоставить — не ясно.</p>

<p>Общественность слегка удивилась, но замерла в ожидании, что скажет
Линус. Очевидно, такое событие не могло пройти его стороной.</p>

<p>Линус ответил, и интернет порвался. В грубой манере он написал четыре параграфа,
которые можно описать тезисами ниже:</p>

<ul>
  <li>
    <p>Мы получили много жалоб от русских пользователей, но это оплаченные (государством) тролли.</p>
  </li>
  <li>
    <p>Допускаю, что среди них есть несколько честных людей, но ничего не могу поделать.</p>
  </li>
  <li>
    <p>Вы не слышали про санкции? Проверьте новости, но не ту дичь, что называется новостями в России.</p>
  </li>
  <li>
    <p>Попытайтесь использовать то, что у вас вместо мозгов.</p>
  </li>
  <li>
    <p>Вообще-то я финн, что вы хотели? Почитайте историю.</p>
  </li>
  <li>
    <p>Мне так сказали юристы. Я программист, а не юрист, разбираться не буду.</p>
  </li>
  <li>
    <p>Я не говорю на юридические темы с незнакомыми людьми на прикорме у государства.</p>
  </li>
</ul>

<p>Получилось бодро, с огоньком. По слухам, в почтовой рассылке начался шторм. В
числе прочего пользователи, как и просил Линус, почитали историю и напомнили про
нападение Финляндии на Россию в 1918—1920 годах, ее позицию во время Второй
мировой войны (коллаборацию с СС), а еще — оккупацию Финляндии Швецией на
протяжении семи столетий.</p>

<p>Изюминка в том, что Линус — финн шведского происхождения, то есть потомок
оккупантов, живущий на территории жертв. Еще пользователи интересовались, чем
занимался отец Линуса в период 1941—1945 годов: по слухам, он был коммунистом и
часто бывал в Москве.</p>

<p>Все это на первый взгляд смешно, но в сухом остатке — безобразно. На наших
глазах случилось важное событие, и прошло оно грубо и со скрипом.</p>

<p>Меня задевает, что с людьми обошлись грубо в одностороннем порядке. Это всегда
неприятно, даже когда касается других. Никто не предупреждал разработчиков, что
в их отношении готовится проверка. Сбор данных оказался неточным: по крайней
мере один разработчик уже давно жил в США и работал в Амазоне. Скорее всего,
информацию собрали из LinkedIn и устаревших резюме.</p>

<p>Письмо Линуса в высшей степени грубо и инфантильно. В нем смешались эмоции,
высокомерие, исторические отсылки. Это типичное сообщение для срача на Reddit,
где участники забыли, о чем спорят, и каждый пишет про войну и Гитлера. От
руководителя я бы ждал более внятной позиции.</p>

<p>Процесс полон нарушений от начала до конца. Разработчиков лишили статуса до
того, как они закончили важный патч ядра. Их имен нет даже в файле CREDITS, где
упоминается любой человек, чей код попал в патч, даже если он умер.</p>

<p>Все большие обещания на проверку оказались ложью. Нам долго рассказывали, что
Линукс — это открытый код и международное сообщество. На проверку все это
оказалось бутафорией. Линус — гражданин США, основные спонсоры Linux Foundation
— компании США, юристы — граждане США. По факту Linux Kernel стал цифровым
продуктом США со всеми юридическими последствиями. И хотя прецедентов не было, я
уверен, любой суд придет к такому же выводу. Судья посмотрит на состав
руководителей и спонсоров — и все станет ясно.</p>

<p>Несмотря на несправедливость, я бы не хотел, чтобы разработчиков выставляли жертвами. Просто с людьми обошлись некрасиво, и это может случиться с каждым. Формально они остались контрибьюторами ядра и могут присылать патчи, но после инцидента вряд ли у кого-нибудь останется желание.  Один разработчик написал спокойное, грамотное письмо — прямо ни убавить, ни прибавить. В нем он коротко описал свой волонтерский труд в течение 13 лет и  отказался от дальнейшего участия. Половину письма занимают личные благодарности коллегам.</p>

<p>Читаешь этот текст и думаешь: какие люди важнее проекту — у которых заскоки на
тему истории или кто может сохранить лицо даже в такой ситуации?</p>

<p>Я хорошо понимаю, что ощутили те разработчики. Напомню, что когда началось то,
что сегодня называется “СВО”, меня уволили из Exoscale одним письмом. Никаких
приватных разговоров, предупреждений. Просто я получил письмо, и пока
вчитывался, чтобы понять смысл, пропал доступ ко всей инфраструктуре.</p>

<p>В таких случаях злит не сам факт увольнения — меня увольняли и за грубость, и
когда у стартапа кончались деньги. Озлобляет эта однонаправленность,
безапелляционность. Тебя вычеркнули и отключили от сети, чтобы не услышать твое
мнение. Пространство сужено до одного решения — и хотя все утверждают, что
других решений быть не может, в это отказываешься верить. Что в моем случае, что
в случае одиннадцати разработчиков Линукса, решений могло быть гораздо больше —
стоит только захотеть.</p>

<p>Как я уже писал, обсуждение в почтовой рассылке перешло в клоунаду про Гитлера и
фашистов. Были массовые письма с почтой <code class="language-plaintext highlighter-rouge">putin@kremlin.ru</code> с угрозами ядерных
ударов и прочее. Но если говорить в серьезном ключе, беда в том, что уже первое
сообщение Линуса — про кремлевских ботов и финнов — было троллингом. Оно уже
было высказано с той позиции, когда никакое трезвое обсуждение
невозможно. Фактически Линус стал нулевым троллем, который все это устроил.</p>

<p>В ироническом смысле удивляет осведомленность Линуса о российских новостях и
оплаченных ботах. Интересно, сталкивался ли он с чем-либо из этого? Имеет хотя
бы общее представление о том, какие медиа работают в России? Заходил ли хотя бы
на какой-то сайт? Я в этом сомневаюсь. Линус пишет так, потому что так сказали
его местные сми: если видишь сообщение с русского домена, это кремлевский бот.</p>

<p>Это в точности подтверждает тезис прошлого поста: когда человек пишет о
пропаганде в другой стране, он пересказывает свою пропаганду.</p>

<p>Странно, что Линус, человек пятидесяти лет или около, не понимает: подкреплять
свою позицию историей — в высшей степени моветон. Это глупо, грубо, это
фундамент жирного троллинга, словом — что угодно, только не общение по
делу. Историю человечества можно описать тремя словами: все воевали со
всеми. Если ты взялся отслеживать, кто кому и когда был врагом и переносить это
на софт, ты уже не программист, а диванный воин.</p>

<p>Я и раньше знал об отсутствии у Линуса эмпатии. Об этом говорили многие, в
сообществе периодически были разборки на эту тему. Не мне казалось, что это
поведение имеет напускной характер и что оно преследует благую цель. Например,
не пустить плохой код в ядро даже ценой оскорбления человека. Конечно, лучше
всего добиться того же без оскорблений, но в случае с Линусом это было
простительно. Про него, как и про Джобса, можно было сказать о двух половинах —
гении и засранца, когда заслуги первой перевешивают поведение второй.</p>

<p>Линус долгое время вдохновлял нас бунтарством. Своей грубостью он мог
перевернуть доску в свою сторону, как это было в случае с “Fuck you,
Nvidia”. Однако важно понимать, что во-первых, это был показной ход, а
во-вторых, грубость относилась к гиганту — а пнуть гиганта всегда приятно, и
приятно за этим наблюдать. Публичная грубость в адрес конкретного человека, увы,
смотрится совсем по-другому.</p>

<p>Досадно, что когда пришло время все взвесить и подумать головой, все пошло
криво. Вместо ясных формулировок мы услышали отмазки. Все было сделано тихо и с
ошибками. Там, где можно было сохранить лицо, потеряли его. Там, где можно было
сохранить отношения, потеряли их тоже. Коротко — позор.</p>

<p>Завершая эту простыню, хочется пожелать разработчикам не терять энтузиазма и
направить талант во что-то полезное людям. Это не их вина в том, что с ними
обошлись невежливо. Уверен, они это переживут и пойдут дальше.</p>

<blockquote>
  <p>Оставив выживание за скобками, Linux позволяет людям соединить удовольствие от
интеллектуальных усилий и социальные отношения в единой команде ее создателей.</p>

  <p>Линус Торвальдс</p>
</blockquote>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/mech-work/">Механическая работа</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2024-10-22T00:00:00+00:00">
        Oct 22, 2024
    </time>

    <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/work/" rel="tag">work</a>

</div>


            <div class="entry">
                
                    <p>Любую работу я условно делю на осмысленную и механическую. Первая — когда нужно
думать, вторая — когда не нужно. Если проще, то в первом случае работает голова
— нужно соображать, искать варианты. Во втором случае — задница: нужно сесть и
сделать монотонную работу.</p>

<p>Каждый вид хорош по-своему, и секрет в том, как их чередовать.</p>

<p>Механическую работу нельзя делать, пока остался потенциал для осмысленной. Лучше
сделать осмысленную, а механическую оставить на потом. Обратное тоже верно:
нельзя браться за осмысленную, если уже устал — лучше заняться рутиной.</p>

<p>Например, мы исследуем узкое место в программе. Это осмысленная работа, потому
что нужно строить гипотезы и проверять их. Предположим, мы нашли причину, и
теперь нужно исправить двадцать файлов. Это механическая работа, и будет глупо
браться за нее сразу — наверняка остался потенциал для чего-то полезного. Лучше
исправить пару файлов и поскорее прогнать замеры. Нафигачить костылей, выкатить
приложение на препрод и посмотреть метрики. И только если гипотеза
подтвердилась, прижать зад и исправить остальные 18 файлов.</p>

<p>Я не чураюсь механической работы. Просто отмечаю про себя, что это место в целом
понятно, просто нужно взять его терпением. И возвращаюсь, когда мозги уже
выжаты, а работают только пальцы. Я не особо люблю автоматизирующие скрипты —
писать и отлаживать их дольше, чем сделать работу. Включаю что-нибудь из раннего
Пинк Флойд и колбашу руками.</p>

<p>Осмысленность и механика — две стороны одной медали. На самом деле одно и то же,
но и разные. Дают гибкость и маневр, скрашивают капризы нашего тела.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/kray/">Крайний</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2024-10-22T00:00:00+00:00">
        Oct 22, 2024
    </time>

    <a href="/tag/books/" rel="tag">books</a>

</div>


            <div class="entry">
                
                    <p><img src="/assets/static/aws/kray/1.jpeg" /></p>

<p>К слову “крайний” в значении “последний” я отношусь с улыбкой. Это дремучее
просторечие, и дергать людей из-за него — то же самое, что поправлять “одеть” и
“надеть”. Пусть человек говорит, такая у него особенность.</p>

<p>Но я никогда не думал, что прочту “крайний” в значении “последний” в книге. И не
в прямой речи простолюдина, скажем, “братан, предупреждаю, это крайний
раз”. Слово “крайний” использует рассказчик книги, по сюжету — развитый,
интеллектуальный персонаж.</p>

<p>Как же случилось, что такое просторечение пропустили переводчик, корректор и
редактор? Это уму не постижимо — разве что все трое приехали из одной рязанской
деревни. Другой версии у меня нет.</p>

<p>Книга — “Звездный десант”, <em>крайний</em> перевод.</p>

<p><strong>UPD:</strong> в Телеграме объяснили, что “крайний” пришло из военных и прочих
профессий, связанных с риском. Там не говорят “последний раз”, опасаясь, что он
станет таковым буквально. Можно понять: у военных, моряков и летчиков целый
букет прибабахов. Но зачем перенимать это в обычную жизнь – загадка.</p>

                
            </div>

        </li>
        
    </ul>

    <h4>
        
        <a href="/page5" class="previous">&larr;</a>
        
        <span class="page_number ">Страница 6 из 89</span>
        
        <a href="/page7" class="next">&rarr;</a>
        
    </h4>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Ivan Grishaev's blog</li>
          <li><a href="mailto:ivan@grishaev.me">ivan@grishaev.me</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
            <li><a href="https://github.com/igrishaev">GitHub</a></li>
            <li><a href="https://t.me/igrishaev_blog">Telegram</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Writing on programming, education, books and negotiations.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
