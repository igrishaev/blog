<!DOCTYPE html>
<html lang="ru">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>JSAM: a simple JSON writer and reader</title>
  <meta name="description" content="">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/custom.css">
  <link rel="canonical" href="https://grishaev.me/jsam/">
  <link rel="alternate" type="application/rss+xml" title="Ivan Grishaev's blog" href="https://grishaev.me/feed.xml">

  <link rel="shortcut icon" type="image/x-icon" href="/assets/static/favicons/favicon.ico">

  <script type="text/javascript" src="/assets/typo.js"></script>

</head>


  <body>
    <header class="site-header">

    <div class="wrapper flex-container">

        <div>
            <a href="/">
                <img id="avatar" src="/assets/static/avatar.jpg" alt="Ivan Grishaev">
            </a>
        </div>

        <div class="flex-container-vert" style="margin-left: 15px; width: 80%">

            <div class="flex-container full-width">
                <p style="margin-bottom: 5px"><a href="/">Ivan Grishaev's blog</a></p>
                <div class="flex-huge"></div>
                <div >
<form id="search-form"
      target="_blank"
      style="display: inline"
      method="get"
      action="https://www.google.com/search">

    <input name="sitesearch"
           value="grishaev.me"
           type="hidden">

    <input type="text"
           required="required"
           name="q"
           placeholder="Google search..."
           autocomplete="off">

    <button style="border: none; background-color: transparent; cursor: pointer;"
            type="submit">&#x1f50d;</button>

</form>
</div>
            </div>

            <p><small>Writing on programming, education, books and negotiations.
</small></p>

            <div class="flex-container">
                <a class="menu-item" href="/">Home</a>
                <a class="menu-item" href="/about/">About</a>
                <a class="menu-item" href="/open-source/">Open Source</a>
                <a class="menu-item" href="/bookshelf/">Bookshelf</a>
                <a class="menu-item" href="/feed.xml">RSS</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor" href="/tag/clojure/">Clojure</a>
                <a class="menu-item minor" href="/tag/emacs/">Emacs</a>
                <a class="menu-item minor" href="/tag/python/">Python</a>
                <a class="menu-item minor" href="/tag/programming/">Programming</a>
                <a class="menu-item minor" href="/interview/">Interview</a>
                <a class="menu-item minor" href="/video/">Video</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor hl" href="/clojure-in-prod/">Книга «Clojure на производстве»</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor hl" href="/clojure-in-prod-2/">Книга «Clojure на производстве», второй том</a>
            </div>

        </div>
    </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">

    <h1 class="post-title" itemprop="name headline">JSAM: a simple JSON writer and reader</h1>

    
<div class="post-meta">

    <time class="post-time"
          datetime="2025-04-24T00:00:00+00:00">
        Apr 24, 2025
    </time>

    <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/clojure/" rel="tag">clojure</a>, <a href="/tag/json/" rel="tag">json</a>, <a href="/tag/jsam/" rel="tag">jsam</a>

</div>


  </header>

  <div class="post-content" itemprop="articleBody">
    
<p><a href="https://github.com/igrishaev/jsam">JSam</a> is a lightweight, zero-deps JSON parser and writer. Named after
<a href="https://metalgear.fandom.com/wiki/Samuel_Rodrigues">Jetstream Sam</a>.</p>

<ul>
  <li>Small: only 14 Java files with no extra libraries;</li>
  <li>Not the fastest one but is pretty good (see the chart below);</li>
  <li>Has got its own features, e.g. read and write multiple values;</li>
  <li>Flexible and extendable.</li>
</ul>

<h2 id="installation">Installation</h2>

<p>Requires Java version at least 17. Add a new dependency:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">;; lein</span><span class="w">
</span><span class="p">[</span><span class="n">com.github.igrishaev/jsam</span><span class="w"> </span><span class="s">"0.1.0"</span><span class="p">]</span><span class="w">

</span><span class="c1">;; deps</span><span class="w">
</span><span class="n">com.github.igrishaev/jsam</span><span class="w"> </span><span class="p">{</span><span class="no">:mvn/version</span><span class="w"> </span><span class="s">"0.1.0"</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Import the library:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">ns</span><span class="w"> </span><span class="n">org.some.project</span><span class="w">
  </span><span class="p">(</span><span class="no">:require</span><span class="w">
    </span><span class="p">[</span><span class="n">jsam.core</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">jsam</span><span class="p">]))</span><span class="w">
</span></code></pre></div></div>

<h2 id="reading">Reading</h2>

<p>To read a string:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">jsam/read-string</span><span class="w"> </span><span class="s">"[42.3e-3, 123, \"hello\", true, false, null, {\"some\": \"map\"}]"</span><span class="p">)</span><span class="w">

</span><span class="p">[</span><span class="mf">0.0423</span><span class="w"> </span><span class="mi">123</span><span class="w"> </span><span class="s">"hello"</span><span class="w"> </span><span class="n">true</span><span class="w"> </span><span class="n">false</span><span class="w"> </span><span class="n">nil</span><span class="w"> </span><span class="p">{</span><span class="no">:some</span><span class="w"> </span><span class="s">"map"</span><span class="p">}]</span><span class="w">
</span></code></pre></div></div>

<p>To read any kind of a source: a file, a URL, a socket, an input stream, a
reader, etc:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">jsam/read</span><span class="w"> </span><span class="s">"data.json"</span><span class="p">)</span><span class="w"> </span><span class="c1">;; a file named data.json</span><span class="w">
</span><span class="p">(</span><span class="nf">jsam/read</span><span class="w"> </span><span class="p">(</span><span class="nf">io/input-stream</span><span class="w"> </span><span class="n">...</span><span class="p">))</span><span class="w">
</span><span class="p">(</span><span class="nf">jsam/read</span><span class="w"> </span><span class="p">(</span><span class="nf">io/reader</span><span class="w"> </span><span class="n">...</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<p>Both functions accept an optional map of settings:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">jsam/read-string</span><span class="w"> </span><span class="s">"..."</span><span class="w"> </span><span class="p">{</span><span class="n">...</span><span class="p">})</span><span class="w">
</span><span class="p">(</span><span class="nf">jsam/read</span><span class="w"> </span><span class="p">(</span><span class="nf">io/file</span><span class="w"> </span><span class="n">...</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="n">...</span><span class="p">})</span><span class="w">
</span></code></pre></div></div>

<p>Here is a table of options that affect reading:</p>

<table>
  <thead>
    <tr>
      <th>option</th>
      <th>default</th>
      <th>comment</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:read-buf-size</code></td>
      <td>8k</td>
      <td>Size of a buffer to read</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:temp-buf-scale-factor</code></td>
      <td>2</td>
      <td>Scale factor for an innter buffer</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:temp-buf-size</code></td>
      <td>255</td>
      <td>Inner temp buffer initial size</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:parser-charset</code></td>
      <td>UTF-8</td>
      <td>Must be an instance of <code class="language-plaintext highlighter-rouge">Charset</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:arr-supplier</code></td>
      <td><code class="language-plaintext highlighter-rouge">jsam.core/sup-arr-clj</code></td>
      <td>An object to collect array values</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:obj-supplier</code></td>
      <td><code class="language-plaintext highlighter-rouge">jsam.core/sup-obj-clj</code></td>
      <td>An object to collect key-value pairs</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:bigdec?</code></td>
      <td><code class="language-plaintext highlighter-rouge">false</code></td>
      <td>Use BigDecimal when parsing numbers</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:fn-key</code></td>
      <td><code class="language-plaintext highlighter-rouge">keyword</code></td>
      <td>A function to process keys</td>
    </tr>
  </tbody>
</table>

<p>If you want keys to stay strings, and parse large numbers using <code class="language-plaintext highlighter-rouge">BigDecimal</code> to
avoid infinite values, this is what you pass:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">jsam/read-string</span><span class="w"> </span><span class="s">"..."</span><span class="w"> </span><span class="p">{</span><span class="no">:fn-key</span><span class="w"> </span><span class="nb">identity</span><span class="w"> </span><span class="no">:bigdec?</span><span class="w"> </span><span class="n">true</span><span class="p">})</span><span class="w">
</span></code></pre></div></div>

<p>We will discuss suppliers a bit later.</p>

<h2 id="writing">Writing</h2>

<p>To dump data into a string, use <code class="language-plaintext highlighter-rouge">write-string</code>:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">jsam/write-string</span><span class="w"> </span><span class="p">{</span><span class="no">:hello</span><span class="w"> </span><span class="s">"test"</span><span class="w"> </span><span class="no">:a</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="n">nil</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mf">42.123</span><span class="p">]})</span><span class="w">

</span><span class="s">"{\"hello\":\"test\",\"a\":[1,null,3,42.123]}"</span><span class="w">
</span></code></pre></div></div>

<p>To write into a destination, which might be a file, an output stream, a writer,
etc, use <code class="language-plaintext highlighter-rouge">write</code>:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">jsam/write</span><span class="w"> </span><span class="s">"data2.json"</span><span class="w"> </span><span class="p">{</span><span class="no">:hello</span><span class="w"> </span><span class="s">"test"</span><span class="w"> </span><span class="no">:a</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="n">nil</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mf">42.123</span><span class="p">]})</span><span class="w">

</span><span class="c1">;; or</span><span class="w">

</span><span class="p">(</span><span class="nf">jsam/write</span><span class="w"> </span><span class="p">(</span><span class="nf">io/file</span><span class="w"> </span><span class="n">...</span><span class="p">))</span><span class="w">

</span><span class="c1">;; or</span><span class="w">

</span><span class="p">(</span><span class="nb">with-open</span><span class="w"> </span><span class="p">[</span><span class="n">writer</span><span class="w"> </span><span class="p">(</span><span class="nf">io/writer</span><span class="w"> </span><span class="n">...</span><span class="p">)]</span><span class="w">
  </span><span class="p">(</span><span class="nf">jsam/write</span><span class="w"> </span><span class="n">writer</span><span class="w"> </span><span class="p">{</span><span class="n">...</span><span class="p">}))</span><span class="w">
</span></code></pre></div></div>

<p>Both functions accept a map of options for writing:</p>

<table>
  <thead>
    <tr>
      <th>option</th>
      <th>default</th>
      <th>comment</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:writer-charset</code></td>
      <td>UTF-8</td>
      <td>Must be an instance of <code class="language-plaintext highlighter-rouge">Charset</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:pretty?</code></td>
      <td><code class="language-plaintext highlighter-rouge">false</code></td>
      <td>Use indents and line breaks</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:pretty-indent</code></td>
      <td>2</td>
      <td>Indent growth for each level</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:multi-separator</code></td>
      <td><code class="language-plaintext highlighter-rouge">\n</code></td>
      <td>How to split multiple values</td>
    </tr>
  </tbody>
</table>

<p>This is how you pretty-print data:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">jsam/write</span><span class="w"> </span><span class="s">"data3.json"</span><span class="w">
            </span><span class="p">{</span><span class="no">:hello</span><span class="w"> </span><span class="s">"test"</span><span class="w"> </span><span class="no">:a</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="p">{</span><span class="no">:foo</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="p">[</span><span class="mi">42</span><span class="p">]</span><span class="w"> </span><span class="mi">3</span><span class="p">]}</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mf">42.123</span><span class="p">]}</span><span class="w">
            </span><span class="p">{</span><span class="no">:pretty?</span><span class="w"> </span><span class="n">true</span><span class="w">
             </span><span class="no">:pretty-indent</span><span class="w"> </span><span class="mi">4</span><span class="p">})</span><span class="w">
</span></code></pre></div></div>

<p>This is what you’ll get (maybe needs some further adjustment):</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"hello"</span><span class="p">:</span><span class="w"> </span><span class="s2">"test"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"a"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="mi">1</span><span class="p">,</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"foo"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                </span><span class="mi">1</span><span class="p">,</span><span class="w">
                </span><span class="p">[</span><span class="w">
                    </span><span class="mi">42</span><span class="w">
                </span><span class="p">],</span><span class="w">
                </span><span class="mi">3</span><span class="w">
            </span><span class="p">]</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="mi">3</span><span class="p">,</span><span class="w">
        </span><span class="mf">42.123</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h2 id="handling-multiple-values">Handling Multiple Values</h2>

<p>When you have 10.000.000 of rows of data to dump into JSON, a regular approach
is not developer friendly. It leads to a single array with 10M items that you
read into memory at once. Only few libraries provide facilities to read arrays
lazily.</p>

<p>It’s much better to dump rows one by one into a stream and then read them one by
one without saturating memory. Here is how you do it:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">jsam/write-multi</span><span class="w"> </span><span class="s">"data4.json"</span><span class="w">
                  </span><span class="p">(</span><span class="k">for</span><span class="w"> </span><span class="p">[</span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="nb">range</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">3</span><span class="p">)]</span><span class="w">
                    </span><span class="p">{</span><span class="no">:x</span><span class="w"> </span><span class="n">x</span><span class="p">}))</span><span class="w">
</span></code></pre></div></div>

<p>The second argument is a collection that might be lazy as well. The content of
the file is:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="nl">"x"</span><span class="p">:</span><span class="mi">0</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="nl">"x"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="nl">"x"</span><span class="p">:</span><span class="mi">2</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Now read it back:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nb">doseq</span><span class="w"> </span><span class="p">[</span><span class="n">item</span><span class="w"> </span><span class="p">(</span><span class="nf">jsam/read-multi</span><span class="w"> </span><span class="s">"data4.json"</span><span class="p">)]</span><span class="w">
  </span><span class="p">(</span><span class="nb">println</span><span class="w"> </span><span class="n">item</span><span class="p">))</span><span class="w">

</span><span class="c1">;; {:x 0}</span><span class="w">
</span><span class="c1">;; {:x 1}</span><span class="w">
</span><span class="c1">;; {:x 2}</span><span class="w">
</span></code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">read-multi</code> function returns a <strong>lazy</strong> iterable object meaning it won’t
read everything at once. Also, both <code class="language-plaintext highlighter-rouge">write-</code> and <code class="language-plaintext highlighter-rouge">read-multi</code> functions are
pretty-print friendly:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">;; write</span><span class="w">
</span><span class="p">(</span><span class="nf">jsam/write-multi</span><span class="w"> </span><span class="s">"data5.json"</span><span class="w">
                  </span><span class="p">(</span><span class="k">for</span><span class="w"> </span><span class="p">[</span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="nb">range</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">3</span><span class="p">)]</span><span class="w">
                    </span><span class="p">{</span><span class="no">:x</span><span class="w"> </span><span class="p">[</span><span class="n">x</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">x</span><span class="p">]})</span><span class="w">
                  </span><span class="p">{</span><span class="no">:pretty?</span><span class="w"> </span><span class="n">true</span><span class="p">})</span><span class="w">

</span><span class="c1">;; read</span><span class="w">
</span><span class="p">(</span><span class="nb">doseq</span><span class="w"> </span><span class="p">[</span><span class="n">item</span><span class="w"> </span><span class="p">(</span><span class="nf">jsam/read-multi</span><span class="w"> </span><span class="s">"data5.json"</span><span class="p">)]</span><span class="w">
  </span><span class="p">(</span><span class="nb">println</span><span class="w"> </span><span class="n">item</span><span class="p">))</span><span class="w">

</span><span class="c1">;; {:x [0 0 0]}</span><span class="w">
</span><span class="c1">;; {:x [1 1 1]}</span><span class="w">
</span><span class="c1">;; {:x [2 2 2]}</span><span class="w">
</span></code></pre></div></div>

<p>The content of the data5.json file:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"x"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="mi">0</span><span class="p">,</span><span class="w">
    </span><span class="mi">0</span><span class="p">,</span><span class="w">
    </span><span class="mi">0</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="w">
  </span><span class="nl">"x"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="mi">1</span><span class="p">,</span><span class="w">
    </span><span class="mi">1</span><span class="p">,</span><span class="w">
    </span><span class="mi">1</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="w">
  </span><span class="nl">"x"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="mi">2</span><span class="p">,</span><span class="w">
    </span><span class="mi">2</span><span class="p">,</span><span class="w">
    </span><span class="mi">2</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h2 id="type-mapping-and-extending">Type Mapping and Extending</h2>

<p>This chapter covers how to control type mapping between Clojure and JSON realms.</p>

<p>Writing is served using a protocol named <code class="language-plaintext highlighter-rouge">jsam.core/IJSON</code> with a single encidng
method:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">defprotocol</span><span class="w"> </span><span class="n">IJSON</span><span class="w">
  </span><span class="p">(</span><span class="nf">-encode</span><span class="w"> </span><span class="p">[</span><span class="n">this</span><span class="w"> </span><span class="n">writer</span><span class="p">]))</span><span class="w">
</span></code></pre></div></div>

<p>The default mapping is the following:</p>

<table>
  <thead>
    <tr>
      <th>Clojure</th>
      <th>JSON</th>
      <th>Comment</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>nil</td>
      <td>null</td>
      <td> </td>
    </tr>
    <tr>
      <td>String</td>
      <td>string</td>
      <td> </td>
    </tr>
    <tr>
      <td>Boolean</td>
      <td>bool</td>
      <td> </td>
    </tr>
    <tr>
      <td>Number</td>
      <td>number</td>
      <td> </td>
    </tr>
    <tr>
      <td>Ratio</td>
      <td>string</td>
      <td>e.g. <code class="language-plaintext highlighter-rouge">(/ 3 2)</code> -&gt; <code class="language-plaintext highlighter-rouge">"3/2"</code></td>
    </tr>
    <tr>
      <td>Atom</td>
      <td>any</td>
      <td>gets <code class="language-plaintext highlighter-rouge">deref</code>-ed</td>
    </tr>
    <tr>
      <td>Ref</td>
      <td>any</td>
      <td>gets <code class="language-plaintext highlighter-rouge">deref</code>-ed</td>
    </tr>
    <tr>
      <td>List</td>
      <td>array</td>
      <td>lazy seqs as well</td>
    </tr>
    <tr>
      <td>Map</td>
      <td>object</td>
      <td>keys coerced to strings</td>
    </tr>
    <tr>
      <td>Keyword</td>
      <td>string</td>
      <td>leading <code class="language-plaintext highlighter-rouge">:</code> is trimmed</td>
    </tr>
  </tbody>
</table>

<p>Anything else gets encoded like a string using the <code class="language-plaintext highlighter-rouge">.toString</code> invocation under
the hood:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">extend-protocol</span><span class="w"> </span><span class="n">IJSON</span><span class="w">
  </span><span class="n">...</span><span class="w">
  </span><span class="n">Object</span><span class="w">
  </span><span class="p">(</span><span class="nf">-encode</span><span class="w"> </span><span class="p">[</span><span class="n">this</span><span class="w"> </span><span class="o">^</span><span class="n">JsonWriter</span><span class="w"> </span><span class="n">writer</span><span class="p">]</span><span class="w">
    </span><span class="p">(</span><span class="nf">.writeString</span><span class="w"> </span><span class="n">writer</span><span class="w"> </span><span class="p">(</span><span class="nb">str</span><span class="w"> </span><span class="n">this</span><span class="p">)))</span><span class="w">
  </span><span class="n">...</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>Here is how you override encoding. Imagine you have a special type <code class="language-plaintext highlighter-rouge">SneakyType</code>:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">deftype</span><span class="w"> </span><span class="n">SneakyType</span><span class="w"> </span><span class="p">[</span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="n">c</span><span class="p">]</span><span class="w">

  </span><span class="c1">;; some protocols...</span><span class="w">

  </span><span class="n">jsam/IJSON</span><span class="w">
  </span><span class="p">(</span><span class="nf">-encode</span><span class="w"> </span><span class="p">[</span><span class="n">this</span><span class="w"> </span><span class="n">writer</span><span class="p">]</span><span class="w">
    </span><span class="p">(</span><span class="nf">jsam/-encode</span><span class="w"> </span><span class="p">[</span><span class="s">"I used to be a SneakyType"</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="n">c</span><span class="p">]</span><span class="w"> </span><span class="n">writer</span><span class="p">)))</span><span class="w">
</span></code></pre></div></div>

<p>Test it:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">data1</span><span class="w"> </span><span class="p">{</span><span class="no">:foo</span><span class="w"> </span><span class="p">(</span><span class="nb">new</span><span class="w"> </span><span class="n">SneakyType</span><span class="w"> </span><span class="no">:a</span><span class="w"> </span><span class="s">"b"</span><span class="w"> </span><span class="mi">42</span><span class="p">)}</span><span class="w">
      </span><span class="n">string</span><span class="w"> </span><span class="p">(</span><span class="nf">jsam/write-string</span><span class="w"> </span><span class="n">data1</span><span class="p">)]</span><span class="w">
  </span><span class="p">(</span><span class="nf">jsam/read-string</span><span class="w"> </span><span class="n">string</span><span class="p">))</span><span class="w">

</span><span class="c1">;; {:foo ["I used to be a SneakyType" "a" "b" 42]}</span><span class="w">
</span></code></pre></div></div>

<p>When reading the data, there is a way to specify how array and object values get
collected. Options <code class="language-plaintext highlighter-rouge">:arr-supplier</code> and <code class="language-plaintext highlighter-rouge">:obj-supplier</code> accept a <code class="language-plaintext highlighter-rouge">Supplier</code>
instance where the <code class="language-plaintext highlighter-rouge">get</code> method returns instances of <code class="language-plaintext highlighter-rouge">IArrayBuilder</code> or
<code class="language-plaintext highlighter-rouge">IObjectBuilder</code> interfaces. Each interface knows how to add a value into a
collection how to finalize it.</p>

<p>Default implementations build Clojure persistent collections like
<code class="language-plaintext highlighter-rouge">PersistentVector</code> or <code class="language-plaintext highlighter-rouge">PersistenHashMap</code>. There is a couple of Java-specific
suppliers that build <code class="language-plaintext highlighter-rouge">ArrayList</code> and <code class="language-plaintext highlighter-rouge">HashMap</code>, respectively. Here is how you
use them:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">jsam/read-string</span><span class="w"> </span><span class="s">"[1, 2, 3]"</span><span class="w">
                  </span><span class="p">{</span><span class="no">:arr-supplier</span><span class="w"> </span><span class="n">jsam/sup-arr-java</span><span class="p">})</span><span class="w">

</span><span class="c1">;; [1 2 3]</span><span class="w">
</span><span class="c1">;; java.util.ArrayList</span><span class="w">

</span><span class="p">(</span><span class="nf">jsam/read-string</span><span class="w"> </span><span class="s">"{\"test\": 42}"</span><span class="w">
                  </span><span class="p">{</span><span class="no">:obj-supplier</span><span class="w"> </span><span class="n">jsam/sup-obj-java</span><span class="p">})</span><span class="w">

</span><span class="c1">;; {:test 42}</span><span class="w">
</span><span class="c1">;; java.util.HashMap</span><span class="w">
</span></code></pre></div></div>

<p>Here are some crazy examples that allow to modify data while you build
collections. For an array:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">arr-supplier</span><span class="w">
      </span><span class="p">(</span><span class="nf">reify</span><span class="w"> </span><span class="n">java.util.function.Supplier</span><span class="w">
        </span><span class="p">(</span><span class="nb">get</span><span class="w"> </span><span class="p">[</span><span class="n">this</span><span class="p">]</span><span class="w">
          </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">state</span><span class="w"> </span><span class="p">(</span><span class="nf">atom</span><span class="w"> </span><span class="p">[])]</span><span class="w">
            </span><span class="p">(</span><span class="nf">reify</span><span class="w"> </span><span class="n">org.jsam.IArrayBuilder</span><span class="w">
              </span><span class="p">(</span><span class="nb">conj</span><span class="w"> </span><span class="p">[</span><span class="n">this</span><span class="w"> </span><span class="n">el</span><span class="p">]</span><span class="w">
                </span><span class="p">(</span><span class="nf">swap!</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="n">clojure.core/conj</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">el</span><span class="w"> </span><span class="mi">10</span><span class="p">)))</span><span class="w">
              </span><span class="p">(</span><span class="nf">build</span><span class="w"> </span><span class="p">[</span><span class="n">this</span><span class="p">]</span><span class="w">
                </span><span class="o">@</span><span class="n">state</span><span class="p">)))))]</span><span class="w">

  </span><span class="p">(</span><span class="nf">jsam/read-string</span><span class="w"> </span><span class="s">"[1, 2, 3]"</span><span class="w">
                    </span><span class="p">{</span><span class="no">:arr-supplier</span><span class="w"> </span><span class="n">arr-supplier</span><span class="p">}))</span><span class="w">

</span><span class="c1">;; [10 20 30]</span><span class="w">
</span></code></pre></div></div>

<p>And for an object:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">obj-supplier</span><span class="w">
      </span><span class="p">(</span><span class="nf">jsam/supplier</span><span class="w">
        </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">state</span><span class="w"> </span><span class="p">(</span><span class="nf">atom</span><span class="w"> </span><span class="p">{})]</span><span class="w">
          </span><span class="p">(</span><span class="nf">reify</span><span class="w"> </span><span class="n">org.jsam.IObjectBuilder</span><span class="w">
            </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="p">[</span><span class="n">this</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="n">v</span><span class="p">]</span><span class="w">
              </span><span class="p">(</span><span class="nf">swap!</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="n">clojure.core/assoc</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="mi">10</span><span class="p">)))</span><span class="w">
            </span><span class="p">(</span><span class="nf">build</span><span class="w"> </span><span class="p">[</span><span class="n">this</span><span class="p">]</span><span class="w">
              </span><span class="o">@</span><span class="n">state</span><span class="p">))))]</span><span class="w">

  </span><span class="p">(</span><span class="nf">jsam/read-string</span><span class="w"> </span><span class="s">"{\"test\": 1}"</span><span class="w">
                    </span><span class="p">{</span><span class="no">:obj-supplier</span><span class="w"> </span><span class="n">obj-supplier</span><span class="p">}))</span><span class="w">

</span><span class="c1">;; {:test 10}</span><span class="w">
</span></code></pre></div></div>

<h2 id="benchmarks">Benchmarks</h2>

<p>Jsam doesn’t try to gain as much performance as possible; tuning JSON reading
and writing is pretty challenging. But so far, the library is not as bad as you
might think! It’s two times slower that Jsonista and slightly slower than
Cheshire. But it’s times faster than data.json which is written in pure Clojure
and thus is so slow.</p>

<p>The chart below renders my measures of reading a 100MB Json file. Then the data
read from this file were dumped into a string. It’s pretty clear that Jsam is
not the best nor the worst one in this competition. I’ll keep the question of
performance for further work.</p>

<p>Measured on MacBook M3 Pro 36Gb.</p>

<p><img src="/assets/static/aws/jsam/1.svg" /></p>

<p>Another benchmark made by <a href="https://github.com/p-himik">Eugene Pakhomov</a>. Reading:</p>

<table>
  <thead>
    <tr>
      <th>size</th>
      <th>jsam mean</th>
      <th>data.json</th>
      <th>cheshire</th>
      <th>jsonista</th>
      <th>jsoniter</th>
      <th>charred</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>10 b</td>
      <td>182 ns</td>
      <td>302 ns</td>
      <td>800 ns</td>
      <td>230 ns</td>
      <td>101 ns</td>
      <td>485 ns</td>
    </tr>
    <tr>
      <td>100 b</td>
      <td>827 ns</td>
      <td>1 µs</td>
      <td>2 µs</td>
      <td>1 µs</td>
      <td>504 ns</td>
      <td>1 µs</td>
    </tr>
    <tr>
      <td>1 kb</td>
      <td>5 µs</td>
      <td>8 µs</td>
      <td>9 µs</td>
      <td>6 µs</td>
      <td>3 µs</td>
      <td>5 µs</td>
    </tr>
    <tr>
      <td>10 kb</td>
      <td>58 µs</td>
      <td>108 µs</td>
      <td>102 µs</td>
      <td>58 µs</td>
      <td>36 µs</td>
      <td>59 µs</td>
    </tr>
    <tr>
      <td>100 kb</td>
      <td>573 µs</td>
      <td>1 ms</td>
      <td>968 µs</td>
      <td>596 µs</td>
      <td>379 µs</td>
      <td>561 µs</td>
    </tr>
  </tbody>
</table>

<p>Writing:</p>

<table>
  <thead>
    <tr>
      <th>size</th>
      <th>jsam mean</th>
      <th>data.json</th>
      <th>cheshire</th>
      <th>jsonista</th>
      <th>jsoniter</th>
      <th>charred</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>10 b</td>
      <td>229 ns</td>
      <td>491 ns</td>
      <td>895 ns</td>
      <td>185 ns</td>
      <td>2 µs</td>
      <td>326 ns</td>
    </tr>
    <tr>
      <td>100 b</td>
      <td>2 µs</td>
      <td>3 µs</td>
      <td>2 µs</td>
      <td>540 ns</td>
      <td>3 µs</td>
      <td>351 ns</td>
    </tr>
    <tr>
      <td>1 kb</td>
      <td>14 µs</td>
      <td>14 µs</td>
      <td>8 µs</td>
      <td>3 µs</td>
      <td>8 µs</td>
      <td>88 ns</td>
    </tr>
    <tr>
      <td>10 kb</td>
      <td>192 µs</td>
      <td>165 µs</td>
      <td>85 µs</td>
      <td>29 µs</td>
      <td>96 µs</td>
      <td>10 µs</td>
    </tr>
    <tr>
      <td>100 kb</td>
      <td>2 ms</td>
      <td>2 ms</td>
      <td>827 µs</td>
      <td>325 µs</td>
      <td>881 µs</td>
      <td>88 µs</td>
    </tr>
  </tbody>
</table>

<p>Measured on i7-9700K.</p>

<h2 id="on-tests">On Tests</h2>

<p>One can be interested in how this library was tested. Although being considered
as a simple format, JSON has got plenty of surprises. Jsam has tree sets of
tests, namely:</p>

<ul>
  <li>basic cases written by me;</li>
  <li>a large test suite borrowed from the <a href="https://github.com/cnuernber/charred">Charred library</a>. Many thanks
to <a href="https://github.com/cnuernber">Chris Nuernberger</a> who allowed me to use his code.</li>
  <li>an extra set of generative tests borrowed from the official
<code class="language-plaintext highlighter-rouge">clojure.data.json</code> library developed by Clojure team.</li>
</ul>

<p>These three, I believe, cover most of the cases. Should you face any weird
behavior, please let me know.</p>

    
<div class="prev-next">

    <div class="prev-next-left">
    
        <p><small><a href="/flyway/">&larr; Flyway</a></small></p>
    
    </div>

    <div class="prev-next-mid">
    </div>

    <div class="prev-next-right">
    
        <p><small><a href="/limiter/">Вертикальная полоса &rarr;</a></small></p>
    
    </div>

</div>

  </div>

</article>

<center>
    <p>
        <small>Нашли ошибку? Выделите мышкой и нажмите Ctrl/&#8984;+Enter</small>
    </p>
</center>





<center>
    
    Комментариев пока нет
    
    
    &emsp;<a href="https://t.me/igrishaev_blog/816">Обсудить в Телеграме</a>
    
</center>









<form id="comment-form" method="POST" action="https://functions.yandexcloud.net/d4ehfuf08fjfjr59ivnf">

    <div class="block">
        <p class="comment-form-label"><small>Your name</small></p>
        <input required id="comment-form-author" name="author" type="text">
    </div>

    <div class="block">
        <p class="comment-form-label"><small>Comment (markdown syntax)</small></p>
        <textarea required id="comment-form-comment" name="comment"></textarea>
    </div>

    <input required name="path" type="hidden" value="/jsam/">
    <input required name="captcha" type="hidden" value="9 &#215; 7">

    <div class="block">
        <span class="comment-form-label"><small>9 &#215; 7 = </small></span>
        <input required id="comment-form-solution" name="solution" type="text">
    </div>

    <div class="block">
        <button id="comment-form-send" type="submit">Send</button>
    </div>

</form>


      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Ivan Grishaev's blog</li>
          <li><a href="mailto:ivan@grishaev.me">ivan@grishaev.me</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
            <li><a href="https://github.com/igrishaev">GitHub</a></li>
            <li><a href="https://t.me/igrishaev_blog">Telegram</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Writing on programming, education, books and negotiations.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
