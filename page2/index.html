<!DOCTYPE html>
<html lang="ru">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Ivan Grishaev's blog</title>
  <meta name="description" content="Writing on programming, education, books and negotiations.
">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/custom.css">
  <link rel="canonical" href="https://grishaev.me/page2/">
  <link rel="alternate" type="application/rss+xml" title="Ivan Grishaev's blog" href="https://grishaev.me/feed.xml">

  <link rel="shortcut icon" type="image/x-icon" href="/assets/static/favicons/favicon.ico">

  <script type="text/javascript" src="/assets/typo.js"></script>

</head>


  <body>
    <header class="site-header">

    <div class="wrapper flex-container">

        <div>
            <a href="/">
                <img id="avatar" src="/assets/static/avatar.jpg" alt="Ivan Grishaev">
            </a>
        </div>

        <div class="flex-container-vert" style="margin-left: 15px; width: 80%">

            <div class="flex-container full-width">
                <p style="margin-bottom: 5px">Ivan Grishaev's blog</p>
                <div class="flex-huge"></div>
                <div >
<form id="search-form"
      target="_blank"
      style="display: inline"
      method="get"
      action="https://www.google.com/search">

    <input name="sitesearch"
           value="grishaev.me"
           type="hidden">

    <input type="text"
           required="required"
           name="q"
           placeholder="Google search..."
           autocomplete="off">

    <button style="border: none; background-color: transparent; cursor: pointer;"
            type="submit">&#x1f50d;</button>

</form>
</div>
            </div>

            <p><small>Writing on programming, education, books and negotiations.
</small></p>

            <div class="flex-container">
                <a class="menu-item" href="/">Home</a>
                <a class="menu-item" href="/about/">About</a>
                <a class="menu-item" href="/bookshelf/">Bookshelf</a>
                <a class="menu-item" href="/feed.xml">RSS</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor" href="/tag/clojure/">Clojure</a>
                <a class="menu-item minor" href="/tag/emacs/">Emacs</a>
                <a class="menu-item minor" href="/tag/python/">Python</a>
                <a class="menu-item minor" href="/tag/programming/">Programming</a>
                <a class="menu-item minor" href="/interview/">Interview</a>
                <a class="menu-item minor" href="/video/">Video</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor hl" href="/clojure-in-prod/">Книга «Clojure на производстве»</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor hl" href="/clojure-in-prod-2/">Книга «Clojure на производстве», второй том</a>
            </div>

        </div>
    </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="home">

    <ul class="post-list">
        
        <li>

            <h2>
                <a class="post-link" href="/corp-update/">Корпоративные обновления</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2025-03-04T00:00:00+00:00">
        Mar 4, 2025
    </time>

    <a href="/tag/update/" rel="tag">update</a>, <a href="/tag/macos/" rel="tag">macos</a>, <a href="/tag/apple/" rel="tag">apple</a>

</div>


            <div class="entry">
                
                    <p>Когда работаешь на корпоративном ноуте, постигаешь всю беспощадность
обновлений. Ничего нельзя отключить, в фоне работают программы, которые следят
за обновлениями. Раз в несколько дней обновится то Хром, то Idea, и начинаются
выпадашки: Иван, чтобы защитить себя от угроз, поставь обновление! Откладывать
можно фиксированное число раз, и в какой-то момент обновление ставится силой —
конечно, перед релизом или звонком. Поэтому со временем я стал накатывать
обновления на выходных.</p>

<p>Так вот, в который раз попадаюсь на дурацкое поведение Эпла. Вылазит выпадашка:
обновись до Секвойи, тянуть больше нельзя. И кнопочка “Install update”. Я
закрываю все программы, все реплы, докеры и остаюсь с выпадашкой наедине. Жму
кнопку и вижу: отлично, загружаю обновление, осталось 3 часа. Три часа, Карл! Я
мог бы ничего не закрывать и работать чуть ли не полдня, пока качается
обновление!</p>

<p>Нажимая “Install update”, я рассчитываю, что оно уже загружено и я в шаге от
того, чтобы начать установку. А загрузка даже не начиналась! И качать там не три
мегабайта, а 5-7 гигов.</p>

<p>Спрашивается, что мешало скачать обновление в фоне? Если от него нельзя
отделаться, так скачай сам, зачем парить мне мозги?</p>

<p>Дизайнер тоже хорош: если кнопка запускает загрузку обновления, ее нужно назвать
“Download &amp; Install update”. Я ведь хочу самую малость: чтобы на кнопке было
написано то, что она делает на самом деле.</p>

<p>Сюда же относится виджет обновления Эппловских программ. Вылазит окошко поверх
всего, и там кнопка “Обновить”. Нажимаешь, оно начинает загрузку, а потом сто
раз перехватывает форус. Почему нельзя скачать в фоне? Почему нельзя поставить
его в фоне? Зачем тыкать в лицо модалки?</p>

<p>Та же самое с Саблаймом. Поработав минут 20, он начинает показывать модалку с
прогрессбаром: загружаю обновление. Тупица, что мешает скачать обновление в
фоне? Зачем ты показываешь прогресс-бар? Чтобы пользователь смотрел на него?
Других дел у пользователя нет?</p>

<p>В общем, сегодня каждая программа обновляется как не в себя, только нормальные
обновления так и не сделали. На ум приходит только одно исключение — Хром,
который обновляется полностью незаметно. Все остальное — обычные модалки с
прогрес-баром.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/clj-taggie/">Taggie</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2025-02-08T00:00:00+00:00">
        Feb 8, 2025
    </time>

    <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/clojure/" rel="tag">clojure</a>, <a href="/tag/tags/" rel="tag">tags</a>

</div>


            <div class="entry">
                
                    
<p><a href="https://github.com/igrishaev/taggie">Taggie</a> is an experimental library trying find an answer for a strange
question: is it possible to benefit from Clojure tags and readers, and how?</p>

<p>Taggie extends printing methods such that types that could not be read from
their representation now <strong>can</strong> be read. A quick example: if you print an atom,
you’ll get a weird string:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">atom</span><span class="w"> </span><span class="mi">42</span><span class="p">)</span><span class="w">
</span><span class="o">#</span><span class="n">&lt;Atom</span><span class="o">@</span><span class="mi">7</span><span class="n">fea5978</span><span class="err">:</span><span class="w"> </span><span class="mi">42</span><span class="nb">&gt;</span><span class="w">
</span></code></pre></div></div>

<p>Run that string, and REPL won’t understand you:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">#</span><span class="n">&lt;Atom</span><span class="o">@</span><span class="mi">7</span><span class="n">fea5978</span><span class="err">:</span><span class="w"> </span><span class="mi">42</span><span class="nb">&gt;</span><span class="w">
</span><span class="n">Syntax</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">reading</span><span class="w"> </span><span class="n">source</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="p">(</span><span class="nf">REPL</span><span class="no">:962:5</span><span class="p">)</span><span class="nb">.</span><span class="w">
</span><span class="n">Unreadable</span><span class="w"> </span><span class="n">form</span><span class="w">
</span></code></pre></div></div>

<p>But with Taggie, it goes this way:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">atom</span><span class="w"> </span><span class="mi">42</span><span class="p">)</span><span class="w">
</span><span class="o">#</span><span class="n">atom</span><span class="w"> </span><span class="mi">42</span><span class="w"> </span><span class="c1">;; represented with a tag</span><span class="w">
</span></code></pre></div></div>

<p>And vice versa:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">#</span><span class="n">atom</span><span class="w"> </span><span class="mi">42</span><span class="w"> </span><span class="c1">;; run it in repl</span><span class="w">
</span><span class="o">#</span><span class="n">atom</span><span class="w"> </span><span class="mi">42</span><span class="w"> </span><span class="c1">;; the result</span><span class="w">
</span></code></pre></div></div>

<p>The value is an atom indeed, you can check it:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nb">deref</span><span class="w"> </span><span class="o">#</span><span class="n">atom</span><span class="w"> </span><span class="mi">42</span><span class="p">)</span><span class="w">
</span><span class="mi">42</span><span class="w">
</span></code></pre></div></div>

<p>Tags can be nested. Let’s try some madness:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">omg</span><span class="w"> </span><span class="o">#</span><span class="n">atom</span><span class="w"> </span><span class="o">#</span><span class="n">atom</span><span class="w"> </span><span class="o">#</span><span class="n">atom</span><span class="w"> </span><span class="o">#</span><span class="n">atom</span><span class="w"> </span><span class="o">#</span><span class="n">atom</span><span class="w"> </span><span class="o">#</span><span class="n">atom</span><span class="w"> </span><span class="mi">42</span><span class="p">)</span><span class="w">

</span><span class="p">(</span><span class="nb">println</span><span class="w"> </span><span class="n">omg</span><span class="p">)</span><span class="w">
</span><span class="o">#</span><span class="n">atom</span><span class="w"> </span><span class="o">#</span><span class="n">atom</span><span class="w"> </span><span class="o">#</span><span class="n">atom</span><span class="w"> </span><span class="o">#</span><span class="n">atom</span><span class="w"> </span><span class="o">#</span><span class="n">atom</span><span class="w"> </span><span class="o">#</span><span class="n">atom</span><span class="w"> </span><span class="mi">42</span><span class="w">

</span><span class="o">@@@@@@</span><span class="n">omg</span><span class="w">
</span><span class="mi">42</span><span class="w">
</span></code></pre></div></div>

<p>But this is not only about atoms! Taggie extends many types, e.g. refs, native
Java arrays, <code class="language-plaintext highlighter-rouge">File</code>, <code class="language-plaintext highlighter-rouge">URI</code>, <code class="language-plaintext highlighter-rouge">URL</code>, <code class="language-plaintext highlighter-rouge">Date</code>, <code class="language-plaintext highlighter-rouge">java.time.*</code> classes, and something
else. See the corresponding section below.</p>

<h2 id="installation-and-usage">Installation and Usage</h2>

<p>Add this to your project:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">;; lein</span><span class="w">
</span><span class="p">[</span><span class="n">com.github.igrishaev/taggie</span><span class="w"> </span><span class="s">"0.1.0"</span><span class="p">]</span><span class="w">

</span><span class="c1">;; deps</span><span class="w">
</span><span class="n">com.github.igrishaev/taggie</span><span class="w"> </span><span class="p">{</span><span class="no">:mvn/version</span><span class="w"> </span><span class="s">"0.1.0"</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Then import the core namespace:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">ns</span><span class="w"> </span><span class="n">com.acme.server</span><span class="w">
  </span><span class="p">(</span><span class="no">:require</span><span class="w">
    </span><span class="n">taggie.core</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<p>Now type in the repl any of these:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">#</span><span class="n">LocalDate</span><span class="w"> </span><span class="s">"2025-01-01"</span><span class="w">
</span><span class="o">#</span><span class="n">Instant</span><span class="w"> </span><span class="s">"2025-01-01T23:59:59Z"</span><span class="w">
</span><span class="o">#</span><span class="n">File</span><span class="w"> </span><span class="s">"/path/to/a/file.txt"</span><span class="w">
</span><span class="o">#</span><span class="n">URL</span><span class="w"> </span><span class="s">"https://clojure.org"</span><span class="w">
</span><span class="o">#</span><span class="n">bytes</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="n">x00</span><span class="w"> </span><span class="mi">0</span><span class="n">xff</span><span class="p">]</span><span class="w">
</span><span class="o">#</span><span class="n">ints</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="p">]</span><span class="w">
</span><span class="o">#</span><span class="n">floats</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="p">]</span><span class="w">
</span><span class="o">#</span><span class="n">ByteBuffer</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">4</span><span class="p">]</span><span class="w">
</span><span class="n">...</span><span class="w">
</span></code></pre></div></div>

<p>Each expression gives an instance of a corresponding type: a <code class="language-plaintext highlighter-rouge">LocalDate</code>, an
<code class="language-plaintext highlighter-rouge">Instane</code>, a <code class="language-plaintext highlighter-rouge">File</code>, etc… <code class="language-plaintext highlighter-rouge">#bytes</code>, <code class="language-plaintext highlighter-rouge">#ints</code> and similar produce native Java
arrays.</p>

<p>You can pass tagged values into functions as usual:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nb">deref</span><span class="w"> </span><span class="o">#</span><span class="n">atom</span><span class="w"> </span><span class="mi">42</span><span class="p">)</span><span class="w">
</span><span class="mi">42</span><span class="w">

</span><span class="p">(</span><span class="nb">alength</span><span class="w"> </span><span class="o">#</span><span class="n">longs</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="p">])</span><span class="w">
</span><span class="mi">3</span><span class="w">
</span></code></pre></div></div>

<p>To observe what happends under the hood, prepend your expression with a
backtick:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">`</span><span class="p">(</span><span class="nb">alength</span><span class="w"> </span><span class="o">#</span><span class="n">longs</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="p">])</span><span class="w">

</span><span class="p">(</span><span class="nf">clojure.core/alength</span><span class="w"> </span><span class="p">(</span><span class="nf">taggie.readers/__reader-longs-edn</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="p">]))</span><span class="w">
</span></code></pre></div></div>

<p>Internally, all tags expand into an invocation of an EDN reader. Namely, <code class="language-plaintext highlighter-rouge">#longs
items</code> becomes <code class="language-plaintext highlighter-rouge">(taggie.readers/__reader-longs-edn items)</code>, and when evaluated,
it returs a native array of longs.</p>

<h2 id="edn-support">EDN Support</h2>

<p>Taggie provides functions to read and write EDN with tags. They live in the
<code class="language-plaintext highlighter-rouge">taggie.edn</code> namespace. Use it as follows:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">edn-dump</span><span class="w">
  </span><span class="p">(</span><span class="nf">taggie.edn/write-string</span><span class="w"> </span><span class="o">#</span><span class="n">atom</span><span class="w"> </span><span class="p">{</span><span class="no">:test</span><span class="w"> </span><span class="mi">1</span><span class="w">
                                  </span><span class="no">:values</span><span class="w"> </span><span class="o">#</span><span class="n">longs</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="p">]</span><span class="w">
                                  </span><span class="no">:created-at</span><span class="w"> </span><span class="o">#</span><span class="n">LocalDate</span><span class="w"> </span><span class="s">"2025-01-01"</span><span class="p">}))</span><span class="w">

</span><span class="p">(</span><span class="nb">println</span><span class="w"> </span><span class="n">edn-dump</span><span class="p">)</span><span class="w">

</span><span class="c1">;; #atom {:test 1,</span><span class="w">
</span><span class="c1">;;        :values #longs [1, 2, 3],</span><span class="w">
</span><span class="c1">;;        :created-at #LocalDate "2025-01-01"}</span><span class="w">
</span></code></pre></div></div>

<p>It produces a string with custom tags and data being pretty printed. Let’s read
it back:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">taggie.edn/read-string</span><span class="w"> </span><span class="n">edn-dump</span><span class="p">)</span><span class="w">

</span><span class="o">#</span><span class="n">atom</span><span class="w"> </span><span class="p">{</span><span class="no">:test</span><span class="w"> </span><span class="mi">1</span><span class="n">,</span><span class="w">
       </span><span class="no">:values</span><span class="w"> </span><span class="o">#</span><span class="n">longs</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="n">,</span><span class="w"> </span><span class="mi">2</span><span class="n">,</span><span class="w"> </span><span class="mi">3</span><span class="p">]</span><span class="n">,</span><span class="w">
       </span><span class="no">:created-at</span><span class="w"> </span><span class="o">#</span><span class="n">LocalDate</span><span class="w"> </span><span class="s">"2025-01-01"</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">write</code> function writes EDN into a destination which might be a file path, a
file, an output stream, a writer, etc:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">taggie.edn/write</span><span class="w"> </span><span class="p">(</span><span class="nf">clojure.java.io/file</span><span class="w"> </span><span class="s">"data.edn"</span><span class="p">)</span><span class="w">
                  </span><span class="p">{</span><span class="no">:test</span><span class="w"> </span><span class="p">(</span><span class="nf">atom</span><span class="w"> </span><span class="p">(</span><span class="nb">ref</span><span class="w"> </span><span class="p">(</span><span class="nf">atom</span><span class="w"> </span><span class="no">:secret</span><span class="p">)))})</span><span class="w">
</span></code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">read</code> function reads EDN from any kind of source: a file path, a file, in
input stream, a reader, etc. Internally, a source is transformed into the
<code class="language-plaintext highlighter-rouge">PushbackReader</code> instance:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">taggie.edn/read</span><span class="w"> </span><span class="p">(</span><span class="nf">clojure.java.io/file</span><span class="w"> </span><span class="s">"data.edn"</span><span class="p">))</span><span class="w">

</span><span class="p">{</span><span class="no">:test</span><span class="w"> </span><span class="o">#</span><span class="n">atom</span><span class="w"> </span><span class="o">#</span><span class="nb">ref</span><span class="w"> </span><span class="o">#</span><span class="n">atom</span><span class="w"> </span><span class="no">:secret</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Both <code class="language-plaintext highlighter-rouge">read</code> and <code class="language-plaintext highlighter-rouge">read-string</code> accept standard <code class="language-plaintext highlighter-rouge">clojure.edn/read</code> options,
e.g. <code class="language-plaintext highlighter-rouge">:readers</code>, <code class="language-plaintext highlighter-rouge">:eof</code>, etc. The <code class="language-plaintext highlighter-rouge">:readers</code> map gets merged with a global map
of custom tags.</p>

<h2 id="motivation">Motivation</h2>

<p>Aside from jokes, this library might save your day. I often see people dump data
into .edn files, and the data has atoms, regular expressions, exceptions, and
other unreadable types:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">spit</span><span class="w"> </span><span class="s">"data.edn"</span><span class="w">
      </span><span class="p">(</span><span class="nb">with-out-str</span><span class="w">
        </span><span class="p">(</span><span class="nf">clojure.pprint/pprint</span><span class="w">
          </span><span class="p">{</span><span class="no">:regex</span><span class="w"> </span><span class="o">#</span><span class="s">"foobar"</span><span class="w">
           </span><span class="no">:atom</span><span class="w"> </span><span class="p">(</span><span class="nf">atom</span><span class="w"> </span><span class="mi">42</span><span class="p">)</span><span class="w">
           </span><span class="no">:error</span><span class="w"> </span><span class="p">(</span><span class="nf">ex-info</span><span class="w"> </span><span class="s">"boom"</span><span class="w"> </span><span class="p">{</span><span class="no">:test</span><span class="w"> </span><span class="mi">1</span><span class="p">})})))</span><span class="w">

</span><span class="p">(</span><span class="nb">println</span><span class="w"> </span><span class="p">(</span><span class="nb">slurp</span><span class="w"> </span><span class="s">"data.edn"</span><span class="p">))</span><span class="w">

</span><span class="p">{</span><span class="no">:regex</span><span class="w"> </span><span class="o">#</span><span class="s">"foobar"</span><span class="n">,</span><span class="w"> </span><span class="no">:atom</span><span class="w"> </span><span class="o">#</span><span class="n">&lt;Atom</span><span class="o">@</span><span class="mi">4</span><span class="n">f7aa8aa</span><span class="err">:</span><span class="w"> </span><span class="mi">42</span><span class="n">&gt;,</span><span class="w"> </span><span class="no">:error</span><span class="w"> </span><span class="o">#</span><span class="n">error</span><span class="w"> </span><span class="p">{</span><span class="w">
 </span><span class="no">:cause</span><span class="w"> </span><span class="s">"boom"</span><span class="w">
 </span><span class="no">:data</span><span class="w"> </span><span class="p">{</span><span class="no">:test</span><span class="w"> </span><span class="mi">1</span><span class="p">}</span><span class="w">
 </span><span class="no">:via</span><span class="w">
 </span><span class="p">[{</span><span class="no">:type</span><span class="w"> </span><span class="n">clojure.lang.ExceptionInfo</span><span class="w">
   </span><span class="no">:message</span><span class="w"> </span><span class="s">"boom"</span><span class="w">
   </span><span class="no">:data</span><span class="w"> </span><span class="p">{</span><span class="no">:test</span><span class="w"> </span><span class="mi">1</span><span class="p">}</span><span class="w">
   </span><span class="no">:at</span><span class="w"> </span><span class="p">[</span><span class="n">user$eval43373$fn__43374</span><span class="w"> </span><span class="n">invoke</span><span class="w"> </span><span class="s">"form-init6283045849674730121.clj"</span><span class="w"> </span><span class="mi">2248</span><span class="p">]}]</span><span class="w">
 </span><span class="no">:trace</span><span class="w">
 </span><span class="p">[[</span><span class="n">user$eval43373$fn__43374</span><span class="w"> </span><span class="n">invoke</span><span class="w"> </span><span class="s">"form-init6283045849674730121.clj"</span><span class="w"> </span><span class="mi">2248</span><span class="p">]</span><span class="w">
  </span><span class="p">[</span><span class="n">user$eval43373</span><span class="w"> </span><span class="n">invokeStatic</span><span class="w"> </span><span class="s">"form-init6283045849674730121.clj"</span><span class="w"> </span><span class="mi">2244</span><span class="p">]</span><span class="w">
  </span><span class="c1">;; truncated</span><span class="w">
  </span><span class="p">[</span><span class="n">clojure.lang.AFn</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="s">"AFn.java"</span><span class="w"> </span><span class="mi">22</span><span class="p">]</span><span class="w">
  </span><span class="p">[</span><span class="n">java.lang.Thread</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="s">"Thread.java"</span><span class="w"> </span><span class="mi">833</span><span class="p">]]}}</span><span class="w">
</span></code></pre></div></div>

<p>This dump cannot be read back due to:</p>

<ol>
  <li>unknown <code class="language-plaintext highlighter-rouge">#"foobar"</code> tag (EDN doesn’t support regex);</li>
  <li>broken <code class="language-plaintext highlighter-rouge">#&lt;Atom@4f7aa8aa: 42&gt;</code> expression;</li>
  <li>unknown <code class="language-plaintext highlighter-rouge">#error</code> tag.</li>
</ol>

<p>But with Taggie, the same data produces tagged fields that <strong>can</strong> be read back.</p>

<h2 id="supported-types">Supported Types</h2>

<p>In alphabetic order:</p>

<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Example</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">java.nio.ByteBuffer</code></td>
      <td><code class="language-plaintext highlighter-rouge">#ByteBuffer [0 1 2]</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">java.util.Date</code></td>
      <td><code class="language-plaintext highlighter-rouge">#Date "2025-01-06T14:03:23.819Z"</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">java.time.Duration</code></td>
      <td><code class="language-plaintext highlighter-rouge">#Duration "PT72H"</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">java.io.File</code></td>
      <td><code class="language-plaintext highlighter-rouge">#File "/path/to/file.txt"</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">java.time.Instant</code></td>
      <td><code class="language-plaintext highlighter-rouge">#Instant "2025-01-06T14:03:23.819994Z"</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">java.time.LocalDate</code></td>
      <td><code class="language-plaintext highlighter-rouge">#LocalDate "2034-01-30"</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">java.time.LocalDateTime</code></td>
      <td><code class="language-plaintext highlighter-rouge">#LocalDateTime "2025-01-08T11:08:13.232516"</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">java.time.LocalTime</code></td>
      <td><code class="language-plaintext highlighter-rouge">#LocalTime "20:30:56.928424"</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">java.time.MonthDay</code></td>
      <td><code class="language-plaintext highlighter-rouge">#MonthDay "--02-07"</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">java.time.OffsetDateTime</code></td>
      <td><code class="language-plaintext highlighter-rouge">#OffsetDateTime "2025-02-07T20:31:22.513785+04:00"</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">java.time.OffsetTime</code></td>
      <td><code class="language-plaintext highlighter-rouge">#OffsetTime "20:31:39.516036+03:00"</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">java.time.Period</code></td>
      <td><code class="language-plaintext highlighter-rouge">#Period "P1Y2M3D"</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">java.net.URI</code></td>
      <td><code class="language-plaintext highlighter-rouge">#URI "foobar://test.com/path?foo=1"</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">java.net.URL</code></td>
      <td><code class="language-plaintext highlighter-rouge">#URL "https://clojure.org"</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">java.time.Year</code></td>
      <td><code class="language-plaintext highlighter-rouge">#Year "2025"</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">java.time.YearMonth</code></td>
      <td><code class="language-plaintext highlighter-rouge">#YearMonth "2025-02"</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">java.time.ZoneId</code></td>
      <td><code class="language-plaintext highlighter-rouge">#ZoneId "Europe/Paris"</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">java.time.ZoneOffset</code></td>
      <td><code class="language-plaintext highlighter-rouge">#ZoneOffset "-08:00"</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">java.time.ZonedDateTime</code></td>
      <td><code class="language-plaintext highlighter-rouge">#ZonedDateTime "2025-02-07T20:32:33.309294+01:00[Europe/Paris]"</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">clojure.lang.Atom</code></td>
      <td><code class="language-plaintext highlighter-rouge">#atom {:inner 'state}</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">boolean[]</code></td>
      <td><code class="language-plaintext highlighter-rouge">#booleans [true false]</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">byte[]</code></td>
      <td><code class="language-plaintext highlighter-rouge">#bytes [1 2 3]</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">char[]</code></td>
      <td><code class="language-plaintext highlighter-rouge">#chars [\a \b \c]</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">double[]</code></td>
      <td><code class="language-plaintext highlighter-rouge">#doubles [1.1 2.2 3.3]</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">Throwable-&gt;map</code></td>
      <td><code class="language-plaintext highlighter-rouge">#error &lt;result of Throwable-&gt;map&gt;</code> (see below)</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">float[]</code></td>
      <td><code class="language-plaintext highlighter-rouge">#floats [1.1 2.2 3.3]</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">int[]</code></td>
      <td><code class="language-plaintext highlighter-rouge">#ints [1 2 3]</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">long[]</code></td>
      <td><code class="language-plaintext highlighter-rouge">#longs [1 2 3]</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">Object[]</code></td>
      <td><code class="language-plaintext highlighter-rouge">#objects ["test" :foo 42 #atom false]</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">clojure.lang.Ref</code></td>
      <td><code class="language-plaintext highlighter-rouge">#ref {:test true}</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">java.util.regex.Pattern</code></td>
      <td><code class="language-plaintext highlighter-rouge">#regex "vesion: \d+"</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">java.sql.Timestamp</code></td>
      <td><code class="language-plaintext highlighter-rouge">#sql/Timestamp "2025-01-06T14:03:23.819Z"</code></td>
    </tr>
  </tbody>
</table>

<p>The <code class="language-plaintext highlighter-rouge">#error</code> tag is a bit special: it returns a value with no parsing. It
prevents an error when reading the result of printing of an exception:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nb">println</span><span class="w"> </span><span class="p">(</span><span class="nf">ex-info</span><span class="w"> </span><span class="s">"boom"</span><span class="w"> </span><span class="p">{</span><span class="no">:test</span><span class="w"> </span><span class="mi">123</span><span class="p">}))</span><span class="w">

</span><span class="o">#</span><span class="n">error</span><span class="w"> </span><span class="p">{</span><span class="w">
 </span><span class="no">:cause</span><span class="w"> </span><span class="n">boom</span><span class="w">
 </span><span class="no">:data</span><span class="w"> </span><span class="p">{</span><span class="no">:test</span><span class="w"> </span><span class="mi">123</span><span class="p">}</span><span class="w">
 </span><span class="no">:via</span><span class="w">
 </span><span class="p">[{</span><span class="no">:type</span><span class="w"> </span><span class="n">clojure.lang.ExceptionInfo</span><span class="w">
   </span><span class="no">:message</span><span class="w"> </span><span class="n">boom</span><span class="w">
   </span><span class="no">:data</span><span class="w"> </span><span class="p">{</span><span class="no">:test</span><span class="w"> </span><span class="mi">123</span><span class="p">}</span><span class="w">
   </span><span class="no">:at</span><span class="w"> </span><span class="p">[</span><span class="n">taggie.edn$eval9263</span><span class="w"> </span><span class="n">invokeStatic</span><span class="w"> </span><span class="n">form-init2367470449524935680.clj</span><span class="w"> </span><span class="mi">97</span><span class="p">]}]</span><span class="w">
 </span><span class="no">:trace</span><span class="w">
 </span><span class="p">[[</span><span class="n">taggie.edn$eval9263</span><span class="w"> </span><span class="n">invokeStatic</span><span class="w"> </span><span class="n">form-init2367470449524935680.clj</span><span class="w"> </span><span class="mi">97</span><span class="p">]</span><span class="w">
  </span><span class="p">[</span><span class="n">taggie.edn$eval9263</span><span class="w"> </span><span class="n">invoke</span><span class="w"> </span><span class="n">form-init2367470449524935680.clj</span><span class="w"> </span><span class="mi">97</span><span class="p">]</span><span class="w">
  </span><span class="c1">;; truncated</span><span class="w">
  </span><span class="p">[</span><span class="n">java.lang.Thread</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">Thread.java</span><span class="w"> </span><span class="mi">833</span><span class="p">]]}</span><span class="w">
</span></code></pre></div></div>

<p>When reading such data from EDN with Taggie, you’ll get a regular map.</p>

<h2 id="adding-your-types">Adding Your Types</h2>

<p>Imagine you have a custom type and you want Taggie to hande it:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">deftype</span><span class="w"> </span><span class="n">SomeType</span><span class="w"> </span><span class="p">[</span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="n">c</span><span class="p">])</span><span class="w">

</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">some-type</span><span class="w">
  </span><span class="p">(</span><span class="nb">new</span><span class="w"> </span><span class="n">SomeType</span><span class="w"> </span><span class="p">(</span><span class="nf">atom</span><span class="w"> </span><span class="no">:test</span><span class="p">)</span><span class="w">
                </span><span class="p">(</span><span class="nf">LocalDate/parse</span><span class="w"> </span><span class="s">"2023-01-03"</span><span class="p">)</span><span class="w">
                </span><span class="p">(</span><span class="nf">long-array</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="p">])))</span><span class="w">
</span></code></pre></div></div>

<p>To override the way it gets printed, run the <code class="language-plaintext highlighter-rouge">defprint</code> macro:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">taggie.print/defprint</span><span class="w"> </span><span class="n">SomeType</span><span class="w"> </span><span class="o">^</span><span class="n">SomeType</span><span class="w"> </span><span class="n">some-type</span><span class="w"> </span><span class="n">writer</span><span class="w">
  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">a</span><span class="w"> </span><span class="p">(</span><span class="nf">.-a</span><span class="w"> </span><span class="n">some-type</span><span class="p">)</span><span class="w">
        </span><span class="n">b</span><span class="w"> </span><span class="p">(</span><span class="nf">.-b</span><span class="w"> </span><span class="n">some-type</span><span class="p">)</span><span class="w">
        </span><span class="n">c</span><span class="w"> </span><span class="p">(</span><span class="nf">.-c</span><span class="w"> </span><span class="n">some-type</span><span class="p">)]</span><span class="w">
    </span><span class="p">(</span><span class="nf">.write</span><span class="w"> </span><span class="n">writer</span><span class="w"> </span><span class="s">"#SomeType "</span><span class="p">)</span><span class="w">
    </span><span class="p">(</span><span class="nf">print-method</span><span class="w"> </span><span class="p">[</span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="n">c</span><span class="p">]</span><span class="w"> </span><span class="n">writer</span><span class="p">)))</span><span class="w">
</span></code></pre></div></div>

<p>The first argument is a symbol bound to a class. The second is a symbol bound to
the instance of this class (in some cases you’ll need a type hint). The third
symbol is bound to the <code class="language-plaintext highlighter-rouge">Writer</code> instance. Inside the macro, you <code class="language-plaintext highlighter-rouge">.write</code> certain
values into the writer. Avobe, we write the leading <code class="language-plaintext highlighter-rouge">"#SomeType "</code> string, and a
vector of fields <code class="language-plaintext highlighter-rouge">a</code>, <code class="language-plaintext highlighter-rouge">b</code> and <code class="language-plaintext highlighter-rouge">c</code>. Calling <code class="language-plaintext highlighter-rouge">print-method</code> guarantees that all
nested data will be written with their custom tags.</p>

<p>Now if you print <code class="language-plaintext highlighter-rouge">some-type</code> or dump it into EDN, you’ll get:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">#</span><span class="n">SomeType</span><span class="w"> </span><span class="p">[</span><span class="o">#</span><span class="n">atom</span><span class="w"> </span><span class="no">:test</span><span class="w"> </span><span class="o">#</span><span class="n">LocalDate</span><span class="w"> </span><span class="s">"2023-01-03"</span><span class="w"> </span><span class="o">#</span><span class="n">longs</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="p">]]</span><span class="w">
</span></code></pre></div></div>

<p>The opposite step: define readers for <code class="language-plaintext highlighter-rouge">SomeType</code> class:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">taggie.readers/defreader</span><span class="w"> </span><span class="n">SomeType</span><span class="w"> </span><span class="p">[</span><span class="n">vect</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[[</span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="n">c</span><span class="p">]</span><span class="w"> </span><span class="n">vect</span><span class="p">]</span><span class="w">
    </span><span class="p">(</span><span class="nb">new</span><span class="w"> </span><span class="n">SomeType</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="n">c</span><span class="p">)))</span><span class="w">
</span></code></pre></div></div>

<p>It’s quite simple: the vector of fields is already parsed, so you only need to
split it and pass fields into the constructor.</p>

<p>The <code class="language-plaintext highlighter-rouge">defreader</code> mutates a global map of EDN readers. When you read an EDN
string, the <code class="language-plaintext highlighter-rouge">SomeType</code> will be held. But it won’t work in REPL: for example,
running <code class="language-plaintext highlighter-rouge">#SomeType [...]</code> in REPL will throw an error. The thing is, REPL
readers cannot be overriden in runtime.</p>

<p>But you can declare your own readers: in <code class="language-plaintext highlighter-rouge">src</code> directory, create a file called
<code class="language-plaintext highlighter-rouge">data_readers.clj</code> with a map:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="n">SomeType</span><span class="w"> </span><span class="n">some.namespace/__reader-SomeType-clj</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Restart the REPL, and now the tag will be available.</p>

<p>As you might have guessed, the <code class="language-plaintext highlighter-rouge">defreader</code> macro creates two functions:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">__reader-&lt;tag&gt;-clj</code> for a REPL reader;</li>
  <li><code class="language-plaintext highlighter-rouge">__reader-&lt;tag&gt;-edn</code> for an EDN reader.</li>
</ul>

<p>Each <code class="language-plaintext highlighter-rouge">-clj</code> reader relies on a corresponding <code class="language-plaintext highlighter-rouge">-edn</code> reader internally.</p>

<p><strong>Emacs &amp; Cider caveat:</strong> I noticed that <code class="language-plaintext highlighter-rouge">M-x cider-ns-refresh</code> command ruins
loading REPL tags. After this command being run, any attempt to execute
something like <code class="language-plaintext highlighter-rouge">#LocalDate "..."</code> ends up with an error saying “unbound
function”. Thus, if you use Emacs and Cider, avoid this command.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/just-use-postgres/">Просто берите Postgres</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2025-02-01T00:00:00+00:00">
        Feb 1, 2025
    </time>

    <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/postgres/" rel="tag">postgres</a>, <a href="/tag/sql/" rel="tag">sql</a>

</div>


            <div class="entry">
                
                    <p>Несколько месяцев назад завирусилась статья <a href="https://mccue.dev/pages/8-16-24-just-use-postgres">Just Use
Postgres</a>. Она была на всех
площадках, а том числе в переводе на русский. Я чуть было не репостнул ее, но
передумал. На проверку статья оказалось поверхностной: скажем, автор на полном
серьезе сравнивает Postgres с SQLite. Мне показалось, в статье нет глубины, и
тезис из заголовка ничем не подтверждается. И хотя вывод верный — Just Use
Postgres — автор пришел к нему странным способом.</p>

<p>В своей заметке я расскажу, как пришел к аналогичному выводу сам — только
доводов будет больше.</p>

<p>Последний год я занимаюсь Посгресом все активнее. Я мигрировал большую систему с
OpenSearch на Postgres. Это 30 сервисов с большими JSON-документами — от
нескольких тысяч до миллионов в каждом сервисе. Нужен поиск по вложенным полям,
поиск по вхождению, простое ранжирование, а также всякая отчетность. И пока я
все это мигрировал, узнал о Постгресе столько, что хватит на несколько
докладов. В том числе — почему именно Постгрес так хорош.</p>

<p>Я давно понял одну вещь, а миграция только ее укрепила. Хранение данных
определяет разработку. Это фундамент, относительно которого планируешь куда
копать и что возводить. Кто-то считает, что абстракцией можно уравновесить любое
хранилище: сделать так, что get-by-id либо идет в базу, либо качает файл из
S3. Это справедливо в простых случаях. На практике каждое хранилище вносит свои
особенности, с которыми нужно мириться. Если у вас условные OpenSearch или
Cassandra, их особенности будут фонить сквозь код. Избежать этого нельзя. На мой
взгляд, Постгрес фонит меньше всех: с ним у вас будет меньше проблем в
абстракцях.</p>

<p>Но довольно расплывчатых слов, перейдем к конкретике. Начну с того, что Постгрес
легко ставится и работает на любой машине, будь то локальный комп с Виндой,
Маком, Линуксом или сервер. Он есть во всех пакетах. Постгрес написан на Си, и
на выходе бинарный файл, которому не нужна Джава. Помню, как ставил Датомик на
Убунте — это было тяжело. Вроде бы Джава, “compile once, run everywhere (c)” —
но вылетают ошибки о том, что классы не найдены. Оказалось, нужна другая Джава,
которую нужно ставить отдельно. С Постгресом такого не было никогда.</p>

<p>Для Мака есть проект <a href="http://postgres.app/">Postgres.app</a>. Это приложение с
графическим интерфейсом, чтобы запустить Postgres. Можно скачать любую версию по
отдельности; есть убер-приложение со всеми версиями и установленным PostGis. Так
что любой человек может завести Postgres + PostGis в два клика.</p>

<p>Особой похвалы заслуживает <a href="https://hub.docker.com/_/postgres">докерный образ
Postgres</a>. Он очень гибко настраивается:
почти любую опцию можно задать переменной среды, легко прокинуть свою
конфигурацию. У образа убойная фича: папка, куда можно накидать файлы .sql, .sh
и .gz. При запуске образ запустит эти файлы в алфавитном порядке. Если у вас
миграции или посев тестовых данных, смонтируйте файлы в образ, и при запуске
получится готовая база.</p>

<p>По наивности я думал, что так работают образы других баз данных. Оказалось
нет. Запустил образ Кассандры, а она ничего не знает о первичной
настройке. Нужны разделы и таблицы? Создай сам. Нужны топики в Кафке? Создай
сам. Нужна точка обмена в RabbitMQ? Создай сам! После запуска образа нужно
дождаться, пока поднимутся все потроха (обычно это поллинг порта), а потом
создать таблицы и топики. Почему-то в Постгресе подумали над этим, а остальным
безразлично. Считаю, что образ postgres нужно брать за образец.</p>

<p>У документо-ориентированных баз и key-value хранилищ есть преимущество: они
хорошо реплицируются в силу дизайна. Часто говорят: вы со своим Постгресом
упретесь в потолок, когда нужно хранить данные в разных датацентрах, но при этом
иметь легкий доступ из одного центра к другому. Условная Кассандра чувствует
себя лучше в подобных условиях. Но забывают, что реплицировать нужно не все
данные, а только их часть. Например, только базовые сведения о пользователях и
сущностях, чтобы быстро выяснить, в каком дата-центре они лежат и выполнить
запрос там.</p>

<p>Так у нас было устроено в одном облачном хостинге. В каждом дата-центре данные
хранились в MySQL, а пользователи и права доступа дублировались в кластер
Кассанды, который в силу репликации был доступен отовсюду.</p>

<p>Postgres тоже не стоит на месте, и в нем все больше средств репликации и
кластеризации. Есть проекты вроде Debezium, которые читают журнал WAL и стримят
изменения в другие базы, очереди и так далее.</p>

<p>Postgres силен в проекции данных. Бывает, на одни и те же данные нужно смотреть
под разным углом: делать группировки, поворачивать таблицы. Часто нужны левые
соединения: это когда слева находится полный набор данных, а справа — неполный,
и данные слева не должны пропадать. В редких случаях нужно декартово
произведение двух таблиц (каждый по каждому), что тоже делается легко. Есть
много функций, которые разбивают данные на строки (переводят массивы в строки
элементов) и наоборот — агрегируют записи в коллекции.</p>

<p>Postgres силен рекурсивными запросами. Это когда запрос разбивается на две
части: первичный посев и рекурсивная логика, которая принимает предыдущий
результат и порождает новый. Пока он не пустой, строки складываются в итоговую
таблицу. За счет рекурсии прекрасно обходятся таблицы со ссылками на себя,
например структура папок, иерархия сущностей.</p>

<p>В финансах очень важны оконные функции: посчитать нарастающий доход, остаток на
счете, стоимость проекта по неделям и многое другое. Оконные функции слегка
пугают, но достаточно прочитать одну книжку, чтобы овладеть ими (см ниже). Без
оконных функций происходит следующее: человек выгребает из базы массив данных и
проделывает вручную то, что умеет база — только на порядок медленней и с кучей
багов. О похожем случае <a href="/postgres-csv/">я как-то уже писал</a>.</p>

<p>Огромную пользу можно получить из связки materialized view и pg_cron. Напомню,
materialized view — это вьюхи, которые сбрасываются в физическую таблицу. На нее
можно навесить индексы, чтобы ускорить поиск. Польза таких вьюх огромна — это
различные проекции и отчеты. Чтобы каждый раз не гонять огромный запрос, его
“запекают” во вьюху и материализуют, после чего выбирают строки обычным SELECT.</p>

<p>В текущем проекте мы храним огромные JSON-документы. У них сложная структура, но
отчетность должна быть плоской. Сначала я писал запросы со множеством операторов
<code class="language-plaintext highlighter-rouge">#&gt;&gt;</code>, которые извлекают данные из JSON по пути в виде массива. Но со временем
стал делать плоские представления этих документов вьюхами — и дело пошло
лучше. Аналитикам и менеджерам тоже легче: им постоянно нужные данные, и они
пишут запросы сами, чтобы не дергать программистов.</p>

<p>Расширение <a href="https://github.com/citusdata/pg_cron">pg_cron</a> выводит Постгрес на
новый уровень: с его помощью можно выполнить любой скрипт по
расписанию. Расширение использует стандартный синтаксис crontab. У меня
множество крон-задач на материализацию вьюх и прогрев индексов — их
принудительный загон в оперативную память. С <code class="language-plaintext highlighter-rouge">pg_cron</code> база становится полностью
автономной: не нужен сторонний крон, который пинает скрипты. Я недоволен только
одним: <code class="language-plaintext highlighter-rouge">pg_cron</code> — стороннее расширение, и его нет в поставке. Однако облачные
провайдеры вроде Амазона предустанавливают его.</p>

<p>На сегодня Постгрес — лучшая база для работы с JSON-документами. Я не в восторге
от JSON и насколько возможно, храню данные в таблицах. Но порой выбора нет:
бизнес завязан на какие-то стандарты. Пример — медицинский <a href="https://www.hl7.org/fhir/overview.html">формат
FHIR</a>. Это огромные документы тройной и
более вложенности. Раскладывать их по таблицам и собирать джоинами тяжело,
поэтому их хранят в поле jsonb. У меня похожая ситуация : 30 сервисов, каждый
отвечает за свою бизнес-сущность. Это большие JSON-ы, и сервисы гоняют их
туда-сюда; на них завязан фронтенд. Я пытался представить их в плоском виде, но
это очень трудно.</p>

<p>Постгрес предлагает богатные возможности для JSON: доступ ко вложенным полям по
массиву ключей, обновление вложенных полей, слияние словарей, гибкую замену,
индексацию документа целиком или подмножества… Есть даже встроенный язык <a href="https://www.postgresql.org/docs/current/functions-json.html#FUNCTIONS-SQLJSON-PATH">JSON
PATH</a>
для поиска! Да, внутри SQL может быть строка с мини-языком JSON PATH. Я
использую его в сочетании индексами btree по отдельным полям.</p>

<p>В последнем Постгресе 17 появилась функция
<a href="https://www.postgresql.org/docs/current/functions-json.html#FUNCTIONS-SQLJSON-TABLE">JSON_TABLE</a>. По
указанной спеке она переводит JSON в таблицу с выводом типов. Если у вас вектор
мап, то легко получить таблицу. JSON_TABLE поддерживает вложенность, в
результате чего можно развернуть мапу мап в плоскую таблицу. Далее вы
материализуете ее, ставите на крон и готово — можно выбрать плоские данные
селектом.</p>

<p>Для Постгреса создано великое число обучающих материалов: книг, курсов,
самоучителей. Многие из них изначально созданы на русском, то есть не являются
переводами. Российский вендор Postgres Pro не только пишет отличные книги, но и
<a href="https://postgrespro.ru/education/books">выкладывает на сайте</a>
бесплатно. Бесплатно! Я читал некоторые из них, и это не халтура, а
действительно проработанные материалы. Книга Егора Рогова “Postgres изнутри”
описывает устройство базы в мельчайших деталях. Наверное, нет книги лучше, чтобы
понять, как работают современные базы данных.</p>

<p>В Постгресе отличный анализатор запросов: он покажет, какие стратегии выбрал
движок для обхода таблиц и джоинов; какие индексы были использованы и какую их
часть пришлось читать с диска. Да, понадобится время, чтобы понять его вывод. Но
иные базы данных не предлагают вообще ничего! Просто дают рекомендации, а дальше
пробуй сам. Есть расширения, которые фиксируют медленные запросы и их план
выполнения. Расширение pg_stat_statements ведет статистику по всем запросам:
число вызовов, частота, минимальное, максимальное, среднее время выполнения,
ожидание, объем передачи данных и прочее. Все это помогает отлаживать случаи,
когда базе нехорошо.</p>

<p>В Постгресе достойный полнотекстовый поиск. Для начала подойдет <a href="https://www.postgresql.org/docs/current/pgtrgm.html">триграммный
нечеткий поиск</a> по
коэффициенту совпадения. Позже можно добавить ts_vector — вектор лексем и
стемминга. Из коробки есть стемминг для десятка языков, в том числе
русского. Когда заходят разговоры об OpenSearch и других поисковых движках,
оказывается, что на Постгресе можно сделать не хуже и главное — без добавления в
систему нового узла.</p>

<p>У Постгреса обширный тулинг: консольные и графические клиенты — браузерные и
настольные. PGAdmin, DBeaver, DataGrip… стандартная утилита psql покрывает
множество случаев. Она показывает сведения обо всех сущностях, выводит данные
разными способами, умеет импорт-экспорт. Можно редактировать запросы и сущности
во внешнем редакторе, например Emacs или Vim.</p>

<p>Постгрес поддерживает <a href="https://www.postgresql.org/docs/current/sql-copy.html">апишку
COPY</a>, с помощью которой
данные гоняют в обе стороны. Если я хочу слить таблицу в CSV, пишу что-то вроде:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">COPY</span> <span class="n">my_table</span> <span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">email</span><span class="p">)</span> <span class="k">to</span> <span class="k">STDOUT</span>
  <span class="k">with</span> <span class="p">(</span><span class="n">HEADER</span><span class="p">,</span> <span class="n">format</span> <span class="n">CSV</span><span class="p">)</span>
</code></pre></div></div>

<p>и Постгрес выплевывает CSV-шный файл. Можно записать файл на диск или читать
построчно из сети. Это работает и в обратную сторону: если я хочу вставить CSV в
таблицу, то пишу:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">COPY</span> <span class="n">my_table</span> <span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">email</span><span class="p">)</span> <span class="k">from</span> <span class="k">STDIN</span>
  <span class="k">with</span> <span class="p">(</span><span class="n">HEADER</span><span class="p">,</span> <span class="n">format</span> <span class="n">CSV</span><span class="p">)</span>
</code></pre></div></div>

<p>и стримлю в соединение строки CSV. Кроме CSV, Постгрес поддерживает бинарный
формат. Спецификация довольна проста, и на практике он работает на 30% быстрее.</p>

<p>Словом, гонять большие данные в Постгресе очень просто. Я как-то <a href="/pagination/">писал о
том</a>, что источник данных хорош настолько, насколько удобно
забрать из него данные. В том же OpenSearch забор данных превращается в муку:
нужна ручная пагинация по страницам. А Постгрес выплюнет миллион строк и не
моргнет глазом — только успевай их принимать.</p>

<p>Не менее важна генерация данных. Скажем, у вас на проде миллион записей, и нужно
воспроизвести сложный запрос. Если в локальной базе только тысяча записей, он
поведет себя по-другому; нужен именно миллион. Как вы их вставите?</p>

<p>Обычно на этом месте расчехляют Питон и всякие FakeMockGenerator-ы — библиотеки
для генерации случайных данных по спеке. Этот код долго писать, и вставка тоже
будет долгой, потому что мы передаем данные от клиента серверу. Еще нужен
рантайм, то есть среда, где запускается код: какая-то машина, нода, плейбук.</p>

<p>А ведь достаточно написать примерно такой скрипт и выполнить его в PGAdmin:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">insert</span> <span class="k">into</span> <span class="n">documents</span> <span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">document</span><span class="p">)</span>
<span class="k">select</span>
    <span class="n">gen_random_uuid</span><span class="p">()</span> <span class="k">as</span> <span class="n">id</span><span class="p">,</span>
    <span class="n">jsonb_build_object</span><span class="p">(</span>
        <span class="s1">'__generated__'</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span>
        <span class="s1">'meta'</span><span class="p">,</span> <span class="n">jsonb_build_object</span><span class="p">(</span>
            <span class="s1">'eyes'</span><span class="p">,</span> <span class="n">format</span><span class="p">(</span><span class="s1">'color-%s'</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="p">),</span>
        <span class="s1">'attrs'</span><span class="p">,</span> <span class="n">jsonb_build_object</span><span class="p">(</span>
            <span class="s1">'email'</span><span class="p">,</span> <span class="n">format</span><span class="p">(</span><span class="s1">'user-%s@test.com'</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span>
            <span class="s1">'name'</span><span class="p">,</span> <span class="n">format</span><span class="p">(</span><span class="s1">'Test Name %s'</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="p">),</span>
        <span class="s1">'roles'</span><span class="p">,</span> <span class="n">jsonb_build_array</span><span class="p">(</span>
            <span class="s1">'user'</span><span class="p">,</span>
            <span class="s1">'admin'</span>
        <span class="p">)</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">document</span>
<span class="k">from</span>
    <span class="n">generate_series</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span> <span class="k">as</span> <span class="n">x</span>
<span class="n">returning</span>
    <span class="n">id</span><span class="p">;</span>
</code></pre></div></div>

<p>Он вставит в базу столько JSON-документов, сколько указано в функции
generate_series. Хочешь миллион? Да пожалуйста. Важно, что данные генерятся
<strong>сразу на сервере</strong> — мы не гоняем их по сети. Все происходит внутри Постгреса,
и это значительно быстрее. Миллион огромных JSON-ов вставляются за несколько
минут. Этот скрипт легко поправить, чтобы поля высчитывались по-другому. Каждый
может скопировать его и выполнить на свой базе, не прибегая к Питону.</p>

<p>Иные жалуются, что SQL устарел. Мол, это архаичный язык, он плохо
шаблонизируется, и логично выразить его данными, например JSON-ом. Что тут
сказать… Да, SQL со скрипом ложится на всякие ORM. Но сегодня полно библиотек,
которые строят SQL из объектов и коллекций. А во-вторых, мне нравится
самобытность SQL, то, что он остается вещью в себе. Когда пишешь большие
запросы, начинаешь видеть его красоту. Со временем понимаешь, что заменить его
нечем — слишком много ситуаций и выражений.</p>

<p>Я рассматриваю SQL как REPL к данным. Наверное, вы знаете, что программисты на
Лиспе днями сидят в репле. О преимуществе REPL-driven develpoment сказано много,
и нет смысла повторять. По аналогии, SQL — это репл для данных со всеми
преимуществами REPL-driven develpoment. Легко понять, какие данные прилетят в
код, выполнив запрос в базе. Вместо быдлокода, который вынимает тысячи записей,
исправляет их и записывает в базу, можно выполнить один UPDATE. Поймал себя на
том, что целыми днями сижу в PGAdmin, а к коду приступаю в последнюю очередь.</p>

<p>Повторю тезис, который как-то высказывал. Данные — это отдельный домен. Ключевое
свойство домена — его ортогональность другим доменам. Я хочу, чтобы данные не
были привязаны ко всяким Питонам и Джавам. Я хочу управлять ими независимо от
языка или потребителей. Мне не нравятся встраиваемые хранилища или базы, которые
“сливаются” с приложением. Если данные можно извлечь только вызовом метода, я
пас.</p>

<p>Рассказывать о том, как динамично развивается Постгрес, нет смысла. Это видно
всем. Есть классический Постгрес, есть вендорский Postgres Pro, где доступны
различные фичи до того, как они окажутся в классике — правда, за
деньги. Развиваются расширения, появляются новые вендоры, проводят митапы и
конференции, выходят книги, видосы… на любой запрос найдется контент.</p>

<p>Важно, что сообщество Постгреса прошло проверку на адекватность. Как только один
<em>чудак</em> заявил, что нужно выгнать русских разработчиков и откатить их код, ему
быстро объяснили, что к чему. Больше эту тему не поднимали, по крайней мере в
публичном пространстве.</p>

<p>И вот теперь, в конце шестого листа, я говорю: <em>вот поэтому</em> берите Постгрес.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/solid-context/">SOLID и контекст</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2025-01-27T00:00:00+00:00">
        Jan 27, 2025
    </time>

    <a href="/tag/solid/" rel="tag">solid</a>

</div>


            <div class="entry">
                
                    <p>Когда говорят про SOLID, забывают вот о чем. Принцип SOLID — типичный пример,
когда контекст, в котором возникло явление, важнее самого явления.</p>

<p>SOLID возник в момент, когда в ООП-тусовке царил упадок. До повсеместного
перехода на ООП говорили, что объекты решат все проблемы. Достаточно выразить
сущности классами и нарисовать UML-схему — и все станет понятно. Звучит примерно
как “Земля плоская”, но тогда в это верили. И когда ООП-модель стала буксовать,
придумали SOLID, чтобы вдохнуть в нее новую жизнь.</p>

<p>У SOLID есть даже не аналогия, а буквальный пример из жизни. Каждый тренер
знает, что главное у спортсмена — настрой (разумеется, не исключая питание и
тренировки). Если настрой в упадке, есть не совсем честные способы его
поднять. Скажем, когда команда проигрывает всухую, тренер берет таймаут и выдает
“заряженные” клюшки, которыми играли великие спортсмены. Или переставляет
участников местами, говоря, что сейчас будем играть по “секретной”
тактике. Поскольку спортсмены суеверны, это работает.</p>

<p>Та же самая история у военных, полицейских, пожарных. У них есть церемонии
раздачи “заряженных” девайсов, например, касок погибших героев. Надевая такую
каску, боец буквально получает +100 к отваге. Вопрос о том, действительно ли
герой носил эту каску, тактично обойдем стороной.</p>

<p>С принципом SOLID то же самое. Когда стало ясно, что нагромождение классов не
решает прошлых проблем, а только добавляет новых, кто-то придумал SOLID. Посыл в
том, что отныне мы не блуждаем в потемках, а идем к некой цели. Пишем не просто
быдлокод, а по некой методичке. И пусть она спорна и расплывчата, это неважно —
есть ориентир. Спортсмен снова мотивирован и готов брать рубежи.</p>

<p>Поэтому отношение к SOLID у меня спорное. Смысловая составляющая высосана из
пальца, но запал колоссальный. Уже десятки лет люди спорят о том, как писать код
по SOLID правильно. В этом смысле я снимаю перед создателем шляпу, потому что
ведь надо так уметь! — вдохновить толпы народа без какой-либо конкретики.</p>

<p>Но у любой легенды есть запас прочности, и актуальность SOLID подходит к
концу. Я понимаю, когда о нем пишут в рекламных блогах или курсах для
новичков. SOLID — это все и ни о чем, универсальный рецепт, из которого можно
выжать тысячи текстов. Но удивляет, когда кто-то всерьез рассуждает о том, как в
2025 году писать код по SOLID. Здесь можно сказать одно: как бы ни держалась
стюардесса, ее пора закопать.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/solid-abbrev/">SOLID и другие аббревиатуры</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2025-01-27T00:00:00+00:00">
        Jan 27, 2025
    </time>

    <a href="/tag/solid/" rel="tag">solid</a>, <a href="/tag/anal-sex/" rel="tag">anal-sex</a>

</div>


            <div class="entry">
                
                    <p>Читатель Дмитрий снял с языка одну мысль, которую я приберег для отдельной
заметки. Если коротко, все удачные аббревиатуры вроде SOLID, как правило,
высосаны из пальца. Вероятность, что первые буквы пяти слов образуют другое
емкое слово, равна нулю. Поэтому слова подгоняют под аббревиатуру.</p>

<p>Другими словами, сначала придумывают емкий термин, затем под каждую букву ищется
слово. Разумеется, за уши притягивают лишние слова, как например принцип Liskov,
который никому не сдался. Но без Liskov не получилось бы слова, поэтому пришлось
взять.</p>

<p>В своем комментарии Дмитрий приводит пример. Берем выразительную аббревиатуру,
например ANALSEX и просим чат-ГПТ придумать расшифровку. Чат справился
прекрасно:</p>

<ul>
  <li>
    <p><strong>A: Abstraction</strong> Focus on hiding complex implementation details and exposing
only essential features.</p>
  </li>
  <li>
    <p><strong>N: Normalization</strong> Ensure that data structures and databases are designed
efficiently, avoiding redundancy.</p>
  </li>
  <li>
    <p><strong>A: Automation</strong> Prioritize automating repetitive tasks and workflows to
increase efficiency and reduce errors.</p>
  </li>
  <li>
    <p><strong>L: Loose Coupling</strong> Design components to have minimal dependencies, making
systems more modular and easier to maintain.</p>
  </li>
  <li>
    <p><strong>S: Scalability</strong> Build systems capable of handling growth in users, data,
and operations effectively.</p>
  </li>
  <li>
    <p><strong>E: Encapsulation</strong> Keep implementation details private within modules or
classes, exposing only necessary interfaces.</p>
  </li>
  <li>
    <p><strong>X: eXpandability</strong> Design with future growth and adaptability in mind,
ensuring that new features can be added without major rewrites.</p>
  </li>
</ul>

<p>Особенно хорош последний пункт. Слов на X мало, поэтому чат выделил вторую букву
в eXpandability.</p>

<p>И главное, все по делу: абстракции — нужны, автоматизация — нужна,
масштабирование — нужно, расширяемость — тоже. Не прикопаешься. Так что всем
внедрять ANALSEX! Обсудите с коллегами и расскажите начальству.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/edocs/">Электронные квитанции</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2025-01-27T00:00:00+00:00">
        Jan 27, 2025
    </time>

    <a href="/tag/life/" rel="tag">life</a>, <a href="/tag/planet/" rel="tag">planet</a>

</div>


            <div class="entry">
                
                    <p>Иногда снабжающие организации присылают письма:</p>

<blockquote>
  <p>Иван Викторович!</p>
</blockquote>

<blockquote>
  <p>Давайте беречь бумагу и планету! Перейдем на электронные квитанции во имя
добра. Согласны? Если да, откройте файл из вложения, заполните и отправьте.</p>
</blockquote>

<p>Конечно, я за природу, планету и все такое. Открываю файл <code class="language-plaintext highlighter-rouge">?????????????.doc</code> из
вложения, смотрю, а там: укажите ФИО, адрес, юридический адрес, ИНН, реквизиты
счета, телефон, номер и дату договора, почту, а еще — название документооборота
и фирму-эмитент электронной подписи. Всего-то…</p>

<p>Смотрю на этот файл минуту, а потом отправляю в корзину вместе с письмом. До
следующего раза.</p>

<p>Хочется спросить: ребята, если вам так нужно перетащить меня в какую-то систему,
нельзя ли этому поспособствовать? Скажем, поручить кодеру Васе написать скрипт,
который вытащит мои данные из базы — я указывал их при заключении договора — и
состряпает PDF, который останется только подписать. Что, нельзя так?</p>

<p>Наверняка эти письма рассчитаны на биг-боссов, которые пересылают их секретарше
Леночке со словами “разбери это дерьмо”. Но у меня нет секретарши, и тратить час
на заполнение Ворда я не хочу.</p>

<p>Самое забавное — фирма уже высылает документы по электронной почте, но вдобавок
зачем-то кладет в почтовый ящик распечатки толщиной с палец. Уже который раз
пишу им, мол, перестаньте слать бумагу, электронка вполне устраивает. Но им
нужно заявление в Ворде.</p>

<p>Удивительно, как быстро у людей деформируются мозги в больших фирмах.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/the-fuck/">The Fuck</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2025-01-24T00:00:00+00:00">
        Jan 24, 2025
    </time>

    <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/python/" rel="tag">python</a>, <a href="/tag/fuck/" rel="tag">fuck</a>

</div>


            <div class="entry">
                
                    
<p>Может быть, вы не знали, но есть программа с выразительным названием <a href="https://github.com/nvbn/thefuck">The
Fuck</a>. Написана на Питоне, 90 тысяч звезд, работает следующим образом.</p>

<p>Предположим, вы запустили что-то в терминале, но получили ошибку. Не указан
такой-то флаг, это депрекейтед, то-се. Если ввести <code class="language-plaintext highlighter-rouge">fuck</code>, то программа считает
предыдущую команду и повторит ее, но на этот раз правильно.</p>

<p>Звучит непонятно, так что рассмотрим пример. Скажем, я сделал новую ветку и хочу
запушить ее на сервер:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git checkout -b ssl-no-validation
git add .
git commit -m "some changes"
git push
</code></pre></div></div>

<p>Вот что я получу:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fatal: The current branch ssl-no-validation has no upstream branch.
To push the current branch and set the remote as upstream, use

    git push --set-upstream origin ssl-no-validation
</code></pre></div></div>

<p>Гит прекрасно понял, что я имел в виду, но предлагает ввести команду
повторно. Если же ввести <code class="language-plaintext highlighter-rouge">fuck</code>, то утилита считает bash_history и выполнит то,
что нравится Гиту.</p>

<p>В последнем Гите это починили: теперь <code class="language-plaintext highlighter-rouge">git push</code> делает апстрим
самостоятельно. Однако долгое время меня выручал fuck.</p>

<p>Сегодня я им не пользуюсь, но вспомнил вот почему. Программа хорошо расширяется
регулярками, и народ собрал целую кладезь fuck-рецептов. Получилась своего рода
энциклопедия бредовых случаев. Мне кажется, они достойны изучения просто затем,
чтобы знать, как делать не надо. Если же ваша программа оказалась среди рецептов
– это нужно быстро исправить.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/postgres-csv/">Постгрес и отчеты</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2025-01-24T00:00:00+00:00">
        Jan 24, 2025
    </time>

    <a href="/tag/postgres/" rel="tag">postgres</a>, <a href="/tag/sql/" rel="tag">sql</a>, <a href="/tag/csv/" rel="tag">csv</a>

</div>


            <div class="entry">
                
                    <p>В очередной раз выручил Постгрес.</p>

<p>По работе я много занимаюсь отчетностью: генерю CSV и эксельки со всякими
цифрами. Дело это не хитрое, но много нюансов: нужно собрать данные из десяти
источников, очистить, переколбасить, построить прямые и обратные индексы. В
идеале распараллелить. Потом пробежаться по коллекциям и записать итоговый
документ.</p>

<p>Поскольку дело происходит в лямбде, я очень стеснен в ресурсах и
времени. Процессор медленный, памяти и диска немного, а на выполнение дается не
более 15 минут. Это только кажется много, а на самом деле первые 7 минут уходят
только на то, чтобы скачать архивы.</p>

<p>Из последнего: в папке S3 лежит огромный CSV на 10 миллионов записей. Нужно
выбрать из него одно подмножество, затем второе, а потом склеить их по id =
parent_id.</p>

<p>Написал на Кложе черновик — работает, занимает 11 минут. Можно плюнуть и
оставить, но 11 минут — это уже близко к 15 минутам, а значит, можно получить
таймаут. Переписал с параллельной обработкой — стало 5 минут, волноваться не о
чем.</p>

<p>А потом смотрю и думаю: ты же, дурачок, написал ровно то, что делает база
данных. Только раз в десять медленней и костыльней. Убери быдлокод, загони CSV в
базу и выполни запрос — получишь то же самое.</p>

<p>Так и сделал: получаю из Амазона стрим с CSV-содержимым. Не скачивая его на
диск, направляю прямиком в Постгрес во временную таблицу (апишка COPY FROM
STDIN). Тот загружает 10 миллионов записей за 40 секунд. Потом посылаю SQL с
двумя подзапросами и джоином — результат готов за 15 секунд. Его даже не нужно
писать в CSV самому. Вызываешь COPY TO STDOUT — и Постгрес сам записывает CSV на
диск. Точнее, в стрим, который я направляю в файл.</p>

<p>Минус два экрана быдлокода, быстрее почти на порядок — все довольны, все
смеются. Сразу после этой доработки мне написал один человек — мол, репорт
хороший, только надо еще одну табличку заджойнить. Да не вопрос.</p>

<p>Отсюда мораль — если что-то можно поручить базе, поручайте базе. Постгрес уже 20
лет делает джоины и проекции таблиц. Вероятность того, что вы сделаете быстрее,
стремится к нулю.</p>

<p>Ради интереса глянул на SQLite — зачем брать серверный Постгрес, если можно
локально справиться? Оказалось, SQLite не умеет импортировать CSV. Такая команда
есть в интерактивном шелле, а в протоколе обмена — нет. А в Постгресе есть
потоковый COPY, поэтому выбора не остается.</p>

<p>Есть у нас сервис, который пилят другие люди. Там логика крутится вокруг CSV и
пакетного импорта в другие сервисы. Посмотрел и ужаснулся: километры кложурного
быдлокода можно заменить импортом в базу и парой-тройкой запросов. Дай бог
доберусь, переделаю.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/lol-1c/">Код на русском</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2025-01-24T00:00:00+00:00">
        Jan 24, 2025
    </time>

    <a href="/tag/1c/" rel="tag">1c</a>, <a href="/tag/life/" rel="tag">life</a>

</div>


            <div class="entry">
                
                    <p>Я как-то рассказывал про феномен: показываешь человеку код на Лиспе, и он
начинает хихикать, хрюкать, постить смайлики, словом, теряет всякое
лицо. Примерно как школьник, принесший в класс эротический журнал.</p>

<p>Заметил, что такая же ерунда с кодом на 1С. Если где-то всплывет код на русском,
начинаются крики, эмоции… ужасно.</p>

<p><img src="/assets/static/aws/lol-1c/1.jpeg" /></p>

<p>Я писал на 1С три с половиной года в Чите, в славном Энергосбыте. У нас были две
жирные программы: одна на Дельфях, вторая на 1С. Я поддеживал обе, и до сих пор
нежно люблю эти платформы.</p>

<p>Так вот, торжественно заявляю: код на русском поддерживается точно так же, как и
на английском. Разницы нет. Когда читаешь код, то воспринимаешь его как
структурированный набор команд. Никто не читает по буквам
“Если…То… Конец”. Глаз выделяет структуру, операторы, циклы, словом, все как
в обычном языке.</p>

<p>Да, у 1С свои проблемы. Во-первых, язык не отличается врожденной красотой, а
во-вторых, у 1С радикально низкий порог входа. Хотя то же самое можно сказать о
раннем PHP. Еще одна косвенная проблема – 1С стоит особняком от других
технологий, и в результате типичный 1С-программист ничего не знает о протоколах,
безопасности и алгоритмах.</p>

<p>Эти проблемы я признаю и готов обсуждать. Но когда очередной клоун смеется над
кодом с русскими буквами, боюсь, он получит только мое презрение.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/grumping/">Дети в телефонах</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2025-01-24T00:00:00+00:00">
        Jan 24, 2025
    </time>

    <a href="/tag/life/" rel="tag">life</a>, <a href="/tag/phones/" rel="tag">phones</a>

</div>


            <div class="entry">
                
                    <p>Разговаривал с пожилым человеком, и он выдал следующую мысль. Цитирую
максимально близко.</p>

<blockquote>
  <p>Мы, старики, часто бухтим, что дети сидят в телефонах. А разве пожилые люди
чем-то лучше? Еду в поезде — книги нет ни у кого, все от мала до велика в
телефонах и планшетах. Даже старики, которых в свое время приучали читать. На
работе у нас пять чатов в Вацапе: младшая группа, старшая, родители, педсовет,
бухгалтерия. И все туда пишут, отвечают, спорят. Постят картинки а-ля “с
добрым утром”. Набрасывают политические новости, уже на втором сообщении
переходят на личности. Бывает, три человека стоят в метре друг от друга и
пишут в один чат. Чем они отличаются от детей, которых мы ругаем? Если сами не
можем себя контролировать и каждую минуту открываем телефон, то что требовать
от детей? Они повторяют за нами.</p>
</blockquote>

<p>И я подумал: эту мысль стоит разместить здесь.</p>

                
            </div>

        </li>
        
    </ul>

    <h4>
        
        <a href="/" class="previous">&larr;</a>
        
        <span class="page_number ">Страница 2 из 90</span>
        
        <a href="/page3" class="next">&rarr;</a>
        
    </h4>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Ivan Grishaev's blog</li>
          <li><a href="mailto:ivan@grishaev.me">ivan@grishaev.me</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
            <li><a href="https://github.com/igrishaev">GitHub</a></li>
            <li><a href="https://t.me/igrishaev_blog">Telegram</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Writing on programming, education, books and negotiations.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
