<!DOCTYPE html>
<html lang="ru">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Ivan Grishaev's blog</title>
  <meta name="description" content="Writing on programming, education, books and negotiations.
">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/custom.css">
  <link rel="canonical" href="https://grishaev.me/page2/">
  <link rel="alternate" type="application/rss+xml" title="Ivan Grishaev's blog" href="https://grishaev.me/feed.xml">

  <link rel="shortcut icon" type="image/x-icon" href="/assets/static/favicons/favicon.ico">

  <script type="text/javascript" src="/assets/typo.js"></script>

</head>


  <body>
    <header class="site-header">

    <div class="wrapper flex-container">

        <div>
            <a href="/">
                <img id="avatar" src="/assets/static/avatar.jpg" alt="Ivan Grishaev">
            </a>
        </div>

        <div class="flex-container-vert" style="margin-left: 15px; width: 80%">

            <div class="flex-container full-width">
                <p style="margin-bottom: 5px">Ivan Grishaev's blog</p>
                <div class="flex-huge"></div>
                <div >
<form id="search-form"
      target="_blank"
      style="display: inline"
      method="get"
      action="https://www.google.com/search">

    <input name="sitesearch"
           value="grishaev.me"
           type="hidden">

    <input type="text"
           required="required"
           name="q"
           placeholder="Google search..."
           autocomplete="off">

    <button style="border: none; background-color: transparent; cursor: pointer;"
            type="submit">&#x1f50d;</button>

</form>
</div>
            </div>

            <p><small>Writing on programming, education, books and negotiations.
</small></p>

            <div class="flex-container">
                <a class="menu-item" href="/">Home</a>
                <a class="menu-item" href="/about/">About</a>
                <a class="menu-item" href="/bookshelf/">Bookshelf</a>
                <a class="menu-item" href="/feed.xml">RSS</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor" href="/tag/clojure/">Clojure</a>
                <a class="menu-item minor" href="/tag/emacs/">Emacs</a>
                <a class="menu-item minor" href="/tag/python/">Python</a>
                <a class="menu-item minor" href="/tag/programming/">Programming</a>
                <a class="menu-item minor" href="/interview/">Interview</a>
                <a class="menu-item minor" href="/video/">Video</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor hl" href="/clojure-in-prod/">Книга «Clojure на производстве»</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor hl" href="/clojure-in-prod-2/">Книга «Clojure на производстве», второй том</a>
            </div>

        </div>
    </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="home">

    <ul class="post-list">
        
        <li>

            <h2>
                <a class="post-link" href="/en/pg-docs/05/">PG docs, part 5. Notifications</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2023-09-15T00:00:00+00:00">
        Sep 15, 2023
    </time>

    <a href="/tag/clojure/" rel="tag">clojure</a>, <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/postgres/" rel="tag">postgres</a>, <a href="/tag/sql/" rel="tag">sql</a>, <a href="/tag/notifications/" rel="tag">notifications</a>

</div>


            <div class="entry">
                
                    
<p><em>(This is a new documentation chapter from the <a href="https://github.com/igrishaev/pg">PG project</a>.)</em></p>

<p><strong>ToC</strong></p>

<ul>
  <li><a href="/en/pg-docs/01/">About &amp; Installation</a></li>
  <li><a href="/en/pg-docs/02/">The Client</a></li>
  <li><a href="/en/pg-docs/03/">Connection Pool</a></li>
  <li><a href="/en/pg-docs/04/">Arrays</a></li>
  <li><a href="/en/pg-docs/05/">Notifications</a></li>
</ul>

<h2 id="notifications">Notifications</h2>

<!-- toc -->

<ul>
  <li><a href="#introduction">Introduction</a></li>
  <li><a href="#usage">Usage</a></li>
</ul>

<!-- tocstop -->

<h3 id="introduction">Introduction</h3>

<p>Notifications are somewhat pub-sub message systems in Postgres. They can be
described in these simple steps:</p>

<ul>
  <li>
    <p>client B subscribes to a channel; the channel gets created if it doesn’t
exist.</p>
  </li>
  <li>
    <p>client A sends a message to that channel;</p>
  </li>
  <li>
    <p>every time client B interacts with the database, they receive messages sent to
this channel by other clients.</p>
  </li>
</ul>

<p>To handle a message, the client invokes a special handler. This handler comes
from the configuration. The default handler just prints the notification
map. <strong>Pay attention</strong> that the handler is called synchronously blocking the
interaction with a socket. To prevent the connection from hanging due to the
time-consuming handling of a notification, provide a handler that sends it to
some sort of channel, agent, or message queue system.</p>


                    <p><a href="/en/pg-docs/05/">Read more &rarr;</a></p>
                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/en/pg-docs/04/">PG docs, part 4. Arrays</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2023-09-12T00:00:00+00:00">
        Sep 12, 2023
    </time>

    <a href="/tag/clojure/" rel="tag">clojure</a>, <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/postgres/" rel="tag">postgres</a>, <a href="/tag/sql/" rel="tag">sql</a>, <a href="/tag/arrays/" rel="tag">arrays</a>

</div>


            <div class="entry">
                
                    
<p><em>(This is a new documentation chapter from the <a href="https://github.com/igrishaev/pg">PG project</a>.)</em></p>

<p><strong>ToC</strong></p>

<ul>
  <li><a href="/en/pg-docs/01/">About &amp; Installation</a></li>
  <li><a href="/en/pg-docs/02/">The Client</a></li>
  <li><a href="/en/pg-docs/03/">Connection Pool</a></li>
  <li><a href="/en/pg-docs/04/">Arrays</a></li>
  <li><a href="/en/pg-docs/05/">Notifications</a></li>
</ul>

<p>In JDBC, arrays have always been a pain. Every time you want to pass an array to
the database or read it back, you’ve got to wrap your data with various Java
classes, extend protocols, and multimethods. We do it in each project, and it
doesn’t have to be like this.</p>

<p>The recent release of PG ships a significant feature: arrays. You can pass an
array to a query and read it back as easily as they were native Clojure
vectors. No more ceremonies with classes, manual parsing, etc.</p>


                    <p><a href="/en/pg-docs/04/">Read more &rarr;</a></p>
                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/en/pg-docs/03/">PG docs, part 3</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2023-09-05T00:00:00+00:00">
        Sep 5, 2023
    </time>

    <a href="/tag/clojure/" rel="tag">clojure</a>, <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/postgres/" rel="tag">postgres</a>, <a href="/tag/sql/" rel="tag">sql</a>

</div>


            <div class="entry">
                
                    
<p><em>(This is a new documentation chapter from the <a href="https://github.com/igrishaev/pg">PG project</a>.)</em></p>

<p><strong>ToC</strong></p>

<ul>
  <li><a href="/en/pg-docs/01/">About &amp; Installation</a></li>
  <li><a href="/en/pg-docs/02/">The Client</a></li>
  <li><a href="/en/pg-docs/03/">Connection Pool</a></li>
  <li><a href="/en/pg-docs/04/">Arrays</a></li>
  <li><a href="/en/pg-docs/05/">Notifications</a></li>
</ul>

<h1 id="connection-pool">Connection Pool</h1>

<ul>
  <li><a href="#basic-usage">Basic usage</a></li>
  <li><a href="#with-pool--with-open">With-pool &amp; with-open</a></li>
  <li><a href="#config">Config</a></li>
  <li><a href="#thread-safety">Thread safety</a></li>
  <li><a href="#pool-exhausting">Pool Exhausting</a></li>
  <li><a href="#exception-handling">Exception handling</a></li>
  <li><a href="#logs">Logs</a></li>
  <li><a href="#component">Component</a></li>
</ul>

<p>To interact with a database effectively, you need a connection pool. A single
connection is fragile on its own: you can easily lose it by an accidental lag in
the network.</p>

<p>Another thing that is worth bearing in mind is, that opening a new connection
every time you want to reach PostgreSQL is expensive. Every connection starts a
new process on the server. If your code opens too many connections, say in a
cycle or within threads/futures, sooner or later you’ll reach an error response
saying “too many connections”.</p>

<p>The connection pool is an object that holds several open connections at once. It
allows you to <em>borrow</em> a connection for some period of time. A borrowed
connection can be only used in a block of code that has borrowed it but nowhere
else. Once the block of code has done with its duties, the connection gets
returned to the pool.</p>

<p>The pool is also capable of calculating the lifetime of connections and their
expiration moments. Once a connection has expired, it gets terminated and the
pool spawns a new connection.</p>

<p>The connection pool is shipped in a dedicated library
<code class="language-plaintext highlighter-rouge">com.github.igrishaev/pg-pool</code> as it depends on the logging facility.</p>


                    <p><a href="/en/pg-docs/03/">Read more &rarr;</a></p>
                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/en/pg-docs/02/">PG docs, part 2</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2023-08-31T00:00:00+00:00">
        Aug 31, 2023
    </time>

    <a href="/tag/clojure/" rel="tag">clojure</a>, <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/postgres/" rel="tag">postgres</a>, <a href="/tag/sql/" rel="tag">sql</a>

</div>


            <div class="entry">
                
                    
<p><strong>ToC</strong></p>

<ul>
  <li><a href="/en/pg-docs/01/">About &amp; Installation</a></li>
  <li><a href="/en/pg-docs/02/">The Client</a></li>
  <li><a href="/en/pg-docs/03/">Connection Pool</a></li>
  <li><a href="/en/pg-docs/04/">Arrays</a></li>
  <li><a href="/en/pg-docs/05/">Notifications</a></li>
</ul>

<p>In this chapter, we’ll discuss how to reach Postgres using the <a href="https://github.com/igrishaev/pg">Client library</a>.</p>

<ul>
  <li><a href="#basic-usage">Basic usage</a></li>
  <li><a href="#queries">Queries</a></li>
  <li><a href="#execute">Execute</a></li>
  <li><a href="#prepared-statements">Prepared Statements</a></li>
  <li><a href="#processing-result-with-fn-result">Processing result with :fn-result</a></li>
  <li><a href="#column-names">Column names</a></li>
  <li><a href="#column-duplicates">Column duplicates</a></li>
  <li><a href="#reducers-and-bundles">Reducers and bundles</a>
    <ul>
      <li><a href="#java">Java</a></li>
      <li><a href="#kebab-keys">Kebab-keys</a></li>
      <li><a href="#matrix">Matrix</a></li>
      <li><a href="#index-by">Index by</a></li>
      <li><a href="#group-by">Group by</a></li>
      <li><a href="#key-value">Key-value</a></li>
      <li><a href="#custom-reducers">Custom reducers</a></li>
    </ul>
  </li>
  <li><a href="#transactions">Transactions</a>
    <ul>
      <li><a href="#always-rollback">Always Rollback</a></li>
      <li><a href="#read-only">Read-only</a></li>
      <li><a href="#isolation-level">Isolation level</a></li>
      <li><a href="#manual-transactions-and-status-check">Manual transactions and status check</a></li>
    </ul>
  </li>
  <li><a href="#configuration">Configuration</a></li>
  <li><a href="#authorization">Authorization</a></li>
  <li><a href="#cloning-a-connection">Cloning a connection</a></li>
  <li><a href="#cancelling-a-query">Cancelling a query</a></li>
  <li><a href="#notices">Notices</a></li>
  <li><a href="#thread-safety">Thread safety</a></li>
  <li><a href="#debugging">Debugging</a></li>
</ul>

<!-- tocstop -->

<h2 id="basic-usage">Basic usage</h2>

<p>Here is a brief example of using the client library:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">ns</span><span class="w"> </span><span class="n">scratch</span><span class="w">
  </span><span class="p">(</span><span class="no">:require</span><span class="w">
   </span><span class="p">[</span><span class="n">pg.client</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">pg</span><span class="p">]))</span><span class="w">

</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">config</span><span class="w">
  </span><span class="p">{</span><span class="no">:host</span><span class="w"> </span><span class="s">"127.0.0.1"</span><span class="w">
   </span><span class="no">:port</span><span class="w"> </span><span class="mi">5432</span><span class="w">
   </span><span class="no">:user</span><span class="w"> </span><span class="s">"test"</span><span class="w">
   </span><span class="no">:password</span><span class="w"> </span><span class="s">"test"</span><span class="w">
   </span><span class="no">:database</span><span class="w"> </span><span class="s">"test"</span><span class="p">})</span><span class="w">

</span><span class="p">(</span><span class="nf">pg/with-connection</span><span class="w"> </span><span class="p">[</span><span class="n">conn</span><span class="w"> </span><span class="n">config</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nf">pg/query</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="s">"select 1 as one"</span><span class="p">))</span><span class="w">

</span><span class="c1">;; [{:one 1}]</span><span class="w">
</span></code></pre></div></div>

<p>First, you import the <code class="language-plaintext highlighter-rouge">pg.client</code> namespace which brings the top-level API functions to interact with Postgres. The <code class="language-plaintext highlighter-rouge">config</code> map above specifies the minimal configuration;
it might have more fields which we will explore in a separate section.</p>

<p>The <code class="language-plaintext highlighter-rouge">with-connection</code> macro establishes a new connection, binds it to the <code class="language-plaintext highlighter-rouge">conn</code>
symbol, and executes the body. The connection is closed afterward, even if an
exception pops up.</p>

<p>Technically you can open and terminate a connection manually like this:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">conn</span><span class="w"> </span><span class="p">(</span><span class="nf">pg/connect</span><span class="w"> </span><span class="n">config</span><span class="p">)</span><span class="w">
      </span><span class="n">data</span><span class="w"> </span><span class="p">(</span><span class="nf">pg/query</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="s">"select 1 as one"</span><span class="p">)]</span><span class="w">
  </span><span class="p">(</span><span class="nf">pg/terminate</span><span class="w"> </span><span class="n">conn</span><span class="p">)</span><span class="w">
  </span><span class="n">data</span><span class="p">)</span><span class="w">

</span><span class="c1">;; [{:one 1}]</span><span class="w">
</span></code></pre></div></div>

<p>but it’s not recommended. Also, since the <code class="language-plaintext highlighter-rouge">Connection</code> object implements
<code class="language-plaintext highlighter-rouge">java.io.Closeable</code>, it’s possible to use it in <code class="language-plaintext highlighter-rouge">with-open</code>:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nb">with-open</span><span class="w"> </span><span class="p">[</span><span class="n">conn</span><span class="w"> </span><span class="p">(</span><span class="nf">pg/connect</span><span class="w"> </span><span class="n">config</span><span class="p">)]</span><span class="w">
  </span><span class="p">(</span><span class="nf">pg/query</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="s">"select 1 as one"</span><span class="p">))</span><span class="w">

</span><span class="c1">;; [{:one 1}]</span><span class="w">
</span></code></pre></div></div>


                    <p><a href="/en/pg-docs/02/">Read more &rarr;</a></p>
                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/en/pg-docs/01/">PG docs, part 1</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2023-08-28T00:00:00+00:00">
        Aug 28, 2023
    </time>

    <a href="/tag/clojure/" rel="tag">clojure</a>, <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/postgres/" rel="tag">postgres</a>, <a href="/tag/sql/" rel="tag">sql</a>

</div>


            <div class="entry">
                
                    <p><em>TL;DR: I’m writing a Postgres driver in pure Clojure. In general, works! Now I
proceed with the most miserable part of the project: writing documentation. I
decided to do it step by step and share it on my blog.</em></p>

<p><strong>ToC</strong></p>

<ul>
  <li><a href="/en/pg-docs/01/">About &amp; Installation</a></li>
  <li><a href="/en/pg-docs/02/">The Client</a></li>
  <li><a href="/en/pg-docs/03/">Connection Pool</a></li>
  <li><a href="/en/pg-docs/04/">Arrays</a></li>
  <li><a href="/en/pg-docs/05/">Notifications</a></li>
</ul>

<h2 id="about">About</h2>

<p><a href="https://github.com/igrishaev/pg">This project</a> is a set of libraries related to the <a href="https://www.postgresql.org/">PostgreSQL</a>
database. The primary library called <code class="language-plaintext highlighter-rouge">pg-client</code> is a driver for Postgres
written in pure Clojure. By purity I mean, neither JDBC nor any other
third-party Java libraries are involved. Everything is driven by a TCP socket
and implementation of the Posrgres Wire protocol. Fun!</p>

<p>Besides the client, the project provides such various additions as a connection
pool (see <code class="language-plaintext highlighter-rouge">pg-pool</code>). The <code class="language-plaintext highlighter-rouge">pg-types</code> library holds the encoding and decoding
logic which determines how to write and read Clojure data from and into the
database. You can use this library separately in pair with JDBC.next and <code class="language-plaintext highlighter-rouge">COPY</code>
for efficient data transcoding in binary format.</p>

<p>The question you would probably ask is, why would create a Postgres client from
scratch? JDBC has been around for decades, and there are also good
<code class="language-plaintext highlighter-rouge">clojure.java.jdbc</code> and <code class="language-plaintext highlighter-rouge">jdbc.next</code> wrappers on top of it?</p>

<p>The answer is: that although these two libraries are amazing, they don’t
disclose all Postgres features. JDBC is an abstraction whose main goal is to
satisfy all the DB engines. A general library that works with MS SQL, MySQL, and
Postgres at the same time would reduce the variety of features each backend is
capable of.</p>


                    <p><a href="/en/pg-docs/01/">Read more &rarr;</a></p>
                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/book2-anounce/">Анонс второй книги</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2023-08-01T00:00:00+00:00">
        Aug 1, 2023
    </time>

    <a href="/tag/clojure/" rel="tag">clojure</a>, <a href="/tag/book/" rel="tag">book</a>

</div>


            <div class="entry">
                
                    <p><img src="/assets/static/aws/clj-book2/IMG_2527.jpeg" /></p>

<p>Вышел второй том “Сlojure на производстве” — продолжение первой книги. Без той
помпы, что в прошлый раз, когда я каждую неделю выкладывал апдейты, фото
черновиков и прочее. На всё это не хватает времени, плюс хочется меньше пафоса.</p>

<p>В книге три главы, черновые версии которых я выкладывал в блоге. Это
<a href="/clj-zippers-1/">зипперы</a>, <a href="/clj-jdbc-1/">базы данных</a> и
<a href="/clj-repl-part-1/">REPL</a>. Всё это можно прочесть здесь на сайте, но каждую
главу я многократно улучшил. Кроме банальных опечаток, изменилась структура, а
примеры стали убедительней.</p>

<p>Книжка выполнена в том же стиле и манере повествования. Текст чередуется с
кодом, каждый тезис подтверждается примером. Длинный код разбит на части с
пояснением, что происходит. Код “подсвечен” с помощью градаций серого и
начертания. Ссылки, коих много по тексту, вынесены в QR-коды на поля.</p>

<p>Твёрдая обложка, B5, 364 страницы. Форматы для мобильных устройств появятся
позже. Издано в ДМК-Пресс тиражом в 100 экземпляров. Двадцать из них — мои,
полученные в качестве гонорара, и я готов разослать их читателям.</p>

<p>Все подробности – где купить, открывок, галерея – указаны <a href="/clojure-in-prod-2/">на странице
книги</a>.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/node-js/">Node.js</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2023-07-28T00:00:00+00:00">
        Jul 28, 2023
    </time>

    <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/javascript/" rel="tag">javascript</a>, <a href="/tag/vue/" rel="tag">vue</a>

</div>


            <div class="entry">
                
                    <p>Удивляюсь, до чего же хрупок этот Node.js. Месяц назад я делал фронт на Vue, и
настало время кое-что поправить. Обновляю пакеты, запускаю билд — сотня
ошибок. Мудрил так и сяк, пока коллега не сказал — удали node_modules и все
заработает.</p>

<p>Вот это “удали” меня поражает. Вместо того, чтобы решить корень проблемы, решают
симптомы. Подумаешь не работает! Просто начни с чистого листа. Ситуация КРИЧИТ о
системной проблеме, но никому нет дела. В платформу вливают огромные деньги, ей
пользуются миллионы, и никто не может это починить.</p>

<p>Была б моя воля, я бы посадил разработчиков Node.js за компы и сказал: чини, но
без удаления файлов. Найди источник проблемы и реши его. За удаление — пытка
током на месте. И тогда бы все починили.</p>

<p>Помню, была та же беда в проекте с React Native, только хуже. Проект перестал
собираться, и я по привычке удалил node_modules. Оказалось, в его недрах лежат
бинарники для устройства, которые генерируется на старте. При повторной
установке этот шаг пропускается, и где взять эти бинарники — неизвестно. На
StackOverflow так и пишут — перед удалением скопируй такие-то файлы в папочку,
иначе будешь плакать. Плакал я, конечно, уже после того, как это прочел.</p>

<p>Вы, наверное, подумали, что после удаления node_modules все заработало? Это было
бы слишком просто. Я получил другие непонятные ошибки, и коллега предположил,
что моя версия Node.js слишком высока. Проверили — да, у него 16, у меня 20. Но
ведь месяц назад все работало на версии 20! Мало того, что за месяц случились
такие изменения, так эти клоуны не оставили обратную совместимость! Не иначе как
цирком с клоунами эту ситуацию назвать нельзя.</p>

<p>В целом Node.js вызывает ощущение, что убираешь какашки за годовалым
ребенком. Те, у кого есть дети, знают, о чем я говорю. Когда делаешь это
постоянно, ощущения притупляются, и можно спокойно чистить говно, жуя
бутерброд. Разница в том, что к двум годам проблема с туалетом уходит, а с семи
лет ребенок уже поддерживает чистоту сам.</p>

<p>Node.js, напротив, обречен срать под себя как инвалид. Если через восемь лет за
ним нужно чистить какие-то папки, то, похоже, проблема не уйдет никогда. Бог с
ним, пусть живет как хочет. Но непонятно, зачем с этим работать, и что в голове
у людей, которые добровольно идут в разработку на Node.js.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/paysys/">Платежные системы</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2023-07-26T00:00:00+00:00">
        Jul 26, 2023
    </time>

    <a href="/tag/life/" rel="tag">life</a>, <a href="/tag/payment-systems/" rel="tag">payment-systems</a>

</div>


            <div class="entry">
                
                    <p>У платежных систем одна тонкость. Ты регистрируешься, подтверждаешь почту и
телефон, прикладываешь скан паспорта и селфи, крутишь головой перед камерой,
высылаешь все вплоть до анализов мочи — с тем, чтобы узнать: нужная функция
недоступна в твоей стране.</p>

<p>Конечно, недоступна временно. Подпишись и мы пришлем уведомление. Уже вот-вот,
буквально завтра.</p>

<p>Удалить аккаунт? Не можем: по такому-то закону данные хранятся пять лет, чтобы
выдать по требованию властей.</p>

<p>Уже сто раз такое было, но вот опять — потратил полчаса на отрытие PayPal в
другой стране, чтобы узнать, что там он ничего не умеет.</p>

<p>Регистрируясь в похожих системах, сперва нужно гуглить по словам “Service in
Country limitations”.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/cosplay/">Косплей</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2023-07-26T00:00:00+00:00">
        Jul 26, 2023
    </time>

    <a href="/tag/life/" rel="tag">life</a>, <a href="/tag/cosplay/" rel="tag">cosplay</a>

</div>


            <div class="entry">
                
                    <p>Почему-то люди не понимают: если нашел себе кумира, повторяй его поступки, а не
внешность и поведение. Потому что иначе выходит косплей — костюмированное шоу.</p>

<p>Если нравится Стив Джобс, сделай Айфон. Если Павел Дуров — сделай соцсеть с той
стеной, которую считаешь нужной. Если Лапенко — сними смешной ролик. Но не
повторяй внешность или стиль общения в интернете. Это ужасно.</p>

<p>Точто так же не стоит повторять стиль жизни. Не надо вставать в пять утра,
принимать контрастный душ, ходить босиком и медитировать. В мире полно людей,
которые медитируют и не едят мяса, но не достигли ничего.</p>

<p>Между великими людьми вообще нет связи. Все они были молодыми и старыми,
сатанистами и христианами, бабниками и девственниками. Связи нет никакой. Когда
кто-то читает десять правил знаменитости, я не понимаю — зачем? Ведь известность
из них не следует.</p>

<p>Доводилось видеть человека, который косплеил Дурова: челка, плащ до колен, все
черное, взгляд мимо камеры. Он делал стартап, и было забавно видеть его за
работой. Не знаю, чем кончилась его затея, но судя по всему — ничем.</p>

<p>Все это сказано цитатой о Стиве Джобсе. У Стива были две половины: одна —
редкостный засранец, вторая — редкостный гений. Из-за второй половины ему
прощали первую. Сегодня много людей косят под Стива, но у них получается первая
половина — засранца.</p>

<p>Начинайте со второй половины.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/as-x/">Как в X</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2023-07-26T00:00:00+00:00">
        Jul 26, 2023
    </time>

    <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/coding/" rel="tag">coding</a>

</div>


            <div class="entry">
                
                    <p>Совершенно ужасная вещь — писать на яыке X как в Y. Например, в Питоне как на
Хаскеле, а в JavaScript — как в Кложе. Придумать какие-нибудь “элегантные
объекты” и тыкать людям, что они живут неправильно.</p>

<p>Чемпионом в этой области является Питон. Из-за его гибкости на нем можно
косплеить любой язык — хоть Хаскел, хоть Кобол. Скажем, выражение ниже можно
сделать рабочим:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">items</span> <span class="o">=</span> <span class="n">List</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">...]</span>
</code></pre></div></div>

<p>Для этого пишут особый класс <code class="language-plaintext highlighter-rouge">List</code> с метаклассом, у которого реализован метод
<code class="language-plaintext highlighter-rouge">__getitem__</code>. В нем проверяется, что если второй элемент — класс <code class="language-plaintext highlighter-rouge">Ellipsis</code>, то
возвращается ленивый список от 1 до бесконечности.</p>

<p>Для Питона созданы сотни библиотек, которые косплеят другие языки — Хаскель,
Скалу и другие. Я тоже отметился: написал либу с <a href="https://github.com/igrishaev/f">лаконичным названием f</a>, где
собраны плюшки Кложи: стрелочные операторы, мультиметоды и всякие мелочи.</p>

<p>Все это замечательно, если бы не одна деталь: оно никому не сдалось. До перехода
в Кложу я работал с Питоном семь лет и ни разу не видел, чтобы использовались
функциональные поделки. Промышленные проекты на Питоне — это скучный ООП-код без
map/reduce, монад и алгебраических типов. В точности так, как это видит
создатель языка.</p>

<p>Точно так же в Кложе никто не использует монады. Уже в седьмой раз я устраиваюсь
кложуристом и не вижу их в проде (и это хорошо).</p>

<p>В текущем проекте на Кложе беда — его начинали люди, которые знали ее синтаксис,
но не идиомы. Другими словами, они знали, что вместо <code class="language-plaintext highlighter-rouge">1 + 2</code> надо писать <code class="language-plaintext highlighter-rouge">(+ 1 2)</code>,
но не знали, как устроить работу с базой, компоненты, тесты и окружение.</p>

<p>Кажется, это были рубисты. Я не держал свечку, но это сквозит в коде. Чуваки
написали свою ORM, которая матчит базу с REST — кривую и глючную. Для
конфигурации используют переменные среды, и это тоже треш и содомия. Компоненты
и система убоги. Позже в фирму пришли люди опытом на Кложе. Они либо обходят
легаси — ходят в базу напрямую, используют свои решения, — либо прибегают к нему
с легким отвращением.</p>

<p>Идиома “писать на X как в Y” — это проигрыш по определению. В любом виде. Это
билет в один конец, и он всегда одинаков. Вы пишете “как надо”, но потом
уходите, и другие с трудом приводят код в нужное русло. Не всегда удается
сделать это полностью — иной раз авгиевы конюшни столь полны, что переделывать
слишком дорого, и с этим как-то живут.</p>

<p>Легковестные агенты из Эрланга в Кложе. Элегантные объекты в Джаве. Монады
вместо исключений в Питоне. Да, интересно, да, ярко. Но бесполезно.</p>

<p>Если идеи по-настоящему сильны, их нужно выразить в новом языке. Не устраивает
чистый C — появляется C++. Не устраивают древние диалекты Лиспа — появляется
Кложа. Не нравится бородатый Эрланг — пишут Эликсир.</p>

<p>На любом языке надо писать так, как в нем принято. На Руби — как в Руби, а не в
Кложе. На Кложе — как принято в Кложе, а не в Руби.</p>

<p>Чем раньше это поймешь, тем скорее на тебя снизойдет благодать.</p>

                
            </div>

        </li>
        
    </ul>

    <h4>
        
        <a href="/" class="previous">&larr;</a>
        
        <span class="page_number ">Страница 2 из 66</span>
        
        <a href="/page3" class="next">&rarr;</a>
        
    </h4>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Ivan Grishaev's blog</li>
          <li><a href="mailto:ivan@grishaev.me">ivan@grishaev.me</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
            <li><a href="https://github.com/igrishaev">GitHub</a></li>
            <li><a href="tg://resolve?domain=igrishaev_blog">Telegram</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Writing on programming, education, books and negotiations.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
