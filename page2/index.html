<!DOCTYPE html>
<html lang="ru">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Ivan Grishaev's blog</title>
  <meta name="description" content="Writing on programming, education, books and negotiations.
">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/custom.css">
  <link rel="canonical" href="https://grishaev.me/page2/">
  <link rel="alternate" type="application/rss+xml" title="Ivan Grishaev's blog" href="https://grishaev.me/feed.xml">

  <link rel="shortcut icon" type="image/x-icon" href="/assets/static/favicons/favicon.ico">

  <script type="text/javascript" src="/assets/typo.js"></script>

</head>


  <body>
    <header class="site-header">

    <div class="wrapper flex-container">

        <div>
            <a href="/">
                <img id="avatar" src="/assets/static/avatar.jpg" alt="Ivan Grishaev">
            </a>
        </div>

        <div class="flex-container-vert" style="margin-left: 15px; width: 80%">

            <div class="flex-container full-width">
                <p style="margin-bottom: 5px">Ivan Grishaev's blog</p>
                <div class="flex-huge"></div>
                <div >
<form id="search-form"
      target="_blank"
      style="display: inline"
      method="get"
      action="https://www.google.com/search">

    <input name="sitesearch"
           value="grishaev.me"
           type="hidden">

    <input type="text"
           required="required"
           name="q"
           placeholder="Google search..."
           autocomplete="off">

    <button style="border: none; background-color: transparent; cursor: pointer;"
            type="submit">&#x1f50d;</button>

</form>
</div>
            </div>

            <p><small>Writing on programming, education, books and negotiations.
</small></p>

            <div class="flex-container">
                <a class="menu-item" href="/">Home</a>
                <a class="menu-item" href="/about/">About</a>
                <a class="menu-item" href="/bookshelf/">Bookshelf</a>
                <a class="menu-item" href="/feed.xml">RSS</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor" href="/tag/clojure/">Clojure</a>
                <a class="menu-item minor" href="/tag/emacs/">Emacs</a>
                <a class="menu-item minor" href="/tag/python/">Python</a>
                <a class="menu-item minor" href="/tag/programming/">Programming</a>
                <a class="menu-item minor" href="/interview/">Interview</a>
                <a class="menu-item minor" href="/video/">Video</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor hl" href="/clojure-in-prod/">Книга «Clojure на производстве»</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor hl" href="/clojure-in-prod-2/">Книга «Clojure на производстве», второй том</a>
            </div>

        </div>
    </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="home">

    <ul class="post-list">
        
        <li>

            <h2>
                <a class="post-link" href="/solid/">SOLID</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2024-07-19T00:00:00+00:00">
        Jul 19, 2024
    </time>

    <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/solid/" rel="tag">solid</a>

</div>


            <div class="entry">
                
                    
<p>На мой взгляд, у SOLID есть важное и полезное применение — унижать людей на
собесах. Очень помогает в найме, когда на должность претендует сто человек, а
нам не нужны неудачники. Уверен, в Амазон брали только тех, кто этот SOLID
знает. <a href="/patterns/">Результат налицо</a>.</p>

<p>О других преимуществах SOLID мне неизвестно.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/patterns/">Паттерны</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2024-07-19T00:00:00+00:00">
        Jul 19, 2024
    </time>

    <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/patterns/" rel="tag">patterns</a>, <a href="/tag/java/" rel="tag">java</a>

</div>


            <div class="entry">
                
                    <p>Одна из худших вещей в айти – это паттерны. Когда я слышу “паттерн”, меня
трясет. Хочется, чтобы паттернов было как можно меньше, а может быть, однажды мы
доживем до счастливого дня, когда в программировании не будет паттернов.</p>

<p>Откуда такой радикализм? Дело в том, что паттерн – это костыль. Помните картинку
с жуком, где слева баг, а справа фича? То же самое с паттерном. Это прокол
языка, который решили подпереть костылем.</p>

<p>Builder, Visitor, Singleton – все это ошибки в дизайне языка. Чемпионами по их
количеству являются C++ и Java. Вряд ли кто-то в здравом уме назовет их хорошо
спроектированными языками.</p>

<p>Builder – прямое следствие того, что нет параметров по умолчанию. Visitor – цена
за убогую систему типов и ООП в целом. Singleton вообще рак мозга – кто-то
решил, что объект нельзя создать дважды, хотя внятного объяснения этому нет.</p>

<p>Если взять любую книгу по Джаве, половина ее будет о том, как делать не надо и
какой паттерн брать взамен. Не лучше ли убрать из языка то, чего делать не надо?
Я понимаю, легаси и все такое, но все же.</p>

<p>Книги Банды Четырех и талмуды толщиной с руку, где учат паттернам, наводят
гнетущее впечатление. Столько труда потрачено на костыли, чтобы обойти ошибки
языка!</p>

<p>Паттерн – это о том, как сделать удобней компилятору или IDE. Ни слова о том,
чтобы сделать удобно потребителю кода.</p>

<p>Беда паттернов в том, что они плохо влияют на программиста. Он буквально тупеет,
не понимая, что по-прежнему пишет плохой код, просто теперь можно сослаться на
книги или громкие имена. Мышление паттернами – это натуральная деградация. Есть
надежда, если Джава-программист поддерживает форму, ковыряясь с Лиспом или
Хаскелем. Но если он видит только паттерны с десяти до шести, это путь к
деградации и больше никуда.</p>

<p>Пример из реальной жизни – Amazon AWS SDK для Джавы. Казалось бы: самое
популярное облако, самый популярный язык, самые сильные программисты. Почему же
они пишут абсолютное говно, которым нельзя пользоваться? Потому что в голове
паттерны, а не задача сделать удобно.</p>

<p>Если вы не знаете, все пакеты SDK V1 следуют паттерну POJO. Это когда каждый
класс SDK имеет нулевой конструктор и пачку геттеров и сеттеров. Например,
какой-нибудь GetObjectRequest создается так:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">GetObjectRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">GetObjectRequest</span><span class="o">();</span>
<span class="n">request</span><span class="o">.</span><span class="na">setBucket</span><span class="o">(</span><span class="s">"some_bucket"</span><span class="o">)</span>
<span class="n">request</span><span class="o">.</span><span class="na">setKey</span><span class="o">(</span><span class="s">"path/to/file.txt"</span><span class="o">)</span>
<span class="n">request</span><span class="o">.</span><span class="na">setIfModifiedSince</span><span class="o">(...)</span>
</code></pre></div></div>

<p>И таких классов тысячи – в буквальном смысле. Нигде не сказано, какой из
сеттеров является обязательным. Можно запросто убрать вызов <code class="language-plaintext highlighter-rouge">setBucket</code>, и
запрос будет без бакета. При запуске кода вы получите исключение в рантайме.</p>

<p>Паттерн есть? Есть. Удобно? Нет. Вы же не будете гонять код вручную на S3 каждый
раз, когда меняете какой-то сеттер. Поэтому все сводится к тому, чтобы поправить
код, прогнать CI и задеплоить на тестовое окружение, чтобы дернуть там и
убедиться, что работает. Займет час. Умные ребята поднимают для этого Докер с
локальным min.io, но так бывает не везде.</p>

<p>Написав тысячи битых классов, инженеры Амазона почесали голову и сели за AWS SDK
V2.0. На этот раз с другим паттерном – Builder. Теперь каждый класс создается
цепочкой:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">GetObjectRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="nc">GetObjectRequest</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
  <span class="o">.</span><span class="na">bucket</span><span class="o">(</span><span class="s">"some_bucket"</span><span class="o">)</span>
  <span class="o">.</span><span class="na">key</span><span class="o">(</span><span class="s">"path/to/file.txt"</span><span class="o">)</span>
  <span class="o">.</span><span class="na">ifModifiedSince</span><span class="o">(...)</span>
  <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</code></pre></div></div>

<p>Казалось бы, удобно, современно, все как у Джошуа Блоха. Однако я по-прежнему не
вижу, какие параметры обязательны. Легко пропустить метод .bucket и получить
объект, который не знает, в какой бакет обращаться.</p>

<p>А вот реальный пример с тегом. Тег – это объект, который хранит пару
ключ-значение. Других полей у него нет. Казалось бы, сделай конструктор с двумя
полями, чтобы было так:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Tag</span> <span class="n">tag</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Tag</span><span class="o">(</span><span class="s">"release"</span><span class="o">,</span> <span class="s">"test-123.4"</span><span class="o">);</span>
</code></pre></div></div>

<p>Но нельзя, у нас же паттерн! Нужен билдер и методы для каждого поля. В
результате имеем:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Tag</span> <span class="n">tag</span> <span class="o">=</span> <span class="nc">Tag</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">value</span><span class="o">(</span><span class="s">"42"</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>

<span class="err">#</span><span class="n">object</span><span class="o">[....</span><span class="na">s3</span><span class="o">.</span><span class="na">model</span><span class="o">.</span><span class="na">Tag</span> <span class="o">...</span> <span class="s">"Tag(Value=42)"</span><span class="o">]</span>
</code></pre></div></div>

<p>Смотрю и не понимаю – как так? Почему позволено иметь тег, в котором нет имени
поля?! Оно же Null и в будущем свалится с ошибкой. Как вообще можно создать тег
без имени и значения? Кто был тот тупица, который все это дизайнил? Кто нанял
клоунов в Амазон за 250 тысяч в год, чтобы они писали подобный код?</p>

<p>Они наколбасили сто новых пакетов и классов с новым паттерном. Но как было
невозможно пользоваться, так и осталось. Как так получилось?</p>

<p>Понятно, это вопросы в никуда. Программисты пишут SDK по паттерну – как сказал
знакомый джавист, “ходят строем”. Главное, чтобы строй шел ровно, а куда он
придет – и надо ли было идти – мало кто задается вопросом.</p>

<p>Пожелаю читателю использовать паттерны как можно меньше. Если вы слышите
“паттерн” – это тревожный знак.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/en/clojure-with-retry/">Clojure AntiPatterns: the with-retry macro </a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2024-07-18T00:00:00+00:00">
        Jul 18, 2024
    </time>

    <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/clojure/" rel="tag">clojure</a>, <a href="/tag/retry/" rel="tag">retry</a>, <a href="/tag/s3/" rel="tag">s3</a>

</div>


            <div class="entry">
                
                    <p>Most of clojurians write good things about Clojure only. I decided to start
sharing techniques and patterns that I consider bad practices. We still have
plenty of them in Clojure projects, unfortunately.</p>

<p>My first candidate is widely used, casual macro called <code class="language-plaintext highlighter-rouge">with-retry</code>:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">defmacro</span><span class="w"> </span><span class="n">with-retry</span><span class="w"> </span><span class="p">[[</span><span class="n">attempts</span><span class="w"> </span><span class="n">timeout</span><span class="p">]</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">body</span><span class="p">]</span><span class="w">
  </span><span class="o">`</span><span class="p">(</span><span class="nb">loop</span><span class="w"> </span><span class="p">[</span><span class="n">n</span><span class="o">#</span><span class="w"> </span><span class="o">~</span><span class="n">attempts</span><span class="p">]</span><span class="w">
     </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[[</span><span class="n">e</span><span class="o">#</span><span class="w"> </span><span class="n">result</span><span class="o">#</span><span class="p">]</span><span class="w">
           </span><span class="p">(</span><span class="nf">try</span><span class="w">
             </span><span class="p">[</span><span class="n">nil</span><span class="w"> </span><span class="p">(</span><span class="nf">do</span><span class="w"> </span><span class="o">~@</span><span class="n">body</span><span class="p">)]</span><span class="w">
             </span><span class="p">(</span><span class="nf">catch</span><span class="w"> </span><span class="n">Throwable</span><span class="w"> </span><span class="n">e</span><span class="o">#</span><span class="w">
               </span><span class="p">[</span><span class="n">e</span><span class="o">#</span><span class="w"> </span><span class="n">nil</span><span class="p">]))]</span><span class="w">
       </span><span class="p">(</span><span class="k">cond</span><span class="w">

         </span><span class="p">(</span><span class="nb">nil?</span><span class="w"> </span><span class="n">e</span><span class="o">#</span><span class="p">)</span><span class="w">
         </span><span class="n">result</span><span class="o">#</span><span class="w">

         </span><span class="p">(</span><span class="nb">&gt;</span><span class="w"> </span><span class="n">n</span><span class="o">#</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w">
         </span><span class="p">(</span><span class="nf">do</span><span class="w">
           </span><span class="p">(</span><span class="nf">Thread/sleep</span><span class="w"> </span><span class="o">~</span><span class="n">timeout</span><span class="p">)</span><span class="w">
           </span><span class="p">(</span><span class="nf">recur</span><span class="w"> </span><span class="p">(</span><span class="nb">dec</span><span class="w"> </span><span class="n">n</span><span class="o">#</span><span class="p">)))</span><span class="w">

         </span><span class="no">:else</span><span class="w">
         </span><span class="p">(</span><span class="nf">throw</span><span class="w"> </span><span class="p">(</span><span class="nb">new</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="s">"all attempts exhausted"</span><span class="w"> </span><span class="n">e</span><span class="o">#</span><span class="p">))))))</span><span class="w">
</span></code></pre></div></div>

<p>This is a very basic implementation. It catches all possible exceptions, has a
strict number of attempts, and the constant delay time. Typical usage:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">with-retry</span><span class="w"> </span><span class="p">[</span><span class="mi">3</span><span class="w"> </span><span class="mi">2000</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nf">get-file-from-network</span><span class="w"> </span><span class="s">"/path/to/file.txt"</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<p>Should network blink, most likely you’ll get a file anyway.</p>

<p>Clojure people who don’t like macros write a function like this:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">with-retry</span><span class="w"> </span><span class="p">[[</span><span class="n">attempts</span><span class="w"> </span><span class="n">timeout</span><span class="p">]</span><span class="w"> </span><span class="n">func</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nb">loop</span><span class="w"> </span><span class="p">[</span><span class="n">n</span><span class="w"> </span><span class="n">attempts</span><span class="p">]</span><span class="w">
    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[[</span><span class="n">e</span><span class="w"> </span><span class="n">result</span><span class="p">]</span><span class="w">
          </span><span class="p">(</span><span class="nf">try</span><span class="w">
            </span><span class="p">[</span><span class="n">nil</span><span class="w"> </span><span class="p">(</span><span class="nf">func</span><span class="p">)]</span><span class="w">
            </span><span class="p">(</span><span class="nf">catch</span><span class="w"> </span><span class="n">Throwable</span><span class="w"> </span><span class="n">e</span><span class="w">
              </span><span class="p">[</span><span class="n">e</span><span class="w"> </span><span class="n">nil</span><span class="p">]))]</span><span class="w">
      </span><span class="p">(</span><span class="k">cond</span><span class="w">

        </span><span class="p">(</span><span class="nb">nil?</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w">
        </span><span class="n">result</span><span class="w">

        </span><span class="p">(</span><span class="nb">&gt;</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w">
        </span><span class="p">(</span><span class="nf">do</span><span class="w">
          </span><span class="p">(</span><span class="nf">Thread/sleep</span><span class="w"> </span><span class="n">timeout</span><span class="p">)</span><span class="w">
          </span><span class="p">(</span><span class="nf">recur</span><span class="w"> </span><span class="p">(</span><span class="nb">dec</span><span class="w"> </span><span class="n">n</span><span class="p">)))</span><span class="w">

        </span><span class="no">:else</span><span class="w">
        </span><span class="p">(</span><span class="nf">throw</span><span class="w"> </span><span class="p">(</span><span class="nb">new</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="s">"all attempts exhausted"</span><span class="w"> </span><span class="n">e</span><span class="p">))))))</span><span class="w">
</span></code></pre></div></div>

<p>It acts the same but accepts not arbitrary code but a function. A form can be
easily turned into a function by putting a sharp sign in front of it. After all,
it looks almost the same:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">with-retry</span><span class="w"> </span><span class="p">[</span><span class="mi">3</span><span class="w"> </span><span class="mi">2000</span><span class="p">]</span><span class="w">
  </span><span class="o">#</span><span class="p">(</span><span class="nf">get-file-from-network</span><span class="w"> </span><span class="s">"/path/to/file.txt"</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<p>Although it is considered being a good practice, here is the outcome of using it
in production.</p>

<p>Practice proves that, even if you wrap something into that macro, you cannot
recover from a failure anyway. Imagine you’re downloading a file from S3 and
pass wrong credentials. You cannot recover no matter how many times you
retry. Wrong creds remain wrong forever. Now there is a missing file: again, no
matter how hard you retry, it’s all in vain and you only waste resources. Should
you put a file into S3, and submit wrong headers, it’s the same. If your network
is misconfigured or some resources are blocked, or you have no permissions, it’s
the same again: <strong>no matter how long have you been trying, it’s useless</strong>.</p>

<p>There might be dozens of reasons when your request fails, and there is no way to
recover. Instead of invoking a resource again and again, you must investigate
what went wrong.</p>

<p>There might be some rare cases which are worth retrying though. One of them is
an <code class="language-plaintext highlighter-rouge">IOException</code> caused by a network blink. But in fact, modern HTTP clients
already handle it for you. If you <code class="language-plaintext highlighter-rouge">GET</code> a resource and receive an <code class="language-plaintext highlighter-rouge">IOException</code>,
most likely your client has already done three attempts silently with growing
timeouts. By wrapping the call <code class="language-plaintext highlighter-rouge">with-retry</code>, you perform 9 attempts or so under
the hood.</p>

<p>Another case might be 429 error code which stands for rate limitation on the
server side. Personally I don’t think that a slight delay may help. Most likely
you need to bump the limits, rotate API keys and so on but not <code class="language-plaintext highlighter-rouge">Thread.sleep</code> in
the middle of code.</p>

<p>I’ve seen terrible usage of <code class="language-plaintext highlighter-rouge">with-retry</code> macro across various projects. One
developer specified 10 attempts with 10 seconds timeout to reach a remote API
for sure. But he was calling the wrong API handler in fact.</p>

<p>Another developer put two nested <code class="language-plaintext highlighter-rouge">with-macro</code> forms. They belonged to different
functions and thus could not be visible at once. I’m reproducing a simplified
version:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">with-retry</span><span class="w"> </span><span class="p">[</span><span class="mi">4</span><span class="w"> </span><span class="mi">1000</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nf">do-this</span><span class="w"> </span><span class="n">...</span><span class="p">)</span><span class="w">
  </span><span class="p">(</span><span class="nf">do-that</span><span class="w"> </span><span class="n">...</span><span class="p">)</span><span class="w">
  </span><span class="p">(</span><span class="nf">with-retry</span><span class="w"> </span><span class="p">[</span><span class="mi">3</span><span class="w"> </span><span class="mi">2000</span><span class="p">]</span><span class="w">
    </span><span class="p">(</span><span class="nf">do-something-else...</span><span class="p">)))</span><span class="w">
</span></code></pre></div></div>

<p>According to math, 4 times 3 is 12. When the <code class="language-plaintext highlighter-rouge">(do-something-else)</code> function
failed, the whole top-level block started again. It led to 12 executions in
total with terrible side effects and logs which I could not investigate.</p>

<p>One more case: a developer wrapped a chunk of logic that inserted something into
the database. He messed up with foreign keys so the records could not be
stored. Postgres replied with an error “foreign key constraint violation” yet
the macro tried to store them three times before failing completely. Three
broken SQL invocations… for what? Why?</p>

<p>So. Whenever you use <code class="language-plaintext highlighter-rouge">with-retry</code>, most likely it’s a bad sign. Most often you
cannot recover from a failure no matter if you add two numbers, upload a file,
or write into a database. You should only retry in certain situations like
<code class="language-plaintext highlighter-rouge">IOException</code> or rate limiting. But even those cases are questionable and might
be mitigated with no retrying.</p>

<p>Next time you’re going to cover a block of logic <code class="language-plaintext highlighter-rouge">with-retry</code>, think hard if you
really need to retry. Will it really help in case of wrong creds, a missing
file, incorrect signature or similar things? Perhaps not. Thus, don’t retry in
vain. Just fail and write detailed logs. Then find the real problem, fix it and
let it never happen again.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/warming/">Глобальное потепление</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2024-07-06T00:00:00+00:00">
        Jul 6, 2024
    </time>

    <a href="/tag/warming/" rel="tag">warming</a>, <a href="/tag/life/" rel="tag">life</a>, <a href="/tag/english/" rel="tag">english</a>

</div>


            <div class="entry">
                
                    <p>Уже год я преподаю английский: одному человеку и бесплатно. Первые полгода
занимались по моей программе, которую я составил по книге Мерфи. Затем перешли
на учебник Language Leader, по которому я учился когда-то сам.</p>

<p>Он хорошо составлен: он интересен взрослому, потому что авторы добавили много
фактов из реальной жизни. Из него буквально фонит то, что было в мире на момент
его составления. В том числе поэтому проходить некоторые темы забавно.</p>

<p>Одна из таких тем — погода. Лет 10-15 назад весь мир стоял на ушах из-за так
называемого “глобального потепления”. Ему приписывались любые природные явления:
шторм, торнадо — потепление, озоновая дыра — потепление, ядовитые испарения в
тундре — потепление.</p>

<p>Забавно, как в учебнике повторяется то же самое. Упражнения самых разных
форматов — текст, диалоги, грамматика, — и везде потепление, потепление,
потепление. Других причин не бывает. А если и есть причина, то какая у нее
первопричина? Угадайте.</p>

<p>Поэтому я воспринимаю учебник как исторический документ. Читая его, видно, как
штырило людей на эту тему в прошлом. Гринпис и прочие радикальные группировки
штурмовали платформы Шелл, а их отгоняли водометами. Население “прикладывало
линейку” — если сегодня потеплело на градус, а завтра на два, то через месяц
потеплеет на тридцать.</p>

<p>Сегодня, когда глобальное потепление уже выдохлось, повестка изменилась. Теперь
у нас “борьба с изменением климата”. Это более гибкая конструкция, потому что
нигде не говориться, как долго нужно бороться. Горизонт работ заложен уже в
постановке задачи.</p>

<p>Грета куда-то пропала, а у меня смешной стикер-пак с ней. Пропадает без дела.</p>

<p>Хороших выходных!</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/en/pg-version-1.15/">PG2 release 0.1.15</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2024-07-06T00:00:00+00:00">
        Jul 6, 2024
    </time>

    <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/sql/" rel="tag">sql</a>, <a href="/tag/clojure/" rel="tag">clojure</a>, <a href="/tag/postgres/" rel="tag">postgres</a>

</div>


            <div class="entry">
                
                    
<p><a href="https://github.com/igrishaev/pg2">PG2 version 0.1.15</a> is out. This version mostly ships improvements to
connection pool and folders (reducers) of a database result. There are two new
sections in the documentation that describe each part. I reproduce them below.</p>

<h2 id="connection-pool">Connection Pool</h2>

<p>Problem: every time you connect to the database, it takes time to open a socket,
pass authentication pipeline and receive initial data from the server. From the
server’s prospective, a new connection spawns a new process which is also an
expensive operation. If you open a connection per a query, your application is
about ten times slower than it could be.</p>

<p>Connection pools solve that problem. A pool holds a set of connections opened in
advance, and you <em>borrow</em> them from a pool. When borrowed, a connection cannot
be shared with somebody else any longer. Once you’ve done with your work, you
return the connection to the pool, and it’s available for other consumers.</p>

<p>PG2 ships a simple and robust connection pool out from the box. This section
covers how to use it.</p>

<h3 id="a-simple-example">A Simple Example</h3>

<p>Import both core and pool namespaces as follows:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">ns</span><span class="w"> </span><span class="n">demo</span><span class="w">
  </span><span class="p">(</span><span class="no">:require</span><span class="w">
    </span><span class="p">[</span><span class="n">pg.core</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">pg</span><span class="p">]</span><span class="w">
    </span><span class="p">[</span><span class="n">pg.pool</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">pool</span><span class="p">]))</span><span class="w">
</span></code></pre></div></div>

<p>Here is how you use the pool:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">config</span><span class="w">
  </span><span class="p">{</span><span class="no">:host</span><span class="w"> </span><span class="s">"127.0.0.1"</span><span class="w">
   </span><span class="no">:port</span><span class="w"> </span><span class="mi">5432</span><span class="w">
   </span><span class="no">:user</span><span class="w"> </span><span class="s">"test"</span><span class="w">
   </span><span class="no">:password</span><span class="w"> </span><span class="s">"test"</span><span class="w">
   </span><span class="no">:database</span><span class="w"> </span><span class="s">"test"</span><span class="p">})</span><span class="w">

</span><span class="p">(</span><span class="nf">pool/with-pool</span><span class="w"> </span><span class="p">[</span><span class="n">pool</span><span class="w"> </span><span class="n">config</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nf">pool/with-connection</span><span class="w"> </span><span class="p">[</span><span class="n">conn</span><span class="w"> </span><span class="n">pool</span><span class="p">]</span><span class="w">
    </span><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="s">"select 1 as one"</span><span class="p">)))</span><span class="w">
</span></code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">pool/with-pool</code> macro creates a pool object from the <code class="language-plaintext highlighter-rouge">config</code> map and binds
it to the <code class="language-plaintext highlighter-rouge">pool</code> symbol. Once you exit the macro, the pool gets closed.</p>

<p>The <code class="language-plaintext highlighter-rouge">with-pool</code> macro can be easily replaced with the <code class="language-plaintext highlighter-rouge">with-open</code> macro and the
<code class="language-plaintext highlighter-rouge">pool</code> function that creates a pool instance. By exit, the macro calls the
<code class="language-plaintext highlighter-rouge">.close</code> method of an opened object, which closes the pool.</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nb">with-open</span><span class="w"> </span><span class="p">[</span><span class="n">pool</span><span class="w"> </span><span class="p">(</span><span class="nf">pool/pool</span><span class="w"> </span><span class="n">config</span><span class="p">)]</span><span class="w">
  </span><span class="p">(</span><span class="nf">pool/with-conn</span><span class="w"> </span><span class="p">[</span><span class="n">conn</span><span class="w"> </span><span class="n">pool</span><span class="p">]</span><span class="w">
    </span><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="s">"select 1 as one"</span><span class="p">)))</span><span class="w">
</span></code></pre></div></div>

<p>Having a pool object, use it with the <code class="language-plaintext highlighter-rouge">pool/with-connection</code> macro (there is a
shorter version <code class="language-plaintext highlighter-rouge">pool/with-conn</code> as well). This macro borrows a connection from
the pool and binds it to the <code class="language-plaintext highlighter-rouge">conn</code> symbol. Now you pass the connection to
<code class="language-plaintext highlighter-rouge">pg/execute</code>, <code class="language-plaintext highlighter-rouge">pg/query</code> and so on. By exiting the <code class="language-plaintext highlighter-rouge">with-connection</code> macro, the
connection is returned to the pool.</p>

<p>And this is briefly everything you need to know about the pool! Sections below
describe more about its inner state and behavior.</p>

<h3 id="configuration">Configuration</h3>

<p>The pool object accepts the same config the <code class="language-plaintext highlighter-rouge">Connection</code> object does section for
the table of parameters). In addition to these, the fillowing options are
accepted:</p>

<table>
  <thead>
    <tr>
      <th>Field</th>
      <th>Type</th>
      <th>Default</th>
      <th>Comment</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:pool-min-size</code></td>
      <td>integer</td>
      <td>2</td>
      <td>Minimum number of open connections when initialized.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:pool-max-size</code></td>
      <td>integer</td>
      <td>8</td>
      <td>Maximum number of open connections. Cannot be exceeded.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:pool-expire-threshold-ms</code></td>
      <td>integer</td>
      <td>300.000 (5 mins)</td>
      <td>How soon a connection is treated as expired and will be forcibly closed.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:pool-borrow-conn-timeout-ms</code></td>
      <td>integer</td>
      <td>15.000 (15 secs)</td>
      <td>How long to wait when borrowing a connection while all the connections are busy. By timeout, an exception is thrown.</td>
    </tr>
  </tbody>
</table>

<p>The first option <code class="language-plaintext highlighter-rouge">:pool-min-size</code> specifies how many connection are opened at
the beginning. Setting too many is not necessary because you never know if you
application will really use all of them. It’s better to start with a small
number and let the pool to grow in time, if needed.</p>

<p>The next option <code class="language-plaintext highlighter-rouge">:pool-max-size</code> determines the total number of open
connections. When set, it cannot be overridden. If all the connections are busy
and there is still a gap, the pool spawns a new connection and adds it to the
internal queue. But if the <code class="language-plaintext highlighter-rouge">:pool-max-size</code> value is reached, an exception is
thrown.</p>

<p>The option <code class="language-plaintext highlighter-rouge">:pool-expire-threshold-ms</code> specifies the number of
milliseconds. When a certain amount of time has passed since the connection’s
initialization, it is considered expired and will be closed by the pool. This is
used to rotate connections and prevent them from living for too long.</p>

<p>The option <code class="language-plaintext highlighter-rouge">:pool-borrow-conn-timeout-ms</code> prescribes how long to wait when
borrowing a connection from an exhausted pool: a pool where all the connections
are busy and the <code class="language-plaintext highlighter-rouge">:pool-max-size</code> value is reached. At this case, the only hope
that other clients complete their work and return theri connection before
timeout bangs. Should there still haven’t been any free connections during the
<code class="language-plaintext highlighter-rouge">:pool-borrow-conn-timeout-ms</code> time window, an exception pops up.</p>

<h3 id="pool-methods">Pool Methods</h3>

<p>The <code class="language-plaintext highlighter-rouge">stats</code> function returns info about free and used connections:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pool/with-pool</span><span class="w"> </span><span class="p">[</span><span class="n">pool</span><span class="w"> </span><span class="n">config</span><span class="p">]</span><span class="w">

  </span><span class="p">(</span><span class="nf">pool/stats</span><span class="w"> </span><span class="n">pool</span><span class="p">)</span><span class="w">
  </span><span class="c1">;; {:free 1 :used 0}</span><span class="w">

  </span><span class="p">(</span><span class="nf">pool/with-connection</span><span class="w"> </span><span class="p">[</span><span class="n">conn</span><span class="w"> </span><span class="n">pool</span><span class="p">]</span><span class="w">
    </span><span class="p">(</span><span class="nf">pool/stats</span><span class="w"> </span><span class="n">pool</span><span class="p">)</span><span class="w">
    </span><span class="c1">;; {:free 0 :used 1}</span><span class="w">
  </span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<p>It might be used to send metrics to Grafana, CloudWatch, etc.</p>

<h3 id="manual-pool-management">Manual Pool Management</h3>

<p>The following functions help you manage a connection pool manually, for example
when it’s wrapped into a component (see <a href="https://github.com/stuartsierra/component">Component</a> and
<a href="https://github.com/weavejester/integrant">Integrant</a> libraries).</p>

<p>The <code class="language-plaintext highlighter-rouge">pool</code> function creates a pool:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">POOL</span><span class="w"> </span><span class="p">(</span><span class="nf">pool/pool</span><span class="w"> </span><span class="n">config</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">used-count</code> and <code class="language-plaintext highlighter-rouge">free-count</code> functions return total numbers of busy and
free connections, respectively:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pool/free-count</span><span class="w"> </span><span class="n">POOL</span><span class="p">)</span><span class="w">
</span><span class="c1">;; 2</span><span class="w">

</span><span class="p">(</span><span class="nf">pool/used-count</span><span class="w"> </span><span class="n">POOL</span><span class="p">)</span><span class="w">
</span><span class="c1">;; 0</span><span class="w">
</span></code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">pool?</code> predicate ensures it’s a <code class="language-plaintext highlighter-rouge">Pool</code> instance indeed:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pool/pool?</span><span class="w"> </span><span class="n">POOL</span><span class="p">)</span><span class="w">
</span><span class="c1">;; true</span><span class="w">
</span></code></pre></div></div>

<h3 id="closing">Closing</h3>

<p>The <code class="language-plaintext highlighter-rouge">close</code> method shuts down a pool instance. On shutdown, first, all the free
connections get closed. Then the pool closes busy connections that were
borrowed. This might lead to failures in other threads, so it’s worth waiting
until the pool has zero busy connections.</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pool/close</span><span class="w"> </span><span class="n">POOL</span><span class="p">)</span><span class="w">
</span><span class="c1">;; nil</span><span class="w">
</span></code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">closed?</code> predicate ensures the pool has already been closed:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pool/closed?</span><span class="w"> </span><span class="n">POOL</span><span class="p">)</span><span class="w">
</span><span class="c1">;; true</span><span class="w">
</span></code></pre></div></div>

<h3 id="borrow-logic-in-detail">Borrow Logic in Detail</h3>

<p>When getting a connection from a pool, the following conditions are taken into
account:</p>

<ul>
  <li>if the pool is closed, an exception is thrown;</li>
  <li>if there are free connections available, the pool takes one of them;</li>
  <li>if a connection is expired (was created long ago), it’s closed and the pool
performs another attempt;</li>
  <li>if there aren’t free connections, but the max number of used connection has not
been reached yet, the pool spawns a new connection;</li>
  <li>if the number of used connections is reached, the pool waits for
<code class="language-plaintext highlighter-rouge">:pool-borrow-conn-timeout-ms</code> amount of milliseconds hoping that someone
releases a connection in the background;</li>
  <li>by timeout (when nobody did), the pool throws an exception.</li>
</ul>

<h3 id="returning-logic-in-detail">Returning Logic in Detail</h3>

<p>When you return a connection to a pool, the following cases might come into
play:</p>

<ul>
  <li>if the connection is an error state, then transaction is rolled back, and the
connection is closed;</li>
  <li>if the connection is in transaction mode, it is rolled back, and the
connection is marked as free again;</li>
  <li>if it was already closed, the pool just removes it from used connections. It
won’t be added into the free queue;</li>
  <li>if the pool is closed, the connection is removed from used connections;</li>
  <li>when none of above conditions is met, the connection is removed from used and
becomes available for other consumers again.</li>
</ul>

<hr />

<p>This was the Connecton Pool section, and now we proceed with Folders.</p>

<h2 id="folders-reducers">Folders (Reducers)</h2>

<p>Folders (which are also known as reducers) are objects that transform rows from
network into something else. A typical folder consists from an initial value
(which might be mutable) and logic that adds the next row to that value. Before
returning the value, a folder might post-process it somehow, for example turn it
into an immutable value.</p>

<p>The default folder (which you don’t need to specify) acts exactly like this: it
spawns a new <code class="language-plaintext highlighter-rouge">transient</code> vector and <code class="language-plaintext highlighter-rouge">conj!</code>es all the incoming rows into
it. Finally, it returns a <code class="language-plaintext highlighter-rouge">persistent!</code> version of this vector.</p>

<p>PG2 provides a great variety of folders: to build maps or sets, to index or
group rows by a certain function. With folders, it’s possible to dump a database
result into a JSON or EDN file.</p>

<p>It’s quite important that folders process rows on the fly. Like transducers,
they don’t keep the whole dataset in memory. They only track the accumulator and
the current row no matter how many of them have arrived from the database: one
thousand or one million.</p>

<h3 id="a-simple-folder">A Simple Folder</h3>

<p>Technically a folder is a function (an instance of <code class="language-plaintext highlighter-rouge">clojure.lang.IFn</code>) with
three bodies of arity 0, 1, and 2, as follows:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">a-folder</span><span class="w">
  </span><span class="p">([]</span><span class="w">
   </span><span class="n">...</span><span class="p">)</span><span class="w">
  </span><span class="p">([</span><span class="n">acc</span><span class="p">]</span><span class="w">
   </span><span class="n">...</span><span class="p">)</span><span class="w">
  </span><span class="p">([</span><span class="n">acc</span><span class="w"> </span><span class="n">row</span><span class="p">]</span><span class="w">
   </span><span class="n">...</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<ul>
  <li>
    <p>The first 0-arity form produces an accumulator that might be mutable.</p>
  </li>
  <li>
    <p>The third 2-arity form takes the accumulator and the current row and returns
an updated version of the accumulator.</p>
  </li>
  <li>
    <p>The second 1-arity form accepts the last version of the accumulator and
transforms it somehow, for example seals a transient collection into its
persistent view.</p>
  </li>
</ul>

<p>Here is the <code class="language-plaintext highlighter-rouge">default</code> folder:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">default</span><span class="w">
  </span><span class="p">([]</span><span class="w">
   </span><span class="p">(</span><span class="nf">transient</span><span class="w"> </span><span class="p">[]))</span><span class="w">
  </span><span class="p">([</span><span class="n">acc!</span><span class="p">]</span><span class="w">
   </span><span class="p">(</span><span class="nf">persistent!</span><span class="w"> </span><span class="n">acc!</span><span class="p">))</span><span class="w">
  </span><span class="p">([</span><span class="n">acc!</span><span class="w"> </span><span class="n">row</span><span class="p">]</span><span class="w">
   </span><span class="p">(</span><span class="nf">conj!</span><span class="w"> </span><span class="n">acc!</span><span class="w"> </span><span class="n">row</span><span class="p">)))</span><span class="w">
</span></code></pre></div></div>

<p>Some folders depend on initial settings and thus produce folding functions. Here
is an example of the <code class="language-plaintext highlighter-rouge">map</code> folder that acts like the <code class="language-plaintext highlighter-rouge">map</code> function from
<code class="language-plaintext highlighter-rouge">clojure.core</code>:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="nb">map</span><span class="w">
  </span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="k">fn</span><span class="w"> </span><span class="n">folder-map</span><span class="w">
    </span><span class="p">([]</span><span class="w">
     </span><span class="p">(</span><span class="nf">transient</span><span class="w"> </span><span class="p">[]))</span><span class="w">
    </span><span class="p">([</span><span class="n">acc!</span><span class="p">]</span><span class="w">
     </span><span class="p">(</span><span class="nf">persistent!</span><span class="w"> </span><span class="n">acc!</span><span class="p">))</span><span class="w">
    </span><span class="p">([</span><span class="n">acc!</span><span class="w"> </span><span class="n">row</span><span class="p">]</span><span class="w">
     </span><span class="p">(</span><span class="nf">conj!</span><span class="w"> </span><span class="n">acc!</span><span class="w"> </span><span class="p">(</span><span class="nf">f</span><span class="w"> </span><span class="n">row</span><span class="p">)))))</span><span class="w">
</span></code></pre></div></div>

<h3 id="passing-a-folder">Passing A Folder</h3>

<p>To pass a custom folder to process the result, specify the <code class="language-plaintext highlighter-rouge">:as</code> key as follows:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">require</span><span class="w"> </span><span class="o">'</span><span class="p">[</span><span class="n">pg.fold</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">fold</span><span class="p">])</span><span class="w">

</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">row-sum</span><span class="w"> </span><span class="p">[{</span><span class="no">:keys</span><span class="w"> </span><span class="p">[</span><span class="n">field_1</span><span class="w"> </span><span class="n">field_2</span><span class="p">]}]</span><span class="w">
  </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="n">field_1</span><span class="w"> </span><span class="n">field_2</span><span class="p">))</span><span class="w">

</span><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="p">{</span><span class="no">:as</span><span class="w"> </span><span class="p">(</span><span class="nf">fold/map</span><span class="w"> </span><span class="n">row-sum</span><span class="p">)})</span><span class="w">

</span><span class="c1">;; [10 53 14 32 ...]</span><span class="w">
</span></code></pre></div></div>

<h3 id="standard-folders-and-aliases">Standard Folders and Aliases</h3>

<p>PG provides a number of built-in folders. Some of them are used so often that
it’s not needed to pass them explicitly. There are shortcuts that enable certain
folders internally. Below, find the actual list of folders, their shortcuts and
examples.</p>

<h4 id="column">Column</h4>

<p>Takes a single column from each row returning a plain vector:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="p">{</span><span class="no">:as</span><span class="w"> </span><span class="p">(</span><span class="nf">fold/column</span><span class="w"> </span><span class="no">:id</span><span class="p">)})</span><span class="w">

</span><span class="c1">;; [1 2 3 4 ....]</span><span class="w">
</span></code></pre></div></div>

<p>There is an alias <code class="language-plaintext highlighter-rouge">:column</code> that accepts a name of the column:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="p">{</span><span class="no">:column</span><span class="w"> </span><span class="no">:id</span><span class="p">})</span><span class="w">
</span><span class="c1">;; [1 2 3 4 ....]</span><span class="w">
</span></code></pre></div></div>

<h4 id="map">Map</h4>

<p>Acts like the standard <code class="language-plaintext highlighter-rouge">map</code> function from <code class="language-plaintext highlighter-rouge">clojure.core</code>. Applies a function to
each row and collects a vector of results.</p>

<p>Passing the folder explicitly:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="p">{</span><span class="no">:as</span><span class="w"> </span><span class="p">(</span><span class="nf">fold/map</span><span class="w"> </span><span class="n">func</span><span class="p">)})</span><span class="w">
</span></code></pre></div></div>

<p>And with an alias:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="p">{</span><span class="no">:map</span><span class="w"> </span><span class="n">func</span><span class="p">})</span><span class="w">
</span></code></pre></div></div>

<h4 id="default">Default</h4>

<p>Collects unmodified rows into a vector. That’s unlikely you’ll need that folder
as it gets applied internally when no other folders were specified.</p>

<h4 id="dummy">Dummy</h4>

<p>A folder that doesn’t accumulate the rows but just skips them and returns nil.</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="p">{</span><span class="no">:as</span><span class="w"> </span><span class="n">fold/dummy</span><span class="p">})</span><span class="w">

</span><span class="n">nil</span><span class="w">
</span></code></pre></div></div>

<h4 id="first">First</h4>

<p>Perhaps the most needed folder, <code class="language-plaintext highlighter-rouge">first</code> returns the first row only and skips the
rest. Pay attention, this folder doesn’t have a state and thus doesn’t need to
be initiated. Useful when you query a single row by its primary key:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w">
            </span><span class="s">"select * from users where id = $1"</span><span class="w">
            </span><span class="p">{</span><span class="no">:params</span><span class="w"> </span><span class="p">[</span><span class="mi">42</span><span class="p">]</span><span class="w">
             </span><span class="no">:as</span><span class="w"> </span><span class="n">fold/first</span><span class="p">})</span><span class="w">

</span><span class="p">{</span><span class="no">:id</span><span class="w"> </span><span class="mi">42</span><span class="w"> </span><span class="no">:email</span><span class="w"> </span><span class="s">"test@test.com"</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Or pass the <code class="language-plaintext highlighter-rouge">:first</code> (or <code class="language-plaintext highlighter-rouge">:first?</code>) option set to true:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w">
            </span><span class="s">"select * from users where id = $1"</span><span class="w">
            </span><span class="p">{</span><span class="no">:params</span><span class="w"> </span><span class="p">[</span><span class="mi">42</span><span class="p">]</span><span class="w">
             </span><span class="no">:first</span><span class="w"> </span><span class="n">true</span><span class="p">})</span><span class="w">

</span><span class="p">{</span><span class="no">:id</span><span class="w"> </span><span class="mi">42</span><span class="w"> </span><span class="no">:email</span><span class="w"> </span><span class="s">"test@test.com"</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h4 id="index-by">Index by</h4>

<p>Often, you select rows as a vector and build a map like <code class="language-plaintext highlighter-rouge">{id =&gt; row}</code>, for
example:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">rows</span><span class="w"> </span><span class="p">(</span><span class="nf">jdbc/execute!</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="p">[</span><span class="s">"select ..."</span><span class="p">])]</span><span class="w">
  </span><span class="p">(</span><span class="nb">reduce</span><span class="w"> </span><span class="p">(</span><span class="k">fn</span><span class="w"> </span><span class="p">[</span><span class="n">acc</span><span class="w"> </span><span class="n">row</span><span class="p">]</span><span class="w">
            </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">acc</span><span class="w"> </span><span class="p">(</span><span class="no">:id</span><span class="w"> </span><span class="n">row</span><span class="p">)</span><span class="w"> </span><span class="n">row</span><span class="p">))</span><span class="w">
          </span><span class="p">{}</span><span class="w">
          </span><span class="n">rows</span><span class="p">))</span><span class="w">

</span><span class="p">{</span><span class="mi">1</span><span class="w"> </span><span class="p">{</span><span class="no">:id</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="no">:name</span><span class="w"> </span><span class="s">"test1"</span><span class="w"> </span><span class="n">...</span><span class="p">}</span><span class="w">
 </span><span class="mi">2</span><span class="w"> </span><span class="p">{</span><span class="no">:id</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="no">:name</span><span class="w"> </span><span class="s">"test2"</span><span class="w"> </span><span class="n">...</span><span class="p">}</span><span class="w">
 </span><span class="mi">3</span><span class="w"> </span><span class="p">{</span><span class="no">:id</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="no">:name</span><span class="w"> </span><span class="s">"test3"</span><span class="w"> </span><span class="n">...</span><span class="p">}</span><span class="w">
 </span><span class="n">...</span><span class="w">
 </span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>This process is known as indexing because later on, the map is used as an index
for quick lookups.</p>

<p>This approach, although is quite common, has flaws. First, you traverse rows
twice: when fetching them from the database, and then again inside
<code class="language-plaintext highlighter-rouge">reduce</code>. Second, it takes extra lines of code.</p>

<p>The <code class="language-plaintext highlighter-rouge">index-by</code> folder does exactly the same: it accepts a function which is
applied to a row and uses the result as an index key. Most often you pass a
keyword:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">query</span><span class="w">
      </span><span class="s">"with foo (a, b) as (values (1, 2), (3, 4), (5, 6))
      select * from foo"</span><span class="w">

      </span><span class="n">res</span><span class="w">
      </span><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="p">{</span><span class="no">:as</span><span class="w"> </span><span class="p">(</span><span class="nf">fold/index-by</span><span class="w"> </span><span class="no">:a</span><span class="p">)})]</span><span class="w">

</span><span class="p">{</span><span class="mi">1</span><span class="w"> </span><span class="p">{</span><span class="no">:a</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="no">:b</span><span class="w"> </span><span class="mi">2</span><span class="p">}</span><span class="w">
 </span><span class="mi">3</span><span class="w"> </span><span class="p">{</span><span class="no">:a</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="no">:b</span><span class="w"> </span><span class="mi">4</span><span class="p">}</span><span class="w">
 </span><span class="mi">5</span><span class="w"> </span><span class="p">{</span><span class="no">:a</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="no">:b</span><span class="w"> </span><span class="mi">6</span><span class="p">}})</span><span class="w">
</span></code></pre></div></div>

<p>The shortcut <code class="language-plaintext highlighter-rouge">:index-by</code> accepts a function as well:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="p">{</span><span class="no">:index-by</span><span class="w"> </span><span class="no">:a</span><span class="p">})</span><span class="w">
</span></code></pre></div></div>

<h4 id="group-by">Group by</h4>

<p>The <code class="language-plaintext highlighter-rouge">group-by</code> folder is simlar to <code class="language-plaintext highlighter-rouge">index-by</code> but collects multiple rows per a
grouping function. It produces a map like <code class="language-plaintext highlighter-rouge">{(f row) =&gt; [row1, row2, ...]}</code> where
<code class="language-plaintext highlighter-rouge">row1</code>, <code class="language-plaintext highlighter-rouge">row2</code> and the rest return the same value for <code class="language-plaintext highlighter-rouge">f</code>.</p>

<p>Imagine each user in the database has a role:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="no">:id</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="no">:name</span><span class="w"> </span><span class="s">"Test1"</span><span class="w"> </span><span class="no">:role</span><span class="w"> </span><span class="s">"user"</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="no">:id</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="no">:name</span><span class="w"> </span><span class="s">"Test2"</span><span class="w"> </span><span class="no">:role</span><span class="w"> </span><span class="s">"user"</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="no">:id</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="no">:name</span><span class="w"> </span><span class="s">"Test3"</span><span class="w"> </span><span class="no">:role</span><span class="w"> </span><span class="s">"admin"</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="no">:id</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="no">:name</span><span class="w"> </span><span class="s">"Test4"</span><span class="w"> </span><span class="no">:role</span><span class="w"> </span><span class="s">"owner"</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="no">:id</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="no">:name</span><span class="w"> </span><span class="s">"Test5"</span><span class="w"> </span><span class="no">:role</span><span class="w"> </span><span class="s">"admin"</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>This is what <code class="language-plaintext highlighter-rouge">group-by</code> returns when grouping by the <code class="language-plaintext highlighter-rouge">:role</code> field:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="p">{</span><span class="no">:as</span><span class="w"> </span><span class="p">(</span><span class="nf">fold/group-by</span><span class="w"> </span><span class="no">:role</span><span class="p">)})</span><span class="w">

</span><span class="p">{</span><span class="s">"user"</span><span class="w">
 </span><span class="p">[{</span><span class="no">:id</span><span class="w"> </span><span class="mi">1</span><span class="n">,</span><span class="w"> </span><span class="no">:name</span><span class="w"> </span><span class="s">"Test1"</span><span class="n">,</span><span class="w"> </span><span class="no">:role</span><span class="w"> </span><span class="s">"user"</span><span class="p">}</span><span class="w">
  </span><span class="p">{</span><span class="no">:id</span><span class="w"> </span><span class="mi">2</span><span class="n">,</span><span class="w"> </span><span class="no">:name</span><span class="w"> </span><span class="s">"Test2"</span><span class="n">,</span><span class="w"> </span><span class="no">:role</span><span class="w"> </span><span class="s">"user"</span><span class="p">}]</span><span class="w">

 </span><span class="s">"admin"</span><span class="w">
 </span><span class="p">[{</span><span class="no">:id</span><span class="w"> </span><span class="mi">3</span><span class="n">,</span><span class="w"> </span><span class="no">:name</span><span class="w"> </span><span class="s">"Test3"</span><span class="n">,</span><span class="w"> </span><span class="no">:role</span><span class="w"> </span><span class="s">"admin"</span><span class="p">}</span><span class="w">
  </span><span class="p">{</span><span class="no">:id</span><span class="w"> </span><span class="mi">5</span><span class="n">,</span><span class="w"> </span><span class="no">:name</span><span class="w"> </span><span class="s">"Test5"</span><span class="n">,</span><span class="w"> </span><span class="no">:role</span><span class="w"> </span><span class="s">"admin"</span><span class="p">}]</span><span class="w">

 </span><span class="s">"owner"</span><span class="w">
 </span><span class="p">[{</span><span class="no">:id</span><span class="w"> </span><span class="mi">4</span><span class="n">,</span><span class="w"> </span><span class="no">:name</span><span class="w"> </span><span class="s">"Test4"</span><span class="n">,</span><span class="w"> </span><span class="no">:role</span><span class="w"> </span><span class="s">"owner"</span><span class="p">}]}</span><span class="w">
</span></code></pre></div></div>

<p>The folder has its own alias which accepts a function:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="p">{</span><span class="no">:group-by</span><span class="w"> </span><span class="no">:role</span><span class="p">})</span><span class="w">
</span></code></pre></div></div>

<h4 id="kv-key-and-value">KV (Key and Value)</h4>

<p>The <code class="language-plaintext highlighter-rouge">kv</code> folder accepts two functions: the first one is for a key (<code class="language-plaintext highlighter-rouge">fk</code>), and
the second is for a value (<code class="language-plaintext highlighter-rouge">fv</code>). Then it produces a map like <code class="language-plaintext highlighter-rouge">{(fk row) =&gt; (fv
row)}</code>.</p>

<p>A typical example might be a narrower index map. Imagine you select just a
couple of fields, <code class="language-plaintext highlighter-rouge">id</code> and <code class="language-plaintext highlighter-rouge">email</code>. Now you need a map of <code class="language-plaintext highlighter-rouge">{id =&gt; email}</code> for
quick email lookup by id. This is where <code class="language-plaintext highlighter-rouge">kv</code> does the job for you.</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w">
            </span><span class="s">"select id, email from users"</span><span class="w">
            </span><span class="p">{</span><span class="no">:as</span><span class="w"> </span><span class="p">(</span><span class="nf">fold/kv</span><span class="w"> </span><span class="no">:id</span><span class="w"> </span><span class="no">:email</span><span class="p">)})</span><span class="w">

</span><span class="p">{</span><span class="mi">1</span><span class="w"> </span><span class="s">"ivan@test.com"</span><span class="w">
 </span><span class="mi">2</span><span class="w"> </span><span class="s">"hello@gmail.com"</span><span class="w">
 </span><span class="mi">3</span><span class="w"> </span><span class="s">"skotobaza@mail.ru"</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">:kv</code> alias accepts a vector of two functions:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w">
            </span><span class="s">"select id, email from users"</span><span class="w">
            </span><span class="p">{</span><span class="no">:kv</span><span class="w"> </span><span class="p">[</span><span class="no">:id</span><span class="w"> </span><span class="no">:email</span><span class="p">]})</span><span class="w">
</span></code></pre></div></div>

<h4 id="run">Run</h4>

<p>The <code class="language-plaintext highlighter-rouge">run</code> folder is useful for processing rows with side effects, e.g. printing
them, writing to files, passing via API. A one-argument function passed to <code class="language-plaintext highlighter-rouge">run</code>
is applied to each row ignoring the result. The folder counts a total number of
rows being processed.</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">func</span><span class="w"> </span><span class="p">[</span><span class="n">row</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nb">println</span><span class="w"> </span><span class="s">"processing row"</span><span class="w"> </span><span class="n">row</span><span class="p">)</span><span class="w">
  </span><span class="p">(</span><span class="nf">send-to-api</span><span class="w"> </span><span class="n">row</span><span class="p">))</span><span class="w">

</span><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="p">{</span><span class="no">:as</span><span class="w"> </span><span class="p">(</span><span class="nf">fold/run</span><span class="w"> </span><span class="n">func</span><span class="p">)})</span><span class="w">

</span><span class="mi">100</span><span class="w"> </span><span class="c1">;; the number of rows processed</span><span class="w">
</span></code></pre></div></div>

<p>An example with an alias:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="p">{</span><span class="no">:run</span><span class="w"> </span><span class="n">func</span><span class="p">})</span><span class="w">
</span></code></pre></div></div>

<h4 id="table">Table</h4>

<p>The <code class="language-plaintext highlighter-rouge">table</code> folder returns a plain matrix (a vector of vectors) of database
values. It reminds the <code class="language-plaintext highlighter-rouge">columns</code> folder but also keeps column names in the
leading row. Thus, the resulting table always has at least one row (it’s never
empty because of the header). The table view is useful when saving the data into
CSV.</p>

<p>The folder has its inner state and thus needs to be initialized with no
parameters:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="p">{</span><span class="no">:as</span><span class="w"> </span><span class="p">(</span><span class="nf">fold/table</span><span class="p">)})</span><span class="w">

</span><span class="p">[[</span><span class="no">:id</span><span class="w"> </span><span class="no">:email</span><span class="p">]</span><span class="w">
 </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="s">"ivan@test.com"</span><span class="p">]</span><span class="w">
 </span><span class="p">[</span><span class="mi">2</span><span class="w"> </span><span class="s">"skotobaza@mail.ru"</span><span class="p">]]</span><span class="w">
</span></code></pre></div></div>

<p>The alias <code class="language-plaintext highlighter-rouge">:table</code> accepts any non-false value:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="p">{</span><span class="no">:table</span><span class="w"> </span><span class="n">true</span><span class="p">})</span><span class="w">

</span><span class="p">[[</span><span class="no">:id</span><span class="w"> </span><span class="no">:email</span><span class="p">]</span><span class="w">
 </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="s">"ivan@test.com"</span><span class="p">]</span><span class="w">
 </span><span class="p">[</span><span class="mi">2</span><span class="w"> </span><span class="s">"skotobaza@mail.ru"</span><span class="p">]]</span><span class="w">
</span></code></pre></div></div>

<h4 id="java">Java</h4>

<p>This folder produces <code class="language-plaintext highlighter-rouge">java.util.ArrayList</code> where each row is an instance of
<code class="language-plaintext highlighter-rouge">java.util.HashMap</code>. It doesn’t require initialization:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="p">{</span><span class="no">:as</span><span class="w"> </span><span class="n">fold/java</span><span class="p">})</span><span class="w">
</span></code></pre></div></div>

<p>Alias:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="p">{</span><span class="no">:java</span><span class="w"> </span><span class="n">true</span><span class="p">})</span><span class="w">
</span></code></pre></div></div>

<h4 id="reduce">Reduce</h4>

<p>The <code class="language-plaintext highlighter-rouge">reduce</code> folder acts like the same-name function from <code class="language-plaintext highlighter-rouge">clojure.core</code>. It
accepts a function and an initial value (accumulator). The function accepts the
accumulator and the current row, and returns an updated version of the
accumulator.</p>

<p>Here is how you collect unique pairs of size and color from the database result:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">-&gt;pair</span><span class="w"> </span><span class="p">[</span><span class="n">acc</span><span class="w"> </span><span class="p">{</span><span class="no">:keys</span><span class="w"> </span><span class="p">[</span><span class="n">sku</span><span class="w"> </span><span class="n">color</span><span class="p">]}]</span><span class="w">
  </span><span class="p">(</span><span class="nb">conj</span><span class="w"> </span><span class="n">acc</span><span class="w"> </span><span class="p">[</span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">]))</span><span class="w">

</span><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="p">{</span><span class="no">:as</span><span class="w"> </span><span class="p">(</span><span class="nf">fold/reduce</span><span class="w"> </span><span class="n">-&gt;pair</span><span class="w"> </span><span class="o">#</span><span class="p">{})})</span><span class="w">

</span><span class="o">#</span><span class="p">{[</span><span class="no">:xxl</span><span class="w"> </span><span class="no">:green</span><span class="p">]</span><span class="w">
  </span><span class="p">[</span><span class="no">:xxl</span><span class="w"> </span><span class="no">:red</span><span class="p">]</span><span class="w">
  </span><span class="p">[</span><span class="no">:x</span><span class="w"> </span><span class="no">:red</span><span class="p">]</span><span class="w">
  </span><span class="p">[</span><span class="no">:x</span><span class="w"> </span><span class="no">:blue</span><span class="p">]}</span><span class="w">
</span></code></pre></div></div>

<p>The folder ignores <code class="language-plaintext highlighter-rouge">reduced</code> logic: it performs iteration until all rows are
consumed. It doesn’t check if the accumulator is wrapped with <code class="language-plaintext highlighter-rouge">reduced</code>.</p>

<p>The <code class="language-plaintext highlighter-rouge">:reduce</code> alias accepts a vector of a function and an initial value:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="p">{</span><span class="no">:reduce</span><span class="w"> </span><span class="p">[</span><span class="n">-&gt;pair</span><span class="w"> </span><span class="o">#</span><span class="p">{}]})</span><span class="w">
</span></code></pre></div></div>

<h4 id="into-transduce">Into (Transduce)</h4>

<p>This folder mimics the <code class="language-plaintext highlighter-rouge">into</code> logic when it deals with an <code class="language-plaintext highlighter-rouge">xform</code>, also known as
a transducer. Sometimes, you need to pass the result throughout a bunch of
<code class="language-plaintext highlighter-rouge">map</code>/<code class="language-plaintext highlighter-rouge">filter</code>/<code class="language-plaintext highlighter-rouge">keep</code> functions. Each of them produces an intermediate
collection which is not as fast as it could be with a transducer. Transducers
are designed such that they compose a stack of actions, which, when being run,
does not produce extra collections.</p>

<p>The <code class="language-plaintext highlighter-rouge">into</code> folder accepts an <code class="language-plaintext highlighter-rouge">xform</code> produced by <code class="language-plaintext highlighter-rouge">map</code>/<code class="language-plaintext highlighter-rouge">filter</code>/<code class="language-plaintext highlighter-rouge">comp</code>,
whatever. It also accepts a persistent collection which acts as an
accumulator. The accumulator gets transformed into a transient view internally
for better performance. The folder uses <code class="language-plaintext highlighter-rouge">conj!</code> to push values into the
accumulator, so maps are not acceptable, only vectors, lists, or sets. When the
accumulator is not passed, it’s an empty vector.</p>

<p>Here is a quick example of <code class="language-plaintext highlighter-rouge">into</code> in action:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">tx</span><span class="w">
      </span><span class="p">(</span><span class="nb">comp</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="no">:a</span><span class="p">)</span><span class="w">
            </span><span class="p">(</span><span class="nb">filter</span><span class="w"> </span><span class="o">#</span><span class="p">{</span><span class="mi">1</span><span class="w"> </span><span class="mi">5</span><span class="p">})</span><span class="w">
            </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="nb">str</span><span class="p">))</span><span class="w">

      </span><span class="n">query</span><span class="w">
      </span><span class="s">"with foo (a, b) as (values (1, 2), (3, 4), (5, 6))
       select * from foo"</span><span class="p">]</span><span class="w">

  </span><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="p">{</span><span class="no">:as</span><span class="w"> </span><span class="p">(</span><span class="nf">fold/into</span><span class="w"> </span><span class="n">tx</span><span class="p">)}))</span><span class="w">

</span><span class="c1">;; ["1" "5"]</span><span class="w">
</span></code></pre></div></div>

<p>Another case where we pass a non-empty set to collect the values:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="p">{</span><span class="no">:as</span><span class="w"> </span><span class="p">(</span><span class="nf">fold/into</span><span class="w"> </span><span class="n">tx</span><span class="w"> </span><span class="o">#</span><span class="p">{</span><span class="no">:a</span><span class="w"> </span><span class="no">:b</span><span class="w"> </span><span class="no">:c</span><span class="p">})})</span><span class="w">

</span><span class="c1">;; #{:a :b :c "1" "5"}</span><span class="w">
</span></code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">:into</code> alias is a vector where the first item is an <code class="language-plaintext highlighter-rouge">xform</code> and the second
is an accumulator:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="p">{</span><span class="no">:into</span><span class="w"> </span><span class="p">[</span><span class="n">tx</span><span class="w"> </span><span class="p">[]]})</span><span class="w">
</span></code></pre></div></div>

<h4 id="to-edn">To EDN</h4>

<p>This folder writes down rows into an EDN file. It accepts an instance of
<code class="language-plaintext highlighter-rouge">java.io.Writer</code> which must be opened in advance. The folder doesn’t open nor
close the writer as these actions are beyond its scope. A common pattern is to
wrap <code class="language-plaintext highlighter-rouge">pg/execute</code> or <code class="language-plaintext highlighter-rouge">pg/query</code> invocations with the <code class="language-plaintext highlighter-rouge">with-open</code> macro that
handles closing procedure even in case of an exception.</p>

<p>The folder writes down rows into the writer using <code class="language-plaintext highlighter-rouge">pr-str</code>. Each row takes one
line, and the lines are split with <code class="language-plaintext highlighter-rouge">\n</code>. The leading line is <code class="language-plaintext highlighter-rouge">[</code>, and the
trailing is <code class="language-plaintext highlighter-rouge">]</code>.</p>

<p>The result is a number of rows processed. Here is an example of dumping rows
into a file called “test.edn”:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nb">with-open</span><span class="w"> </span><span class="p">[</span><span class="n">out</span><span class="w"> </span><span class="p">(</span><span class="nb">-&gt;</span><span class="w"> </span><span class="s">"test.edn"</span><span class="w"> </span><span class="n">io/file</span><span class="w"> </span><span class="n">io/writer</span><span class="p">)]</span><span class="w">
  </span><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="p">{</span><span class="no">:as</span><span class="w"> </span><span class="p">(</span><span class="nf">fold/to-edn</span><span class="w"> </span><span class="n">out</span><span class="p">)}))</span><span class="w">

</span><span class="c1">;; 199</span><span class="w">
</span></code></pre></div></div>

<p>Let’s check the content of the file:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="w">
  </span><span class="p">{</span><span class="no">:id</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="no">:email</span><span class="w"> </span><span class="s">"test@test.com"</span><span class="p">}</span><span class="w">
  </span><span class="p">{</span><span class="no">:id</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="no">:email</span><span class="w"> </span><span class="s">"hello@test.com"</span><span class="p">}</span><span class="w">
  </span><span class="n">...</span><span class="w">
  </span><span class="p">{</span><span class="no">:id</span><span class="w"> </span><span class="mi">199</span><span class="w"> </span><span class="no">:email</span><span class="w"> </span><span class="s">"ivan@test.com"</span><span class="p">}</span><span class="w">
</span><span class="p">]</span><span class="w">
</span></code></pre></div></div>

<p>The alias <code class="language-plaintext highlighter-rouge">:to-edn</code> accepts a writer object:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nb">with-open</span><span class="w"> </span><span class="p">[</span><span class="n">out</span><span class="w"> </span><span class="p">(</span><span class="nb">-&gt;</span><span class="w"> </span><span class="s">"test.edn"</span><span class="w"> </span><span class="n">io/file</span><span class="w"> </span><span class="n">io/writer</span><span class="p">)]</span><span class="w">
  </span><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="p">{</span><span class="no">:to-edn</span><span class="w"> </span><span class="n">out</span><span class="p">}))</span><span class="w">
</span></code></pre></div></div>

<h4 id="to-json">To JSON</h4>

<p>Like <code class="language-plaintext highlighter-rouge">to-edn</code> but dumps rows into JSON. Accepts an instance of
<code class="language-plaintext highlighter-rouge">java.io.Writer</code>. Writes rows line by line with no pretty printing. Lines are
joined with a comma. The leading and trailing lines are square brackets. The
result is the number of rows put into the writer.</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nb">with-open</span><span class="w"> </span><span class="p">[</span><span class="n">out</span><span class="w"> </span><span class="p">(</span><span class="nb">-&gt;</span><span class="w"> </span><span class="s">"test.json"</span><span class="w"> </span><span class="n">io/file</span><span class="w"> </span><span class="n">io/writer</span><span class="p">)]</span><span class="w">
  </span><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="p">{</span><span class="no">:as</span><span class="w"> </span><span class="p">(</span><span class="nf">fold/to-json</span><span class="w"> </span><span class="n">out</span><span class="p">)}))</span><span class="w">

</span><span class="c1">;; 123</span><span class="w">
</span></code></pre></div></div>

<p>The content of the file:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="w">
  </span><span class="p">{</span><span class="nl">"b"</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="nl">"a"</span><span class="p">:</span><span class="mi">1</span><span class="p">},</span><span class="w">
  </span><span class="p">{</span><span class="nl">"b"</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="nl">"a"</span><span class="p">:</span><span class="mi">3</span><span class="p">},</span><span class="w">
  </span><span class="err">//</span><span class="w"> </span><span class="err">...</span><span class="w">
  </span><span class="p">{</span><span class="nl">"b"</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span><span class="nl">"a"</span><span class="p">:</span><span class="mi">5</span><span class="p">}</span><span class="w">
</span><span class="p">]</span><span class="w">
</span></code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">:to-json</code> alias accepts a writer object:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nb">with-open</span><span class="w"> </span><span class="p">[</span><span class="n">out</span><span class="w"> </span><span class="p">(</span><span class="nb">-&gt;</span><span class="w"> </span><span class="s">"test.json"</span><span class="w"> </span><span class="n">io/file</span><span class="w"> </span><span class="n">io/writer</span><span class="p">)]</span><span class="w">
  </span><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="p">{</span><span class="no">:to-json</span><span class="w"> </span><span class="n">out</span><span class="p">}))</span><span class="w">
</span></code></pre></div></div>

<hr />

<p>For more details, you’re welcome to the <a href="https://github.com/igrishaev/pg2/blob/master/README.md">readme file</a> of the repo.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/json-pass/">Перекладывание</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2024-07-06T00:00:00+00:00">
        Jul 6, 2024
    </time>

    <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/json/" rel="tag">json</a>

</div>


            <div class="entry">
                
                    <p>Иногда говорят: это тебе не джейсоны перекладывать, тут думать надо. А между
прочим, перекладывать джейсоны – очень трудное занятие.</p>

<p>Прилетает вам джейсон из сети. Надо его прочитать, провалидировать, распарсить
даты, подрезать лишнее. Потом выгрести из базы то, из кэша се, из S3 третье и
все это собрать в нечто нужное бизнесу. Сделать эксельку, положить в S3 и
отписать в очередь.</p>

<p>На каждом шаге может быть сто причин для эксепшена. Записать логи, не раскрывая
бизнес-данных и секретов, собрать исключения и отправить в Сентри.</p>

<p>Иные джейсоны пятиэтажной вложенности. Нужно рыскать по их кишкам и строить
обратные мапы (индексы). Потом передавать по пять индексов в другие функции.</p>

<p>Читать из базы миллион джейсонов так, чтобы не умереть от нехватки памяти в AWS.</p>

<p>В идеале покрыть все случаи тестами, желательно с Докером, чтобы были настоящие
база, Редис, S3 и так далее.</p>

<p>Все еще легко, на ваш взгляд? Не знаю, мне кажется трудным. Поэтому над
“перекладыванием” я не смеюсь.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/csv-to-xlsx/">Excel и CSV</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2024-07-06T00:00:00+00:00">
        Jul 6, 2024
    </time>

    <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/excel/" rel="tag">excel</a>, <a href="/tag/csv/" rel="tag">csv</a>

</div>


            <div class="entry">
                
                    <p>Маленькая техническая заметка. Не пользуйтесь CSV в надежде, что он откроется в
Экселе. Если ваши потребители – люди с Экселем (а таких большинство), нужно
генерить <code class="language-plaintext highlighter-rouge">.xlsx</code>, а не <code class="language-plaintext highlighter-rouge">.csv</code>.</p>

<p>Дело в том, что Эксель писали в Микрософте. Может быть, сегодняшний MS уже обрел
какую-то человечность. Но Эксель отсчитывает возраст с 1985 года – прямо как я –
и старше многих читателей этой заметки. Поэтому ни о какой человечности говорить
не приходится.</p>

<p>Эксель никогда не откроет CSV без ошибок. Он обязательно промажет с
разделителем: если в файле запятая, он ищет точку с запятой и наоборот. Для
обхода придумали грубый костыль: в первой строке может быть выражение sep=, и
тогда Эксель возьмет запятую. Но этот заголовок ломает парсеры CSV, которые ни о
каком Экселе не слышали.</p>

<p>Разделитель по умолчанию может зависеть от локали. У француза откроется, а у
австрийца не откроется.</p>

<p>Эксель по-прежнему игнорирует UTF8. Немецкие умляуты становятся
кракозябрами. Махинации с меткой BOM ни к чему не приводят.</p>

<p>В Экселе есть мастер импорта из CSV, но можно подумать, людям больше нечем
заняться, как импортировать что-то куда-то ради таблички.</p>

<p>В общем, нужно напрячь булки и выкинуть CSV, и вместо этого генерить нормальный
Эксель.</p>

<p>Если вдруг у вас Джава или Кложа, берите fastexcel и fastexcel-reader – они
быстрее и компилируются Граалем. Все, что основано на Apache POI, тормозное и не
компилируется Граалем. Я эту дорогу прошел и вот делюсь с вами.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/avito-my/">Мои объявления</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2024-07-06T00:00:00+00:00">
        Jul 6, 2024
    </time>

    <a href="/tag/avito/" rel="tag">avito</a>, <a href="/tag/ui/" rel="tag">ui</a>, <a href="/tag/idiots/" rel="tag">idiots</a>

</div>


            <div class="entry">
                
                    <p><img src="/assets/static/aws/avito-my/1.jpg" /></p>

<p>Авито, страница “Мои объявления” — разве это не забавно? На экране все что
угодно, кроме моих объявлений. Огромная плашка, громадные пустоты. Слоеный
дизайн, когда каждый слой, пусть даже занимает сантиметр в ширину, растекается
на весь экран.</p>

<p>Очередной калека-дизайнер, которому “не хватило места”. Важная часть уехала на
экран ниже — потому что первый экран занял всякий шлак.</p>

<p>Считаю, таких дизайнеров надо даже не учить, а лечить. Обучение бессильно, пусть
действуют профильные специалисты.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/amazon-download/">Загрузка в Амазоне</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2024-07-06T00:00:00+00:00">
        Jul 6, 2024
    </time>

    <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/aws/" rel="tag">aws</a>, <a href="/tag/s3/" rel="tag">s3</a>, <a href="/tag/files/" rel="tag">files</a>

</div>


            <div class="entry">
                
                    <p>У веб-панели S3 есть особенность: если скачать оттуда файл, Амазон поправит
расширение в зависимости от Content-Type, который назначили файлу при
создании. Например, если у файла нет расширения, а Content-Type равен
<code class="language-plaintext highlighter-rouge">application/json</code>, то Амазон допишет в конец .json, чтобы файлик открылся.</p>

<p>Казалось бы, хорошо? А вот что имеем на практике.</p>

<p>Если залить файл <code class="language-plaintext highlighter-rouge">hello.json.gzip</code>, внутри которого сжатый Gzip-ом JSON, и
указать заголовки <code class="language-plaintext highlighter-rouge">Content-Type: application/json</code>, <code class="language-plaintext highlighter-rouge">Content-Encoding: gzip</code>, то
при загрузке произойдет следующее.</p>

<p>Файл будет декодирован Амазоном, чтобы клиенту не пришлось делать это руками. Не
бог весть какая помощь, потому что и текстовые редакторы, и файловые менеджеры
открывают gzip-файлы. Но ладно.</p>

<p>После раскодировки Амазон смотрит: что там внутри? Application/json? Значит
удалим <code class="language-plaintext highlighter-rouge">.gzip</code> и добавим <code class="language-plaintext highlighter-rouge">.json</code>. В результате получается файл
<code class="language-plaintext highlighter-rouge">hello.json.json</code>. Я не шучу, проверьте сами.</p>

<p>Второй случай: я залил в Амазон файл <code class="language-plaintext highlighter-rouge">report.xlsx</code>, но указал не тот
Content-Type. Указал старый <code class="language-plaintext highlighter-rouge">application/vnd.ms-excel</code> для xls документов, а
надо было такую колбасу:
<code class="language-plaintext highlighter-rouge">application/vnd.openxmlformats-officedocument.spreadsheetml.sheet</code>. При
загрузке Амазон молча исправил расширение с <code class="language-plaintext highlighter-rouge">.xlsx</code> на <code class="language-plaintext highlighter-rouge">.xls</code>. А Эксель тоже
хорош: по клику на файл он пишет, что формат битый, ничего не знаю – нет бы
первые 100 байтов проверить, тупица.</p>

<p>На ровном месте Амазон заруинил файл, хотя никто об этом не просил.</p>

<p>Понимаете, не нужно мне помогать! Не нужно что-то тайно переименовывать для моей
же пользы. Если прям чешется в одном месте – спроси, и я нажму “больше не
спрашивать”.</p>

<p>Кроме того, надо помнить: в Амазоне работают не боги, а такие же кодеры, как и
везде. Перед нами обычный баг, который живет в проде не один год, и никому нет
дела. Баг состоит в том, что махинации с расширением нужно производить только
если у файла нет расширения. Вдобавок у расширения приоритет выше, чем у
Content-Type, потому что последний – это метаинформация, которая может
потеряться или исказиться. Вероятность потерять расширение гораздо ниже, нежели
Content-Type.</p>

<p>Верю, что когда-нибудь в Амазоне это поймут.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/interstellar-tick/">Время в Interstellar</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2024-07-05T00:00:00+00:00">
        Jul 5, 2024
    </time>

    <a href="/tag/life/" rel="tag">life</a>, <a href="/tag/interstellar/" rel="tag">interstellar</a>

</div>


            <div class="entry">
                
                    <p>Вы же смотрели Интерстеллар? Помните высадку на планету с волной? А музыку в
фоне, такую тревожную, помните? Тик-так, тик-так по нарастающей?</p>

<p>Этот тик-так — неспроста. Каждый тик равен 1.37 секунды, и за это время на Земле
проходят сутки. Именно такое соотношение времени между Землей и той планетой
из-за близости к черной дыре. Ганс Циммер гений.</p>

<p>Когда знаешь об этом, в сцену добавляется новый оттенок. Теперь уже не смотришь
на метания за разбитым кораблем: слушаешь тик-так и представляешь, как впустую
проходит чья-то жизнь — твоя, например.</p>

<p>Иногда по вечерам, вытряхнув себя из-за компа, я чувствую что-то похожее. Словно
жизнь — это фильм, а в фоне кто-то цокает языком. Исправляешь чей-то быдлокод и
косяки, потом идешь домой и думаешь — что я вообще делал?</p>

<p>Нечто похожее встретилось в дневниках Корнея Чуковского времен блокады
Ленинграда: “дни сгорают как бумажные”. Потому он и великий писатель, что не
уходят, не летят, а именно сгорают.</p>

<p>Впрочем, потом меня отпускает, и я снова иду править чужой код и косяки. И так
постоянно.</p>

<iframe width="100%" height="500" src="https://www.youtube.com/embed/60h6lpnSgck" title="Interstellar | “Tidal Wave&quot; Full Scene (Anne Hathaway, Matthew McConaughey) | Paramount Movies" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen=""></iframe>

                
            </div>

        </li>
        
    </ul>

    <h4>
        
        <a href="/" class="previous">&larr;</a>
        
        <span class="page_number ">Страница 2 из 80</span>
        
        <a href="/page3" class="next">&rarr;</a>
        
    </h4>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Ivan Grishaev's blog</li>
          <li><a href="mailto:ivan@grishaev.me">ivan@grishaev.me</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
            <li><a href="https://github.com/igrishaev">GitHub</a></li>
            <li><a href="tg://resolve?domain=igrishaev_blog">Telegram</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Writing on programming, education, books and negotiations.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
