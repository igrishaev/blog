<!DOCTYPE html>
<html lang="ru">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Ivan Grishaev's blog</title>
  <meta name="description" content="Writing on programming, education, books and negotiations.
">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/custom.css">
  <link rel="canonical" href="https://grishaev.me/page2/">
  <link rel="alternate" type="application/rss+xml" title="Ivan Grishaev's blog" href="https://grishaev.me/feed.xml">

  <link rel="shortcut icon" type="image/x-icon" href="/assets/static/favicons/favicon.ico">

  <script type="text/javascript" src="/assets/typo.js"></script>

</head>


  <body>
    <header class="site-header">

    <div class="wrapper flex-container">

        <div>
            <a href="/">
                <img id="avatar" src="/assets/static/avatar.jpg" alt="Ivan Grishaev">
            </a>
        </div>

        <div class="flex-container-vert" style="margin-left: 15px; width: 80%">

            <div class="flex-container full-width">
                <p style="margin-bottom: 5px"><a href="/">Ivan Grishaev's blog</a></p>
                <div class="flex-huge"></div>
                <div >
<form id="search-form"
      target="_blank"
      style="display: inline"
      method="get"
      action="https://www.google.com/search">

    <input name="sitesearch"
           value="grishaev.me"
           type="hidden">

    <input type="text"
           required="required"
           name="q"
           placeholder="Google search..."
           autocomplete="off">

    <button style="border: none; background-color: transparent; cursor: pointer;"
            type="submit">&#x1f50d;</button>

</form>
</div>
            </div>

            <p><small>Writing on programming, education, books and negotiations.
</small></p>

            <div class="flex-container">
                <a class="menu-item" href="/">Home</a>
                <a class="menu-item" href="/about/">About</a>
                <a class="menu-item" href="/open-source/">Open Source</a>
                <a class="menu-item" href="/bookshelf/">Bookshelf</a>
                <a class="menu-item" href="/feed.xml">RSS</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor" href="/tag/clojure/">Clojure</a>
                <a class="menu-item minor" href="/tag/emacs/">Emacs</a>
                <a class="menu-item minor" href="/tag/python/">Python</a>
                <a class="menu-item minor" href="/tag/programming/">Programming</a>
                <a class="menu-item minor" href="/interview/">Interview</a>
                <a class="menu-item minor" href="/video/">Video</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor hl" href="/clojure-in-prod/">Книга «Clojure на производстве»</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor hl" href="/clojure-in-prod-2/">Книга «Clojure на производстве», второй том</a>
            </div>

        </div>
    </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="home">

    <ul class="post-list">
        
        <li>

            <h2>
                <a class="post-link" href="/multi-curr/">Игровые валюты</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2025-11-28T00:00:00+00:00">
        Nov 28, 2025
    </time>

    <a href="/tag/life/" rel="tag">life</a>

</div>


            <div class="entry">
                
                    <p>Как-то раз на меня нашла деградация: поставил на телефон тупую
стрелялку. Примерно как 15 лет назад: бесплатную, но с продвинутой системой
выжимания денег.</p>

<p>Кроме бесконечных выпадашек с просьбой что-то купить удивило другое, а именно —
разнообразие валют. Смотрите, есть сами деньги. Есть золотые слитки для
премиум-товаров. Есть какие-то кристаллы. Есть энергетические сгустки, а еще
какие-то кубки, бонусы, баллы и так далее. Я даже не запомнил номенклатуру, не
говоря уж о том, для чего нужна та или иная валюта.</p>

<p>Вдобавок это неудобно: чтобы купить пистолет, нужны кристаллы. Чтобы открыть
бонус-уровень, нужны сгустки. Хоть на бумажку записывай. Разумеется, чьи-то дети
сидят в игре часами и на память знают, что нужно для чего. Но такую роскошь я
позволить себе не могу.</p>

<p>Моя идея в том, что механика игровых валют переусложнена. Может быть, в
усложненном варианте она приносит больше денег. Менеджер такой: давайте добавим
платиновые слитки и подогреем интерес. Возможно, что-то там подогреется. Однако
с годами вряд ли кто-то понимает, сколько у нас валют и что на них покупается.</p>

<p>Похожую вещь наблюдаю в фирмах с особо креативными менеджерами. Например, в
Озоне. У них есть баллы, мили, вау-баллы, звезды. Есть бонусы продавцов. Недавно
добавили какие-то морковки, засунули зайцев в каждую щель. Это все хорошо за
одним исключением — я не понимаю, что вообще происходит. В многообразии валют,
баллов и миль исчезает ясность: какие у тебя привилегии.</p>

<p>Нужно, чтобы менеджерам Озона кто-то сказал: ребят, морковки это хорошо, но
старое нужно подчищать. Похоже, вы сами не особо понимаете, что у вас там: мили,
баллы и так далее. Навели бы порядок.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/win-10-python/">Python в Windows 10</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2025-10-03T00:00:00+00:00">
        Oct 3, 2025
    </time>

    <a href="/tag/windows/" rel="tag">windows</a>, <a href="/tag/python/" rel="tag">python</a>

</div>


            <div class="entry">
                
                    <p>Виндуз 10 — мягко говоря, странная вещь. Во всех операционках Питон идет из
коробки, а на Винде его нет. Вместо него — заглушка. Если набрать в консоли
<code class="language-plaintext highlighter-rouge">python foo.py</code>, появится надпись: друг, у тебя нет Питона. Чтобы поставить его,
просто введи python.</p>

<p>Хорошо, ввожу <code class="language-plaintext highlighter-rouge">python</code>. Открывается магазин приложений и тут же выстреливает
алертами: и какая-то ошибка, и регион не тот, и токен протух. Еле закрыл к
чертям, а то и дальше бы кидался ошибками.</p>

<p>Скачал Питон с официального сайта, поставил. Ввожу <code class="language-plaintext highlighter-rouge">python foo.py</code> — опять та же
самая заглушка. Минуточку, где Питон, который я поставил минуту назад? Начинаю
искать. В дни моей молодости он ставился в корень: <code class="language-plaintext highlighter-rouge">C:\Python27</code>. Там его
нет. Ищу в <code class="language-plaintext highlighter-rouge">C:\Program Files</code> (обоих папках) — тоже нет. Наконец догадался:
проверил ярлык в меню Пуск. Знаете куда он ведет? Вот:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:\Users\ivan\AppData\Local\Programs\Python\Python3.8\...
</code></pre></div></div>

<p>Удивляюсь, какими же уродами надо быть, чтобы так сделать? Мало того что
засунули его глубже некуда, так еще не сменили заглушку для магазина!</p>

<p>Ладно, может быть заглушку нельзя трогать по условиям лицензии. Тогда почему
инсталятор не добавил путь к Питону в <code class="language-plaintext highlighter-rouge">PATH</code>?</p>

<p>Ничего не работает как надо. Какое-то сборище клоунов, честное слово.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/weird-code/">Непонятный код</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2025-10-03T00:00:00+00:00">
        Oct 3, 2025
    </time>

    <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/code/" rel="tag">code</a>

</div>


            <div class="entry">
                
                    <p>Одна из самых бесячих вещей — когда кто-то вбрасывает непонятный код и
спрашивает, что он выведет. Откуда я знаю, что он выведет? Запусти и
посмотри. Еще лучше исправить код, чтобы он был понятен сразу.</p>

<p>Я еще могу понять, если это какой-нибудь сишный код, оптимизированный по самые
помидоры, чтобы умещаться в кэше процессора. Это чужой монастырь, и там свои
погремушки. Но когда это обычный бизнес-код типа “принять две мапы и взять
наибольший ключ”, оправданий быть не может.</p>

<p>Почему-то мало кто понимает: писать непонятный код легко, а понятный —
трудно. На это уходят годы практики, нужно пройти много ситуаций, чтобы понять,
какой код и при каких обстоятельсвах понятен. Вываливать непонятный код — то же
самое, что мочиться в штаны. Нужно тихо решить проблему, а не тыкать ей в лицо.</p>

<p>Вообще, угадывание — худшее, что есть в айти. Когда угадываешь, фактически ты на
дне. Ты исчерпал все нормальные варианты, ну или их не было. Должна быть легкая
возможность запустить код — привет, программисты без репла. Должны быть тесты,
линтеры, логи, метрики, бенчмарки, сбор ошибок и так далее.</p>

<p>Угадайка — это билет в проигрыш, иначе быть не может. Да, бывают истории, когда
человек раз — и решил сложную проблему, не имея никаких улик. Но это ошибка
выжившего: на каждую такую историю приходится тысяча других, когда человек
просидел выходные, решая проблему брутфорсом — и на двадцать пятой итерации
что-то помогло. Я бы не рассчитывал на такую удачу.</p>

<p>Короче, видишь плохой код — исправь, не гадай.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/no-exceptions/">Без исключений</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2025-10-03T00:00:00+00:00">
        Oct 3, 2025
    </time>

    <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/exceptions/" rel="tag">exceptions</a>

</div>


            <div class="entry">
                
                    <p>Меня искренне изумляют ребята, которые обходят исключения стороной. Типа, вернем
<code class="language-plaintext highlighter-rouge">null</code> и запишем в лог. Или вернем мапу <code class="language-plaintext highlighter-rouge">{"success": false}</code>. Или кортеж <code class="language-plaintext highlighter-rouge">(nil,
"error")</code>. Или еще какой-то финт ушами.</p>

<p>Мне интересно: а кто будет читать логи? Тот чел, который молча пишет в лог, у
него что, в договоре прописано каждое утро их читать? С какой частотой? И что
делать, если логи нашлись? Как реагировать? И кто следит, чтобы он их читал?</p>

<p>Или какой-то калека вернул мапу <code class="language-plaintext highlighter-rouge">{"success": false}</code>. Что с ней делать? Какая
была ошибка? В каком направлении двигаться? Просто неопытный разработчик
переложил на других то, что должен делать сам.</p>

<p>Замалчивание ошибок — признак неопытности программиста. В единичном случае это
еще не страшно. Но когда каждая строчка возвращает <code class="language-plaintext highlighter-rouge">null</code> или мапу вместо
ошибки, работать невозможно. Приходиться писать строгие обертки вокруг таких
функций, которые кидают исключение с понятным сообщением: что я собирался делать
и что пошло не так.</p>

<p>Один коллега предложил: давай я буду возвращать сообщение об ошибке, если файла
нет? Я аж чуть кофе не выплюнул: минуточку, все это время ты молчал о том, что
файла нет? Блин, уж будь добр, потрудись сообщить о проблеме.</p>

<p>При либом отклонении от нормы нужно кидать исключение с максимально детальным
текстом. Вот, вобщем-то, простой секрет хорошего кода.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/mac-photos/">Фотографии на Маке</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2025-10-03T00:00:00+00:00">
        Oct 3, 2025
    </time>

    <a href="/tag/life/" rel="tag">life</a>, <a href="/tag/apple/" rel="tag">apple</a>, <a href="/tag/photos/" rel="tag">photos</a>

</div>


            <div class="entry">
                
                    <p>Моя семейная жизнь течет спокойно и счастливо, однако нет-нет да окажется на
грани развода. Всему виной они – фотографии.</p>

<p>Когда у тебя трое детей, часто фотографируешь их по поводу и без, а потом
наступает тот самый момент: дорогой, давай я выберу фотографии для фоторамок в
кухне. Я оттягиваю его как могу, потому что знаю – будут крики и ругань.</p>

<p>Даю жене яблочный ноут. Не проходит и пяти минут, как слышу: почему файл не
открывается по нажатию Enter? Почему, открыв фотографию, нельзя перейти к
соседней стрелочками? Почему сочетания кнопок такие неудобные? Почему нет
бегунка, чтобы превьюшки стали больше?</p>

<p>Ни на один упрек я не знаю ответа. В этом плане я обычная тряпка, яблочный
приспособленец. Я не знаю, почему по нажатию Enter система предлагает
переименовать файл, а не открыть его. Возможно, Стив Джобс был под наркотой,
когда придумал это. Иначе как объяснить, что вместо Enter нужно либо дважды
кликнуть по файлу, либо нажать Command+Down?</p>

<p>Как часто мы открываем файл, а как часто меняем его имя? Что в приоритете?
Ничего, что на клавише написано Enter – по-английски “войти”, а не
“переименовать”? Сколько ЛСД принял Стив в тот вечер?</p>

<p>То же самое с переходом между фотографиями. Когда человек открыл одно фото, он
захочет посмотреть соседнее и нажмет стрелку влево или вправо. Логично же? Эпл
предлагает выделить фотографии в Finder, нажать правую кнопку мыши, открыть в
Preview. После этого можно просматривать несколько фотографий, – но только те,
что выбрал.</p>

<p>Есть быстрый просмотр при помощи пробела, и внезапно в нем работают
стрелочки. Однако их поведение зависит от того, в каком виде показаны
файлы. Если это список, то работают клавиши вверх и вниз, а влево и вправо
бездействуют. Если файлы в режиме значков, перемещение по ним работает во все
стороны. Нажав вниз, вы перейдете к такой же позиции следующего ряда, пропустив
столько фотографий, сколько их в ряду. Это значит, нельзя просмотерть файлы один
за другим, используя одну кнопку. Нужно следить за курсором и нажимать влево,
вправо и вниз – другими словами, обходить файлы змейкой.</p>

<p>Файлы в режиме значков не подстраиваются под ширину окна. Если в ряду их десять
и вы ужали окно, матрица не перестроится. Появится горизонтальный скроллинг, и
часть файлов вы не увидете.</p>

<p>Выбор фотографий превратился в маленький адок, который нужно пережить. Однако и
я стал умнее. Зная, что супруга управляется с Виндой, я теперь делаю
так. Отбираю фотки, которые ее интересуют, и помещаю в какой-то альбом. Это
легко сделать на телефоне: достаточно выделить файлы и пометить тегом.</p>

<p>Далее открываю яблочный ноут, приложение Photos. В нем работает экспорт файлов
на диск. Разумеется, можно достучаться до файлов и обычным способом, но это
нелегко. Фотографии хранятся в чертовом HEIC – яблочном формате, который
совмещает в себе JPEG и HDR. Это добро откроется только на яблочной машине. У
файлов машинные имена-уиды, а вся мета о них лежит во внутренней базе данных.</p>

<p>Я думал, Эпл позволит экспортировать только штучные файлы. Но все оказалось
проще: можно экспортировать целый альбом, и на диске появятся нормальные джипеги
и mp4.</p>

<p>Осталось перетащить их на Винду. Это тоже проблематично, потому что шаринг
файлов между Эплом и Виндой максимально костыльный. Есть вариант с флешкой в
exFAT. Но еще лучше воткнуть флешку в роутер и поднять на нем FTP- или
SMB-сервер. Все просто: на яблоке закинул, на Винде скачал.</p>

<p>И знаете, жить стало намного легче!</p>

<p>Вот так технологии спасают семейную жизнь.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/message-storm/">Чат вслух</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2025-09-28T00:00:00+00:00">
        Sep 28, 2025
    </time>

    <a href="/tag/life/" rel="tag">life</a>

</div>


            <div class="entry">
                
                    <p>Бывает, пишешь коллеге: дружище, я вызываю такой-то сервис, посылаю мапу:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{:foo 42
 :data ["some-type"]
 :items [:kek :lol :crap]}
</code></pre></div></div>

<p>Сервис возвращает не то. Вот логи, вот ссылки, вот трассировочный заголовок. Все
для тебя, мой милый-хороший.</p>

<p>В ответ человек срет сообщениями:</p>

<p>привет :)</p>

<p>надо items передать через точку с запятой :)</p>

<p>вроде так было в последнем коммите</p>

<p>или погоди его не выкатили :)</p>

<p>спроси девопсов выкатили или нет</p>

<p>и еще foo надо не 42 а 41 :)</p>

<p>по ходу да</p>

<p>или не :)</p>

<p>а да</p>

<p>мы так тестировали работало :)</p>

<p>на пре-проде работало помню</p>

<p>и без двоеточий передай</p>

<p>так заработает :)</p>

<p>Я смотрю на это и думаю: ладно, есть люди, которые думают вслух. Им легче писать
и проговаривать про себя, чтобы что-то вспомнить. Бывает. С этим можно
смириться.</p>

<p>Однако в конце этого выхлопа я ожидаю вердикт: какой запрос все-таки
передать. Но этого не происходит: собеседник решил, что уже помог. Приходится
идти по списку сообщений и применять каждое утверждение (“по ходу да”), а
возможно, откатывать (“или не”).</p>

<p>Что тут сказать? Других мы не исправим, а вот себя исправить можно. Не
вываливайте на собеседника поток сознания, а если это имело место, подведите
итог. Достаточно смотаться к первому сообщению и коротко на него ответить.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/yt-music-ui/">Интерфейс музыкальных сервисов</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2025-09-22T00:00:00+00:00">
        Sep 22, 2025
    </time>

    <a href="/tag/ui/" rel="tag">ui</a>, <a href="/tag/youtube/" rel="tag">youtube</a>

</div>


            <div class="entry">
                
                    <p>Не знаю, как так вышло, но сегодня ни один — буквально ни один — музыкальный
сервис не может сделать хороший интерфейс. Ни Гугл, ни Яндекс, ни кто бы то ни
было. Не помогают ни миллионы денег, которые сервисы гребут за подписку, ни
дизайнеры за 400 тыщщ долларов в год.</p>

<p>Яндекс-музыка уже давно стала мемом а-ля Medium: хорошее начинание превратилось
в музей багов. Без преувеличения можно сказать, что каждый квадратный сантиметр
ее дизайна несет бред. Гугл со своей Музыкой не лучше: там все прыгает,
переключается, показывает выпадашки.</p>

<p>Прикладываю картинки. Слушаю музыку из мультика, вроде бы все в порядке. Но
что-то нажал — открылось то же самое, но в другом лейауте. Почему? Без
понятия. Как вернуться обратно? Тоже без понятия.</p>

<p><img src="/assets/static/aws/yt-music-ui/1.jpeg" /></p>

<p><img src="/assets/static/aws/yt-music-ui/2.jpeg" /></p>

<p>Снизу без конца вылазит нотификашка, что контент для детей не доступен в
мини-плеере. Предлагает куда-то тапнуть, чтобы вернуться. О чем речь вообще?</p>

<p><img src="/assets/static/aws/yt-music-ui/3.jpeg" /></p>

<p>И разумеется, сервису не хватает места. Даже на 4к-мониторе дизайнер не может
все уместить. Треки приходят с сервера пачками по 20 штук, нужно проматывать
страницу, чтобы они подгрузились, иначе поиск на странице не работает.</p>

<p>Ради интереса сравните с Винампом: на ЭЛТ-мониторе в разрешении 800x600 он
занимал только часть экрана. Там было все: кнопки, перемотка, плейлист,
эквалайзер. Можно было поставить рядом Total Commander, и места хватало на две
программы.</p>

<p>Умели же люди делать плеер для монитора 800x600! А сегодня это сродни навыку
писать на ассемблере.</p>

<p><img src="/assets/static/aws/yt-music-ui/4.jpeg" /></p>

<p>Секрет-то на самом деле простой. Я бы выдал дизайнерам ЭЛТ-мониторы и сказал:
все должно помещаться на экране. За каждую выпадашку этим монитором тебя будут
бить по голове. И тогда бы все наладилось — я гарантирую это (с).</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/youtube-pause/">Пробел и пауза</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2025-09-22T00:00:00+00:00">
        Sep 22, 2025
    </time>

    <a href="/tag/ui/" rel="tag">ui</a>, <a href="/tag/yandex/" rel="tag">yandex</a>, <a href="/tag/pause/" rel="tag">pause</a>

</div>


            <div class="entry">
                
                    <p>Как-то давно я писал об ошибке в интерфейсе Ютуба. В нем клавиша “пробел”
означает не паузу, а действие по умолчанию для текущего виджета. По умолчанию
текущий виджет – экран, но если кликнуть по кнопке субтитров или громкости,
текущим станет другой виджет, и пробел тоже будет делать что-то другое.</p>

<p>Сценарии я тоже описывал: посадил ребенка смотреть мультик, объяснил, что пробел
– это пауза. Но в последний момент поправил звук, и фокус остался на виджете
громкости. Ребенок жмет пробел – пропадает звук. То же самое с субтитрами:
усадил пожилого родственника, все объяснил и перед уходом отключил субтитры,
чтобы не загораживали экран. Родственник хочет паузу, жмет пробел и в результате
включает субчики.</p>

<p>Ту же самую херню затащил Яндекс в свою Музыку. Играет трек, мне нравится, жму
сердечко. Потом хочу поставить паузу, жму пробел – трек играет, и написано
“удалено из избранного”. Оказалось, сердечко – это отдельный виджет, и теперь
когда фокус на нем, он добавляет и удаляет из избранного. То же самое с другими
кнопками и панелями.</p>

<p>В общем-то, критиковать тут не за что: ребята стащили чужой подход вместе с
багами. В больших компаниях это безопасная стратегия: повторяй за гигантом, и
вопросов к тебе не будет. Касается не только менеджеров, но и разработчиков:
фраза “как в Гугле” всегда спасет твою задницу.</p>

<p>И все-таки: если кто-то из читателей связан с Яндексом, будьте добры, передайте
им, что у пробела должна быть строго одна функция.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/http-request-aws/">Зависимости S3</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2025-09-22T00:00:00+00:00">
        Sep 22, 2025
    </time>

    <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/aws/" rel="tag">aws</a>, <a href="/tag/http/" rel="tag">http</a>

</div>


            <div class="entry">
                
                    <p>Число для справки: сколько зависимостей нужно, чтобы сделать запрос к S3? Вот:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>software/amazon/awssdk/s3/2.33.1/s3-2.33.1.pom
software/amazon/awssdk/services/2.33.1/services-2.33.1.pom
software/amazon/awssdk/aws-sdk-java-pom/2.33.1/aws-sdk-java-pom-2.33.1.pom
software/amazon/awssdk/bom-internal/2.33.1/bom-internal-2.33.1.pom
software/amazon/awssdk/aws-xml-protocol/2.33.1/aws-xml-protocol-2.33.1.pom
software/amazon/awssdk/http-auth/2.33.1/http-auth-2.33.1.pom
software/amazon/awssdk/http-auth-aws/2.33.1/http-auth-aws-2.33.1.pom
software/amazon/awssdk/profiles/2.33.1/profiles-2.33.1.pom
software/amazon/awssdk/protocol-core/2.33.1/protocol-core-2.33.1.pom
software/amazon/awssdk/arns/2.33.1/arns-2.33.1.pom
software/amazon/awssdk/retries-spi/2.33.1/retries-spi-2.33.1.pom
software/amazon/awssdk/checksums/2.33.1/checksums-2.33.1.pom
software/amazon/awssdk/checksums-spi/2.33.1/checksums-spi-2.33.1.pom
software/amazon/awssdk/identity-spi/2.33.1/identity-spi-2.33.1.pom
software/amazon/awssdk/http-auth-spi/2.33.1/http-auth-spi-2.33.1.pom
software/amazon/awssdk/crt-core/2.33.1/crt-core-2.33.1.pom
software/amazon/awssdk/protocols/2.33.1/protocols-2.33.1.pom
software/amazon/awssdk/core/2.33.1/core-2.33.1.pom
software/amazon/awssdk/regions/2.33.1/regions-2.33.1.pom
software/amazon/awssdk/netty-nio-client/2.33.1/netty-nio-client-2.33.1.pom
software/amazon/awssdk/annotations/2.33.1/annotations-2.33.1.pom
software/amazon/awssdk/apache-client/2.33.1/apache-client-2.33.1.pom
software/amazon/awssdk/endpoints-spi/2.33.1/endpoints-spi-2.33.1.pom
software/amazon/awssdk/json-utils/2.33.1/json-utils-2.33.1.pom
software/amazon/awssdk/utils/2.33.1/utils-2.33.1.pom
software/amazon/awssdk/aws-core/2.33.1/aws-core-2.33.1.pom
software/amazon/awssdk/auth/2.33.1/auth-2.33.1.pom
software/amazon/awssdk/metrics-spi/2.33.1/metrics-spi-2.33.1.pom
software/amazon/awssdk/http-client-spi/2.33.1/http-client-spi-2.33.1.pom
software/amazon/awssdk/sdk-core/2.33.1/sdk-core-2.33.1.pom
software/amazon/awssdk/http-clients/2.33.1/http-clients-2.33.1.pom
io/netty/netty-codec/4.1.124.Final/netty-codec-4.1.124.Final.pom
io/netty/netty-transport/4.1.124.Final/netty-transport-4.1.124.Final.pom
io/netty/netty-codec-http/4.1.124.Final/netty-codec-http-4.1.124.Final.pom
io/netty/netty-codec-http2/4.1.124.Final/netty-codec-http2-4.1.124.Final.pom
io/netty/netty-buffer/4.1.124.Final/netty-buffer-4.1.124.Final.pom
io/netty/netty-handler/4.1.124.Final/netty-handler-4.1.124.Final.pom
io/netty/netty-common/4.1.124.Final/netty-common-4.1.124.Final.pom
io/netty/netty-parent/4.1.124.Final/netty-parent-4.1.124.Final.pom
software/amazon/awssdk/aws-query-protocol/2.33.1/aws-query-protocol-2.33.1.pom
io/netty/netty-resolver/4.1.124.Final/netty-resolver-4.1.124.Final.pom
io/netty/netty-transport-classes-epoll/4.1.124.Final/netty-transport-classes-epoll-4.1.124.Final.pom
software/amazon/awssdk/third-party-jackson-core/2.33.1/third-party-jackson-core-2.33.1.pom
software/amazon/awssdk/http-auth-aws-eventstream/2.33.1/http-auth-aws-eventstream-2.33.1.pom
software/amazon/awssdk/retries/2.33.1/retries-2.33.1.pom
software/amazon/awssdk/third-party/2.33.1/third-party-2.33.1.pom
io/netty/netty-transport-native-unix-common/4.1.124.Final/netty-transport-native-unix-common-4.1.124.Final.pom
io/netty/netty-codec/4.1.124.Final/netty-codec-4.1.124.Final.jar
io/netty/netty-common/4.1.124.Final/netty-common-4.1.124.Final.jar
io/netty/netty-transport-classes-epoll/4.1.124.Final/netty-transport-classes-epoll-4.1.124.Final.jar
io/netty/netty-codec-http2/4.1.124.Final/netty-codec-http2-4.1.124.Final.jar
io/netty/netty-buffer/4.1.124.Final/netty-buffer-4.1.124.Final.jar
io/netty/netty-handler/4.1.124.Final/netty-handler-4.1.124.Final.jar
software/amazon/awssdk/checksums-spi/2.33.1/checksums-spi-2.33.1.jar
software/amazon/awssdk/profiles/2.33.1/profiles-2.33.1.jar
software/amazon/awssdk/aws-xml-protocol/2.33.1/aws-xml-protocol-2.33.1.jar
software/amazon/awssdk/aws-query-protocol/2.33.1/aws-query-protocol-2.33.1.jar
software/amazon/awssdk/third-party-jackson-core/2.33.1/third-party-jackson-core-2.33.1.jar
software/amazon/awssdk/http-auth/2.33.1/http-auth-2.33.1.jar
software/amazon/awssdk/apache-client/2.33.1/apache-client-2.33.1.jar
software/amazon/awssdk/retries-spi/2.33.1/retries-spi-2.33.1.jar
io/netty/netty-transport/4.1.124.Final/netty-transport-4.1.124.Final.jar
software/amazon/awssdk/endpoints-spi/2.33.1/endpoints-spi-2.33.1.jar
io/netty/netty-transport-native-unix-common/4.1.124.Final/netty-transport-native-unix-common-4.1.124.Final.jar
software/amazon/awssdk/crt-core/2.33.1/crt-core-2.33.1.jar
io/netty/netty-codec-http/4.1.124.Final/netty-codec-http-4.1.124.Final.jar
software/amazon/awssdk/http-auth-aws-eventstream/2.33.1/http-auth-aws-eventstream-2.33.1.jar
software/amazon/awssdk/auth/2.33.1/auth-2.33.1.jar
software/amazon/awssdk/http-client-spi/2.33.1/http-client-spi-2.33.1.jar
io/netty/netty-resolver/4.1.124.Final/netty-resolver-4.1.124.Final.jar
software/amazon/awssdk/metrics-spi/2.33.1/metrics-spi-2.33.1.jar
software/amazon/awssdk/arns/2.33.1/arns-2.33.1.jar
software/amazon/awssdk/json-utils/2.33.1/json-utils-2.33.1.jar
software/amazon/awssdk/identity-spi/2.33.1/identity-spi-2.33.1.jar
software/amazon/awssdk/regions/2.33.1/regions-2.33.1.jar
software/amazon/awssdk/aws-core/2.33.1/aws-core-2.33.1.jar
software/amazon/awssdk/sdk-core/2.33.1/sdk-core-2.33.1.jar
software/amazon/awssdk/protocol-core/2.33.1/protocol-core-2.33.1.jar
software/amazon/awssdk/checksums/2.33.1/checksums-2.33.1.jar
software/amazon/awssdk/http-auth-aws/2.33.1/http-auth-aws-2.33.1.jar
software/amazon/awssdk/retries/2.33.1/retries-2.33.1.jar
software/amazon/awssdk/http-auth-spi/2.33.1/http-auth-spi-2.33.1.jar
software/amazon/awssdk/netty-nio-client/2.33.1/netty-nio-client-2.33.1.jar
software/amazon/awssdk/annotations/2.33.1/annotations-2.33.1.jar
software/amazon/awssdk/s3/2.33.1/s3-2.33.1.jar
software/amazon/awssdk/utils/2.33.1/utils-2.33.1.jar
</code></pre></div></div>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/clj-pg-bin/">New library: PG.bin</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2025-09-15T00:00:00+00:00">
        Sep 15, 2025
    </time>

    <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/clojure/" rel="tag">clojure</a>, <a href="/tag/postgres/" rel="tag">postgres</a>, <a href="/tag/binary/" rel="tag">binary</a>, <a href="/tag/copy/" rel="tag">copy</a>

</div>


            <div class="entry">
                
                    
<p><a href="https://github.com/igrishaev/pg-bin">PG.bin is a library</a> to parse Postgres COPY dumps made in binary format.</p>

<p>Postgres has a great API to transfer data into and out from a database called
COPY. What is special about it is that it supports three different formats: CSV,
text and binary. Both CSV and text are trivial: values are passed using their
text representation. Only quoting rules and separating characters differ.</p>

<p>Binary format is special in that direction that values are not text. They’re
passed exactly how they’re stored in Postgres. Thus, binary format is more
compact: it’s 30% less in size than CSV or text. The same applies to
performance: COPY-ing a binary data back and forth takes about 15-25% less time.</p>

<p>To parse a binary dump, one must know its structure. This is what the library
does: it knows how to parse such dumps. It supports most of the built-in
Postgres types including JSON(b). The API is simple an extensible.</p>

<h2 id="installation">Installation</h2>

<p>Add this to your project:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">;; lein</span><span class="w">
</span><span class="p">[</span><span class="n">com.github.igrishaev/pg-bin</span><span class="w"> </span><span class="s">"0.1.0"</span><span class="p">]</span><span class="w">

</span><span class="c1">;; deps</span><span class="w">
</span><span class="n">com.github.igrishaev/pg-bin</span><span class="w"> </span><span class="p">{</span><span class="no">:mvn/version</span><span class="w"> </span><span class="s">"0.1.0"</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h2 id="usage">Usage</h2>

<p>Let’s prepare a binary dump as follows:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">create</span> <span class="k">temp</span> <span class="k">table</span> <span class="n">test</span><span class="p">(</span>
    <span class="n">f_01</span> <span class="n">int2</span><span class="p">,</span>
    <span class="n">f_02</span> <span class="n">int4</span><span class="p">,</span>
    <span class="n">f_03</span> <span class="n">int8</span><span class="p">,</span>
    <span class="n">f_04</span> <span class="nb">boolean</span><span class="p">,</span>
    <span class="n">f_05</span> <span class="n">float4</span><span class="p">,</span>
    <span class="n">f_06</span> <span class="n">float8</span><span class="p">,</span>
    <span class="n">f_07</span> <span class="nb">text</span><span class="p">,</span>
    <span class="n">f_08</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">12</span><span class="p">),</span>
    <span class="n">f_09</span> <span class="nb">time</span><span class="p">,</span>
    <span class="n">f_10</span> <span class="n">timetz</span><span class="p">,</span>
    <span class="n">f_11</span> <span class="nb">date</span><span class="p">,</span>
    <span class="n">f_12</span> <span class="nb">timestamp</span><span class="p">,</span>
    <span class="n">f_13</span> <span class="n">timestamptz</span><span class="p">,</span>
    <span class="n">f_14</span> <span class="n">bytea</span><span class="p">,</span>
    <span class="n">f_15</span> <span class="n">json</span><span class="p">,</span>
    <span class="n">f_16</span> <span class="n">jsonb</span><span class="p">,</span>
    <span class="n">f_17</span> <span class="n">uuid</span><span class="p">,</span>
    <span class="n">f_18</span> <span class="nb">numeric</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span>
    <span class="n">f_19</span> <span class="nb">text</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">f_20</span> <span class="nb">decimal</span>
<span class="p">);</span>

<span class="k">insert</span> <span class="k">into</span> <span class="n">test</span> <span class="k">values</span> <span class="p">(</span>
    <span class="mi">1</span><span class="p">,</span>
    <span class="mi">2</span><span class="p">,</span>
    <span class="mi">3</span><span class="p">,</span>
    <span class="k">true</span><span class="p">,</span>
    <span class="mi">123</span><span class="p">.</span><span class="mi">456</span><span class="p">,</span>
    <span class="mi">654</span><span class="p">.</span><span class="mi">321</span><span class="p">,</span>
    <span class="s1">'hello'</span><span class="p">,</span>
    <span class="s1">'world'</span><span class="p">,</span>
    <span class="s1">'10:42:35'</span><span class="p">,</span>
    <span class="s1">'10:42:35+0030'</span><span class="p">,</span>
    <span class="s1">'2025-11-30'</span><span class="p">,</span>
    <span class="s1">'2025-11-30 10:42:35'</span><span class="p">,</span>
    <span class="s1">'2025-11-30 10:42:35.123567+0030'</span><span class="p">,</span>
    <span class="s1">'</span><span class="se">\x</span><span class="s1">DEADBEEF'</span><span class="p">,</span>
    <span class="s1">'{"foo": [1, 2, 3, {"kek": [true, false, null]}]}'</span><span class="p">,</span>
    <span class="s1">'{"foo": [1, 2, 3, {"kek": [true, false, null]}]}'</span><span class="p">,</span>
    <span class="s1">'4bda6037-1c37-4051-9898-13b82f1bd712'</span><span class="p">,</span>
    <span class="s1">'123456.123456'</span><span class="p">,</span>
    <span class="k">null</span><span class="p">,</span>
    <span class="s1">'123999.999100500'</span>
<span class="p">);</span>

<span class="err">\</span><span class="k">copy</span> <span class="n">test</span> <span class="k">to</span> <span class="s1">'/Users/ivan/dump.bin'</span> <span class="k">with</span> <span class="p">(</span><span class="n">format</span> <span class="nb">binary</span><span class="p">);</span>
</code></pre></div></div>

<p>Let’s peek what’s inside:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>xxd -d /Users/ivan/dump.bin

00000000: 5047 434f 5059 0aff 0d0a 0000 0000 0000  PGCOPY..........
00000016: 0000 0000 1400 0000 0200 0100 0000 0400  ................
00000032: 0000 0200 0000 0800 0000 0000 0000 0300  ................
00000048: 0000 0101 0000 0004 42f6 e979 0000 0008  ........B..y....
00000064: 4084 7291 6872 b021 0000 0005 6865 6c6c  @.r.hr.!....hell
00000080: 6f00 0000 0577 6f72 6c64 0000 0008 0000  o....world......
00000096: 0008 fa0e 9cc0 0000 000c 0000 0008 fa0e  ................
00000112: 9cc0 ffff f8f8 0000 0004 0000 24f9 0000  ............$...
00000128: 0008 0002 e7cc 4a0a fcc0 0000 0008 0002  ......J.........
00000144: e7cb dec3 0d6f 0000 0004 dead beef 0000  .....o..........
00000160: 0030 7b22 666f 6f22 3a20 5b31 2c20 322c  .0{"foo": [1, 2,
00000176: 2033 2c20 7b22 6b65 6b22 3a20 5b74 7275   3, {"kek": [tru
00000192: 652c 2066 616c 7365 2c20 6e75 6c6c 5d7d  e, false, null]}
00000208: 5d7d 0000 0031 017b 2266 6f6f 223a 205b  ]}...1.{"foo": [
00000224: 312c 2032 2c20 332c 207b 226b 656b 223a  1, 2, 3, {"kek":
00000240: 205b 7472 7565 2c20 6661 6c73 652c 206e   [true, false, n
00000256: 756c 6c5d 7d5d 7d00 0000 104b da60 371c  ull]}]}....K.`7.
00000272: 3740 5198 9813 b82f 1bd7 1200 0000 0e00  7@Q..../........
00000288: 0300 0100 0000 0300 0c0d 8004 ceff ffff  ................
00000304: ff00 0000 1000 0400 0100 0000 0900 0c0f  ................
00000320: 9f27 0700 32ff ff                        .'..2..
</code></pre></div></div>

<p>Now the library comes into play:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">ns</span><span class="w"> </span><span class="n">some.ns</span><span class="w">
  </span><span class="p">(</span><span class="no">:require</span><span class="w">
   </span><span class="p">[</span><span class="n">clojure.java.io</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">io</span><span class="p">]</span><span class="w">
   </span><span class="p">[</span><span class="n">pg-bin.core</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">copy</span><span class="p">]</span><span class="w">
   </span><span class="n">taggie.core</span><span class="p">))</span><span class="w">

</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">FIELDS</span><span class="w">
  </span><span class="p">[</span><span class="no">:int2</span><span class="w">
   </span><span class="no">:int4</span><span class="w">
   </span><span class="no">:int8</span><span class="w">
   </span><span class="no">:boolean</span><span class="w">
   </span><span class="no">:float4</span><span class="w">
   </span><span class="no">:float8</span><span class="w">
   </span><span class="no">:text</span><span class="w">
   </span><span class="no">:varchar</span><span class="w">
   </span><span class="no">:time</span><span class="w">
   </span><span class="no">:timetz</span><span class="w">
   </span><span class="no">:date</span><span class="w">
   </span><span class="no">:timestamp</span><span class="w">
   </span><span class="no">:timestamptz</span><span class="w">
   </span><span class="no">:bytea</span><span class="w">
   </span><span class="no">:json</span><span class="w">
   </span><span class="no">:jsonb</span><span class="w">
   </span><span class="no">:uuid</span><span class="w">
   </span><span class="no">:numeric</span><span class="w">
   </span><span class="no">:text</span><span class="w">
   </span><span class="no">:decimal</span><span class="p">])</span><span class="w">

</span><span class="p">(</span><span class="nf">copy/parse</span><span class="w"> </span><span class="s">"/Users/ivan/dump.bin"</span><span class="w"> </span><span class="n">FIELDS</span><span class="p">)</span><span class="w">

</span><span class="p">[[</span><span class="mi">1</span><span class="w">
  </span><span class="mi">2</span><span class="w">
  </span><span class="mi">3</span><span class="w">
  </span><span class="n">true</span><span class="w">
  </span><span class="p">(</span><span class="nb">float</span><span class="w"> </span><span class="mf">123.456</span><span class="p">)</span><span class="w">
  </span><span class="mf">654.321</span><span class="w">
  </span><span class="s">"hello"</span><span class="w">
  </span><span class="s">"world"</span><span class="w">
  </span><span class="o">#</span><span class="n">LocalTime</span><span class="w"> </span><span class="s">"10:42:35"</span><span class="w">
  </span><span class="o">#</span><span class="n">OffsetTime</span><span class="w"> </span><span class="s">"10:42:35+00:30"</span><span class="w">
  </span><span class="o">#</span><span class="n">LocalDate</span><span class="w"> </span><span class="s">"2025-11-30"</span><span class="w">
  </span><span class="o">#</span><span class="n">LocalDateTime</span><span class="w"> </span><span class="s">"2025-11-30T10:42:35"</span><span class="w">
  </span><span class="o">#</span><span class="n">OffsetDateTime</span><span class="w"> </span><span class="s">"2025-11-30T10:12:35.123567Z"</span><span class="w">
  </span><span class="p">(</span><span class="nf">=bytes</span><span class="w"> </span><span class="p">[</span><span class="mi">-34</span><span class="n">,</span><span class="w"> </span><span class="mi">-83</span><span class="n">,</span><span class="w"> </span><span class="mi">-66</span><span class="n">,</span><span class="w"> </span><span class="mi">-17</span><span class="p">])</span><span class="w">
  </span><span class="s">"{\"foo\": [1, 2, 3, {\"kek\": [true, false, null]}]}"</span><span class="w">
  </span><span class="s">"{\"foo\": [1, 2, 3, {\"kek\": [true, false, null]}]}"</span><span class="w">
  </span><span class="o">#</span><span class="n">uuid</span><span class="w"> </span><span class="s">"4bda6037-1c37-4051-9898-13b82f1bd712"</span><span class="w">
  </span><span class="mf">123456.123</span><span class="n">M</span><span class="w">
  </span><span class="n">nil</span><span class="w">
  </span><span class="mf">123999.999100500</span><span class="n">M</span><span class="p">]]</span><span class="w">
</span></code></pre></div></div>

<p>Here and below: I use <a href="https://github.com/igrishaev/taggie">Taggie</a> to render complex values like date &amp;
time, byte arrays and so on. Really useful!</p>

<p>This is what is going on here: we parse a source pointing to a dump using the
<code class="language-plaintext highlighter-rouge">parse</code> function. A source might be a file, a byte array, an input stream and so
on – anything that can be coerced to an input stream using the
<code class="language-plaintext highlighter-rouge">clojure.java.io/input-stream</code> function.</p>

<p>Binary files produced by Postgres don’t know their structure. Unfortunately,
there is no information about types, only data. One should help the library
traverse a binary dump by specifying a vector of types. The <code class="language-plaintext highlighter-rouge">FIELDS</code> variable
declares the structure of the file. See below what types are supported.</p>

<h2 id="api">API</h2>

<p>There are two functions to parse, namely:</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">pg-bin.core/parse</code> accepts any source and returns a vector of parsed
lines. This function is eager meaning it consumes the whole source and
accumulates lines in a vector.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">pg-bin.core/parse-seq</code> accepts an <code class="language-plaintext highlighter-rouge">InputStream</code> and returns a lazy sequence
of parsed lines. It must be called under the <code class="language-plaintext highlighter-rouge">with-open</code> macro as follows:</p>
  </li>
</ul>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nb">with-open</span><span class="w"> </span><span class="p">[</span><span class="n">in</span><span class="w"> </span><span class="p">(</span><span class="nf">io/input-stream</span><span class="w"> </span><span class="s">"/Users/ivan/dump.bin"</span><span class="p">)]</span><span class="w">
  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">lines</span><span class="w"> </span><span class="p">(</span><span class="nf">copy/parse-seq</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">FIELDS</span><span class="p">)]</span><span class="w">
    </span><span class="p">(</span><span class="nb">doseq</span><span class="w"> </span><span class="p">[</span><span class="n">line</span><span class="w"> </span><span class="n">lines</span><span class="p">]</span><span class="w">
      </span><span class="n">...</span><span class="p">)))</span><span class="w">
</span></code></pre></div></div>

<p>Both functions accept a list of fields as the second argument.</p>

<h2 id="skipping-fields">Skipping fields</h2>

<p>When parsing, it’s likely that you don’t need all fields to be parsed. You may
keep only the leading ones:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">copy/parse</span><span class="w"> </span><span class="n">DUMP_PATH</span><span class="w"> </span><span class="p">[</span><span class="no">:int2</span><span class="w"> </span><span class="no">:int4</span><span class="w"> </span><span class="no">:int8</span><span class="p">])</span><span class="w">
</span><span class="p">[[</span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="p">]]</span><span class="w">
</span></code></pre></div></div>

<p>To skip fields located in the middle, use either <code class="language-plaintext highlighter-rouge">:skip</code> or an underscore:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">copy/parse</span><span class="w"> </span><span class="n">DUMP_PATH</span><span class="w"> </span><span class="p">[</span><span class="no">:int2</span><span class="w"> </span><span class="no">:skip</span><span class="w"> </span><span class="no">:_</span><span class="w"> </span><span class="no">:boolean</span><span class="p">])</span><span class="w">
</span><span class="p">[[</span><span class="mi">1</span><span class="w"> </span><span class="n">true</span><span class="p">]]</span><span class="w">
</span></code></pre></div></div>

<h2 id="raw-fields">Raw fields</h2>

<p>If, for any reason, you have a type in your dump that the library is not aware
about, or you’d like to examine its binary representation, specify <code class="language-plaintext highlighter-rouge">:raw</code> or
<code class="language-plaintext highlighter-rouge">:bytes</code>. Each value will be a byte array then. It’s up to you how to deal with
those bytes:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">copy/parse</span><span class="w"> </span><span class="n">DUMP_PATH</span><span class="w"> </span><span class="p">[</span><span class="no">:raw</span><span class="w"> </span><span class="no">:raw</span><span class="w"> </span><span class="no">:bytes</span><span class="p">])</span><span class="w">
</span><span class="p">[[</span><span class="o">#</span><span class="n">bytes</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="n">,</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w">
  </span><span class="o">#</span><span class="n">bytes</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="n">,</span><span class="w"> </span><span class="mi">0</span><span class="n">,</span><span class="w"> </span><span class="mi">0</span><span class="n">,</span><span class="w"> </span><span class="mi">2</span><span class="p">]</span><span class="w">
  </span><span class="o">#</span><span class="n">bytes</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="n">,</span><span class="w"> </span><span class="mi">0</span><span class="n">,</span><span class="w"> </span><span class="mi">0</span><span class="n">,</span><span class="w"> </span><span class="mi">0</span><span class="n">,</span><span class="w"> </span><span class="mi">0</span><span class="n">,</span><span class="w"> </span><span class="mi">0</span><span class="n">,</span><span class="w"> </span><span class="mi">0</span><span class="n">,</span><span class="w"> </span><span class="mi">3</span><span class="p">]]]</span><span class="w">
</span></code></pre></div></div>

<h2 id="handling-json">Handling JSON</h2>

<p>Postgres is well-known for its vast JSON capabilities, and sometimes tables that
we dump have json(b) columns. Above, you saw that by default, they’re parsed as
plain strings. This is because there is no a built-in JSON parser in Java and I
don’t want to tie this library to a certain JSON implementation.</p>

<p>But the library provides a number of macros to extend undelrying
multi-methods. With a line of code, you can enable parsing json(b) types with
Chesire, Jsonista, Clojure.data.json, Charred, and JSam. This is how to do it:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">ns</span><span class="w"> </span><span class="n">some.ns</span><span class="w">
  </span><span class="p">(</span><span class="no">:require</span><span class="w">
   </span><span class="p">[</span><span class="n">pg-bin.core</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">copy</span><span class="p">]</span><span class="w">
   </span><span class="p">[</span><span class="n">pg-bin.json</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">json</span><span class="p">]))</span><span class="w">

</span><span class="p">(</span><span class="nf">json/set-cheshire</span><span class="w"> </span><span class="nb">keyword</span><span class="p">)</span><span class="w"> </span><span class="c1">;; overrides multimethods</span><span class="w">

</span><span class="p">(</span><span class="nf">copy/parse</span><span class="w"> </span><span class="n">DUMP_PATH</span><span class="w"> </span><span class="n">FIELDS</span><span class="p">)</span><span class="w">

</span><span class="p">[[</span><span class="n">...</span><span class="w">
  </span><span class="p">{</span><span class="no">:foo</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="p">{</span><span class="no">:kek</span><span class="w"> </span><span class="p">[</span><span class="n">true</span><span class="w"> </span><span class="n">false</span><span class="w"> </span><span class="n">nil</span><span class="p">]}]}</span><span class="w">
  </span><span class="p">{</span><span class="no">:foo</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="p">{</span><span class="no">:kek</span><span class="w"> </span><span class="p">[</span><span class="n">true</span><span class="w"> </span><span class="n">false</span><span class="w"> </span><span class="n">nil</span><span class="p">]}]}</span><span class="w">
  </span><span class="n">...</span><span class="p">]]</span><span class="w">
</span></code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">set-cheshire</code> macro extends multimethods assuming you have Cheshire
installed. Now the <code class="language-plaintext highlighter-rouge">parse</code> function, when facing json(b) types, will decode them
properly.</p>

<p>The <code class="language-plaintext highlighter-rouge">pg-bin.json</code> namespace provides the following macros:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">set-string</code>: parse json(b) types as strings again;</li>
  <li><code class="language-plaintext highlighter-rouge">set-cheshire</code>: parse using Cheshire;</li>
  <li><code class="language-plaintext highlighter-rouge">set-data-json</code>: parse using clojure.data.json;</li>
  <li><code class="language-plaintext highlighter-rouge">set-jsonista</code>: parse using Jsonista;</li>
  <li><code class="language-plaintext highlighter-rouge">set-charred</code>: parse using Charred;</li>
  <li><code class="language-plaintext highlighter-rouge">set-jsam</code>: parse using JSam.</li>
</ul>

<p>All of them accept optional parameters that are passed into the underlying
parsing function.</p>

<p>PG.Bin doesn’t introduce any JSON-related dependencies. Each macro assumes you
have added a required library into the classpath.</p>

<h2 id="metadata">Metadata</h2>

<p>Each parsed line tracks its length in bytes, offset from the beginning of a file
(or a stream) and a unique index:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nb">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="nf">copy/parse</span><span class="w"> </span><span class="n">DUMP_PATH</span><span class="w"> </span><span class="n">FIELDS</span><span class="p">)</span><span class="w">
    </span><span class="nb">first</span><span class="w">
    </span><span class="nb">meta</span><span class="p">)</span><span class="w">

</span><span class="o">#</span><span class="no">:pg</span><span class="p">{</span><span class="no">:length</span><span class="w"> </span><span class="mi">306</span><span class="n">,</span><span class="w"> </span><span class="no">:index</span><span class="w"> </span><span class="mi">0</span><span class="n">,</span><span class="w"> </span><span class="no">:offset</span><span class="w"> </span><span class="mi">19</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Knowing these values might help reading a dump by chunks.</p>

<h2 id="supported-types">Supported types</h2>

<ul>
  <li><code class="language-plaintext highlighter-rouge">:raw :bytea :bytes</code> for raw access and <code class="language-plaintext highlighter-rouge">bytea</code></li>
  <li><code class="language-plaintext highlighter-rouge">:skip :_ nil</code> to skip a certain field</li>
  <li><code class="language-plaintext highlighter-rouge">:uuid</code> to parse UUIDs</li>
  <li><code class="language-plaintext highlighter-rouge">:int2 :short :smallint :smallserial</code> 2-byte integer (short)</li>
  <li><code class="language-plaintext highlighter-rouge">:int4 :int :integer :oid :serial</code> 4-byte integer (integer)</li>
  <li><code class="language-plaintext highlighter-rouge">:int8 :bigint :long :bigserial</code> 8-byte integer (long)</li>
  <li><code class="language-plaintext highlighter-rouge">:numeric :decimal</code> numeric type (becomes <code class="language-plaintext highlighter-rouge">BigDecimal</code>)</li>
  <li><code class="language-plaintext highlighter-rouge">:float4 :float :real</code> 4-byte float (float)</li>
  <li><code class="language-plaintext highlighter-rouge">:float8 :double :double-precision</code> 8-byte float (double)</li>
  <li><code class="language-plaintext highlighter-rouge">:boolean :bool</code> boolean</li>
  <li><code class="language-plaintext highlighter-rouge">:text :varchar :enum :name :string</code> text values</li>
  <li><code class="language-plaintext highlighter-rouge">:date</code> becomes <code class="language-plaintext highlighter-rouge">java.time.LocalDate</code></li>
  <li><code class="language-plaintext highlighter-rouge">:time :time-without-time-zone</code> becomes <code class="language-plaintext highlighter-rouge">java.time.LocalTime</code></li>
  <li><code class="language-plaintext highlighter-rouge">:timetz :time-with-time-zone</code> becomes <code class="language-plaintext highlighter-rouge">java.time.OffsetTime</code></li>
  <li><code class="language-plaintext highlighter-rouge">:timestamp :timestamp-without-time-zone</code> becomes <code class="language-plaintext highlighter-rouge">java.time.LocalDateTime</code></li>
  <li><code class="language-plaintext highlighter-rouge">:timestamptz :timestamp-with-time-zone</code> becomes <code class="language-plaintext highlighter-rouge">java.time.OffsetDateTime</code></li>
</ul>

<p>Ping me for more types, if needed.</p>

<h2 id="on-writing">On Writing</h2>

<p>At the moment, the library only parses binary dumps. Writing them is possible
yet requires extra work. Ping me if you really need writing binary files.</p>

<h2 id="scenarios">Scenarios</h2>

<p>Why using this library ever? Imagine you have to fetch a mas-s-s-ive chunk of
rows from a database, say 2-3 million to build a report. That might be an issue:
you don’t want to saturate memory, neither you want to paginate using
LIMIT/OFFSET as it’s slow. A simple solution would be to dump the data you need
into a file and process it. You won’t keep the database constantly busy as
you’re working with a dump! Here is a small demo:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">ns</span><span class="w"> </span><span class="n">some.ns</span><span class="w">
  </span><span class="p">(</span><span class="no">:require</span><span class="w">
   </span><span class="p">[</span><span class="n">pg-bin.core</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">copy</span><span class="p">]</span><span class="w">
   </span><span class="p">[</span><span class="n">pg-bin.json</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">json</span><span class="p">]))</span><span class="w">

</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">make-copy-manager</span><span class="w">
  </span><span class="s">"
  Build an instance of CopyManager from a connection.
  "</span><span class="w">
  </span><span class="o">^</span><span class="n">CopyManager</span><span class="w"> </span><span class="p">[</span><span class="o">^</span><span class="n">Connection</span><span class="w"> </span><span class="n">conn</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nb">new</span><span class="w"> </span><span class="n">CopyManager</span><span class="w"> </span><span class="p">(</span><span class="nf">.unwrap</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="n">BaseConnection</span><span class="p">)))</span><span class="w">

</span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">conn</span><span class="w"> </span><span class="p">(</span><span class="nf">jdbc/get-connection</span><span class="w"> </span><span class="n">data-source</span><span class="p">)</span><span class="w">
      </span><span class="n">mgr</span><span class="w"> </span><span class="p">(</span><span class="nf">make-copy-manager</span><span class="w"> </span><span class="n">conn</span><span class="p">)</span><span class="w">
      </span><span class="n">sql</span><span class="w"> </span><span class="s">"copy table_name(col1, col2...) to stdout with (format binary)"</span><span class="w">
      </span><span class="c1">;; you can use a query without parameters as well</span><span class="w">
      </span><span class="n">sql</span><span class="w"> </span><span class="s">"copy (select... from... where...) to stdout with (format binary)"</span><span class="w">
      </span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nb">with-open</span><span class="w"> </span><span class="p">[</span><span class="n">out</span><span class="w"> </span><span class="p">(</span><span class="nf">io/output-stream</span><span class="w"> </span><span class="s">"/path/to/dump.bin"</span><span class="p">)]</span><span class="w">
    </span><span class="p">(</span><span class="nf">.copyOut</span><span class="w"> </span><span class="n">mgr</span><span class="w"> </span><span class="n">sql</span><span class="w"> </span><span class="n">out</span><span class="p">)))</span><span class="w">

</span><span class="p">(</span><span class="nb">with-open</span><span class="w"> </span><span class="p">[</span><span class="n">in</span><span class="w"> </span><span class="p">(</span><span class="nf">io/input-stream</span><span class="w"> </span><span class="s">"/path/to/dump.bin"</span><span class="p">)]</span><span class="w">
  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">lines</span><span class="w"> </span><span class="p">(</span><span class="nf">copy/parse-seq</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="p">[</span><span class="no">:int2</span><span class="w"> </span><span class="no">:text</span><span class="w"> </span><span class="n">...</span><span class="p">])]</span><span class="w">
    </span><span class="p">(</span><span class="nb">doseq</span><span class="w"> </span><span class="p">[</span><span class="n">line</span><span class="w"> </span><span class="n">lines</span><span class="p">]</span><span class="w">
      </span><span class="n">...</span><span class="p">)))</span><span class="w">
</span></code></pre></div></div>

<p>Above, we dump the data into a file and then process it. There is a way to
process lines on the fly using another thread. The second demo:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">conn</span><span class="w">
      </span><span class="p">(</span><span class="nf">jdbc/get-connection</span><span class="w"> </span><span class="n">data-source</span><span class="p">)</span><span class="w">

      </span><span class="n">mgr</span><span class="w">
      </span><span class="p">(</span><span class="nf">make-copy-manager</span><span class="w"> </span><span class="n">conn</span><span class="p">)</span><span class="w">

      </span><span class="n">sql</span><span class="w">
      </span><span class="s">"copy table_name(col1, col2...) to stdout with (format binary)"</span><span class="w">

      </span><span class="n">in</span><span class="w">
      </span><span class="p">(</span><span class="nb">new</span><span class="w"> </span><span class="n">PipedInputStream</span><span class="p">)</span><span class="w">

      </span><span class="n">started?</span><span class="w"> </span><span class="p">(</span><span class="nf">promise</span><span class="p">)</span><span class="w">

      </span><span class="n">fut</span><span class="w"> </span><span class="c1">;; a future to process the output</span><span class="w">
      </span><span class="p">(</span><span class="nf">future</span><span class="w">
        </span><span class="p">(</span><span class="nb">with-open</span><span class="w"> </span><span class="p">[</span><span class="n">_</span><span class="w"> </span><span class="n">in</span><span class="p">]</span><span class="w"> </span><span class="c1">;; must close it afterward</span><span class="w">
          </span><span class="p">(</span><span class="nf">deliver</span><span class="w"> </span><span class="n">started?</span><span class="w"> </span><span class="n">true</span><span class="p">)</span><span class="w"> </span><span class="c1">;; must report we have started</span><span class="w">
          </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">lines</span><span class="w"> </span><span class="p">(</span><span class="nf">copy/parse-seq</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="p">[</span><span class="no">:int2</span><span class="w"> </span><span class="no">:text</span><span class="w"> </span><span class="n">...</span><span class="p">])]</span><span class="w">
            </span><span class="p">(</span><span class="nb">doseq</span><span class="w"> </span><span class="p">[</span><span class="n">line</span><span class="w"> </span><span class="n">lines</span><span class="p">]</span><span class="w"> </span><span class="c1">;; process on the fly</span><span class="w">
              </span><span class="c1">;; without touching the disk</span><span class="w">
              </span><span class="n">...</span><span class="p">))))]</span><span class="w">

  </span><span class="c1">;; ensure the future has started</span><span class="w">
  </span><span class="o">@</span><span class="n">started?</span><span class="w">

  </span><span class="c1">;; drain down to the piped output stream</span><span class="w">
  </span><span class="p">(</span><span class="nb">with-open</span><span class="w"> </span><span class="p">[</span><span class="n">out</span><span class="w"> </span><span class="p">(</span><span class="nb">new</span><span class="w"> </span><span class="n">PipedOutputStream</span><span class="w"> </span><span class="n">in</span><span class="p">)]</span><span class="w">
    </span><span class="p">(</span><span class="nf">.copyOut</span><span class="w"> </span><span class="n">mgr</span><span class="w"> </span><span class="n">sql</span><span class="w"> </span><span class="n">out</span><span class="p">))</span><span class="w">

  </span><span class="o">@</span><span class="n">fut</span><span class="w"> </span><span class="c1">;; wait for the future to complete</span><span class="w">
  </span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

                
            </div>

        </li>
        
    </ul>

    <h4>
        
        <a href="/" class="previous">&larr;</a>
        
        <span class="page_number ">Страница 2 из 101</span>
        
        <a href="/page3" class="next">&rarr;</a>
        
    </h4>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Ivan Grishaev's blog</li>
          <li><a href="mailto:ivan@grishaev.me">ivan@grishaev.me</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
            <li><a href="https://github.com/igrishaev">GitHub</a></li>
            <li><a href="https://t.me/igrishaev_blog">Telegram</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Writing on programming, education, books and negotiations.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
