<!DOCTYPE html>
<html lang="ru">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Ivan Grishaev's blog</title>
  <meta name="description" content="Writing on programming, education, books and negotiations.
">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/custom.css">
  <link rel="canonical" href="https://grishaev.me/page10/">
  <link rel="alternate" type="application/rss+xml" title="Ivan Grishaev's blog" href="https://grishaev.me/feed.xml">

  <link rel="shortcut icon" type="image/x-icon" href="/assets/static/favicons/favicon.ico">

  <script type="text/javascript" src="/assets/typo.js"></script>

</head>


  <body>
    <header class="site-header">

    <div class="wrapper flex-container">

        <div>
            <a href="/">
                <img id="avatar" src="/assets/static/avatar.jpg" alt="Ivan Grishaev">
            </a>
        </div>

        <div class="flex-container-vert" style="margin-left: 15px; width: 80%">

            <div class="flex-container full-width">
                <p style="margin-bottom: 5px">Ivan Grishaev's blog</p>
                <div class="flex-huge"></div>
                <div >
<form id="search-form"
      target="_blank"
      style="display: inline"
      method="get"
      action="https://www.google.com/search">

    <input name="sitesearch"
           value="grishaev.me"
           type="hidden">

    <input type="text"
           required="required"
           name="q"
           placeholder="Google search..."
           autocomplete="off">

    <button style="border: none; background-color: transparent; cursor: pointer;"
            type="submit">&#x1f50d;</button>

</form>
</div>
            </div>

            <p><small>Writing on programming, education, books and negotiations.
</small></p>

            <div class="flex-container">
                <a class="menu-item" href="/">Home</a>
                <a class="menu-item" href="/about/">About</a>
                <a class="menu-item" href="/bookshelf/">Bookshelf</a>
                <a class="menu-item" href="/feed.xml">RSS</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor" href="/tag/clojure/">Clojure</a>
                <a class="menu-item minor" href="/tag/emacs/">Emacs</a>
                <a class="menu-item minor" href="/tag/python/">Python</a>
                <a class="menu-item minor" href="/tag/programming/">Programming</a>
                <a class="menu-item minor" href="/interview/">Interview</a>
                <a class="menu-item minor" href="/video/">Video</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor hl" href="/clojure-in-prod/">Книга «Clojure на производстве»</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor hl" href="/clojure-in-prod-2/">Книга «Clojure на производстве», второй том</a>
            </div>

        </div>
    </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="home">

    <ul class="post-list">
        
        <li>

            <h2>
                <a class="post-link" href="/xbox-ban/">Бан в XBox</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2023-09-17T00:00:00+00:00">
        Sep 17, 2023
    </time>

    <a href="/tag/xbox/" rel="tag">xbox</a>, <a href="/tag/design/" rel="tag">design</a>

</div>


            <div class="entry">
                
                    <p><img src="/assets/static/aws/xbox/1.jpeg" /></p>

<p>У меня нет приставки, и я почти ни во что не играю (разве что в старые игры на эмуляторе). Однако я не мог пройти мимо такой картинки в интернете. Это скриншот из интерфейса XBox, где написано, что вас забанили.</p>

<p>Удивляет пиктограмма рукопожатия справа. Что было в голове у дизайнера, который ее добавил? Мало того, что забанили клиента без объяснения причины; так еще нарисовали рукопожатие, мол, дружище, без обид, держись там. Бан пройдет, и мы снова будем друзьями.</p>

<p>Тупизна какого-то вселенского масштаба. В точности как все у Микрософта.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/warn/">Warn</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2023-09-17T00:00:00+00:00">
        Sep 17, 2023
    </time>

    <a href="/tag/logs/" rel="tag">logs</a>, <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/warn/" rel="tag">warn</a>

</div>


            <div class="entry">
                
                    <p>Не допускайте, чтобы в коде встречались логи с уровнем warn(ing).</p>

<p>Во-первых, warn, предупреждение, — это ни то, ни сё. Вроде важнее обычного info,
но и не ошибка. Что делать? Продолжать вести наблюдение?</p>

<p>Во-вторых, warn — отличный способ отстрелить ногу. В текущем проекте много
фоновых задач, и для них используется библиотека-аналог крона. Каждую задачу она
оборачивает в try/catch, чтобы не падать, но при этом логирует исключение с
уровнем warn. Мол, тут что-то упало, но не беспокойся. Авось в следующий раз
повезёт.</p>

<p>Наш логгер устроен так, что только error попадает в Sentry; остальное идёт в
файл, который никто не читает. В результате мы прошляпили кучу ошибок в фоновых
задачах — просто потому, что автор библиотеки не считает их чем-то важным. Крон
работает и хорошо. Подумаешь, половина задач валится, главное, что у меня всё в
порядке.</p>

<p>Не надо так.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/telegram-fram/">Фрагментация Телеграма</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2023-09-17T00:00:00+00:00">
        Sep 17, 2023
    </time>

    <a href="/tag/telegram/" rel="tag">telegram</a>, <a href="/tag/vk/" rel="tag">vk</a>

</div>


            <div class="entry">
                
                    <p>Когда я пользовался VK, меня удивляла фрагментация сущностей. Заметка, пост, фотография, видео и прочее — всё уже не упомню. Были записи на стене, сама стена, группы, форум. Я никогда не мог запомнить, что и где создавать и удивлялся — почему нельзя свести этот зоопарк к “сообщению”? Да, пусть у него будет много полей: гео-теги, фото, видео, ссылки… но это лучше, чем дюжина разных сущностей! Причём не только для программистов, но и для пользователей, потому что заморочки бекенда не будут на них проецироваться.</p>

<p>Ясно, что ВК был клоном Фейсбука (запрещенная организация) и унаследовал его родовые травмы. В свою очередь в Фейсбуке была та же фрагментация, потому что изначально это был закрытый форум. А на форумах до сих пор такая фигня: создать заметку, фотографию, видео.</p>

<p>Учетку VK, ровно как и других соцсетей, я удалил лет семь назад и ни разу не пожалел.</p>

<p>Удвиляет, что при всем идиотизме этой фрагментации она продолжает жить в мессенджерах. Скажем, я написал заметку на лист А4, она прекрасно помещается в Телеграме. Но стоит добавить картинку или видео — размер сокращается в разы, буквально 150 символов или около. Почему? Потому что это уже не “заметка”, а “картинка”. А в чём проблема показать и картинку, и текст? Очевидно, там какие-то заморочки на бекенде — Эрланг, Mnesia, — но какое они имеют значение для меня как пользователя? Никакого.</p>

<p>Чтобы исправить этот косяк, Телеграм сделал Телеграф — сервис анонимных заметок, в котором текст чередуется с картинками. Телеграфные ссылки открываются в Телеграме без перехода в браузер, но в целом это костыль — решили симптом, проблема осталась.</p>

<p>А с недавними сторисами вышел смех и грех. Совершенно бесполезная функция, которую нельзя отключить. Мало того, что это буквальное неуважение к пользователю, так еще чувствуется вторичность и запоздалое заимствование. Телеграм — хороший месаджер, при чём тут какие-то сторис? У нас что, Инстаграм? Полная нелепица.</p>

<p>В итоге происходит следующее: люди уходят из соцсетей в месаджеры, потому что устали от фрагментации контента. Не хочется групп, стен, форумов. Хочется единого потока сообщений. Для некоторых целей это не подходит, но в целом удобно. И тут опять приходит фрагментация. Деление каналов на топики — как же они глючили и кувыркались в первые недели работы! — и сторизы.</p>

<p>Конечно, найдется тот, кто скажет: не нравится — не пользуйся. Но так не работает. Уже построены связи, диалоги, люди стучатся в Телеграм, и слезть с него так просто не выйдет.</p>

<p>Словом, Телеграм плавно становится комбайном, который “может все”, как китайский Ви-чат. Это немного, но огорчает: мне не нужно всё.</p>

<p>Мне нужно чуть-чуть.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/pe-music/">Parasite Eve</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2023-09-17T00:00:00+00:00">
        Sep 17, 2023
    </time>

    <a href="/tag/parasiteeve/" rel="tag">parasiteeve</a>, <a href="/tag/playstation/" rel="tag">playstation</a>, <a href="/tag/music/" rel="tag">music</a>

</div>


            <div class="entry">
                
                    <p>На первой PlayStation была замечательная игра Parasite Eve. И была там музыкальная шкатулка с красивой темой:</p>

<iframe width="897" height="586" src="https://www.youtube.com/embed/ENMEzmmWiKk" title="13 - Parasite Eve OST Disc 2 - I Hear a Voice Asking Me to Awaken" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen=""></iframe>

<p>Оказывается, <a href="https://youtu.be/DqZE54i-muE?t=919">это Бах</a>. Всего-то 23 года прошло, прежде чем я это понял.</p>

<p>Кто играл в эту замечательную игру, почтите ее прослушиванием саундтрека.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/en/pg-docs/05/">PG docs, part 5. Notifications</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2023-09-15T00:00:00+00:00">
        Sep 15, 2023
    </time>

    <a href="/tag/clojure/" rel="tag">clojure</a>, <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/postgres/" rel="tag">postgres</a>, <a href="/tag/sql/" rel="tag">sql</a>, <a href="/tag/notifications/" rel="tag">notifications</a>

</div>


            <div class="entry">
                
                    
<p><em>(This is a new documentation chapter from the <a href="https://github.com/igrishaev/pg">PG project</a>.)</em></p>

<p><strong>ToC</strong></p>

<ul>
  <li><a href="/en/pg-docs/01/">About &amp; Installation</a></li>
  <li><a href="/en/pg-docs/02/">The Client</a></li>
  <li><a href="/en/pg-docs/03/">Connection Pool</a></li>
  <li><a href="/en/pg-docs/04/">Arrays</a></li>
  <li><a href="/en/pg-docs/05/">Notifications</a></li>
  <li><a href="/en/pg-docs/06/">SSL</a></li>
  <li><a href="/en/pg-docs/07/">COPY</a></li>
  <li><a href="/en/pg-docs/08/">HoneySQL</a></li>
</ul>

<h2 id="notifications">Notifications</h2>

<!-- toc -->

<ul>
  <li><a href="#introduction">Introduction</a></li>
  <li><a href="#usage">Usage</a></li>
</ul>

<!-- tocstop -->

<h3 id="introduction">Introduction</h3>

<p>Notifications are somewhat pub-sub message systems in Postgres. They can be
described in these simple steps:</p>

<ul>
  <li>
    <p>client B subscribes to a channel; the channel gets created if it doesn’t
exist.</p>
  </li>
  <li>
    <p>client A sends a message to that channel;</p>
  </li>
  <li>
    <p>every time client B interacts with the database, they receive messages sent to
this channel by other clients.</p>
  </li>
</ul>

<p>To handle a message, the client invokes a special handler. This handler comes
from the configuration. The default handler just prints the notification
map. <strong>Pay attention</strong> that the handler is called synchronously blocking the
interaction with a socket. To prevent the connection from hanging due to the
time-consuming handling of a notification, provide a handler that sends it to
some sort of channel, agent, or message queue system.</p>


                    <p><a href="/en/pg-docs/05/">Read more &rarr;</a></p>
                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/en/pg-docs/04/">PG docs, part 4. Arrays</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2023-09-12T00:00:00+00:00">
        Sep 12, 2023
    </time>

    <a href="/tag/clojure/" rel="tag">clojure</a>, <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/postgres/" rel="tag">postgres</a>, <a href="/tag/sql/" rel="tag">sql</a>, <a href="/tag/arrays/" rel="tag">arrays</a>

</div>


            <div class="entry">
                
                    
<p><em>(This is a new documentation chapter from the <a href="https://github.com/igrishaev/pg">PG project</a>.)</em></p>

<p><strong>ToC</strong></p>

<ul>
  <li><a href="/en/pg-docs/01/">About &amp; Installation</a></li>
  <li><a href="/en/pg-docs/02/">The Client</a></li>
  <li><a href="/en/pg-docs/03/">Connection Pool</a></li>
  <li><a href="/en/pg-docs/04/">Arrays</a></li>
  <li><a href="/en/pg-docs/05/">Notifications</a></li>
  <li><a href="/en/pg-docs/06/">SSL</a></li>
  <li><a href="/en/pg-docs/07/">COPY</a></li>
  <li><a href="/en/pg-docs/08/">HoneySQL</a></li>
</ul>

<p>In JDBC, arrays have always been a pain. Every time you want to pass an array to
the database or read it back, you’ve got to wrap your data with various Java
classes, extend protocols, and multimethods. We do it in each project, and it
doesn’t have to be like this.</p>

<p>The recent release of PG ships a significant feature: arrays. You can pass an
array to a query and read it back as easily as they were native Clojure
vectors. No more ceremonies with classes, manual parsing, etc.</p>


                    <p><a href="/en/pg-docs/04/">Read more &rarr;</a></p>
                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/en/pg-docs/03/">PG docs, part 3</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2023-09-05T00:00:00+00:00">
        Sep 5, 2023
    </time>

    <a href="/tag/clojure/" rel="tag">clojure</a>, <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/postgres/" rel="tag">postgres</a>, <a href="/tag/sql/" rel="tag">sql</a>

</div>


            <div class="entry">
                
                    
<p><em>(This is a new documentation chapter from the <a href="https://github.com/igrishaev/pg">PG project</a>.)</em></p>

<p><strong>ToC</strong></p>

<ul>
  <li><a href="/en/pg-docs/01/">About &amp; Installation</a></li>
  <li><a href="/en/pg-docs/02/">The Client</a></li>
  <li><a href="/en/pg-docs/03/">Connection Pool</a></li>
  <li><a href="/en/pg-docs/04/">Arrays</a></li>
  <li><a href="/en/pg-docs/05/">Notifications</a></li>
  <li><a href="/en/pg-docs/06/">SSL</a></li>
  <li><a href="/en/pg-docs/07/">COPY</a></li>
  <li><a href="/en/pg-docs/08/">HoneySQL</a></li>
</ul>

<h1 id="connection-pool">Connection Pool</h1>

<ul>
  <li><a href="#basic-usage">Basic usage</a></li>
  <li><a href="#with-pool--with-open">With-pool &amp; with-open</a></li>
  <li><a href="#config">Config</a></li>
  <li><a href="#thread-safety">Thread safety</a></li>
  <li><a href="#pool-exhausting">Pool Exhausting</a></li>
  <li><a href="#exception-handling">Exception handling</a></li>
  <li><a href="#logs">Logs</a></li>
  <li><a href="#component">Component</a></li>
</ul>

<p>To interact with a database effectively, you need a connection pool. A single
connection is fragile on its own: you can easily lose it by an accidental lag in
the network.</p>

<p>Another thing that is worth bearing in mind is, that opening a new connection
every time you want to reach PostgreSQL is expensive. Every connection starts a
new process on the server. If your code opens too many connections, say in a
cycle or within threads/futures, sooner or later you’ll reach an error response
saying “too many connections”.</p>

<p>The connection pool is an object that holds several open connections at once. It
allows you to <em>borrow</em> a connection for some period of time. A borrowed
connection can be only used in a block of code that has borrowed it but nowhere
else. Once the block of code has done with its duties, the connection gets
returned to the pool.</p>

<p>The pool is also capable of calculating the lifetime of connections and their
expiration moments. Once a connection has expired, it gets terminated and the
pool spawns a new connection.</p>

<p>The connection pool is shipped in a dedicated library
<code class="language-plaintext highlighter-rouge">com.github.igrishaev/pg-pool</code> as it depends on the logging facility.</p>


                    <p><a href="/en/pg-docs/03/">Read more &rarr;</a></p>
                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/en/pg-docs/02/">PG docs, part 2</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2023-08-31T00:00:00+00:00">
        Aug 31, 2023
    </time>

    <a href="/tag/clojure/" rel="tag">clojure</a>, <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/postgres/" rel="tag">postgres</a>, <a href="/tag/sql/" rel="tag">sql</a>

</div>


            <div class="entry">
                
                    
<p><strong>ToC</strong></p>

<ul>
  <li><a href="/en/pg-docs/01/">About &amp; Installation</a></li>
  <li><a href="/en/pg-docs/02/">The Client</a></li>
  <li><a href="/en/pg-docs/03/">Connection Pool</a></li>
  <li><a href="/en/pg-docs/04/">Arrays</a></li>
  <li><a href="/en/pg-docs/05/">Notifications</a></li>
  <li><a href="/en/pg-docs/06/">SSL</a></li>
  <li><a href="/en/pg-docs/07/">COPY</a></li>
  <li><a href="/en/pg-docs/08/">HoneySQL</a></li>
</ul>

<p>In this chapter, we’ll discuss how to reach Postgres using the <a href="https://github.com/igrishaev/pg">Client library</a>.</p>

<ul>
  <li><a href="#basic-usage">Basic usage</a></li>
  <li><a href="#queries">Queries</a></li>
  <li><a href="#execute">Execute</a></li>
  <li><a href="#prepared-statements">Prepared Statements</a></li>
  <li><a href="#processing-result-with-fn-result">Processing result with :fn-result</a></li>
  <li><a href="#column-names">Column names</a></li>
  <li><a href="#column-duplicates">Column duplicates</a></li>
  <li><a href="#reducers-and-bundles">Reducers and bundles</a>
    <ul>
      <li><a href="#java">Java</a></li>
      <li><a href="#kebab-keys">Kebab-keys</a></li>
      <li><a href="#matrix">Matrix</a></li>
      <li><a href="#index-by">Index by</a></li>
      <li><a href="#group-by">Group by</a></li>
      <li><a href="#key-value">Key-value</a></li>
      <li><a href="#custom-reducers">Custom reducers</a></li>
    </ul>
  </li>
  <li><a href="#transactions">Transactions</a>
    <ul>
      <li><a href="#always-rollback">Always Rollback</a></li>
      <li><a href="#read-only">Read-only</a></li>
      <li><a href="#isolation-level">Isolation level</a></li>
      <li><a href="#manual-transactions-and-status-check">Manual transactions and status check</a></li>
    </ul>
  </li>
  <li><a href="#configuration">Configuration</a></li>
  <li><a href="#authorization">Authorization</a></li>
  <li><a href="#cloning-a-connection">Cloning a connection</a></li>
  <li><a href="#cancelling-a-query">Cancelling a query</a></li>
  <li><a href="#notices">Notices</a></li>
  <li><a href="#thread-safety">Thread safety</a></li>
  <li><a href="#debugging">Debugging</a></li>
</ul>

<!-- tocstop -->

<h2 id="basic-usage">Basic usage</h2>

<p>Here is a brief example of using the client library:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">ns</span><span class="w"> </span><span class="n">scratch</span><span class="w">
  </span><span class="p">(</span><span class="no">:require</span><span class="w">
   </span><span class="p">[</span><span class="n">pg.client</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">pg</span><span class="p">]))</span><span class="w">

</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">config</span><span class="w">
  </span><span class="p">{</span><span class="no">:host</span><span class="w"> </span><span class="s">"127.0.0.1"</span><span class="w">
   </span><span class="no">:port</span><span class="w"> </span><span class="mi">5432</span><span class="w">
   </span><span class="no">:user</span><span class="w"> </span><span class="s">"test"</span><span class="w">
   </span><span class="no">:password</span><span class="w"> </span><span class="s">"test"</span><span class="w">
   </span><span class="no">:database</span><span class="w"> </span><span class="s">"test"</span><span class="p">})</span><span class="w">

</span><span class="p">(</span><span class="nf">pg/with-connection</span><span class="w"> </span><span class="p">[</span><span class="n">conn</span><span class="w"> </span><span class="n">config</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nf">pg/query</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="s">"select 1 as one"</span><span class="p">))</span><span class="w">

</span><span class="c1">;; [{:one 1}]</span><span class="w">
</span></code></pre></div></div>

<p>First, you import the <code class="language-plaintext highlighter-rouge">pg.client</code> namespace which brings the top-level API functions to interact with Postgres. The <code class="language-plaintext highlighter-rouge">config</code> map above specifies the minimal configuration;
it might have more fields which we will explore in a separate section.</p>

<p>The <code class="language-plaintext highlighter-rouge">with-connection</code> macro establishes a new connection, binds it to the <code class="language-plaintext highlighter-rouge">conn</code>
symbol, and executes the body. The connection is closed afterward, even if an
exception pops up.</p>

<p>Technically you can open and terminate a connection manually like this:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">conn</span><span class="w"> </span><span class="p">(</span><span class="nf">pg/connect</span><span class="w"> </span><span class="n">config</span><span class="p">)</span><span class="w">
      </span><span class="n">data</span><span class="w"> </span><span class="p">(</span><span class="nf">pg/query</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="s">"select 1 as one"</span><span class="p">)]</span><span class="w">
  </span><span class="p">(</span><span class="nf">pg/terminate</span><span class="w"> </span><span class="n">conn</span><span class="p">)</span><span class="w">
  </span><span class="n">data</span><span class="p">)</span><span class="w">

</span><span class="c1">;; [{:one 1}]</span><span class="w">
</span></code></pre></div></div>

<p>but it’s not recommended. Also, since the <code class="language-plaintext highlighter-rouge">Connection</code> object implements
<code class="language-plaintext highlighter-rouge">java.io.Closeable</code>, it’s possible to use it in <code class="language-plaintext highlighter-rouge">with-open</code>:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nb">with-open</span><span class="w"> </span><span class="p">[</span><span class="n">conn</span><span class="w"> </span><span class="p">(</span><span class="nf">pg/connect</span><span class="w"> </span><span class="n">config</span><span class="p">)]</span><span class="w">
  </span><span class="p">(</span><span class="nf">pg/query</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="s">"select 1 as one"</span><span class="p">))</span><span class="w">

</span><span class="c1">;; [{:one 1}]</span><span class="w">
</span></code></pre></div></div>


                    <p><a href="/en/pg-docs/02/">Read more &rarr;</a></p>
                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/en/pg-docs/01/">PG docs, part 1</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2023-08-28T00:00:00+00:00">
        Aug 28, 2023
    </time>

    <a href="/tag/clojure/" rel="tag">clojure</a>, <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/postgres/" rel="tag">postgres</a>, <a href="/tag/sql/" rel="tag">sql</a>

</div>


            <div class="entry">
                
                    <p><em>TL;DR: I’m writing a Postgres driver in pure Clojure. In general, works! Now I
proceed with the most miserable part of the project: writing documentation. I
decided to do it step by step and share it on my blog.</em></p>

<p><strong>ToC</strong></p>

<ul>
  <li><a href="/en/pg-docs/01/">About &amp; Installation</a></li>
  <li><a href="/en/pg-docs/02/">The Client</a></li>
  <li><a href="/en/pg-docs/03/">Connection Pool</a></li>
  <li><a href="/en/pg-docs/04/">Arrays</a></li>
  <li><a href="/en/pg-docs/05/">Notifications</a></li>
  <li><a href="/en/pg-docs/06/">SSL</a></li>
  <li><a href="/en/pg-docs/07/">COPY</a></li>
  <li><a href="/en/pg-docs/08/">HoneySQL</a></li>
</ul>

<h2 id="about">About</h2>

<p><a href="https://github.com/igrishaev/pg">This project</a> is a set of libraries related to the <a href="https://www.postgresql.org/">PostgreSQL</a>
database. The primary library called <code class="language-plaintext highlighter-rouge">pg-client</code> is a driver for Postgres
written in pure Clojure. By purity I mean, neither JDBC nor any other
third-party Java libraries are involved. Everything is driven by a TCP socket
and implementation of the Posrgres Wire protocol. Fun!</p>

<p>Besides the client, the project provides such various additions as a connection
pool (see <code class="language-plaintext highlighter-rouge">pg-pool</code>). The <code class="language-plaintext highlighter-rouge">pg-types</code> library holds the encoding and decoding
logic which determines how to write and read Clojure data from and into the
database. You can use this library separately in pair with JDBC.next and <code class="language-plaintext highlighter-rouge">COPY</code>
for efficient data transcoding in binary format.</p>

<p>The question you would probably ask is, why would create a Postgres client from
scratch? JDBC has been around for decades, and there are also good
<code class="language-plaintext highlighter-rouge">clojure.java.jdbc</code> and <code class="language-plaintext highlighter-rouge">jdbc.next</code> wrappers on top of it?</p>

<p>The answer is: that although these two libraries are amazing, they don’t
disclose all Postgres features. JDBC is an abstraction whose main goal is to
satisfy all the DB engines. A general library that works with MS SQL, MySQL, and
Postgres at the same time would reduce the variety of features each backend is
capable of.</p>


                    <p><a href="/en/pg-docs/01/">Read more &rarr;</a></p>
                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/book2-anounce/">Анонс второй книги</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2023-08-01T00:00:00+00:00">
        Aug 1, 2023
    </time>

    <a href="/tag/clojure/" rel="tag">clojure</a>, <a href="/tag/book/" rel="tag">book</a>

</div>


            <div class="entry">
                
                    <p><img src="/assets/static/aws/clj-book2/IMG_2527.jpeg" /></p>

<p>Вышел второй том “Сlojure на производстве” — продолжение первой книги. Без той
помпы, что в прошлый раз, когда я каждую неделю выкладывал апдейты, фото
черновиков и прочее. На всё это не хватает времени, плюс хочется меньше пафоса.</p>

<p>В книге три главы, черновые версии которых я выкладывал в блоге. Это
<a href="/clj-zippers-1/">зипперы</a>, <a href="/clj-jdbc-1/">базы данных</a> и
<a href="/clj-repl-part-1/">REPL</a>. Всё это можно прочесть здесь на сайте, но каждую
главу я многократно улучшил. Кроме банальных опечаток, изменилась структура, а
примеры стали убедительней.</p>

<p>Книжка выполнена в том же стиле и манере повествования. Текст чередуется с
кодом, каждый тезис подтверждается примером. Длинный код разбит на части с
пояснением, что происходит. Код “подсвечен” с помощью градаций серого и
начертания. Ссылки, коих много по тексту, вынесены в QR-коды на поля.</p>

<p>Твёрдая обложка, B5, 364 страницы. Форматы для мобильных устройств появятся
позже. Издано в ДМК-Пресс тиражом в 100 экземпляров. Двадцать из них — мои,
полученные в качестве гонорара, и я готов разослать их читателям.</p>

<p>Все подробности – где купить, открывок, галерея – указаны <a href="/clojure-in-prod-2/">на странице
книги</a>.</p>

                
            </div>

        </li>
        
    </ul>

    <h4>
        
        <a href="/page9" class="previous">&larr;</a>
        
        <span class="page_number ">Страница 10 из 74</span>
        
        <a href="/page11" class="next">&rarr;</a>
        
    </h4>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Ivan Grishaev's blog</li>
          <li><a href="mailto:ivan@grishaev.me">ivan@grishaev.me</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
            <li><a href="https://github.com/igrishaev">GitHub</a></li>
            <li><a href="tg://resolve?domain=igrishaev_blog">Telegram</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Writing on programming, education, books and negotiations.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
