<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Teleward: a CAPTCHA bot for Telegram in Clojure + GraalVM</title>
  <meta name="description" content="">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/custom.css">
  <link rel="canonical" href="https://grishaev.me/en/teleward/">
  <link rel="alternate" type="application/rss+xml" title="Ivan Grishaev's blog" href="https://grishaev.me/feed.xml">

  <link rel="shortcut icon" type="image/x-icon" href="/assets/static/favicons/favicon.ico">

  <script type="text/javascript" src="/assets/typo.js"></script>

</head>


  <body>
    <header class="site-header">

    <div class="wrapper flex-container">

        <div>
            <a href="/">
                <img id="avatar" src="/assets/static/avatar.jpg" alt="Ivan Grishaev">
            </a>
        </div>

        <div class="flex-container-vert" style="margin-left: 15px; width: 80%">

            <div class="flex-container full-width">
                <p style="margin-bottom: 5px">Ivan Grishaev's blog</p>
                <div class="flex-huge"></div>
                <div >
<form id="search-form"
      target="_blank"
      style="display: inline"
      method="get"
      action="https://www.google.com/search">

    <input name="sitesearch"
           value="grishaev.me"
           type="hidden">

    <input type="text"
           required="required"
           name="q"
           placeholder="Google search..."
           autocomplete="off">

    <button style="border: none; background-color: transparent; cursor: pointer;"
            type="submit">&#x1f50d;</button>

</form>
</div>
            </div>

            <p><small>Writing on programming, education, books and negotiations.
</small></p>

            <div class="flex-container">
                <a class="menu-item" href="/">Home</a>
                <a class="menu-item" href="/about/">About</a>
                <a class="menu-item" href="/bookshelf/">Bookshelf</a>
                <a class="menu-item" href="/feed.xml">RSS</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor" href="/tag/clojure/">Clojure</a>
                <a class="menu-item minor" href="/tag/emacs/">Emacs</a>
                <a class="menu-item minor" href="/tag/python/">Python</a>
                <a class="menu-item minor" href="/tag/programming/">Programming</a>
                <a class="menu-item minor" href="/interview/">Interview</a>
                <a class="menu-item minor" href="/video/">Video</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor hl" href="/clojure-in-prod/">Книга «Clojure на производстве»</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor hl" href="/clojure-in-prod-2/">Книга «Clojure на производстве», второй том</a>
            </div>

        </div>
    </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">

    <h1 class="post-title" itemprop="name headline">Teleward: a CAPTCHA bot for Telegram in Clojure + GraalVM</h1>

    
<div class="post-meta">

    <time class="post-time"
          datetime="2022-07-18T00:00:00+00:00">
        Jul 18, 2022
    </time>

    <a href="/tag/clojure/" rel="tag">clojure</a>, <a href="/tag/programming/" rel="tag">programming</a>

</div>


  </header>

  <div class="post-content" itemprop="articleBody">
    
<p><em>(This is a copy of the readme file from the repository.)</em></p>

<p><a href="https://github.com/igrishaev/teleward">Teleward</a> is a Telegram captcha bot written in Clojure and compiled
with GraalVM native image. Runs on bare Linux/MacOS with no requirements. Fast
and robust.</p>

<h3 id="why">Why</h3>

<p>Telegram chats suffer from spammers who are pretty smart nowadays. They don’t
use bots; instead, they register ordinary accounts and automate them with
Selenium + web-version of Telegram. Personally, I found Shieldy and other bots
useless when dealing with such kind of spammers. This project aims the goal to
finish that mess.</p>

<p>Another reason I opened Teleward for is to try my skills in developing Clojure
applications with GraalVM. Binary applications are nice: they are fast, and they
don’t need installing JDK. At the same time, they’re are still Clojure: REPL is
here, and that’s amazing.</p>

<h3 id="features">Features</h3>

<ul>
  <li>This is Clojure, so you have REPL! During development, you call Telegram API
directly from REPL and see what’s going on.</li>
  <li>The bot can be delivered either as a Jar file or a binary file (with Graal).</li>
  <li>When Graal-compiled, needs no requirements (Java SDK, etc). The binary size is
about 30 Mb.</li>
  <li>At the moment, supports only long polling strategy to obtain messages. The
webhook is to be done soon.</li>
  <li>Keeps all the state in memory and thus doesn’t need any kind of a
database. The only exception is the current offset value which is tracked in a
file.</li>
  <li>Supports English and Russian languages.</li>
  <li>Two captcha styles: normal “1 + 2” and Lisp captcha “(+ 1 2)”.</li>
  <li>The <code class="language-plaintext highlighter-rouge">+</code>, <code class="language-plaintext highlighter-rouge">-</code>, and <code class="language-plaintext highlighter-rouge">*</code> operators are corresponding Unicode characters that
prevent captcha from naive evaluation.</li>
</ul>

<h3 id="algorithm">Algorithm</h3>

<p>The bot listens for all the messages in a group. Once a new pack of messages
arrives, the bot applies the following procedure to each message:</p>

<ul>
  <li>Mark new members as locked.</li>
  <li>Send a captcha message to all members.</li>
  <li>Unless an author of a message is locked, delete that message.</li>
  <li>If a message is short and matches the captcha’s solution, unlock a user and
delete the catpcha message.</li>
  <li>If a locked user has posted three messages with no solution, ban them.</li>
  <li>If a locked user hasn’t solved captcha in time, ban them as well.</li>
</ul>

<p><em>Please note:</em> the bot processes only messages no older than two minutes from
now. In other words, the bot is interested in what is happening now (with a
slight delay), but not in the far past. This is to prevent a sutuation what a
bot had been inactive and then has started to consume messages. Without this
condition, it will send captcha to chat members who have already joined and
confuse them.</p>

<h3 id="java-version">Java version</h3>

<p>To make a Jar artefact, run:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>make uberjar
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">uberjar</code> target calls <code class="language-plaintext highlighter-rouge">lein uberjar</code> and also injects the <code class="language-plaintext highlighter-rouge">VERSION</code> file
into it. The output file is <code class="language-plaintext highlighter-rouge">./target/teleward.jar</code>.</p>

<h3 id="binary-version-linux">Binary version, Linux</h3>

<p>Linux version is built inside a Docker image, namely the
<code class="language-plaintext highlighter-rouge">ghcr.io/graalvm/graalvm-ce</code> one with <code class="language-plaintext highlighter-rouge">native-image</code> extension preinstalled. Run
the following command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>make docker-build
</code></pre></div></div>

<p>The output binary file appears at <code class="language-plaintext highlighter-rouge">./target/teleward</code>.</p>

<h3 id="binary-version-macos">Binary version, MacOS</h3>

<ul>
  <li>
    <p><a href="https://www.graalvm.org/docs/getting-started/">Install GraalVM</a> locally.</p>
  </li>
  <li>
    <p>Install the “native image” extension:</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gu <span class="nb">install </span>native-image
</code></pre></div></div>

<ul>
  <li>Then <code class="language-plaintext highlighter-rouge">make</code> the project:</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>make
</code></pre></div></div>

<h3 id="setting-up-your-bot">Setting Up Your Bot</h3>

<ul>
  <li>
    <p>To run the bot, first you need a token. Contact <code class="language-plaintext highlighter-rouge">@BotFather</code> in Telegram to
create a new bot. Copy the token and don’t share it.</p>
  </li>
  <li>
    <p>Add your new bot into a Telegram group. Promote it to admins. At least the bot
must be able to 1) send messages, 2) delete messages, and 3) ban users.</p>
  </li>
  <li>
    <p>Run the bot locally:</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>teleward <span class="nt">-t</span> &lt;telegram-token&gt; <span class="nt">-l</span> debug
</code></pre></div></div>

<p>If everything is fine, the bot will start consuming messages and print them in
console.</p>

<h3 id="configuration">Configuration</h3>

<p>See the version with <code class="language-plaintext highlighter-rouge">-v</code>, and help with <code class="language-plaintext highlighter-rouge">-h</code>. The bot takes into account plenty
of settings, yet not all of them are available for configuration for now. Below,
we name the most important parameters you will need.</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">-t, --telegram.token</code>: the Telegram token you obtain from
BotFather. Required, can be set via an env variable <code class="language-plaintext highlighter-rouge">TELEGRAM_TOKEN</code>.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">-l, --logging.level</code>: the logging level. Can be <code class="language-plaintext highlighter-rouge">debug, info, error</code>. Default
is <code class="language-plaintext highlighter-rouge">info</code>. In production, most likely you will set <code class="language-plaintext highlighter-rouge">error</code>.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">--telegram.offset-file</code>: where to store offset number for the next
<code class="language-plaintext highlighter-rouge">getUpdates</code> call. Default is <code class="language-plaintext highlighter-rouge">TELEGRAM_OFFSET</code> in the current working
directory.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">--lang</code>: the language for messages. Can be <code class="language-plaintext highlighter-rouge">en, ru</code>, default is <code class="language-plaintext highlighter-rouge">ru</code>.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">--captcha.style</code>: a type of captcha. When <code class="language-plaintext highlighter-rouge">lisp</code>, the captcha looks like a
lisp expression <code class="language-plaintext highlighter-rouge">(+ 4 3)</code>. Any other value type will produce <code class="language-plaintext highlighter-rouge">4 + 3</code>. The
operator is taken randomly.</p>
  </li>
</ul>

<p>Example:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./target/teleward <span class="nt">-t</span> &lt;...&gt; <span class="nt">-l</span> debug <span class="se">\</span>
  <span class="nt">--lang</span><span class="o">=</span>en <span class="nt">--telegram</span>.offset-file<span class="o">=</span>mybot.offset <span class="se">\</span>
  <span class="nt">--captcha</span>.style<span class="o">=</span>normal
</code></pre></div></div>

<p>For the rest of the config, see the <code class="language-plaintext highlighter-rouge">src/teleward/config.clj</code> file.</p>

<h3 id="deploying-on-bare-ubuntu">Deploying on bare Ubuntu</h3>

<ul>
  <li>
    <p>Buy the cheapest VPS machine and SSH to it.</p>
  </li>
  <li>
    <p>Create a user:</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>useradd <span class="nt">-s</span> /bin/bash <span class="nt">-d</span> /home/ivan/ <span class="nt">-m</span> <span class="nt">-G</span> <span class="nb">sudo </span>ivan
<span class="nb">sudo </span>passwd ivan
<span class="nb">mkdir</span> /home/ivan/teleward
</code></pre></div></div>

<ul>
  <li>Compile the file locally and copy it to the machine:</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>scp ./target/teleward ivan@hostname:/home/ivan/teleward/
</code></pre></div></div>

<ul>
  <li>Create a new <code class="language-plaintext highlighter-rouge">systemctl</code> service:</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>mcedit /etc/systemd/system/teleward.service
</code></pre></div></div>

<ul>
  <li>Paste the following config:</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[Unit]
Description = Teleward bot
After = network.target

[Service]
Type = simple
Restart = always
RestartSec = 1
User = ivan
WorkingDirectory = /home/ivan/teleward/
ExecStart = /home/ivan/teleward/teleward -l debug
Environment = TELEGRAM_TOKEN=xxxxxxxxxxxxxx

[Install]
WantedBy = multi-user.target
</code></pre></div></div>

<ul>
  <li>Enable autoload:</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>systemctl <span class="nb">enable </span>teleward
</code></pre></div></div>

<ul>
  <li>Manage the service with commands:</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>systemctl stop teleward
<span class="nb">sudo </span>systemctl start teleward
<span class="nb">sudo </span>systemctl status teleward
</code></pre></div></div>

<p>For Jar, the config file would be almost the same except the <code class="language-plaintext highlighter-rouge">ExecStart</code>
section. There, you specify something like <code class="language-plaintext highlighter-rouge">java -jar teleward.jar ...</code>.</p>

<h3 id="health-check">Health check</h3>

<p>The bot accepts the <code class="language-plaintext highlighter-rouge">/health</code> command which it replies to “OK”.</p>

<h3 id="further-work">Further work</h3>

<ul>
  <li>Implement webhook.</li>
  <li>Add tests.</li>
  <li>Report uptime for <code class="language-plaintext highlighter-rouge">/health</code>.</li>
  <li>More config parameters via CLI args.</li>
  <li>Widnows build.</li>
</ul>

<p>© 2022 Ivan Grishaev</p>

    
<div class="prev-next">

    <div class="prev-next-left">
    
        <p><small><a href="/failed-podcast/">&larr; Невышедший подкаст про Лисп. Работа над ошибками</a></small></p>
    
    </div>

    <div class="prev-next-mid">
    </div>

    <div class="prev-next-right">
    
        <p><small><a href="/clj-repl-part-1/">REPL, Cider, Emacs (часть 1/4) &rarr;</a></small></p>
    
    </div>

</div>

  </div>

</article>

<center>
    <p>
        <small>Нашли ошибку? Выделите мышкой и нажмите Ctrl/&#8984;+Enter</small>
    </p>
</center>






<center>Комментариев пока нет</center>









<form id="comment-form" method="POST" action="https://functions.yandexcloud.net/d4ehfuf08fjfjr59ivnf">

    <div class="block">
        <p class="comment-form-label"><small>Your name</small></p>
        <input required id="comment-form-author" name="author" type="text">
    </div>

    <div class="block">
        <p class="comment-form-label"><small>Comment (markdown syntax)</small></p>
        <textarea required id="comment-form-comment" name="comment"></textarea>
    </div>

    <input required name="path" type="hidden" value="/en/teleward/">
    <input required name="captcha" type="hidden" value="5 &#215; 9">

    <div class="block">
        <span class="comment-form-label"><small>5 &#215; 9 = </small></span>
        <input required id="comment-form-solution" name="solution" type="text">
    </div>

    <div class="block">
        <button id="comment-form-send" type="submit">Send</button>
    </div>

</form>


      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Ivan Grishaev's blog</li>
          <li><a href="mailto:ivan@grishaev.me">ivan@grishaev.me</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
            <li><a href="https://github.com/igrishaev">GitHub</a></li>
            <li><a href="https://t.me/igrishaev_blog">Telegram</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Writing on programming, education, books and negotiations.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
