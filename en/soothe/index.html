<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Meet Soothe: a small Clojure library for better Spec error messages</title>
  <meta name="description" content="Note: this post is an adjusted copy of the Readme file from the GitHub repo.">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/custom.css">
  <link rel="canonical" href="https://grishaev.me/en/soothe/">
  <link rel="alternate" type="application/rss+xml" title="Ivan Grishaev's blog" href="https://grishaev.me/feed.xml">

  <link rel="shortcut icon" type="image/x-icon" href="/assets/static/favicons/favicon.ico">

  <script type="text/javascript" src="/assets/typo.js"></script>

</head>


  <body>
    <header class="site-header">

    <div class="wrapper flex-container">

        <div>
            <a href="/">
                <img src="/assets/static/photo-round-small.png" alt="Ivan Grishaev">
            </a>
        </div>

        <div class="flex-container-vert" style="margin-left: 15px; width: 80%">

            <div class="flex-container full-width">
                <p style="margin-bottom: 5px">Ivan Grishaev's blog</p>
                <div class="flex-huge"></div>
                <div >
<form id="search-form"
      target="_blank"
      style="display: inline"
      method="get"
      action="https://www.google.com/search">

    <input name="sitesearch"
           value="grishaev.me"
           type="hidden">

    <input type="text"
           required="required"
           name="q"
           placeholder="Google search..."
           autocomplete="off">

    <button style="border: none; background-color: transparent; cursor: pointer;"
            type="submit">&#x1f50d;</button>

</form>
</div>
            </div>

            <p><small>Writing on programming, education, books and negotiations.
</small></p>

            <div class="flex-container">
                <a class="menu-item" href="/">Home</a>
                <a class="menu-item" href="/about/">About</a>
                <a class="menu-item" href="/bookshelf/">Bookshelf</a>
                <a class="menu-item" href="/feed.xml">RSS</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor" href="/tag/clojure/">Clojure</a>
                <a class="menu-item minor" href="/tag/emacs/">Emacs</a>
                <a class="menu-item minor" href="/tag/python/">Python</a>
                <a class="menu-item minor" href="/tag/programming/">Programming</a>
                <a class="menu-item minor" href="/interview/">Interview</a>
                <a class="menu-item minor" href="/video/">Video</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor hl" href="/clojure-in-prod/">Книга «Clojure на производстве»</a>
            </div>

        </div>
    </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">

    <h1 class="post-title" itemprop="name headline">Meet Soothe: a small Clojure library for better Spec error messages</h1>

    
<div class="post-meta">

    <time class="post-time"
          datetime="2021-11-14T00:00:00+00:00">
        Nov 14, 2021
    </time>

    <a href="/tag/clojure/" rel="tag">clojure</a>, <a href="/tag/spec/" rel="tag">spec</a>, <a href="/tag/soothe/" rel="tag">soothe</a>

</div>


  </header>

  <div class="post-content" itemprop="articleBody">
    <p><em>Note: this post is an adjusted copy of the Readme file from the <a href="https://github.com/igrishaev/soothe">GitHub repo</a>.</em></p>

<p>Soothe provides better error messages for Clojure.spec. It’s extremely simple and robust.</p>

<p><a href="https://igrishaev.github.io/soothe/">API Documentation</a></p>

<h2>

    

</h2>

<ul id="toc-item-farseer-en">
  <li><a href="#installation" id="toc-item-farseer-en-installation">Installation</a></li>
  <li><a href="#concepts" id="toc-item-farseer-en-concepts">Concepts</a></li>
  <li><a href="#tldr-code-samples" id="toc-item-farseer-en-tldr-code-samples">TL;DR: Code Samples</a></li>
  <li><a href="#the-api" id="toc-item-farseer-en-the-api">The API</a>    <ul>
      <li><a href="#special-messages" id="toc-item-farseer-en-special-messages">Special messages</a></li>
    </ul>
  </li>
  <li><a href="#pre-defined-messages--localization" id="toc-item-farseer-en-pre-defined-messages--localization">Pre-defined messages &amp; Localization</a></li>
  <li><a href="#clojurescript" id="toc-item-farseer-en-clojurescript">ClojureScript</a></li>
  <li><a href="#best-practices--known-cases" id="toc-item-farseer-en-best-practices--known-cases">Best practices &amp; Known cases</a></li>
</ul>

<h2 id="installation">Installation</h2>

<ul>
  <li>Leiningen/Boot</li>
</ul>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="n">com.github.igrishaev/soothe</span><span class="w"> </span><span class="s">"0.1.0"</span><span class="p">]</span><span class="w">
</span></code></pre></div></div>

<ul>
  <li>clojure CLI/deps.edn</li>
</ul>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">com.github.igrishaev/soothe</span><span class="w"> </span><span class="p">{</span><span class="no">:mvn/version</span><span class="w"> </span><span class="s">"0.1.0"</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h2 id="concepts">Concepts</h2>

<p>Clojure.spec is a piece of art yet misses some bits when dealing with error
messages.  The standard <code class="language-plaintext highlighter-rouge">s/explain-data</code> gives a raw machinery output that
bearly can be shown to the end-user. This library is going to fix this.</p>

<p>The idea of Soothe is extremely simple. The library keeps its private registry
of spec/pred =&gt; message pairs. The key is either a keyword referencing a spec or
a fully-qualified symbol meaning a predicate. The value of this map is either a
plain string or a function that takes the problem map of the raw explain spec
data.</p>

<!-- more -->

<p>For example:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="no">:some.ns/user</span><span class="w">
 </span><span class="s">"This is a wrong user."</span><span class="w">

 </span><span class="ss">'other.ns/data-valid?</span><span class="w">
 </span><span class="s">"The data is invalid."</span><span class="w">

 </span><span class="no">:my.project.spec/item</span><span class="w">
 </span><span class="p">(</span><span class="k">fn</span><span class="w"> </span><span class="p">[{</span><span class="no">:as</span><span class="w"> </span><span class="n">problem</span><span class="w"> </span><span class="no">:keys</span><span class="w"> </span><span class="p">[</span><span class="n">pred</span><span class="w"> </span><span class="n">in</span><span class="p">]}]</span><span class="w"> </span><span class="c1">;; other spec problem keys</span><span class="w">
   </span><span class="p">(</span><span class="nf">format</span><span class="w"> </span><span class="s">"Build a custom message for this spec in runtime"</span><span class="p">))}</span><span class="w">
</span></code></pre></div></div>

<p>Soothe provides its own version of <code class="language-plaintext highlighter-rouge">explain-data</code>. When called, it prepares the
raw Spec explain data and then remaps it. For each problem, Soothe tries to find
a message using the following algorithm.</p>

<ul>
  <li>
    <p>When the <code class="language-plaintext highlighter-rouge">pred</code> field is a fully-qualified symbol, get the message from the
registry. For example, <code class="language-plaintext highlighter-rouge">clojure.core/int?</code> resolves into something like <code class="language-plaintext highlighter-rouge">"The
value must be an integer"</code>.</p>
  </li>
  <li>
    <p>When the <code class="language-plaintext highlighter-rouge">pred</code> is something different, try the <code class="language-plaintext highlighter-rouge">via</code> vector of specs. The
algorithm iterates the vector in reverse order. The first spec which has a
message in the registry will succeed.</p>
  </li>
  <li>
    <p>A special case when an <code class="language-plaintext highlighter-rouge">s/keys</code> spec misses a required key.</p>
  </li>
  <li>
    <p>Another special case when the spec is wrapped with <code class="language-plaintext highlighter-rouge">s/conformer</code>.</p>
  </li>
  <li>
    <p>The default message gets resolved.</p>
  </li>
</ul>

<h2 id="tldr-code-samples">TL;DR: Code Samples</h2>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w">
</span><span class="c1">;;</span><span class="w">
</span><span class="c1">;; Imports</span><span class="w">
</span><span class="c1">;;</span><span class="w">

</span><span class="p">(</span><span class="nf">ns</span><span class="w"> </span><span class="n">...</span><span class="w">
  </span><span class="p">(</span><span class="no">:require</span><span class="w">
   </span><span class="p">[</span><span class="n">soothe.core</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">sth</span><span class="p">]</span><span class="w">
   </span><span class="p">[</span><span class="n">clojure.spec.alpha</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">s</span><span class="p">]))</span><span class="w">


</span><span class="c1">;;</span><span class="w">
</span><span class="c1">;; Define a spec</span><span class="w">
</span><span class="c1">;;</span><span class="w">
</span><span class="p">(</span><span class="nf">s/def</span><span class="w"> </span><span class="no">:user/name</span><span class="w"> </span><span class="nb">string?</span><span class="p">)</span><span class="w">
</span><span class="p">(</span><span class="nf">s/def</span><span class="w"> </span><span class="no">:user/age</span><span class="w"> </span><span class="n">int?</span><span class="p">)</span><span class="w">

</span><span class="p">(</span><span class="nf">s/def</span><span class="w"> </span><span class="no">:user/email</span><span class="w">
  </span><span class="p">(</span><span class="nf">s/and</span><span class="w">
    </span><span class="nb">string?</span><span class="w">
    </span><span class="p">(</span><span class="nb">partial</span><span class="w"> </span><span class="nb">re-matches</span><span class="w"> </span><span class="o">#</span><span class="s">"(.+?)@(.+?)"</span><span class="p">)))</span><span class="w">

</span><span class="p">(</span><span class="nf">s/def</span><span class="w"> </span><span class="no">:user/field-42</span><span class="w">
  </span><span class="p">(</span><span class="k">fn</span><span class="w"> </span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="w">
    </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="mi">42</span><span class="p">)))</span><span class="w">

</span><span class="p">(</span><span class="nf">s/def</span><span class="w"> </span><span class="no">::user</span><span class="w">
  </span><span class="p">(</span><span class="nf">s/keys</span><span class="w"> </span><span class="no">:req-un</span><span class="w"> </span><span class="p">[</span><span class="no">:user/name</span><span class="w">
                   </span><span class="no">:user/age</span><span class="p">]</span><span class="w">
          </span><span class="no">:opt-un</span><span class="w"> </span><span class="p">[</span><span class="no">:user/email</span><span class="w">
                   </span><span class="no">:user/field-42</span><span class="p">]))</span><span class="w">


</span><span class="c1">;;</span><span class="w">
</span><span class="c1">;; Data sample</span><span class="w">
</span><span class="c1">;;</span><span class="w">

</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">user</span><span class="w">
  </span><span class="p">{</span><span class="no">:name</span><span class="w"> </span><span class="s">"Test"</span><span class="w"> </span><span class="no">:age</span><span class="w"> </span><span class="mi">42</span><span class="p">})</span><span class="w">


</span><span class="c1">;;</span><span class="w">
</span><span class="c1">;; no errors</span><span class="w">
</span><span class="c1">;;</span><span class="w">
</span><span class="p">(</span><span class="nf">sth/explain-data</span><span class="w"> </span><span class="no">::user</span><span class="w"> </span><span class="n">user</span><span class="p">)</span><span class="w"> </span><span class="c1">;; nil</span><span class="w">

</span><span class="c1">;;</span><span class="w">
</span><span class="c1">;; wrong type</span><span class="w">
</span><span class="c1">;;</span><span class="w">
</span><span class="p">(</span><span class="nf">sth/explain-data</span><span class="w">
  </span><span class="no">::user</span><span class="w">
  </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="no">:name</span><span class="w"> </span><span class="mi">42</span><span class="p">))</span><span class="w">

</span><span class="p">{</span><span class="no">:problems</span><span class="w">
  </span><span class="p">[{</span><span class="no">:message</span><span class="w"> </span><span class="s">"The value must be a string."</span><span class="w">  </span><span class="c1">;; &lt;&lt;&lt;</span><span class="w">
    </span><span class="no">:path</span><span class="w"> </span><span class="p">[</span><span class="no">:name</span><span class="p">]</span><span class="w">
    </span><span class="no">:val</span><span class="w"> </span><span class="mi">42</span><span class="p">}]}</span><span class="w">

</span><span class="c1">;;</span><span class="w">
</span><span class="c1">;; Missing key</span><span class="w">
</span><span class="c1">;;</span><span class="w">
</span><span class="p">(</span><span class="nf">sth/explain-data</span><span class="w">
  </span><span class="no">::user</span><span class="w"> </span><span class="p">(</span><span class="nb">dissoc</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="no">:age</span><span class="p">))</span><span class="w">

</span><span class="p">{</span><span class="no">:problems</span><span class="w">
  </span><span class="p">[{</span><span class="no">:message</span><span class="w"> </span><span class="s">"The object misses the mandatory key 'age'."</span><span class="w">  </span><span class="c1">;; &lt;&lt;&lt;</span><span class="w">
    </span><span class="no">:path</span><span class="w"> </span><span class="p">[]</span><span class="w">
    </span><span class="no">:val</span><span class="w"> </span><span class="p">{</span><span class="no">:name</span><span class="w"> </span><span class="s">"Test"</span><span class="p">}}]}</span><span class="w">

</span><span class="c1">;;</span><span class="w">
</span><span class="c1">;; Custom predicate fails, no custom message defined</span><span class="w">
</span><span class="c1">;;</span><span class="w">
</span><span class="p">(</span><span class="nf">sth/explain-data</span><span class="w">
  </span><span class="no">::user</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="no">:email</span><span class="w"> </span><span class="s">"wrong-string"</span><span class="p">))</span><span class="w">

</span><span class="p">{</span><span class="no">:problems</span><span class="w">
 </span><span class="p">[{</span><span class="no">:message</span><span class="w"> </span><span class="s">"The value is incorrect."</span><span class="w">  </span><span class="c1">;; &lt;&lt;&lt;</span><span class="w">
   </span><span class="no">:path</span><span class="w"> </span><span class="p">[</span><span class="no">:email</span><span class="p">]</span><span class="w">
   </span><span class="no">:val</span><span class="w"> </span><span class="s">"wrong-string"</span><span class="p">}]}</span><span class="w">


</span><span class="c1">;;</span><span class="w">
</span><span class="c1">;; Define a cumstom message</span><span class="w">
</span><span class="c1">;;</span><span class="w">
</span><span class="p">(</span><span class="nf">sth/def</span><span class="w"> </span><span class="no">:user/email</span><span class="w"> </span><span class="s">"Wrong email."</span><span class="p">)</span><span class="w">

</span><span class="p">(</span><span class="nf">sth/explain-data</span><span class="w">
  </span><span class="no">::user</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="no">:email</span><span class="w"> </span><span class="s">"wrong-string"</span><span class="p">))</span><span class="w">

</span><span class="p">{</span><span class="no">:problems</span><span class="w">
  </span><span class="p">[{</span><span class="no">:message</span><span class="w"> </span><span class="s">"Wrong email."</span><span class="w">  </span><span class="c1">;; &lt;&lt;&lt;</span><span class="w">
   </span><span class="no">:path</span><span class="w"> </span><span class="p">[</span><span class="no">:email</span><span class="p">]</span><span class="w">
   </span><span class="no">:val</span><span class="w"> </span><span class="s">"wrong-string"</span><span class="p">}]}</span><span class="w">

</span><span class="c1">;;</span><span class="w">
</span><span class="c1">;; A message for a custom predicate</span><span class="w">
</span><span class="c1">;;</span><span class="w">
</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">some-complidated-check</span><span class="w"> </span><span class="p">[</span><span class="n">value</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="mi">100500</span><span class="p">))</span><span class="w">

</span><span class="p">(</span><span class="nf">sth/def</span><span class="w"> </span><span class="o">`</span><span class="n">some-complidated-check</span><span class="w">
  </span><span class="s">"The value did't match that complicated check."</span><span class="p">)</span><span class="w">

</span><span class="p">(</span><span class="nf">s/def</span><span class="w"> </span><span class="no">::data</span><span class="w">
  </span><span class="p">(</span><span class="nf">s/and</span><span class="w"> </span><span class="n">int?</span><span class="w"> </span><span class="n">some-complidated-check</span><span class="p">))</span><span class="w">

</span><span class="p">(</span><span class="nf">sth/explain</span><span class="w"> </span><span class="no">::data</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w">

</span><span class="p">{</span><span class="no">:problems</span><span class="w">
 </span><span class="p">[{</span><span class="no">:message</span><span class="w"> </span><span class="s">"The value did't match that complicated check."</span><span class="w">  </span><span class="c1">;; &lt;&lt;&lt;</span><span class="w">
   </span><span class="no">:path</span><span class="w"> </span><span class="p">[]</span><span class="w">
   </span><span class="no">:val</span><span class="w"> </span><span class="mi">-1</span><span class="p">}]}</span><span class="w">

</span><span class="c1">;;</span><span class="w">
</span><span class="c1">;; The message can be a function</span><span class="w">
</span><span class="c1">;;</span><span class="w">
</span><span class="p">(</span><span class="nf">sth/def</span><span class="w"> </span><span class="no">:user/email</span><span class="w">
  </span><span class="p">(</span><span class="k">fn</span><span class="w"> </span><span class="p">[{</span><span class="no">:as</span><span class="w"> </span><span class="n">problem</span><span class="w">
        </span><span class="no">:keys</span><span class="w"> </span><span class="p">[</span><span class="nb">path</span><span class="w"> </span><span class="n">pred</span><span class="w"> </span><span class="nb">val</span><span class="w"> </span><span class="n">via</span><span class="w"> </span><span class="n">in</span><span class="p">]}]</span><span class="w">
    </span><span class="p">(</span><span class="nf">format</span><span class="w"> </span><span class="s">"Custom error message for email, pred: %s"</span><span class="w"> </span><span class="n">pred</span><span class="p">)))</span><span class="w">

</span><span class="p">(</span><span class="nf">sth/explain-data</span><span class="w">
  </span><span class="no">::user</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="no">:email</span><span class="w"> </span><span class="s">"wrong-string"</span><span class="p">))</span><span class="w">

</span><span class="p">{</span><span class="no">:problems</span><span class="w">
 </span><span class="p">[{</span><span class="no">:message</span><span class="w">
   </span><span class="s">"Custom error message for email, pred: (clojure.core/partial clojure.core/re-matches #\"(.+?)@(.+?)\")"</span><span class="w">  </span><span class="c1">;; &lt;&lt;&lt;</span><span class="w">
   </span><span class="no">:path</span><span class="w"> </span><span class="p">[</span><span class="no">:email</span><span class="p">]</span><span class="w">
   </span><span class="no">:val</span><span class="w"> </span><span class="s">"wrong-string"</span><span class="p">}]}</span><span class="w">

</span><span class="c1">;;</span><span class="w">
</span><span class="c1">;; Formatted output:</span><span class="w">
</span><span class="c1">;;</span><span class="w">
</span><span class="p">(</span><span class="nf">sth/explain</span><span class="w">
  </span><span class="no">::user</span><span class="w"> </span><span class="p">(</span><span class="nb">dissoc</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="no">:age</span><span class="p">))</span><span class="w">

</span><span class="c1">;; Problems:</span><span class="w">
</span><span class="c1">;;</span><span class="w">
</span><span class="c1">;; - The object misses the mandatory key 'age'.</span><span class="w">
</span><span class="c1">;;   path: []</span><span class="w">
</span><span class="c1">;;   value: {:name Test}</span><span class="w">

</span><span class="p">(</span><span class="nf">sth/explain-str</span><span class="w"> </span><span class="no">::user</span><span class="w"> </span><span class="p">(</span><span class="nb">dissoc</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="no">:age</span><span class="p">))</span><span class="w">
</span><span class="c1">;; returns the same output as a string</span><span class="w">

</span><span class="c1">;;</span><span class="w">
</span><span class="c1">;; Handling conformers</span><span class="w">
</span><span class="c1">;;</span><span class="w">
</span><span class="p">(</span><span class="nf">sth/def</span><span class="w"> </span><span class="o">`</span><span class="n">-&gt;int</span><span class="w">
  </span><span class="s">"Cannot coerce the value to an integer."</span><span class="p">)</span><span class="w">

</span><span class="p">(</span><span class="nf">s/def</span><span class="w"> </span><span class="no">::config</span><span class="w">
  </span><span class="p">(</span><span class="nf">s/keys</span><span class="w"> </span><span class="no">:req-un</span><span class="w"> </span><span class="p">[</span><span class="no">:config/port</span><span class="w">
                   </span><span class="no">:config/timeout</span><span class="p">]))</span><span class="w">

</span><span class="p">(</span><span class="nf">s/def</span><span class="w"> </span><span class="no">:config/port</span><span class="w">
  </span><span class="p">(</span><span class="nf">s/conformer</span><span class="w"> </span><span class="n">-&gt;int</span><span class="p">))</span><span class="w">

</span><span class="p">(</span><span class="nf">s/def</span><span class="w"> </span><span class="no">:config/timeout</span><span class="w">
  </span><span class="p">(</span><span class="nf">s/conformer</span><span class="w"> </span><span class="n">-&gt;int</span><span class="p">))</span><span class="w">

</span><span class="p">(</span><span class="nf">sth/explain-data</span><span class="w">
  </span><span class="no">::config</span><span class="w"> </span><span class="p">{</span><span class="no">:port</span><span class="w"> </span><span class="s">"five"</span><span class="w"> </span><span class="no">:timeout</span><span class="w"> </span><span class="s">"dunno"</span><span class="p">})</span><span class="w">

</span><span class="p">{</span><span class="no">:problems</span><span class="w">
  </span><span class="p">[{</span><span class="no">:message</span><span class="w"> </span><span class="s">"Cannot coerce the value to an integer."</span><span class="w">  </span><span class="c1">;; &lt;&lt;&lt;</span><span class="w">
    </span><span class="no">:path</span><span class="w"> </span><span class="p">[</span><span class="no">:port</span><span class="p">]</span><span class="w">
    </span><span class="no">:val</span><span class="w"> </span><span class="s">"five"</span><span class="p">}</span><span class="w">
   </span><span class="p">{</span><span class="no">:message</span><span class="w"> </span><span class="s">"Cannot coerce the value to an integer."</span><span class="w">  </span><span class="c1">;; &lt;&lt;&lt;</span><span class="w">
    </span><span class="no">:path</span><span class="w"> </span><span class="p">[</span><span class="no">:timeout</span><span class="p">]</span><span class="w">
    </span><span class="no">:val</span><span class="w"> </span><span class="s">"dunno"</span><span class="p">}]}</span><span class="w">
</span></code></pre></div></div>

<p>For more examples, see <a href="https://github.com/igrishaev/soothe/blob/master/test/soothe/core_test.cljc">the unit tests</a>.</p>

<h2 id="the-api">The API</h2>

<p>Define a message for a spec or a predicate using the <code class="language-plaintext highlighter-rouge">soothe.core/def</code> function:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">my-predicate</span><span class="w"> </span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="w">
  </span><span class="n">...</span><span class="p">)</span><span class="w">

</span><span class="p">(</span><span class="nf">sth/def</span><span class="w"> </span><span class="o">`</span><span class="n">my-predicate</span><span class="w"> </span><span class="s">"Some message"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>Use fully-qualified symbols, not simple ones. In the example above, the backtick
expands the symbol to the full form (with the current namespace).</p>

<p>Defining a message for a spec:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">s/def</span><span class="w"> </span><span class="no">::user</span><span class="w"> </span><span class="p">(</span><span class="nf">s/keys</span><span class="w"> </span><span class="n">...</span><span class="p">))</span><span class="w">
</span><span class="p">(</span><span class="nf">sth/def</span><span class="w"> </span><span class="no">::user</span><span class="w"> </span><span class="s">"Message for the user spec"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>The message might be a function that takes a preblem map and returns a string:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">sth/def</span><span class="w"> </span><span class="no">::user</span><span class="w">
  </span><span class="p">(</span><span class="k">fn</span><span class="w"> </span><span class="p">[</span><span class="n">problem</span><span class="p">]</span><span class="w">
    </span><span class="p">(</span><span class="nf">format</span><span class="w"> </span><span class="s">"A custom message ... %s"</span><span class="w"> </span><span class="n">...</span><span class="p">)))</span><span class="w">
</span></code></pre></div></div>

<p>The library handles the case when the predicate is wrapped into the
<code class="language-plaintext highlighter-rouge">s/conformer</code> spec. Soothe tries to find a message for the nested predicate if
possible:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">-&gt;int</span><span class="w">
  </span><span class="p">[</span><span class="nb">val</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="k">cond</span><span class="w">
    </span><span class="p">(</span><span class="nf">int?</span><span class="w"> </span><span class="nb">val</span><span class="p">)</span><span class="w">
    </span><span class="nb">val</span><span class="w">
    </span><span class="p">(</span><span class="nb">string?</span><span class="w"> </span><span class="nb">val</span><span class="p">)</span><span class="w">
    </span><span class="c1">;; (... try to parse the string ...)</span><span class="w">
    </span><span class="no">:else</span><span class="w">
    </span><span class="no">::s/invalid</span><span class="p">))</span><span class="w">

</span><span class="p">(</span><span class="nf">s/def</span><span class="w"> </span><span class="no">::port</span><span class="w"> </span><span class="n">-&gt;int</span><span class="p">)</span><span class="w">

</span><span class="p">(</span><span class="nf">sth/def</span><span class="w"> </span><span class="o">`</span><span class="n">-&gt;int</span><span class="w"> </span><span class="s">"Cannot coerce the value to an integer."</span><span class="p">)</span><span class="w">

</span><span class="p">(</span><span class="nf">sth/explain-data</span><span class="w"> </span><span class="no">::port</span><span class="w"> </span><span class="s">"dunno"</span><span class="p">)</span><span class="w">
</span><span class="c1">;; you'll get "Cannot coerce the value to an integer."</span><span class="w">
</span></code></pre></div></div>

<h3 id="special-messages">Special messages</h3>

<p>There are two <em>special messages</em> at the moment. The first one is the
<code class="language-plaintext highlighter-rouge">:soothe.core/missing-key</code> keyword which is used when a map misses a key. The
default implementation is:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">:soothe.core/missing-key</span><span class="w">
</span><span class="p">(</span><span class="k">fn</span><span class="w"> </span><span class="p">[{</span><span class="no">:keys</span><span class="w"> </span><span class="p">[</span><span class="nb">key</span><span class="p">]}]</span><span class="w">
  </span><span class="p">(</span><span class="nf">format</span><span class="w"> </span><span class="s">"The object misses the mandatory key '%s'."</span><span class="w">
          </span><span class="p">(</span><span class="nb">-&gt;</span><span class="w"> </span><span class="nb">key</span><span class="w"> </span><span class="nb">str</span><span class="w"> </span><span class="p">(</span><span class="nb">subs</span><span class="w"> </span><span class="mi">1</span><span class="p">))))</span><span class="w">
</span></code></pre></div></div>

<p>The library adds the <code class="language-plaintext highlighter-rouge">key</code> field into the problem map when detecting this case.</p>

<p>The second special message is <code class="language-plaintext highlighter-rouge">:soothe.core/default</code>. The default implementation
is just a string <code class="language-plaintext highlighter-rouge">"The value is incorrect."</code> You’re welcome to register a
function for that key with a custom function.</p>

<p>Use <code class="language-plaintext highlighter-rouge">(sth/def-many {...})</code> function to define several key/message pairs at once
passing them as a map. The <code class="language-plaintext highlighter-rouge">(sth/undef ...)</code> function removes a message for the
passed key. To wipe all the messages, use <code class="language-plaintext highlighter-rouge">(sth/undef-all)</code>.</p>

<h2 id="pre-defined-messages--localization">Pre-defined messages &amp; Localization</h2>

<p>The library ships predefined messages for all the <code class="language-plaintext highlighter-rouge">clojure.core</code> predicates:
<code class="language-plaintext highlighter-rouge">int?</code>, <code class="language-plaintext highlighter-rouge">string?</code>, <code class="language-plaintext highlighter-rouge">uuid?</code> and so forth. They locate in the <a href="https://github.com/igrishaev/soothe/blob/master/src/soothe/en.cljc">en.cljs module</a>
wich gets loaded automatically once you import <code class="language-plaintext highlighter-rouge">soothe.core</code>.</p>

<p>There is also a Russian version of the messages provided with the <code class="language-plaintext highlighter-rouge">soothe.ru</code>
module. Once loaded, it overrides the messages in the registry. Just import it
somewhere in your project:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">ns</span><span class="w"> </span><span class="n">...</span><span class="w">
  </span><span class="p">(</span><span class="no">:require</span><span class="w">
    </span><span class="p">[</span><span class="n">soothe.core</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">sth</span><span class="p">]</span><span class="w">
    </span><span class="n">soothe.ru</span><span class="w"> </span><span class="c1">;; RU messages for spec</span><span class="w">
    </span><span class="n">...</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<p>You’re welcome to submit your localized messages with a pull request.</p>

<h2 id="clojurescript">ClojureScript</h2>

<p>Soothe is fully compatible with ClojureScript and thus can be used on the
frontend.</p>

<h2 id="best-practices--known-cases">Best practices &amp; Known cases</h2>

<ul>
  <li>Declare the messages right after you’re declared the specs or predicates, for
example:</li>
</ul>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">s/def</span><span class="w"> </span><span class="no">::my-spec</span><span class="w"> </span><span class="n">...</span><span class="p">)</span><span class="w"> </span><span class="c1">;; your spec</span><span class="w">
</span><span class="p">(</span><span class="nf">sth/def</span><span class="w"> </span><span class="no">::my-spec</span><span class="w"> </span><span class="s">"..."</span><span class="p">)</span><span class="w"> </span><span class="c1">;; the message</span><span class="w">

</span><span class="c1">;; or</span><span class="w">

</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">check-email</span><span class="w"> </span><span class="p">[</span><span class="n">string</span><span class="p">]</span><span class="n">...</span><span class="p">)</span><span class="w">
</span><span class="p">(</span><span class="nf">sth/def</span><span class="w"> </span><span class="o">`</span><span class="n">check-email</span><span class="w"> </span><span class="s">"..."</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>But don’t put them in another namespace.</p>

<ul>
  <li>Some specs spoil the predicates, for example, <code class="language-plaintext highlighter-rouge">s/coll-of</code>. Imagine you have a
spec like this one:</li>
</ul>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">s/def</span><span class="w"> </span><span class="no">::my-items</span><span class="w"> </span><span class="p">(</span><span class="nf">s/coll-of</span><span class="w"> </span><span class="n">int?</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<p>Now, if one of the items fails, the predicate will be not <code class="language-plaintext highlighter-rouge">'clojure.core/int?</code>
but just a <code class="language-plaintext highlighter-rouge">'int?</code> which leads to the default error message. To handle this,
bind the predicate to a spec and pass the spec:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">s/def</span><span class="w"> </span><span class="no">::int?</span><span class="w"> </span><span class="n">int?</span><span class="p">)</span><span class="w">
</span><span class="p">(</span><span class="nf">s/def</span><span class="w"> </span><span class="no">::my-items</span><span class="w"> </span><span class="p">(</span><span class="nf">s/coll-of</span><span class="w"> </span><span class="no">::int?</span><span class="p">))</span><span class="w">
</span><span class="p">(</span><span class="nf">sth/def</span><span class="w"> </span><span class="no">::int?</span><span class="w"> </span><span class="s">"The value must be an integer."</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>With this approach, the library will return the right error message.</p>

<hr />

<p>Ivan Grishaev, 2021</p>

  </div>

</article>

<center>
    <p>
        <small>Нашли ошибку? Выделите мышкой и нажмите Ctrl/&#8984;+Enter</small>
    </p>
</center>






<center>Комментариев пока нет</center>









<form id="comment-form" method="POST" action="https://functions.yandexcloud.net/d4ehfuf08fjfjr59ivnf">

    <div class="block">
        <p class="comment-form-label"><small>Your name</small></p>
        <input required id="comment-form-author" name="author" type="text">
    </div>

    <div class="block">
        <p class="comment-form-label"><small>Comment (markdown syntax)</small></p>
        <textarea required id="comment-form-comment" name="comment"></textarea>
    </div>

    <input required name="path" type="hidden" value="/en/soothe/">
    <input required name="captcha" type="hidden" value="9 &#215; 3">

    <div class="block">
        <span class="comment-form-label"><small>9 &#215; 3 = </small></span>
        <input required id="comment-form-solution" name="solution" type="text">
    </div>

    <div class="block">
        <button id="comment-form-send" type="submit">Send</button>
    </div>

</form>


      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Ivan Grishaev's blog</li>
          <li><a href="mailto:ivan@grishaev.me">ivan@grishaev.me</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
            <li><a href="https://github.com/igrishaev">GitHub</a></li>
            <li><a href="tg://resolve?domain=igrishaev_blog">Telegram</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Writing on programming, education, books and negotiations.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
