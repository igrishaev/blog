<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>PG docs, part 8. HoneySQL</title>
  <meta name="description" content="">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/custom.css">
  <link rel="canonical" href="https://grishaev.me/en/pg-docs/08/">
  <link rel="alternate" type="application/rss+xml" title="Ivan Grishaev's blog" href="https://grishaev.me/feed.xml">

  <link rel="shortcut icon" type="image/x-icon" href="/assets/static/favicons/favicon.ico">

  <script type="text/javascript" src="/assets/typo.js"></script>

</head>


  <body>
    <header class="site-header">

    <div class="wrapper flex-container">

        <div>
            <a href="/">
                <img id="avatar" src="/assets/static/avatar.jpg" alt="Ivan Grishaev">
            </a>
        </div>

        <div class="flex-container-vert" style="margin-left: 15px; width: 80%">

            <div class="flex-container full-width">
                <p style="margin-bottom: 5px">Ivan Grishaev's blog</p>
                <div class="flex-huge"></div>
                <div >
<form id="search-form"
      target="_blank"
      style="display: inline"
      method="get"
      action="https://www.google.com/search">

    <input name="sitesearch"
           value="grishaev.me"
           type="hidden">

    <input type="text"
           required="required"
           name="q"
           placeholder="Google search..."
           autocomplete="off">

    <button style="border: none; background-color: transparent; cursor: pointer;"
            type="submit">&#x1f50d;</button>

</form>
</div>
            </div>

            <p><small>Writing on programming, education, books and negotiations.
</small></p>

            <div class="flex-container">
                <a class="menu-item" href="/">Home</a>
                <a class="menu-item" href="/about/">About</a>
                <a class="menu-item" href="/bookshelf/">Bookshelf</a>
                <a class="menu-item" href="/feed.xml">RSS</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor" href="/tag/clojure/">Clojure</a>
                <a class="menu-item minor" href="/tag/emacs/">Emacs</a>
                <a class="menu-item minor" href="/tag/python/">Python</a>
                <a class="menu-item minor" href="/tag/programming/">Programming</a>
                <a class="menu-item minor" href="/interview/">Interview</a>
                <a class="menu-item minor" href="/video/">Video</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor hl" href="/clojure-in-prod/">Книга «Clojure на производстве»</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor hl" href="/clojure-in-prod-2/">Книга «Clojure на производстве», второй том</a>
            </div>

        </div>
    </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">

    <h1 class="post-title" itemprop="name headline">PG docs, part 8. HoneySQL</h1>

    
<div class="post-meta">

    <time class="post-time"
          datetime="2023-10-31T00:00:00+00:00">
        Oct 31, 2023
    </time>

    <a href="/tag/clojure/" rel="tag">clojure</a>, <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/postgres/" rel="tag">postgres</a>, <a href="/tag/sql/" rel="tag">sql</a>, <a href="/tag/honeysql/" rel="tag">honeysql</a>

</div>


  </header>

  <div class="post-content" itemprop="articleBody">
    
<p><em>(This is a new documentation chapter from the <a href="https://github.com/igrishaev/pg">PG project</a>.)</em></p>

<p><strong>ToC</strong></p>

<ul>
  <li><a href="/en/pg-docs/01/">About &amp; Installation</a></li>
  <li><a href="/en/pg-docs/02/">The Client</a></li>
  <li><a href="/en/pg-docs/03/">Connection Pool</a></li>
  <li><a href="/en/pg-docs/04/">Arrays</a></li>
  <li><a href="/en/pg-docs/05/">Notifications</a></li>
  <li><a href="/en/pg-docs/06/">SSL</a></li>
  <li><a href="/en/pg-docs/07/">COPY</a></li>
  <li><a href="/en/pg-docs/08/">HoneySQL</a></li>
</ul>

<p>In this chapter:</p>

<!-- toc -->

<ul>
  <li><a href="#about">About</a></li>
  <li><a href="#installation">Installation</a></li>
  <li><a href="#usage">Usage</a></li>
</ul>

<!-- tocstop -->

<p><a href="https://github.com/seancorfield/honeysql">HoneySQL</a> is a well-known library for building SQL expressions from
Clojure maps. It’s convenient for making complex queries, for example, when you
have optional JOIN operators. Or you’re unaware of the final WHERE conditions as
the filtering parameters come from the request. HoneySQL frees you from building
raw SQL queries by concatenating strings, which is unsafe and leads to SQL
injections.</p>

<p>The <code class="language-plaintext highlighter-rouge">pg-honey</code> is a small wrapper on top of HoneySQL. It provides special
versions of <code class="language-plaintext highlighter-rouge">query</code> and <code class="language-plaintext highlighter-rouge">execute</code> functions that accept not a SQL string but
Clojure maps. The maps get transformed into SQL under the hood and get executed.</p>

<h2 id="installation">Installation</h2>

<p>Install the <code class="language-plaintext highlighter-rouge">pg-honey</code> package as follows.</p>

<p>Lein:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="n">com.github.igrishaev/pg-honey</span><span class="w"> </span><span class="s">"0.1.10"</span><span class="p">]</span><span class="w">
</span></code></pre></div></div>

<p>Deps:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="n">com.github.igrishaev/pg-honey</span><span class="w"> </span><span class="p">{</span><span class="no">:mvn/version</span><span class="w"> </span><span class="s">"0.1.10"</span><span class="p">}}</span><span class="w">
</span></code></pre></div></div>

<h2 id="usage">Usage</h2>

<p>Import the library:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">require</span><span class="w"> </span><span class="o">'</span><span class="p">[</span><span class="n">pg.honey</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">pgh</span><span class="p">])</span><span class="w">
</span></code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">query</code> function accepts a connection object, a Clojure map representing a
query and a map of options.</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pgh/query</span><span class="w">
  </span><span class="n">conn</span><span class="w">
  </span><span class="p">{</span><span class="no">:select</span><span class="w"> </span><span class="p">[</span><span class="no">:*</span><span class="p">]</span><span class="w"> </span><span class="no">:from</span><span class="w"> </span><span class="p">[</span><span class="no">:users</span><span class="p">]}</span><span class="w">
  </span><span class="p">{</span><span class="no">:pretty</span><span class="w"> </span><span class="n">true</span><span class="w">
   </span><span class="no">:as</span><span class="w"> </span><span class="n">as/first</span><span class="p">})</span><span class="w">
</span></code></pre></div></div>

<p>The third parameter combines HoneySQL parameters and the standard <code class="language-plaintext highlighter-rouge">query</code>
options. In the example above, we passed a custom reducer into the <code class="language-plaintext highlighter-rouge">:as</code>
parameter, and we also specified the <code class="language-plaintext highlighter-rouge">:pretty</code> HoneySQL option to true. With the
pretty flag enabled, HoneySQL produces a formatted SQL expression, which is
easier to read in logs.</p>

<p>Please note: since the <code class="language-plaintext highlighter-rouge">query</code> function doesn’t allow you to pass any
parameters, the following example will lead to an error response:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pgh/query</span><span class="w">
  </span><span class="n">conn</span><span class="w">
  </span><span class="p">{</span><span class="no">:select</span><span class="w"> </span><span class="p">[</span><span class="no">:*</span><span class="p">]</span><span class="w"> </span><span class="no">:from</span><span class="w"> </span><span class="p">[</span><span class="no">:users</span><span class="p">]</span><span class="w"> </span><span class="no">:where</span><span class="w"> </span><span class="p">[</span><span class="no">:=</span><span class="w"> </span><span class="no">:id</span><span class="w"> </span><span class="mi">42</span><span class="p">]}</span><span class="w">
  </span><span class="p">{</span><span class="no">:pretty</span><span class="w"> </span><span class="n">true</span><span class="w">
   </span><span class="no">:as</span><span class="w"> </span><span class="n">as/first</span><span class="p">})</span><span class="w">
</span></code></pre></div></div>

<p>This is a limitation of the PostgreSQL wire protocol: the <code class="language-plaintext highlighter-rouge">Query</code> message bears
only a pure SQL expression with no parameters. For parameters, use the <code class="language-plaintext highlighter-rouge">execute</code>
function described below.</p>

<p>The <code class="language-plaintext highlighter-rouge">execute</code> function acts the same but accepts a Clojure map that might have
values that become parameters when rendering the map. Here is an example:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pgh/execute</span><span class="w">
  </span><span class="n">conn</span><span class="w">
  </span><span class="p">{</span><span class="no">:select</span><span class="w"> </span><span class="p">[</span><span class="no">:*</span><span class="p">]</span><span class="w"> </span><span class="no">:from</span><span class="w"> </span><span class="p">[</span><span class="no">:users</span><span class="p">]</span><span class="w"> </span><span class="no">:where</span><span class="w"> </span><span class="p">[</span><span class="no">:=</span><span class="w"> </span><span class="no">:id</span><span class="w"> </span><span class="mi">42</span><span class="p">]}</span><span class="w">
  </span><span class="p">{</span><span class="no">:pretty</span><span class="w"> </span><span class="n">true</span><span class="w">
   </span><span class="no">:as</span><span class="w"> </span><span class="n">as/first</span><span class="p">})</span><span class="w">
</span></code></pre></div></div>

<p>Or:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pgh/execute</span><span class="w">
  </span><span class="n">conn</span><span class="w">
  </span><span class="p">{</span><span class="no">:insert-into</span><span class="w"> </span><span class="no">:demo</span><span class="w">
   </span><span class="no">:values</span><span class="w"> </span><span class="p">[{</span><span class="no">:id</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="no">:title</span><span class="w"> </span><span class="s">"test1"</span><span class="p">}</span><span class="w">
            </span><span class="p">{</span><span class="no">:id</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="no">:title</span><span class="w"> </span><span class="s">"test2"</span><span class="p">}</span><span class="w">
            </span><span class="p">{</span><span class="no">:id</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="no">:title</span><span class="w"> </span><span class="s">"test3"</span><span class="p">}]}</span><span class="w">
  </span><span class="p">{</span><span class="no">:pretty</span><span class="w"> </span><span class="n">true</span><span class="p">})</span><span class="w">
</span></code></pre></div></div>

<p>Under the hood, the <code class="language-plaintext highlighter-rouge">{:inset-into ...}</code> map gets rendered into a SQL vector:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="s">"insert into ... values ($1, $2), ($3, $4), ($5, $6)"</span><span class="w">
 </span><span class="mi">1</span><span class="w"> </span><span class="s">"test1"</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="s">"test2"</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="s">"test3"</span><span class="p">]</span><span class="w">
</span></code></pre></div></div>

<p>It gets split on the SQL expression and the parameters, which are passed into
the underlying <code class="language-plaintext highlighter-rouge">pg.client/execute</code> function.</p>

<p>You can use named parameters that HoneySQL does support. Place a specific
keyword into the <code class="language-plaintext highlighter-rouge">[:param ...]</code> vector, and pass a map of params into the
options as follows:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pgh/execute</span><span class="w"> </span><span class="n">conn</span><span class="w">
             </span><span class="p">{</span><span class="no">:select</span><span class="w"> </span><span class="p">[</span><span class="no">:id</span><span class="w"> </span><span class="no">:title</span><span class="p">]</span><span class="w">
              </span><span class="no">:from</span><span class="w"> </span><span class="p">[</span><span class="no">:demo</span><span class="p">]</span><span class="w">
              </span><span class="no">:where</span><span class="w"> </span><span class="p">[</span><span class="no">:and</span><span class="w">
                      </span><span class="p">[</span><span class="no">:=</span><span class="w"> </span><span class="no">:id</span><span class="w"> </span><span class="mi">2</span><span class="p">]</span><span class="w">
                      </span><span class="p">[</span><span class="no">:=</span><span class="w"> </span><span class="no">:title</span><span class="w"> </span><span class="p">[</span><span class="no">:param</span><span class="w"> </span><span class="no">:title</span><span class="p">]]]}</span><span class="w">
             </span><span class="p">{</span><span class="no">:pretty</span><span class="w"> </span><span class="n">true</span><span class="w">
              </span><span class="no">:params</span><span class="w"> </span><span class="p">{</span><span class="no">:title</span><span class="w"> </span><span class="s">"test2"</span><span class="p">}})</span><span class="w">
</span></code></pre></div></div>

<p>To familiarise yourself with HoneySQL features, please refer to the <a href="https://github.com/seancorfield/honeysql">official
documentation</a>.</p>

    
<div class="prev-next">

    <div class="prev-next-left">
    
        <p><small><a href="/en/virtuoso/">&larr; Virtuoso: a Clojure wrapper for virtual threads</a></small></p>
    
    </div>

    <div class="prev-next-mid">
    </div>

    <div class="prev-next-right">
    
        <p><small><a href="/sobes/">Неудавшийся собес &rarr;</a></small></p>
    
    </div>

</div>

  </div>

</article>

<center>
    <p>
        <small>Нашли ошибку? Выделите мышкой и нажмите Ctrl/&#8984;+Enter</small>
    </p>
</center>






<center>Комментариев пока нет</center>









<form id="comment-form" method="POST" action="https://functions.yandexcloud.net/d4ehfuf08fjfjr59ivnf">

    <div class="block">
        <p class="comment-form-label"><small>Your name</small></p>
        <input required id="comment-form-author" name="author" type="text">
    </div>

    <div class="block">
        <p class="comment-form-label"><small>Comment (markdown syntax)</small></p>
        <textarea required id="comment-form-comment" name="comment"></textarea>
    </div>

    <input required name="path" type="hidden" value="/en/pg-docs/08/">
    <input required name="captcha" type="hidden" value="7 &#215; 6">

    <div class="block">
        <span class="comment-form-label"><small>7 &#215; 6 = </small></span>
        <input required id="comment-form-solution" name="solution" type="text">
    </div>

    <div class="block">
        <button id="comment-form-send" type="submit">Send</button>
    </div>

</form>


      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Ivan Grishaev's blog</li>
          <li><a href="mailto:ivan@grishaev.me">ivan@grishaev.me</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
            <li><a href="https://github.com/igrishaev">GitHub</a></li>
            <li><a href="https://t.me/igrishaev_blog">Telegram</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Writing on programming, education, books and negotiations.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
