<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>PG docs, part 1</title>
  <meta name="description" content="TL;DR: I’m writing a Postgres driver in pure Clojure. In general, works! Now Iproceed with the most miserable part of the project: writing documentation. Ide...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/custom.css">
  <link rel="canonical" href="https://grishaev.me/en/pg-docs/01/">
  <link rel="alternate" type="application/rss+xml" title="Ivan Grishaev's blog" href="https://grishaev.me/feed.xml">

  <link rel="shortcut icon" type="image/x-icon" href="/assets/static/favicons/favicon.ico">

  <script type="text/javascript" src="/assets/typo.js"></script>

</head>


  <body>
    <header class="site-header">

    <div class="wrapper flex-container">

        <div>
            <a href="/">
                <img id="avatar" src="/assets/static/avatar.jpg" alt="Ivan Grishaev">
            </a>
        </div>

        <div class="flex-container-vert" style="margin-left: 15px; width: 80%">

            <div class="flex-container full-width">
                <p style="margin-bottom: 5px">Ivan Grishaev's blog</p>
                <div class="flex-huge"></div>
                <div >
<form id="search-form"
      target="_blank"
      style="display: inline"
      method="get"
      action="https://www.google.com/search">

    <input name="sitesearch"
           value="grishaev.me"
           type="hidden">

    <input type="text"
           required="required"
           name="q"
           placeholder="Google search..."
           autocomplete="off">

    <button style="border: none; background-color: transparent; cursor: pointer;"
            type="submit">&#x1f50d;</button>

</form>
</div>
            </div>

            <p><small>Writing on programming, education, books and negotiations.
</small></p>

            <div class="flex-container">
                <a class="menu-item" href="/">Home</a>
                <a class="menu-item" href="/about/">About</a>
                <a class="menu-item" href="/bookshelf/">Bookshelf</a>
                <a class="menu-item" href="/feed.xml">RSS</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor" href="/tag/clojure/">Clojure</a>
                <a class="menu-item minor" href="/tag/emacs/">Emacs</a>
                <a class="menu-item minor" href="/tag/python/">Python</a>
                <a class="menu-item minor" href="/tag/programming/">Programming</a>
                <a class="menu-item minor" href="/interview/">Interview</a>
                <a class="menu-item minor" href="/video/">Video</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor hl" href="/clojure-in-prod/">Книга «Clojure на производстве»</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor hl" href="/clojure-in-prod-2/">Книга «Clojure на производстве», второй том</a>
            </div>

        </div>
    </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">

    <h1 class="post-title" itemprop="name headline">PG docs, part 1</h1>

    
<div class="post-meta">

    <time class="post-time"
          datetime="2023-08-28T00:00:00+00:00">
        Aug 28, 2023
    </time>

    <a href="/tag/clojure/" rel="tag">clojure</a>, <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/postgres/" rel="tag">postgres</a>, <a href="/tag/sql/" rel="tag">sql</a>

</div>


  </header>

  <div class="post-content" itemprop="articleBody">
    <p><em>TL;DR: I’m writing a Postgres driver in pure Clojure. In general, works! Now I
proceed with the most miserable part of the project: writing documentation. I
decided to do it step by step and share it on my blog.</em></p>

<p><strong>ToC</strong></p>

<ul>
  <li><a href="/en/pg-docs/01/">About &amp; Installation</a></li>
  <li><a href="/en/pg-docs/02/">The Client</a></li>
  <li><a href="/en/pg-docs/03/">Connection Pool</a></li>
  <li><a href="/en/pg-docs/04/">Arrays</a></li>
  <li><a href="/en/pg-docs/05/">Notifications</a></li>
  <li><a href="/en/pg-docs/06/">SSL</a></li>
  <li><a href="/en/pg-docs/07/">COPY</a></li>
  <li><a href="/en/pg-docs/08/">HoneySQL</a></li>
</ul>

<h2 id="about">About</h2>

<p><a href="https://github.com/igrishaev/pg">This project</a> is a set of libraries related to the <a href="https://www.postgresql.org/">PostgreSQL</a>
database. The primary library called <code class="language-plaintext highlighter-rouge">pg-client</code> is a driver for Postgres
written in pure Clojure. By purity I mean, neither JDBC nor any other
third-party Java libraries are involved. Everything is driven by a TCP socket
and implementation of the Posrgres Wire protocol. Fun!</p>

<p>Besides the client, the project provides such various additions as a connection
pool (see <code class="language-plaintext highlighter-rouge">pg-pool</code>). The <code class="language-plaintext highlighter-rouge">pg-types</code> library holds the encoding and decoding
logic which determines how to write and read Clojure data from and into the
database. You can use this library separately in pair with JDBC.next and <code class="language-plaintext highlighter-rouge">COPY</code>
for efficient data transcoding in binary format.</p>

<p>The question you would probably ask is, why would create a Postgres client from
scratch? JDBC has been around for decades, and there are also good
<code class="language-plaintext highlighter-rouge">clojure.java.jdbc</code> and <code class="language-plaintext highlighter-rouge">jdbc.next</code> wrappers on top of it?</p>

<p>The answer is: that although these two libraries are amazing, they don’t
disclose all Postgres features. JDBC is an abstraction whose main goal is to
satisfy all the DB engines. A general library that works with MS SQL, MySQL, and
Postgres at the same time would reduce the variety of features each backend is
capable of.</p>

<!-- more -->

<p>Postgres is a great database that brings <em>an enormous amount</em> of features. I’ve
been working with Postgres a lot and in each project, I had to invent a wheel
from scratch: add JSON support, type mapping, smart <code class="language-plaintext highlighter-rouge">ResultSet</code> processing, and
so on. I strongly believe there should be a client that pairs Clojure with
Postgres seamlessly when all the features are available out of the box.</p>

<p>Here is a brief list of the benefits of this project:</p>

<ul>
  <li>
    <p>Written in pure Clojure and thus is completely transparent for users and
developers;</p>
  </li>
  <li>
    <p>Supports a lot of Clojure and Java types including <code class="language-plaintext highlighter-rouge">java.time.*</code> (see the
dedicated section in the documentation);</p>
  </li>
  <li>
    <p>Extendable encoding and decoding: adding a new type means just extending a
multimethod;</p>
  </li>
  <li>
    <p>Implements both <strong>Simple</strong> and <strong>Extended</strong> Postgres Wire protocols;</p>
  </li>
  <li>
    <p>Implements both <strong>text</strong> and <strong>binary</strong> content encoding and decoding;</p>
  </li>
  <li>
    <p>Easy to debug what goes through the wire;</p>
  </li>
  <li>
    <p>Reducing the result on the fly, custom reducers; various ways to process the
data;</p>
  </li>
  <li>
    <p>SAML authentication out from the box; JDBC still fails when handling it
(“unknown auth code 10”);</p>
  </li>
  <li>
    <p>Tested with Postgres 11, 12, 13, 14, 15, and 16-beta (integration tests with
multiple Docker images);</p>
  </li>
  <li>
    <p>And more.</p>
  </li>
</ul>

<h2 id="installation">Installation</h2>

<h3 id="general-notes">General Notes</h3>

<p>Although PG is a set of modules, they all have the same version when deployed to
Clojars. For example:</p>

<p>Lein:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="n">com.github.igrishaev/pg-client</span><span class="w"> </span><span class="s">"0.1.6"</span><span class="p">]</span><span class="w">
</span><span class="p">[</span><span class="n">com.github.igrishaev/pg-pool</span><span class="w"> </span><span class="s">"0.1.6"</span><span class="p">]</span><span class="w">
</span></code></pre></div></div>

<p>Deps:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="n">com.github.igrishaev/pg-client</span><span class="w"> </span><span class="p">{</span><span class="no">:mvn/version</span><span class="w"> </span><span class="s">"0.1.6"</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Lein users may specify a global <code class="language-plaintext highlighter-rouge">pg-version</code> variable on top of the
<code class="language-plaintext highlighter-rouge">project.clj</code> and reference it as follows:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">;; project.clj</span><span class="w">
</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">pg-version</span><span class="w"> </span><span class="s">"0.1.6"</span><span class="p">)</span><span class="w">

</span><span class="p">(</span><span class="nf">defproject</span><span class="w"> </span><span class="n">...</span><span class="w">
  </span><span class="no">:dependencies</span><span class="w">
  </span><span class="p">[</span><span class="n">...</span><span class="w">
   </span><span class="p">[</span><span class="n">com.github.igrishaev/pg-client</span><span class="w"> </span><span class="o">~</span><span class="n">pg-version</span><span class="p">]</span><span class="w">
   </span><span class="p">[</span><span class="n">com.github.igrishaev/pg-pool</span><span class="w"> </span><span class="o">~</span><span class="n">pg-version</span><span class="p">]])</span><span class="w">
</span></code></pre></div></div>

<p>Usually, you don’t need to specify more than one package because they depend on
each other and will be download automatically.</p>

<h3 id="client">Client</h3>

<p>The <code class="language-plaintext highlighter-rouge">pg-client</code> module ships a client access to Postgres. Since the connection
pool depends on logging facility, it’s shipped in a separate package.</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="n">com.github.igrishaev/pg-client</span><span class="w"> </span><span class="s">"0.1.6"</span><span class="p">]</span><span class="w">
</span></code></pre></div></div>

<p>Deps:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="n">com.github.igrishaev/pg-client</span><span class="w"> </span><span class="p">{</span><span class="no">:mvn/version</span><span class="w"> </span><span class="s">"0.1.6"</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h3 id="connection-pool">Connection Pool</h3>

<p>The client depends on pool so there is no need to specify it explicitly.</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="n">com.github.igrishaev/pg-pool</span><span class="w"> </span><span class="s">"0.1.6"</span><span class="p">]</span><span class="w">
</span></code></pre></div></div>

<p>Deps:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="n">com.github.igrishaev/pg-pool</span><span class="w"> </span><span class="p">{</span><span class="no">:mvn/version</span><span class="w"> </span><span class="s">"0.1.6"</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h3 id="json-extension">JSON extension</h3>

<p>A package that extends the client with reading and writing JSON objects.</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="n">com.github.igrishaev/pg-json</span><span class="w"> </span><span class="s">"0.1.6"</span><span class="p">]</span><span class="w">
</span></code></pre></div></div>

<p>Deps:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="n">com.github.igrishaev/pg-json</span><span class="w"> </span><span class="p">{</span><span class="no">:mvn/version</span><span class="w"> </span><span class="s">"0.1.6"</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h3 id="joda-time-extension">Joda Time extension</h3>

<p>Extends the client with Joda Time support.</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="n">com.github.igrishaev/pg-joda-time</span><span class="w"> </span><span class="s">"0.1.6"</span><span class="p">]</span><span class="w">
</span></code></pre></div></div>

<p>Deps:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="n">com.github.igrishaev/pg-joda-time</span><span class="w"> </span><span class="p">{</span><span class="no">:mvn/version</span><span class="w"> </span><span class="s">"0.1.6"</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

  </div>

</article>

<center>
    <p>
        <small>Нашли ошибку? Выделите мышкой и нажмите Ctrl/&#8984;+Enter</small>
    </p>
</center>






<center>Комментариев пока нет</center>









<form id="comment-form" method="POST" action="https://functions.yandexcloud.net/d4ehfuf08fjfjr59ivnf">

    <div class="block">
        <p class="comment-form-label"><small>Your name</small></p>
        <input required id="comment-form-author" name="author" type="text">
    </div>

    <div class="block">
        <p class="comment-form-label"><small>Comment (markdown syntax)</small></p>
        <textarea required id="comment-form-comment" name="comment"></textarea>
    </div>

    <input required name="path" type="hidden" value="/en/pg-docs/01/">
    <input required name="captcha" type="hidden" value="9 &#215; 6">

    <div class="block">
        <span class="comment-form-label"><small>9 &#215; 6 = </small></span>
        <input required id="comment-form-solution" name="solution" type="text">
    </div>

    <div class="block">
        <button id="comment-form-send" type="submit">Send</button>
    </div>

</form>


      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Ivan Grishaev's blog</li>
          <li><a href="mailto:ivan@grishaev.me">ivan@grishaev.me</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
            <li><a href="https://github.com/igrishaev">GitHub</a></li>
            <li><a href="tg://resolve?domain=igrishaev_blog">Telegram</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Writing on programming, education, books and negotiations.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
