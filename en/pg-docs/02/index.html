<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>PG docs, part 2</title>
  <meta name="description" content="">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/custom.css">
  <link rel="canonical" href="https://grishaev.me/en/pg-docs/02/">
  <link rel="alternate" type="application/rss+xml" title="Ivan Grishaev's blog" href="https://grishaev.me/feed.xml">

  <link rel="shortcut icon" type="image/x-icon" href="/assets/static/favicons/favicon.ico">

  <script type="text/javascript" src="/assets/typo.js"></script>

</head>


  <body>
    <header class="site-header">

    <div class="wrapper flex-container">

        <div>
            <a href="/">
                <img id="avatar" src="/assets/static/avatar.jpg" alt="Ivan Grishaev">
            </a>
        </div>

        <div class="flex-container-vert" style="margin-left: 15px; width: 80%">

            <div class="flex-container full-width">
                <p style="margin-bottom: 5px">Ivan Grishaev's blog</p>
                <div class="flex-huge"></div>
                <div >
<form id="search-form"
      target="_blank"
      style="display: inline"
      method="get"
      action="https://www.google.com/search">

    <input name="sitesearch"
           value="grishaev.me"
           type="hidden">

    <input type="text"
           required="required"
           name="q"
           placeholder="Google search..."
           autocomplete="off">

    <button style="border: none; background-color: transparent; cursor: pointer;"
            type="submit">&#x1f50d;</button>

</form>
</div>
            </div>

            <p><small>Writing on programming, education, books and negotiations.
</small></p>

            <div class="flex-container">
                <a class="menu-item" href="/">Home</a>
                <a class="menu-item" href="/about/">About</a>
                <a class="menu-item" href="/bookshelf/">Bookshelf</a>
                <a class="menu-item" href="/feed.xml">RSS</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor" href="/tag/clojure/">Clojure</a>
                <a class="menu-item minor" href="/tag/emacs/">Emacs</a>
                <a class="menu-item minor" href="/tag/python/">Python</a>
                <a class="menu-item minor" href="/tag/programming/">Programming</a>
                <a class="menu-item minor" href="/interview/">Interview</a>
                <a class="menu-item minor" href="/video/">Video</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor hl" href="/clojure-in-prod/">Книга «Clojure на производстве»</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor hl" href="/clojure-in-prod-2/">Книга «Clojure на производстве», второй том</a>
            </div>

        </div>
    </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">

    <h1 class="post-title" itemprop="name headline">PG docs, part 2</h1>

    
<div class="post-meta">

    <time class="post-time"
          datetime="2023-08-31T00:00:00+00:00">
        Aug 31, 2023
    </time>

    <a href="/tag/clojure/" rel="tag">clojure</a>, <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/postgres/" rel="tag">postgres</a>, <a href="/tag/sql/" rel="tag">sql</a>

</div>


  </header>

  <div class="post-content" itemprop="articleBody">
    
<p><strong>ToC</strong></p>

<ul>
  <li><a href="/en/pg-docs/01/">About &amp; Installation</a></li>
  <li><a href="/en/pg-docs/02/">The Client</a></li>
  <li><a href="/en/pg-docs/03/">Connection Pool</a></li>
  <li><a href="/en/pg-docs/04/">Arrays</a></li>
  <li><a href="/en/pg-docs/05/">Notifications</a></li>
  <li><a href="/en/pg-docs/06/">SSL</a></li>
</ul>

<p>In this chapter, we’ll discuss how to reach Postgres using the <a href="https://github.com/igrishaev/pg">Client library</a>.</p>

<ul>
  <li><a href="#basic-usage">Basic usage</a></li>
  <li><a href="#queries">Queries</a></li>
  <li><a href="#execute">Execute</a></li>
  <li><a href="#prepared-statements">Prepared Statements</a></li>
  <li><a href="#processing-result-with-fn-result">Processing result with :fn-result</a></li>
  <li><a href="#column-names">Column names</a></li>
  <li><a href="#column-duplicates">Column duplicates</a></li>
  <li><a href="#reducers-and-bundles">Reducers and bundles</a>
    <ul>
      <li><a href="#java">Java</a></li>
      <li><a href="#kebab-keys">Kebab-keys</a></li>
      <li><a href="#matrix">Matrix</a></li>
      <li><a href="#index-by">Index by</a></li>
      <li><a href="#group-by">Group by</a></li>
      <li><a href="#key-value">Key-value</a></li>
      <li><a href="#custom-reducers">Custom reducers</a></li>
    </ul>
  </li>
  <li><a href="#transactions">Transactions</a>
    <ul>
      <li><a href="#always-rollback">Always Rollback</a></li>
      <li><a href="#read-only">Read-only</a></li>
      <li><a href="#isolation-level">Isolation level</a></li>
      <li><a href="#manual-transactions-and-status-check">Manual transactions and status check</a></li>
    </ul>
  </li>
  <li><a href="#configuration">Configuration</a></li>
  <li><a href="#authorization">Authorization</a></li>
  <li><a href="#cloning-a-connection">Cloning a connection</a></li>
  <li><a href="#cancelling-a-query">Cancelling a query</a></li>
  <li><a href="#notices">Notices</a></li>
  <li><a href="#thread-safety">Thread safety</a></li>
  <li><a href="#debugging">Debugging</a></li>
</ul>

<!-- tocstop -->

<h2 id="basic-usage">Basic usage</h2>

<p>Here is a brief example of using the client library:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">ns</span><span class="w"> </span><span class="n">scratch</span><span class="w">
  </span><span class="p">(</span><span class="no">:require</span><span class="w">
   </span><span class="p">[</span><span class="n">pg.client</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">pg</span><span class="p">]))</span><span class="w">

</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">config</span><span class="w">
  </span><span class="p">{</span><span class="no">:host</span><span class="w"> </span><span class="s">"127.0.0.1"</span><span class="w">
   </span><span class="no">:port</span><span class="w"> </span><span class="mi">5432</span><span class="w">
   </span><span class="no">:user</span><span class="w"> </span><span class="s">"test"</span><span class="w">
   </span><span class="no">:password</span><span class="w"> </span><span class="s">"test"</span><span class="w">
   </span><span class="no">:database</span><span class="w"> </span><span class="s">"test"</span><span class="p">})</span><span class="w">

</span><span class="p">(</span><span class="nf">pg/with-connection</span><span class="w"> </span><span class="p">[</span><span class="n">conn</span><span class="w"> </span><span class="n">config</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nf">pg/query</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="s">"select 1 as one"</span><span class="p">))</span><span class="w">

</span><span class="c1">;; [{:one 1}]</span><span class="w">
</span></code></pre></div></div>

<p>First, you import the <code class="language-plaintext highlighter-rouge">pg.client</code> namespace which brings the top-level API functions to interact with Postgres. The <code class="language-plaintext highlighter-rouge">config</code> map above specifies the minimal configuration;
it might have more fields which we will explore in a separate section.</p>

<p>The <code class="language-plaintext highlighter-rouge">with-connection</code> macro establishes a new connection, binds it to the <code class="language-plaintext highlighter-rouge">conn</code>
symbol, and executes the body. The connection is closed afterward, even if an
exception pops up.</p>

<p>Technically you can open and terminate a connection manually like this:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">conn</span><span class="w"> </span><span class="p">(</span><span class="nf">pg/connect</span><span class="w"> </span><span class="n">config</span><span class="p">)</span><span class="w">
      </span><span class="n">data</span><span class="w"> </span><span class="p">(</span><span class="nf">pg/query</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="s">"select 1 as one"</span><span class="p">)]</span><span class="w">
  </span><span class="p">(</span><span class="nf">pg/terminate</span><span class="w"> </span><span class="n">conn</span><span class="p">)</span><span class="w">
  </span><span class="n">data</span><span class="p">)</span><span class="w">

</span><span class="c1">;; [{:one 1}]</span><span class="w">
</span></code></pre></div></div>

<p>but it’s not recommended. Also, since the <code class="language-plaintext highlighter-rouge">Connection</code> object implements
<code class="language-plaintext highlighter-rouge">java.io.Closeable</code>, it’s possible to use it in <code class="language-plaintext highlighter-rouge">with-open</code>:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nb">with-open</span><span class="w"> </span><span class="p">[</span><span class="n">conn</span><span class="w"> </span><span class="p">(</span><span class="nf">pg/connect</span><span class="w"> </span><span class="n">config</span><span class="p">)]</span><span class="w">
  </span><span class="p">(</span><span class="nf">pg/query</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="s">"select 1 as one"</span><span class="p">))</span><span class="w">

</span><span class="c1">;; [{:one 1}]</span><span class="w">
</span></code></pre></div></div>

<!-- more -->

<h2 id="queries">Queries</h2>

<p>The <code class="language-plaintext highlighter-rouge">pg/query</code> function above runs a query using a <em>Simple Wire</em> protocol
(Postgres has two kinds of protocols to communicate each having its own pros and
cons). The function takes a connection object, a string query, and a map of
non-required options:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pg/query</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="s">"select 1 as one"</span><span class="p">)</span><span class="w">
</span><span class="p">(</span><span class="nf">pg/query</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="s">"select 2 as two"</span><span class="w"> </span><span class="p">{</span><span class="n">...</span><span class="p">})</span><span class="w">
</span></code></pre></div></div>

<p><em>Pay attention:</em> There is no way to pass parameters because the Simple Wire
protocol doesn’t support them! In other words, <code class="language-plaintext highlighter-rouge">pg/query</code> doesn’t allow you to
write something like this:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pg/query</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="s">"select * from users where id = $1"</span><span class="w"> </span><span class="p">[</span><span class="mi">42</span><span class="p">])</span><span class="w">
</span></code></pre></div></div>

<p>This behavior is held by <code class="language-plaintext highlighter-rouge">pg/execute</code> and statements (see below).</p>

<p>What is the benefit of Simple Wire queries then? They allow you to send multiple
expressions in one separating them with a semicolon:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pg/query</span><span class="w"> </span><span class="n">conn</span><span class="w">
   </span><span class="s">"select s.x from generate_series(1, 5) as s(x);
    select s.x from generate_series('2008-03-01 00:00'::timestamp,
                                    '2008-03-04 12:00',
                                    '10 hours') as s(x)"</span><span class="p">)</span><span class="w">

</span><span class="p">[[{</span><span class="no">:x</span><span class="w"> </span><span class="mi">1</span><span class="p">}</span><span class="w"> </span><span class="p">{</span><span class="no">:x</span><span class="w"> </span><span class="mi">2</span><span class="p">}</span><span class="w"> </span><span class="p">{</span><span class="no">:x</span><span class="w"> </span><span class="mi">3</span><span class="p">}</span><span class="w"> </span><span class="p">{</span><span class="no">:x</span><span class="w"> </span><span class="mi">4</span><span class="p">}</span><span class="w"> </span><span class="p">{</span><span class="no">:x</span><span class="w"> </span><span class="mi">5</span><span class="p">}]</span><span class="w">
 </span><span class="p">[{</span><span class="no">:x</span><span class="w"> </span><span class="o">#</span><span class="n">object</span><span class="p">[</span><span class="n">j.t.LocalDateTime</span><span class="w"> </span><span class="s">"2008-03-01T00:00"</span><span class="p">]}</span><span class="w">
  </span><span class="p">{</span><span class="no">:x</span><span class="w"> </span><span class="o">#</span><span class="n">object</span><span class="p">[</span><span class="n">j.t.LocalDateTime</span><span class="w"> </span><span class="s">"2008-03-01T10:00"</span><span class="p">]}</span><span class="w">
  </span><span class="p">{</span><span class="no">:x</span><span class="w"> </span><span class="o">#</span><span class="n">object</span><span class="p">[</span><span class="n">j.t.LocalDateTime</span><span class="w"> </span><span class="s">"2008-03-01T20:00"</span><span class="p">]}</span><span class="w">
  </span><span class="p">{</span><span class="no">:x</span><span class="w"> </span><span class="o">#</span><span class="n">object</span><span class="p">[</span><span class="n">j.t.LocalDateTime</span><span class="w"> </span><span class="s">"2008-03-02T06:00"</span><span class="p">]}</span><span class="w">
  </span><span class="p">{</span><span class="no">:x</span><span class="w"> </span><span class="o">#</span><span class="n">object</span><span class="p">[</span><span class="n">j.t.LocalDateTime</span><span class="w"> </span><span class="s">"2008-03-02T16:00"</span><span class="p">]}</span><span class="w">
  </span><span class="p">{</span><span class="no">:x</span><span class="w"> </span><span class="o">#</span><span class="n">object</span><span class="p">[</span><span class="n">j.t.LocalDateTime</span><span class="w"> </span><span class="s">"2008-03-03T02:00"</span><span class="p">]}</span><span class="w">
  </span><span class="p">{</span><span class="no">:x</span><span class="w"> </span><span class="o">#</span><span class="n">object</span><span class="p">[</span><span class="n">j.t.LocalDateTime</span><span class="w"> </span><span class="s">"2008-03-03T12:00"</span><span class="p">]}</span><span class="w">
  </span><span class="p">{</span><span class="no">:x</span><span class="w"> </span><span class="o">#</span><span class="n">object</span><span class="p">[</span><span class="n">j.t.LocalDateTime</span><span class="w"> </span><span class="s">"2008-03-03T22:00"</span><span class="p">]}</span><span class="w">
  </span><span class="p">{</span><span class="no">:x</span><span class="w"> </span><span class="o">#</span><span class="n">object</span><span class="p">[</span><span class="n">j.t.LocalDateTime</span><span class="w"> </span><span class="s">"2008-03-04T08:00"</span><span class="p">]}]]</span><span class="w">
</span></code></pre></div></div>

<p>The result will be a vector of two results, each for the corresponding
expression. Each expression has its own column set and doesn’t depend on other
expressions.</p>

<p>Obviously, it’s better to avoid mixing DDL expressions like <code class="language-plaintext highlighter-rouge">CREATE TABLE</code> with
data selection.</p>

<h2 id="execute">Execute</h2>

<p>The <code class="language-plaintext highlighter-rouge">pg/execute</code> function implements the <em>Extended Wire</em> protocol for
Postgres. Although it doesn’t allow you to pass multiple expressions separated
by a semicolon, it supports passing parameters.</p>

<p>First, let’s prepare a table:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pg/query</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="s">"CREATE TABLE users (id serial primary key, name text, age integer)"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>Let’s insert a couple of users:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w">
            </span><span class="s">"INSERT INTO users (name, age)
             VALUES ($1, $2), ($3, $4)
             RETURNING id"</span><span class="w">
            </span><span class="p">[</span><span class="s">"Ivan"</span><span class="w"> </span><span class="mi">37</span><span class="w"> </span><span class="s">"Juan"</span><span class="w"> </span><span class="mi">38</span><span class="p">])</span><span class="w">

</span><span class="c1">;; [{:id 1} {:id 2}]</span><span class="w">
</span></code></pre></div></div>

<p>Above, “Ivan” becomes <code class="language-plaintext highlighter-rouge">$1</code>, 37 becomes <code class="language-plaintext highlighter-rouge">$2</code> and so on. Now that we have some
data, let’s query users by id:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">sql</span><span class="w"> </span><span class="s">"select * from users where id = $1"</span><span class="p">)</span><span class="w">

</span><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="n">sql</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="w">
</span><span class="c1">;; [{:id 1, :name "Ivan", :age 37}]</span><span class="w">

</span><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="n">sql</span><span class="w"> </span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="w">
</span><span class="c1">;; [{:id 2, :name "Juan", :age 38}]</span><span class="w">
</span></code></pre></div></div>

<p>This technique allows to you share the same queries for different values.</p>

<h2 id="prepared-statements">Prepared Statements</h2>

<p>The <code class="language-plaintext highlighter-rouge">pg/execute</code> function above does several things under the hood. It prepares
a statement, binds the parameters to it, and obtains a <em>portal</em>; then it reads
the from the portal and closes it.</p>

<p>There are a couple of functions to do the same in a breakdown. The
<code class="language-plaintext highlighter-rouge">pg/prepare-statement</code> accepts a connection, a SQL expression and returns a
prepared statement:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">stmt</span><span class="w"> </span><span class="p">(</span><span class="nf">pg/prepare-statement</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="n">sql</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<p>A prepared statement is just a plain map that carries brief information about
its name (auto-generated), columns, and parameters. In the example below, the
statement is called <code class="language-plaintext highlighter-rouge">statement_10637</code>, there are three columns called “id”,
“name” and “age” of type OIDs 23, 25, and 23. There is a single parameter with
type 23 (integer):</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="no">:statement</span><span class="w"> </span><span class="s">"statement_10637"</span><span class="w">
 </span><span class="no">:RowDescription</span><span class="w">
 </span><span class="p">{</span><span class="no">:msg</span><span class="w"> </span><span class="no">:RowDescription</span><span class="w">
  </span><span class="no">:column-count</span><span class="w"> </span><span class="mi">3</span><span class="w">
  </span><span class="no">:columns</span><span class="w">
  </span><span class="p">[{</span><span class="no">:index</span><span class="w"> </span><span class="mi">0</span><span class="w">
    </span><span class="no">:name</span><span class="w"> </span><span class="s">"id"</span><span class="w">
    </span><span class="no">:table-oid</span><span class="w"> </span><span class="mi">18024</span><span class="w">
    </span><span class="no">:column-oid</span><span class="w"> </span><span class="mi">1</span><span class="w">
    </span><span class="no">:type-oid</span><span class="w"> </span><span class="mi">23</span><span class="w">
    </span><span class="no">:type-len</span><span class="w"> </span><span class="mi">4</span><span class="w">
    </span><span class="no">:type-mod</span><span class="w"> </span><span class="mi">-1</span><span class="w">
    </span><span class="no">:format</span><span class="w"> </span><span class="mi">0</span><span class="p">}</span><span class="w">
   </span><span class="p">{</span><span class="no">:index</span><span class="w"> </span><span class="mi">1</span><span class="w">
    </span><span class="no">:name</span><span class="w"> </span><span class="s">"name"</span><span class="w">
    </span><span class="no">:table-oid</span><span class="w"> </span><span class="mi">18024</span><span class="w">
    </span><span class="no">:column-oid</span><span class="w"> </span><span class="mi">2</span><span class="w">
    </span><span class="no">:type-oid</span><span class="w"> </span><span class="mi">25</span><span class="w">
    </span><span class="no">:type-len</span><span class="w"> </span><span class="mi">-1</span><span class="w">
    </span><span class="no">:format</span><span class="w"> </span><span class="mi">0</span><span class="p">}</span><span class="w">
   </span><span class="p">{</span><span class="no">:index</span><span class="w"> </span><span class="mi">2</span><span class="w">
    </span><span class="no">:name</span><span class="w"> </span><span class="s">"age"</span><span class="w">
    </span><span class="no">:table-oid</span><span class="w"> </span><span class="mi">18024</span><span class="w">
    </span><span class="no">:column-oid</span><span class="w"> </span><span class="mi">3</span><span class="w">
    </span><span class="no">:type-oid</span><span class="w"> </span><span class="mi">23</span><span class="w">
    </span><span class="no">:type-len</span><span class="w"> </span><span class="mi">4</span><span class="w">
    </span><span class="no">:type-mod</span><span class="w"> </span><span class="mi">-1</span><span class="w">
    </span><span class="no">:format</span><span class="w"> </span><span class="mi">0</span><span class="p">}]}</span><span class="w">
 </span><span class="no">:ParameterDescription</span><span class="w">
 </span><span class="p">{</span><span class="no">:msg</span><span class="w"> </span><span class="no">:ParameterDescription</span><span class="w">
  </span><span class="no">:param-count</span><span class="w"> </span><span class="mi">1</span><span class="w">
  </span><span class="no">:param-oids</span><span class="w"> </span><span class="p">[</span><span class="mi">23</span><span class="p">]}}</span><span class="w">
</span></code></pre></div></div>

<p>Having a prepared statement, execute it as follows:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pg/execute-statement</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="n">stmt</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="w">
</span><span class="c1">;; [{:id 1, :name "Ivan", :age 37}]</span><span class="w">

</span><span class="p">(</span><span class="nf">pg/execute-statement</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="n">stmt</span><span class="w"> </span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="w">
</span><span class="c1">;; [{:id 2, :name "Juan", :age 38}]</span><span class="w">
</span></code></pre></div></div>

<p><em>Pay attention that prepared statements are always bound to a certain
connection. You cannot prepare a statement in one connection and execute it with
another: it will cause an error response from Postgres.</em></p>

<p>Once you’ve done with a prepared statement, close it:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pg/close-statement</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="n">stmt</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>Closing statements is important for the server as it releases resources
allocated to those statements. To prevent hanging statements, there is a macro
called <code class="language-plaintext highlighter-rouge">with-statement</code> which closes a statement afterward:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pg/with-statement</span><span class="w"> </span><span class="p">[</span><span class="n">stmt</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="s">"INSERT INTO users (name, age) VALUES ($1, $2)"</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nf">pg/execute-statement</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="n">stmt</span><span class="w"> </span><span class="p">[</span><span class="s">"Petr"</span><span class="w"> </span><span class="mi">42</span><span class="p">])</span><span class="w">
  </span><span class="p">(</span><span class="nf">pg/execute-statement</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="n">stmt</span><span class="w"> </span><span class="p">[</span><span class="s">"Simon"</span><span class="w"> </span><span class="mi">33</span><span class="p">]))</span><span class="w">
</span></code></pre></div></div>

<h2 id="processing-result-with-fn-result">Processing result with :fn-result</h2>

<p>Often, you want to process the result somehow. Say, take only the first row of
the selection (when you know there is either zero or one record).</p>

<p>All the <code class="language-plaintext highlighter-rouge">query</code>, <code class="language-plaintext highlighter-rouge">execute</code>, and <code class="language-plaintext highlighter-rouge">execute-statement</code> accept optional
parameters. The <code class="language-plaintext highlighter-rouge">:fn-result</code> function is applied to the whole result; usually,
you pass <code class="language-plaintext highlighter-rouge">first</code>:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">sql</span><span class="w"> </span><span class="s">"select * from users where id = $1"</span><span class="p">)</span><span class="w">

</span><span class="p">(</span><span class="nf">pg/with-statement</span><span class="w"> </span><span class="p">[</span><span class="n">stmt</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="n">sql</span><span class="p">]</span><span class="w">
    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">user1</span><span class="w"> </span><span class="p">(</span><span class="nf">pg/execute-statement</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="n">stmt</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="p">{</span><span class="no">:fn-result</span><span class="w"> </span><span class="nb">first</span><span class="p">})</span><span class="w">
          </span><span class="n">user2</span><span class="w"> </span><span class="p">(</span><span class="nf">pg/execute-statement</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="n">stmt</span><span class="w"> </span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="p">{</span><span class="no">:fn-result</span><span class="w"> </span><span class="nb">first</span><span class="p">})]</span><span class="w">
      </span><span class="p">{</span><span class="no">:user1</span><span class="w"> </span><span class="n">user1</span><span class="w">
       </span><span class="no">:user2</span><span class="w"> </span><span class="n">user2</span><span class="p">}))</span><span class="w">

</span><span class="p">{</span><span class="no">:user1</span><span class="w"> </span><span class="p">{</span><span class="no">:id</span><span class="w"> </span><span class="mi">1</span><span class="n">,</span><span class="w"> </span><span class="no">:name</span><span class="w"> </span><span class="s">"Ivan"</span><span class="n">,</span><span class="w"> </span><span class="no">:age</span><span class="w"> </span><span class="mi">37</span><span class="p">}</span><span class="n">,</span><span class="w">
 </span><span class="no">:user2</span><span class="w"> </span><span class="p">{</span><span class="no">:id</span><span class="w"> </span><span class="mi">2</span><span class="n">,</span><span class="w"> </span><span class="no">:name</span><span class="w"> </span><span class="s">"Juan"</span><span class="n">,</span><span class="w"> </span><span class="no">:age</span><span class="w"> </span><span class="mi">38</span><span class="p">}}</span><span class="w">
</span></code></pre></div></div>

<p>Pay attention: when passing the <code class="language-plaintext highlighter-rouge">:fn-result</code> function to <code class="language-plaintext highlighter-rouge">pg/query</code> with
multiple expressions, the function is applied to each expression:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pg/query</span><span class="w"> </span><span class="n">conn</span><span class="w">
          </span><span class="s">"
           select x from generate_series(0, 3) as s(x);
           select y from generate_series(2, 5) as s(y)
          "</span><span class="w">
          </span><span class="p">{</span><span class="no">:fn-result</span><span class="w"> </span><span class="nb">set</span><span class="p">})</span><span class="w">

</span><span class="p">[</span><span class="o">#</span><span class="p">{{</span><span class="no">:x</span><span class="w"> </span><span class="mi">1</span><span class="p">}</span><span class="w"> </span><span class="p">{</span><span class="no">:x</span><span class="w"> </span><span class="mi">3</span><span class="p">}</span><span class="w"> </span><span class="p">{</span><span class="no">:x</span><span class="w"> </span><span class="mi">2</span><span class="p">}</span><span class="w"> </span><span class="p">{</span><span class="no">:x</span><span class="w"> </span><span class="mi">0</span><span class="p">}}</span><span class="w">
 </span><span class="o">#</span><span class="p">{{</span><span class="no">:y</span><span class="w"> </span><span class="mi">4</span><span class="p">}</span><span class="w"> </span><span class="p">{</span><span class="no">:y</span><span class="w"> </span><span class="mi">3</span><span class="p">}</span><span class="w"> </span><span class="p">{</span><span class="no">:y</span><span class="w"> </span><span class="mi">2</span><span class="p">}</span><span class="w"> </span><span class="p">{</span><span class="no">:y</span><span class="w"> </span><span class="mi">5</span><span class="p">}}]</span><span class="w">
</span></code></pre></div></div>

<h2 id="column-names">Column names</h2>

<p>By default, the client library turns all the column names to keywords. It
doesn’t take any kebab-case transformations into account: a column <code class="language-plaintext highlighter-rouge">"user_name"</code>
becomes <code class="language-plaintext highlighter-rouge">:user_name</code>.</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pg/query</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="s">"select 42 as the_answer"</span><span class="p">)</span><span class="w">

</span><span class="p">[{</span><span class="no">:the_answer</span><span class="w"> </span><span class="mi">42</span><span class="p">}]</span><span class="w">
</span></code></pre></div></div>

<p>An optional parameter <code class="language-plaintext highlighter-rouge">:fn-column</code> changes this behaviour. It’s a function that
takes a string column and returns whatever you want. Here is how you can obtain
upper-cased string keys:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">require</span><span class="w"> </span><span class="o">'</span><span class="p">[</span><span class="n">clojure.string</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="nb">str</span><span class="p">])</span><span class="w">

</span><span class="p">(</span><span class="nf">pg/query</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="s">"select 42 as the_answer"</span><span class="w"> </span><span class="p">{</span><span class="no">:fn-column</span><span class="w"> </span><span class="n">str/upper-case</span><span class="p">})</span><span class="w">

</span><span class="p">[{</span><span class="s">"THE_ANSWER"</span><span class="w"> </span><span class="mi">42</span><span class="p">}]</span><span class="w">
</span></code></pre></div></div>

<p>Of course, you can pass a complex function that transforms the string somehow
and then turns it into a keyword or a symbol.</p>

<p>Some Clojure programmers prefer kebab-case keywords (which I honestly consider a bad practice, but still). For this, do one of the two options. Either get such function from the <code class="language-plaintext highlighter-rouge">pg.client.func</code> namespace:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">require</span><span class="w"> </span><span class="o">'</span><span class="p">[</span><span class="n">pg.client.func</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">func</span><span class="p">])</span><span class="w">

</span><span class="p">(</span><span class="nf">pg/query</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="s">"select 42 as the_answer"</span><span class="w"> </span><span class="p">{</span><span class="no">:fn-column</span><span class="w"> </span><span class="n">func/kebab-keyword</span><span class="p">})</span><span class="w">

</span><span class="p">[{</span><span class="no">:the-answer</span><span class="w"> </span><span class="mi">42</span><span class="p">}]</span><span class="w">
</span></code></pre></div></div>

<p>Or pass it as a “bundle”:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">require</span><span class="w"> </span><span class="o">'</span><span class="p">[</span><span class="n">pg.client.as</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">as</span><span class="p">])</span><span class="w">

</span><span class="p">(</span><span class="nf">pg/query</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="s">"select 42 as the_answer"</span><span class="w"> </span><span class="p">{</span><span class="no">:as</span><span class="w"> </span><span class="n">as/kebab-keys</span><span class="p">})</span><span class="w">

</span><span class="p">[{</span><span class="no">:the-answer</span><span class="w"> </span><span class="mi">42</span><span class="p">}]</span><span class="w">
</span></code></pre></div></div>

<p>Bundles are maps of several processing functions which we’re going to describe a
bit below.</p>

<h2 id="column-duplicates">Column duplicates</h2>

<p>In SQL, that’s completely fine when a query returns several columns with the
same name, for example:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SELECT 1 as val, true as val, 'dunno' as val;

 val | val |  val
-----+-----+-------
   1 | t   | dunno
</code></pre></div></div>

<p>But from the client’s perspective, that’s unclear what to do with such a result,
especially when you’re dealing with maps.</p>

<p>By default, the client library adds numbers to those columns that have already
been in the result. Briefly, for the example above, you’ll get <code class="language-plaintext highlighter-rouge">val</code>, <code class="language-plaintext highlighter-rouge">val_1</code>
and <code class="language-plaintext highlighter-rouge">val_2</code> columns:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pg/query</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="s">"SELECT 1 as val, true as val, 'dunno' as val"</span><span class="p">)</span><span class="w">

</span><span class="p">[{</span><span class="no">:val</span><span class="w"> </span><span class="mi">1</span><span class="n">,</span><span class="w"> </span><span class="no">:val_1</span><span class="w"> </span><span class="n">true,</span><span class="w"> </span><span class="no">:val_2</span><span class="w"> </span><span class="s">"dunno"</span><span class="p">}]</span><span class="w">
</span></code></pre></div></div>

<p>This behaviour stacks with the <code class="language-plaintext highlighter-rouge">fn-column</code> parameter: the <code class="language-plaintext highlighter-rouge">fn-column</code> gets
applied after the column names have been transformed.</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pg/query</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="s">"SELECT 1 as val, true as val, 'dunno' as val"</span><span class="w"> </span><span class="p">{</span><span class="no">:as</span><span class="w"> </span><span class="n">as/kebab-keys</span><span class="p">})</span><span class="w">

</span><span class="p">[{</span><span class="no">:val</span><span class="w"> </span><span class="mi">1</span><span class="n">,</span><span class="w"> </span><span class="no">:val-1</span><span class="w"> </span><span class="n">true,</span><span class="w"> </span><span class="no">:val-2</span><span class="w"> </span><span class="s">"dunno"</span><span class="p">}]</span><span class="w">
</span></code></pre></div></div>

<p>The function which is responsible for column duplicate processing is called
<code class="language-plaintext highlighter-rouge">:fn-unify</code>. It takes a vector of strings and must return a vector of something
(strings, keywords, symbols).</p>

<h2 id="reducers-and-bundles">Reducers and bundles</h2>

<p>As you’ve seen before, the result of <code class="language-plaintext highlighter-rouge">pg/query</code> or <code class="language-plaintext highlighter-rouge">pg/execute</code> is a vector of
maps. Although it is most likely what you want by default, there are other ways
to obtain the result in another shape.</p>

<p>There is a <code class="language-plaintext highlighter-rouge">pg.client.as</code> namespace that carries “bundles”: named maps with
predefined parameters, mostly functions. Passing these maps into the optional
<code class="language-plaintext highlighter-rouge">:as</code> field when querying data affects how the rows will be processed.</p>

<h3 id="java">Java</h3>

<p>The <code class="language-plaintext highlighter-rouge">as/java</code> bundle builds an <code class="language-plaintext highlighter-rouge">ArrayList</code> of mutable <code class="language-plaintext highlighter-rouge">HashMap</code>s. Both the
top-level set of rows and its children are mutable:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="p">(</span><span class="nf">pg/query</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="s">"SELECT 42 as the_answer"</span><span class="w"> </span><span class="p">{</span><span class="no">:as</span><span class="w"> </span><span class="n">as/java</span><span class="p">}))</span><span class="w">

</span><span class="p">(</span><span class="nf">.add</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="no">:someting</span><span class="p">)</span><span class="w">
</span><span class="p">(</span><span class="nf">.put</span><span class="w"> </span><span class="p">(</span><span class="nf">.get</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="no">:some-key</span><span class="w"> </span><span class="s">"A"</span><span class="p">)</span><span class="w">

</span><span class="c1">;; [{:the_answer 42, :some-key "A"} :someting]</span><span class="w">
</span></code></pre></div></div>

<h3 id="kebab-keys">Kebab-keys</h3>

<p>The <code class="language-plaintext highlighter-rouge">kebab-keys</code> bundle we have already seen in action: it just transforms the
keys from <code class="language-plaintext highlighter-rouge">:foo_bar</code> to <code class="language-plaintext highlighter-rouge">:foo-bar</code>:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pg/query</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="s">"SELECT 42 as the_answer"</span><span class="w"> </span><span class="p">{</span><span class="no">:as</span><span class="w"> </span><span class="n">as/kebab-keys</span><span class="p">})</span><span class="w">

</span><span class="p">[{</span><span class="no">:the-answer</span><span class="w"> </span><span class="mi">42</span><span class="p">}]</span><span class="w">
</span></code></pre></div></div>

<h3 id="matrix">Matrix</h3>

<p>The <code class="language-plaintext highlighter-rouge">as/matrix</code> bundle is useful for getting values without names:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pg/query</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="s">"SELECT 1, false, 'hello'"</span><span class="w"> </span><span class="p">{</span><span class="no">:as</span><span class="w"> </span><span class="n">as/matrix</span><span class="p">})</span><span class="w">

</span><span class="p">[[</span><span class="mi">1</span><span class="w"> </span><span class="n">false</span><span class="w"> </span><span class="s">"hello"</span><span class="p">]]</span><span class="w">
</span></code></pre></div></div>

<p>The result will be just a vector of vectors which is convenient for writing to
CSV or Excel files.</p>

<h3 id="index-by">Index by</h3>

<p>The following case happens quite often: you select certain entities and then you
need to build an index map by id. Namely, transform this:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[{</span><span class="no">:id</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="no">:name</span><span class="w"> </span><span class="s">"Ivan"</span><span class="p">}</span><span class="w">
 </span><span class="p">{</span><span class="no">:id</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="no">:name</span><span class="w"> </span><span class="s">"Juan"</span><span class="p">}</span><span class="w">
 </span><span class="n">...</span><span class="p">]</span><span class="w">
</span></code></pre></div></div>

<p>to this:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="mi">1</span><span class="w"> </span><span class="p">{</span><span class="no">:id</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="no">:name</span><span class="w"> </span><span class="s">"Ivan"</span><span class="p">}</span><span class="w">
 </span><span class="mi">2</span><span class="w"> </span><span class="p">{</span><span class="no">:id</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="no">:name</span><span class="w"> </span><span class="s">"Juan"</span><span class="p">}</span><span class="w">
 </span><span class="n">...</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>That would be great of course to do that not once <em>you have read</em> the rows from
the database but <em>as you’re reading</em> the rows. That would save the lines of code
and resources.</p>

<p>The <code class="language-plaintext highlighter-rouge">as/index-by</code> reducer does it for you. It’s a function that takes a row
function and returns a bundle:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pg/query</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="s">"select * from users"</span><span class="w"> </span><span class="p">{</span><span class="no">:as</span><span class="w"> </span><span class="p">(</span><span class="nf">as/index-by</span><span class="w"> </span><span class="no">:id</span><span class="p">)})</span><span class="w">
</span><span class="n">p</span><span class="w">
</span><span class="p">{</span><span class="mi">1</span><span class="w"> </span><span class="p">{</span><span class="no">:id</span><span class="w"> </span><span class="mi">1</span><span class="n">,</span><span class="w"> </span><span class="no">:name</span><span class="w"> </span><span class="s">"Ivan"</span><span class="n">,</span><span class="w"> </span><span class="no">:age</span><span class="w"> </span><span class="mi">37</span><span class="p">}</span><span class="n">,</span><span class="w">
 </span><span class="mi">2</span><span class="w"> </span><span class="p">{</span><span class="no">:id</span><span class="w"> </span><span class="mi">2</span><span class="n">,</span><span class="w"> </span><span class="no">:name</span><span class="w"> </span><span class="s">"Juan"</span><span class="n">,</span><span class="w"> </span><span class="no">:age</span><span class="w"> </span><span class="mi">38</span><span class="p">}}</span><span class="w">
</span></code></pre></div></div>

<p>Of course, a function that is passed to <code class="language-plaintext highlighter-rouge">index-by</code> might be something more
complex than an ordinary keyword. It can be a call of <code class="language-plaintext highlighter-rouge">juxt</code> if you need to
group rows by several keys:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pg/query</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="s">"select * from users"</span><span class="w"> </span><span class="p">{</span><span class="no">:as</span><span class="w"> </span><span class="p">(</span><span class="nf">as/index-by</span><span class="w"> </span><span class="p">(</span><span class="nf">juxt</span><span class="w"> </span><span class="no">:id</span><span class="w"> </span><span class="no">:name</span><span class="p">))})</span><span class="w">

</span><span class="p">{[</span><span class="mi">1</span><span class="w"> </span><span class="s">"Ivan"</span><span class="p">]</span><span class="w"> </span><span class="p">{</span><span class="no">:id</span><span class="w"> </span><span class="mi">1</span><span class="n">,</span><span class="w"> </span><span class="no">:name</span><span class="w"> </span><span class="s">"Ivan"</span><span class="n">,</span><span class="w"> </span><span class="no">:age</span><span class="w"> </span><span class="mi">37</span><span class="p">}</span><span class="n">,</span><span class="w">
 </span><span class="p">[</span><span class="mi">2</span><span class="w"> </span><span class="s">"Juan"</span><span class="p">]</span><span class="w"> </span><span class="p">{</span><span class="no">:id</span><span class="w"> </span><span class="mi">2</span><span class="n">,</span><span class="w"> </span><span class="no">:name</span><span class="w"> </span><span class="s">"Juan"</span><span class="n">,</span><span class="w"> </span><span class="no">:age</span><span class="w"> </span><span class="mi">38</span><span class="p">}}</span><span class="w">
</span></code></pre></div></div>

<h3 id="group-by">Group by</h3>

<p>The <code class="language-plaintext highlighter-rouge">as/group-by</code> reducer acts like the standard <code class="language-plaintext highlighter-rouge">group-by</code> function. It
collects a map where a key is a result of <code class="language-plaintext highlighter-rouge">(f row)</code>, and the value is a vector
of matched rows. The main difference is, that it fills the result on the fly as
the data arrives from the server.</p>

<p>Imagine there are more users named Ivan and Juan in our database. Here is how we
can select and group them by name:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pg/query</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="s">"select * from users"</span><span class="w"> </span><span class="p">{</span><span class="no">:as</span><span class="w"> </span><span class="p">(</span><span class="nf">as/group-by</span><span class="w"> </span><span class="no">:name</span><span class="p">)})</span><span class="w">

</span><span class="p">{</span><span class="s">"Ivan"</span><span class="w"> </span><span class="p">[{</span><span class="no">:id</span><span class="w"> </span><span class="mi">1</span><span class="n">,</span><span class="w"> </span><span class="no">:name</span><span class="w"> </span><span class="s">"Ivan"</span><span class="n">,</span><span class="w"> </span><span class="no">:age</span><span class="w"> </span><span class="mi">37</span><span class="p">}</span><span class="w">
         </span><span class="p">{</span><span class="no">:id</span><span class="w"> </span><span class="mi">3</span><span class="n">,</span><span class="w"> </span><span class="no">:name</span><span class="w"> </span><span class="s">"Ivan"</span><span class="n">,</span><span class="w"> </span><span class="no">:age</span><span class="w"> </span><span class="mi">37</span><span class="p">}]</span><span class="n">,</span><span class="w">
 </span><span class="s">"Juan"</span><span class="w"> </span><span class="p">[{</span><span class="no">:id</span><span class="w"> </span><span class="mi">2</span><span class="n">,</span><span class="w"> </span><span class="no">:name</span><span class="w"> </span><span class="s">"Juan"</span><span class="n">,</span><span class="w"> </span><span class="no">:age</span><span class="w"> </span><span class="mi">38</span><span class="p">}</span><span class="w">
         </span><span class="p">{</span><span class="no">:id</span><span class="w"> </span><span class="mi">4</span><span class="n">,</span><span class="w"> </span><span class="no">:name</span><span class="w"> </span><span class="s">"Juan"</span><span class="n">,</span><span class="w"> </span><span class="no">:age</span><span class="w"> </span><span class="mi">38</span><span class="p">}]}</span><span class="w">
</span></code></pre></div></div>

<h3 id="key-value">Key-value</h3>

<p>There is a <code class="language-plaintext highlighter-rouge">kv</code> reducer that allows you to build <em>any map</em> you want. It takes
two parameters: a key function (fk) and a value function (fv). The result will
be a map like this:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{(</span><span class="nf">fk</span><span class="w"> </span><span class="n">row</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">fv</span><span class="w"> </span><span class="n">row</span><span class="p">)}</span><span class="w">
</span></code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">as/kv</code> reducer is useful when you want to get a map from rows, for example,
a mapping from the id to the name:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pg/query</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="s">"select * from users"</span><span class="w"> </span><span class="p">{</span><span class="no">:as</span><span class="w"> </span><span class="p">(</span><span class="nf">as/kv</span><span class="w"> </span><span class="no">:id</span><span class="w"> </span><span class="no">:name</span><span class="p">)})</span><span class="w">

</span><span class="p">{</span><span class="mi">1</span><span class="w"> </span><span class="s">"Ivan"</span><span class="n">,</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="s">"Juan"</span><span class="n">,</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="s">"Ivan"</span><span class="n">,</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="s">"Juan"</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h3 id="custom-reducers">Custom reducers</h3>

<p>Making a custom reducer means declaring either a map or a function that returns
a map of the following structure:</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">:fn-init</code>: a function that returns an empty accumulator value;</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">:fn-reduce</code>: a function that takes the accumulator and a row and adds the row
to the accumulator;</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">:fn-finalize</code>: a function that takes the accumulator and returns the final
value.</p>
  </li>
</ul>

<p>Here is an example of the <code class="language-plaintext highlighter-rouge">kv</code> reducer:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">kv</span><span class="w"> </span><span class="p">[</span><span class="n">fk</span><span class="w"> </span><span class="n">fv</span><span class="p">]</span><span class="w">
  </span><span class="p">{</span><span class="no">:fn-init</span><span class="w"> </span><span class="o">#</span><span class="p">(</span><span class="nf">transient</span><span class="w"> </span><span class="p">{})</span><span class="w">
   </span><span class="no">:fn-reduce</span><span class="w"> </span><span class="p">(</span><span class="k">fn</span><span class="w"> </span><span class="p">[</span><span class="n">acc!</span><span class="w"> </span><span class="n">row</span><span class="p">]</span><span class="w">
                </span><span class="p">(</span><span class="nf">assoc!</span><span class="w"> </span><span class="n">acc!</span><span class="w"> </span><span class="p">(</span><span class="nf">fk</span><span class="w"> </span><span class="n">row</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">fv</span><span class="w"> </span><span class="n">row</span><span class="p">)))</span><span class="w">
   </span><span class="no">:fn-finalize</span><span class="w"> </span><span class="n">persistent!</span><span class="p">})</span><span class="w">
</span></code></pre></div></div>

<h2 id="transactions">Transactions</h2>

<p>There is a special <code class="language-plaintext highlighter-rouge">pg/with-tx</code> macro to wrap several expressions in a single
transaction. It takes a connection object and produces BEGIN … COMMIT
commands:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">sql</span><span class="w"> </span><span class="s">"INSERT INTO users (name, age) VALUES ($1, $2)"</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nf">pg/with-tx</span><span class="w"> </span><span class="p">[</span><span class="n">conn</span><span class="p">]</span><span class="w">
    </span><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="n">sql</span><span class="w"> </span><span class="p">[</span><span class="s">"Jim"</span><span class="w"> </span><span class="mi">20</span><span class="p">])</span><span class="w">
    </span><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="n">sql</span><span class="w"> </span><span class="p">[</span><span class="s">"Bob"</span><span class="w"> </span><span class="mi">30</span><span class="p">])))</span><span class="w">
</span></code></pre></div></div>

<p>Here is what you would see in the logs:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">BEGIN</span><span class="w">
</span><span class="n">INSERT</span><span class="w"> </span><span class="n">INTO</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="p">(</span><span class="nf">name,</span><span class="w"> </span><span class="n">age</span><span class="p">)</span><span class="w"> </span><span class="n">VALUES</span><span class="w"> </span><span class="p">(</span><span class="nf">$1,</span><span class="w"> </span><span class="n">$2</span><span class="p">)</span><span class="w">
  </span><span class="n">parameters</span><span class="err">:</span><span class="w"> </span><span class="n">$1</span><span class="w"> </span><span class="nb">=</span><span class="w"> </span><span class="ss">'Jim',</span><span class="w"> </span><span class="n">$2</span><span class="w"> </span><span class="nb">=</span><span class="w"> </span><span class="ss">'20</span><span class="o">'</span><span class="w">
</span><span class="n">INSERT</span><span class="w"> </span><span class="n">INTO</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="p">(</span><span class="nf">name,</span><span class="w"> </span><span class="n">age</span><span class="p">)</span><span class="w"> </span><span class="n">VALUES</span><span class="w"> </span><span class="p">(</span><span class="nf">$1,</span><span class="w"> </span><span class="n">$2</span><span class="p">)</span><span class="w">
  </span><span class="n">parameters</span><span class="err">:</span><span class="w"> </span><span class="n">$1</span><span class="w"> </span><span class="nb">=</span><span class="w"> </span><span class="ss">'Bob',</span><span class="w"> </span><span class="n">$2</span><span class="w"> </span><span class="nb">=</span><span class="w"> </span><span class="ss">'30</span><span class="o">'</span><span class="w">
</span><span class="n">COMMIT</span><span class="w">
</span></code></pre></div></div>

<p>Should an exception pop up the middle, the whole transaction ends up with
ROLLBACK and the exception is rethrown:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">sql</span><span class="w"> </span><span class="s">"INSERT INTO users (name, age) VALUES ($1, $2)"</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nf">pg/with-tx</span><span class="w"> </span><span class="p">[</span><span class="n">conn</span><span class="p">]</span><span class="w">
    </span><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="n">sql</span><span class="w"> </span><span class="p">[</span><span class="s">"Jim"</span><span class="w"> </span><span class="mi">20</span><span class="p">])</span><span class="w">
    </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="mi">42</span><span class="w"> </span><span class="n">nil</span><span class="p">)</span><span class="w"> </span><span class="c1">;; &lt;-</span><span class="w">
    </span><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="n">sql</span><span class="w"> </span><span class="p">[</span><span class="s">"Bob"</span><span class="w"> </span><span class="mi">30</span><span class="p">])))</span><span class="w">

</span><span class="n">BEGIN</span><span class="w">
</span><span class="n">INSERT</span><span class="w"> </span><span class="n">INTO</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="p">(</span><span class="nf">name,</span><span class="w"> </span><span class="n">age</span><span class="p">)</span><span class="w"> </span><span class="n">VALUES</span><span class="w"> </span><span class="p">(</span><span class="nf">$1,</span><span class="w"> </span><span class="n">$2</span><span class="p">)</span><span class="w">
  </span><span class="n">parameters</span><span class="err">:</span><span class="w"> </span><span class="n">$1</span><span class="w"> </span><span class="nb">=</span><span class="w"> </span><span class="ss">'Jim',</span><span class="w"> </span><span class="n">$2</span><span class="w"> </span><span class="nb">=</span><span class="w"> </span><span class="ss">'20</span><span class="o">'</span><span class="w">
</span><span class="n">ROLLBACK</span><span class="w">

</span><span class="n">Execution</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="p">(</span><span class="nf">NullPointerException</span><span class="p">)</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">...</span><span class="w">
</span><span class="n">Cannot</span><span class="w"> </span><span class="n">invoke</span><span class="w"> </span><span class="s">"Object.getClass()"</span><span class="w"> </span><span class="n">because</span><span class="w"> </span><span class="s">"x"</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">null</span><span class="w">
</span></code></pre></div></div>

<h3 id="always-rollback">Always Rollback</h3>

<p>The <code class="language-plaintext highlighter-rouge">pg/with-tx</code> macro takes additional options for precise control over the
transaction. Passing the <code class="language-plaintext highlighter-rouge">{:rollback? true}</code> would end up a transaction with
rolling back the changes even if there was no error.</p>

<p>Here we create a couple of users in a rolling-back transaction. Right after you
exit the <code class="language-plaintext highlighter-rouge">pg/with-tx</code> macro, all the changes you made get wiped.</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">sql</span><span class="w"> </span><span class="s">"INSERT INTO users (name, age) VALUES ($1, $2)"</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nf">pg/with-tx</span><span class="w"> </span><span class="p">[</span><span class="n">conn</span><span class="w"> </span><span class="p">{</span><span class="no">:rollback?</span><span class="w"> </span><span class="n">true</span><span class="p">}]</span><span class="w">
    </span><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="n">sql</span><span class="w"> </span><span class="p">[</span><span class="s">"Jim"</span><span class="w"> </span><span class="mi">20</span><span class="p">])</span><span class="w">
    </span><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="n">sql</span><span class="w"> </span><span class="p">[</span><span class="s">"Bob"</span><span class="w"> </span><span class="mi">30</span><span class="p">])))</span><span class="w">
</span></code></pre></div></div>

<p>The logs:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">BEGIN</span><span class="w">
</span><span class="n">INSERT</span><span class="w"> </span><span class="n">INTO</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="p">(</span><span class="nf">name,</span><span class="w"> </span><span class="n">age</span><span class="p">)</span><span class="w"> </span><span class="n">VALUES</span><span class="w"> </span><span class="p">(</span><span class="nf">$1,</span><span class="w"> </span><span class="n">$2</span><span class="p">)</span><span class="w">
  </span><span class="n">parameters</span><span class="err">:</span><span class="w"> </span><span class="n">$1</span><span class="w"> </span><span class="nb">=</span><span class="w"> </span><span class="ss">'Jim',</span><span class="w"> </span><span class="n">$2</span><span class="w"> </span><span class="nb">=</span><span class="w"> </span><span class="ss">'20</span><span class="o">'</span><span class="w">
</span><span class="n">INSERT</span><span class="w"> </span><span class="n">INTO</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="p">(</span><span class="nf">name,</span><span class="w"> </span><span class="n">age</span><span class="p">)</span><span class="w"> </span><span class="n">VALUES</span><span class="w"> </span><span class="p">(</span><span class="nf">$1,</span><span class="w"> </span><span class="n">$2</span><span class="p">)</span><span class="w">
  </span><span class="n">parameters</span><span class="err">:</span><span class="w"> </span><span class="n">$1</span><span class="w"> </span><span class="nb">=</span><span class="w"> </span><span class="ss">'Bob',</span><span class="w"> </span><span class="n">$2</span><span class="w"> </span><span class="nb">=</span><span class="w"> </span><span class="ss">'30</span><span class="o">'</span><span class="w">
</span><span class="n">ROLLBACK</span><span class="w">
</span></code></pre></div></div>

<p>Always-rollback transactions are great for testing: first, you insert something
into the database, perform some checks, roll back, and the database stays
untouched. Of course, this is not the case for multi-threaded tests or some
tricky logic when multiple DB connections are involved.</p>

<h3 id="read-only">Read-only</h3>

<p>Passing the <code class="language-plaintext highlighter-rouge">{:read-only? true}</code> map will spawn a read-only transaction where
only SELECT and SHOW commands are available. Triggering INSERT, DELETE, CREATE
and similar commands would make Postgres respond with an error.</p>

<p>Here we try to create a couple of users in read-only mode:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">sql</span><span class="w"> </span><span class="s">"INSERT INTO users (name, age) VALUES ($1, $2)"</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nf">pg/with-tx</span><span class="w"> </span><span class="p">[</span><span class="n">conn</span><span class="w"> </span><span class="p">{</span><span class="no">:read-only?</span><span class="w"> </span><span class="n">true</span><span class="p">}]</span><span class="w">
    </span><span class="p">(</span><span class="nf">pg/query</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="s">"select * from users"</span><span class="p">)</span><span class="w">
    </span><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="n">sql</span><span class="w"> </span><span class="p">[</span><span class="s">"Bob"</span><span class="w"> </span><span class="mi">30</span><span class="p">])))</span><span class="w">

</span><span class="n">Execution</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="p">(</span><span class="nf">ExceptionInfo</span><span class="p">)</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">pg.client.result/finalize-errors!</span><span class="w"> </span><span class="p">(</span><span class="nf">result.clj</span><span class="no">:537</span><span class="p">)</span><span class="nb">.</span><span class="w">
</span><span class="n">clojure.lang.ExceptionInfo</span><span class="err">:</span><span class="w"> </span><span class="n">ErrorResponse</span><span class="w">
</span><span class="p">{</span><span class="no">:error</span><span class="w">
  </span><span class="p">{</span><span class="no">:msg</span><span class="w"> </span><span class="no">:ErrorResponse,</span><span class="w">
   </span><span class="no">:errors</span><span class="w"> </span><span class="p">{</span><span class="no">:severity</span><span class="w"> </span><span class="s">"ERROR"</span><span class="n">,</span><span class="w">
            </span><span class="no">:verbosity</span><span class="w"> </span><span class="s">"ERROR"</span><span class="n">,</span><span class="w">
            </span><span class="no">:code</span><span class="w"> </span><span class="s">"25006"</span><span class="n">,</span><span class="w">
            </span><span class="no">:message</span><span class="w"> </span><span class="s">"cannot execute INSERT in a read-only transaction"</span><span class="n">,</span><span class="w">
            </span><span class="no">:file</span><span class="w"> </span><span class="s">"utility.c"</span><span class="n">,</span><span class="w">
            </span><span class="no">:line</span><span class="w"> </span><span class="s">"414"</span><span class="n">,</span><span class="w">
            </span><span class="no">:function</span><span class="w"> </span><span class="s">"PreventCommandIfReadOnly"</span><span class="p">}}}</span><span class="w">
</span></code></pre></div></div>

<p>Usually, the read-only option is mandatory for replicas. Should you try to write
something to the replica by mistake, you’ll get an exception.</p>

<h3 id="isolation-level">Isolation level</h3>

<p>The <code class="language-plaintext highlighter-rouge">{:isolation-level ...}</code> option sets the isolation level for the new
transaction. Here is an example of setting a SERIALIZABLE level although there
is no need for that, actually.</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">sql</span><span class="w"> </span><span class="s">"INSERT INTO users (name, age) VALUES ($1, $2)"</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nf">pg/with-tx</span><span class="w"> </span><span class="p">[</span><span class="n">conn</span><span class="w"> </span><span class="p">{</span><span class="no">:isolation-level</span><span class="w"> </span><span class="no">:serializable</span><span class="p">}]</span><span class="w">
    </span><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="n">sql</span><span class="w"> </span><span class="p">[</span><span class="s">"Jim"</span><span class="w"> </span><span class="mi">20</span><span class="p">])</span><span class="w">
    </span><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="n">sql</span><span class="w"> </span><span class="p">[</span><span class="s">"Bob"</span><span class="w"> </span><span class="mi">30</span><span class="p">])))</span><span class="w">
</span></code></pre></div></div>

<p>The logs:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>BEGIN
SET TRANSACTION ISOLATION LEVEL SERIALIZABLE
INSERT INTO users (name, age) VALUES ($1, $2)
  parameters: $1 = 'Jim', $2 = '20'
INSERT INTO users (name, age) VALUES ($1, $2)
  parameters: $1 = 'Bob', $2 = '30'
COMMIT
</code></pre></div></div>

<p>The level might be a keyword, a string or a symbol, both in lower or upper
case. For example, <code class="language-plaintext highlighter-rouge">:SERIALIZABLE</code>, <code class="language-plaintext highlighter-rouge">:serializable</code>, <code class="language-plaintext highlighter-rouge">"SERIALIZABLE"</code> and so
on. Those levels that consist of two words, e.g. <code class="language-plaintext highlighter-rouge">REPEATABLE READ</code>, are
separated with a hyphen: <code class="language-plaintext highlighter-rouge">:repeatable-read</code>, <code class="language-plaintext highlighter-rouge">"REPEATABLE-READ"</code>, etc.</p>

<p>Just a reminder, there are four isolation levels in Postgres:</p>

<ul>
  <li>READ UNCOMMITTED</li>
  <li>READ COMMITTED (default)</li>
  <li>REPEATABLE READ</li>
  <li>SERIALIZABLE</li>
</ul>

<p><strong>Use them wisely: Never set a level explicitly unless you clearly understand
what is the default level and why doesn’t it satisfy you.</strong></p>

<h3 id="manual-transactions-and-status-check">Manual transactions and status check</h3>

<p>On the low level, transactions are driven by the <code class="language-plaintext highlighter-rouge">pg/begin</code>, <code class="language-plaintext highlighter-rouge">pg/commit</code> and
<code class="language-plaintext highlighter-rouge">pg/rollback</code> functions. They all take a single argument (a connection) and send
a corresponding command to the server.</p>

<p>Briefly, the <code class="language-plaintext highlighter-rouge">pg/with-tx</code> macro boils down to the following code:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pg/begin</span><span class="w"> </span><span class="n">conn</span><span class="p">)</span><span class="w">
</span><span class="p">(</span><span class="nf">try</span><span class="w">
  </span><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="n">...</span><span class="p">)</span><span class="w">
  </span><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="n">...</span><span class="p">)</span><span class="w">
  </span><span class="p">(</span><span class="nf">pg/commit</span><span class="w"> </span><span class="n">conn</span><span class="p">)</span><span class="w">
  </span><span class="p">(</span><span class="nf">catch</span><span class="w"> </span><span class="n">Throwable</span><span class="w"> </span><span class="n">e</span><span class="w">
    </span><span class="p">(</span><span class="nf">pg/rollback</span><span class="w"> </span><span class="n">conn</span><span class="p">)</span><span class="w">
    </span><span class="p">(</span><span class="nf">throw</span><span class="w"> </span><span class="n">e</span><span class="p">)))</span><span class="w">
</span></code></pre></div></div>

<p>Sometimes, you’d like to know the current state of a connection: whether it’s in
a transaction or not, or if the transaction has been aborted. The <code class="language-plaintext highlighter-rouge">pg/status</code>
returns a single-character keyword that represents the current state:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pg/status</span><span class="w"> </span><span class="n">conn</span><span class="p">)</span><span class="w">
</span><span class="no">:I</span><span class="w">
</span></code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">:I</code> stands for Idle: there is no transaction;</li>
  <li><code class="language-plaintext highlighter-rouge">:T</code> stands for Transaction: the connection is in the middle of a transaction;</li>
  <li><code class="language-plaintext highlighter-rouge">:E</code> stands for Error: the transaction has failed. Any subsequent query would
lead to an error response.</li>
</ul>

<p>There are also shortcuts to check the state: <code class="language-plaintext highlighter-rouge">pg/idle?</code>, <code class="language-plaintext highlighter-rouge">pg/in-transaction?</code>
and <code class="language-plaintext highlighter-rouge">pg/tx-error?</code>. Here is a quick session:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">;; no transaction</span><span class="w">

</span><span class="p">(</span><span class="nf">pg/status</span><span class="w"> </span><span class="n">conn</span><span class="p">)</span><span class="w">
</span><span class="no">:I</span><span class="w">

</span><span class="p">(</span><span class="nf">pg/idle?</span><span class="w"> </span><span class="n">conn</span><span class="p">)</span><span class="w">
</span><span class="n">true</span><span class="w">

</span><span class="c1">;; begin transaction</span><span class="w">

</span><span class="p">(</span><span class="nf">pg/begin</span><span class="w"> </span><span class="n">conn</span><span class="p">)</span><span class="w">

</span><span class="p">(</span><span class="nf">pg/status</span><span class="w"> </span><span class="n">conn</span><span class="p">)</span><span class="w">
</span><span class="no">:T</span><span class="w">

</span><span class="p">(</span><span class="nf">pg/in-transaction?</span><span class="w"> </span><span class="n">conn</span><span class="p">)</span><span class="w">
</span><span class="n">true</span><span class="w">

</span><span class="c1">;; spoil the transaction</span><span class="w">

</span><span class="p">(</span><span class="nf">pg/query</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="s">"selekt ..."</span><span class="p">)</span><span class="w">

</span><span class="n">Execution</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="p">(</span><span class="nf">ExceptionInfo</span><span class="p">)</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">...</span><span class="w">
</span><span class="n">ErrorResponse</span><span class="w"> </span><span class="n">syntax</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="nb">or</span><span class="w"> </span><span class="n">near</span><span class="w"> </span><span class="sc">\"</span><span class="n">selekt</span><span class="sc">\"</span><span class="n">...</span><span class="w">

</span><span class="p">(</span><span class="nf">pg/status</span><span class="w"> </span><span class="n">conn</span><span class="p">)</span><span class="w">
</span><span class="no">:E</span><span class="w">

</span><span class="p">(</span><span class="nf">pg/tx-error?</span><span class="w"> </span><span class="n">conn</span><span class="p">)</span><span class="w">
</span><span class="n">true</span><span class="w">

</span><span class="c1">;; rolling back</span><span class="w">

</span><span class="p">(</span><span class="nf">pg/rollback</span><span class="w"> </span><span class="n">conn</span><span class="p">)</span><span class="w">

</span><span class="p">(</span><span class="nf">pg/status</span><span class="w"> </span><span class="n">conn</span><span class="p">)</span><span class="w">
</span><span class="no">:I</span><span class="w">

</span><span class="p">(</span><span class="nf">pg/idle?</span><span class="w"> </span><span class="n">conn</span><span class="p">)</span><span class="w">
</span><span class="n">true</span><span class="w">
</span></code></pre></div></div>

<h2 id="configuration">Configuration</h2>

<p>A config map that you pass to <code class="language-plaintext highlighter-rouge">pg/connect</code> has various fields. Most of them are
not necessary and are derived from the default map. Below, please find a list of
parameters and their defaults.</p>

<table>
  <thead>
    <tr>
      <th>Field</th>
      <th>Default</th>
      <th>Comment</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:host</code></td>
      <td><code class="language-plaintext highlighter-rouge">"127.0.0.1"</code></td>
      <td>Host</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:port</code></td>
      <td><code class="language-plaintext highlighter-rouge">5432</code></td>
      <td>Port</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:database</code></td>
      <td>-</td>
      <td>Database</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:user</code></td>
      <td>-</td>
      <td>Username</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:password</code></td>
      <td>-</td>
      <td>Password</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:protocol-version</code></td>
      <td><code class="language-plaintext highlighter-rouge">196608</code> (declared in constants)</td>
      <td>PG protocol version</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:binary-encode?</code></td>
      <td><code class="language-plaintext highlighter-rouge">false</code></td>
      <td>Use binary protocol to write data</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:binary-decode?</code></td>
      <td><code class="language-plaintext highlighter-rouge">false</code></td>
      <td>Use binary protocol to read data</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:fn-notice</code></td>
      <td><code class="language-plaintext highlighter-rouge">pg.client.conn/fn-notice</code></td>
      <td>1-arg function to handle notices (see below)</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:fn-notification</code></td>
      <td><code class="language-plaintext highlighter-rouge">pg.client.conn/fn-notification</code></td>
      <td>1-arg function to handle notifications (see below)</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:socket</code></td>
      <td>(see below)</td>
      <td>A nested map with socket options</td>
    </tr>
  </tbody>
</table>

<p>The <code class="language-plaintext highlighter-rouge">:socket</code> map has the following sub-options:</p>

<table>
  <thead>
    <tr>
      <th>Field</th>
      <th>Default</th>
      <th>Comment</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:tcp-no-delay?</code></td>
      <td><code class="language-plaintext highlighter-rouge">true</code></td>
      <td>Set <code class="language-plaintext highlighter-rouge">TCP_NODELAY</code> socket boolean property</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:so-keep-alive?</code></td>
      <td><code class="language-plaintext highlighter-rouge">true</code></td>
      <td>Set <code class="language-plaintext highlighter-rouge">SO_KEEPALIVE</code> socket boolean property</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:so-reuse-addr?</code></td>
      <td><code class="language-plaintext highlighter-rouge">true</code></td>
      <td>Set <code class="language-plaintext highlighter-rouge">SO_REUSEADDR</code> socket boolean property</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:so-reuse-port?</code></td>
      <td><code class="language-plaintext highlighter-rouge">true</code></td>
      <td>Set <code class="language-plaintext highlighter-rouge">SO_REUSEPORT</code> socket boolean property</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:so-rcv-buf</code></td>
      <td>-</td>
      <td>Set <code class="language-plaintext highlighter-rouge">SO_RCVBUF</code> socket size; <strong>must be</strong> an integer (e.g. <code class="language-plaintext highlighter-rouge">(int 123456)</code>)</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:so-snd-buf</code></td>
      <td>-</td>
      <td>Set <code class="language-plaintext highlighter-rouge">SO_SNDBUF</code> socket size; <strong>must be</strong> an integer (e.g. <code class="language-plaintext highlighter-rouge">(int 123456)</code>)</td>
    </tr>
  </tbody>
</table>

<p>Here is an example of the configuration:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="no">:host</span><span class="w"> </span><span class="s">"127.0.0.1"</span><span class="w">
 </span><span class="no">:port</span><span class="w"> </span><span class="mi">5432</span><span class="w">
 </span><span class="no">:database</span><span class="w"> </span><span class="s">"project_dev"</span><span class="w">
 </span><span class="no">:user</span><span class="w"> </span><span class="s">"ivan"</span><span class="w">
 </span><span class="no">:password</span><span class="w"> </span><span class="s">"Secret123"</span><span class="w">
 </span><span class="no">:fn-notice</span><span class="w"> </span><span class="n">my-notice-handler</span><span class="w">
 </span><span class="no">:fn-notification</span><span class="w"> </span><span class="n">my-notification-handler</span><span class="w">
 </span><span class="no">:protocol-version</span><span class="w"> </span><span class="n">const/PROTOCOL_VERSION</span><span class="w">
 </span><span class="no">:binary-encode?</span><span class="w"> </span><span class="n">true</span><span class="w">
 </span><span class="no">:binary-decode?</span><span class="w"> </span><span class="n">true</span><span class="w">
 </span><span class="no">:socket</span><span class="w"> </span><span class="p">{</span><span class="no">:tcp-no-delay?</span><span class="w"> </span><span class="n">true</span><span class="w">
          </span><span class="no">:so-keep-alive?</span><span class="w"> </span><span class="n">true</span><span class="w">
          </span><span class="no">:so-reuse-addr?</span><span class="w"> </span><span class="n">true</span><span class="w">
          </span><span class="no">:so-reuse-port?</span><span class="w"> </span><span class="n">true</span><span class="w">
          </span><span class="no">:so-rcv-buf</span><span class="w"> </span><span class="p">(</span><span class="nb">int</span><span class="w"> </span><span class="n">...</span><span class="p">)</span><span class="w">
          </span><span class="no">:so-snd-buf</span><span class="w"> </span><span class="p">(</span><span class="nb">int</span><span class="w"> </span><span class="n">...</span><span class="p">)}}</span><span class="w">
</span></code></pre></div></div>

<h2 id="authorization">Authorization</h2>

<p>The PG client supports several authentication pipelines:</p>

<table>
  <thead>
    <tr>
      <th>Title</th>
      <th>pg_hba.conf</th>
      <th>Comment</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>No password</td>
      <td><code class="language-plaintext highlighter-rouge">trust</code></td>
      <td>No password is sent; used when user &amp; host are trusted</td>
    </tr>
    <tr>
      <td>Clear password</td>
      <td><code class="language-plaintext highlighter-rouge">password</code></td>
      <td>The password is sent unmasked; quite unsafe</td>
    </tr>
    <tr>
      <td>MD5</td>
      <td><code class="language-plaintext highlighter-rouge">md5</code></td>
      <td>The password is sent being MD5-hashed with salt; the default method prior v15</td>
    </tr>
    <tr>
      <td>SASL</td>
      <td><code class="language-plaintext highlighter-rouge">scram-sha-256</code></td>
      <td>3-steps pipeline with complex algorith; set as default since v15</td>
    </tr>
  </tbody>
</table>

<p>The SASL method includes two algorithms: SCRAM-SHA-256 and
SCRAM-SHA-256-PLUS. It’s up to the client which one to use. At the moment, only
SCRAM-SHA-256 is implemented.</p>

<h2 id="cloning-a-connection">Cloning a connection</h2>

<p>The <code class="language-plaintext highlighter-rouge">pg/clone</code> function spawns a new connection from an existing one. It reuses
the config from a given connection.</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pg/with-connection</span><span class="w"> </span><span class="p">[</span><span class="n">conn</span><span class="w"> </span><span class="n">config</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nb">with-open</span><span class="w"> </span><span class="p">[</span><span class="n">conn2</span><span class="w"> </span><span class="p">(</span><span class="nf">pg/clone</span><span class="w"> </span><span class="n">conn</span><span class="p">)]</span><span class="w">
    </span><span class="p">(</span><span class="nf">pg/query</span><span class="w"> </span><span class="n">conn2</span><span class="w"> </span><span class="s">"select 1 as one"</span><span class="p">)))</span><span class="w">

</span><span class="p">[{</span><span class="no">:one</span><span class="w"> </span><span class="mi">1</span><span class="p">}]</span><span class="w">
</span></code></pre></div></div>

<h2 id="cancelling-a-query">Cancelling a query</h2>

<p>Sometimes, a poorly composed query might hang. If you have a reference to the
connection that has spawned such a query, you may cancel it. Cancelling a query
requires a new connection to be opened and thus is usually done in a separate
thread.</p>

<p>Imagine you’re running a long query in the future:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">fut</span><span class="w">
  </span><span class="p">(</span><span class="nf">future</span><span class="w">
    </span><span class="p">(</span><span class="nf">pg/query</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="s">"select pg_sleep(600) as sleep"</span><span class="p">)))</span><span class="w">
</span></code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">pg/cancel</code> takes a connection and cancels its current query:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pg/cancel</span><span class="w"> </span><span class="n">conn</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>Now if you try to deref the future, you’ll get an exception caused by an error
response from the server:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">fut</span><span class="w">

</span><span class="n">java.util.concurrent.ExecutionException</span><span class="w"> </span><span class="n">...</span><span class="w">
</span><span class="n">clojure.lang.ExceptionInfo</span><span class="err">:</span><span class="w"> </span><span class="n">ErrorResponse</span><span class="w"> </span><span class="n">...</span><span class="w">
</span></code></pre></div></div>

<p>Here is what inside the <code class="language-plaintext highlighter-rouge">ex-data</code>:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">try</span><span class="w">
  </span><span class="o">@</span><span class="n">fut</span><span class="w">
  </span><span class="p">(</span><span class="nf">catch</span><span class="w"> </span><span class="n">ExecutionException</span><span class="w"> </span><span class="n">e</span><span class="w">
    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">data</span><span class="w"> </span><span class="p">(</span><span class="nb">-&gt;</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="n">ex-case</span><span class="w"> </span><span class="n">ex-data</span><span class="p">)]</span><span class="w">
      </span><span class="n">...</span><span class="p">)))</span><span class="w">

</span><span class="p">{</span><span class="no">:error</span><span class="w">
 </span><span class="p">{</span><span class="no">:msg</span><span class="w"> </span><span class="no">:ErrorResponse,</span><span class="w">
  </span><span class="no">:errors</span><span class="w">
  </span><span class="p">{</span><span class="no">:severity</span><span class="w"> </span><span class="s">"ERROR"</span><span class="n">,</span><span class="w">
   </span><span class="no">:verbosity</span><span class="w"> </span><span class="s">"ERROR"</span><span class="n">,</span><span class="w">
   </span><span class="no">:code</span><span class="w"> </span><span class="s">"57014"</span><span class="n">,</span><span class="w">
   </span><span class="no">:message</span><span class="w"> </span><span class="s">"canceling statement due to user request"</span><span class="n">,</span><span class="w">
   </span><span class="no">:file</span><span class="w"> </span><span class="s">"postgres.c"</span><span class="n">,</span><span class="w">
   </span><span class="no">:line</span><span class="w"> </span><span class="s">"3092"</span><span class="n">,</span><span class="w">
   </span><span class="no">:function</span><span class="w"> </span><span class="s">"ProcessInterrupts"</span><span class="p">}}}</span><span class="w">
</span></code></pre></div></div>

<p>Under the hood, cancelling a query means taking some private data from the
target connection, opening a new connection and sending a special message. Then,
the new connection gets closed immediately.</p>

<h2 id="notices">Notices</h2>

<p>In Postgres, notices are short informative messages shown to the user
sometimes. For example, if you try to <code class="language-plaintext highlighter-rouge">ROLLBACK</code> although there was no <code class="language-plaintext highlighter-rouge">BEGIN</code>
first, you won’t get an error but a notice instead.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ROLLBACK;
WARNING:  there is no transaction in progress
</code></pre></div></div>

<p><strong>Don’t mix notices with notifications (see the corresponding chapter).</strong></p>

<p>By default, the client library just prints the <code class="language-plaintext highlighter-rouge">NoticeResponse</code> map with all the
fields. You’re welcome to pass your own notice handler which logs them, stores
them in an atom or whatever else:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">my-notice-handler</span><span class="w"> </span><span class="p">[</span><span class="n">NoticeResponse</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nf">log/infof</span><span class="w"> </span><span class="s">"Notice response: %s"</span><span class="w"> </span><span class="n">NoticeResponse</span><span class="p">))</span><span class="w">

</span><span class="c1">;; or</span><span class="w">

</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">notices!</span><span class="w"> </span><span class="p">(</span><span class="nf">atom</span><span class="w"> </span><span class="p">[]))</span><span class="w">

</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">my-notice-handler</span><span class="w"> </span><span class="p">[</span><span class="n">NoticeResponse</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nf">swap!</span><span class="w"> </span><span class="n">notices!</span><span class="w"> </span><span class="nb">conj</span><span class="w"> </span><span class="n">NoticeResponse</span><span class="p">))</span><span class="w">

</span><span class="c1">;; config</span><span class="w">

</span><span class="p">{</span><span class="no">:host</span><span class="w"> </span><span class="s">"127.0.0.1"</span><span class="w">
 </span><span class="no">:port</span><span class="w"> </span><span class="mi">5432</span><span class="w">
 </span><span class="n">...</span><span class="w">
 </span><span class="no">:fn-notice</span><span class="w"> </span><span class="n">my-notice-handler</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h2 id="thread-safety">Thread safety</h2>

<p>The connection object <strong>is not thread-safe</strong>. What it means is, that sharing a
connection between multiple threads (futures, agents) might lead to weird
behaviour when two threads read something from a socket
simultaneously. Technically it’s possible to fix that by wrapping each API call
with <code class="language-plaintext highlighter-rouge">with-locking</code>; yet it’s much better to use the connection pool. The pool
provides a special <code class="language-plaintext highlighter-rouge">with-connection</code> macro that ships the <code class="language-plaintext highlighter-rouge">with-locking</code> wrapper
under the hood, so no other threads can interfere.</p>

<h2 id="debugging">Debugging</h2>

<p>It’s quite easy to debug messages that the client sends and receives from the
server. Run REPL with either the <code class="language-plaintext highlighter-rouge">PG_DEBUG</code> environment variable or <code class="language-plaintext highlighter-rouge">pg.debug</code>
system property set:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">PG_DEBUG=1</span><span class="w"> </span><span class="n">lein</span><span class="w"> </span><span class="n">with-profile</span><span class="w"> </span><span class="n">+test</span><span class="w"> </span><span class="n">repl</span><span class="w">

</span><span class="c1">;; or, in lein:</span><span class="w">

</span><span class="no">:profiles</span><span class="w"> </span><span class="p">{</span><span class="no">:dev</span><span class="w"> </span><span class="p">{</span><span class="no">:jvm-opts</span><span class="w"> </span><span class="p">[</span><span class="s">"-Dpg.debug=1"</span><span class="p">]}}</span><span class="w">
</span></code></pre></div></div>

<p>Now that you have the debug option set, run some queries in REPL, and you’ll see
the dump:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w">
</span><span class="c1">;; startup pipeline</span><span class="w">

 </span><span class="nb">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="no">:msg</span><span class="w"> </span><span class="no">:StartupMessage,</span><span class="w"> </span><span class="no">:protocol-version</span><span class="w"> </span><span class="mi">196608</span><span class="n">,</span><span class="w"> </span><span class="no">:user</span><span class="w"> </span><span class="n">test,</span><span class="w"> </span><span class="no">:database</span><span class="w"> </span><span class="n">test,</span><span class="w"> </span><span class="no">:options</span><span class="w"> </span><span class="n">nil</span><span class="p">}</span><span class="w">
</span><span class="n">&lt;-</span><span class="w">  </span><span class="p">{</span><span class="no">:msg</span><span class="w"> </span><span class="no">:AuthenticationSASL,</span><span class="w"> </span><span class="no">:status</span><span class="w"> </span><span class="mi">10</span><span class="n">,</span><span class="w"> </span><span class="no">:sasl-types</span><span class="w"> </span><span class="o">#</span><span class="p">{</span><span class="n">SCRAM-SHA-256</span><span class="p">}}</span><span class="w">
 </span><span class="nb">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="no">:msg</span><span class="w"> </span><span class="no">:SASLInitialResponse,</span><span class="w"> </span><span class="no">:sasl-type</span><span class="w"> </span><span class="n">SCRAM-SHA-256,</span><span class="w"> </span><span class="no">:client-first-message</span><span class="w"> </span><span class="n">n,,n=test,r=2c0549c8-ef3f-44d4-82e4-4ad99303f7ec</span><span class="p">}</span><span class="w">
</span><span class="n">&lt;-</span><span class="w">  </span><span class="p">{</span><span class="no">:msg</span><span class="w"> </span><span class="no">:AuthenticationSASLContinue,</span><span class="w"> </span><span class="no">:status</span><span class="w"> </span><span class="mi">11</span><span class="n">,</span><span class="w"> </span><span class="no">:server-first-message</span><span class="w"> </span><span class="n">r=2c0549c8-ef3f-44d4-82e4-4ad99303f7echCLyIqVeK1lswQUcIZPZgNB5,s=qkGROo12a/m8jDa9wv90TA==,i=4096</span><span class="p">}</span><span class="w">
 </span><span class="nb">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="no">:msg</span><span class="w"> </span><span class="no">:SASLResponse,</span><span class="w"> </span><span class="no">:client-final-message</span><span class="w"> </span><span class="n">c=biws,r=2c0549c8-ef3f-44d4-82e4-4ad99303f7echCLyIqVeK1lswQUcIZPZgNB5,p=IbvOGV7fKIj+OIt54dopu/HI35+9Q67R7uPRp1/Ein8=</span><span class="p">}</span><span class="w">
</span><span class="n">&lt;-</span><span class="w">  </span><span class="p">{</span><span class="no">:msg</span><span class="w"> </span><span class="no">:AuthenticationSASLFinal,</span><span class="w"> </span><span class="no">:status</span><span class="w"> </span><span class="mi">12</span><span class="n">,</span><span class="w"> </span><span class="no">:server-final-message</span><span class="w"> </span><span class="n">v=0Mj1tVhYjDUKt7k9ClCkj9h/6zyVtLMAlZ9HIKA6vyc=</span><span class="p">}</span><span class="w">
</span><span class="n">&lt;-</span><span class="w">  </span><span class="p">{</span><span class="no">:msg</span><span class="w"> </span><span class="no">:AuthenticationOk,</span><span class="w"> </span><span class="no">:status</span><span class="w"> </span><span class="mi">0</span><span class="p">}</span><span class="w">

</span><span class="c1">;; init pipeline</span><span class="w">

</span><span class="n">&lt;-</span><span class="w">  </span><span class="p">{</span><span class="no">:msg</span><span class="w"> </span><span class="no">:ParameterStatus,</span><span class="w"> </span><span class="no">:param</span><span class="w"> </span><span class="n">in_hot_standby,</span><span class="w"> </span><span class="no">:value</span><span class="w"> </span><span class="n">off</span><span class="p">}</span><span class="w">
</span><span class="n">&lt;-</span><span class="w">  </span><span class="p">{</span><span class="no">:msg</span><span class="w"> </span><span class="no">:ParameterStatus,</span><span class="w"> </span><span class="no">:param</span><span class="w"> </span><span class="n">integer_datetimes,</span><span class="w"> </span><span class="no">:value</span><span class="w"> </span><span class="n">on</span><span class="p">}</span><span class="w">
</span><span class="n">&lt;-</span><span class="w">  </span><span class="p">{</span><span class="no">:msg</span><span class="w"> </span><span class="no">:ParameterStatus,</span><span class="w"> </span><span class="no">:param</span><span class="w"> </span><span class="n">TimeZone,</span><span class="w"> </span><span class="no">:value</span><span class="w"> </span><span class="n">Etc/UTC</span><span class="p">}</span><span class="w">
</span><span class="n">&lt;-</span><span class="w">  </span><span class="p">{</span><span class="no">:msg</span><span class="w"> </span><span class="no">:ParameterStatus,</span><span class="w"> </span><span class="no">:param</span><span class="w"> </span><span class="n">IntervalStyle,</span><span class="w"> </span><span class="no">:value</span><span class="w"> </span><span class="n">postgres</span><span class="p">}</span><span class="w">
</span><span class="n">&lt;-</span><span class="w">  </span><span class="p">{</span><span class="no">:msg</span><span class="w"> </span><span class="no">:ParameterStatus,</span><span class="w"> </span><span class="no">:param</span><span class="w"> </span><span class="n">is_superuser,</span><span class="w"> </span><span class="no">:value</span><span class="w"> </span><span class="n">on</span><span class="p">}</span><span class="w">
</span><span class="n">&lt;-</span><span class="w">  </span><span class="p">{</span><span class="no">:msg</span><span class="w"> </span><span class="no">:ParameterStatus,</span><span class="w"> </span><span class="no">:param</span><span class="w"> </span><span class="n">application_name,</span><span class="w"> </span><span class="no">:value</span><span class="w"> </span><span class="p">}</span><span class="w">
</span><span class="n">&lt;-</span><span class="w">  </span><span class="p">{</span><span class="no">:msg</span><span class="w"> </span><span class="no">:ParameterStatus,</span><span class="w"> </span><span class="no">:param</span><span class="w"> </span><span class="n">default_transaction_read_only,</span><span class="w"> </span><span class="no">:value</span><span class="w"> </span><span class="n">off</span><span class="p">}</span><span class="w">
</span><span class="n">&lt;-</span><span class="w">  </span><span class="p">{</span><span class="no">:msg</span><span class="w"> </span><span class="no">:ParameterStatus,</span><span class="w"> </span><span class="no">:param</span><span class="w"> </span><span class="n">scram_iterations,</span><span class="w"> </span><span class="no">:value</span><span class="w"> </span><span class="mi">4096</span><span class="p">}</span><span class="w">
</span><span class="n">&lt;-</span><span class="w">  </span><span class="p">{</span><span class="no">:msg</span><span class="w"> </span><span class="no">:ParameterStatus,</span><span class="w"> </span><span class="no">:param</span><span class="w"> </span><span class="n">DateStyle,</span><span class="w"> </span><span class="no">:value</span><span class="w"> </span><span class="n">ISO,</span><span class="w"> </span><span class="n">MDY</span><span class="p">}</span><span class="w">
</span><span class="n">&lt;-</span><span class="w">  </span><span class="p">{</span><span class="no">:msg</span><span class="w"> </span><span class="no">:ParameterStatus,</span><span class="w"> </span><span class="no">:param</span><span class="w"> </span><span class="n">standard_conforming_strings,</span><span class="w"> </span><span class="no">:value</span><span class="w"> </span><span class="n">on</span><span class="p">}</span><span class="w">
</span><span class="n">&lt;-</span><span class="w">  </span><span class="p">{</span><span class="no">:msg</span><span class="w"> </span><span class="no">:ParameterStatus,</span><span class="w"> </span><span class="no">:param</span><span class="w"> </span><span class="n">session_authorization,</span><span class="w"> </span><span class="no">:value</span><span class="w"> </span><span class="nb">test</span><span class="p">}</span><span class="w">
</span><span class="n">&lt;-</span><span class="w">  </span><span class="p">{</span><span class="no">:msg</span><span class="w"> </span><span class="no">:ParameterStatus,</span><span class="w"> </span><span class="no">:param</span><span class="w"> </span><span class="n">client_encoding,</span><span class="w"> </span><span class="no">:value</span><span class="w"> </span><span class="n">UTF8</span><span class="p">}</span><span class="w">
</span><span class="n">&lt;-</span><span class="w">  </span><span class="p">{</span><span class="no">:msg</span><span class="w"> </span><span class="no">:ParameterStatus,</span><span class="w"> </span><span class="no">:param</span><span class="w"> </span><span class="n">server_version,</span><span class="w"> </span><span class="no">:value</span><span class="w"> </span><span class="mi">16</span><span class="n">beta2</span><span class="w"> </span><span class="p">(</span><span class="nf">Debian</span><span class="w"> </span><span class="mi">16</span><span class="o">~</span><span class="n">beta2-1.pgdg120+1</span><span class="p">)}</span><span class="w">
</span><span class="n">&lt;-</span><span class="w">  </span><span class="p">{</span><span class="no">:msg</span><span class="w"> </span><span class="no">:ParameterStatus,</span><span class="w"> </span><span class="no">:param</span><span class="w"> </span><span class="n">server_encoding,</span><span class="w"> </span><span class="no">:value</span><span class="w"> </span><span class="n">UTF8</span><span class="p">}</span><span class="w">
</span><span class="n">&lt;-</span><span class="w">  </span><span class="p">{</span><span class="no">:msg</span><span class="w"> </span><span class="no">:BackendKeyData,</span><span class="w"> </span><span class="no">:pid</span><span class="w"> </span><span class="mi">5671</span><span class="n">,</span><span class="w"> </span><span class="no">:secret-key</span><span class="w"> </span><span class="mi">-1344960525</span><span class="p">}</span><span class="w">
</span><span class="n">&lt;-</span><span class="w">  </span><span class="p">{</span><span class="no">:msg</span><span class="w"> </span><span class="no">:ReadyForQuery,</span><span class="w"> </span><span class="no">:tx-status</span><span class="w"> </span><span class="no">:I</span><span class="p">}</span><span class="w">

</span><span class="c1">;; a hanging query has been run</span><span class="w">

 </span><span class="nb">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="no">:msg</span><span class="w"> </span><span class="no">:Query,</span><span class="w"> </span><span class="no">:query</span><span class="w"> </span><span class="nb">select</span><span class="w"> </span><span class="n">pg_sleep</span><span class="p">(</span><span class="nf">60</span><span class="p">)</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="n">sleep</span><span class="p">}</span><span class="w">

</span><span class="c1">;; cancelling it from another connection and terminate</span><span class="w">

 </span><span class="nb">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="no">:msg</span><span class="w"> </span><span class="no">:CancelRequest,</span><span class="w"> </span><span class="no">:code</span><span class="w"> </span><span class="mi">80877102</span><span class="n">,</span><span class="w"> </span><span class="no">:pid</span><span class="w"> </span><span class="mi">5671</span><span class="n">,</span><span class="w"> </span><span class="no">:secret-key</span><span class="w"> </span><span class="mi">-1344960525</span><span class="p">}</span><span class="w">
 </span><span class="nb">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="no">:msg</span><span class="w"> </span><span class="no">:Terminate</span><span class="p">}</span><span class="w">

</span><span class="c1">;; the query fails, emits an error message, then the connection is ready for</span><span class="w">
</span><span class="c1">;;  further queries</span><span class="w">

</span><span class="n">&lt;-</span><span class="w">  </span><span class="p">{</span><span class="no">:msg</span><span class="w"> </span><span class="no">:RowDescription,</span><span class="w"> </span><span class="no">:column-count</span><span class="w"> </span><span class="mi">1</span><span class="n">,</span><span class="w"> </span><span class="no">:columns</span><span class="w"> </span><span class="p">[{</span><span class="no">:index</span><span class="w"> </span><span class="mi">0</span><span class="n">,</span><span class="w"> </span><span class="no">:name</span><span class="w"> </span><span class="n">sleep,</span><span class="w"> </span><span class="no">:table-oid</span><span class="w"> </span><span class="mi">0</span><span class="n">,</span><span class="w"> </span><span class="no">:column-oid</span><span class="w"> </span><span class="mi">0</span><span class="n">,</span><span class="w"> </span><span class="no">:type-oid</span><span class="w"> </span><span class="mi">2278</span><span class="n">,</span><span class="w"> </span><span class="no">:type-len</span><span class="w"> </span><span class="mi">4</span><span class="n">,</span><span class="w"> </span><span class="no">:type-mod</span><span class="w"> </span><span class="mi">-1</span><span class="n">,</span><span class="w"> </span><span class="no">:format</span><span class="w"> </span><span class="mi">0</span><span class="p">}]}</span><span class="w">
</span><span class="n">&lt;-</span><span class="w">  </span><span class="p">{</span><span class="no">:msg</span><span class="w"> </span><span class="no">:ErrorResponse,</span><span class="w"> </span><span class="no">:errors</span><span class="w"> </span><span class="p">{</span><span class="no">:severity</span><span class="w"> </span><span class="n">ERROR,</span><span class="w"> </span><span class="no">:verbosity</span><span class="w"> </span><span class="n">ERROR,</span><span class="w"> </span><span class="no">:code</span><span class="w"> </span><span class="mi">57014</span><span class="n">,</span><span class="w"> </span><span class="no">:message</span><span class="w"> </span><span class="n">canceling</span><span class="w"> </span><span class="n">statement</span><span class="w"> </span><span class="n">due</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="n">request,</span><span class="w"> </span><span class="no">:file</span><span class="w"> </span><span class="n">postgres.c,</span><span class="w"> </span><span class="no">:line</span><span class="w"> </span><span class="mi">3396</span><span class="n">,</span><span class="w"> </span><span class="no">:function</span><span class="w"> </span><span class="n">ProcessInterrupts</span><span class="p">}}</span><span class="w">
</span><span class="n">&lt;-</span><span class="w">  </span><span class="p">{</span><span class="no">:msg</span><span class="w"> </span><span class="no">:ReadyForQuery,</span><span class="w"> </span><span class="no">:tx-status</span><span class="w"> </span><span class="no">:I</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>The right arrow ` -&gt;<code class="language-plaintext highlighter-rouge"> means the message is passed from the client to the
server. The left arrow </code>&lt;- ` stands for reading a message from the server.</p>

<p>The debugging facilities come from the <code class="language-plaintext highlighter-rouge">pg.client.debug</code> namespace.</p>

  </div>

</article>

<center>
    <p>
        <small>Нашли ошибку? Выделите мышкой и нажмите Ctrl/&#8984;+Enter</small>
    </p>
</center>






<center>Комментариев пока нет</center>









<form id="comment-form" method="POST" action="https://functions.yandexcloud.net/d4ehfuf08fjfjr59ivnf">

    <div class="block">
        <p class="comment-form-label"><small>Your name</small></p>
        <input required id="comment-form-author" name="author" type="text">
    </div>

    <div class="block">
        <p class="comment-form-label"><small>Comment (markdown syntax)</small></p>
        <textarea required id="comment-form-comment" name="comment"></textarea>
    </div>

    <input required name="path" type="hidden" value="/en/pg-docs/02/">
    <input required name="captcha" type="hidden" value="4 &#215; 9">

    <div class="block">
        <span class="comment-form-label"><small>4 &#215; 9 = </small></span>
        <input required id="comment-form-solution" name="solution" type="text">
    </div>

    <div class="block">
        <button id="comment-form-send" type="submit">Send</button>
    </div>

</form>


      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Ivan Grishaev's blog</li>
          <li><a href="mailto:ivan@grishaev.me">ivan@grishaev.me</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
            <li><a href="https://github.com/igrishaev">GitHub</a></li>
            <li><a href="tg://resolve?domain=igrishaev_blog">Telegram</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Writing on programming, education, books and negotiations.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
