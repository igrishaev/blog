<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Virtuoso: a Clojure wrapper for virtual threads</title>
  <meta name="description" content="">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/custom.css">
  <link rel="canonical" href="https://grishaev.me/en/virtuoso/">
  <link rel="alternate" type="application/rss+xml" title="Ivan Grishaev's blog" href="https://grishaev.me/feed.xml">

  <link rel="shortcut icon" type="image/x-icon" href="/assets/static/favicons/favicon.ico">

  <script type="text/javascript" src="/assets/typo.js"></script>

</head>


  <body>
    <header class="site-header">

    <div class="wrapper flex-container">

        <div>
            <a href="/">
                <img id="avatar" src="/assets/static/avatar.jpg" alt="Ivan Grishaev">
            </a>
        </div>

        <div class="flex-container-vert" style="margin-left: 15px; width: 80%">

            <div class="flex-container full-width">
                <p style="margin-bottom: 5px">Ivan Grishaev's blog</p>
                <div class="flex-huge"></div>
                <div >
<form id="search-form"
      target="_blank"
      style="display: inline"
      method="get"
      action="https://www.google.com/search">

    <input name="sitesearch"
           value="grishaev.me"
           type="hidden">

    <input type="text"
           required="required"
           name="q"
           placeholder="Google search..."
           autocomplete="off">

    <button style="border: none; background-color: transparent; cursor: pointer;"
            type="submit">&#x1f50d;</button>

</form>
</div>
            </div>

            <p><small>Writing on programming, education, books and negotiations.
</small></p>

            <div class="flex-container">
                <a class="menu-item" href="/">Home</a>
                <a class="menu-item" href="/about/">About</a>
                <a class="menu-item" href="/bookshelf/">Bookshelf</a>
                <a class="menu-item" href="/feed.xml">RSS</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor" href="/tag/clojure/">Clojure</a>
                <a class="menu-item minor" href="/tag/emacs/">Emacs</a>
                <a class="menu-item minor" href="/tag/python/">Python</a>
                <a class="menu-item minor" href="/tag/programming/">Programming</a>
                <a class="menu-item minor" href="/interview/">Interview</a>
                <a class="menu-item minor" href="/video/">Video</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor hl" href="/clojure-in-prod/">Книга «Clojure на производстве»</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor hl" href="/clojure-in-prod-2/">Книга «Clojure на производстве», второй том</a>
            </div>

        </div>
    </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">

    <h1 class="post-title" itemprop="name headline">Virtuoso: a Clojure wrapper for virtual threads</h1>

    
<div class="post-meta">

    <time class="post-time"
          datetime="2023-10-16T00:00:00+00:00">
        Oct 16, 2023
    </time>

    <a href="/tag/clojure/" rel="tag">clojure</a>, <a href="/tag/virtual/" rel="tag">virtual</a>, <a href="/tag/threads/" rel="tag">threads</a>, <a href="/tag/java21/" rel="tag">java21</a>

</div>


  </header>

  <div class="post-content" itemprop="articleBody">
    
<p><a href="https://github.com/igrishaev/virtuoso">Virtuoso</a> is small wrapper on top of <a href="https://docs.oracle.com/en/java/javase/21/core/virtual-threads.html">virtual threads</a>
introduced in Java 21.</p>

<h2 id="about">About</h2>

<p>The recent release of Java 21 introduced virtual threads to the scene. It’s a
nice feature that allows you to run imperative code, such as it was written in
an asynchronous way. This library is a naive attempt to gain something from the
virtual threads.</p>

<h2 id="installation">Installation</h2>

<p>Lein</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="n">com.github.igrishaev/virtuoso</span><span class="w"> </span><span class="s">"0.1.0"</span><span class="p">]</span><span class="w">
</span></code></pre></div></div>

<p>Deps/CLI</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="n">com.github.igrishaev/virtuoso</span><span class="w"> </span><span class="p">{</span><span class="no">:mvn/version</span><span class="w"> </span><span class="s">"0.1.0"</span><span class="p">}}</span><span class="w">
</span></code></pre></div></div>

<h2 id="usage">Usage</h2>

<p>First, import the library:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">require</span><span class="w"> </span><span class="o">'</span><span class="p">[</span><span class="n">virtuoso.core</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">v</span><span class="p">])</span><span class="w">
</span></code></pre></div></div>

<h3 id="with-executor">with-executor</h3>

<p>The <code class="language-plaintext highlighter-rouge">with-executor</code> wraps a block of code binding a new instance of
<code class="language-plaintext highlighter-rouge">VirtualThreadPerTaskExecutor</code> to the passed symbol:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">v/with-executor</span><span class="w"> </span><span class="p">[</span><span class="n">exe</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nf">do-this</span><span class="w"> </span><span class="n">...</span><span class="p">)</span><span class="w">
  </span><span class="p">(</span><span class="nf">do-that</span><span class="w"> </span><span class="n">...</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<p>Above, the executor is bound to the <code class="language-plaintext highlighter-rouge">exe</code> symbol. Exiting from the macro will
trigger closing the executor, which, in turn, leads to blocking until all the
tasks sent to it are complete. The <code class="language-plaintext highlighter-rouge">with-executor</code> macro, although it might be
used on your code, is instead a building material for other macros.</p>

<h3 id="future-via">future-via</h3>

<p>The <code class="language-plaintext highlighter-rouge">future-via</code> macro spawns a new virtual future through a previously open
executor. You can generate as many futures as you want due to the nature of
virtual threads: there might be millions of them.</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">v/with-executor</span><span class="w"> </span><span class="p">[</span><span class="n">exe</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">f1</span><span class="w"> </span><span class="p">(</span><span class="nf">v/future-via</span><span class="w"> </span><span class="n">exe</span><span class="w">
             </span><span class="p">(</span><span class="nf">do-this</span><span class="w"> </span><span class="n">...</span><span class="p">))</span><span class="w">
        </span><span class="n">f2</span><span class="w"> </span><span class="p">(</span><span class="nf">v/future-via</span><span class="w"> </span><span class="n">exe</span><span class="w">
             </span><span class="p">(</span><span class="nf">do-that</span><span class="w"> </span><span class="n">...</span><span class="p">))]</span><span class="w">
    </span><span class="p">[</span><span class="o">@</span><span class="n">f1</span><span class="w"> </span><span class="o">@</span><span class="n">f2</span><span class="p">]))</span><span class="w">
</span></code></pre></div></div>

<p>Virtual futures give performance gain only when the code they wrap makes
IO. Instead, if you run CPU-based computations in virtual threads, the
performance suffers due to continuations and moving the stack trace from the
stack to the heap and back.</p>

<h3 id="futures">futures(!)</h3>

<p>The <code class="language-plaintext highlighter-rouge">futures</code> macro takes a series of forms. It spawns a new virtual thread
executor and wraps each form into a future bound to that executor. The result is
a vector of <code class="language-plaintext highlighter-rouge">Future</code> objects. To obtain values, pass the result through
<code class="language-plaintext highlighter-rouge">(map/mapv deref ...)</code>:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">futs</span><span class="w">
      </span><span class="p">(</span><span class="nf">v/futures</span><span class="w">
       </span><span class="p">(</span><span class="nf">io-heavy-task-1</span><span class="w"> </span><span class="n">...</span><span class="p">)</span><span class="w">
       </span><span class="p">(</span><span class="nf">io-heavy-task-2</span><span class="w"> </span><span class="n">...</span><span class="p">)</span><span class="w">
       </span><span class="p">(</span><span class="nf">io-heavy-task-3</span><span class="w"> </span><span class="n">...</span><span class="p">))]</span><span class="w">
  </span><span class="p">(</span><span class="nf">mapv</span><span class="w"> </span><span class="nb">deref</span><span class="w"> </span><span class="n">futs</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<p>Right before you exit the macro, it closes the executor, which leads to blicking
until all the tasks are complete.</p>

<p>Pay attention that <code class="language-plaintext highlighter-rouge">deref</code>-ing a failed future leads to throwing an
exception. That’s why the macro doesn’t dereference the futures for you, as it
doesn’t know how to handle errors. But if you don’t care about exception
handling, there is a <code class="language-plaintext highlighter-rouge">futures!</code> macro that does it for you:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">v/futures!</span><span class="w">
  </span><span class="p">(</span><span class="nf">io-heavy-task-1</span><span class="w"> </span><span class="n">...</span><span class="p">)</span><span class="w">
  </span><span class="p">(</span><span class="nf">io-heavy-task-2</span><span class="w"> </span><span class="n">...</span><span class="p">)</span><span class="w">
  </span><span class="p">(</span><span class="nf">io-heavy-task-3</span><span class="w"> </span><span class="n">...</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<p>The result will be vector of dereferenced values.</p>

<h3 id="thread">thread</h3>

<p>The <code class="language-plaintext highlighter-rouge">thread</code> macro spawns and starts a new virtual thread using the
<code class="language-plaintext highlighter-rouge">(Thread/ofVirtual)</code> call. Threads in Java do not return values; they can only
be <code class="language-plaintext highlighter-rouge">join</code>-ed or interrupted. Use this macro when interested in a <code class="language-plaintext highlighter-rouge">Thread</code> object
but not the result.</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">thread1</span><span class="w">
      </span><span class="p">(</span><span class="nf">v/thread</span><span class="w">
        </span><span class="p">(</span><span class="nf">some-long-task</span><span class="w"> </span><span class="n">...</span><span class="p">))</span><span class="w">

      </span><span class="n">thread2</span><span class="w">
      </span><span class="p">(</span><span class="nf">v/thread</span><span class="w">
        </span><span class="p">(</span><span class="nf">some-long-task</span><span class="w"> </span><span class="n">...</span><span class="p">))]</span><span class="w">

  </span><span class="p">(</span><span class="nf">.join</span><span class="w"> </span><span class="n">thread1</span><span class="p">)</span><span class="w">
  </span><span class="p">(</span><span class="nf">.join</span><span class="w"> </span><span class="n">thread2</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<h3 id="pmap">pmap(!)</h3>

<p>The <code class="language-plaintext highlighter-rouge">pmap</code> function acts like the standard <code class="language-plaintext highlighter-rouge">clojure.core/pmap</code>: it takes a
function and a collection (or more collections). It opens a new virtual executor
and submits each calculation step to the executor. The result is a vector of
futures. The function closes the executor afterwards, blocking until all the
tasks are complete.</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">futs</span><span class="w">
      </span><span class="p">(</span><span class="nf">v/pmap</span><span class="w"> </span><span class="n">get-user-from-api</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="p">])]</span><span class="w">
  </span><span class="p">(</span><span class="nf">mapv</span><span class="w"> </span><span class="nb">deref</span><span class="w"> </span><span class="n">futs</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<p>Or:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">futs</span><span class="w">
      </span><span class="p">(</span><span class="nf">v/pmap</span><span class="w"> </span><span class="n">get-some-entity</span><span class="w">                </span><span class="c1">;; assuming it accepts id and status</span><span class="w">
              </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="p">]</span><span class="w">                        </span><span class="c1">;; ids</span><span class="w">
              </span><span class="p">[</span><span class="s">"active"</span><span class="w"> </span><span class="s">"pending"</span><span class="w"> </span><span class="s">"deleted"</span><span class="p">]</span><span class="w"> </span><span class="c1">;; statuses</span><span class="w">
              </span><span class="p">)]</span><span class="w">
  </span><span class="p">(</span><span class="nf">mapv</span><span class="w"> </span><span class="nb">deref</span><span class="w"> </span><span class="n">futs</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">pmap!</code> version of this function dereferences all the results for you with
no exception handling:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">v/pmap!</span><span class="w"> </span><span class="n">get-user-from-api</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="p">])</span><span class="w">
</span><span class="c1">;; [{:id 1...}, {:id 2...}, {:id 3...}]</span><span class="w">
</span></code></pre></div></div>

<h3 id="each">each(!)</h3>

<p>The <code class="language-plaintext highlighter-rouge">each</code> macro is a wrapper on top of <code class="language-plaintext highlighter-rouge">pmap</code>. It binds each item from a
collection to a given symbol and submits a code block into a virtual
executor. The result is a vector of futures; exiting the macro closes the
executor.</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">futs</span><span class="w">
      </span><span class="p">(</span><span class="nf">v/each</span><span class="w"> </span><span class="p">[</span><span class="n">id</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="p">]]</span><span class="w">
        </span><span class="p">(</span><span class="nf">log/info...</span><span class="p">)</span><span class="w">
        </span><span class="p">(</span><span class="nf">try</span><span class="w">
          </span><span class="p">(</span><span class="nf">get-entity-by-id</span><span class="w"> </span><span class="n">id</span><span class="p">)</span><span class="w">
          </span><span class="p">(</span><span class="nf">catch</span><span class="w"> </span><span class="n">Throwable</span><span class="w"> </span><span class="n">e</span><span class="w">
            </span><span class="p">(</span><span class="nf">log/error</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="n">...</span><span class="p">))))]</span><span class="w">
  </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">[{</span><span class="n">...</span><span class="p">}</span><span class="n">,</span><span class="w"> </span><span class="p">{</span><span class="n">...</span><span class="p">}</span><span class="n">,</span><span class="w"> </span><span class="p">{</span><span class="n">...</span><span class="p">}]</span><span class="w"> </span><span class="p">(</span><span class="nf">mapv</span><span class="w"> </span><span class="nb">deref</span><span class="w"> </span><span class="n">futs</span><span class="p">))))</span><span class="w">
</span></code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">each!</code> macro acts the same but dereferences all the futures with no error handling.</p>

<h2 id="measurements">Measurements</h2>

<p>There is a development <code class="language-plaintext highlighter-rouge">dev/src/bench.clj</code> file with some trivial
measurements. Imagine you want to download 100 of URLs. You can do it
sequentially with <code class="language-plaintext highlighter-rouge">mapv</code>, semi-parallel with <code class="language-plaintext highlighter-rouge">pmap</code>, and fully parallel with
<code class="language-plaintext highlighter-rouge">pmap</code> from this library. Here are the timings made on my machine:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nb">time</span><span class="w">
 </span><span class="p">(</span><span class="nb">count</span><span class="w">
  </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="n">download</span><span class="w"> </span><span class="n">URLS</span><span class="p">)))</span><span class="w">
</span><span class="s">"Elapsed time: 45846.601717 msecs"</span><span class="w">

</span><span class="p">(</span><span class="nb">time</span><span class="w">
 </span><span class="p">(</span><span class="nb">count</span><span class="w">
  </span><span class="p">(</span><span class="nf">pmap</span><span class="w"> </span><span class="n">download</span><span class="w"> </span><span class="n">URLS</span><span class="p">)))</span><span class="w">
</span><span class="s">"Elapsed time: 3343.254302 msecs"</span><span class="w">

</span><span class="p">(</span><span class="nb">time</span><span class="w">
 </span><span class="p">(</span><span class="nb">count</span><span class="w">
  </span><span class="p">(</span><span class="nf">v/pmap!</span><span class="w"> </span><span class="n">download</span><span class="w"> </span><span class="n">URLS</span><span class="p">)))</span><span class="w">
</span><span class="s">"Elapsed time: 1452.514165 msecs"</span><span class="w">
</span></code></pre></div></div>

<p>45, 3.3, and 1.4 seconds favour the virtual threads approach.</p>

<h2 id="links-and-resources">Links and Resources</h2>

<p>The following links helped me a lot to dive into virtual threads, and I highly
recommend reading and watching them:</p>

<ul>
  <li><a href="https://docs.oracle.com/en/java/javase/21/core/virtual-threads.html">Virtual Threads, Oracle Help Center</a></li>
  <li><a href="https://www.youtube.com/watch?v=5E0LU85EnTI">Java 21 new feature: Virtual Threads #RoadTo21</a></li>
</ul>

  </div>

</article>

<center>
    <p>
        <small>Нашли ошибку? Выделите мышкой и нажмите Ctrl/&#8984;+Enter</small>
    </p>
</center>






<center>Комментариев пока нет</center>









<form id="comment-form" method="POST" action="https://functions.yandexcloud.net/d4ehfuf08fjfjr59ivnf">

    <div class="block">
        <p class="comment-form-label"><small>Your name</small></p>
        <input required id="comment-form-author" name="author" type="text">
    </div>

    <div class="block">
        <p class="comment-form-label"><small>Comment (markdown syntax)</small></p>
        <textarea required id="comment-form-comment" name="comment"></textarea>
    </div>

    <input required name="path" type="hidden" value="/en/virtuoso/">
    <input required name="captcha" type="hidden" value="8 &#215; 4">

    <div class="block">
        <span class="comment-form-label"><small>8 &#215; 4 = </small></span>
        <input required id="comment-form-solution" name="solution" type="text">
    </div>

    <div class="block">
        <button id="comment-form-send" type="submit">Send</button>
    </div>

</form>


      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Ivan Grishaev's blog</li>
          <li><a href="mailto:ivan@grishaev.me">ivan@grishaev.me</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
            <li><a href="https://github.com/igrishaev">GitHub</a></li>
            <li><a href="https://t.me/igrishaev_blog">Telegram</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Writing on programming, education, books and negotiations.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
