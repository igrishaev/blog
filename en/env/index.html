<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Environ variables are not for configuring software</title>
  <meta name="description" content="">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/custom.css">
  <link rel="canonical" href="https://grishaev.me/en/env/">
  <link rel="alternate" type="application/rss+xml" title="Ivan Grishaev's blog" href="https://grishaev.me/feed.xml">

  <link rel="shortcut icon" type="image/x-icon" href="/assets/static/favicons/favicon.ico">

  <script type="text/javascript" src="/assets/typo.js"></script>

</head>


  <body>
    <header class="site-header">

    <div class="wrapper flex-container">

        <div>
            <a href="/">
                <img src="/assets/static/photo-round-small.png" alt="Ivan Grishaev">
            </a>
        </div>

        <div class="flex-container-vert" style="margin-left: 15px; width: 80%">

            <div class="flex-container full-width">
                <p style="margin-bottom: 5px">Ivan Grishaev's blog</p>
                <div class="flex-huge"></div>
                <div >
<form id="search-form"
      target="_blank"
      style="display: inline"
      method="get"
      action="https://www.google.com/search">

    <input name="sitesearch"
           value="grishaev.me"
           type="hidden">

    <input type="text"
           required="required"
           name="q"
           placeholder="Google search..."
           autocomplete="off">

    <button style="border: none; background-color: transparent; cursor: pointer;"
            type="submit">&#x1f50d;</button>

</form>
</div>
            </div>

            <p><small>Writing on programming, education, books and negotiations.
</small></p>

            <div class="flex-container">
                <a class="menu-item" href="/">Home</a>
                <a class="menu-item" href="/about/">About</a>
                <a class="menu-item" href="/bookshelf/">Bookshelf</a>
                <a class="menu-item" href="/feed.xml">RSS</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor" href="/tag/clojure/">Clojure</a>
                <a class="menu-item minor" href="/tag/emacs/">Emacs</a>
                <a class="menu-item minor" href="/tag/python/">Python</a>
                <a class="menu-item minor" href="/tag/programming/">Programming</a>
                <a class="menu-item minor" href="/interview/">Interview</a>
                <a class="menu-item minor" href="/video/">Video</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor hl" href="/clojure-in-prod/">Книга «Clojure на производстве»</a>
            </div>

        </div>
    </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">

    <h1 class="post-title" itemprop="name headline">Environ variables are not for configuring software</h1>

    
<div class="post-meta">

    <time class="post-time"
          datetime="2018-05-30T00:00:00+00:00">
        May 30, 2018
    </time>

    <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/clojure/" rel="tag">clojure</a>, <a href="/tag/env/" rel="tag">env</a>

</div>


  </header>

  <div class="post-content" itemprop="articleBody">
    
<p>The recent project I’ve finished and deployed gave me a strong understanding why
using environment variables for configuring is a bad idea. Briefly, I’m going to
not use them anymore for setting up my software and maybe clean them out from my
previous projects. There is a pile of reasons for that.</p>

<p>Generally speaking, env vars aren’t bad in general. I’d just like to highlight
that they come from the ancient Unix time when people didn’t have suitable
development tools. But nowadays we have some. For example, thanks to JSON or
YAML, we do not need to parse integers or floats manually. The same about arrays
or maps. Some better formats like EDN even provide built-in date support or even
custom tags to parse special values. With these great tools, there is no need to
roll back for 20 years ago and parse text chunks once again. That’s the routine
we’ve successfully passed.</p>

<p>In short words, a config is usually a structured data. And we’ve got stuff to
read data from text without any problems. Why use env vars then?</p>

<p>You might be a bit wondered reading this since it conflicts with the third
section of <a href="https://12factor.net/config">12 Factor App</a> Development Manifest. This section clearly
says:</p>

<blockquote>
  <p>The twelve-factor app stores config in environment variables (often shortened
to env vars or env). Env vars are easy to change between deploys without
changing any code; unlike config files, there is little chance of them being
checked into the code repo accidentally; and unlike custom config files, or
other config mechanisms such as Java System Properties, they are a language-
and OS-agnostic standard.</p>
</blockquote>

<p>Well, I read this paragraph a number of times but still guessing is there any
sense out here. Easy to change? Well, you’ll need to edit some file or config
anyway. Little chance to commit them into a repository, really? If you have an
<code class="language-plaintext highlighter-rouge">ENV</code> file with 30 variables, there is no any difference between it and any
other file in your repository, say “config.json”, “settings.prop” or
“params.conf”. ENV file is just yet another file without any special
properties. You still need to control by your own whether it should be ignored
or tracked by your repo.</p>

<p>The whole #3 section says nothing about what benefits the env vars bring into a
project. From my prospective, since the 12 Factor App was initially written by
Ruby programmers, there is nothing else then just a cargo cult.</p>

<p>The idea of getting rid of a regular JSON, YAML, Java .props config file is
totally wrong. Of cause, if a program requires one or two arguments, there is no
a reason to distribute a separate config file. Especially when those parameters
have default values and might be overridden by command line arguments. But the
problem is, our modern web apps require up to 30 parameters at once and even
more.</p>

<p>Definitely, you’ll keep them in a text file, say “ENV” or “vars”. So what’s the
difference here to have a JSON file?</p>

<p>If you take <a href="https://github.com/tolitius/cprop">cprop</a>, a Clojure library that turns env vars into a map,
you’ll see that it provides a bunch of tricky rules for types coercion and
splitting nested values. For example, “true” and “false” strings will be
converted to a boolean value. A variable with a double underscore will be read
as a nested map:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">FOO__BAR</span><span class="o">=</span>42
</code></pre></div></div>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="no">:foo</span><span class="w"> </span><span class="p">{</span><span class="no">:bar</span><span class="w"> </span><span class="mi">42</span><span class="p">}}</span><span class="w">
</span></code></pre></div></div>

<p>That tricky logic may let you down sometimes. Imagine you’ve got a secret API
key for some service that it a string but consists only of numbers:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">API_KEY</span><span class="o">=</span>123123123
</code></pre></div></div>

<p>In Clojure, the result would be a number, not a string:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="no">:api-key</span><span class="w"> </span><span class="mi">123123123</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>There won’t be any error during parsing, but suddenly, in the middle of running
an app, you’ll get an exception that says something like “the Long type cannot
be cast to a Char Sequence”. It’s because the code tries to act on that API key
like it’s a string, but it’s an integer.</p>

<p>You should have marked that key with double quotes instead:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">API_KEY</span><span class="o">=</span><span class="s1">'"123123123"'</span>
</code></pre></div></div>

<p>Well, that’s a known issue and it’s even mentioned in the official readme, but
still. I can never remember the proper order: single-double or vice versa. I
don’t want to fight with those damned quotes again. It has been enough in shell
scripting: single quotes, double quotes, back-ticks. Now again in my Clojure? No
way.</p>

<p>In terms of <code class="language-plaintext highlighter-rouge">cprop</code>, there is nothing weird here because it doesn’t know
anything about the variable’s semantics. They are all just text and nothing else.</p>

<p>I’d like to stress that we’ve just invented our own system of rules and wrote
plenty of code just for one purpose: to turn env vars into a map. It’s plain to
see the code behaves a bit strange and forces us to keep that ugly scenario with
quotes in mind.</p>

<p>Even a dull JSON file that supports a limited number of hard-coded types seems
to be a salvation after been using env vars for a long time, really. A string
will always be a string and won’t turn into a number. There is no need to add a
double underscore in the middle of a name to simulate nested data.</p>

<p>But the main reason for getting rid of env vars is they tie us to all that
legacy that our systems still need to carry. Let’s say honestly, env vars are
just another part of Unix shell and related stuff. I do not have anything
against them when they are used in the right way. For system administration, for
example, but not for web development.</p>

<p>I mentioned before that a program should never rely on shell commands. Never
call <code class="language-plaintext highlighter-rouge">mkdir</code>, <code class="language-plaintext highlighter-rouge">curl</code> or any other commands. You may think it reduces the code,
but in fact, it’s a deal with the devil. Java code that creates a folder will
work on any OS or device as expected. But a shell command won’t.</p>

<p>The same I may say about env vars. They are part of a shell system and that’s
why are great for OS environment, but not a web application. They should never
affect an app running in production. The codebase should rely only on its own
resources. From the app’s prospective, a JSON/EDN config file is something that
an app may control. But the env vars are not.</p>

<p>I think that’s enough said on the subject. Provide your own config based on any
structured file format, no matter if it is a JSON, YAML or EDN file. But leave
the env vars alone. They are from Unix legacy and have nothing common with
modern development.</p>

  </div>

</article>

<center>
    <p>
        <small>Нашли ошибку? Выделите мышкой и нажмите Ctrl/&#8984;+Enter</small>
    </p>
</center>






<center>Комментарии</center>

<div id="comments">
  
    <div id="comment-3924672289" class="comment-block">
      <p class="comment-lead">
        <small>
          <em>
            Alex Yakushev,
            31st May 2018,
            <a href="#comment-3924672289">link</a>
            
          </em>
        </small>
      </p>
      <div><p>You might want to check Omniconf. The main value prop is that you have to define all the configuration your app takes upfront – and then, you can use EDN files, CLI parameters, or ENV vars as sources of the configuration. Thus, there's no magic when parsing the parameters, if you said in the code that :api-key is a string, it will be filled with a string regardless whether the value is coming from. On top of that, you get verification (make sure all necessary parameters are provided and have the correct type before the main code runs) and visibility (show the whole configuration map at the start of the program).</p>
<p>[1] <a href="https://github.com/grammarly/omniconf" rel="nofollow noopener" title="https://github.com/grammarly/omniconf">https://github.com/grammarl...</a></p>
</div>
    </div>
  
    <div id="comment-3924689816" class="comment-block">
      <p class="comment-lead">
        <small>
          <em>
            Ivan Grishaev,
            31st May 2018,
            <a href="#comment-3924689816">link</a>
            , <a href="#comment-3924672289">parent</a>
          </em>
        </small>
      </p>
      <div><p>Looks nice, but again, you've implemented lots of stuff whereas it could be picked up from existing libraries, clojure.spec for example. In your case, you declare a huge map of maps with your own validators and coercers. The same could be easily achieved if you had an EDN file with a map inside, then you pass it through spec/conform to coerce and validate values. The only problem here will be returning human-friendly error messages since spec is not good for that. But a short function is enough to turn a `problem` node from spec error output into a clear message.</p>
</div>
    </div>
  
    <div id="comment-3924693080" class="comment-block">
      <p class="comment-lead">
        <small>
          <em>
            Alex Yakushev,
            31st May 2018,
            <a href="#comment-3924693080">link</a>
            , <a href="#comment-3924689816">parent</a>
          </em>
        </small>
      </p>
      <div><p>Spec wasn't around when this library was created. Someday it might migrate to spec, but I want to preserve the compatibility with at least Clojure 1.8 for now.</p>
<p>Spec was not explicitly designed for coercion, the developers stated that a few times.</p>
<p>And you mention the problem of error messages yourself.</p>
</div>
    </div>
  
    <div id="comment-3924707134" class="comment-block">
      <p class="comment-lead">
        <small>
          <em>
            Ivan Grishaev,
            31st May 2018,
            <a href="#comment-3924707134">link</a>
            , <a href="#comment-3924693080">parent</a>
          </em>
        </small>
      </p>
      <div><p>Hm, as for me, spec is great for coercion, there is a `conform` function that takes a value and returns either a new value or an `:invalid` keyword. Also, most of coercions might be done on EDN level using custom tags, say #foo "some string value".</p>
</div>
    </div>
  
</div>









<form id="comment-form" method="POST" action="https://functions.yandexcloud.net/d4ehfuf08fjfjr59ivnf">

    <div class="block">
        <p class="comment-form-label"><small>Your name</small></p>
        <input required id="comment-form-author" name="author" type="text">
    </div>

    <div class="block">
        <p class="comment-form-label"><small>Comment (markdown syntax)</small></p>
        <textarea required id="comment-form-comment" name="comment"></textarea>
    </div>

    <input required name="path" type="hidden" value="/en/env/">
    <input required name="captcha" type="hidden" value="7 &#215; 4">

    <div class="block">
        <span class="comment-form-label"><small>7 &#215; 4 = </small></span>
        <input required id="comment-form-solution" name="solution" type="text">
    </div>

    <div class="block">
        <button id="comment-form-send" type="submit">Send</button>
    </div>

</form>


      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Ivan Grishaev's blog</li>
          <li><a href="mailto:ivan@grishaev.me">ivan@grishaev.me</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
            <li><a href="https://github.com/igrishaev">GitHub</a></li>
            <li><a href="tg://resolve?domain=igrishaev_blog">Telegram</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Writing on programming, education, books and negotiations.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
