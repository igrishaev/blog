<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>PG2 release 0.1.9: arrays</title>
  <meta name="description" content="">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/custom.css">
  <link rel="canonical" href="https://grishaev.me/en/pg-arrays">
  <link rel="alternate" type="application/rss+xml" title="Ivan Grishaev's blog" href="https://grishaev.me/feed.xml">

  <link rel="shortcut icon" type="image/x-icon" href="/assets/static/favicons/favicon.ico">

  <script type="text/javascript" src="/assets/typo.js"></script>

</head>


  <body>
    <header class="site-header">

    <div class="wrapper flex-container">

        <div>
            <a href="/">
                <img id="avatar" src="/assets/static/avatar.jpg" alt="Ivan Grishaev">
            </a>
        </div>

        <div class="flex-container-vert" style="margin-left: 15px; width: 80%">

            <div class="flex-container full-width">
                <p style="margin-bottom: 5px">Ivan Grishaev's blog</p>
                <div class="flex-huge"></div>
                <div >
<form id="search-form"
      target="_blank"
      style="display: inline"
      method="get"
      action="https://www.google.com/search">

    <input name="sitesearch"
           value="grishaev.me"
           type="hidden">

    <input type="text"
           required="required"
           name="q"
           placeholder="Google search..."
           autocomplete="off">

    <button style="border: none; background-color: transparent; cursor: pointer;"
            type="submit">&#x1f50d;</button>

</form>
</div>
            </div>

            <p><small>Writing on programming, education, books and negotiations.
</small></p>

            <div class="flex-container">
                <a class="menu-item" href="/">Home</a>
                <a class="menu-item" href="/about/">About</a>
                <a class="menu-item" href="/bookshelf/">Bookshelf</a>
                <a class="menu-item" href="/feed.xml">RSS</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor" href="/tag/clojure/">Clojure</a>
                <a class="menu-item minor" href="/tag/emacs/">Emacs</a>
                <a class="menu-item minor" href="/tag/python/">Python</a>
                <a class="menu-item minor" href="/tag/programming/">Programming</a>
                <a class="menu-item minor" href="/interview/">Interview</a>
                <a class="menu-item minor" href="/video/">Video</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor hl" href="/clojure-in-prod/">Книга «Clojure на производстве»</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor hl" href="/clojure-in-prod-2/">Книга «Clojure на производстве», второй том</a>
            </div>

        </div>
    </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">

    <h1 class="post-title" itemprop="name headline">PG2 release 0.1.9: arrays</h1>

    
<div class="post-meta">

    <time class="post-time"
          datetime="2024-04-04T00:00:00+00:00">
        Apr 4, 2024
    </time>

    <a href="/tag/clojure/" rel="tag">clojure</a>, <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/postgres/" rel="tag">postgres</a>, <a href="/tag/array/" rel="tag">array</a>

</div>


  </header>

  <div class="post-content" itemprop="articleBody">
    
<p>The latest <a href="https://github.com/igrishaev/pg2">0.1.9 release</a> of PG2 supports Postgres arrays.</p>

<p>In JDBC, arrays have always been a pain. Every time you’re about to pass an
array to the database and read it back, you’ve got to wrap your data in various
Java classes, extend protocols, and multimethods. In Postgres, the array type is
quite powerful yet underestimated due to poor support of drivers. This is one
more reason for running this project: to bring easy access to Postgres arrays.</p>

<p>PG2 tries its best to provide seamless connection between Clojure vectors and
Postgres arrays. When reading an array, you get a Clojure vector. And vice
versa: to pass an array object into a query, just submit a vector.</p>

<p>PG2 supports arrays of any type: not only primitives like numbers and strings
but <code class="language-plaintext highlighter-rouge">uuid</code>, <code class="language-plaintext highlighter-rouge">numeric</code>, <code class="language-plaintext highlighter-rouge">timestamp(tz)</code>, <code class="language-plaintext highlighter-rouge">json(b)</code>, and more as well.</p>

<p>Arrays might have more than one dimension. Nothing prevents you from having a 3D
array of integers like <code class="language-plaintext highlighter-rouge">cube::int[][][]</code>, and it becomes a nested vector when
fetched by PG2.</p>

<p><em>A technical note: PG2 supports both encoding and decoding of arrays in both
text and binary modes.</em></p>

<p>Here is a short demo session. Let’s prepare a table with an array of strings:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pg/query</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="s">"create table arr_demo_1 (id serial, text_arr text[])"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>Insert a simple item:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w">
            </span><span class="s">"insert into arr_demo_1 (text_arr) values ($1)"</span><span class="w">
            </span><span class="p">{</span><span class="no">:params</span><span class="w"> </span><span class="p">[[</span><span class="s">"one"</span><span class="w"> </span><span class="s">"two"</span><span class="w"> </span><span class="s">"three"</span><span class="p">]]})</span><span class="w">
</span></code></pre></div></div>

<p>In arrays, some elements might be NULL:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w">
            </span><span class="s">"insert into arr_demo_1 (text_arr) values ($1)"</span><span class="w">
            </span><span class="p">{</span><span class="no">:params</span><span class="w"> </span><span class="p">[[</span><span class="s">"foo"</span><span class="w"> </span><span class="n">nil</span><span class="w"> </span><span class="s">"bar"</span><span class="p">]]})</span><span class="w">
</span></code></pre></div></div>

<p>Now let’s check what we’ve got so far:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pg/query</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="s">"select * from arr_demo_1"</span><span class="p">)</span><span class="w">

</span><span class="p">[{</span><span class="no">:id</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="no">:text_arr</span><span class="w"> </span><span class="p">[</span><span class="s">"one"</span><span class="w"> </span><span class="s">"two"</span><span class="w"> </span><span class="s">"three"</span><span class="p">]}</span><span class="w">
 </span><span class="p">{</span><span class="no">:id</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="no">:text_arr</span><span class="w"> </span><span class="p">[</span><span class="s">"foo"</span><span class="w"> </span><span class="n">nil</span><span class="w"> </span><span class="s">"bar"</span><span class="p">]}]</span><span class="w">
</span></code></pre></div></div>

<p>Postgres supports plenty of operators for arrays. Say, the <code class="language-plaintext highlighter-rouge">&amp;&amp;</code> one checks if
there is at least one common element on both sides. Here is how we find those
records that have either “tree”, “four”, or “five”:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w">
            </span><span class="s">"select * from arr_demo_1 where text_arr &amp;&amp; $1"</span><span class="w">
            </span><span class="p">{</span><span class="no">:params</span><span class="w"> </span><span class="p">[[</span><span class="s">"three"</span><span class="w"> </span><span class="s">"four"</span><span class="w"> </span><span class="s">"five"</span><span class="p">]]})</span><span class="w">

</span><span class="p">[{</span><span class="no">:text_arr</span><span class="w"> </span><span class="p">[</span><span class="s">"one"</span><span class="w"> </span><span class="s">"two"</span><span class="w"> </span><span class="s">"three"</span><span class="p">]</span><span class="n">,</span><span class="w"> </span><span class="no">:id</span><span class="w"> </span><span class="mi">1</span><span class="p">}]</span><span class="w">
</span></code></pre></div></div>

<p>Another useful operator is <code class="language-plaintext highlighter-rouge">@&gt;</code> that checks if the left array contains all
elements from the right array:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w">
            </span><span class="s">"select * from arr_demo_1 where text_arr @&gt; $1"</span><span class="w">
            </span><span class="p">{</span><span class="no">:params</span><span class="w"> </span><span class="p">[[</span><span class="s">"foo"</span><span class="w"> </span><span class="s">"bar"</span><span class="p">]]})</span><span class="w">

</span><span class="p">[{</span><span class="no">:text_arr</span><span class="w"> </span><span class="p">[</span><span class="s">"foo"</span><span class="w"> </span><span class="n">nil</span><span class="w"> </span><span class="s">"bar"</span><span class="p">]</span><span class="n">,</span><span class="w"> </span><span class="no">:id</span><span class="w"> </span><span class="mi">2</span><span class="p">}]</span><span class="w">
</span></code></pre></div></div>

<p>Let’s proceed with numeric two-dimensional arrays. They’re widely used in math,
statistics, graphics, and similar areas:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pg/query</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="s">"create table arr_demo_2 (id serial, matrix bigint[][])"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>Here is how you insert a matrix:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w">
            </span><span class="s">"insert into arr_demo_2 (matrix) values ($1)"</span><span class="w">
            </span><span class="p">{</span><span class="no">:params</span><span class="w"> </span><span class="p">[[[[</span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="mi">3</span><span class="w"> </span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="mi">5</span><span class="w"> </span><span class="mi">6</span><span class="p">]]</span><span class="w">
                       </span><span class="p">[[</span><span class="mi">6</span><span class="w"> </span><span class="mi">5</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="mi">4</span><span class="w"> </span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="mi">2</span><span class="w"> </span><span class="mi">1</span><span class="p">]]]]})</span><span class="w">

</span><span class="p">{</span><span class="no">:inserted</span><span class="w"> </span><span class="mi">1</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Pay attention: each number can be NULL but you cannot have NULL for an entire
sub-array. This will trigger an error response from Postgres.</p>

<p>Reading the matrix back:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pg/query</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="s">"select * from arr_demo_2"</span><span class="p">)</span><span class="w">

</span><span class="p">[{</span><span class="no">:id</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="no">:matrix</span><span class="w"> </span><span class="p">[[[</span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="mi">3</span><span class="w"> </span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="mi">5</span><span class="w"> </span><span class="mi">6</span><span class="p">]]</span><span class="w">
                 </span><span class="p">[[</span><span class="mi">6</span><span class="w"> </span><span class="mi">5</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="mi">4</span><span class="w"> </span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="mi">2</span><span class="w"> </span><span class="mi">1</span><span class="p">]]]}]</span><span class="w">
</span></code></pre></div></div>

<p>A crazy example: let’s have a three dimension array of timestamps with a time
zone. No idea how it can be used but still:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pg/query</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="s">"create table arr_demo_3 (id serial, matrix timestamp[][][])"</span><span class="p">)</span><span class="w">

</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">-matrix</span><span class="w">
  </span><span class="p">[[[[(</span><span class="nf">OffsetDateTime/now</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">OffsetDateTime/now</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">OffsetDateTime/now</span><span class="p">)]</span><span class="w">
     </span><span class="p">[(</span><span class="nf">OffsetDateTime/now</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">OffsetDateTime/now</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">OffsetDateTime/now</span><span class="p">)]</span><span class="w">
     </span><span class="p">[(</span><span class="nf">OffsetDateTime/now</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">OffsetDateTime/now</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">OffsetDateTime/now</span><span class="p">)]]</span><span class="w">
    </span><span class="p">[[(</span><span class="nf">OffsetDateTime/now</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">OffsetDateTime/now</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">OffsetDateTime/now</span><span class="p">)]</span><span class="w">
     </span><span class="p">[(</span><span class="nf">OffsetDateTime/now</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">OffsetDateTime/now</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">OffsetDateTime/now</span><span class="p">)]</span><span class="w">
     </span><span class="p">[(</span><span class="nf">OffsetDateTime/now</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">OffsetDateTime/now</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">OffsetDateTime/now</span><span class="p">)]]</span><span class="w">
    </span><span class="p">[[(</span><span class="nf">OffsetDateTime/now</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">OffsetDateTime/now</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">OffsetDateTime/now</span><span class="p">)]</span><span class="w">
     </span><span class="p">[(</span><span class="nf">OffsetDateTime/now</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">OffsetDateTime/now</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">OffsetDateTime/now</span><span class="p">)]</span><span class="w">
     </span><span class="p">[(</span><span class="nf">OffsetDateTime/now</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">OffsetDateTime/now</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">OffsetDateTime/now</span><span class="p">)]]]</span><span class="w">
   </span><span class="p">[[[(</span><span class="nf">OffsetDateTime/now</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">OffsetDateTime/now</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">OffsetDateTime/now</span><span class="p">)]</span><span class="w">
     </span><span class="p">[(</span><span class="nf">OffsetDateTime/now</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">OffsetDateTime/now</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">OffsetDateTime/now</span><span class="p">)]</span><span class="w">
     </span><span class="p">[(</span><span class="nf">OffsetDateTime/now</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">OffsetDateTime/now</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">OffsetDateTime/now</span><span class="p">)]]</span><span class="w">
    </span><span class="p">[[(</span><span class="nf">OffsetDateTime/now</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">OffsetDateTime/now</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">OffsetDateTime/now</span><span class="p">)]</span><span class="w">
     </span><span class="p">[(</span><span class="nf">OffsetDateTime/now</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">OffsetDateTime/now</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">OffsetDateTime/now</span><span class="p">)]</span><span class="w">
     </span><span class="p">[(</span><span class="nf">OffsetDateTime/now</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">OffsetDateTime/now</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">OffsetDateTime/now</span><span class="p">)]]</span><span class="w">
    </span><span class="p">[[(</span><span class="nf">OffsetDateTime/now</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">OffsetDateTime/now</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">OffsetDateTime/now</span><span class="p">)]</span><span class="w">
     </span><span class="p">[(</span><span class="nf">OffsetDateTime/now</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">OffsetDateTime/now</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">OffsetDateTime/now</span><span class="p">)]</span><span class="w">
     </span><span class="p">[(</span><span class="nf">OffsetDateTime/now</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">OffsetDateTime/now</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">OffsetDateTime/now</span><span class="p">)]]]</span><span class="w">
   </span><span class="p">[[[(</span><span class="nf">OffsetDateTime/now</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">OffsetDateTime/now</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">OffsetDateTime/now</span><span class="p">)]</span><span class="w">
     </span><span class="p">[(</span><span class="nf">OffsetDateTime/now</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">OffsetDateTime/now</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">OffsetDateTime/now</span><span class="p">)]</span><span class="w">
     </span><span class="p">[(</span><span class="nf">OffsetDateTime/now</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">OffsetDateTime/now</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">OffsetDateTime/now</span><span class="p">)]]</span><span class="w">
    </span><span class="p">[[(</span><span class="nf">OffsetDateTime/now</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">OffsetDateTime/now</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">OffsetDateTime/now</span><span class="p">)]</span><span class="w">
     </span><span class="p">[(</span><span class="nf">OffsetDateTime/now</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">OffsetDateTime/now</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">OffsetDateTime/now</span><span class="p">)]</span><span class="w">
     </span><span class="p">[(</span><span class="nf">OffsetDateTime/now</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">OffsetDateTime/now</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">OffsetDateTime/now</span><span class="p">)]]</span><span class="w">
    </span><span class="p">[[(</span><span class="nf">OffsetDateTime/now</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">OffsetDateTime/now</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">OffsetDateTime/now</span><span class="p">)]</span><span class="w">
     </span><span class="p">[(</span><span class="nf">OffsetDateTime/now</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">OffsetDateTime/now</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">OffsetDateTime/now</span><span class="p">)]</span><span class="w">
     </span><span class="p">[(</span><span class="nf">OffsetDateTime/now</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">OffsetDateTime/now</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">OffsetDateTime/now</span><span class="p">)]]]])</span><span class="w">

</span><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w">
            </span><span class="s">"insert into arr_demo_3 (matrix) values ($1)"</span><span class="w">
            </span><span class="p">{</span><span class="no">:params</span><span class="w"> </span><span class="p">[</span><span class="n">-matrix</span><span class="p">]})</span><span class="w">
</span></code></pre></div></div>

<p>Now read it back:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pg/query</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="s">"select * from arr_demo_3"</span><span class="p">)</span><span class="w">

</span><span class="p">[{</span><span class="no">:matrix</span><span class="w">
  </span><span class="p">[</span><span class="n">...</span><span class="w"> </span><span class="n">truncated</span><span class="w">
   </span><span class="p">[[[</span><span class="o">#</span><span class="n">object</span><span class="p">[</span><span class="n">java.time.LocalDateTime</span><span class="w"> </span><span class="mi">0</span><span class="n">x5ed6e62b</span><span class="w"> </span><span class="s">"2024-04-01T18:32:48.272169"</span><span class="p">]</span><span class="w">
      </span><span class="o">#</span><span class="n">object</span><span class="p">[</span><span class="n">java.time.LocalDateTime</span><span class="w"> </span><span class="mi">0</span><span class="n">xb9d6851</span><span class="w"> </span><span class="s">"2024-04-01T18:32:48.272197"</span><span class="p">]</span><span class="w">
      </span><span class="o">#</span><span class="n">object</span><span class="p">[</span><span class="n">java.time.LocalDateTime</span><span class="w"> </span><span class="mi">0</span><span class="n">x6e35ed84</span><span class="w"> </span><span class="s">"2024-04-01T18:32:48.272207"</span><span class="p">]]</span><span class="w">
     </span><span class="n">...</span><span class="w">
     </span><span class="p">[</span><span class="o">#</span><span class="n">object</span><span class="p">[</span><span class="n">java.time.LocalDateTime</span><span class="w"> </span><span class="mi">0</span><span class="n">x7319d217</span><span class="w"> </span><span class="s">"2024-04-01T18:32:48.272236"</span><span class="p">]</span><span class="w">
      </span><span class="o">#</span><span class="n">object</span><span class="p">[</span><span class="n">java.time.LocalDateTime</span><span class="w"> </span><span class="mi">0</span><span class="n">x6153154d</span><span class="w"> </span><span class="s">"2024-04-01T18:32:48.272241"</span><span class="p">]</span><span class="w">
      </span><span class="o">#</span><span class="n">object</span><span class="p">[</span><span class="n">java.time.LocalDateTime</span><span class="w"> </span><span class="mi">0</span><span class="n">x2e4ffd44</span><span class="w"> </span><span class="s">"2024-04-01T18:32:48.272247"</span><span class="p">]]]</span><span class="w">
    </span><span class="n">...</span><span class="w">
    </span><span class="p">[[</span><span class="o">#</span><span class="n">object</span><span class="p">[</span><span class="n">java.time.LocalDateTime</span><span class="w"> </span><span class="mi">0</span><span class="n">x32c6e526</span><span class="w"> </span><span class="s">"2024-04-01T18:32:48.272405"</span><span class="p">]</span><span class="w">
      </span><span class="o">#</span><span class="n">object</span><span class="p">[</span><span class="n">java.time.LocalDateTime</span><span class="w"> </span><span class="mi">0</span><span class="n">x496a5bc6</span><span class="w"> </span><span class="s">"2024-04-01T18:32:48.272418"</span><span class="p">]</span><span class="w">
      </span><span class="o">#</span><span class="n">object</span><span class="p">[</span><span class="n">java.time.LocalDateTime</span><span class="w"> </span><span class="mi">0</span><span class="n">x283531ee</span><span class="w"> </span><span class="s">"2024-04-01T18:32:48.272426"</span><span class="p">]]</span><span class="w">
     </span><span class="n">...</span><span class="w">
     </span><span class="p">[</span><span class="o">#</span><span class="n">object</span><span class="p">[</span><span class="n">java.time.LocalDateTime</span><span class="w"> </span><span class="mi">0</span><span class="n">x677b3def</span><span class="w"> </span><span class="s">"2024-04-01T18:32:48.272459"</span><span class="p">]</span><span class="w">
      </span><span class="o">#</span><span class="n">object</span><span class="p">[</span><span class="n">java.time.LocalDateTime</span><span class="w"> </span><span class="mi">0</span><span class="n">x46d5039f</span><span class="w"> </span><span class="s">"2024-04-01T18:32:48.272467"</span><span class="p">]</span><span class="w">
      </span><span class="o">#</span><span class="n">object</span><span class="p">[</span><span class="n">java.time.LocalDateTime</span><span class="w"> </span><span class="mi">0</span><span class="n">x3d0b906</span><span class="w"> </span><span class="s">"2024-04-01T18:32:48.272475"</span><span class="p">]]]]]</span><span class="n">,</span><span class="w">
  </span><span class="no">:id</span><span class="w"> </span><span class="mi">1</span><span class="p">}]</span><span class="w">
</span></code></pre></div></div>

<p>You can have an array of JSON(b) objects, too:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pg/query</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="s">"create table arr_demo_4 (id serial, json_arr jsonb[])"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>Inserting an array of three maps:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w">  </span><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w">
              </span><span class="s">"insert into arr_demo_4 (json_arr) values ($1)"</span><span class="w">
              </span><span class="p">{</span><span class="no">:params</span><span class="w"> </span><span class="p">[[{</span><span class="no">:foo</span><span class="w"> </span><span class="mi">1</span><span class="p">}</span><span class="w"> </span><span class="p">{</span><span class="no">:bar</span><span class="w"> </span><span class="mi">2</span><span class="p">}</span><span class="w"> </span><span class="p">{</span><span class="no">:test</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="p">]}]]})</span><span class="w">
</span></code></pre></div></div>

<p>Elements might be everything that can be JSON-encoded: numbers, strings,
boolean, etc. The only tricky case is a vector. To not break the algorithm that
traverses the matrix, wrap a vector element with <code class="language-plaintext highlighter-rouge">pg/json-wrap</code>:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w">
            </span><span class="s">"insert into arr_demo_4 (json_arr) values ($1)"</span><span class="w">
            </span><span class="p">{</span><span class="no">:params</span><span class="w"> </span><span class="p">[[</span><span class="mi">42</span><span class="w"> </span><span class="n">nil</span><span class="w"> </span><span class="p">{</span><span class="no">:some</span><span class="w"> </span><span class="s">"object"</span><span class="p">}</span><span class="w"> </span><span class="p">(</span><span class="nf">pg/json-wrap</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="p">])]]})</span><span class="w">

</span><span class="c1">;; Signals that the [1 2 3] is not a nested array but an element.</span><span class="w">
</span></code></pre></div></div>

<p>Now read it back:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pg/query</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="s">"select * from arr_demo_4"</span><span class="p">)</span><span class="w">

</span><span class="p">[{</span><span class="no">:id</span><span class="w"> </span><span class="mi">1</span><span class="n">,</span><span class="w"> </span><span class="no">:json_arr</span><span class="w"> </span><span class="p">[</span><span class="mi">42</span><span class="w"> </span><span class="n">nil</span><span class="w"> </span><span class="p">{</span><span class="no">:some</span><span class="w"> </span><span class="s">"object"</span><span class="p">}</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="p">]]}]</span><span class="w">
</span></code></pre></div></div>

    
<div class="prev-next">

    <div class="prev-next-left">
    
        <p><small><a href="/ms-teams/">&larr; Microsoft Teams</a></small></p>
    
    </div>

    <div class="prev-next-mid">
    </div>

    <div class="prev-next-right">
    
        <p><small><a href="/github-ide/">Github IDE &rarr;</a></small></p>
    
    </div>

</div>

  </div>

</article>

<center>
    <p>
        <small>Нашли ошибку? Выделите мышкой и нажмите Ctrl/&#8984;+Enter</small>
    </p>
</center>






<center>Комментариев пока нет</center>









<form id="comment-form" method="POST" action="https://functions.yandexcloud.net/d4ehfuf08fjfjr59ivnf">

    <div class="block">
        <p class="comment-form-label"><small>Your name</small></p>
        <input required id="comment-form-author" name="author" type="text">
    </div>

    <div class="block">
        <p class="comment-form-label"><small>Comment (markdown syntax)</small></p>
        <textarea required id="comment-form-comment" name="comment"></textarea>
    </div>

    <input required name="path" type="hidden" value="/en/pg-arrays">
    <input required name="captcha" type="hidden" value="4 &#215; 7">

    <div class="block">
        <span class="comment-form-label"><small>4 &#215; 7 = </small></span>
        <input required id="comment-form-solution" name="solution" type="text">
    </div>

    <div class="block">
        <button id="comment-form-send" type="submit">Send</button>
    </div>

</form>


      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Ivan Grishaev's blog</li>
          <li><a href="mailto:ivan@grishaev.me">ivan@grishaev.me</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
            <li><a href="https://github.com/igrishaev">GitHub</a></li>
            <li><a href="https://t.me/igrishaev_blog">Telegram</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Writing on programming, education, books and negotiations.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
