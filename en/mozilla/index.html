<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Mozilla makes me crazy</title>
  <meta name="description" content="">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/custom.css">
  <link rel="canonical" href="https://grishaev.me/en/mozilla/">
  <link rel="alternate" type="application/rss+xml" title="Ivan Grishaev's blog" href="https://grishaev.me/feed.xml">

  <link rel="shortcut icon" type="image/x-icon" href="/assets/static/favicons/favicon.ico">

  <script type="text/javascript" src="/assets/typo.js"></script>

</head>


  <body>
    <header class="site-header">

    <div class="wrapper flex-container">

        <div>
            <a href="/">
                <img id="avatar" src="/assets/static/avatar.jpg" alt="Ivan Grishaev">
            </a>
        </div>

        <div class="flex-container-vert" style="margin-left: 15px; width: 80%">

            <div class="flex-container full-width">
                <p style="margin-bottom: 5px">Ivan Grishaev's blog</p>
                <div class="flex-huge"></div>
                <div >
<form id="search-form"
      target="_blank"
      style="display: inline"
      method="get"
      action="https://www.google.com/search">

    <input name="sitesearch"
           value="grishaev.me"
           type="hidden">

    <input type="text"
           required="required"
           name="q"
           placeholder="Google search..."
           autocomplete="off">

    <button style="border: none; background-color: transparent; cursor: pointer;"
            type="submit">&#x1f50d;</button>

</form>
</div>
            </div>

            <p><small>Writing on programming, education, books and negotiations.
</small></p>

            <div class="flex-container">
                <a class="menu-item" href="/">Home</a>
                <a class="menu-item" href="/about/">About</a>
                <a class="menu-item" href="/bookshelf/">Bookshelf</a>
                <a class="menu-item" href="/feed.xml">RSS</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor" href="/tag/clojure/">Clojure</a>
                <a class="menu-item minor" href="/tag/emacs/">Emacs</a>
                <a class="menu-item minor" href="/tag/python/">Python</a>
                <a class="menu-item minor" href="/tag/programming/">Programming</a>
                <a class="menu-item minor" href="/interview/">Interview</a>
                <a class="menu-item minor" href="/video/">Video</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor hl" href="/clojure-in-prod/">Книга «Clojure на производстве»</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor hl" href="/clojure-in-prod-2/">Книга «Clojure на производстве», второй том</a>
            </div>

        </div>
    </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">

    <h1 class="post-title" itemprop="name headline">Mozilla makes me crazy</h1>

    
<div class="post-meta">

    <time class="post-time"
          datetime="2017-11-10T00:00:00+00:00">
        Nov 10, 2017
    </time>

    <a href="/tag/clojure/" rel="tag">clojure</a>, <a href="/tag/mozilla/" rel="tag">mozilla</a>, <a href="/tag/rust/" rel="tag">rust</a>

</div>


  </header>

  <div class="post-content" itemprop="articleBody">
    
<p>What I’d like to share with you is my suffering from dealing with browsers. I’m
an author of a <a href="https://github.com/igrishaev/etaoin">Clojure library</a> that automates browsers. Briefly, the
library doesn’t depend on Selenium since it implements
the <a href="https://www.w3.org/TR/webdriver">Webdriver protocol</a> with pure Clojure. It brings flexibility and
freedom in the way you’d like to build your API.</p>

<p>At the same time, everybody who is willing to tame several browsers at once is
doomed to open the Pandora box. There is the <a href="https://www.w3.org/TR/webdriver">official standard</a> I
thought, so definitely everybody will follow it. A naive laddie I was.</p>

<p>I don’t know if there is some kind of curse or black magic, but sometimes
developers cannot just implement the standard as it dictates the things should
be done. For example, it says the server should accept a <code class="language-plaintext highlighter-rouge">value</code>
field. Developers write code that takes <code class="language-plaintext highlighter-rouge">text</code> instead. When I see it, I have
strange feeling of being completely stunned without any understanding of what’s
going on here.</p>

<p>But what exactly I wanted to discuss is how does Mozilla develop their software.</p>

<p>Briefly, they break everything apart moving further. And I don’t know how to
deal with it. Maybe they enjoy coding in Rust so much that their mission to ship
good software has faded away.</p>

<p>I know I’m not a Mozilla engineer and would never be capable of joining them,
but still. As a user of their products, namely Geckodriver and Webdriver
utilities, I consider myself being right when criticizing them.</p>

<p>With each <a href="https://github.com/mozilla/geckodriver/releases">next release</a> of Geckodriver, it behaves worth and
worth. When I first started developing the library (a bit less then 1 year ago),
it was 0.13 version available and it worked fine. I wrote a bunch of unit tests
that all passed. Nowadays, the latest version is 0.19 and it just doesn’t work.</p>

<p>Yes, you heard correct, it does not even respond to any API call:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>~/Downloads&gt; ./geckodriver-0.19.0
1510326430666 geckodriver INFO geckodriver 0.19.0
1510326430680 geckodriver INFO Listening on 127.0.0.1:4444

curl <span class="nt">-X</span> POST <span class="nt">-d</span> <span class="s1">'{"desiredCapabilities": {}}'</span> <span class="s2">"http://127.0.0.1:4444/session"</span>
</code></pre></div></div>

<p>Calling <code class="language-plaintext highlighter-rouge">curl</code> utility throws a long stack trace saying something about sandbox
restrictions without any word on how to fix that or at least where to look for
help.</p>

<p>Here is a <a href="https://github.com/mozilla/geckodriver/issues/706">related issue</a> that confirms I’m not the first one who faced
it. It’s closed! “As I said, this isn’t a problem with geckodriver”, one of
developers says. OK, but I’m still curious about why does the version <code class="language-plaintext highlighter-rouge">0.13</code>
work fine whereas switching on <code class="language-plaintext highlighter-rouge">0.19</code> leads to failure? Proof:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>~/Downloads&gt; ./geckodriver-0.13.0 <span class="nt">--version</span>
geckodriver 0.13.0

~/Downloads&gt; ./geckodriver-0.13.0
1510327215587 geckodriver INFO Listening on 127.0.0.1:4444

curl <span class="nt">-X</span> POST <span class="nt">-d</span> <span class="s1">'{"desiredCapabilities": {}}'</span> <span class="s2">"http://127.0.0.1:4444/session"</span>
<span class="o">&gt;&gt;&gt;</span> <span class="o">{</span><span class="s2">"sessionId"</span>:<span class="s2">"e744bbdd-1b3f-9249-827f-02204bbc81c8"</span>,<span class="s2">"value"</span>:<span class="o">{</span><span class="s2">"acceptInsecureCerts"</span>:...
</code></pre></div></div>

<p>Ok, let’s decrease the version a bit. I downloaded them moving backwards in
time. Again, <code class="language-plaintext highlighter-rouge">0.18</code> still does not work. We need to go deeper. The previous one
numbered with <code class="language-plaintext highlighter-rouge">0.17</code> starts well, but suddenly, I cannot fetch a new session
with my library, it just returns <code class="language-plaintext highlighter-rouge">nil</code> value. That’s strange.</p>

<p>Going down to <code class="language-plaintext highlighter-rouge">0.15</code>. Don’t know why, but I cannot fill any input field, the API
fails with a strange error saying I didn’t pass the “text” field. Hm, I clearly
remember that the API accepts “value” field. That’s what
the <a href="https://www.w3.org/TR/webdriver/#dfn-element-send-keys">W3C standard says</a>. Geckodriver 0.13 follows it, but not the
0.15 release! After fetching the official <a href="https://hg.mozilla.org/mozilla-central/">Mozilla repo</a> and
searching in its history for a while, I found this (truncated):</p>

<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gh">diff -r 225d1faf513b -r b429bf0078c4 testing/webdriver/src/command.rs
</span><span class="gd">--- a/testing/webdriver/src/command.rs	Tue Mar 07 18:50:56 2017 +0000
</span><span class="gi">+++ b/testing/webdriver/src/command.rs	Wed Mar 15 13:54:19 2017 +0000
</span><span class="p">@@ -752,7 +752,7 @@</span>

 #[derive(PartialEq)]
 pub struct SendKeysParameters {
<span class="gd">-    pub value: Vec&lt;char&gt;
</span><span class="gi">+    pub text: String
</span> }

 impl Parameters for SendKeysParameters {
<span class="p">@@ -760,26 +760,14 @@</span>
         let data = try_opt!(body.as_object(),
                             ErrorStatus::InvalidArgument,
<span class="err">...</span>
-            Ok(chars[0])
<span class="gd">-        }).collect::&lt;Result&lt;Vec&lt;_&gt;, _&gt;&gt;());
</span><span class="gi">+        let text = try_opt!(try_opt!(data.get("text"),
</span><span class="err">...</span>
+            text: text.into()
         })
     }
 }
<span class="p">@@ -787,10 +775,7 @@</span>
 impl ToJson for SendKeysParameters {
     fn to_json(&amp;self) -&gt; Json {
         let mut data = BTreeMap::new();
<span class="gd">-        let value_string: Vec&lt;String&gt; = self.value.iter().map(|x| {
-            x.to_string()
-        }).collect();
-        data.insert("value".to_string(), value_string.to_json());
</span><span class="gi">+        data.insert("value".to_string(), self.text.to_json());
</span>         Json::Object(data)
     }
 }

</code></pre></div></div>

<p>Hold on, what was the purpose to change that field? Everything was working,
right? Who asked for that? Did the standard change? No, it’s still the same! Why
have you guys just changed the API? You could easily rewrite the code without
renaming “value” field into “text”.</p>

<p>Listen, I’ve already got three different versions of those API for Chrome,
Firefox and Safari. In addition to that, your force me to switch on version
inside Firefox branch turning my code into if/else hell.</p>

<p>From your perspectives, what’s the difference in processing either “value” or
“text” field? But for me, you’ve broken my software! It doesn’t work anymore.</p>

<p>I could not find a diff that would proof the fact of moving “sessionId” field
because the repo’s history is pretty complicated. But it’s easy to check that.
The version 0.17 returns:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"sessionId"</span><span class="p">:</span><span class="s2">"4decec3e-e564-b349-bb41-b27b5f307e01"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"value"</span><span class="p">:{</span><span class="w">
    </span><span class="nl">"acceptInsecureCerts"</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span><span class="w">
    </span><span class="nl">"browserName"</span><span class="p">:</span><span class="s2">"firefox"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"browserVersion"</span><span class="p">:</span><span class="s2">"52.0
    ...
</span></code></pre></div></div>

<p>whereas 0.13 returns:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="nl">"value"</span><span class="p">:{</span><span class="w">
  </span><span class="nl">"sessionId"</span><span class="p">:</span><span class="s2">"d0dc41f8-9c17-934e-be2b-708c72f0fb9c"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"capabilities"</span><span class="p">:{</span><span class="w">
    </span><span class="nl">"acceptInsecureCerts"</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span><span class="w">
    </span><span class="nl">"browserName"</span><span class="p">:</span><span class="s2">"firefox"</span><span class="p">,</span><span class="w">
    </span><span class="err">...</span><span class="w">
</span></code></pre></div></div>

<p>Look, they just wrapped the whole data into “value” subfield shifting it one
level below. Again, what was the purpose of doing this? Did you think of those
users who have already been using your code for some time?</p>

<p>Thanks to those weird changes, I need to refactor my code just because Mozilla
guys decided to rename something. And more over that, thank you for not sending
back the driver’s version in API responses. It would be not so challenging when
having it.</p>

<p>I wonder why has Chromedriver been working all that time without errors? It’s
written in <a href="https://github.com/bayandin/chromedriver/tree/master/client">C++ and Python</a> and the code is quite simple and
linear. And it’s much stable then its Rust-driven rival.</p>

<p>OK, it’s time to summarize all together. I don’t think that anybody will share
my misery on the subject. The Webdriver spec is quite specific thing, so who
would really care…</p>

<p>But the main point of that talk is you should never break backward capability
even at the gunpoint. Just keep things working, that’s the main priority when
you change something. Extend, but not truncate your product. And really, just
use it sometimes in a way that an ordinary user does.</p>

  </div>

</article>

<center>
    <p>
        <small>Нашли ошибку? Выделите мышкой и нажмите Ctrl/&#8984;+Enter</small>
    </p>
</center>






<center>Комментарии</center>

<div id="comments">
  
    <div id="comment-3613393103" class="comment-block">
      <p class="comment-lead">
        <small>
          <em>
            Antti Virtanen,
            13th Nov 2017,
            <a href="#comment-3613393103">link</a>
            
          </em>
        </small>
      </p>
      <div><p>I might care even though Webdriver spec is not what I work on. I might care as a software developer who is the end user of libraries like the one you have been developing. Indirectly this kind of stupidity affects me because suddenly I can't run my application level tests with a new version of Mozilla Firefox. Because they break the API. And don't seem to care.</p>
</div>
    </div>
  
</div>









<form id="comment-form" method="POST" action="https://functions.yandexcloud.net/d4ehfuf08fjfjr59ivnf">

    <div class="block">
        <p class="comment-form-label"><small>Your name</small></p>
        <input required id="comment-form-author" name="author" type="text">
    </div>

    <div class="block">
        <p class="comment-form-label"><small>Comment (markdown syntax)</small></p>
        <textarea required id="comment-form-comment" name="comment"></textarea>
    </div>

    <input required name="path" type="hidden" value="/en/mozilla/">
    <input required name="captcha" type="hidden" value="6 &#215; 3">

    <div class="block">
        <span class="comment-form-label"><small>6 &#215; 3 = </small></span>
        <input required id="comment-form-solution" name="solution" type="text">
    </div>

    <div class="block">
        <button id="comment-form-send" type="submit">Send</button>
    </div>

</form>


      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Ivan Grishaev's blog</li>
          <li><a href="mailto:ivan@grishaev.me">ivan@grishaev.me</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
            <li><a href="https://github.com/igrishaev">GitHub</a></li>
            <li><a href="tg://resolve?domain=igrishaev_blog">Telegram</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Writing on programming, education, books and negotiations.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
