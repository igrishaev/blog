<!DOCTYPE html>
<html lang="ru">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Ivan Grishaev's blog</title>
  <meta name="description" content="Writing on programming, education, books and negotiations.
">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/custom.css">
  <link rel="canonical" href="https://grishaev.me/page63/">
  <link rel="alternate" type="application/rss+xml" title="Ivan Grishaev's blog" href="https://grishaev.me/feed.xml">

  <link rel="shortcut icon" type="image/x-icon" href="/assets/static/favicons/favicon.ico">

  <script type="text/javascript" src="/assets/typo.js"></script>

</head>


  <body>
    <header class="site-header">

    <div class="wrapper flex-container">

        <div>
            <a href="/">
                <img id="avatar" src="/assets/static/avatar.jpg" alt="Ivan Grishaev">
            </a>
        </div>

        <div class="flex-container-vert" style="margin-left: 15px; width: 80%">

            <div class="flex-container full-width">
                <p style="margin-bottom: 5px">Ivan Grishaev's blog</p>
                <div class="flex-huge"></div>
                <div >
<form id="search-form"
      target="_blank"
      style="display: inline"
      method="get"
      action="https://www.google.com/search">

    <input name="sitesearch"
           value="grishaev.me"
           type="hidden">

    <input type="text"
           required="required"
           name="q"
           placeholder="Google search..."
           autocomplete="off">

    <button style="border: none; background-color: transparent; cursor: pointer;"
            type="submit">&#x1f50d;</button>

</form>
</div>
            </div>

            <p><small>Writing on programming, education, books and negotiations.
</small></p>

            <div class="flex-container">
                <a class="menu-item" href="/">Home</a>
                <a class="menu-item" href="/about/">About</a>
                <a class="menu-item" href="/bookshelf/">Bookshelf</a>
                <a class="menu-item" href="/feed.xml">RSS</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor" href="/tag/clojure/">Clojure</a>
                <a class="menu-item minor" href="/tag/emacs/">Emacs</a>
                <a class="menu-item minor" href="/tag/python/">Python</a>
                <a class="menu-item minor" href="/tag/programming/">Programming</a>
                <a class="menu-item minor" href="/interview/">Interview</a>
                <a class="menu-item minor" href="/video/">Video</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor hl" href="/clojure-in-prod/">Книга «Clojure на производстве»</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor hl" href="/clojure-in-prod-2/">Книга «Clojure на производстве», второй том</a>
            </div>

        </div>
    </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="home">

    <ul class="post-list">
        
        <li>

            <h2>
                <a class="post-link" href="/cors/">Руководство по кросс-доменным запросам (CORS)</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2016-12-18T00:00:00+00:00">
        Dec 18, 2016
    </time>

    <a href="/tag/cors/" rel="tag">cors</a>, <a href="/tag/html/" rel="tag">html</a>, <a href="/tag/ajax/" rel="tag">ajax</a>, <a href="/tag/json/" rel="tag">json</a>

</div>


            <div class="entry">
                
                    <p>На прошлой неделе я внедрял в проект CORS-запросы – современный способ
кросс-доменного Аякса. По следам прочитанной документации и набитых шишек
подготовил небольшой мануал. Это вольный пересказ англоязычных статей, вопросов
со Стека и скромный личный опыт.</p>

<p>Но сначала короткая предыстория. Я неравнодушен к собеседованиям, как вы,
наверное, знаете. Чаще я собеседовал бекенд, т.к. к фронтенду отношусь
прохладно. Но тема фронтенда обладает огромным потенциалом для оценки уровня
кандидата. Я считаю, что разработчик должен в деталях понимать протокол HTTP и
тонкости работы браузера.</p>

<p>Один из вопросов на тему фронтенда звучит банально: как на клиенте получить
данные с другого домена?</p>

<p>Некоторые кандидаты отвечают, что проблемы нет, достаточно выполнить
Аякс-запрос. И с большим удивлением узнают, что, оказывается, нельзя: сработают
какие-то там политики безопасности.</p>

<p>Один собеседуемый заявил, что в Фаерфоксе это работает, достаточно зайти на
страницу для разработчиков и что-то там переключить. Я не против такого
ответа. Следующий вопрос, как вы заставите всех пользователей установить именно
Фаерфокс и поменять системный флаг?</p>

<p>С понятием JSONP вообще беда – никто не может объяснить, как это
устроено. Разработчики думают, что это обычный Аякс, только с каким-то P на
конце, то ли баг, то ли фича. А это вообще ни разу не Аякс.</p>

<p>Аббревиатура CORS появилась недавно, и спрашивать о ней нет смысла. Этот пробел
восполняет данный мануал.</p>

<p>Разберем вопросы из предыдущих абзацев. Действительно, слать Аякс-запросы к
серверам с другим доменом запрещено на уровне браузера. Однако, в интернете
полно сайтов, где значимая часть контента подгружается со сторонних
серверов. Например, этот блог работает на статичном генераторе
<a href="/jekyll">Jekyll</a>, в котором нет комментариев. Делиться мнениями помогает сервис
<a href="https://disqus.com/">Discuss</a>: лента комментариев встраивается
Джаваскриптом. Получая и отправляя комментарии, вы взаимодействуете с серверами
Discuss, а мой блог вообще ни при чем. Значит, слать запросы Аяксом все же
можно?</p>

<p>Нет, здесь работает JSONP. Аббревиатура значит JSON with Padding (с
подкладкой). Идея основана на лазейке в стандартах: загружать скрипты с других
доменов не запрещено! Скажем, если в файле <code class="language-plaintext highlighter-rouge">example.js</code> на чужом сервере
написано что-то вроде:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">alert</span><span class="p">(</span><span class="dl">"</span><span class="s2">hello!</span><span class="dl">"</span><span class="p">);</span>
</code></pre></div></div>

<p>, то достаточно подгрузить его тегом <code class="language-plaintext highlighter-rouge">&lt;script&gt;</code> на страницу:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"http://example.com/static/example.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
</code></pre></div></div>

<p>и браузер выполнит все, что внутри. В данном случае покажет окошко.</p>

<p>Предположим теперь, что сервер отдает не статичный файл, а генерит его
динамически в зависимости от параметров. Например, мы добавляем на страницу
скрипт с адресом:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;script
</span><span class="na">src=</span><span class="s">"http://example.com/api.js?method=get_user&amp;user_id=42&amp;callback=processUser"</span>
<span class="nt">&gt;&lt;/script&gt;</span>
</code></pre></div></div>

<p>В переменой <code class="language-plaintext highlighter-rouge">method</code> указываем, какое действие требуем от сервера. В данном
случае, получить пользователя по идентификатору. Айдишку передаем следующим
параметром <code class="language-plaintext highlighter-rouge">user_id</code>. Пусть такой пользователь найден на сервере, теперь его
нужно отдать клиенту. Если просто выплюнуть объект:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="nl">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Ivan</span><span class="dl">"</span><span class="p">,</span> <span class="nx">age</span><span class="p">:</span> <span class="mi">30</span><span class="p">}</span>
</code></pre></div></div>

<p>, то на клиенте ничего не произойдет: объект просто считается в память. Именно
поэтому передают третий параметр <code class="language-plaintext highlighter-rouge">callback</code> – имя функции, объявленной на
клиенте, в которую нужно завернуть пользователя. С этим параметром ответ станет
другим:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">processUser</span><span class="p">({</span>
    <span class="na">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Ivan</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">age</span><span class="p">:</span> <span class="mi">30</span>
<span class="p">});</span>
</code></pre></div></div>

<p>На клиенте отработает код, зашитый в функцию <code class="language-plaintext highlighter-rouge">processUser</code>: вывести данные в
консоль, отрисовать виджет и т.д. Вот как работает JSONP.</p>

<p>Теперь, имея полную картину, нельзя не признать, что технология очень
крива. Прежде всего, это лазейка, костыль. Разработчики стандартов просто не
были настолько хитры, чтобы предугадать динамическое взаимодействие на уровне
скриптов.</p>

<p>Далее, подгрузка скриптов ни разу не безопасней, чем Аякс. Целое семейство
вирусов занимается тем, что добавляет на страницу браузера скрипты для отрисовки
баннеров порно и казино. Когда вы подключаетесь к интернету через мобильных
операторов, обсосы вставляют в HTML-трафик скрипты для отрисовки виджетов (если
соединение не HTTPS).</p>

<p>JSONP работает только методом GET, что сводит на нет возможности
REST-интерфейса. Для REST-сервисов приходится писать прокладки-прокси,
т.е. множить костыли.</p>

<p>Добавив скрипт на страницу, в дальнейшем вы не можете отследить его судьбу. Если
у Аякс-запроса есть специальные коллбеки для основных событий (начало, удачное
завершение, таймаут, неудачное завершение), то у скрипта ничего такого
нет. Загрузился ли он? Ответил ли сервер? Была ли ошибка? Никто не знает.</p>

<p>Ясно, что в 2016 году приложениям на js нужен надежный способ забирать данные с
серверов. Чтобы это была законно, а не по-воровски в обход протоколов и
стандартов. Таким способом стал <code class="language-plaintext highlighter-rouge">CORS</code> – <code class="language-plaintext highlighter-rouge">Cross-Origin Resource Sharing</code>,
кросс-доменные запросы.</p>

<p>Идея проста – пусть клиент шлет Аякс-запрос к чужому серверу. Браузер добавит в
запрос особые заголовки с информацией о том, что запрос с другого домена. На их
основании сервер решит, как обрабатывать такой запрос, и добавит особые
заголовки в ответ. Удобно, правда?</p>

<p>Техническая реализация несколько сложнее. Стандарт CORS различает “простые” и
“сложные” запросы. Простым считается запрос методами:</p>

<ul>
  <li>HEAD</li>
  <li>GET</li>
  <li>POST</li>
</ul>

<p>и заголовками:</p>

<ul>
  <li>Accept</li>
  <li>Accept-Language</li>
  <li>Content-Language</li>
  <li>Last-Event-ID</li>
  <li>Content-Type, <strong>но только со значениями:</strong>
    <ul>
      <li>application/x-www-form-urlencoded</li>
      <li>multipart/form-data</li>
      <li>text/plain</li>
    </ul>
  </li>
</ul>

<p>Если ваш запрос удовлетворяет этим критериям, можно слать Аякс к другому домену
из любого современного браузера. При этом браузер добавит заголовок <code class="language-plaintext highlighter-rouge">Origin</code> с
адресом страницы, откуда инициирован запрос. Подделать заголовок скриптом не
удастся.</p>

<p>Сервер, получив на обработку подобный запрос, должен прочесть Origin и решить,
как его обрабатывать. Заголовок ответа <code class="language-plaintext highlighter-rouge">Access-Control-Allow-Origin</code> регулирует,
с какого домена разрешено запрашивать данные. Это может быть как веб-адрес, так
и знак астерикса (звездочки), если разрешено всем. Несколько разных адресов
через запятую, к сожалению, не поддерживаются.</p>

<p>Пример CORS-запроса:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST /foo/bar HTTP/1.1
Origin: http://foreign.com
Host: test.com
</code></pre></div></div>

<p>и ответа с разрешением на получение данных:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>200 OK HTTP/1.1
Access-Control-Allow-Origin: http://foreign.com
Content-Type: text/html; charset=utf-8

&lt;h1&gt;Welldone&lt;/h1&gt;
</code></pre></div></div>

<p>Обратите внимание на такую вещь: мы намерены использовать CORS, чтобы дергать
чужие API. С вероятностью почти 100% они работают по протоколу <code class="language-plaintext highlighter-rouge">JSON</code>, то есть
принимают и отдают заголовок <code class="language-plaintext highlighter-rouge">Content-Type: application/json</code>. Вроде бы мелочь,
но такой запрос автоматом перестает быть простым и переходит в разряд “сложных”,
где схема взаимодействия иная.</p>

<p>Сложные запросы <strong>проходят в два этапа</strong>. Сначала браузер делает запрос по тому
же урлу, но методом <code class="language-plaintext highlighter-rouge">OPTIONS</code>. Сервер должен ответить: какими другими методами и
дополнительными заголовками (помимо стандартных) можно обращаться к этому
урлу. И только получив разрешение, браузер сделает запрос на основной урл.</p>

<p>При этом браузер не дурак и все запомнит: если разрешили только методы GET и
POST, то PUT и DELETE не сработают. Аналогично с заголовками: если помимо
стандартных разрешено использовать только <code class="language-plaintext highlighter-rouge">Authorization</code>, то нужно передать его
и ничего другого.</p>

<p>Пример сложного запроса:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>OPTIONS /cors HTTP/1.1
Origin: http://api.bob.com
Access-Control-Request-Method: PUT
Access-Control-Request-Headers: X-Custom-Header
Host: api.alice.com
Accept-Language: en-US
Connection: keep-alive
User-Agent: Mozilla/5.0...
</code></pre></div></div>

<p>Клиент хотел отправить Аяксом запрос методом <code class="language-plaintext highlighter-rouge">PUT</code> на урл
<code class="language-plaintext highlighter-rouge">http://api.alice.com/cors</code> с сайта <code class="language-plaintext highlighter-rouge">http://api.bob.com</code>. Поскольку это сложный
запрос, браузер запросил разрешение: типа, хочу сделать PUT на этот урл с особым
заголовком <code class="language-plaintext highlighter-rouge">X-Custom-Header</code>. Сервер ему на это:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>200 OK HTTP/1.1
Access-Control-Allow-Origin: http://api.bob.com
Access-Control-Allow-Methods: GET, POST, PUT
Access-Control-Allow-Headers: X-Custom-Header
Content-Type: text/html; charset=utf-8
</code></pre></div></div>

<p>Или иными слвами: разрешено ходить методами GET, POST, PUT и с заголовком
X-Custom-Header. Это подходит под критерии первоначального запроса. Браузер
делает второй запрос куда мы намеревались вначале.</p>

<p>Первая стадия, когда делается запрос OPTION, официально называется <code class="language-plaintext highlighter-rouge">preflight
request</code>. Надо сказать, такое взаимодействие весьма прозрачно отражается в
браузере. Например, в консоли разработчика в Хроме видны оба запроса со всеми
заголовками.</p>

<p>Вот такие строгости. В нашем проекте API на стороне сервера требует заголовки
Version (версия операции), Authorization (авторизация по токену) и Content-Type
(JSON), поэтому в ответе указываем</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Access-Control-Allow-Headers: Version, Authorization, Content-Type
</code></pre></div></div>

<p>, иначе запрос не пройдет.</p>

<p>Теперь все это можно протестировать. Запускаем локальный сервер, открываем
консоль Хрома и пишем:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">xhr</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">();</span>
<span class="nx">xhr</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="dl">"</span><span class="s2">GET</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">http://127.0.0.1:5000/api/users</span><span class="dl">"</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
<span class="nx">xhr</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="dl">"</span><span class="s2">authorization</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">Token xxxxxx</span><span class="dl">"</span><span class="p">);</span>
<span class="nx">xhr</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="dl">"</span><span class="s2">Version</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">1</span><span class="dl">"</span><span class="p">);</span>
<span class="nx">xhr</span><span class="p">.</span><span class="nx">send</span><span class="p">();</span>
<span class="nx">xhr</span><span class="p">.</span><span class="nx">responseText</span>
<span class="o">&gt;&gt;</span> <span class="dl">"</span><span class="s2">{</span><span class="dl">"</span><span class="nx">users</span><span class="dl">"</span><span class="s2">:[{name </span><span class="dl">"</span><span class="nx">Ivan</span><span class="dl">"</span><span class="s2">...
</span></code></pre></div></div>

<p>Забавно, что заголовок <code class="language-plaintext highlighter-rouge">Origin</code> в этом случае будет равен <code class="language-plaintext highlighter-rouge">https://google.com</code>,
потому что Хром считает пустой страницей главную Гугла.</p>

<p>Видно теперь, что даже сложная версия стандарта весьма понятна, если
разобраться. На мой взгляд, она все же избыточна: может быть либо один, либо два
запроса. Я бы постарался привести к общему знаменателю. Как этот ад поддерживают
разработчики браузеров, не понимаю.</p>

<p>Несмотря на кажущуюся простоту, реализовать поддержку CORS на сервере требует
времени. Первоначально я хотел использовать чужую библиотеку, но после 10 минут
чтения исходного кода понял, что автор НЕПРАВИЛЬНО понял спецификацию и
реализовал ее с ошибками. Лишний раз убедился, авторы сторонних библиотек – не
боги, а такие же смертные. Они могут тупить, ошибаться. Лучше потратить день на
чтение спеки и сделать все правильно, чем доверять первому встречному решению.</p>

<p>Расскажу теперь о тонкостях, с которыми столкнулся при внедрении CORS в
проекте. Прежде всего, чтобы сократить число preflight-запросов, стоит
либо кешировать эндпоинт <code class="language-plaintext highlighter-rouge">OPTIONS</code> заголовками:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Cache-Control: no-cache, must-revalidate
</code></pre></div></div>

<p>, либо вообще объявить его на уровне Nginx:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>location / {
     if ($request_method = 'OPTIONS') {
        add_header 'Access-Control-Allow-Origin' '*';
        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
        add_header 'Access-Control-Allow-Headers' 'Version, Authorization, Content-Type';
     }
</code></pre></div></div>

<p>Еще одна тонкость: даже если возвращаете ответ с не-положительным статусом,
например, не прошла валидация или нет прав, заголовок
<code class="language-plaintext highlighter-rouge">Access-Control-Allow-Origin</code> обязан присутствовать. Если заголовка нет, браузер
решит, что CORS-запрос запрещен и не прочитает ответ.</p>

<p>В нашем случае это вылилось в следующее: CORS-декоратор оборачивал ответ в заголовки только в
положительном случае. Если не проходила валидация, приложение отсылало ответ еще
до того, как доходила очередь декоратора. Браузер не мог внятно сказать, почему не прошел запрос.
Пришлось поднять декоратор на самый верх стека.</p>

<p>С CORS разобрались, теперь не будет лишним почитать другое руководство <a href="/timezone">про
часовые пояса</a></p>

<p>Ссылки:</p>

<ul>
  <li>
    <p><a href="https://www.html5rocks.com/en/tutorials/cors/">Using CORS</a></p>

    <p>Отличный туториал на английском языке, откуда я подчерпнул большую часть материала.</p>
  </li>
  <li>
    <p><a href="http://enable-cors.org/">Enable CORS</a></p>

    <p>Сайт, целиком посвященный CORS: описание, статьи, конфиги, примеры кода.</p>
  </li>
</ul>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/read-5/">Что почитать на выходных №5</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2016-12-17T00:00:00+00:00">
        Dec 17, 2016
    </time>

    <a href="/tag/read/" rel="tag">read</a>, <a href="/tag/life/" rel="tag">life</a>

</div>


            <div class="entry">
                
                    <p>Поехали, техническое:</p>

<ul>
  <li>
    <p><a href="http://www.yegor256.com/2016/12/13/mvc-vs-oop.html">MVC vs. OOP</a></p>

    <p>Замечания Егора Бугаенко об известных паттернах.</p>
  </li>
  <li>
    <p><a href="http://www.yegor256.com/2016/08/15/what-is-wrong-object-oriented-programming.html">What’s Wrong With Object-Oriented Programming?</a></p>

    <p>У того же автора: подборка цитат известных программистов о том, что ООП отстой.</p>
  </li>
  <li>
    <p><a href="https://www.html5rocks.com/en/tutorials/cors/">Using CORS</a></p>

    <p>Отличный мануал как прикрутить кросс-доменные запросы к серверу и
клиенту. Намереваюсь написать свой туториал по следам недавних изысканий.</p>
  </li>
</ul>

<p>На сладкое:</p>

<ul>
  <li>
    <p><a href="https://snob.ru/selected/entry/117376">Женщины для меня устарели</a></p>

    <p>Что дает человеку секс с роботом.</p>
  </li>
</ul>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/clj-http/">Мой вклад в clj-http</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2016-12-16T00:00:00+00:00">
        Dec 16, 2016
    </time>

    <a href="/tag/clojure/" rel="tag">clojure</a>, <a href="/tag/http/" rel="tag">http</a>

</div>


            <div class="entry">
                
                    
<p>В проект <a href="https://github.com/dakrone/clj-http">clj-http</a> приняли мой
<a href="https://github.com/dakrone/clj-http/pull/343/files">скромный пулл-реквест</a>. Теперь, если запрос был вызван с флагом
<code class="language-plaintext highlighter-rouge">:throw-exceptions true</code> и вернулся плохой ответ (статус не 2хх, 3хх), то во
вбрасываемый словарь добавляеся ключ <code class="language-plaintext highlighter-rouge">:type
:clj-http.client/unexceptional-status</code>. Это на ура работает с библиотекой
<a href="https://github.com/scgilardi/slingshot">Slingshot</a>, потому что отлов исключений по полю <code class="language-plaintext highlighter-rouge">:type</code> стал
негласным стандартом.</p>

<p>Если абзац выше звучит для вас бессмыслецей, расскажу подробней. Изначально в
Кложе идут унылые Java-исключения, которые плохо ложатся на мир структур и
коллекций. Но поскольку Кложа это Лисп, а в Лиспе любая проблема решается его же
силами, умельцы написали библиотеку для альтернативных исключений slingshot.</p>

<p>Библиотека упрощает работу с исключениями до мыслимого предела. Теперь можно
вбрасывать не только объект, унаследованный от Throwable, а вообще что
угодно. Лучше всего подходит словарь. Форма отлова исключения, выброшенного из
slingshot, может иметь разную структуру. Например, предикат, но удобней и короче
будет вектор двух элементов, где первый – ключ, а второй – значение.</p>

<p>Если раньше приходилось передавать неочевидный предикат, который проверял, что в
словаре есть поле <code class="language-plaintext highlighter-rouge">status</code>, и оно числовое:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">catch</span><span class="w">
  </span><span class="p">(</span><span class="k">fn</span><span class="w"> </span><span class="p">[</span><span class="n">response</span><span class="p">]</span><span class="w">
    </span><span class="p">(</span><span class="nb">-&gt;</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="no">:statsus</span><span class="w"> </span><span class="n">integer?</span><span class="p">))</span><span class="w">
  </span><span class="n">...</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>, то теперь достаточно сравнить так:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">catch</span><span class="w"> </span><span class="p">[</span><span class="no">:type</span><span class="w"> </span><span class="no">:clj-http.client/unexceptional-status</span><span class="p">])</span><span class="w">
</span></code></pre></div></div>

<p>Визуально разницы мало, но селектор по ключу <code class="language-plaintext highlighter-rouge">:type</code> открывает новые
горизонты. Например, во фреймворке <a href="https://github.com/metosin/compojure-api">Compojure API</a>, на котором
наш проект, обработка исключений целиком работает на этом принципе. В особом
словаре лежат ключи – потенциальные варианты <code class="language-plaintext highlighter-rouge">:type</code>, а значения –
функции-обработчики. Хорошие примеры <a href="https://github.com/metosin/compojure-api/wiki/Exception-handling">в документации</a>.</p>

<p>Пока пулл-реквест не приняли, приходилось писать свой костыль для добавления
ключа. Теперь с этим покончено.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/press/">Статья в Associated Press</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2016-12-14T00:00:00+00:00">
        Dec 14, 2016
    </time>

    <a href="/tag/press/" rel="tag">press</a>, <a href="/tag/ap/" rel="tag">AP</a>

</div>


            <div class="entry">
                
                    <p><img src="/assets/static/ivan.jpg" alt="ivan" /></p>

<p>В издании Associated Press <a href="http://bigstory.ap.org/article/b46a8e42383049ea8a449130cdec0e67/tech-hub-russias-rustbelt-recessions-godsend">опубликована статья</a> об айти-специалистах
Воронежа, в том числе из нашего офиса. Я немного рассказал про удаленку, деньги
и прочие детали, словом, все то, что описывал в посте про
<a href="/remote">удаленную работу</a>. Мой коллега Михаил поделился взглядами на рынок
специалистов и воздействие кризиза на айти.</p>

<p>Фотографии в хорошем качестве и видео на сайте AP доступны только по платной
подписке.</p>


                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/syntax/">Синтаксис</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2016-12-12T00:00:00+00:00">
        Dec 12, 2016
    </time>

    <a href="/tag/syntax/" rel="tag">syntax</a>, <a href="/tag/lisp/" rel="tag">lisp</a>

</div>


            <div class="entry">
                
                    <p>Незрелый программист судит о языке по синтаксису. Эти скобочки люблю, а такие
нет. Языки с отступами не рассматриваю. Требую коммерческую ИДЕ с дебагом
мышкой.</p>

<p>Это проблема.</p>

<p>Каждый язык обладает неповторимым портретом. Он складывается из идей, которые
вложил в него автор. Как устроены коллекции, как ведут себя типы-примитивы,
какая парадигма господствует.</p>

<p>Автор выбирает тот или иной синтаксис, чтобы выразить внутреннее устройство
языка явно. Чтобы программисты смогли понять заложенные в языке принципы. Верно
их применить.</p>

<p>Бывает, синтаксис не только справляется со своей задачей, но и привносит
преимущества, недоступные в другим синтаксисам. Например, любой диалект Лиспа
автоматически несет мощь макросов и метапрограммирования в дополнение к языку.</p>

<p>Обыватели полагают, что Кложа – это очередной “современный” Лисп. Это
рассуждение дилетанта. Кложа – самостоятельный язык с принципиально новыми
идеями, оформленный в виде Лиспа. Его создатель мог бы выбрать сишный или
питонячий синтаксис и получить какой-нибудь Котлин или Скалу со своими
особенностями.</p>

<p>Синтаксис – это внешность языка.  По налогии с людьми, внешность бывает
обманчива. Человек заметил это еще в древние времена: не тот друг, кто красиво
выглядит, и не тот враг, кто некрасив.</p>

<p><img src="/assets/static/seth-godin.jpg" alt="seth-godin" /></p>

<p>Посмотрите на этого человека. Выглядит он слегка комично. Волос нет, черты лица
ассиметричны: нос скошен, левое ухо больше, глаза неровные. А это, на минутку,
<a href="https://en.wikipedia.org/wiki/Seth_Godin">Сет Годин</a> – мировой эксперт по маркетингу, автор научных работ и
бестеллеров.</p>

<p>Сделал он столько всего хорошего, что другим и за несколько жизней не сделать. С
такой внешностью, да.</p>

<p>Следующий тезис выделю особо.</p>

<h1 id="я-слышал-много-раз-что-у-лиспа-странный-синтаксис-но-ни-разу-не-слышал-что-он-не-решил-какую-то-задачу">Я слышал много раз, что у Лиспа странный синтаксис, но ни разу не слышал, что он не решил какую-то задачу</h1>

<p>Когда вы жаловались, пытались сделать что-то полезное? Например, распарсить XML,
JSON, дернуть урл или сходить в базу. Спорю, что даже не пытались, потому что
все это Лисп делает на раз.</p>

<p>Фразы о синтаксисе обычно исходят от самовлюбленных нарциссов, которым лень
пошевелить головой. Малейшая неожиданность, мозг потревожен – включается
агрессия. Плохой синтаксис!</p>

<p>Человек привыкает ко всему. Садишься за Лисп, и непривычно. А недавно, после
двух месяцев Кложи, сел за Питон и все вызовы функций напихал в скобки. Уже
автомат.</p>

<p>Испытываешь приятно чувство, когда видишь стену кода на Лиспе и скачешь по нему
вверх и вниз с полным пониманием, что происходит. Синтаксис уходит и остается
только смысл, заложенный в код. Я читал, похожее чувствуют спортсмены, когда
прорывают очередной рубеж. Только здесь работает голова, а не тело.</p>

<p>Синтаксисы хороши все. Важно видеть за синтаксисом природу языка, тогда не будет
проблем с восприятием синтаксиса.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/read-4/">Что почитать на выходных №4</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2016-12-10T00:00:00+00:00">
        Dec 10, 2016
    </time>

    <a href="/tag/read/" rel="tag">read</a>, <a href="/tag/life/" rel="tag">life</a>

</div>


            <div class="entry">
                
                    <p>Поехали:</p>

<ul>
  <li>
    <p><a href="https://specious.github.io/blog/2016/12/07/Starting-a-NodeJS-app-with-ClojureScript-and-Boot/">Starting a Node.js app with ClojureScript and Boot</a> (английский)</p>

    <p>Небольшой туториал как начать проект на Ноде с Кложе-скриптом. Да, под Ноду
можно спокойно писать на cljs.</p>
  </li>
</ul>

<ul>
  <li>
    <p><a href="http://www.yegor256.com/2016/11/09/why-no-ebooks.html">Why I Don’t Publish E-Books</a> (английский)</p>

    <p>Егор Бугаенко о недостатках электронных книг.</p>
  </li>
</ul>

<ul>
  <li>
    <p><a href="http://artgorbunov.ru/bb/soviet/20160121/">Что значит «сделать»?</a></p>

    <p>Николай Товеровский (сотрудник Бюро Горбунова) объясняет разницу между
“делать” и “сделать”. В рамочку и на стену.</p>
  </li>
</ul>

<ul>
  <li>
    <p>И на сладкое: <a href="https://snob.ru/selected/entry/99127?v=1452099738">Голый патриарх, или Закон Микки Мауса</a></p>

    <p>Александр Невзоров как всегда прекрасен.</p>
  </li>
</ul>


                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/meetup12/">Двенадцатая встреча</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2016-12-09T00:00:00+00:00">
        Dec 9, 2016
    </time>

    <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/meetup/" rel="tag">meetup</a>, <a href="/tag/deep-refactoring/" rel="tag">deep-refactoring</a>

</div>


            <div class="entry">
                
                    <p>Провели двенадцатую встречу. Двенадцатую, Карл! Целый год без пропусков, в жару
и холод, в будни и на майских. 25 выступлений, 12 докладчиков. Отдельным постом
я расскажу, с чего все начиналось и как вообще держится, я пока что свежие
видосы.</p>

<p>Антон Чикин рассказал про мердж в Гите:</p>

<iframe width="100%" height="500" src="https://www.youtube.com/embed/Ei2PfAKUkaI" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen="">
</iframe>

<p><a href="https://speakerdeck.com/achikin/git-merge-in-depth">Слайды</a></p>

<p>Артем Трубачев топил за веб-сокеты, послушал с удовольствием:</p>

<iframe width="100%" height="500" src="https://www.youtube.com/embed/coitU07ZTsM" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen="">
</iframe>

<p><a href="http://slides.com/artemtrubachev/websocket#/">Слайды</a></p>

<p>Косяки: я вел трансляцию в Перископе, ушла только половина эфира. В следующий
раз нам грозятся дать личный пароль от Дом.ру, так что есть надежда. Во время
записи опять налажал со звуком: писал на встроенный микрофон мимо петличного,
звук вышел не ахти. Зато слышен весь бред из зала :-)</p>

<p>На следующую встречу уже запланированы выступления: про Докер и No-SQL базы
данных. Следите за новостями. Хотите выступить – пишите в личку. Напомню, на
тему Рефакторинга мы общаемся в
<a href="https://telegram.me/deeprefactoring">чате Телеграма</a>.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/read-3/">Что почитать на выходных №3</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2016-12-02T00:00:00+00:00">
        Dec 2, 2016
    </time>

    <a href="/tag/read/" rel="tag">read</a>, <a href="/tag/life/" rel="tag">life</a>

</div>


            <div class="entry">
                
                    <p>В этом выпуске:</p>

<ul>
  <li>
    <p><a href="http://eax.me/hr-experience/">Мой скромный опыт в роли HR</a> (русский)</p>

    <p>О вечном: работе и найме. Под “мой” в данном случае подразумевается опыт
Александра. Тема собеседования мне очень интересна, я писал о нем
неоднократно: <a href="/how-to-be-interviewed">раз</a>, <a href="/dont-ask">два</a>,
<a href="/how-to-interview">три</a>, <a href="/lead">четыре</a>.</p>
  </li>
  <li>
    <p><a href="https://www.youtube.com/watch?v=oyLBGkS5ICk&amp;list=PLZdCLR02grLofiMKo0bCeLHZC0_2rpqsz&amp;index=1">Rich Hickey: Spec-ulation Keynote</a>
(видео, английский)</p>

    <p>Опубликованы доклады с Clojure/conj 2016
(<a href="https://www.youtube.com/playlist?list=PLZdCLR02grLofiMKo0bCeLHZC0_2rpqsz">плейлист</a>). Судя
по заголовкам, все доклады интересные, но пусть это будет Рич в качестве
главного рекомендуемого к просмотру.</p>
  </li>
  <li>
    <p>На сладкое:
<a href="https://rufabula.com/author/shrmndrzd/991">Один день из жизни Николая Ивановича</a>
(русский)</p>

    <p>Просто читать до конца.</p>
  </li>
</ul>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/emacs-term/">Емакс в терминале</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2016-11-29T00:00:00+00:00">
        Nov 29, 2016
    </time>

    <a href="/tag/emacs/" rel="tag">emacs</a>, <a href="/tag/terminal/" rel="tag">terminal</a>

</div>


            <div class="entry">
                
                    <p>Долгое время я пользовался Емаксом с графическим интерфейсом. Для Мака такой
Емакс качается с сайта <a href="https://emacsformacosx.com/">Emacs For Mac OS X</a> и ставится как
обычное приложение в папке <code class="language-plaintext highlighter-rouge">Applications</code>.</p>

<p>Два месяца назад перешел на версию для терминала. Ниже короткие заметки о том,
как это сделать и что изменилось.</p>

<p><strong>Установка из пакетов.</strong> Для Мака ставится из brew: <code class="language-plaintext highlighter-rouge">brew install emacs</code>. На
момент написания статьи скачивается версия 25.1. Важно: бинарник находится по
пути <code class="language-plaintext highlighter-rouge">/usr/local/Cellar/emacs/25.1/bin/emacs</code>! Если вы введете в терминале
просто <code class="language-plaintext highlighter-rouge">emacs</code>, то запустится <code class="language-plaintext highlighter-rouge">/usr/bin/emacs</code>, у меня это какое-то старье.</p>

<p><strong>Внешний вид.</strong> Я использую стандартную цветовую схему <code class="language-plaintext highlighter-rouge">light-blue</code> из
коробки. Включается командой <code class="language-plaintext highlighter-rouge">(load-theme 'light-blue t)</code>. В терминальной версии
цвета немного другие. Сравните графическую версию:</p>

<p><img src="/assets/static/emacs/emacs-gui.png" alt="gui" /></p>

<p>и терминал:</p>

<p><img src="/assets/static/emacs/emacs-term.png" alt="terminal" /></p>

<p><strong>Размер текста.</strong> Для комфортной работы я нашел полезным ставить шрифт
покрупнее. Глаза нам даны одни на всю жизнь, так что лучше их поберечь. В
графической версии высота шрифта меняется командой <code class="language-plaintext highlighter-rouge">(set-face-attribute 'default
nil :height 140)</code> (140 – моя метрика, подобранная эмпирически). В терминале,
конечно, это не прокатит. Поэтому я просто жму три раза <code class="language-plaintext highlighter-rouge">Cmd + =</code>. Получается
как на рисунке ниже (картинка специально обрезана, чтобы вошла в колонку без
масштабирования):</p>

<p><img src="/assets/static/emacs/emacs-font.png" alt="font" /></p>

<p><strong>Курсор.</strong> Больше недели не мог настроить цвет курсора в терминале. В
графической версии был красный, а в терминале серый. Сливается в голубым фоном,
глазам трудно найти. Команды вроде <code class="language-plaintext highlighter-rouge">(set-cursor-color "#ffffff")</code> не помогают.
Оказывается, в маковском терминале <code class="language-plaintext highlighter-rouge">Iterm2</code> цвет курсора и текста под ним
регулируется силами самого терминала. Пришлось поправить настройки:</p>

<p><img src="/assets/static/emacs/emacs-iterm2.png" alt="iterm2" /></p>

<p>Вместе с цветом курсора (Cursor) можно включить легкое цветовое выделение
текущей строки (Cursor Guide).</p>

<p><strong>Общие впечатления.</strong> В целом мне показалось, что терминальная версия работает
быстрее графической. Изредка бывают артефакты при сложной прорисовке (несколько
рабиений окна, например), а так все ок. Мини-буфер, попапы работают как надо.</p>

<p>Напомню, мой конфиг Емакса с комментариями лежит <a href="https://github.com/igrishaev/dotfiles/blob/master/.emacs">в Гитхабе</a>.</p>


                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/read-2/">Что почитать на выходных №2</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2016-11-26T00:00:00+00:00">
        Nov 26, 2016
    </time>

    <a href="/tag/read/" rel="tag">read</a>, <a href="/tag/life/" rel="tag">life</a>

</div>


            <div class="entry">
                
                    <p>В этом выпуске:</p>

<ul>
  <li>
    <p><a href="https://habrahabr.ru/company/ecwid/blog/315228/">История одного тестового задания</a> (русский) – забавный пост о том, как
кандидаты справляются с практическим заданием при трудоустройстве. Каждый
абзац прекрасен. С юмором, тонко и по делу.</p>
  </li>
  <li>
    <p><a href="https://www.infoq.com/presentations/Simple-Made-Easy">Simple Made Easy</a> (видео, слайды, английский) – ТОТ САМЫЙ доклад Рича Хики,
что делит жизнь пополам. Серьезно: очень мощное выступление Рича. Без привязки
к конкретному языку.</p>
  </li>
  <li>
    <p><a href="https://snob.ru/selected/entry/113169">Культ женской глупости</a> (русский) – Арина Холина о женщинах и
интеллекте.</p>
  </li>
</ul>

<p>Что, мало про технологии? Да забейте. Дайте мозгу отдохнуть.</p>


                
            </div>

        </li>
        
    </ul>

    <h4>
        
        <a href="/page62" class="previous">&larr;</a>
        
        <span class="page_number ">Страница 63 из 89</span>
        
        <a href="/page64" class="next">&rarr;</a>
        
    </h4>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Ivan Grishaev's blog</li>
          <li><a href="mailto:ivan@grishaev.me">ivan@grishaev.me</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
            <li><a href="https://github.com/igrishaev">GitHub</a></li>
            <li><a href="https://t.me/igrishaev_blog">Telegram</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Writing on programming, education, books and negotiations.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
