<!DOCTYPE html>
<html lang="ru">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Без ORM</title>
  <meta name="description" content="UPD Продолжение">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/custom.css">
  <link rel="canonical" href="https://grishaev.me/sql-no-orm/">
  <link rel="alternate" type="application/rss+xml" title="Ivan Grishaev's blog" href="https://grishaev.me/feed.xml">

  <link rel="shortcut icon" type="image/x-icon" href="/assets/static/favicons/favicon.ico">

  <script type="text/javascript" src="/assets/typo.js"></script>

</head>


  <body>
    <header class="site-header">

    <div class="wrapper flex-container">

        <div>
            <a href="/">
                <img src="/assets/static/photo-round-small.png" alt="Ivan Grishaev">
            </a>
        </div>

        <div class="flex-container-vert" style="margin-left: 15px; width: 80%">

            <div class="flex-container full-width">
                <p style="margin-bottom: 5px">Ivan Grishaev's blog</p>
                <div class="flex-huge"></div>
                <div >
<form id="search-form"
      target="_blank"
      style="display: inline"
      method="get"
      action="https://www.google.com/search">

    <input name="sitesearch"
           value="grishaev.me"
           type="hidden">

    <input type="text"
           required="required"
           name="q"
           placeholder="Google search..."
           autocomplete="off">

    <button style="border: none; background-color: transparent; cursor: pointer;"
            type="submit">&#x1f50d;</button>

</form>
</div>
            </div>

            <p><small>Writing on programming, education, books and negotiations.
</small></p>

            <div class="flex-container">
                <a class="menu-item" href="/">Home</a>
                <a class="menu-item" href="/about/">About</a>
                <a class="menu-item" href="/bookshelf/">Bookshelf</a>
                <a class="menu-item" href="/feed.xml">RSS</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor" href="/tag/clojure/">Clojure</a>
                <a class="menu-item minor" href="/tag/emacs/">Emacs</a>
                <a class="menu-item minor" href="/tag/python/">Python</a>
                <a class="menu-item minor" href="/tag/programming/">Programming</a>
                <a class="menu-item minor" href="/interview/">Interview</a>
                <a class="menu-item minor" href="/video/">Video</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor hl" href="/clojure-in-prod/">Книга «Clojure на производстве»</a>
            </div>

        </div>
    </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">

    <h1 class="post-title" itemprop="name headline">Без ORM</h1>

    
<div class="post-meta">

    <time class="post-time"
          datetime="2016-11-11T00:00:00+00:00">
        Nov 11, 2016
    </time>

    <a href="/tag/sql/" rel="tag">sql</a>, <a href="/tag/orm/" rel="tag">orm</a>

</div>


  </header>

  <div class="post-content" itemprop="articleBody">
    <p><em>UPD</em> <a href="/sql-no-orm-more">Продолжение</a></p>

<p><img src="/assets/static/nosql-expert.png" alt="sql" /></p>

<p>В текущем проекте мы используем SQL. Запросы, миграции, триггеры – все это
чистый скуль, написанный нами. Сперва было непривычно, за годы работы с Джангой
я напрочь забыл язык запросов. Теперь, напротив, меня дико прет. Рассказываю
плюсы и минусы такого подхода.</p>

<p>Прежде всего, мы используем библиотеку
<a href="http://www.hugsql.org/">HugSQL</a>. Работает она любопытным образом. Вы пишете
обычный <code class="language-plaintext highlighter-rouge">.sql</code> файл с запросами. Перед каждым запросом размещаете
структурированный комментарий. В нем указываете имя функции и дополнительные
директивы. Затем библиотека парсит файл и динамически создает в модуле функции с
аналогичными названиями.</p>

<p>Пример:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- :name create-user! :&lt;!</span>
<span class="c1">-- :doc creates a new user record</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">users</span>
<span class="p">(</span><span class="n">first_name</span><span class="p">,</span> <span class="n">last_name</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">phone</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">(:</span><span class="n">first_name</span><span class="p">,</span> <span class="p">:</span><span class="n">last_name</span><span class="p">,</span> <span class="p">:</span><span class="n">email</span><span class="p">,</span> <span class="p">:</span><span class="n">username</span><span class="p">,</span> <span class="p">:</span><span class="n">password</span><span class="p">,</span> <span class="p">:</span><span class="n">phone</span><span class="p">)</span>
<span class="n">RETURNING</span> <span class="o">*</span>

</code></pre></div></div>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">user</span><span class="w"> </span><span class="p">(</span><span class="nf">db/create-user!</span><span class="w"> </span><span class="p">{</span><span class="no">:username</span><span class="w"> </span><span class="s">"ivan"</span><span class="w">
                             </span><span class="no">:email</span><span class="w"> </span><span class="s">"test@test.com"</span><span class="w">
                             </span><span class="no">:password</span><span class="w"> </span><span class="s">"123"</span><span class="w">
                             </span><span class="no">:phone</span><span class="w"> </span><span class="s">"223-322"</span><span class="w">
                             </span><span class="no">:first_name</span><span class="w"> </span><span class="s">"test"</span><span class="w">
                             </span><span class="no">:last_name</span><span class="w"> </span><span class="s">"test"</span><span class="p">})])</span><span class="w">
</span></code></pre></div></div>

<p>Разберу минусы данного подхода. Во-первых, приходится писать больше кода. В
Джанге или Рельсах достаточно вызвать у объекта метод <code class="language-plaintext highlighter-rouge">.save()</code>. В зависимости
от состояния объекта будет выполнен запрос вставки или обновления. В нашем
случае нужно писать два отдельных запроса.</p>

<p>Во-вторых, приходется потратить время на повторное изучение SQL и конкретной
базы данных, в нашем случе – Постгреса. Потому что все ORM-системы превращают
базу в хранилище, то есть черный ящик. Есть модели, пользуйся, а внутрь не
лезь. И вообще, объекты предлагают больше синтаксического сахара.</p>

<p>Плюсов, на мой взгляд, больше. Прежде всего, приходит понимание того, что
происходит в БД. Как устроена структура, какие фукнции и триггеры объявлены, как
связаны сущности.</p>

<p>Появляется возможность свободно строить джоины, объединения. Мы активно
используем триггеры чтобы нормализовать поля. Добавляем констрейнты
(ограничения), чтобы предотвратить запись неверных данных.</p>

<p>Если база сопровождается ORM-системой, скорее всего, работать с ней из другого
языка будет невозможно. Потому что значения по-умолчанию, триггеры и авторизация
пользователей, как правило, реализованы силами ORM, а другая система ничего про
это не знает. У нас такое невозможно. Что Кложа, что Питон не смогут записать в
базу кривые данные.</p>

<p>Мы активно используем расширения Постгреса и специальные типы данных. JSON,
геолокация, генерация токенов и случайных величин. Не приходится писать это в
коде. Например, если из двух разных мест выполнить вставку в эту таблицу, будет
сгенерирован случайый токен на уровне БД. А если делать это в коде, придется
копипастить.</p>

<p>В логах Постргреса я вижу написанные в своем стиле запросы. ORM, как правило,
генерит адский поток, который невозможно прочесть. Если ORM-запрос содержит
что-то посложней чтения или вставки, например, <code class="language-plaintext highlighter-rouge">group by</code>, <code class="language-plaintext highlighter-rouge">having</code>, <code class="language-plaintext highlighter-rouge">join</code>,
<code class="language-plaintext highlighter-rouge">union</code>, приходится его дебажить. Потому что далеко не факт, что результат будет
таким, как вы хотите. Например, Алхимия в Питоне не может правильно сделать
<code class="language-plaintext highlighter-rouge">union</code>, хоть убей. А как указать, что тебе нужен именно левый джоин, а не
внутренний?</p>

<p>Не приходится перенастраивать мозги с одной ORM на другую. Помню, одновременно
работал в двух проектах, в одном Джанга, в другом Алхимия. Так замучился
запоминать особенности каждой. А чистый скуль не врет.</p>

<p>Выражаясь терминами Рича Хики, ORM это легко (easy), а SQL – просто
(simple). Это не синонимы. Легко значит – быстро, а просто – прозрачно. Здесь
я не буду умничать, а просто советую послушать доклад.</p>

<iframe width="854" height="480" src="https://www.youtube.com/embed/rI8tNMsozo0" allowfullscreen=""></iframe>

  </div>

</article>

<center>
    <p>
        <small>Нашли ошибку? Выделите мышкой и нажмите Ctrl/&#8984;+Enter</small>
    </p>
</center>






<center>Комментарии</center>

<div id="comments">
  
    <div id="comment-2996926852" class="comment-block">
      <p class="comment-lead">
        <small>
          <em>
            Lens,
            11th Nov 2016,
            <a href="#comment-2996926852">link</a>
            
          </em>
        </small>
      </p>
      <div><p>Благодаря чтению вашего блога, крепко подсел на кложу )). Сперва было непривычно очень. А теперь "прет", если позволите. Пока я где-то в начале пути, что-то написать сложное с использованием Люминус, например, не могу, но задачки на codewars или очень простое с помощью compojure, ring, http-kit, вполне получается. Так что как минимум одного человека, можете записать себе в актив :). В качестве пожелания: пишите про кложу больше.</p>
<p>Что до SQL, то в свое время именно благодаря тому, что столкнулся с чистым оракловым SQL - стал вообще программировать, и от инженерии переквалифицировался в программисты. Всегда было интересно писать чистые запросы, есть в этом какая-то магия или тайна. Потом же наоборот столкнулся с миром ORM. И магии стало больше, но пропала возможность писать запросы вообще, т.к. пишешь только get() save() insert() и тд. и в дебаг-панелях только простыни из запросов, в которых, и правда, трудно что-то найти.</p>
<p>А на кложе видел DSL библиотеку для написания sql, почему ее не используете? Кажется Korma называлась или ей подобная. Мне кажется это более удобным, правда может быть читаемость чистого SQL выше наверное, как более привычная. Тогда если сравнивать не ORM, а DSL в Korma или ей подобной библиотеке с чистым SQL, то что из этого считать simple, а что easy )<br />P.S. простите за многословность )</p>
</div>
    </div>
  
    <div id="comment-2996957983" class="comment-block">
      <p class="comment-lead">
        <small>
          <em>
            Ivan Grishaev,
            11th Nov 2016,
            <a href="#comment-2996957983">link</a>
            , <a href="#comment-2996926852">parent</a>
          </em>
        </small>
      </p>
      <div><p>Да, Корма -- почти полноценная ORM, а кроме нее есть DSL для описания запросов структурами данных. Но, во-первых, HugSQL -- часть Luminus, а во-вторых, у ORM и DSL трудности со сложными запросами. Так или иначе придется писать куски на сыром скуле.</p>
</div>
    </div>
  
    <div id="comment-2996996001" class="comment-block">
      <p class="comment-lead">
        <small>
          <em>
            Lens,
            11th Nov 2016,
            <a href="#comment-2996996001">link</a>
            , <a href="#comment-2996957983">parent</a>
          </em>
        </small>
      </p>
      <div><p>тогда выбор конечно более очевиден, если хочется гомогенности кода, чтобы не было кусков на DSL, скажем, и кусков на чистом SQL там где это необходимо. Я ошибаюсь или в Django тоже проблемы со сложными запросами, и именно это имеют ввиду когда говорят о недостатках Django ORM, и там тоже приходится прибегать к сырому SQL? Почему-то чаще я слышал об этом именно в контексте Django ORM. Хотя есть и те кто считают, что просто их не умеют готовить.</p>
</div>
    </div>
  
    <div id="comment-2998304801" class="comment-block">
      <p class="comment-lead">
        <small>
          <em>
            toporovvv,
            12th Nov 2016,
            <a href="#comment-2998304801">link</a>
            
          </em>
        </small>
      </p>
      <div><p>Тоже недавно думал над этим вопросом. Меня дико бесит работать с Doctrine ORM: получается, что вместо получения данных мне всё время приходится с ней бороться. Почему вместо нормального SQL я должен учить какой-то DQL? Почему я не могу нормально использовать функции базы и агрегацию - приходится объявлять перемнные в запросе и подготавливать данные на php. Это раздражает неимоверно.</p>
<p>Очень хочется найти бибилиотеку для работы с базой, где были бы простые методы для простых вещей (all(), filter(), insert(), update(), delete() - всё-таки ОРМ делает много "черновой работы") и при этом можно было бы писать на чистом SQL сложные запросы с автомаппингом на модели (чтобы не думать, как перевести запрос с многоэтажными джойнами, агрегацией и каким-нибудь условным ORDER BY в запрос на ОРМе).</p>
<p>С другой стороны, переносить логику работы в базу (увлекаясь хранимыми процедурами и триггерами, например) не рекомендуется, потому что стороннему человеку потом сложно будет сопоставить логику кода приложения и базы в единое целое.</p>
</div>
    </div>
  
    <div id="comment-2999783538" class="comment-block">
      <p class="comment-lead">
        <small>
          <em>
            Ivan Grishaev,
            13th Nov 2016,
            <a href="#comment-2999783538">link</a>
            , <a href="#comment-2996996001">parent</a>
          </em>
        </small>
      </p>
      <div><p>В Джанго есть трудности со сложными запросами, так же как и в любой другой ОРМ. Это случается редко, но все же. В основном, коде требуются возможности именно этой БД, которых нет в ОРМ. Например, рекурсивные запросы. Я лично не вижу ничего страшного в сыром скуле, но в среде тех, кто работает исключительно с РОМ, это считается моветоном. Поэтому если сразу писать на SQL, становишься свободен от этих предрассудков.</p>
</div>
    </div>
  
    <div id="comment-2999784891" class="comment-block">
      <p class="comment-lead">
        <small>
          <em>
            Ivan Grishaev,
            13th Nov 2016,
            <a href="#comment-2999784891">link</a>
            , <a href="#comment-2998304801">parent</a>
          </em>
        </small>
      </p>
      <div><p>Бизнес-логику переносить не стоит, конечно, например, расчет скидок или начисления бонусов. Потому что бизнес-логика постоянно меняется. А вот утилитарные вещи, например, приведение емейла к нижнему регистру -- вполне норм.</p>
</div>
    </div>
  
    <div id="comment-3000421192" class="comment-block">
      <p class="comment-lead">
        <small>
          <em>
            Lens,
            13th Nov 2016,
            <a href="#comment-3000421192">link</a>
            , <a href="#comment-2999783538">parent</a>
          </em>
        </small>
      </p>
      <div><p>Спасибо, в общем и целом мне нравится в сыром SQL один-два момента, но оказалось что уже написано продолжение ). А предрассудки, на мой взгляд, это всегда плохо. Я бы даже сказал, что это совершенно идиотская вещь. Они ограничивают человека, по определению.</p>
</div>
    </div>
  
</div>









<form id="comment-form" method="POST" action="https://functions.yandexcloud.net/d4ehfuf08fjfjr59ivnf">

    <div class="block">
        <p class="comment-form-label"><small>Your name</small></p>
        <input required id="comment-form-author" name="author" type="text">
    </div>

    <div class="block">
        <p class="comment-form-label"><small>Comment (markdown syntax)</small></p>
        <textarea required id="comment-form-comment" name="comment"></textarea>
    </div>

    <input required name="path" type="hidden" value="/sql-no-orm/">
    <input required name="captcha" type="hidden" value="3 &#215; 6">

    <div class="block">
        <span class="comment-form-label"><small>3 &#215; 6 = </small></span>
        <input required id="comment-form-solution" name="solution" type="text">
    </div>

    <div class="block">
        <button id="comment-form-send" type="submit">Send</button>
    </div>

</form>


      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Ivan Grishaev's blog</li>
          <li><a href="mailto:ivan@grishaev.me">ivan@grishaev.me</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
            <li><a href="https://github.com/igrishaev">GitHub</a></li>
            <li><a href="tg://resolve?domain=igrishaev_blog">Telegram</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Writing on programming, education, books and negotiations.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
