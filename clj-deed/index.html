<!DOCTYPE html>
<html lang="ru">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Deed: a fast encoding and decoding library for Clojure</title>
  <meta name="description" content="    Table of Content">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/custom.css">
  <link rel="canonical" href="https://grishaev.me/clj-deed/">
  <link rel="alternate" type="application/rss+xml" title="Ivan Grishaev's blog" href="https://grishaev.me/feed.xml">

  <link rel="shortcut icon" type="image/x-icon" href="/assets/static/favicons/favicon.ico">

  <script type="text/javascript" src="/assets/typo.js"></script>

</head>


  <body>
    <header class="site-header">

    <div class="wrapper flex-container">

        <div>
            <a href="/">
                <img id="avatar" src="/assets/static/avatar.jpg" alt="Ivan Grishaev">
            </a>
        </div>

        <div class="flex-container-vert" style="margin-left: 15px; width: 80%">

            <div class="flex-container full-width">
                <p style="margin-bottom: 5px">Ivan Grishaev's blog</p>
                <div class="flex-huge"></div>
                <div >
<form id="search-form"
      target="_blank"
      style="display: inline"
      method="get"
      action="https://www.google.com/search">

    <input name="sitesearch"
           value="grishaev.me"
           type="hidden">

    <input type="text"
           required="required"
           name="q"
           placeholder="Google search..."
           autocomplete="off">

    <button style="border: none; background-color: transparent; cursor: pointer;"
            type="submit">&#x1f50d;</button>

</form>
</div>
            </div>

            <p><small>Writing on programming, education, books and negotiations.
</small></p>

            <div class="flex-container">
                <a class="menu-item" href="/">Home</a>
                <a class="menu-item" href="/about/">About</a>
                <a class="menu-item" href="/bookshelf/">Bookshelf</a>
                <a class="menu-item" href="/feed.xml">RSS</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor" href="/tag/clojure/">Clojure</a>
                <a class="menu-item minor" href="/tag/emacs/">Emacs</a>
                <a class="menu-item minor" href="/tag/python/">Python</a>
                <a class="menu-item minor" href="/tag/programming/">Programming</a>
                <a class="menu-item minor" href="/interview/">Interview</a>
                <a class="menu-item minor" href="/video/">Video</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor hl" href="/clojure-in-prod/">Книга «Clojure на производстве»</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor hl" href="/clojure-in-prod-2/">Книга «Clojure на производстве», второй том</a>
            </div>

        </div>
    </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">

    <h1 class="post-title" itemprop="name headline">Deed: a fast encoding and decoding library for Clojure</h1>

    
<div class="post-meta">

    <time class="post-time"
          datetime="2024-10-07T00:00:00+00:00">
        Oct 7, 2024
    </time>

    <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/clojure/" rel="tag">clojure</a>, <a href="/tag/encoding/" rel="tag">encoding</a>, <a href="/tag/decoding/" rel="tag">decoding</a>

</div>


  </header>

  <div class="post-content" itemprop="articleBody">
    
<h2>

    Table of Content

</h2>

<ul id="toc-item-clj-deed">
  <li><a href="#about" id="toc-item-clj-deed-about">About</a></li>
  <li><a href="#motivation" id="toc-item-clj-deed-motivation">Motivation</a></li>
  <li><a href="#installation--requirements" id="toc-item-clj-deed-installation--requirements">Installation &amp; Requirements</a></li>
  <li><a href="#quick-demo" id="toc-item-clj-deed-quick-demo">Quick Demo</a></li>
  <li><a href="#api" id="toc-item-clj-deed-api">API</a>    <ul>
      <li><a href="#simple-encode-and-decode" id="toc-item-clj-deed-simple-encode-and-decode">Simple Encode and Decode</a></li>
      <li><a href="#encoding-to-memory" id="toc-item-clj-deed-encoding-to-memory">Encoding to Memory</a></li>
      <li><a href="#sequential-encoding-and-decoding" id="toc-item-clj-deed-sequential-encoding-and-decoding">Sequential Encoding and Decoding</a></li>
      <li><a href="#low-level-api" id="toc-item-clj-deed-low-level-api">Low-Level API</a></li>
      <li><a href="#api-options" id="toc-item-clj-deed-api-options">API Options</a></li>
    </ul>
  </li>
  <li><a href="#gzipped-streams" id="toc-item-clj-deed-gzipped-streams">GZipped Streams</a></li>
  <li><a href="#appending-to-a-file" id="toc-item-clj-deed-appending-to-a-file">Appending to a File</a></li>
  <li><a href="#handle-unsupported-types" id="toc-item-clj-deed-handle-unsupported-types">Handle Unsupported Types</a></li>
  <li><a href="#supported-types" id="toc-item-clj-deed-supported-types">Supported Types</a></li>
  <li><a href="#extending-custom-types" id="toc-item-clj-deed-extending-custom-types">Extending Custom Types</a>    <ul>
      <li><a href="#encode" id="toc-item-clj-deed-encode">Encode</a></li>
      <li><a href="#decode" id="toc-item-clj-deed-decode">Decode</a></li>
      <li><a href="#macros" id="toc-item-clj-deed-macros">Macros</a></li>
    </ul>
  </li>
  <li><a href="#handling-defrecords" id="toc-item-clj-deed-handling-defrecords">Handling Defrecords</a></li>
  <li><a href="#contrib" id="toc-item-clj-deed-contrib">Contrib</a>    <ul>
      <li><a href="#base64" id="toc-item-clj-deed-base64">Base64</a></li>
      <li><a href="#vectorz" id="toc-item-clj-deed-vectorz">VectorZ</a></li>
    </ul>
  </li>
  <li><a href="#binary-format" id="toc-item-clj-deed-binary-format">Binary Format</a></li>
  <li><a href="#benchmarks" id="toc-item-clj-deed-benchmarks">Benchmarks</a></li>
</ul>

<h2 id="about">About</h2>

<p><a href="https://github.com/igrishaev/deed">Deed is a library</a> to dump any value into a byte array and read it
back. It supports plenty of types out from the box: Java primitives, most of the
Clojure types, Java collections, date and time, and so on. It supports even such
tricky types as atoms, refs, and input streams. The full list of supported types
is shown in the <a href="#supported-types">“Supported Types”</a> section below.</p>

<p>Deed can be extended with custom types with ease. There is a contrib package
that extends encoding and decoding logic for vectors from the the well-known
<a href="https://github.com/mikera/vectorz">mikera/vectorz</a> library.</p>

<p>Deed is written in pure Java and thus is pretty fast (see the
<a href="#benchmarks">“Benchmarks”</a> section). It’s about 30-50% faster than Nippy.</p>

<p>It doesn’t rely on the built-in Java <code class="language-plaintext highlighter-rouge">Serializable</code> interface for security
reasons. Every type is processed manually.</p>

<p>Deep provides convenient API for reading the frozen data lazily one by one.</p>

<h2 id="motivation">Motivation</h2>

<p>Obviously you would ask why doing this if we already have Nippy? This is what I
had in mind while working on Deed:</p>

<ol>
  <li>
    <p>The library must be <strong>absolutely free</strong> from dependencies. This is true for
the <code class="language-plaintext highlighter-rouge">deed-core</code> package: it’s written in pure Java with no dependencies at
all. By adding it into a project, you won’t blow up you uberjar, nor you will
have troubles with building a native image with GraalVM.</p>
  </li>
  <li>
    <p>Any part of Deed that requires 3rd-party stuff must be a sub-library. So you
have precise control of what you use and what you don’t</p>
  </li>
  <li>
    <p>Unlike Nippy, Deed never falls back to native Java serialization. There is no
such an option. Thus, your application cannot be attacked by someone how has
forged a binary dump.</p>
  </li>
  <li>
    <p>Deed is simple: it blindly works with input- and output byte streams having
no idea what’s behind them. It doesn’t take compression nor encryption into
account – yet there are utilities for streams.</p>
  </li>
  <li>
    <p>The library provides API which personally I consider more convenient than
Nippi’s. Namely, Deed can lazily iterate on a series of encoded data instead
of reading the whole dump at once.</p>
  </li>
  <li>
    <p>Finally, why not using popular and cross-platform formats like JSON, Message
Pack, or YAML? Well, because of poor types support. JSON has only primitive
types and collections, and nothing else. Extending it with custom types is
always a pain. At the same time, I want my decoded data be as close to the
origin data as possible, say, <code class="language-plaintext highlighter-rouge">LocalDateTime</code> be an instance of
<code class="language-plaintext highlighter-rouge">LocalDateTime</code> but not a string or <code class="language-plaintext highlighter-rouge">java.util.Date</code>. Sometimes, preserving
metadata is crucial. To haldle all of these cases, there now a way other than
making your own library.</p>
  </li>
</ol>

<!-- more -->

<h2 id="installation--requirements">Installation &amp; Requirements</h2>

<p>Deed requires Java version at least 16 to run. Tested with Clojure 1.9.0.</p>

<p><strong>The core module</strong> with basic encode and decode capabilities:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">;; lein</span><span class="w">
</span><span class="p">[</span><span class="n">com.github.igrishaev/deed-core</span><span class="w"> </span><span class="s">"0.1.0"</span><span class="p">]</span><span class="w">

</span><span class="c1">;; deps</span><span class="w">
</span><span class="n">com.github.igrishaev/deed-core</span><span class="w"> </span><span class="p">{</span><span class="no">:mvn/version</span><span class="w"> </span><span class="s">"0.1.0"</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p><strong>Base64 module</strong> do encode and decode from/into base64 on the fly:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">;; lein</span><span class="w">
</span><span class="p">[</span><span class="n">com.github.igrishaev/deed-base64</span><span class="w"> </span><span class="s">"0.1.0"</span><span class="p">]</span><span class="w">

</span><span class="c1">;; deps</span><span class="w">
</span><span class="n">com.github.igrishaev/deed-base64</span><span class="w"> </span><span class="p">{</span><span class="no">:mvn/version</span><span class="w"> </span><span class="s">"0.1.0"</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p><strong>Vectorz module</strong> extends Deed with a number of <code class="language-plaintext highlighter-rouge">Vector*</code> classes from the
<a href="https://github.com/mikera/vectorz">mikera/vectorz</a> library:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">;; lein</span><span class="w">
</span><span class="p">[</span><span class="n">com.github.igrishaev/deed-vectorz</span><span class="w"> </span><span class="s">"0.1.0"</span><span class="p">]</span><span class="w">

</span><span class="c1">;; deps</span><span class="w">
</span><span class="n">com.github.igrishaev/deed-vectorz</span><span class="w"> </span><span class="p">{</span><span class="no">:mvn/version</span><span class="w"> </span><span class="s">"0.1.0"</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h2 id="quick-demo">Quick Demo</h2>

<p>This is a very brief example of how to dump the data into a file. Prepare the
namespace with imports:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">ns</span><span class="w"> </span><span class="n">demo</span><span class="w">
  </span><span class="p">(</span><span class="no">:require</span><span class="w">
   </span><span class="p">[</span><span class="n">clojure.java.io</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">io</span><span class="p">]</span><span class="w">
   </span><span class="p">[</span><span class="n">deed.core</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">deed</span><span class="p">]))</span><span class="w">
</span></code></pre></div></div>

<p>Declare the file and the data:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">file</span><span class="w">
  </span><span class="p">(</span><span class="nf">io/file</span><span class="w"> </span><span class="s">"dump.deed"</span><span class="p">))</span><span class="w">

</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">data</span><span class="w">
  </span><span class="p">{</span><span class="no">:number</span><span class="w"> </span><span class="mi">1</span><span class="w">
   </span><span class="no">:string</span><span class="w"> </span><span class="s">"hello"</span><span class="w">
   </span><span class="no">:bool</span><span class="w"> </span><span class="n">true</span><span class="w">
   </span><span class="no">:nil</span><span class="w"> </span><span class="n">nil</span><span class="w">
   </span><span class="no">:symbol</span><span class="w"> </span><span class="ss">'hello/test</span><span class="w">
   </span><span class="no">:simple-kw</span><span class="w"> </span><span class="no">:test</span><span class="w">
   </span><span class="no">:complex-kw</span><span class="w"> </span><span class="no">:foo/bar</span><span class="w">
   </span><span class="no">:vector</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="no">:test</span><span class="w"> </span><span class="n">nil</span><span class="w"> </span><span class="mi">42</span><span class="w"> </span><span class="s">"hello"</span><span class="p">]</span><span class="w">
   </span><span class="no">:map</span><span class="w"> </span><span class="p">{</span><span class="no">:test</span><span class="w"> </span><span class="p">{</span><span class="no">:bar</span><span class="w"> </span><span class="p">{</span><span class="ss">'dunno</span><span class="w"> </span><span class="p">{</span><span class="s">"lol"</span><span class="w"> </span><span class="p">[</span><span class="no">:kek</span><span class="p">]}}}}</span><span class="w">
   </span><span class="no">:set</span><span class="w"> </span><span class="o">#</span><span class="p">{</span><span class="no">:a</span><span class="w"> </span><span class="no">:b</span><span class="w"> </span><span class="no">:c</span><span class="p">}</span><span class="w">
   </span><span class="no">:atom</span><span class="w"> </span><span class="p">(</span><span class="nf">atom</span><span class="w"> </span><span class="p">{</span><span class="no">:abc</span><span class="w"> </span><span class="mi">42</span><span class="p">})})</span><span class="w">
</span></code></pre></div></div>

<p>Pass them into the <code class="language-plaintext highlighter-rouge">encode-to</code> function as follows:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">deed/encode-to</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">file</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>And this is it! If you examine the file with any kind of a hex editor, you’ll
see a binary payload:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>xxd /path/to/dump.deed

00000000: 0001 0001 0000 0000 0000 0000 0000 0000  ................
00000010: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000020: 0000 003b 0000 000b 004a 0000 0006 6e75  ...;.....J....nu
00000030: 6d62 6572 000e 004a 0000 0006 7379 6d62  mber...J....symb
00000040: 6f6c 004b 0000 000a 6865 6c6c 6f2f 7465  ol.K....hello/te
00000050: 7374 004a 0000 000a 636f 6d70 6c65 782d  st.J....complex-
00000060: 6b77 004a 0000 0007 666f 6f2f 6261 7200  kw.J....foo/bar.
00000070: 4a00 0000 0673 7472 696e 6700 2b00 0000  J....string.+...
00000080: 0568 656c 6c6f 004a 0000 0006 7665 6374  .hello.J....vect
00000090: 6f72 002e 0000 0006 000e 000c 0000 0000  or..............
000000a0: 0000 0002 004a 0000 0004 7465 7374 0000  .....J....test..
000000b0: 000c 0000 0000 0000 002a 002b 0000 0005  .........*.+....
000000c0: 6865 6c6c 6f00 4a00 0000 036e 696c 0000  hello.J....nil..
000000d0: 004a 0000 0004 626f 6f6c 0029 004a 0000  .J....bool.).J..
000000e0: 0003 7365 7400 3300 0000 0300 4a00 0000  ..set.3.....J...
000000f0: 0163 004a 0000 0001 6200 4a00 0000 0161  .c.J....b.J....a
00000100: 004a 0000 0009 7369 6d70 6c65 2d6b 7700  .J....simple-kw.
00000110: 4a00 0000 0474 6573 7400 4a00 0000 0461  J....test.J....a
00000120: 746f 6d00 3000 3b00 0000 0100 4a00 0000  tom.0.;.....J...
00000130: 0361 6263 000c 0000 0000 0000 002a 004a  .abc.........*.J
00000140: 0000 0003 6d61 7000 3b00 0000 0100 4a00  ....map.;.....J.
00000150: 0000 0474 6573 7400 3b00 0000 0100 4a00  ...test.;.....J.
00000160: 0000 0362 6172 003b 0000 0001 004b 0000  ...bar.;.....K..
00000170: 0005 6475 6e6e 6f00 3b00 0000 0100 2b00  ..dunno.;.....+.
00000180: 0000 036c 6f6c 002e 0000 0001 004a 0000  ...lol.......J..
00000190: 0003 6b65 6b                             ..kek
</code></pre></div></div>

<p>Now that you have a .deed file, read it back using the <code class="language-plaintext highlighter-rouge">decode-from</code> function:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">data-back</span><span class="w">
  </span><span class="p">(</span><span class="nf">deed/decode-from</span><span class="w"> </span><span class="n">file</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<p>Print the <code class="language-plaintext highlighter-rouge">data-back</code> to ensure it keeps the origin types:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="no">:number</span><span class="w"> </span><span class="mi">1</span><span class="n">,</span><span class="w">
 </span><span class="no">:symbol</span><span class="w"> </span><span class="n">hello/test,</span><span class="w">
 </span><span class="no">:complex-kw</span><span class="w"> </span><span class="no">:foo/bar,</span><span class="w">
 </span><span class="no">:string</span><span class="w"> </span><span class="s">"hello"</span><span class="n">,</span><span class="w">
 </span><span class="no">:vector</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="no">:test</span><span class="w"> </span><span class="n">nil</span><span class="w"> </span><span class="mi">42</span><span class="w"> </span><span class="s">"hello"</span><span class="p">]</span><span class="n">,</span><span class="w">
 </span><span class="no">:nil</span><span class="w"> </span><span class="n">nil,</span><span class="w">
 </span><span class="no">:bool</span><span class="w"> </span><span class="n">true,</span><span class="w">
 </span><span class="no">:set</span><span class="w"> </span><span class="o">#</span><span class="p">{</span><span class="no">:c</span><span class="w"> </span><span class="no">:b</span><span class="w"> </span><span class="no">:a</span><span class="p">}</span><span class="n">,</span><span class="w">
 </span><span class="no">:simple-kw</span><span class="w"> </span><span class="no">:test,</span><span class="w">
 </span><span class="no">:atom</span><span class="w"> </span><span class="o">#</span><span class="n">&lt;Atom</span><span class="o">@</span><span class="mi">75</span><span class="n">f6dd87</span><span class="err">:</span><span class="w"> </span><span class="p">{</span><span class="no">:abc</span><span class="w"> </span><span class="mi">42</span><span class="p">}</span><span class="n">&gt;,</span><span class="w">
 </span><span class="no">:map</span><span class="w"> </span><span class="p">{</span><span class="no">:test</span><span class="w"> </span><span class="p">{</span><span class="no">:bar</span><span class="w"> </span><span class="p">{</span><span class="n">dunno</span><span class="w"> </span><span class="p">{</span><span class="s">"lol"</span><span class="w"> </span><span class="p">[</span><span class="no">:kek</span><span class="p">]}}}}}</span><span class="w">
</span></code></pre></div></div>

<p>Compare them to ensure we didn’t loose anything. Since atoms cannot be compared,
we <code class="language-plaintext highlighter-rouge">dissoc</code> them from both sides:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">dissoc</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="no">:atom</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">dissoc</span><span class="w"> </span><span class="n">data-back</span><span class="w"> </span><span class="no">:atom</span><span class="p">))</span><span class="w">
</span><span class="c1">;; true</span><span class="w">
</span></code></pre></div></div>

<p>Deed supports plenty of built-in Clojure and Java types. The next section
describes which API it provides to manage the data.</p>

<h2 id="api">API</h2>

<h3 id="simple-encode-and-decode">Simple Encode and Decode</h3>

<p>The <code class="language-plaintext highlighter-rouge">encode-to</code> function accepts two parameters: a value and an output. The
value is an instance of any <a href="#supported-types">supported type</a> (a map, a vector,
etc).</p>

<p>The output is anything that can be coerced to the output stream using the
<code class="language-plaintext highlighter-rouge">io/output-stream</code> function. It could be a file, another output stream, a byte
array, or similar. If you pass a string, it’s treated a file name which will be
created.</p>

<p>Examples:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">deed/encode-to</span><span class="w"> </span><span class="p">{</span><span class="no">:foo</span><span class="w"> </span><span class="mi">123</span><span class="p">}</span><span class="w"> </span><span class="s">"test.deed"</span><span class="p">)</span><span class="w">

</span><span class="p">(</span><span class="nf">deed/encode-to</span><span class="w"> </span><span class="p">{</span><span class="no">:foo</span><span class="w"> </span><span class="mi">123</span><span class="p">}</span><span class="w"> </span><span class="p">(</span><span class="nf">io/file</span><span class="w"> </span><span class="s">"test2.deed"</span><span class="p">))</span><span class="w">

</span><span class="p">(</span><span class="nf">deed/encode-to</span><span class="w"> </span><span class="p">{</span><span class="no">:foo</span><span class="w"> </span><span class="mi">123</span><span class="p">}</span><span class="w"> </span><span class="p">(</span><span class="nb">-&gt;</span><span class="w"> </span><span class="s">"test3.deed"</span><span class="w">
                               </span><span class="n">io/file</span><span class="w">
                               </span><span class="n">io/output-stream</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<p>All the three invocations above dump the same map <code class="language-plaintext highlighter-rouge">{:foo 123}</code> into different
files.</p>

<p>To read the data back, invoke the <code class="language-plaintext highlighter-rouge">decode-from</code> function. It accepts anything
that can be coerced into an input stream using the <code class="language-plaintext highlighter-rouge">io/input-stream</code>
function. It might be a file, another stream, a byte array, or a name of a file.</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">deed/decode-from</span><span class="w"> </span><span class="s">"test.deed"</span><span class="p">)</span><span class="w">
</span><span class="c1">;; {:foo 123}</span><span class="w">

</span><span class="p">(</span><span class="nf">deed/decode-from</span><span class="w"> </span><span class="p">(</span><span class="nf">io/file</span><span class="w"> </span><span class="s">"test2.deed"</span><span class="p">))</span><span class="w">
</span><span class="c1">;; {:foo 123}</span><span class="w">

</span><span class="p">(</span><span class="nf">deed/decode-from</span><span class="w"> </span><span class="p">(</span><span class="nb">-&gt;</span><span class="w"> </span><span class="s">"test3.deed"</span><span class="w">
                      </span><span class="n">io/file</span><span class="w">
                      </span><span class="n">io/input-stream</span><span class="p">))</span><span class="w">
</span><span class="c1">;; {:foo 123}</span><span class="w">
</span></code></pre></div></div>

<h3 id="encoding-to-memory">Encoding to Memory</h3>

<p>The functions below rely on external IO resources. If you want to dump the data
into memory, use the <code class="language-plaintext highlighter-rouge">encode-to-bytes</code> function. It returns a byte array without
any IO interaction:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">buf</span><span class="w">
  </span><span class="p">(</span><span class="nf">deed/encode-to-bytes</span><span class="w"> </span><span class="p">{</span><span class="no">:test</span><span class="w"> </span><span class="mi">123</span><span class="p">}))</span><span class="w">

</span><span class="p">(</span><span class="nb">println</span><span class="w"> </span><span class="p">(</span><span class="nf">vec</span><span class="w"> </span><span class="n">buf</span><span class="p">))</span><span class="w">

</span><span class="p">[</span><span class="mi">0</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">...</span><span class="w"> </span><span class="mi">59</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">74</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="mi">116</span><span class="w"> </span><span class="mi">101</span><span class="w"> </span><span class="mi">115</span><span class="w"> </span><span class="mi">116</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">123</span><span class="p">]</span><span class="w">
</span></code></pre></div></div>

<p>There is no an opposite <code class="language-plaintext highlighter-rouge">decode-from-bytes</code> function because a byte array is
already a data source for the <code class="language-plaintext highlighter-rouge">decode-from</code> function. Just pass the result into
it:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">deed/decode-from</span><span class="w"> </span><span class="n">buf</span><span class="p">)</span><span class="w">
</span><span class="c1">;; {:test 123}</span><span class="w">
</span></code></pre></div></div>

<h3 id="sequential-encoding-and-decoding">Sequential Encoding and Decoding</h3>

<p>We often dump vast collections to explore them afterwards. Say, you’re going to
write 10M of database rows into a file to find a broken row with a script.</p>

<p>The functions above encode and decode a single value. That’s OK for primitive
types and maps but not good for vast collections. For example, if you encode a
vector of 10M items into a file and read it back, you’ll get the same vector of
10M items back. Most likely you don’t need all of these at once: you’d better to
iterate on them one by one.</p>

<p>This is the case that <code class="language-plaintext highlighter-rouge">encode-seq-to</code> and <code class="language-plaintext highlighter-rouge">decode-seq-from</code> functions cover. The
first function accepts a collection of items and writes them sequentially. It’s
not a vector any longer but a series of items written one after another. The
<code class="language-plaintext highlighter-rouge">encode-seq-to</code> invocation returns the number of items written:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">deed/encode-seq-to</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="s">"test.deed"</span><span class="p">)</span><span class="w">
</span><span class="c1">;; 3</span><span class="w">
</span></code></pre></div></div>

<p>Instead of a vector, there might be a lazy sequence, or anything that can be
iterated.</p>

<p>If you read the dump using <code class="language-plaintext highlighter-rouge">decode-from</code>, you’ll get the first item only:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">deed/decode-from</span><span class="w"> </span><span class="s">"test.deed"</span><span class="p">)</span><span class="w">
</span><span class="mi">1</span><span class="w">
</span></code></pre></div></div>

<p>To read all of them, use <code class="language-plaintext highlighter-rouge">decode-seq-from</code>:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">deed/decode-seq-from</span><span class="w"> </span><span class="s">"test.deed"</span><span class="p">)</span><span class="w">
</span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="p">]</span><span class="w">
</span></code></pre></div></div>

<p>What is the point to use sequential encoding? Because with a special API, you
can read them lazily one by one.</p>

<p>The <code class="language-plaintext highlighter-rouge">with-decoder</code> macro takes two parameters: the binding symbol and the
input. Internally, it creates a <code class="language-plaintext highlighter-rouge">Decoder</code> instance and binds it to the first
symbol. The <code class="language-plaintext highlighter-rouge">decode-seq</code> function returns a lazy sequence of items from a
decoder:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">deed/with-decoder</span><span class="w"> </span><span class="p">[</span><span class="n">d</span><span class="w"> </span><span class="s">"test.deed"</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nb">doseq</span><span class="w"> </span><span class="p">[</span><span class="n">item</span><span class="w"> </span><span class="p">(</span><span class="nf">deed/decode-seq</span><span class="w"> </span><span class="n">d</span><span class="p">)]</span><span class="w">
    </span><span class="p">(</span><span class="nb">println</span><span class="w"> </span><span class="n">item</span><span class="p">)))</span><span class="w">
</span><span class="c1">;; 1</span><span class="w">
</span><span class="c1">;; 2</span><span class="w">
</span><span class="c1">;; 3</span><span class="w">
</span></code></pre></div></div>

<p>You must process items before you exit the <code class="language-plaintext highlighter-rouge">with-decoder</code> macro.</p>

<p>The form above might be rewritten using the <code class="language-plaintext highlighter-rouge">with-open</code> macro. Since the
<code class="language-plaintext highlighter-rouge">Decoder</code> object implements <code class="language-plaintext highlighter-rouge">AutoCloseable</code> interface, it handles the <code class="language-plaintext highlighter-rouge">.close</code>
method which in turn closes the underlying stream.</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nb">with-open</span><span class="w"> </span><span class="p">[</span><span class="n">d</span><span class="w"> </span><span class="p">(</span><span class="nf">deed/decoder</span><span class="w"> </span><span class="s">"test.deed"</span><span class="p">)]</span><span class="w">
  </span><span class="p">(</span><span class="nb">doseq</span><span class="w"> </span><span class="p">[</span><span class="n">item</span><span class="w"> </span><span class="p">(</span><span class="nf">deed/decode-seq</span><span class="w"> </span><span class="n">d</span><span class="p">)]</span><span class="w">
    </span><span class="p">(</span><span class="nb">println</span><span class="w"> </span><span class="n">item</span><span class="p">)))</span><span class="w">
</span></code></pre></div></div>

<p>In fact, you don’t even need to pass the decoder object into <code class="language-plaintext highlighter-rouge">decode-seq</code>
because it implements the <code class="language-plaintext highlighter-rouge">Iterable</code> Java interface. Just iterate the decoder:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">deed/with-decoder</span><span class="w"> </span><span class="p">[</span><span class="n">d</span><span class="w"> </span><span class="s">"test.deed"</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nf">mapv</span><span class="w"> </span><span class="nb">inc</span><span class="w"> </span><span class="n">d</span><span class="p">))</span><span class="w">
</span><span class="c1">;; [2 3 3]</span><span class="w">

</span><span class="p">(</span><span class="nf">deed/with-decoder</span><span class="w"> </span><span class="p">[</span><span class="n">d</span><span class="w"> </span><span class="s">"test.deed"</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nb">doseq</span><span class="w"> </span><span class="p">[</span><span class="n">item</span><span class="w"> </span><span class="n">d</span><span class="p">]</span><span class="w">
    </span><span class="p">(</span><span class="nb">println</span><span class="w"> </span><span class="s">"item is"</span><span class="w"> </span><span class="n">item</span><span class="p">)))</span><span class="w">
</span><span class="c1">;; item is 1</span><span class="w">
</span><span class="c1">;; item is 2</span><span class="w">
</span><span class="c1">;; item is 3</span><span class="w">
</span></code></pre></div></div>

<p>The items are read lazily so you won’t saturate memory.</p>

<h3 id="low-level-api">Low-Level API</h3>

<p>Deed provides low-level API for conditional or imperative encoding. The <code class="language-plaintext highlighter-rouge">encode</code>
function writes a value into an instance of the <code class="language-plaintext highlighter-rouge">Encoder</code> class. You can use it
in a cycle with some condition:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">deed/with-encoder</span><span class="w"> </span><span class="p">[</span><span class="n">e</span><span class="w"> </span><span class="s">"test.deed"</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nb">doseq</span><span class="w"> </span><span class="p">[</span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="nb">range</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">32</span><span class="p">)]</span><span class="w">
    </span><span class="p">(</span><span class="nb">when</span><span class="w"> </span><span class="p">(</span><span class="nf">even?</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w">
      </span><span class="p">(</span><span class="nf">deed/encode</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="n">x</span><span class="p">))))</span><span class="w">
</span></code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">decode</code> function reads an object from the <code class="language-plaintext highlighter-rouge">Decoder</code> instance. When the end
of the stream is met, you’ll get a special <code class="language-plaintext highlighter-rouge">EOF</code> object that you can check using
the <code class="language-plaintext highlighter-rouge">eof?</code> preficate:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">deed/with-decoder</span><span class="w"> </span><span class="p">[</span><span class="n">d</span><span class="w"> </span><span class="s">"test.deed"</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nb">loop</span><span class="w"> </span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="mi">0</span><span class="p">]</span><span class="w">
    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">item</span><span class="w"> </span><span class="p">(</span><span class="nf">deed/decode</span><span class="w"> </span><span class="n">d</span><span class="p">)]</span><span class="w">
      </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nf">deed/eof?</span><span class="w"> </span><span class="n">item</span><span class="p">)</span><span class="w">
        </span><span class="p">(</span><span class="nb">println</span><span class="w"> </span><span class="s">"EOF"</span><span class="p">)</span><span class="w">
        </span><span class="p">(</span><span class="nf">do</span><span class="w">
          </span><span class="p">(</span><span class="nb">println</span><span class="w"> </span><span class="s">"item"</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="n">item</span><span class="p">)</span><span class="w">
          </span><span class="p">(</span><span class="nf">recur</span><span class="w"> </span><span class="p">(</span><span class="nb">inc</span><span class="w"> </span><span class="n">i</span><span class="p">)))))))</span><span class="w">

</span><span class="c1">;; item 0 2</span><span class="w">
</span><span class="c1">;; item 1 4</span><span class="w">
</span><span class="c1">;; item 2 6</span><span class="w">
</span><span class="c1">;; item 3 8</span><span class="w">
</span><span class="c1">;; item 4 10</span><span class="w">
</span><span class="c1">;; item 5 12</span><span class="w">
</span><span class="c1">;; item 6 14</span><span class="w">
</span><span class="c1">;; item 7 16</span><span class="w">
</span><span class="c1">;; item 8 18</span><span class="w">
</span><span class="c1">;; item 9 20</span><span class="w">
</span><span class="c1">;; item 10 22</span><span class="w">
</span><span class="c1">;; item 11 24</span><span class="w">
</span><span class="c1">;; item 12 26</span><span class="w">
</span><span class="c1">;; item 13 28</span><span class="w">
</span><span class="c1">;; item 14 30</span><span class="w">
</span><span class="c1">;; EOF</span><span class="w">
</span></code></pre></div></div>

<p>The low-level might be useful when you need precise control on encoding and
decoding.</p>

<h3 id="api-options">API Options</h3>

<p>Most of the functions accept an optional map of parameters. Here is a list of
options supported at the moment:</p>

<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Default</th>
      <th>Meaning</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:deref-timeout-ms</code></td>
      <td>5000</td>
      <td>The number of milliseconds to wait when derefing futures.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:object-chunk-size</code></td>
      <td>0xFF</td>
      <td>The number of object chunk when encoding uncountable collections (e.g. lazy seqs).</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:byte-chunk-size</code></td>
      <td>0xFFFF</td>
      <td>The number of byte chunk when encoding input streams.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:uncountable-max-items</code></td>
      <td>Integer.MAX_VALUE</td>
      <td>The max number of items to process when encoding uncountable collections (e.g. lazy seqs).</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:encode-unsupported?</code></td>
      <td>true</td>
      <td>If true, dump every unsupported object into a string (<a href="#handle-unsupported-types">see below</a>). Otherwise, throw an error.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:io-temp-file?</code></td>
      <td>false</td>
      <td>When deciding previously encoded input stream, write its payload into a temp file.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:save-meta?</code></td>
      <td>true</td>
      <td>Preserve metadata for objects what have it.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:append?</code></td>
      <td>false</td>
      <td>Write at the end of an existing dump (<a href="#appending-to-a-file">see below</a>).</td>
    </tr>
  </tbody>
</table>

<p>That’s unlikely you’ll need to change any of these, yet in rare cases they might
help.</p>

<h2 id="gzipped-streams">GZipped Streams</h2>

<p>Deed has a couple of functions that turn any input or output into
<code class="language-plaintext highlighter-rouge">GZIPInputStream</code> and <code class="language-plaintext highlighter-rouge">GZIPOutputStream</code> instances respectfully. It allows to
compress the data on the fly. Here is how you compress:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nb">with-open</span><span class="w"> </span><span class="p">[</span><span class="n">out</span><span class="w"> </span><span class="p">(</span><span class="nf">deed/gzip-output-stream</span><span class="w"> </span><span class="s">"dump.deed.gz"</span><span class="p">)]</span><span class="w">
  </span><span class="p">(</span><span class="nf">deed/encode-to</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="n">out</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<p>And decompress:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nb">with-open</span><span class="w"> </span><span class="p">[</span><span class="n">in</span><span class="w"> </span><span class="p">(</span><span class="nf">deed/gzip-input-stream</span><span class="w"> </span><span class="s">"dump.deed.gz"</span><span class="p">)]</span><span class="w">
  </span><span class="p">(</span><span class="nf">deed/decode-from</span><span class="w"> </span><span class="n">in</span><span class="p">))</span><span class="w">
</span><span class="c1">;; [1 2 3]</span><span class="w">
</span></code></pre></div></div>

<p>Keep in mind that compression saves disk space but consumes CPU usage.</p>

<h2 id="appending-to-a-file">Appending to a File</h2>

<p>In rare cases, you’d like to append data to an existing file. This might be done
in two steps. First, you initiate the <code class="language-plaintext highlighter-rouge">FileOutputStream</code> object manually and
pass the <code class="language-plaintext highlighter-rouge">true</code> boolean flag meaning put the content at the end of a file, not
the beginning:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nb">with-open</span><span class="w"> </span><span class="p">[</span><span class="n">out</span><span class="w"> </span><span class="p">(</span><span class="nb">new</span><span class="w"> </span><span class="n">FileOutputStream</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="n">true</span><span class="p">)]</span><span class="w">
  </span><span class="n">...</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>Second, when encoding the data into such an output, specify the <code class="language-plaintext highlighter-rouge">{:append?
true}</code> option. In this case, Deed won’t emit a leading <code class="language-plaintext highlighter-rouge">deed.Header</code> object:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nb">with-open</span><span class="w"> </span><span class="p">[</span><span class="n">out</span><span class="w"> </span><span class="p">(</span><span class="nb">new</span><span class="w"> </span><span class="n">FileOutputStream</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="n">true</span><span class="p">)]</span><span class="w">
  </span><span class="p">(</span><span class="nf">deed/encode-to</span><span class="w"> </span><span class="p">{</span><span class="no">:hello</span><span class="w"> </span><span class="mi">123</span><span class="p">}</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="p">{</span><span class="no">:append?</span><span class="w"> </span><span class="n">true</span><span class="p">}))</span><span class="w">
</span></code></pre></div></div>

<h2 id="handle-unsupported-types">Handle Unsupported Types</h2>

<p>By default, when Deed doesn’t know how to encode an object, it turns it into a
string using the standard <code class="language-plaintext highlighter-rouge">.toString</code> method. Than it makes a special
<code class="language-plaintext highlighter-rouge">Unsupported</code> object that tracks full class name and the text payload. Let’s
present it with a custom <code class="language-plaintext highlighter-rouge">deftype</code> declaration:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">deftype</span><span class="w"> </span><span class="n">MyType</span><span class="w"> </span><span class="p">[</span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="n">c</span><span class="p">])</span><span class="w">

</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">mt</span><span class="w"> </span><span class="p">(</span><span class="nb">new</span><span class="w"> </span><span class="n">MyType</span><span class="w"> </span><span class="no">:hello</span><span class="w"> </span><span class="s">"test"</span><span class="w"> </span><span class="mi">42</span><span class="p">))</span><span class="w">

</span><span class="p">(</span><span class="nf">deed/encode-to</span><span class="w"> </span><span class="n">mt</span><span class="w"> </span><span class="s">"test.deed"</span><span class="p">)</span><span class="w">

</span><span class="p">(</span><span class="nf">deed/decode-from</span><span class="w"> </span><span class="s">"test.deed"</span><span class="p">)</span><span class="w">
</span><span class="c1">;; #&lt;Unsupported@b918edf: {:content "demo.MyType@4376ae5c", :class "demo.MyType"}&gt;</span><span class="w">
</span></code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">Unsupported</code> object can be checked with the <code class="language-plaintext highlighter-rouge">unsupported?</code> predicate:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">mt-back</span><span class="w">
  </span><span class="p">(</span><span class="nf">deed/decode-from</span><span class="w"> </span><span class="s">"test.deed"</span><span class="p">))</span><span class="w">

</span><span class="p">(</span><span class="nf">deed/unsupported?</span><span class="w"> </span><span class="n">mt-back</span><span class="p">)</span><span class="w">
</span><span class="c1">;; true</span><span class="w">
</span></code></pre></div></div>

<p>To coerce it to Clojure, just <code class="language-plaintext highlighter-rouge">deref</code> it:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">mt-back</span><span class="w">
</span><span class="p">{</span><span class="no">:content</span><span class="w"> </span><span class="s">"demo.MyType@4376ae5c"</span><span class="n">,</span><span class="w"> </span><span class="no">:class</span><span class="w"> </span><span class="s">"demo.MyType"</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Above, the <code class="language-plaintext highlighter-rouge">"demo.MyType@4376ae5c"</code> string doesn’t say much. This is because the
default <code class="language-plaintext highlighter-rouge">.toString</code> implementation of <code class="language-plaintext highlighter-rouge">deftype</code> lacks fields. That’s why it’s
always worth overriding the <code class="language-plaintext highlighter-rouge">.toString</code> method for custom types:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">deftype</span><span class="w"> </span><span class="n">MyType</span><span class="w"> </span><span class="p">[</span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="n">c</span><span class="p">]</span><span class="w">
  </span><span class="n">Object</span><span class="w">
  </span><span class="p">(</span><span class="nf">toString</span><span class="w"> </span><span class="p">[</span><span class="n">_</span><span class="p">]</span><span class="w">
    </span><span class="p">(</span><span class="nf">format</span><span class="w"> </span><span class="s">"&lt;MyType: %s, %s, %s&gt;"</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="n">c</span><span class="p">)))</span><span class="w">

</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">mt</span><span class="w"> </span><span class="p">(</span><span class="nb">new</span><span class="w"> </span><span class="n">MyType</span><span class="w"> </span><span class="no">:hello</span><span class="w"> </span><span class="s">"test"</span><span class="w"> </span><span class="mi">42</span><span class="p">))</span><span class="w">

</span><span class="p">(</span><span class="nf">deed/encode-to</span><span class="w"> </span><span class="n">mt</span><span class="w"> </span><span class="s">"test.deed"</span><span class="p">)</span><span class="w">

</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">mt-back</span><span class="w">
  </span><span class="p">(</span><span class="nf">deed/decode-from</span><span class="w"> </span><span class="s">"test.deed"</span><span class="p">))</span><span class="w">

</span><span class="p">(</span><span class="nb">str</span><span class="w"> </span><span class="n">mt-back</span><span class="p">)</span><span class="w">
</span><span class="c1">;; "Unsupported[className=demo.MyType, content=&lt;MyType: :hello, test, 42&gt;]"</span><span class="w">

</span><span class="o">@</span><span class="n">mt-back</span><span class="w">
</span><span class="c1">;; {:content "&lt;MyType: :hello, test, 42&gt;", :class "demo.MyType"}</span><span class="w">
</span></code></pre></div></div>

<p>Now the content has fields, so at least you can observe them.</p>

<p>When the <code class="language-plaintext highlighter-rouge">:encode-unsupported?</code> boolean option is false, Deed throws an
exception by facing an unsupported object:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">deed/encode-to</span><span class="w"> </span><span class="n">mt</span><span class="w"> </span><span class="s">"test.deed"</span><span class="w"> </span><span class="p">{</span><span class="no">:encode-unsupported?</span><span class="w"> </span><span class="n">false</span><span class="p">})</span><span class="w">

</span><span class="c1">;; Execution error at deed.Err/error (Err.java:14).</span><span class="w">
</span><span class="c1">;; Cannot encode object, type: demo.MyType, object: &lt;MyType: :hello, test, 42&gt;</span><span class="w">
</span></code></pre></div></div>

<h2 id="supported-types">Supported Types</h2>

<p>The table below renders types supported by Deed out from the box:</p>

<table>
  <thead>
    <tr>
      <th>OID</th>
      <th>TAG</th>
      <th>Class</th>
      <th>Comment</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0x0000</td>
      <td>NULL</td>
      <td><code class="language-plaintext highlighter-rouge">null</code> (<code class="language-plaintext highlighter-rouge">nil</code>)</td>
      <td> </td>
    </tr>
    <tr>
      <td>0x0001</td>
      <td>HEADER</td>
      <td><code class="language-plaintext highlighter-rouge">deed.Header</code></td>
      <td>A leading object with general info about encoding</td>
    </tr>
    <tr>
      <td>0x0002</td>
      <td>UNSUPPORTED</td>
      <td><code class="language-plaintext highlighter-rouge">deed.Unsupported</code></td>
      <td>A wrapper for unsupported objects</td>
    </tr>
    <tr>
      <td>0x0003</td>
      <td>META</td>
      <td> </td>
      <td>Specifies an object with metadata</td>
    </tr>
    <tr>
      <td>0x0004</td>
      <td>INT</td>
      <td><code class="language-plaintext highlighter-rouge">int</code>, <code class="language-plaintext highlighter-rouge">java.lang.Integer</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>0x0005</td>
      <td>INT_ZERO</td>
      <td> </td>
      <td>A special OID for 0 int</td>
    </tr>
    <tr>
      <td>0x0006</td>
      <td>INT_ONE</td>
      <td> </td>
      <td>A special OID for 1 int</td>
    </tr>
    <tr>
      <td>0x0007</td>
      <td>INT_MINUS_ONE</td>
      <td> </td>
      <td>A special OID for -1 int</td>
    </tr>
    <tr>
      <td>0x0008</td>
      <td>SHORT</td>
      <td><code class="language-plaintext highlighter-rouge">short</code>, <code class="language-plaintext highlighter-rouge">java.lang.Short</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>0x0009</td>
      <td>SHORT_ZERO</td>
      <td> </td>
      <td>A special OID for 0 short</td>
    </tr>
    <tr>
      <td>0x000A</td>
      <td>SHORT_ONE</td>
      <td> </td>
      <td>A special OID for 1 short</td>
    </tr>
    <tr>
      <td>0x000B</td>
      <td>SHORT_MINUS_ONE</td>
      <td> </td>
      <td>A special OID for -1 short</td>
    </tr>
    <tr>
      <td>0x000C</td>
      <td>LONG</td>
      <td><code class="language-plaintext highlighter-rouge">long</code>, <code class="language-plaintext highlighter-rouge">java.lang.Long</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>0x000D</td>
      <td>LONG_ZERO</td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td>0x000E</td>
      <td>LONG_ONE</td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td>0x000F</td>
      <td>LONG_MINUS_ONE</td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td>0x0010</td>
      <td>IO_INPUT_STREAM</td>
      <td><code class="language-plaintext highlighter-rouge">java.io.InputStream</code></td>
      <td>When decoding, the bytes are put into a <code class="language-plaintext highlighter-rouge">ByteArrayInputStream</code>. It’s also possible to put them into a temp file and obtain a <code class="language-plaintext highlighter-rouge">FileInputStream</code></td>
    </tr>
    <tr>
      <td>0x0011</td>
      <td>IO_READER</td>
      <td>-</td>
      <td>Not implemented</td>
    </tr>
    <tr>
      <td>0x0012</td>
      <td>IO_FILE</td>
      <td>-</td>
      <td>Not implemented</td>
    </tr>
    <tr>
      <td>0x0013</td>
      <td>IO_BYTEBUFFER</td>
      <td><code class="language-plaintext highlighter-rouge">java.nio.ByteBuffer</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>0x0014</td>
      <td>ARR_BYTE</td>
      <td><code class="language-plaintext highlighter-rouge">byte[]</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>0x0015</td>
      <td>ARR_INT</td>
      <td><code class="language-plaintext highlighter-rouge">int[]</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>0x0016</td>
      <td>ARR_SHORT</td>
      <td><code class="language-plaintext highlighter-rouge">short[]</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>0x0017</td>
      <td>ARR_BOOL</td>
      <td><code class="language-plaintext highlighter-rouge">boolean[]</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>0x0018</td>
      <td>ARR_FLOAT</td>
      <td><code class="language-plaintext highlighter-rouge">float[]</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>0x0019</td>
      <td>ARR_DOUBLE</td>
      <td><code class="language-plaintext highlighter-rouge">double[]</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>0x001A</td>
      <td>ARR_OBJ</td>
      <td><code class="language-plaintext highlighter-rouge">Object[]</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>0x001B</td>
      <td>ARR_LONG</td>
      <td><code class="language-plaintext highlighter-rouge">long[]</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>0x001C</td>
      <td>ARR_CHAR</td>
      <td><code class="language-plaintext highlighter-rouge">char[]</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>0x001D</td>
      <td>REGEX</td>
      <td><code class="language-plaintext highlighter-rouge">java.util.regex.Pattern</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>0x001E</td>
      <td>CLJ_SORTED_SET</td>
      <td><code class="language-plaintext highlighter-rouge">clojure.lang.PersistentTreeSet</code></td>
      <td>A sorted set usually created with <code class="language-plaintext highlighter-rouge">(sorted-set ...)</code></td>
    </tr>
    <tr>
      <td>0x001F</td>
      <td>CLJ_SORTED_SET_EMPTY</td>
      <td> </td>
      <td>A special OID for an empty sorted set</td>
    </tr>
    <tr>
      <td>0x0020</td>
      <td>CLJ_SORTED_MAP</td>
      <td><code class="language-plaintext highlighter-rouge">clojure.lang.PersistentTreeMap</code></td>
      <td>A sorted map usually created with <code class="language-plaintext highlighter-rouge">(sorted-map ...)</code></td>
    </tr>
    <tr>
      <td>0x0021</td>
      <td>CLJ_SORTED_MAP_EMPTY</td>
      <td> </td>
      <td>An empty sorted map</td>
    </tr>
    <tr>
      <td>0x0022</td>
      <td>URI</td>
      <td><code class="language-plaintext highlighter-rouge">java.net.URI</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>0x0023</td>
      <td>URL</td>
      <td><code class="language-plaintext highlighter-rouge">java.net.URL</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>0x0024</td>
      <td>EXCEPTION</td>
      <td><code class="language-plaintext highlighter-rouge">java.lang.Exception</code></td>
      <td>Keeps message, class name, stack trace, cause (recursively encoded), and all the suppressed exceptions</td>
    </tr>
    <tr>
      <td>0x0025</td>
      <td>IO_EXCEPTION</td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td>0x0026</td>
      <td>THROWABLE</td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td>0x0027</td>
      <td>EX_INFO</td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td>0x0028</td>
      <td>EX_NPE</td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td>0x0029</td>
      <td>BOOL_TRUE</td>
      <td><code class="language-plaintext highlighter-rouge">boolean</code>, <code class="language-plaintext highlighter-rouge">java.lang.Boolean</code></td>
      <td>True value only</td>
    </tr>
    <tr>
      <td>0x002A</td>
      <td>BOOL_FALSE</td>
      <td><code class="language-plaintext highlighter-rouge">boolean</code>, <code class="language-plaintext highlighter-rouge">java.lang.Boolean</code></td>
      <td>False value only</td>
    </tr>
    <tr>
      <td>0x002B</td>
      <td>STRING</td>
      <td><code class="language-plaintext highlighter-rouge">java.lang.String</code></td>
      <td>Stored as a number of bytes + bytes</td>
    </tr>
    <tr>
      <td>0x002C</td>
      <td>STRING_EMPTY</td>
      <td> </td>
      <td>A special OID indicating an empty string</td>
    </tr>
    <tr>
      <td>0x002D</td>
      <td>CHAR</td>
      <td><code class="language-plaintext highlighter-rouge">char</code>, <code class="language-plaintext highlighter-rouge">java.lang.Character</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>0x002E</td>
      <td>CLJ_VEC</td>
      <td><code class="language-plaintext highlighter-rouge">clojure.lang.APersistentVector</code></td>
      <td>A standard Clojure vector</td>
    </tr>
    <tr>
      <td>0x002F</td>
      <td>CLJ_VEC_EMPTY</td>
      <td> </td>
      <td>A special OID indicating an empty vector</td>
    </tr>
    <tr>
      <td>0x0030</td>
      <td>CLJ_ATOM</td>
      <td><code class="language-plaintext highlighter-rouge">clojure.lang.Atom</code></td>
      <td>Gets deref-ed when encoding</td>
    </tr>
    <tr>
      <td>0x0031</td>
      <td>CLJ_REF</td>
      <td><code class="language-plaintext highlighter-rouge">clojure.lang.Ref</code></td>
      <td>Gets deref-ed when encoding</td>
    </tr>
    <tr>
      <td>0x0032</td>
      <td>FUTURE</td>
      <td><code class="language-plaintext highlighter-rouge">java.util.concurrent.Future</code></td>
      <td>Deed <code class="language-plaintext highlighter-rouge">.get</code>s the value using timeout from options. When time is up, an exception is throw. When decoded, it’s returned as an instance of <code class="language-plaintext highlighter-rouge">deed.FutureWrapper</code>: a fake object that mimics a future.</td>
    </tr>
    <tr>
      <td>0x0033</td>
      <td>CLJ_SET</td>
      <td><code class="language-plaintext highlighter-rouge">clojure.lang.APersistentSet</code></td>
      <td>A standard Clojure immutable set</td>
    </tr>
    <tr>
      <td>0x0034</td>
      <td>CLJ_SET_EMPTY</td>
      <td> </td>
      <td>A special OID indicating an empty set</td>
    </tr>
    <tr>
      <td>0x0035</td>
      <td>CLJ_LAZY_SEQ</td>
      <td><code class="language-plaintext highlighter-rouge">clojure.lang.LazySeq</code></td>
      <td>Encode a lazy sequence produced with <code class="language-plaintext highlighter-rouge">map</code>, <code class="language-plaintext highlighter-rouge">for</code>, etc. Stored as a collection of chunks like <code class="language-plaintext highlighter-rouge">&lt;chunk-len&gt;&lt;items...&gt;</code>. When decoding, read until the chunk of zero length is met.</td>
    </tr>
    <tr>
      <td>0x0036</td>
      <td>CLJ_SEQ</td>
      <td>Type depends on the origin collection</td>
      <td>Becomes a vector when decoding</td>
    </tr>
    <tr>
      <td>0x0037</td>
      <td>CLJ_LIST</td>
      <td><code class="language-plaintext highlighter-rouge">clojure.lang.PersistentList</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>0x0038</td>
      <td>CLJ_LIST_EMPTY</td>
      <td> </td>
      <td>A special OID indicating an empty list</td>
    </tr>
    <tr>
      <td>0x0039</td>
      <td>CLJ_QUEUE</td>
      <td><code class="language-plaintext highlighter-rouge">clojure.lang.PersistentQueue</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>0x003A</td>
      <td>CLJ_QUEUE_EMPTY</td>
      <td> </td>
      <td>A special OID indicating an empty queue</td>
    </tr>
    <tr>
      <td>0x003B</td>
      <td>CLJ_MAP</td>
      <td><code class="language-plaintext highlighter-rouge">clojure.lang.APersistentMap</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>0x003C</td>
      <td>CLJ_MAP_EMPTY</td>
      <td><code class="language-plaintext highlighter-rouge">clojure.lang.APersistentMap</code></td>
      <td>An empty Clojure map</td>
    </tr>
    <tr>
      <td>0x003D</td>
      <td>CLJ_MAP_ENTRY</td>
      <td><code class="language-plaintext highlighter-rouge">clojure.lang.MapEntry</code></td>
      <td>A pair of key and value</td>
    </tr>
    <tr>
      <td>0x003E</td>
      <td>CLJ_RECORD</td>
      <td><code class="language-plaintext highlighter-rouge">clojure.lang.IRecord</code></td>
      <td>An instance of <code class="language-plaintext highlighter-rouge">defrecord</code> object. When decoding, becomes an ordinary map. To preserve the origin type, use the <code class="language-plaintext highlighter-rouge">handle-record</code> macro (see below).</td>
    </tr>
    <tr>
      <td>0x003F</td>
      <td>CLJ_TR_VEC</td>
      <td><code class="language-plaintext highlighter-rouge">c.l.PersistentVector$TransientVector</code></td>
      <td>A transient Clojure vector.</td>
    </tr>
    <tr>
      <td>0x0040</td>
      <td>JVM_MAP</td>
      <td><code class="language-plaintext highlighter-rouge">java.util.Map</code></td>
      <td>A Java map, usually an instance of <code class="language-plaintext highlighter-rouge">HashMap</code>.</td>
    </tr>
    <tr>
      <td>0x0041</td>
      <td>JVM_MAP_ENTRY</td>
      <td><code class="language-plaintext highlighter-rouge">java.util.Map$Entry</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>0x0042</td>
      <td>UUID</td>
      <td><code class="language-plaintext highlighter-rouge">java.util.UUID</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>0x0043</td>
      <td>JVM_LIST</td>
      <td><code class="language-plaintext highlighter-rouge">java.util.List</code></td>
      <td>When decoding, becomes an instance of <code class="language-plaintext highlighter-rouge">ArrayList</code>.</td>
    </tr>
    <tr>
      <td>0x0044</td>
      <td>JVM_LIST_EMPTY</td>
      <td><code class="language-plaintext highlighter-rouge">java.util.List</code></td>
      <td>A stub for an empty list.</td>
    </tr>
    <tr>
      <td>0x0045</td>
      <td>JVM_VECTOR</td>
      <td><code class="language-plaintext highlighter-rouge">java.util.Vector</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>0x0046</td>
      <td>JVM_VECTOR_EMPTY</td>
      <td> </td>
      <td>An empty Java vector.</td>
    </tr>
    <tr>
      <td>0x0047</td>
      <td>JVM_ITERABLE</td>
      <td><code class="language-plaintext highlighter-rouge">java.lang.Iterable</code></td>
      <td>Encoded as uncounted chunked sequence of objects</td>
    </tr>
    <tr>
      <td>0x0048</td>
      <td>JVM_ITERATOR</td>
      <td> </td>
      <td>When decoding, becomes an instance of <code class="language-plaintext highlighter-rouge">ArrayList</code>.</td>
    </tr>
    <tr>
      <td>0x0049</td>
      <td>JVM_STREAM</td>
      <td><code class="language-plaintext highlighter-rouge">java.util.stream.Stream</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>0x004A</td>
      <td>CLJ_KEYWORD</td>
      <td><code class="language-plaintext highlighter-rouge">clojure.lang.Keyword</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>0x004B</td>
      <td>CLJ_SYMBOL</td>
      <td><code class="language-plaintext highlighter-rouge">clojure.lang.Symbol</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>0x004C</td>
      <td>UTIL_DATE</td>
      <td><code class="language-plaintext highlighter-rouge">java.util.Date</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>0x004D</td>
      <td>DT_LOCAL_DATE</td>
      <td><code class="language-plaintext highlighter-rouge">java.time.LocalDate</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>0x004E</td>
      <td>DT_LOCAL_TIME</td>
      <td><code class="language-plaintext highlighter-rouge">java.time.LocalTime</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>0x004F</td>
      <td>DT_LOCAL_DATETIME</td>
      <td><code class="language-plaintext highlighter-rouge">java.time.LocalDateTime</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>0x0050</td>
      <td>DT_OFFSET_DATETIME</td>
      <td><code class="language-plaintext highlighter-rouge">java.time.OffsetDateTime</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>0x0051</td>
      <td>DT_OFFSET_TIME</td>
      <td><code class="language-plaintext highlighter-rouge">java.time.OffsetTime</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>0x0052</td>
      <td>DT_DURATION</td>
      <td><code class="language-plaintext highlighter-rouge">java.time.Duration</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>0x0053</td>
      <td>DT_PERIOD</td>
      <td><code class="language-plaintext highlighter-rouge">java.time.Period</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>0x0054</td>
      <td>DT_ZONED_DATETIME</td>
      <td><code class="language-plaintext highlighter-rouge">java.time.ZonedDateTime</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>0x0055</td>
      <td>DT_ZONE_ID</td>
      <td><code class="language-plaintext highlighter-rouge">java.time.ZoneId</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>0x0056</td>
      <td>DT_INSTANT</td>
      <td><code class="language-plaintext highlighter-rouge">java.time.Instant</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>0x0057</td>
      <td>SQL_TIMESTAMP</td>
      <td><code class="language-plaintext highlighter-rouge">java.sql.Timestamp</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>0x0058</td>
      <td>SQL_TIME</td>
      <td><code class="language-plaintext highlighter-rouge">java.sql.Time</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>0x0059</td>
      <td>SQL_DATE</td>
      <td><code class="language-plaintext highlighter-rouge">java.sql.Date</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>0x005A</td>
      <td>BYTE</td>
      <td><code class="language-plaintext highlighter-rouge">byte</code>, <code class="language-plaintext highlighter-rouge">java.lang.Byte</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>0x005B</td>
      <td>BYTE_ZERO</td>
      <td> </td>
      <td>A stub for byte 0</td>
    </tr>
    <tr>
      <td>0x005C</td>
      <td>BYTE_ONE</td>
      <td> </td>
      <td>A stub for byte 1</td>
    </tr>
    <tr>
      <td>0x005D</td>
      <td>BYTE_MINUS_ONE</td>
      <td> </td>
      <td>A stub for byte -1</td>
    </tr>
    <tr>
      <td>0x005E</td>
      <td>FLOAT</td>
      <td><code class="language-plaintext highlighter-rouge">float</code>, <code class="language-plaintext highlighter-rouge">java.lang.Float</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>0x005F</td>
      <td>FLOAT_ZERO</td>
      <td> </td>
      <td>A stub for float 0</td>
    </tr>
    <tr>
      <td>0x0060</td>
      <td>FLOAT_ONE</td>
      <td> </td>
      <td>A stub for float 1</td>
    </tr>
    <tr>
      <td>0x0061</td>
      <td>FLOAT_MINUS_ONE</td>
      <td> </td>
      <td>A stub for float -1</td>
    </tr>
    <tr>
      <td>0x0062</td>
      <td>DOUBLE</td>
      <td><code class="language-plaintext highlighter-rouge">double</code>, <code class="language-plaintext highlighter-rouge">java.lang.Double</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>0x0063</td>
      <td>DOUBLE_ZERO</td>
      <td> </td>
      <td>A stub for double 0</td>
    </tr>
    <tr>
      <td>0x0064</td>
      <td>DOUBLE_ONE</td>
      <td> </td>
      <td>A stub for double 1</td>
    </tr>
    <tr>
      <td>0x0065</td>
      <td>DOUBLE_MINUS_ONE</td>
      <td> </td>
      <td>A stub for double -1</td>
    </tr>
    <tr>
      <td>0x0066</td>
      <td>JVM_BIG_DEC</td>
      <td><code class="language-plaintext highlighter-rouge">java.math.BigDecimal</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>0x0067</td>
      <td>JVM_BIG_INT</td>
      <td><code class="language-plaintext highlighter-rouge">java.math.BigInteger</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>0x0068</td>
      <td>CLJ_BIG_INT</td>
      <td><code class="language-plaintext highlighter-rouge">clojure.lang.BigInt</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>0x0069</td>
      <td>CLJ_RATIO</td>
      <td><code class="language-plaintext highlighter-rouge">clojure.lang.Ratio</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>0x006A</td>
      <td>VECTORZ_AVECTOR</td>
      <td><code class="language-plaintext highlighter-rouge">mikera.vectorz.AVector</code></td>
      <td>See the <code class="language-plaintext highlighter-rouge">deed-vectorz</code> package</td>
    </tr>
  </tbody>
</table>

<h2 id="extending-custom-types">Extending Custom Types</h2>

<h3 id="encode">Encode</h3>

<p>Although Deed handles plenty of types, you can easily have a type that is
unknown to it. Handling such a type is a matter of two things: extending both
encoding and decoding logic.</p>

<p>Imagine you have a custom <code class="language-plaintext highlighter-rouge">deftype</code> with three fields:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">deftype</span><span class="w"> </span><span class="n">SomeType</span><span class="w"> </span><span class="p">[</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">z</span><span class="p">]</span><span class="w">
  </span><span class="n">...</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>Here is how you extend the encoding logic. First, declare a custom OID number
for it. The number must be <code class="language-plaintext highlighter-rouge">short</code> (two bytes) meaning the range from -32768
to 32767. When declaring such an OID, please ensure it doens’t overlap with
<a href="https://github.com/igrishaev/deed/blob/master/deed-core/src/java/deed/OID.java">pre-existing OIDs</a>.</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">SomeTypeOID</span><span class="w"> </span><span class="mi">4321</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>Then extend the <code class="language-plaintext highlighter-rouge">IEncode</code> protocol with that type:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">extend-protocol</span><span class="w"> </span><span class="n">deed/IEncode</span><span class="w">
  </span><span class="n">SomeType</span><span class="w">
  </span><span class="p">(</span><span class="nf">-encode</span><span class="w"> </span><span class="p">[</span><span class="n">this</span><span class="w"> </span><span class="n">encoder</span><span class="p">]</span><span class="w">
    </span><span class="p">(</span><span class="nf">deed/writeOID</span><span class="w"> </span><span class="n">encoder</span><span class="w"> </span><span class="n">SomeTypeOID</span><span class="p">)</span><span class="w"> </span><span class="c1">;; !</span><span class="w">
    </span><span class="p">(</span><span class="nf">deed/encode</span><span class="w"> </span><span class="n">encoder</span><span class="w"> </span><span class="p">(</span><span class="nf">.-x</span><span class="w"> </span><span class="n">this</span><span class="p">))</span><span class="w">
    </span><span class="p">(</span><span class="nf">deed/encode</span><span class="w"> </span><span class="n">encoder</span><span class="w"> </span><span class="p">(</span><span class="nf">.-y</span><span class="w"> </span><span class="n">this</span><span class="p">))</span><span class="w">
    </span><span class="p">(</span><span class="nf">deed/encode</span><span class="w"> </span><span class="n">encoder</span><span class="w"> </span><span class="p">(</span><span class="nf">.-z</span><span class="w"> </span><span class="n">this</span><span class="p">))))</span><span class="w">
</span></code></pre></div></div>

<p>Or vice versa: extend the type with the protocol:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">extend-type</span><span class="w"> </span><span class="n">SomeType</span><span class="w">
  </span><span class="n">deed/IEncode</span><span class="w">
  </span><span class="p">(</span><span class="nf">-encode</span><span class="w"> </span><span class="p">[</span><span class="n">this</span><span class="w"> </span><span class="n">encoder</span><span class="p">]</span><span class="w">
    </span><span class="p">(</span><span class="nf">deed/writeOID</span><span class="w"> </span><span class="n">encoder</span><span class="w"> </span><span class="n">SomeTypeOID</span><span class="p">)</span><span class="w"> </span><span class="c1">;; !</span><span class="w">
    </span><span class="p">(</span><span class="nf">deed/encode</span><span class="w"> </span><span class="n">encoder</span><span class="w"> </span><span class="p">(</span><span class="nf">.-x</span><span class="w"> </span><span class="n">this</span><span class="p">))</span><span class="w">
    </span><span class="p">(</span><span class="nf">deed/encode</span><span class="w"> </span><span class="n">encoder</span><span class="w"> </span><span class="p">(</span><span class="nf">.-y</span><span class="w"> </span><span class="n">this</span><span class="p">))</span><span class="w">
    </span><span class="p">(</span><span class="nf">deed/encode</span><span class="w"> </span><span class="n">encoder</span><span class="w"> </span><span class="p">(</span><span class="nf">.-z</span><span class="w"> </span><span class="n">this</span><span class="p">))))</span><span class="w">
</span></code></pre></div></div>

<p>Pay attention that in both cases the first expression must be the <code class="language-plaintext highlighter-rouge">writeOID</code>
invocation. The OID is always put first because decoding logic relies on
it. Then we encode custom fields <code class="language-plaintext highlighter-rouge">x</code>, <code class="language-plaintext highlighter-rouge">y</code>, and <code class="language-plaintext highlighter-rouge">z</code>.</p>

<p>Encoding might be a bit easier if you extend a type with <code class="language-plaintext highlighter-rouge">IEncode</code> when
declaring it. In this case, the <code class="language-plaintext highlighter-rouge">-encode</code> method has direct access to <code class="language-plaintext highlighter-rouge">x</code>, <code class="language-plaintext highlighter-rouge">y</code>,
and <code class="language-plaintext highlighter-rouge">z</code> as they were local variables.</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">deftype</span><span class="w"> </span><span class="n">SomeType</span><span class="w"> </span><span class="p">[</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">z</span><span class="p">]</span><span class="w">
  </span><span class="n">deed/IEncode</span><span class="w">
  </span><span class="p">(</span><span class="nf">-encode</span><span class="w"> </span><span class="p">[</span><span class="n">this</span><span class="w"> </span><span class="n">encoder</span><span class="p">]</span><span class="w">
    </span><span class="p">(</span><span class="nf">deed/writeOID</span><span class="w"> </span><span class="n">encoder</span><span class="w"> </span><span class="n">SomeTypeOID</span><span class="p">)</span><span class="w">
    </span><span class="p">(</span><span class="nf">deed/encode</span><span class="w"> </span><span class="n">encoder</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w">
    </span><span class="p">(</span><span class="nf">deed/encode</span><span class="w"> </span><span class="n">encoder</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w">
    </span><span class="p">(</span><span class="nf">deed/encode</span><span class="w"> </span><span class="n">encoder</span><span class="w"> </span><span class="n">z</span><span class="p">)))</span><span class="w">
</span></code></pre></div></div>

<p>Since <code class="language-plaintext highlighter-rouge">encode</code> is a general function, it handles any types. You don’t bother if
<code class="language-plaintext highlighter-rouge">x</code> is a number, or a string, or a keyword, or a nested <code class="language-plaintext highlighter-rouge">SomeType</code> instance.</p>

<h3 id="decode">Decode</h3>

<p>Extend the decoding counterpart by adding implementation to the <code class="language-plaintext highlighter-rouge">-decode</code>
multimethod:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">defmethod</span><span class="w"> </span><span class="n">deed/-decode</span><span class="w"> </span><span class="n">SomeTypeOID</span><span class="w">
  </span><span class="p">[</span><span class="n">_</span><span class="w"> </span><span class="n">decoder</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="nf">deed/decode</span><span class="w"> </span><span class="n">decoder</span><span class="p">)</span><span class="w">
        </span><span class="n">y</span><span class="w"> </span><span class="p">(</span><span class="nf">deed/decode</span><span class="w"> </span><span class="n">decoder</span><span class="p">)</span><span class="w">
        </span><span class="n">z</span><span class="w"> </span><span class="p">(</span><span class="nf">deed/decode</span><span class="w"> </span><span class="n">decoder</span><span class="p">)]</span><span class="w">
    </span><span class="p">(</span><span class="nb">new</span><span class="w"> </span><span class="n">SomeType</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">z</span><span class="p">)))</span><span class="w">
</span></code></pre></div></div>

<p>Here you retrieve <code class="language-plaintext highlighter-rouge">x</code>, <code class="language-plaintext highlighter-rouge">y</code>, and <code class="language-plaintext highlighter-rouge">z</code> fields back and componse a new instance of
<code class="language-plaintext highlighter-rouge">SomeType</code>. Let’s check it quckly:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">_buf</span><span class="w">
  </span><span class="p">(</span><span class="nf">deed/encode-to-bytes</span><span class="w"> </span><span class="p">(</span><span class="nb">new</span><span class="w"> </span><span class="n">SomeType</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="p">)))</span><span class="w">

</span><span class="p">(</span><span class="nf">deed/decode-from</span><span class="w"> </span><span class="n">_buf</span><span class="p">)</span><span class="w">
</span><span class="c1">;; #object[demo.SomeType 0x47e19f78 "demo.SomeType@47e19f78"]</span><span class="w">
</span></code></pre></div></div>

<p>The order of written and read fields does matter, of course. If you mix them,
you’ll get a broken object back.</p>

<h3 id="macros">Macros</h3>

<p>There is a couple of macros that extend protocols and multimethods under the
hood: <code class="language-plaintext highlighter-rouge">expand-encode</code> and <code class="language-plaintext highlighter-rouge">expand-decode</code>. The first one accepts an OID, a type
(class), and a couple of symbols to bind: the current <code class="language-plaintext highlighter-rouge">Encoder</code> instance and the
current value you process. Then there is a body that encodes fields:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">deed/expand-encode</span><span class="w"> </span><span class="p">[</span><span class="n">MyOID</span><span class="w"> </span><span class="n">SomeType</span><span class="w"> </span><span class="n">encoder</span><span class="w"> </span><span class="n">some-type</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nf">deed/encode</span><span class="w"> </span><span class="n">encoder</span><span class="w"> </span><span class="p">(</span><span class="nf">.-x</span><span class="w"> </span><span class="n">some-type</span><span class="p">))</span><span class="w">
  </span><span class="p">(</span><span class="nf">deed/encode</span><span class="w"> </span><span class="n">encoder</span><span class="w"> </span><span class="p">(</span><span class="nf">.-y</span><span class="w"> </span><span class="n">some-type</span><span class="p">))</span><span class="w">
  </span><span class="p">(</span><span class="nf">deed/encode</span><span class="w"> </span><span class="n">encoder</span><span class="w"> </span><span class="p">(</span><span class="nf">.-z</span><span class="w"> </span><span class="n">some-type</span><span class="p">)))</span><span class="w">
</span></code></pre></div></div>

<p>Pay attention, you <strong>don’t call</strong> <code class="language-plaintext highlighter-rouge">writeOID</code> inside the body because it’s
already a part of the macro.</p>

<p>The <code class="language-plaintext highlighter-rouge">expand-decode</code> macro accepts an OID and a symbol bound to the current
<code class="language-plaintext highlighter-rouge">Decoder</code> instance. Inside, you decode fields and compose an object:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">deed/expand-decode</span><span class="w"> </span><span class="p">[</span><span class="n">MyOID</span><span class="w"> </span><span class="n">decoder</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="nf">deed/decode</span><span class="w"> </span><span class="n">decoder</span><span class="p">)</span><span class="w">
        </span><span class="n">y</span><span class="w"> </span><span class="p">(</span><span class="nf">deed/decode</span><span class="w"> </span><span class="n">decoder</span><span class="p">)</span><span class="w">
        </span><span class="n">z</span><span class="w"> </span><span class="p">(</span><span class="nf">deed/decode</span><span class="w"> </span><span class="n">decoder</span><span class="p">)]</span><span class="w">
    </span><span class="p">(</span><span class="nb">new</span><span class="w"> </span><span class="n">AnotherType</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">z</span><span class="p">)))</span><span class="w">
</span></code></pre></div></div>

<h2 id="handling-defrecords">Handling Defrecords</h2>

<p>By default, records defined with the <code class="language-plaintext highlighter-rouge">defrecord</code> macro are read as Clojure
maps. This because they’re created at runtime and thus are not known to Deed. To
preserve the origin type, either you extend a record with the <code class="language-plaintext highlighter-rouge">IEncode</code> protocol
and extend the <code class="language-plaintext highlighter-rouge">-decode</code> multimethod as described above. Another way is to use
the <code class="language-plaintext highlighter-rouge">handle-record</code> macro that does the same. It accepts just two arguments: a
unique OID and the type of a record:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">defrecord</span><span class="w"> </span><span class="n">Bar</span><span class="w"> </span><span class="p">[</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">])</span><span class="w">

</span><span class="p">(</span><span class="nf">deed/handle-record</span><span class="w"> </span><span class="mi">4321</span><span class="w"> </span><span class="n">Bar</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>The body of the macro is missing as you don’t need to pass anything
else. Internally, a record is still encoded as a Clojure map but using the OID
you passed. When decoding this map, before it gets returned to the user, it’s
wrapped into the <code class="language-plaintext highlighter-rouge">&lt;YourType&gt;/create</code> invocation which creates a record instance
from a map.</p>

<h2 id="contrib">Contrib</h2>

<p>Deed comes with some minor packages that will make your life a bit easier.</p>

<h3 id="base64">Base64</h3>

<p>The package <code class="language-plaintext highlighter-rouge">deed-base64</code> brings functions to encode values into a
base64-encoded stream, and read them back. This is useful when passing encoded
data throughout a text format, for example JSON. The package relies on
<code class="language-plaintext highlighter-rouge">Base64OutputStream</code> and <code class="language-plaintext highlighter-rouge">Base64InputStream</code> classes from the Apacke Commons
Codec library. As it’s a third-party dependency, the functionalty is shipped in
a sub-package.</p>

<p>A quick example:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">ns</span><span class="w"> </span><span class="n">deed-base64-demo</span><span class="w">
  </span><span class="p">(</span><span class="no">:require</span><span class="w">
   </span><span class="p">[</span><span class="n">deed.core</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">deed</span><span class="p">]</span><span class="w">
   </span><span class="p">[</span><span class="n">deed.base64</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">b64</span><span class="p">]))</span><span class="w">

</span><span class="p">(</span><span class="nb">with-open</span><span class="w"> </span><span class="p">[</span><span class="n">out</span><span class="w"> </span><span class="p">(</span><span class="nb">-&gt;</span><span class="w"> </span><span class="s">"dump.deed.b64"</span><span class="w">
                    </span><span class="p">(</span><span class="nf">b64/base64-output-stream</span><span class="p">))]</span><span class="w">
  </span><span class="p">(</span><span class="nf">deed/encode-to</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="n">out</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">base64-output-stream</code> function wraps any source and makes an instance of
<code class="language-plaintext highlighter-rouge">Base64OutputStream</code>. As you write to it, the data gets silently base64-encoded:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nb">slurp</span><span class="w"> </span><span class="s">"dump.deed.b64"</span><span class="p">)</span><span class="w">
</span><span class="s">"AAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAuAAAAAwAOAAwAAAAAAAAAAgAMAAAAAAAAAAM="</span><span class="w">
</span></code></pre></div></div>

<p>Read it again by wrapping the file into the <code class="language-plaintext highlighter-rouge">base64-input-stream</code> function:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nb">with-open</span><span class="w"> </span><span class="p">[</span><span class="n">in</span><span class="w"> </span><span class="p">(</span><span class="nb">-&gt;</span><span class="w"> </span><span class="s">"dump.deed.b64"</span><span class="w">
                   </span><span class="p">(</span><span class="nf">io/file</span><span class="p">)</span><span class="w">
                   </span><span class="p">(</span><span class="nf">b64/base64-input-stream</span><span class="p">))]</span><span class="w">
  </span><span class="p">(</span><span class="nf">deed/decode-from</span><span class="w"> </span><span class="n">in</span><span class="p">))</span><span class="w">

</span><span class="c1">;; [1 2 3]</span><span class="w">
</span></code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">deed.base64</code> namespace provides a number of shortcuts, namely:</p>

<table>
  <thead>
    <tr>
      <th>Function</th>
      <th>Comment</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">encode-to-base64-bytes</code></td>
      <td>Encode a single value into base64 byte array</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">encode-seq-to-base64-bytes</code></td>
      <td>Encode a sequence of values into a base64 byte array</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">encode-to-base64-string</code></td>
      <td>Encode a single value into a base64 string</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">encode-seq-to-base64-string</code></td>
      <td>Encode a sequence of values into a base64 string</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">decode-from-base64-bytes</code></td>
      <td>Decode a single value from a base64 byte array</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">decode-from-base64-string</code></td>
      <td>Decode a single value from a base64 string</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">decode-seq-from-base64-bytes</code></td>
      <td>Decode a sequence of values from base64 byte array</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">decode-seq-from-base64-string</code></td>
      <td>Decode a sequence of values from base64 string</td>
    </tr>
  </tbody>
</table>

<p>Their signatures are similar to what we’ve covered so far.</p>

<h3 id="vectorz">VectorZ</h3>

<p>The <code class="language-plaintext highlighter-rouge">deed-vectorz</code> package extends Deed with classes the from the
<a href="https://github.com/mikera/vectorz">mikera/vectorz</a> library. These vectors are good for fast
computations. A brief demo:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">ns</span><span class="w"> </span><span class="n">demo</span><span class="w">
  </span><span class="p">(</span><span class="no">:require</span><span class="w">
   </span><span class="p">[</span><span class="n">deed.core</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">deed</span><span class="p">]</span><span class="w">
   </span><span class="p">[</span><span class="n">deed.vectorz</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">vz</span><span class="p">])</span><span class="w">
  </span><span class="p">(</span><span class="no">:import</span><span class="w">
   </span><span class="p">(</span><span class="nf">mikera.vectorz</span><span class="w"> </span><span class="n">Vectorz</span><span class="p">)))</span><span class="w">

</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">vz</span><span class="w">
  </span><span class="p">(</span><span class="nf">Vectorz/create</span><span class="w"> </span><span class="p">(</span><span class="nf">double-array</span><span class="w"> </span><span class="p">[</span><span class="mf">1.1</span><span class="w"> </span><span class="mf">2.2</span><span class="w"> </span><span class="mf">3.3</span><span class="p">])))</span><span class="w">

</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">dump</span><span class="w">
  </span><span class="p">(</span><span class="nf">deed/encode-to-bytes</span><span class="w"> </span><span class="n">vz</span><span class="p">))</span><span class="w">

</span><span class="p">(</span><span class="nf">deed/decode-from</span><span class="w"> </span><span class="n">dump</span><span class="p">)</span><span class="w">
</span><span class="c1">;; #object[mikera.vectorz.Vector3 0x5ecb1a9a "[1.1,2.2,3.3]"]</span><span class="w">
</span></code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">Vectorz</code> class is a general factory for other classes like <code class="language-plaintext highlighter-rouge">Vector1</code>,
<code class="language-plaintext highlighter-rouge">Vector2</code> and similar. Deed extends the <code class="language-plaintext highlighter-rouge">AVector</code> class which is common for all
of these.</p>

<h2 id="binary-format">Binary Format</h2>

<p>The binary payload of Deed is quite simple. It consists from the following
pattern:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;2-byte-OID&gt;&lt;content&gt;&lt;2-byte-OID&gt;&lt;content&gt;...
</code></pre></div></div>

<p>At the beginning, there is always a <code class="language-plaintext highlighter-rouge">deed.Header</code> object with general
information about how encoding was made. At the moment, it only tracks the
version of the protocol and nothing else. The header has constant size of 30
bytes where unused bytes are reserved. In there future, there might be more data
in the header.</p>

<p>The content depends on the nature of a type. Say, if it’s an integer, there are
always four bytes. If it’s a string, than we have four-byte length of the
upcoming byte array, and then the array by itself.</p>

<p>Counted collections are encoded whis way too. First, there is a total length of
a collection, and the items encoded one by one. As the items might be of
different types, they have their own OIDs:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;2-byte-vector-id&gt;&lt;4-byte-vector-length&gt;&lt;oid-item-1&gt;&lt;payload-item-1&gt;&lt;oid-item-2&gt;&lt;payload-item-2&gt;
</code></pre></div></div>

<p>This section, perhaps is not too detailed at the moment, will be extended in the
future. For now, check out the source code: see the <a href="https://github.com/igrishaev/deed/blob/master/deed-core/src/java/deed/Encoder.java">Encoder.java</a> and
<a href="https://github.com/igrishaev/deed/blob/master/deed-core/src/java/deed/Decoder.java">Decoder.java</a> files.</p>

<h2 id="benchmarks">Benchmarks</h2>

<p>Deed is a bit faster than Nippy as it’s written mostly in Java. The time
difference depends on the nature of data being processed, but in general Deed is
about 1.5 times faster. Here are encoding metrics made on two various machines
using the Criterium library:</p>

<p><img src="/assets/static/aws/clj-deed/encoding.svg" class="svg-chart" /></p>

<p>Decode measurements made for the same data:</p>

<p><img src="/assets/static/aws/clj-deed/decoding.svg" class="svg-chart" /></p>


    
<div class="prev-next">

    <div class="prev-next-left">
    
        <p><small><a href="/world-of-goo-2/">&larr; World of Goo 2</a></small></p>
    
    </div>

    <div class="prev-next-mid">
    </div>

    <div class="prev-next-right">
    
        <p><small><a href="/clj-last-explain/">Подробней о last &rarr;</a></small></p>
    
    </div>

</div>

  </div>

</article>

<center>
    <p>
        <small>Нашли ошибку? Выделите мышкой и нажмите Ctrl/&#8984;+Enter</small>
    </p>
</center>






<center>Комментариев пока нет</center>









<form id="comment-form" method="POST" action="https://functions.yandexcloud.net/d4ehfuf08fjfjr59ivnf">

    <div class="block">
        <p class="comment-form-label"><small>Your name</small></p>
        <input required id="comment-form-author" name="author" type="text">
    </div>

    <div class="block">
        <p class="comment-form-label"><small>Comment (markdown syntax)</small></p>
        <textarea required id="comment-form-comment" name="comment"></textarea>
    </div>

    <input required name="path" type="hidden" value="/clj-deed/">
    <input required name="captcha" type="hidden" value="7 &#215; 4">

    <div class="block">
        <span class="comment-form-label"><small>7 &#215; 4 = </small></span>
        <input required id="comment-form-solution" name="solution" type="text">
    </div>

    <div class="block">
        <button id="comment-form-send" type="submit">Send</button>
    </div>

</form>


      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Ivan Grishaev's blog</li>
          <li><a href="mailto:ivan@grishaev.me">ivan@grishaev.me</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
            <li><a href="https://github.com/igrishaev">GitHub</a></li>
            <li><a href="https://t.me/igrishaev_blog">Telegram</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Writing on programming, education, books and negotiations.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
