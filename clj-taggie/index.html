<!DOCTYPE html>
<html lang="ru">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Taggie</title>
  <meta name="description" content="">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/custom.css">
  <link rel="canonical" href="https://grishaev.me/clj-taggie/">
  <link rel="alternate" type="application/rss+xml" title="Ivan Grishaev's blog" href="https://grishaev.me/feed.xml">

  <link rel="shortcut icon" type="image/x-icon" href="/assets/static/favicons/favicon.ico">

  <script type="text/javascript" src="/assets/typo.js"></script>

</head>


  <body>
    <header class="site-header">

    <div class="wrapper flex-container">

        <div>
            <a href="/">
                <img id="avatar" src="/assets/static/avatar.jpg" alt="Ivan Grishaev">
            </a>
        </div>

        <div class="flex-container-vert" style="margin-left: 15px; width: 80%">

            <div class="flex-container full-width">
                <p style="margin-bottom: 5px"><a href="/">Ivan Grishaev's blog</a></p>
                <div class="flex-huge"></div>
                <div >
<form id="search-form"
      target="_blank"
      style="display: inline"
      method="get"
      action="https://www.google.com/search">

    <input name="sitesearch"
           value="grishaev.me"
           type="hidden">

    <input type="text"
           required="required"
           name="q"
           placeholder="Google search..."
           autocomplete="off">

    <button style="border: none; background-color: transparent; cursor: pointer;"
            type="submit">&#x1f50d;</button>

</form>
</div>
            </div>

            <p><small>Writing on programming, education, books and negotiations.
</small></p>

            <div class="flex-container">
                <a class="menu-item" href="/">Home</a>
                <a class="menu-item" href="/about/">About</a>
                <a class="menu-item" href="/open-source/">Open Source</a>
                <a class="menu-item" href="/bookshelf/">Bookshelf</a>
                <a class="menu-item" href="/feed.xml">RSS</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor" href="/tag/clojure/">Clojure</a>
                <a class="menu-item minor" href="/tag/emacs/">Emacs</a>
                <a class="menu-item minor" href="/tag/python/">Python</a>
                <a class="menu-item minor" href="/tag/programming/">Programming</a>
                <a class="menu-item minor" href="/interview/">Interview</a>
                <a class="menu-item minor" href="/video/">Video</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor hl" href="/clojure-in-prod/">Книга «Clojure на производстве»</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor hl" href="/clojure-in-prod-2/">Книга «Clojure на производстве», второй том</a>
            </div>

        </div>
    </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">

    <h1 class="post-title" itemprop="name headline">Taggie</h1>

    
<div class="post-meta">

    <time class="post-time"
          datetime="2025-02-08T00:00:00+00:00">
        Feb 8, 2025
    </time>

    <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/clojure/" rel="tag">clojure</a>, <a href="/tag/tags/" rel="tag">tags</a>

</div>


  </header>

  <div class="post-content" itemprop="articleBody">
    
<p><a href="https://github.com/igrishaev/taggie">Taggie</a> is an experimental library trying find an answer for a strange
question: is it possible to benefit from Clojure tags and readers, and how?</p>

<p>Taggie extends printing methods such that types that could not be read from
their representation now <strong>can</strong> be read. A quick example: if you print an atom,
you’ll get a weird string:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">atom</span><span class="w"> </span><span class="mi">42</span><span class="p">)</span><span class="w">
</span><span class="o">#</span><span class="n">&lt;Atom</span><span class="o">@</span><span class="mi">7</span><span class="n">fea5978</span><span class="err">:</span><span class="w"> </span><span class="mi">42</span><span class="nb">&gt;</span><span class="w">
</span></code></pre></div></div>

<p>Run that string, and REPL won’t understand you:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">#</span><span class="n">&lt;Atom</span><span class="o">@</span><span class="mi">7</span><span class="n">fea5978</span><span class="err">:</span><span class="w"> </span><span class="mi">42</span><span class="nb">&gt;</span><span class="w">
</span><span class="n">Syntax</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">reading</span><span class="w"> </span><span class="n">source</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="p">(</span><span class="nf">REPL</span><span class="no">:962:5</span><span class="p">)</span><span class="nb">.</span><span class="w">
</span><span class="n">Unreadable</span><span class="w"> </span><span class="n">form</span><span class="w">
</span></code></pre></div></div>

<p>But with Taggie, it goes this way:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">atom</span><span class="w"> </span><span class="mi">42</span><span class="p">)</span><span class="w">
</span><span class="o">#</span><span class="n">atom</span><span class="w"> </span><span class="mi">42</span><span class="w"> </span><span class="c1">;; represented with a tag</span><span class="w">
</span></code></pre></div></div>

<p>And vice versa:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">#</span><span class="n">atom</span><span class="w"> </span><span class="mi">42</span><span class="w"> </span><span class="c1">;; run it in repl</span><span class="w">
</span><span class="o">#</span><span class="n">atom</span><span class="w"> </span><span class="mi">42</span><span class="w"> </span><span class="c1">;; the result</span><span class="w">
</span></code></pre></div></div>

<p>The value is an atom indeed, you can check it:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nb">deref</span><span class="w"> </span><span class="o">#</span><span class="n">atom</span><span class="w"> </span><span class="mi">42</span><span class="p">)</span><span class="w">
</span><span class="mi">42</span><span class="w">
</span></code></pre></div></div>

<p>Tags can be nested. Let’s try some madness:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">omg</span><span class="w"> </span><span class="o">#</span><span class="n">atom</span><span class="w"> </span><span class="o">#</span><span class="n">atom</span><span class="w"> </span><span class="o">#</span><span class="n">atom</span><span class="w"> </span><span class="o">#</span><span class="n">atom</span><span class="w"> </span><span class="o">#</span><span class="n">atom</span><span class="w"> </span><span class="o">#</span><span class="n">atom</span><span class="w"> </span><span class="mi">42</span><span class="p">)</span><span class="w">

</span><span class="p">(</span><span class="nb">println</span><span class="w"> </span><span class="n">omg</span><span class="p">)</span><span class="w">
</span><span class="o">#</span><span class="n">atom</span><span class="w"> </span><span class="o">#</span><span class="n">atom</span><span class="w"> </span><span class="o">#</span><span class="n">atom</span><span class="w"> </span><span class="o">#</span><span class="n">atom</span><span class="w"> </span><span class="o">#</span><span class="n">atom</span><span class="w"> </span><span class="o">#</span><span class="n">atom</span><span class="w"> </span><span class="mi">42</span><span class="w">

</span><span class="o">@@@@@@</span><span class="n">omg</span><span class="w">
</span><span class="mi">42</span><span class="w">
</span></code></pre></div></div>

<p>But this is not only about atoms! Taggie extends many types, e.g. refs, native
Java arrays, <code class="language-plaintext highlighter-rouge">File</code>, <code class="language-plaintext highlighter-rouge">URI</code>, <code class="language-plaintext highlighter-rouge">URL</code>, <code class="language-plaintext highlighter-rouge">Date</code>, <code class="language-plaintext highlighter-rouge">java.time.*</code> classes, and something
else. See the corresponding section below.</p>

<h2 id="installation-and-usage">Installation and Usage</h2>

<p>Add this to your project:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">;; lein</span><span class="w">
</span><span class="p">[</span><span class="n">com.github.igrishaev/taggie</span><span class="w"> </span><span class="s">"0.1.0"</span><span class="p">]</span><span class="w">

</span><span class="c1">;; deps</span><span class="w">
</span><span class="n">com.github.igrishaev/taggie</span><span class="w"> </span><span class="p">{</span><span class="no">:mvn/version</span><span class="w"> </span><span class="s">"0.1.0"</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Then import the core namespace:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">ns</span><span class="w"> </span><span class="n">com.acme.server</span><span class="w">
  </span><span class="p">(</span><span class="no">:require</span><span class="w">
    </span><span class="n">taggie.core</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<p>Now type in the repl any of these:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">#</span><span class="n">LocalDate</span><span class="w"> </span><span class="s">"2025-01-01"</span><span class="w">
</span><span class="o">#</span><span class="n">Instant</span><span class="w"> </span><span class="s">"2025-01-01T23:59:59Z"</span><span class="w">
</span><span class="o">#</span><span class="n">File</span><span class="w"> </span><span class="s">"/path/to/a/file.txt"</span><span class="w">
</span><span class="o">#</span><span class="n">URL</span><span class="w"> </span><span class="s">"https://clojure.org"</span><span class="w">
</span><span class="o">#</span><span class="n">bytes</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="n">x00</span><span class="w"> </span><span class="mi">0</span><span class="n">xff</span><span class="p">]</span><span class="w">
</span><span class="o">#</span><span class="n">ints</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="p">]</span><span class="w">
</span><span class="o">#</span><span class="n">floats</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="p">]</span><span class="w">
</span><span class="o">#</span><span class="n">ByteBuffer</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">4</span><span class="p">]</span><span class="w">
</span><span class="n">...</span><span class="w">
</span></code></pre></div></div>

<p>Each expression gives an instance of a corresponding type: a <code class="language-plaintext highlighter-rouge">LocalDate</code>, an
<code class="language-plaintext highlighter-rouge">Instane</code>, a <code class="language-plaintext highlighter-rouge">File</code>, etc… <code class="language-plaintext highlighter-rouge">#bytes</code>, <code class="language-plaintext highlighter-rouge">#ints</code> and similar produce native Java
arrays.</p>

<p>You can pass tagged values into functions as usual:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nb">deref</span><span class="w"> </span><span class="o">#</span><span class="n">atom</span><span class="w"> </span><span class="mi">42</span><span class="p">)</span><span class="w">
</span><span class="mi">42</span><span class="w">

</span><span class="p">(</span><span class="nb">alength</span><span class="w"> </span><span class="o">#</span><span class="n">longs</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="p">])</span><span class="w">
</span><span class="mi">3</span><span class="w">
</span></code></pre></div></div>

<p>To observe what happends under the hood, prepend your expression with a
backtick:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">`</span><span class="p">(</span><span class="nb">alength</span><span class="w"> </span><span class="o">#</span><span class="n">longs</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="p">])</span><span class="w">

</span><span class="p">(</span><span class="nf">clojure.core/alength</span><span class="w"> </span><span class="p">(</span><span class="nf">taggie.readers/__reader-longs-edn</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="p">]))</span><span class="w">
</span></code></pre></div></div>

<p>Internally, all tags expand into an invocation of an EDN reader. Namely, <code class="language-plaintext highlighter-rouge">#longs
items</code> becomes <code class="language-plaintext highlighter-rouge">(taggie.readers/__reader-longs-edn items)</code>, and when evaluated,
it returs a native array of longs.</p>

<h2 id="edn-support">EDN Support</h2>

<p>Taggie provides functions to read and write EDN with tags. They live in the
<code class="language-plaintext highlighter-rouge">taggie.edn</code> namespace. Use it as follows:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">edn-dump</span><span class="w">
  </span><span class="p">(</span><span class="nf">taggie.edn/write-string</span><span class="w"> </span><span class="o">#</span><span class="n">atom</span><span class="w"> </span><span class="p">{</span><span class="no">:test</span><span class="w"> </span><span class="mi">1</span><span class="w">
                                  </span><span class="no">:values</span><span class="w"> </span><span class="o">#</span><span class="n">longs</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="p">]</span><span class="w">
                                  </span><span class="no">:created-at</span><span class="w"> </span><span class="o">#</span><span class="n">LocalDate</span><span class="w"> </span><span class="s">"2025-01-01"</span><span class="p">}))</span><span class="w">

</span><span class="p">(</span><span class="nb">println</span><span class="w"> </span><span class="n">edn-dump</span><span class="p">)</span><span class="w">

</span><span class="c1">;; #atom {:test 1,</span><span class="w">
</span><span class="c1">;;        :values #longs [1, 2, 3],</span><span class="w">
</span><span class="c1">;;        :created-at #LocalDate "2025-01-01"}</span><span class="w">
</span></code></pre></div></div>

<p>It produces a string with custom tags and data being pretty printed. Let’s read
it back:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">taggie.edn/read-string</span><span class="w"> </span><span class="n">edn-dump</span><span class="p">)</span><span class="w">

</span><span class="o">#</span><span class="n">atom</span><span class="w"> </span><span class="p">{</span><span class="no">:test</span><span class="w"> </span><span class="mi">1</span><span class="n">,</span><span class="w">
       </span><span class="no">:values</span><span class="w"> </span><span class="o">#</span><span class="n">longs</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="n">,</span><span class="w"> </span><span class="mi">2</span><span class="n">,</span><span class="w"> </span><span class="mi">3</span><span class="p">]</span><span class="n">,</span><span class="w">
       </span><span class="no">:created-at</span><span class="w"> </span><span class="o">#</span><span class="n">LocalDate</span><span class="w"> </span><span class="s">"2025-01-01"</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">write</code> function writes EDN into a destination which might be a file path, a
file, an output stream, a writer, etc:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">taggie.edn/write</span><span class="w"> </span><span class="p">(</span><span class="nf">clojure.java.io/file</span><span class="w"> </span><span class="s">"data.edn"</span><span class="p">)</span><span class="w">
                  </span><span class="p">{</span><span class="no">:test</span><span class="w"> </span><span class="p">(</span><span class="nf">atom</span><span class="w"> </span><span class="p">(</span><span class="nb">ref</span><span class="w"> </span><span class="p">(</span><span class="nf">atom</span><span class="w"> </span><span class="no">:secret</span><span class="p">)))})</span><span class="w">
</span></code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">read</code> function reads EDN from any kind of source: a file path, a file, in
input stream, a reader, etc. Internally, a source is transformed into the
<code class="language-plaintext highlighter-rouge">PushbackReader</code> instance:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">taggie.edn/read</span><span class="w"> </span><span class="p">(</span><span class="nf">clojure.java.io/file</span><span class="w"> </span><span class="s">"data.edn"</span><span class="p">))</span><span class="w">

</span><span class="p">{</span><span class="no">:test</span><span class="w"> </span><span class="o">#</span><span class="n">atom</span><span class="w"> </span><span class="o">#</span><span class="nb">ref</span><span class="w"> </span><span class="o">#</span><span class="n">atom</span><span class="w"> </span><span class="no">:secret</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Both <code class="language-plaintext highlighter-rouge">read</code> and <code class="language-plaintext highlighter-rouge">read-string</code> accept standard <code class="language-plaintext highlighter-rouge">clojure.edn/read</code> options,
e.g. <code class="language-plaintext highlighter-rouge">:readers</code>, <code class="language-plaintext highlighter-rouge">:eof</code>, etc. The <code class="language-plaintext highlighter-rouge">:readers</code> map gets merged with a global map
of custom tags.</p>

<h2 id="motivation">Motivation</h2>

<p>Aside from jokes, this library might save your day. I often see people dump data
into .edn files, and the data has atoms, regular expressions, exceptions, and
other unreadable types:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">spit</span><span class="w"> </span><span class="s">"data.edn"</span><span class="w">
      </span><span class="p">(</span><span class="nb">with-out-str</span><span class="w">
        </span><span class="p">(</span><span class="nf">clojure.pprint/pprint</span><span class="w">
          </span><span class="p">{</span><span class="no">:regex</span><span class="w"> </span><span class="o">#</span><span class="s">"foobar"</span><span class="w">
           </span><span class="no">:atom</span><span class="w"> </span><span class="p">(</span><span class="nf">atom</span><span class="w"> </span><span class="mi">42</span><span class="p">)</span><span class="w">
           </span><span class="no">:error</span><span class="w"> </span><span class="p">(</span><span class="nf">ex-info</span><span class="w"> </span><span class="s">"boom"</span><span class="w"> </span><span class="p">{</span><span class="no">:test</span><span class="w"> </span><span class="mi">1</span><span class="p">})})))</span><span class="w">

</span><span class="p">(</span><span class="nb">println</span><span class="w"> </span><span class="p">(</span><span class="nb">slurp</span><span class="w"> </span><span class="s">"data.edn"</span><span class="p">))</span><span class="w">

</span><span class="p">{</span><span class="no">:regex</span><span class="w"> </span><span class="o">#</span><span class="s">"foobar"</span><span class="n">,</span><span class="w"> </span><span class="no">:atom</span><span class="w"> </span><span class="o">#</span><span class="n">&lt;Atom</span><span class="o">@</span><span class="mi">4</span><span class="n">f7aa8aa</span><span class="err">:</span><span class="w"> </span><span class="mi">42</span><span class="n">&gt;,</span><span class="w"> </span><span class="no">:error</span><span class="w"> </span><span class="o">#</span><span class="n">error</span><span class="w"> </span><span class="p">{</span><span class="w">
 </span><span class="no">:cause</span><span class="w"> </span><span class="s">"boom"</span><span class="w">
 </span><span class="no">:data</span><span class="w"> </span><span class="p">{</span><span class="no">:test</span><span class="w"> </span><span class="mi">1</span><span class="p">}</span><span class="w">
 </span><span class="no">:via</span><span class="w">
 </span><span class="p">[{</span><span class="no">:type</span><span class="w"> </span><span class="n">clojure.lang.ExceptionInfo</span><span class="w">
   </span><span class="no">:message</span><span class="w"> </span><span class="s">"boom"</span><span class="w">
   </span><span class="no">:data</span><span class="w"> </span><span class="p">{</span><span class="no">:test</span><span class="w"> </span><span class="mi">1</span><span class="p">}</span><span class="w">
   </span><span class="no">:at</span><span class="w"> </span><span class="p">[</span><span class="n">user$eval43373$fn__43374</span><span class="w"> </span><span class="n">invoke</span><span class="w"> </span><span class="s">"form-init6283045849674730121.clj"</span><span class="w"> </span><span class="mi">2248</span><span class="p">]}]</span><span class="w">
 </span><span class="no">:trace</span><span class="w">
 </span><span class="p">[[</span><span class="n">user$eval43373$fn__43374</span><span class="w"> </span><span class="n">invoke</span><span class="w"> </span><span class="s">"form-init6283045849674730121.clj"</span><span class="w"> </span><span class="mi">2248</span><span class="p">]</span><span class="w">
  </span><span class="p">[</span><span class="n">user$eval43373</span><span class="w"> </span><span class="n">invokeStatic</span><span class="w"> </span><span class="s">"form-init6283045849674730121.clj"</span><span class="w"> </span><span class="mi">2244</span><span class="p">]</span><span class="w">
  </span><span class="c1">;; truncated</span><span class="w">
  </span><span class="p">[</span><span class="n">clojure.lang.AFn</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="s">"AFn.java"</span><span class="w"> </span><span class="mi">22</span><span class="p">]</span><span class="w">
  </span><span class="p">[</span><span class="n">java.lang.Thread</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="s">"Thread.java"</span><span class="w"> </span><span class="mi">833</span><span class="p">]]}}</span><span class="w">
</span></code></pre></div></div>

<p>This dump cannot be read back due to:</p>

<ol>
  <li>unknown <code class="language-plaintext highlighter-rouge">#"foobar"</code> tag (EDN doesn’t support regex);</li>
  <li>broken <code class="language-plaintext highlighter-rouge">#&lt;Atom@4f7aa8aa: 42&gt;</code> expression;</li>
  <li>unknown <code class="language-plaintext highlighter-rouge">#error</code> tag.</li>
</ol>

<p>But with Taggie, the same data produces tagged fields that <strong>can</strong> be read back.</p>

<h2 id="supported-types">Supported Types</h2>

<p>In alphabetic order:</p>

<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Example</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">java.nio.ByteBuffer</code></td>
      <td><code class="language-plaintext highlighter-rouge">#ByteBuffer [0 1 2]</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">java.util.Date</code></td>
      <td><code class="language-plaintext highlighter-rouge">#Date "2025-01-06T14:03:23.819Z"</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">java.time.Duration</code></td>
      <td><code class="language-plaintext highlighter-rouge">#Duration "PT72H"</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">java.io.File</code></td>
      <td><code class="language-plaintext highlighter-rouge">#File "/path/to/file.txt"</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">java.time.Instant</code></td>
      <td><code class="language-plaintext highlighter-rouge">#Instant "2025-01-06T14:03:23.819994Z"</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">java.time.LocalDate</code></td>
      <td><code class="language-plaintext highlighter-rouge">#LocalDate "2034-01-30"</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">java.time.LocalDateTime</code></td>
      <td><code class="language-plaintext highlighter-rouge">#LocalDateTime "2025-01-08T11:08:13.232516"</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">java.time.LocalTime</code></td>
      <td><code class="language-plaintext highlighter-rouge">#LocalTime "20:30:56.928424"</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">java.time.MonthDay</code></td>
      <td><code class="language-plaintext highlighter-rouge">#MonthDay "--02-07"</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">java.time.OffsetDateTime</code></td>
      <td><code class="language-plaintext highlighter-rouge">#OffsetDateTime "2025-02-07T20:31:22.513785+04:00"</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">java.time.OffsetTime</code></td>
      <td><code class="language-plaintext highlighter-rouge">#OffsetTime "20:31:39.516036+03:00"</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">java.time.Period</code></td>
      <td><code class="language-plaintext highlighter-rouge">#Period "P1Y2M3D"</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">java.net.URI</code></td>
      <td><code class="language-plaintext highlighter-rouge">#URI "foobar://test.com/path?foo=1"</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">java.net.URL</code></td>
      <td><code class="language-plaintext highlighter-rouge">#URL "https://clojure.org"</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">java.time.Year</code></td>
      <td><code class="language-plaintext highlighter-rouge">#Year "2025"</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">java.time.YearMonth</code></td>
      <td><code class="language-plaintext highlighter-rouge">#YearMonth "2025-02"</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">java.time.ZoneId</code></td>
      <td><code class="language-plaintext highlighter-rouge">#ZoneId "Europe/Paris"</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">java.time.ZoneOffset</code></td>
      <td><code class="language-plaintext highlighter-rouge">#ZoneOffset "-08:00"</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">java.time.ZonedDateTime</code></td>
      <td><code class="language-plaintext highlighter-rouge">#ZonedDateTime "2025-02-07T20:32:33.309294+01:00[Europe/Paris]"</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">clojure.lang.Atom</code></td>
      <td><code class="language-plaintext highlighter-rouge">#atom {:inner 'state}</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">boolean[]</code></td>
      <td><code class="language-plaintext highlighter-rouge">#booleans [true false]</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">byte[]</code></td>
      <td><code class="language-plaintext highlighter-rouge">#bytes [1 2 3]</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">char[]</code></td>
      <td><code class="language-plaintext highlighter-rouge">#chars [\a \b \c]</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">double[]</code></td>
      <td><code class="language-plaintext highlighter-rouge">#doubles [1.1 2.2 3.3]</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">Throwable-&gt;map</code></td>
      <td><code class="language-plaintext highlighter-rouge">#error &lt;result of Throwable-&gt;map&gt;</code> (see below)</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">float[]</code></td>
      <td><code class="language-plaintext highlighter-rouge">#floats [1.1 2.2 3.3]</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">int[]</code></td>
      <td><code class="language-plaintext highlighter-rouge">#ints [1 2 3]</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">long[]</code></td>
      <td><code class="language-plaintext highlighter-rouge">#longs [1 2 3]</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">Object[]</code></td>
      <td><code class="language-plaintext highlighter-rouge">#objects ["test" :foo 42 #atom false]</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">clojure.lang.Ref</code></td>
      <td><code class="language-plaintext highlighter-rouge">#ref {:test true}</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">java.util.regex.Pattern</code></td>
      <td><code class="language-plaintext highlighter-rouge">#regex "vesion: \d+"</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">java.sql.Timestamp</code></td>
      <td><code class="language-plaintext highlighter-rouge">#sql/Timestamp "2025-01-06T14:03:23.819Z"</code></td>
    </tr>
  </tbody>
</table>

<p>The <code class="language-plaintext highlighter-rouge">#error</code> tag is a bit special: it returns a value with no parsing. It
prevents an error when reading the result of printing of an exception:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nb">println</span><span class="w"> </span><span class="p">(</span><span class="nf">ex-info</span><span class="w"> </span><span class="s">"boom"</span><span class="w"> </span><span class="p">{</span><span class="no">:test</span><span class="w"> </span><span class="mi">123</span><span class="p">}))</span><span class="w">

</span><span class="o">#</span><span class="n">error</span><span class="w"> </span><span class="p">{</span><span class="w">
 </span><span class="no">:cause</span><span class="w"> </span><span class="n">boom</span><span class="w">
 </span><span class="no">:data</span><span class="w"> </span><span class="p">{</span><span class="no">:test</span><span class="w"> </span><span class="mi">123</span><span class="p">}</span><span class="w">
 </span><span class="no">:via</span><span class="w">
 </span><span class="p">[{</span><span class="no">:type</span><span class="w"> </span><span class="n">clojure.lang.ExceptionInfo</span><span class="w">
   </span><span class="no">:message</span><span class="w"> </span><span class="n">boom</span><span class="w">
   </span><span class="no">:data</span><span class="w"> </span><span class="p">{</span><span class="no">:test</span><span class="w"> </span><span class="mi">123</span><span class="p">}</span><span class="w">
   </span><span class="no">:at</span><span class="w"> </span><span class="p">[</span><span class="n">taggie.edn$eval9263</span><span class="w"> </span><span class="n">invokeStatic</span><span class="w"> </span><span class="n">form-init2367470449524935680.clj</span><span class="w"> </span><span class="mi">97</span><span class="p">]}]</span><span class="w">
 </span><span class="no">:trace</span><span class="w">
 </span><span class="p">[[</span><span class="n">taggie.edn$eval9263</span><span class="w"> </span><span class="n">invokeStatic</span><span class="w"> </span><span class="n">form-init2367470449524935680.clj</span><span class="w"> </span><span class="mi">97</span><span class="p">]</span><span class="w">
  </span><span class="p">[</span><span class="n">taggie.edn$eval9263</span><span class="w"> </span><span class="n">invoke</span><span class="w"> </span><span class="n">form-init2367470449524935680.clj</span><span class="w"> </span><span class="mi">97</span><span class="p">]</span><span class="w">
  </span><span class="c1">;; truncated</span><span class="w">
  </span><span class="p">[</span><span class="n">java.lang.Thread</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">Thread.java</span><span class="w"> </span><span class="mi">833</span><span class="p">]]}</span><span class="w">
</span></code></pre></div></div>

<p>When reading such data from EDN with Taggie, you’ll get a regular map.</p>

<h2 id="adding-your-types">Adding Your Types</h2>

<p>Imagine you have a custom type and you want Taggie to hande it:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">deftype</span><span class="w"> </span><span class="n">SomeType</span><span class="w"> </span><span class="p">[</span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="n">c</span><span class="p">])</span><span class="w">

</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">some-type</span><span class="w">
  </span><span class="p">(</span><span class="nb">new</span><span class="w"> </span><span class="n">SomeType</span><span class="w"> </span><span class="p">(</span><span class="nf">atom</span><span class="w"> </span><span class="no">:test</span><span class="p">)</span><span class="w">
                </span><span class="p">(</span><span class="nf">LocalDate/parse</span><span class="w"> </span><span class="s">"2023-01-03"</span><span class="p">)</span><span class="w">
                </span><span class="p">(</span><span class="nf">long-array</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="p">])))</span><span class="w">
</span></code></pre></div></div>

<p>To override the way it gets printed, run the <code class="language-plaintext highlighter-rouge">defprint</code> macro:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">taggie.print/defprint</span><span class="w"> </span><span class="n">SomeType</span><span class="w"> </span><span class="o">^</span><span class="n">SomeType</span><span class="w"> </span><span class="n">some-type</span><span class="w"> </span><span class="n">writer</span><span class="w">
  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">a</span><span class="w"> </span><span class="p">(</span><span class="nf">.-a</span><span class="w"> </span><span class="n">some-type</span><span class="p">)</span><span class="w">
        </span><span class="n">b</span><span class="w"> </span><span class="p">(</span><span class="nf">.-b</span><span class="w"> </span><span class="n">some-type</span><span class="p">)</span><span class="w">
        </span><span class="n">c</span><span class="w"> </span><span class="p">(</span><span class="nf">.-c</span><span class="w"> </span><span class="n">some-type</span><span class="p">)]</span><span class="w">
    </span><span class="p">(</span><span class="nf">.write</span><span class="w"> </span><span class="n">writer</span><span class="w"> </span><span class="s">"#SomeType "</span><span class="p">)</span><span class="w">
    </span><span class="p">(</span><span class="nf">print-method</span><span class="w"> </span><span class="p">[</span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="n">c</span><span class="p">]</span><span class="w"> </span><span class="n">writer</span><span class="p">)))</span><span class="w">
</span></code></pre></div></div>

<p>The first argument is a symbol bound to a class. The second is a symbol bound to
the instance of this class (in some cases you’ll need a type hint). The third
symbol is bound to the <code class="language-plaintext highlighter-rouge">Writer</code> instance. Inside the macro, you <code class="language-plaintext highlighter-rouge">.write</code> certain
values into the writer. Avobe, we write the leading <code class="language-plaintext highlighter-rouge">"#SomeType "</code> string, and a
vector of fields <code class="language-plaintext highlighter-rouge">a</code>, <code class="language-plaintext highlighter-rouge">b</code> and <code class="language-plaintext highlighter-rouge">c</code>. Calling <code class="language-plaintext highlighter-rouge">print-method</code> guarantees that all
nested data will be written with their custom tags.</p>

<p>Now if you print <code class="language-plaintext highlighter-rouge">some-type</code> or dump it into EDN, you’ll get:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">#</span><span class="n">SomeType</span><span class="w"> </span><span class="p">[</span><span class="o">#</span><span class="n">atom</span><span class="w"> </span><span class="no">:test</span><span class="w"> </span><span class="o">#</span><span class="n">LocalDate</span><span class="w"> </span><span class="s">"2023-01-03"</span><span class="w"> </span><span class="o">#</span><span class="n">longs</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="p">]]</span><span class="w">
</span></code></pre></div></div>

<p>The opposite step: define readers for <code class="language-plaintext highlighter-rouge">SomeType</code> class:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">taggie.readers/defreader</span><span class="w"> </span><span class="n">SomeType</span><span class="w"> </span><span class="p">[</span><span class="n">vect</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[[</span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="n">c</span><span class="p">]</span><span class="w"> </span><span class="n">vect</span><span class="p">]</span><span class="w">
    </span><span class="p">(</span><span class="nb">new</span><span class="w"> </span><span class="n">SomeType</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="n">c</span><span class="p">)))</span><span class="w">
</span></code></pre></div></div>

<p>It’s quite simple: the vector of fields is already parsed, so you only need to
split it and pass fields into the constructor.</p>

<p>The <code class="language-plaintext highlighter-rouge">defreader</code> mutates a global map of EDN readers. When you read an EDN
string, the <code class="language-plaintext highlighter-rouge">SomeType</code> will be held. But it won’t work in REPL: for example,
running <code class="language-plaintext highlighter-rouge">#SomeType [...]</code> in REPL will throw an error. The thing is, REPL
readers cannot be overriden in runtime.</p>

<p>But you can declare your own readers: in <code class="language-plaintext highlighter-rouge">src</code> directory, create a file called
<code class="language-plaintext highlighter-rouge">data_readers.clj</code> with a map:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="n">SomeType</span><span class="w"> </span><span class="n">some.namespace/__reader-SomeType-clj</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Restart the REPL, and now the tag will be available.</p>

<p>As you might have guessed, the <code class="language-plaintext highlighter-rouge">defreader</code> macro creates two functions:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">__reader-&lt;tag&gt;-clj</code> for a REPL reader;</li>
  <li><code class="language-plaintext highlighter-rouge">__reader-&lt;tag&gt;-edn</code> for an EDN reader.</li>
</ul>

<p>Each <code class="language-plaintext highlighter-rouge">-clj</code> reader relies on a corresponding <code class="language-plaintext highlighter-rouge">-edn</code> reader internally.</p>

<p><strong>Emacs &amp; Cider caveat:</strong> I noticed that <code class="language-plaintext highlighter-rouge">M-x cider-ns-refresh</code> command ruins
loading REPL tags. After this command being run, any attempt to execute
something like <code class="language-plaintext highlighter-rouge">#LocalDate "..."</code> ends up with an error saying “unbound
function”. Thus, if you use Emacs and Cider, avoid this command.</p>

    
<div class="prev-next">

    <div class="prev-next-left">
    
        <p><small><a href="/just-use-postgres/">&larr; Просто берите Postgres</a></small></p>
    
    </div>

    <div class="prev-next-mid">
    </div>

    <div class="prev-next-right">
    
        <p><small><a href="/corp-update/">Корпоративные обновления &rarr;</a></small></p>
    
    </div>

</div>

  </div>

</article>

<center>
    <p>
        <small>Нашли ошибку? Выделите мышкой и нажмите Ctrl/&#8984;+Enter</small>
    </p>
</center>





<center>
    
    Комментарии
    
    
</center>



<div id="comments">
  
    <div id="comment-1739113655148" class="comment-block">
      <p class="comment-lead">
        <small>
          <em>
            D,
            9th Feb 2025,
            <a href="#comment-1739113655148">link</a>
            
          </em>
        </small>
      </p>
      <div><p>Have you considered using a prefix in the tag, to avoid conflicting with built-ins reserved by EDN itself?</p>
</div>
    </div>
  
    <div id="comment-1739119011554" class="comment-block">
      <p class="comment-lead">
        <small>
          <em>
            Ivan Grishae,
            9th Feb 2025,
            <a href="#comment-1739119011554">link</a>
            
          </em>
        </small>
      </p>
      <div><p>Actually, none of these tags conflicts with default EDN tags, so I think we’re fine.</p>

</div>
    </div>
  
    <div id="comment-1739180275066" class="comment-block">
      <p class="comment-lead">
        <small>
          <em>
            D,
            10th Feb 2025,
            <a href="#comment-1739180275066">link</a>
            
          </em>
        </small>
      </p>
      <div><p>There are no conflicts now, but the EDN spec reserves un-prefixed tags for future built-ins:</p>

<blockquote>
  <p>Tag symbols without a prefix are reserved by edn for built-ins defined using the tag system.</p>
</blockquote>

<blockquote>
  <p>User tags must contain a prefix component, which must be owned by the user (e.g. trademark or domain) or known unique in the communication context.</p>
</blockquote>

<p>from <a href="https://github.com/edn-format/edn?tab=readme-ov-file#rules-for-tags">rules for tags</a></p>

<p>It’s the kind of thing that doesn’t matter until it matters a lot, so would prohibit a lot of people from using this in production.</p>
</div>
    </div>
  
    <div id="comment-1739189335732" class="comment-block">
      <p class="comment-lead">
        <small>
          <em>
             Ivan Grishaev,
            10th Feb 2025,
            <a href="#comment-1739189335732">link</a>
            
          </em>
        </small>
      </p>
      <div><p>Yeah, I know all this… that’s why this library is just an experiment. Anyway, the very system of readers and tags in Clojure looks a bit unclear to me, so personally I would not rely on it a lot.</p>

</div>
    </div>
  
</div>









<form id="comment-form" method="POST" action="https://functions.yandexcloud.net/d4ehfuf08fjfjr59ivnf">

    <div class="block">
        <p class="comment-form-label"><small>Your name</small></p>
        <input required id="comment-form-author" name="author" type="text">
    </div>

    <div class="block">
        <p class="comment-form-label"><small>Comment (markdown syntax)</small></p>
        <textarea required id="comment-form-comment" name="comment"></textarea>
    </div>

    <input required name="path" type="hidden" value="/clj-taggie/">
    <input required name="captcha" type="hidden" value="8 &#215; 7">

    <div class="block">
        <span class="comment-form-label"><small>8 &#215; 7 = </small></span>
        <input required id="comment-form-solution" name="solution" type="text">
    </div>

    <div class="block">
        <button id="comment-form-send" type="submit">Send</button>
    </div>

</form>


      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Ivan Grishaev's blog</li>
          <li><a href="mailto:ivan@grishaev.me">ivan@grishaev.me</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
            <li><a href="https://github.com/igrishaev">GitHub</a></li>
            <li><a href="https://t.me/igrishaev_blog">Telegram</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Writing on programming, education, books and negotiations.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
