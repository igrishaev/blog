<!DOCTYPE html>
<html lang="ru">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Ivan Grishaev's blog</title>
  <meta name="description" content="Writing on programming, education, books and negotiations.
">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/custom.css">
  <link rel="canonical" href="https://grishaev.me/page35/">
  <link rel="alternate" type="application/rss+xml" title="Ivan Grishaev's blog" href="https://grishaev.me/feed.xml">

  <link rel="shortcut icon" type="image/x-icon" href="/assets/static/favicons/favicon.ico">

  <script type="text/javascript" src="/assets/typo.js"></script>

</head>


  <body>
    <header class="site-header">

    <div class="wrapper flex-container">

        <div>
            <a href="/">
                <img id="avatar" src="/assets/static/avatar.jpg" alt="Ivan Grishaev">
            </a>
        </div>

        <div class="flex-container-vert" style="margin-left: 15px; width: 80%">

            <div class="flex-container full-width">
                <p style="margin-bottom: 5px"><a href="/">Ivan Grishaev's blog</a></p>
                <div class="flex-huge"></div>
                <div >
<form id="search-form"
      target="_blank"
      style="display: inline"
      method="get"
      action="https://www.google.com/search">

    <input name="sitesearch"
           value="grishaev.me"
           type="hidden">

    <input type="text"
           required="required"
           name="q"
           placeholder="Google search..."
           autocomplete="off">

    <button style="border: none; background-color: transparent; cursor: pointer;"
            type="submit">&#x1f50d;</button>

</form>
</div>
            </div>

            <p><small>Writing on programming, education, books and negotiations.
</small></p>

            <div class="flex-container">
                <a class="menu-item" href="/">Home</a>
                <a class="menu-item" href="/about/">About</a>
                <a class="menu-item" href="/open-source/">Open Source</a>
                <a class="menu-item" href="/bookshelf/">Bookshelf</a>
                <a class="menu-item" href="/feed.xml">RSS</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor" href="/tag/clojure/">Clojure</a>
                <a class="menu-item minor" href="/tag/emacs/">Emacs</a>
                <a class="menu-item minor" href="/tag/python/">Python</a>
                <a class="menu-item minor" href="/tag/programming/">Programming</a>
                <a class="menu-item minor" href="/interview/">Interview</a>
                <a class="menu-item minor" href="/video/">Video</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor hl" href="/clojure-in-prod/">Книга «Clojure на производстве»</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor hl" href="/clojure-in-prod-2/">Книга «Clojure на производстве», второй том</a>
            </div>

        </div>
    </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="home">

    <ul class="post-list">
        
        <li>

            <h2>
                <a class="post-link" href="/firewall/">Фаервол</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2023-09-27T00:00:00+00:00">
        Sep 27, 2023
    </time>

    <a href="/tag/macos/" rel="tag">macos</a>, <a href="/tag/firewall/" rel="tag">firewall</a>, <a href="/tag/lulu/" rel="tag">lulu</a>

</div>


            <div class="entry">
                
                    <p>Лучшая вещь, что случилась со мной в последнее время — это установка фаервола на
всех маках. Вот как это произошло.</p>

<p>Когда-то я жаловался, что программы без спроса лезут в интернет
обновляться. Открыл Саблайм — а он показывает модалку, что вышла новая
версия. Открыл то, другое, а там то же самое: скачай-обновись.</p>

<p>Идея как это победить простая — нужно отобрать у программы доступ в интернет. Я
пошел настраивать встроенный фаервол, но оказалось, он убогий: закрывает только
входящие соединения, а исходящие не трогает. В результате даже если добавить в
список программу, она спокойно идет в сеть.</p>

<p>Путем гугления нашел программу Lulu. Хоть название и затасканное, программа
просто супер: удобный интерфейс и настройка. Lulu делит программы на группы:
родные Эпла, уже установленные и другие. Можно включать и выключать целые
группы, а можно по отдельности. Правила формируются в разрезе программ, папок,
регулярных выражений.</p>

<p>Можно настроить гибкий контроль по урлам. Например, дать программе доступ к
хосту <code class="language-plaintext highlighter-rouge">sync.blabla.com</code> для синхронизации, но запретить обновления по хосту
<code class="language-plaintext highlighter-rouge">update.blabla.com</code>.</p>

<p>Можно дать временный доступ по номеру процесса. Когда программа запуститься в
cледующий раз, номер будет другим, и Lulu спросит опять.</p>

<p>Фаервол может работать в интерактивном режиме, показывая диалог на события,
которых нет в правилах, а может молча разрешать или разрешать все, что
происходит.</p>

<p>Для себя я сделал так: удалил все правила, кроме Эпловских, а затем настраивал
вручную. Запретил все программы Адоба, офисного пакета, всякие редакторы вроде
Саблайма — их задача работать с текстом, а не лазить за обновлениями. Запретил
обновки для Dash, программы оффлайн-документации, и много что другое.</p>

<p>На старом ноуте обнаружил несколько вирусов. Это программы с названиями типа
robstoaf, прописанные в автозагрузке. Время от времени они ходят в сеть на левые
хосты. Возможно, крадут историю браузеров или это ботнет. Так что не слушайте
байки про то, что под Мак вирусов нет.</p>

<p>Что немаловажно, Lulu запрашивает подтверждение, когда левая программа хочет
добавить себя в автозагрузку. Всякое дерьмо вроде Zoom, MS Teams прописывают
себя там, и в итоге запускаются в фоне, даже если вы не просили. Больше этого
беспредела нет.</p>

<p>Программа так понравилась, что я хотел перевести автору денег, долларов
сто. Хотел скинуть с Пейпала, а у него только патреон — то есть регистрируйся,
вводи персональные данные, карту, подтверждай — извините, нет.</p>

<p>Кроме Lulu, у автора есть смежные утилиты для безопасности, например монитор
клавиатуры на предмет прослушки и что-то еще второстепенное.</p>

<p>Словом, не знаю как жить без Lulu: теперь это первая программа, которую я ставлю
на Мак. Как раз недавно ставил ее на свежий ноут. Неистово рекомендую!</p>

<p>Картинки, описание и загрузка здесь:
https://objective-see.org/products/lulu.html</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/css-awesome/">CSS is Awesome</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2023-09-27T00:00:00+00:00">
        Sep 27, 2023
    </time>

    <a href="/tag/css/" rel="tag">css</a>, <a href="/tag/awesome/" rel="tag">awesome</a>, <a href="/tag/mem/" rel="tag">mem</a>

</div>


            <div class="entry">
                
                    <p>Все видели картинку, где текст из заголовка не влезает в рамку. Ха-ха, кривой CSS,
технологии, <a href="/we-deserve/">которые мы заслужили</a> (с).</p>

<p><img src="/assets/static/aws/css/1.jpeg" /></p>

<p>Хорошо, посмеялись, а теперь вопрос: как должно быть?</p>

<p>Представим, вы всемогущий бог, все браузеры мира под вашим контролем.  Щелкните
пальцами — и у всех эта картинка покажется так, как вы скажете. Что предпочтете?</p>

<p>Проблема в том, что на картинке типичное UB — undefined behaviour,
неопределенные поведение. В литровую банку пытаются налить два литра воды.
Простыми словами, впихнуть невпихуемое. Это невозможно, поэтому кто-то окажется
в проигрыше.</p>

<p>На самом деле на картинке все правильно: при всем уродстве мы смогли прочитать
текст. Если бы он был обрезан, мы бы его не увидели, то есть не получили бы
вообще ничего. А так получили хотя бы часть, пусть и фраза там бестолковая.</p>

<p>Эту картинку я считаю крайне неудачной. Кто-то хотел пошутить, что CSS глючный,
но выбрал плохой пример: выставил дурацкие ограничения (малую рамку и огромный
шрифт) и смотрит, как программа не справляется. А она, между прочим, справилась
— донесла до нас текст.</p>

<p>Так что шутка на троечку.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/bomb-movie/">Фильмы про бомбу</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2023-09-27T00:00:00+00:00">
        Sep 27, 2023
    </time>

    <a href="/tag/bomb/" rel="tag">bomb</a>, <a href="/tag/movies/" rel="tag">movies</a>

</div>


            <div class="entry">
                
                    <p>В фильмах про ядерную бомбу повторяется дурацкий штамп. Якобы ученый работает из
интереса, не задумываясь над последствиями, только по зову сердца. Но ВНЕЗАПНО,
эффект превосходит все ожидания, бомба оказывается разрушительной, подтягиваются
политики, и ученый такой — ох, что я наделал, нельзя допустить,
АСТАНАВИТЕСЬ!!!111 Всякие метания и попытки вернуть все взад.</p>

<p>Это чушь собачья. Ученые прекрасно понимают, над чем они работают, а штамп нужен
для того, чтобы высосать драму из пальца. Взять того же Фейнмана: после бомбы он
и преподавал, и клеил женщин пачками, и два раза женился, и танцевал, играл,
разгадывал секреты Майя и много что еще.</p>

<p>Так что не надо этой лапши про внезапное прозрение. Ну а если с кем-то и правда
такое было, то надо было думать раньше.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/en/with-http/">With-http: a Clojure library for testing HTTP</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2023-09-21T00:00:00+00:00">
        Sep 21, 2023
    </time>

    <a href="/tag/clojure/" rel="tag">clojure</a>, <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/tests/" rel="tag">tests</a>, <a href="/tag/http/" rel="tag">http</a>

</div>


            <div class="entry">
                
                    
<p>The <a href="https://github.com/igrishaev/with-http">with-http library</a> provides a macro to stub HTTP calls with a
local Jetty server. it’s declarative, flexible, and extremely useful. I’ve been
copying it through many projects, and now it’s time to ship it as a standalone
library.</p>

<p><strong>ToC</strong></p>

<!-- toc -->

<ul>
  <li><a href="#installation">Installation</a></li>
  <li><a href="#about">About</a></li>
  <li><a href="#the-app-routes">The App routes</a></li>
  <li><a href="#default-handler">Default handler</a></li>
  <li><a href="#basic-test">Basic test</a></li>
  <li><a href="#json">JSON</a></li>
  <li><a href="#slow-responses">Slow responses</a></li>
  <li><a href="#files--resources">Files &amp; Resources</a></li>
  <li><a href="#capturing-requests">Capturing requests</a></li>
</ul>

<!-- tocstop -->

<h2 id="installation">Installation</h2>

<p>Lein:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="n">com.github.igrishaev/with-http</span><span class="w"> </span><span class="s">"0.1.1"</span><span class="p">]</span><span class="w">
</span></code></pre></div></div>

<p>Deps.edn</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="n">com.github.igrishaev/with-http</span><span class="w"> </span><span class="p">{</span><span class="no">:mvn/version</span><span class="w"> </span><span class="s">"0.1.1"</span><span class="p">}}</span><span class="w">
</span></code></pre></div></div>

<p><em>Pay attention</em>: since the library is primarily used for tests, put the
dependency in the corresponding profile or alias. Storing it in global
dependencies is not a good idea as it becomes a part of the production code
otherwise.</p>

<h2 id="about">About</h2>

<p>The library provides a <code class="language-plaintext highlighter-rouge">with-http</code> macro of the following form:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">with-http</span><span class="w"> </span><span class="p">[</span><span class="n">port</span><span class="w"> </span><span class="n">app</span><span class="p">]</span><span class="w">
  </span><span class="n">...body</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">port</code> is the number (1..65535) and the <code class="language-plaintext highlighter-rouge">app</code> is a map of routes. When
entering the macro, it spawns a local Jetty server on that port in the
background. The <code class="language-plaintext highlighter-rouge">app</code> map tells the server how to respond to calls.</p>

<p>Now that you have a running server, point your HTTP API clients to
<code class="language-plaintext highlighter-rouge">http://localhost:&lt;port&gt;</code> to imitate real network interaction. For example, for
prod, a third-party base URL is https://api.some.cool.service but for tests, it
is http://localhost:8088. This can be done using environment variables or the
<a href="https://github.com/juxt/aero">Aero library</a>.</p>

<p>Why not use <code class="language-plaintext highlighter-rouge">with-redefs</code>, would you ask? Well, although <code class="language-plaintext highlighter-rouge">with-redefs</code> looks like a solution at first glance, it’s questionable. Using <code class="language-plaintext highlighter-rouge">with-redefs</code> means lying to yourself. You temporarily
mute some pieces of the codebase pretending it’s OK, but it’s not.</p>

<p>Often, bugs lurk in the code that you actually substitute using <code class="language-plaintext highlighter-rouge">with-redefs</code>,
namely:</p>

<ul>
  <li>
    <p>you’ve messed up with MD5/SHA/etc algorithms to sign a request. Calling
localhost would trigger that code and lead to an exception, but <code class="language-plaintext highlighter-rouge">with-redefs</code>
would not.</p>
  </li>
  <li>
    <p>you process the response poorly, e.g. not taking Content-Type header or
non-200 status code into account.</p>
  </li>
  <li>
    <p>you cannot imitate delays and timeout exceptions when interacting with HTTP
API.</p>
  </li>
</ul>

<p>The good news is, that the <code class="language-plaintext highlighter-rouge">with-http</code> macro can test all the cases mentioned above and much more.</p>

<h2 id="the-app-routes">The App routes</h2>

<p>The <code class="language-plaintext highlighter-rouge">app</code> parameter is a two-level map of the form:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="nb">path</span><span class="w"> </span><span class="p">{</span><span class="n">method</span><span class="w"> </span><span class="n">response</span><span class="p">}}</span><span class="w">
</span></code></pre></div></div>

<p>For example:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="s">"/foo"</span><span class="w"> </span><span class="p">{</span><span class="no">:get</span><span class="w"> </span><span class="p">{</span><span class="no">:status</span><span class="w"> </span><span class="mi">200</span><span class="w"> </span><span class="no">:body</span><span class="w"> </span><span class="s">"it was GET"</span><span class="p">}</span><span class="w">
         </span><span class="no">:post</span><span class="w"> </span><span class="p">{</span><span class="no">:status</span><span class="w"> </span><span class="mi">201</span><span class="w"> </span><span class="no">:body</span><span class="w"> </span><span class="s">"it was POST"</span><span class="p">}}}</span><span class="w">
</span></code></pre></div></div>

<p>Calling <code class="language-plaintext highlighter-rouge">GET /foo</code> and <code class="language-plaintext highlighter-rouge">POST /foo</code> would return 200 and 201 status codes with
different messages.</p>

<p>The response might be:</p>

<ul>
  <li>a Ring map;</li>
  <li>a Ring handler function that accepts a request map and returns a response map;</li>
  <li>an instance of <code class="language-plaintext highlighter-rouge">java.io.File</code>;</li>
  <li>a resource: <code class="language-plaintext highlighter-rouge">(clojure.java.io/resource "some/file.txt")</code>;</li>
  <li>a string.</li>
</ul>

<p>Other examples:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="s">"/foo"</span><span class="w"> </span><span class="p">{</span><span class="no">:get</span><span class="w"> </span><span class="p">(</span><span class="k">fn</span><span class="w"> </span><span class="p">[{</span><span class="no">:keys</span><span class="w"> </span><span class="p">[</span><span class="n">params</span><span class="p">]}]</span><span class="w">
                </span><span class="p">(</span><span class="nf">log/infof</span><span class="w"> </span><span class="s">"Params: %s"</span><span class="w"> </span><span class="n">params</span><span class="p">)</span><span class="w">
                </span><span class="p">{</span><span class="no">:status</span><span class="w"> </span><span class="mi">200</span><span class="w"> </span><span class="no">:body</span><span class="w"> </span><span class="s">"OK"</span><span class="p">})}}</span><span class="w">

</span><span class="p">{</span><span class="s">"/some/json"</span><span class="w"> </span><span class="p">{</span><span class="no">:get</span><span class="w"> </span><span class="p">(</span><span class="nf">io/resource</span><span class="w"> </span><span class="s">"file.json"</span><span class="p">)}}</span><span class="w">
</span></code></pre></div></div>

<p>The path might be a vector as well. During the preparation step, it will be
compiled into a string, for example:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{[</span><span class="s">"/foo/bar/"</span><span class="w"> </span><span class="mi">42</span><span class="w"> </span><span class="s">"/test"</span><span class="p">]</span><span class="w">
 </span><span class="p">{</span><span class="no">:get</span><span class="w"> </span><span class="p">{</span><span class="no">:status</span><span class="w"> </span><span class="mi">200</span><span class="w"> </span><span class="no">:body</span><span class="w"> </span><span class="s">"hello"</span><span class="p">}}}</span><span class="w">

</span><span class="c1">;; becomes</span><span class="w">

</span><span class="p">{</span><span class="s">"/foo/bar/42/test"</span><span class="w">
 </span><span class="p">{</span><span class="no">:get</span><span class="w"> </span><span class="p">{</span><span class="no">:status</span><span class="w"> </span><span class="mi">200</span><span class="w"> </span><span class="no">:body</span><span class="w"> </span><span class="s">"hello"</span><span class="p">}}}</span><span class="w">
</span></code></pre></div></div>

<p>This is useful when the paths contain parameters.</p>

<p>The <code class="language-plaintext highlighter-rouge">make-url</code> function helps to build a local URL like
<code class="language-plaintext highlighter-rouge">http://localhost:&lt;port&gt;/&lt;path&gt;</code>. Its second <code class="language-plaintext highlighter-rouge">path</code> argument is either a string
or a vector which gets compiled into a string:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">make-url</span><span class="w"> </span><span class="n">PORT</span><span class="w"> </span><span class="s">"/foo?a=1&amp;b=2"</span><span class="p">)</span><span class="w">
</span><span class="c1">;; http://localhost:8899/foo?a=1&amp;b=2</span><span class="w">

</span><span class="p">(</span><span class="nf">make-url</span><span class="w"> </span><span class="mi">8899</span><span class="w"> </span><span class="p">[</span><span class="s">"/users/"</span><span class="w"> </span><span class="mi">42</span><span class="w"> </span><span class="s">"/reports/"</span><span class="w"> </span><span class="mi">99999</span><span class="p">])</span><span class="w">
</span><span class="c1">;; http://localhost:8899/users/42/reports/99999</span><span class="w">
</span></code></pre></div></div>

<h2 id="default-handler">Default handler</h2>

<p>The App mapping has a default handler which gets triggered when the client calls
a non-existing route. By default, it’s 404 status page with the following JSON
payload:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">NOT-FOUND</span><span class="w">
  </span><span class="p">{</span><span class="no">:status</span><span class="w"> </span><span class="mi">404</span><span class="w">
   </span><span class="no">:body</span><span class="w"> </span><span class="p">{</span><span class="no">:error</span><span class="w"> </span><span class="s">"with-http: route not found"</span><span class="p">}})</span><span class="w">
</span></code></pre></div></div>

<p>You can override it by adding the <code class="language-plaintext highlighter-rouge">:default</code> key to the app map. The value might
be a map, a function, a file and so on.</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="s">"/foo"</span><span class="w"> </span><span class="p">{</span><span class="no">:get</span><span class="w"> </span><span class="p">{</span><span class="no">:status</span><span class="w"> </span><span class="mi">200</span><span class="w"> </span><span class="no">:body</span><span class="w"> </span><span class="s">"hello"</span><span class="p">}}</span><span class="w">
 </span><span class="no">:default</span><span class="w"> </span><span class="p">{</span><span class="no">:status</span><span class="w"> </span><span class="mi">202</span><span class="w"> </span><span class="no">:body</span><span class="w"> </span><span class="s">"I'm the default!"</span><span class="p">}}</span><span class="w">
</span></code></pre></div></div>

<h2 id="basic-test">Basic test</h2>

<p>A simple test to ensure the macro works:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">deftest</span><span class="w"> </span><span class="n">test-with-http-test-json</span><span class="w">

  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">app</span><span class="w">
        </span><span class="p">{</span><span class="s">"/foo"</span><span class="w"> </span><span class="p">{</span><span class="no">:get</span><span class="w"> </span><span class="p">{</span><span class="no">:status</span><span class="w"> </span><span class="mi">200</span><span class="w">
                       </span><span class="no">:body</span><span class="w"> </span><span class="s">"test"</span><span class="p">}}}</span><span class="w">

        </span><span class="n">url</span><span class="w">
        </span><span class="p">(</span><span class="nf">make-url</span><span class="w"> </span><span class="n">PORT</span><span class="w"> </span><span class="s">"/foo"</span><span class="p">)</span><span class="w">

        </span><span class="p">{</span><span class="no">:keys</span><span class="w"> </span><span class="p">[</span><span class="n">status</span><span class="w"> </span><span class="n">body</span><span class="p">]}</span><span class="w">
        </span><span class="p">(</span><span class="nf">with-http</span><span class="w"> </span><span class="p">[</span><span class="n">PORT</span><span class="w"> </span><span class="n">app</span><span class="p">]</span><span class="w">
          </span><span class="p">(</span><span class="nf">client/get</span><span class="w"> </span><span class="n">url</span><span class="p">))]</span><span class="w">

    </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="mi">200</span><span class="w"> </span><span class="n">status</span><span class="p">))</span><span class="w">
    </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="s">"test"</span><span class="w"> </span><span class="n">body</span><span class="p">))))</span><span class="w">
</span></code></pre></div></div>

<h2 id="json">JSON</h2>

<p>The Ring handler function produced from the <code class="language-plaintext highlighter-rouge">app</code> mapping is wrapped with
<code class="language-plaintext highlighter-rouge">wrap-json-response</code> and <code class="language-plaintext highlighter-rouge">wrap-json-params</code> middleware layers. It means the body
of the response might be a collection that gets dumped into JSON:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">deftest</span><span class="w"> </span><span class="n">test-with-http-test-json</span><span class="w">

  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">body</span><span class="w">
        </span><span class="p">{</span><span class="no">:hello</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="s">"test"</span><span class="w"> </span><span class="n">true</span><span class="p">]}</span><span class="w">

        </span><span class="n">app</span><span class="w">
        </span><span class="p">{</span><span class="s">"/foo"</span><span class="w"> </span><span class="p">{</span><span class="no">:get</span><span class="w"> </span><span class="p">{</span><span class="no">:status</span><span class="w"> </span><span class="mi">200</span><span class="w">
                       </span><span class="no">:body</span><span class="w"> </span><span class="n">body</span><span class="p">}}}</span><span class="w">

        </span><span class="n">url</span><span class="w">
        </span><span class="p">(</span><span class="nf">make-url</span><span class="w"> </span><span class="n">PORT</span><span class="w"> </span><span class="s">"/foo"</span><span class="p">)</span><span class="w">

        </span><span class="p">{</span><span class="no">:keys</span><span class="w"> </span><span class="p">[</span><span class="n">status</span><span class="w"> </span><span class="n">body</span><span class="p">]}</span><span class="w">
        </span><span class="p">(</span><span class="nf">with-http</span><span class="w"> </span><span class="p">[</span><span class="n">PORT</span><span class="w"> </span><span class="n">app</span><span class="p">]</span><span class="w">
          </span><span class="p">(</span><span class="nf">client/get</span><span class="w"> </span><span class="n">url</span><span class="w"> </span><span class="p">{</span><span class="no">:as</span><span class="w"> </span><span class="no">:json</span><span class="p">}))]</span><span class="w">

    </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="mi">200</span><span class="w"> </span><span class="n">status</span><span class="p">))</span><span class="w">
    </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">{</span><span class="no">:hello</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="s">"test"</span><span class="w"> </span><span class="n">true</span><span class="p">]}</span><span class="w"> </span><span class="n">body</span><span class="p">))))</span><span class="w">
</span></code></pre></div></div>

<h2 id="slow-responses">Slow responses</h2>

<p>To imitate slow responses, provide a function that sleeps for a certain amount
of time:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="s">"/foo"</span><span class="w"> </span><span class="p">{</span><span class="no">:get</span><span class="w"> </span><span class="p">(</span><span class="k">fn</span><span class="w"> </span><span class="p">[</span><span class="n">_</span><span class="p">]</span><span class="w">
                </span><span class="p">(</span><span class="nf">Thread/sleep</span><span class="w"> </span><span class="mi">10000</span><span class="p">)</span><span class="w">
                </span><span class="p">{</span><span class="no">:status</span><span class="w"> </span><span class="mi">200</span><span class="w"> </span><span class="no">:body</span><span class="w"> </span><span class="s">"OK"</span><span class="p">})}}</span><span class="w">
</span></code></pre></div></div>

<p>Then ensure you pass the timeout limit into your API call.</p>

<h2 id="files--resources">Files &amp; Resources</h2>

<p>Storing JSON responses in files is a good idea. Here is how you can serve them
with the macro:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="s">"/foo"</span><span class="w"> </span><span class="p">{</span><span class="no">:get</span><span class="w"> </span><span class="p">(</span><span class="nf">io/file</span><span class="w"> </span><span class="s">"dev-resources/test.txt"</span><span class="p">)}}</span><span class="w">
</span></code></pre></div></div>

<p>or</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="s">"/foo"</span><span class="w"> </span><span class="p">{</span><span class="no">:get</span><span class="w"> </span><span class="p">(</span><span class="nf">io/file</span><span class="w"> </span><span class="s">"dev-resources/test.json"</span><span class="p">)}}</span><span class="w">
</span></code></pre></div></div>

<h2 id="capturing-requests">Capturing requests</h2>

<p>Another trick to improve your tests: ensure you pass the right parameters or
headers to the HTTP API. Provide an atom and a handler function closed over that
atom. Each time you receive a request, save it’s data to the atom and then
validate them:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">deftest</span><span class="w"> </span><span class="n">test-with-http-capture-params</span><span class="w">

  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">capture!</span><span class="w">
        </span><span class="p">(</span><span class="nf">atom</span><span class="w"> </span><span class="n">nil</span><span class="p">)</span><span class="w">

        </span><span class="n">app</span><span class="w">
        </span><span class="p">{</span><span class="s">"/foo"</span><span class="w"> </span><span class="p">{</span><span class="no">:get</span><span class="w"> </span><span class="p">(</span><span class="k">fn</span><span class="w"> </span><span class="p">[{</span><span class="no">:keys</span><span class="w"> </span><span class="p">[</span><span class="n">params</span><span class="p">]}]</span><span class="w">
                        </span><span class="p">(</span><span class="nf">reset!</span><span class="w"> </span><span class="n">capture!</span><span class="w"> </span><span class="n">params</span><span class="p">)</span><span class="w">
                        </span><span class="p">{</span><span class="no">:status</span><span class="w"> </span><span class="mi">200</span><span class="w"> </span><span class="no">:body</span><span class="w"> </span><span class="s">"OK"</span><span class="p">})}}</span><span class="w">

        </span><span class="n">url</span><span class="w">
        </span><span class="p">(</span><span class="nf">make-url</span><span class="w"> </span><span class="n">PORT</span><span class="w"> </span><span class="s">"/foo?a=1&amp;b=2"</span><span class="p">)</span><span class="w">

        </span><span class="p">{</span><span class="no">:keys</span><span class="w"> </span><span class="p">[</span><span class="n">status</span><span class="w"> </span><span class="n">body</span><span class="p">]}</span><span class="w">
        </span><span class="p">(</span><span class="nf">with-http</span><span class="w"> </span><span class="p">[</span><span class="n">PORT</span><span class="w"> </span><span class="n">app</span><span class="p">]</span><span class="w">
          </span><span class="p">(</span><span class="nf">client/get</span><span class="w"> </span><span class="n">url</span><span class="p">))]</span><span class="w">

    </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="mi">200</span><span class="w"> </span><span class="n">status</span><span class="p">))</span><span class="w">
    </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="s">"OK"</span><span class="w"> </span><span class="n">body</span><span class="p">))</span><span class="w">
    </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">{</span><span class="no">:a</span><span class="w"> </span><span class="s">"1"</span><span class="w"> </span><span class="no">:b</span><span class="w"> </span><span class="s">"2"</span><span class="p">}</span><span class="w"> </span><span class="o">@</span><span class="n">capture!</span><span class="p">))))</span><span class="w">
</span></code></pre></div></div>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/windows-snapshots/">Скриншоты на винде</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2023-09-18T00:00:00+00:00">
        Sep 18, 2023
    </time>

    <a href="/tag/windows/" rel="tag">windows</a>, <a href="/tag/screenshot/" rel="tag">screenshot</a>

</div>


            <div class="entry">
                
                    <p>На винде есть утилита для скриншотов рабочего стола, называется “Ножницы” или
вроде того (clip). И надо сказать, программа люто, бешено тупая.</p>

<p>Делаю скриншот и хочу сохранить — открывает диалог с именем “безымянный.PNG” (в
английской версии untitled.PNG). Не будем комментировать расширение капсом; но
блин, почему файл безымянный? Что мешало назвать его текущей датой с точность до
минуты?</p>

<p>Далее, если в папке уже есть “безымянный” с прошлого раза, программа предложит
его перезаписать. Что мешает проверить, что такой файл уже есть и хотя бы
поставить единичку (двойку, тройку)?</p>

<p>В итоге как дурак дописываешь в конец чушь вроде 123, чтобы сохранить скриншот и
куда-то отправить.</p>

<p>Вот как на Маке: когда делаешь скриншот, он сперва улетает в угол, и в течении
10 секунд его можно куда-то перетащить без сохранения на диск. А если не успел,
он сохранится на рабочий стол с датой и временем в названии. Не нужно париться,
сохранил или нет, перезаписал или нет.</p>

<p>Что мешало сделать также Микрософту? Они вообще своими программами пользуются?</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/we-deserve/">Мы заслужили</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2023-09-18T00:00:00+00:00">
        Sep 18, 2023
    </time>

    <a href="/tag/mems/" rel="tag">mems</a>, <a href="/tag/stamps/" rel="tag">stamps</a>

</div>


            <div class="entry">
                
                    <p>Выражение “X, который мы заслужили” стало затасканным штампом.</p>

<ul>
  <li>Киберпанк, который мы заслужили.</li>
  <li>Футбол, который мы заслужили.</li>
  <li>Релиз, который мы заслужили.</li>
  <li>Пайплайн, который мы заслужили.</li>
</ul>

<p>Блин, кто мы? Чем и как заслужили?</p>

<p>Лет пять назад это было туда-сюда, но сегодня терпеть уже невозможно.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/tg-img/">Картинки в Телеграме</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2023-09-18T00:00:00+00:00">
        Sep 18, 2023
    </time>

    <a href="/tag/telegram/" rel="tag">telegram</a>

</div>


            <div class="entry">
                
                    <p><img src="/assets/static/aws/tg-img/1.jpeg" /></p>

<p>Телеграм бесит ещё одной вещью. Если добавить к тексту картинку, текст
поджимается под её ширину. Зачем, какой смысл? Текст превращается в мышиный
хвост, справа сплошная пустота. Половина полезного места уходит в унитаз. Всё
это ради чего? Чтобы что?</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/easter-eggs/">Пасхалки</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2023-09-18T00:00:00+00:00">
        Sep 18, 2023
    </time>

    <a href="/tag/movies/" rel="tag">movies</a>, <a href="/tag/easter/" rel="tag">easter</a>

</div>


            <div class="entry">
                
                    <p>Пожалуй, худшим фильмом, что я смотрел за последние годы, можно назвать “Петровы
в гриппе”. В двух словах его можно описать как бессвязный треш. В те времена я
читал Медузу, наслушался критика Долина и побежал на предпоказ как последний
дурачок.</p>

<p>Фильм — набор флешбеков без какого-либо действия. Женщина убивает мужчину на
детской площадке. Это происходит во дворе девятиэтажки, но никто этого не
видит. Потом заболевает гриппом мальчик, ее сын. С работы приходит батя-алкаш. У
него начинаются приходы и флешбеки со снегурочкой. Потом фильм рассказывает про
снегурочку: нищета, театр, случайный секс, беременность. В конце сцена про
алкашей и оживший труп.</p>

<p>Я не досидел до конца и ушел из зала, но потом вернулся за забытой вещью. К тому
времени свет включили, но люди не расходились. Оказалось, к фильму был
приставлен специально обученный человек, который после показа работал со
зрителями: отвечал на вопросы “что хотел сказать автор”.</p>

<p>Вот оно, современное искусство: тебе не только продают говно, но ещё тратятся на
человека, который объяснит, что это не говно, а режиссёр — тонкий художник.</p>

<p>Но пост не о плохом фильме — их и так хватает, — а о большом числе “пасхалок” в
нём. Каждые пять минут в кадре появляются какие-нибудь слова на заборе, которые
что-то значат. Это сделано столь топорно, что просто закрываешь глаза. Режиссёр
как будто тычет с экрана: смотри, это пасхалочка, скрытый смысл, понимаешь?
Улавливаешь?</p>

<p>От одной из сцен захотелось просто выругаться. Парень и девушка идут вдоль
огромной инсталляции с буквами в человеческий рост. Буквы показаны наполовину,
но распознать их можно. И когда пара шла мимо них, я подумал: наверняка буквы
складываются в какой-то “мэссадж”, но читать было лень, потому что от пасхалок я
уже устал.</p>

<p>И что вы думаете? Позже я прочёл в интернете, что те буквы складываются в “тебе
пизда”. Очень оригинально! Какой талант режиссёра! Наверное, много думал над
этой пасхалкой — больше, чем над сюжетом и персонажами.</p>

<p>Если серьёзно, то непонятно, зачем эта пасхалка и все другие. Какую задачу они
решают? Фильм как был говном, так остался им со всеми пасхалками, разгаданными
или нет. Если накрыть говно бантиком, получится говно с бантиком, верно?</p>

<p>Пожелаю режиссёру скорей понять это.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/cookie-popups/">Куки</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2023-09-18T00:00:00+00:00">
        Sep 18, 2023
    </time>

    <a href="/tag/web/" rel="tag">web</a>, <a href="/tag/cookies/" rel="tag">cookies</a>, <a href="/tag/design/" rel="tag">design</a>, <a href="/tag/idiots/" rel="tag">idiots</a>

</div>


            <div class="entry">
                
                    <p>К сожалению, нам не везёт с веб-дизайнерами. Я имею в виду нам всем, не только
мне. Открываешь любой сайт — и тебе стреляют плашкой, что сайт использует
куки. Даже если нажмёшь ОК, через пару дней сайт забудет, что ты согласился и
выстрелит опять. Или зайдешь с другого устройства и снова терпи. На телефоне
вообще беда: плашка занимает в лучшем случае полэкрана, в худшем — весь.</p>

<p>Нам не повезло, потому что не нашлось дизайнера, который бы нормально встроил
сообщение о куках в дизайн. Под “нормально” я имею в виду, чтобы оно не
выскакивало, не выпадало, а было написано без анимаций и JavaScript.</p>

<p>Я уже говорил, что хорошие дизайнеры должны начинать с печатного дизайна. Есть
лист бумаги, и нужно уместить на нём дизайн со всеми требованиями. Никаких тебе
выпадашек и анимашек.</p>

<p>А требования бывают разные. Если алкоголь или табак — предупреждение Минздрава
занимает не менее 10% от площади макета. Если банк — генеральная лицензия кеглем
не менее стольки пунктов. Если кандидат на выборах — лицензия на участие, номер
и прочие вещи. В роликах то же самое: показываешь БАД — внизу должна быть
надпись “не является лекарством, проконсультируйтесь с врачом”. И не в первую
секунду, а на протяжении всего ролика.</p>

<p>И дизайнеры как-то справляются с этим — выделяют площадь, увеличивают кегль,
согласуют с юристами и надзорными органами. И только веб-дизайнеры, эти
обезьянки с курсами HTTP/CSS/JavaScript, не могут доработать дизайн так, чтобы
требование чиновников (тоже обезьянок) выполнялось без выпадашки.</p>

<p>Казалось бы: нужно уведомить посетителя, что сайт использует куки. Так напиши
чуть ниже шапки: “этот сайт использует куки”. И ссылку на отдельную страницу,
где подробно написано, что такое куки, а ниже форма с чекбоксами, какие куки
хранить. Что мешает так сделать?</p>

<p>Но нет, дизайнер быдлокодит всплывающую форму, скрипты, стили. Получил
инструменты, а пользуется ими во вред.</p>

<p>Чтоб у него в штанах что-нибудь выпало.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/xbox-ban/">Бан в XBox</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2023-09-17T00:00:00+00:00">
        Sep 17, 2023
    </time>

    <a href="/tag/xbox/" rel="tag">xbox</a>, <a href="/tag/design/" rel="tag">design</a>

</div>


            <div class="entry">
                
                    <p><img src="/assets/static/aws/xbox/1.jpeg" /></p>

<p>У меня нет приставки, и я почти ни во что не играю (разве что в старые игры на эмуляторе). Однако я не мог пройти мимо такой картинки в интернете. Это скриншот из интерфейса XBox, где написано, что вас забанили.</p>

<p>Удивляет пиктограмма рукопожатия справа. Что было в голове у дизайнера, который ее добавил? Мало того, что забанили клиента без объяснения причины; так еще нарисовали рукопожатие, мол, дружище, без обид, держись там. Бан пройдет, и мы снова будем друзьями.</p>

<p>Тупизна какого-то вселенского масштаба. В точности как все у Микрософта.</p>

                
            </div>

        </li>
        
    </ul>

    <h4>
        
        <a href="/page34" class="previous">&larr;</a>
        
        <span class="page_number ">Страница 35 из 100</span>
        
        <a href="/page36" class="next">&rarr;</a>
        
    </h4>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Ivan Grishaev's blog</li>
          <li><a href="mailto:ivan@grishaev.me">ivan@grishaev.me</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
            <li><a href="https://github.com/igrishaev">GitHub</a></li>
            <li><a href="https://t.me/igrishaev_blog">Telegram</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Writing on programming, education, books and negotiations.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
