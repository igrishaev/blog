<!DOCTYPE html>
<html lang="ru">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Ivan Grishaev's blog</title>
  <meta name="description" content="Writing on programming, education, books and negotiations.
">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/custom.css">
  <link rel="canonical" href="https://grishaev.me/page5/">
  <link rel="alternate" type="application/rss+xml" title="Ivan Grishaev's blog" href="https://grishaev.me/feed.xml">

  <link rel="shortcut icon" type="image/x-icon" href="/assets/static/favicons/favicon.ico">

  <script type="text/javascript" src="/assets/typo.js"></script>

</head>


  <body>
    <header class="site-header">

    <div class="wrapper flex-container">

        <div>
            <a href="/">
                <img id="avatar" src="/assets/static/avatar.jpg" alt="Ivan Grishaev">
            </a>
        </div>

        <div class="flex-container-vert" style="margin-left: 15px; width: 80%">

            <div class="flex-container full-width">
                <p style="margin-bottom: 5px">Ivan Grishaev's blog</p>
                <div class="flex-huge"></div>
                <div >
<form id="search-form"
      target="_blank"
      style="display: inline"
      method="get"
      action="https://www.google.com/search">

    <input name="sitesearch"
           value="grishaev.me"
           type="hidden">

    <input type="text"
           required="required"
           name="q"
           placeholder="Google search..."
           autocomplete="off">

    <button style="border: none; background-color: transparent; cursor: pointer;"
            type="submit">&#x1f50d;</button>

</form>
</div>
            </div>

            <p><small>Writing on programming, education, books and negotiations.
</small></p>

            <div class="flex-container">
                <a class="menu-item" href="/">Home</a>
                <a class="menu-item" href="/about/">About</a>
                <a class="menu-item" href="/bookshelf/">Bookshelf</a>
                <a class="menu-item" href="/feed.xml">RSS</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor" href="/tag/clojure/">Clojure</a>
                <a class="menu-item minor" href="/tag/emacs/">Emacs</a>
                <a class="menu-item minor" href="/tag/python/">Python</a>
                <a class="menu-item minor" href="/tag/programming/">Programming</a>
                <a class="menu-item minor" href="/interview/">Interview</a>
                <a class="menu-item minor" href="/video/">Video</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor hl" href="/clojure-in-prod/">Книга «Clojure на производстве»</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor hl" href="/clojure-in-prod-2/">Книга «Clojure на производстве», второй том</a>
            </div>

        </div>
    </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="home">

    <ul class="post-list">
        
        <li>

            <h2>
                <a class="post-link" href="/chart-lang/">Языки диаграмм</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2023-10-08T00:00:00+00:00">
        Oct 8, 2023
    </time>

    <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/charts/" rel="tag">charts</a>, <a href="/tag/diagramms/" rel="tag">diagramms</a>, <a href="/tag/uml/" rel="tag">UML</a>, <a href="/tag/ui/" rel="tag">ui</a>

</div>


            <div class="entry">
                
                    <p>Есть языки, которые описывают схемы и диаграммы. Например, пишешь что-то такое:</p>

<p><img src="/assets/static/aws/chart-lang/1.jpeg" /></p>

<p>Потом натраливаешь на файл программу и получается картинка:</p>

<p><img src="/assets/static/aws/chart-lang/2.jpeg" /></p>

<p>Казалось бы, все автоматически, красиво, удобно. Но нет.</p>

<p>Когда я верстал первую книгу в Латехе, то использользовал для графиков пакет
<a href="https://www.overleaf.com/learn/latex/TikZ_package">TikZ</a>. Там то же самое: схематично описываешь сущности, а пакет их
рендерит. Исходник:</p>

<p><img src="/assets/static/aws/chart-lang/3.jpeg" /></p>

<p>и результат:</p>

<p><img src="/assets/static/aws/chart-lang/4.jpeg" /></p>

<p>Во второй книге я отказался от TikZ по следующим причинам.</p>

<p>Во-первых, синтаксис диаграмм забывается очень быстро. Если работаешь с ними
каждый день, то проблемы не возникает. Однако чаще всего ты рисуешь диаграмму
раз в полгода и не трогаешь ее. Когда открываешь файл опять, нужно вспоминать
все заново. Откуда и куда вести стрелку, нужна ли точка с запятой, ставить <code class="language-plaintext highlighter-rouge">=&gt;</code>
или <code class="language-plaintext highlighter-rouge">-&gt;&gt;</code> для уголка и все в том же духе. Каждый раз как в первый раз.</p>

<p>Далее, дьявол кроется в деталях. Помните правило 20/80? Большую часть диаграммы
вы покроете за 20 процентов времени, и возникнет иллюзия — какой я молодец, что
использую язык! Быстро управился. А потом провозитесь три часа в попытке
сдвинуть первый прямоугольник влево, а второй — вправо. И рамка будет кривая. И
позиционирование будет неудобное. Захочется сдвинуть вручную, но нелья — у нас
же не Фотошоп или Иллюстратор, а код.</p>

<p>Наконец, все эти языки не имеют понятия о восприятии. Когда я рисую диаграмму,
то думаю о пользователе: насколько ему удобно. Поэтому отталкиваюсь от самых
важных элементов; насколько хорошо они контрастируют со второстепенным;
насколько легко проследить процесс; нет ли объектов, которые этому мешают.</p>

<p>Стоит ли говорить, что ничего подобного в языках разметки нет. Они рисуют
прямоугольники и стрелки, полагая, что пользователь разберется сам. Но это бред
— пользователю нужен процесс, кем-то осмысленный и показанный наглядно. А не
нагромождение прямоугольников.</p>

<p>Когда я сел за вторую книгу, то пытался сделать схемы в TikZ как раньше. Но
обнаружил, что синтаксис забыт начисто, а вспоминать не хочется. В итоге
нарисовал в <a href="https://monodraw.helftone.com/">Monodraw</a> — программе ASCII-диаграмм — и экспортировал в
SVG. Это проще и быстрее. Если нужно подвинуть фигуру на клетку влево, я сделаю
это в один клик. Не нужно вспоминать, какое свойство отвечает за сдвиг и в каких
единицах оно измеряется.</p>

<p><img src="/assets/static/aws/chart-lang/5.jpeg" /></p>

<p>Против Monodraw можно сказать только то, что она под Мак. Для командной работы,
возможно, не подойдет. С другой стороны, пусть в команде будет один человек,
который отвечает за диаграммы. Если их редактируют все подряд, это беда.</p>

<p>Экстраполируя, можно сказать, что языки построения схем — блажь. Их любит
“серьезный” бизнез, где вещи внедряют лишь затем, что так принято. Хорошим
примером служит UML — циклопическая абстракция о том, что и как описывать. В нее
вбухали невероятно много денег и времени; всерьез считали, что если отобразить
классы диаграммой, логика программы станет очевидной. И что — кто-то пользуется
UML сегодня? Доводилось ли кому-то посмотреть на UML и сказать: точно, я все
понял?</p>

<p>Наконец, если программы для диаграмм сводят с ума, остается надежное средство —
рисовать руками. Берете маркеры и рисуете на доске то, что нужно. Затем снимок
→ коррекция → красивая картинка.</p>

<p>Как-то раз я делал презентацию об <a href="/htmx/">HTMX</a> для команды, и сама мысль о
какой-то программе вызывала дрожь. В итоге нарисовал на доске и отфотал. Пара
слайдов из презентации:</p>

<p><img src="/assets/static/aws/chart-lang/6.jpeg" /></p>

<p><img src="/assets/static/aws/chart-lang/7.jpeg" /></p>

<p>Местами кривовато, но я и не особо старался.</p>

<p>А можно заморочится и нарисовать на бумаге. Например, Bob Nystrom в своих
знаменитых книгах <a href="https://craftinginterpreters.com/">Crafting Interpreters</a> и
<a href="https://gameprogrammingpatterns.com/">Game Programming Patterns</a> рисовал схемы
гелевой ручкой на бумаге, а потом сканировал. Просто сказка:</p>

<p><img src="/assets/static/aws/chart-lang/8.jpeg" /></p>

<p>Какой итог можно подвести? Мне кажется, такой:</p>

<ul>
  <li>
    <p>языки диаграмм — прохладная затея, потому что машина не понимает, что
первично, а что вторично, что удобно пользователю, а что нет;</p>
  </li>
  <li>
    <p>языки диаграмм — идеальный пример правила 80/20. Быстро получаешь почти
готовый результат, но на доводку уходит много времени;</p>
  </li>
  <li>
    <p>откройте исходник диаграммы через полгода — будет трудно вспомнить, что и как
поправить;</p>
  </li>
  <li>
    <p>не бойтесь ручного труда — рисунки на доске или бумаге по-прежнему смотрятся
отлично.</p>
  </li>
</ul>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/en/pg-docs/06/">PG docs, part 6. SSL</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2023-09-30T00:00:00+00:00">
        Sep 30, 2023
    </time>

    <a href="/tag/clojure/" rel="tag">clojure</a>, <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/postgres/" rel="tag">postgres</a>, <a href="/tag/sql/" rel="tag">sql</a>, <a href="/tag/notifications/" rel="tag">notifications</a>

</div>


            <div class="entry">
                
                    
<p><em>(This is a new documentation chapter from the <a href="https://github.com/igrishaev/pg">PG project</a>.)</em></p>

<p><strong>ToC</strong></p>

<ul>
  <li><a href="/en/pg-docs/01/">About &amp; Installation</a></li>
  <li><a href="/en/pg-docs/02/">The Client</a></li>
  <li><a href="/en/pg-docs/03/">Connection Pool</a></li>
  <li><a href="/en/pg-docs/04/">Arrays</a></li>
  <li><a href="/en/pg-docs/05/">Notifications</a></li>
  <li><a href="/en/pg-docs/06/">SSL</a></li>
  <li><a href="/en/pg-docs/07/">COPY</a></li>
  <li><a href="/en/pg-docs/08/">HoneySQL</a></li>
</ul>

<p>In this chapter:</p>

<ul>
  <li><a href="#setup">Setup</a></li>
  <li><a href="#edn-config">EDN Config</a></li>
  <li><a href="#testing">Testing</a></li>
</ul>

<p>The recent update of PG introduces SSL support. Install the newest version of PG
as follows:</p>

<p>Lein:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="n">com.github.igrishaev/pg-client</span><span class="w"> </span><span class="s">"0.1.8"</span><span class="p">]</span><span class="w">
</span><span class="p">[</span><span class="n">com.github.igrishaev/pg-ssl</span><span class="w"> </span><span class="s">"0.1.8"</span><span class="p">]</span><span class="w"> </span><span class="c1">;; optional, for a custom SSL context</span><span class="w">
</span></code></pre></div></div>

<p>Deps:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="n">com.github.igrishaev/pg-client</span><span class="w"> </span><span class="p">{</span><span class="no">:mvn/version</span><span class="w"> </span><span class="s">"0.1.8"</span><span class="p">}</span><span class="w">
 </span><span class="n">com.github.igrishaev/pg-ssl</span><span class="w"> </span><span class="p">{</span><span class="no">:mvn/version</span><span class="w"> </span><span class="s">"0.1.8"</span><span class="p">}}</span><span class="w">
</span></code></pre></div></div>

<h2 id="setup">Setup</h2>

<p>The are two ways to set up an SSL connection to the database. The first, and
simple, is to set the <code class="language-plaintext highlighter-rouge">:ssl?</code> boolean flag to true and just connect:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="no">:host</span><span class="w"> </span><span class="s">"some.cloud.host.com"</span><span class="w">
 </span><span class="no">:port</span><span class="w"> </span><span class="mi">5432</span><span class="w">
 </span><span class="no">:ssl?</span><span class="w"> </span><span class="n">true</span><span class="w">
 </span><span class="n">...</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>In this case, the entire SSL pipeline is held by Java. It tries to find the
corresponding keys and certificates using the standard KeyStore and TrustStore
which you configure on your own.</p>

<p>The second and more flexible way is to provide a custom SSL context to the
connection map. It must be an instance of the <code class="language-plaintext highlighter-rouge">javax.net.ssl.SSLContext</code>
class. Building such an instance from scratch is quite miserable though. To make
your life easier, there is a thin wrapper on top of the great <a href="https://github.com/aphyr/less-awful-ssl">Less Awful
SSL</a> library that takes a map of certificates and keys and
returns an instance of <code class="language-plaintext highlighter-rouge">SSLContext</code>. Since it requires a third-party library,
it’s shipped as a standalone package pg-ssl. Add it to the project:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="n">com.github.igrishaev/pg-client</span><span class="w"> </span><span class="s">"0.1.8"</span><span class="p">]</span><span class="w"> </span><span class="c1">;; lein</span><span class="w">
</span><span class="c1">;; or</span><span class="w">
</span><span class="p">{</span><span class="n">com.github.igrishaev/pg-ssl</span><span class="w"> </span><span class="p">{</span><span class="no">:mvn/version</span><span class="w"> </span><span class="s">"0.1.8"</span><span class="p">}}</span><span class="w"> </span><span class="c1">;; deps</span><span class="w">
</span></code></pre></div></div>

<p>Now pass the <code class="language-plaintext highlighter-rouge">:ssl-context</code> parameter in addition to <code class="language-plaintext highlighter-rouge">:ssl?</code>. It’s a map with
the string keys <code class="language-plaintext highlighter-rouge">:key-file</code>, <code class="language-plaintext highlighter-rouge">:cert-file</code>, and <code class="language-plaintext highlighter-rouge">:ca-cert-file</code>:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">ns</span><span class="w"> </span><span class="n">foo.bar</span><span class="w">
  </span><span class="p">(</span><span class="no">:require</span><span class="w">
    </span><span class="p">[</span><span class="n">pg.ssl</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">ssl</span><span class="p">]))</span><span class="w">

</span><span class="p">{</span><span class="no">:host</span><span class="w"> </span><span class="s">"some.cloud.host.com"</span><span class="w">
 </span><span class="no">:port</span><span class="w"> </span><span class="mi">5432</span><span class="w">
 </span><span class="no">:ssl?</span><span class="w"> </span><span class="n">true</span><span class="w">
 </span><span class="no">:ssl-context</span><span class="w">
 </span><span class="p">(</span><span class="nf">ssl/context</span><span class="w"> </span><span class="p">{</span><span class="no">:key-file</span><span class="w"> </span><span class="s">"/path/to/client.key"</span><span class="w">
               </span><span class="no">:cert-file</span><span class="w"> </span><span class="s">"/path/to/client.crt"</span><span class="w">
               </span><span class="no">:ca-cert-file</span><span class="w"> </span><span class="s">"/path/to/root.crt"</span><span class="p">})}</span><span class="w">
</span></code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">:ca-cert-file</code> parameter might be missing if just <code class="language-plaintext highlighter-rouge">:key-file</code> and
<code class="language-plaintext highlighter-rouge">:cert-file</code> are enough.</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">ssl/context</span><span class="w"> </span><span class="p">{</span><span class="no">:key-file</span><span class="w"> </span><span class="s">"/path/to/client.key"</span><span class="w">
              </span><span class="no">:cert-file</span><span class="w"> </span><span class="s">"/path/to/client.crt"</span><span class="p">})</span><span class="w">
</span></code></pre></div></div>

<h2 id="edn-config">EDN Config</h2>

<p>Often, we store the configuration in an EDN file. To declare SSL context there,
prepend it with a reader tag called <code class="language-plaintext highlighter-rouge">#pg/ssl-context</code>:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="no">:ssl?</span><span class="w"> </span><span class="n">true</span><span class="w">
 </span><span class="no">:ssl-context</span><span class="w"> </span><span class="o">#</span><span class="n">pg/ssl-context</span><span class="w"> </span><span class="p">{</span><span class="no">:key-file</span><span class="w"> </span><span class="n">...</span><span class="p">}}</span><span class="w">
</span></code></pre></div></div>

<p>When reading EDN, pass that tag to the <code class="language-plaintext highlighter-rouge">:readers</code> map as follows:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="ss">'pg/ssl-context</span><span class="w"> </span><span class="n">pg.ssl/ssl-context-reader</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>The tag wraps the map with a function that builds the <code class="language-plaintext highlighter-rouge">SSLContext</code> from it.</p>

<p>Some cloud platforms give you only the root certificate. In that case, generate
both the client key and the the client certificate on your own using the root
certificate. Something like:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">umask </span><span class="nv">u</span><span class="o">=</span>rw,go<span class="o">=</span> <span class="o">&amp;&amp;</span> openssl req <span class="nt">-days</span> 365 <span class="nt">-new</span> <span class="nt">-nodes</span> <span class="nt">-subj</span> <span class="s1">'/C=US/ST=Test/L=Test/O=Personal/OU=Personal/emailAddress=test@test.com/CN=test'</span> <span class="nt">-keyout</span> client.key <span class="nt">-out</span> client.csr
<span class="nb">umask </span><span class="nv">u</span><span class="o">=</span>rw,go<span class="o">=</span> <span class="o">&amp;&amp;</span> openssl x509 <span class="nt">-days</span> 365 <span class="nt">-req</span>  <span class="nt">-CAcreateserial</span> <span class="nt">-in</span> client.csr <span class="nt">-CA</span> root.crt <span class="nt">-CAkey</span> server.key <span class="nt">-out</span> client.crt
</code></pre></div></div>

<p>When generating the certificates, pay attention to the <code class="language-plaintext highlighter-rouge">CN</code> field which is
“test” in our case. In terms of PostgreSQL, it should match the database
user. Different users will have different certificates.</p>

<h2 id="testing">Testing</h2>

<p>The SSL functionality is difficult to test in Docker so I’ve got to run a native
instance. Here is a brief setup.</p>

<ul>
  <li>In <code class="language-plaintext highlighter-rouge">postgresql.conf</code>, enable the <code class="language-plaintext highlighter-rouge">ssl</code> parameter and specify paths to the
files:</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssl=on
ssl_cert_file='/Users/ivan/work/pg/certs/server.crt'
ssl_key_file='/Users/ivan/work/pg/certs/server.key'
ssl_ca_file = '/Users/ivan/work/pg/certs/root.crt'
</code></pre></div></div>

<ul>
  <li>In <code class="language-plaintext highlighter-rouge">pg_hba.conf</code>, enable the “cert” validation type for SSL connections:</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hostssl all all all cert
</code></pre></div></div>

<p>Finally, create a user with a name that matches the <code class="language-plaintext highlighter-rouge">CN</code> field:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">create</span> <span class="k">user</span> <span class="o">&lt;</span><span class="n">CN</span><span class="o">-</span><span class="n">field</span><span class="o">&gt;</span> <span class="k">with</span> <span class="n">password</span> <span class="s1">'******'</span><span class="p">;</span>
</code></pre></div></div>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/sql/">SQL</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2023-09-27T00:00:00+00:00">
        Sep 27, 2023
    </time>

    <a href="/tag/sql/" rel="tag">sql</a>, <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/postgresql/" rel="tag">postgresql</a>

</div>


            <div class="entry">
                
                    <p>Язык SQL — прекрасная вещь, пожалуй, одна из лучших, что мы имеем в айти.
Научиться ему значит повысить свою квалификацию на голову. Бекендеров я бы
вообще оценивал по одному критерию — насколько хорошо они работают с базой.</p>

<p>SQL выручал меня не только по работе. У нас в ЖК стоят шлагбаумы, и однажды я
запросил логи, чтобы посмотреть, кто и когда и открывает. Мне скинули несколько
страшных CSV. Разбирать их Экселе было адом, и я загнал в Постгрес и построил
отчеты по всем мыслимым критериям.</p>

<p>Импорт:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">COPY</span> <span class="n">logs</span><span class="p">(</span><span class="nb">time</span><span class="p">,</span> <span class="n">account</span><span class="p">,</span> <span class="k">type</span><span class="p">,</span> <span class="n">ident</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">barrier</span><span class="p">)</span>
<span class="k">FROM</span> <span class="s1">'/Users/ivan/work/barriers/65_Ш6.csv'</span>
<span class="k">DELIMITER</span> <span class="s1">';'</span> <span class="n">CSV</span> <span class="n">HEADER</span><span class="p">;</span>
</code></pre></div></div>

<p>Статусы:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>select distinct status from logs

| status
|---------------------------------------
| Добавлен
| Отказ (пульт)
| Отказ (нет в базе или ошибка кнопка)
| Открыто (карта в базе)
| Допуск (пульт)
...
</code></pre></div></div>

<p>Типы доступа:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>select distinct type from logs

| type
|--------------
| Событие
| Карта, метка
| Звонок
| Удаление
...
</code></pre></div></div>

<p>Общее число открываний в разрезе помещений:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="n">account</span><span class="p">,</span> <span class="k">count</span><span class="p">(</span><span class="n">ident</span><span class="p">)</span> <span class="k">as</span> <span class="k">count</span> <span class="k">from</span> <span class="n">logs</span>
<span class="k">where</span> <span class="n">account</span> <span class="o">&lt;&gt;</span> <span class="s1">'Нет в базе'</span>
<span class="k">and</span> <span class="nb">time</span> <span class="o">&gt;</span> <span class="s1">'2022-05-01 00:00:00'</span>
<span class="k">and</span> <span class="n">status</span> <span class="k">in</span> <span class="p">(</span><span class="s1">'Допуск (телефон)'</span><span class="p">,</span> <span class="s1">'Допуск (пульт)'</span><span class="p">)</span>
<span class="k">and</span> <span class="k">type</span> <span class="k">in</span> <span class="p">(</span><span class="s1">'PP'</span><span class="p">,</span> <span class="s1">'Звонок'</span><span class="p">)</span>
<span class="k">group</span> <span class="k">by</span> <span class="n">account</span>
<span class="k">order</span> <span class="k">by</span> <span class="k">count</span> <span class="k">desc</span>
<span class="k">limit</span> <span class="mi">50</span>
</code></pre></div></div>

<p>Данные по конкретной квартире по дням:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="n">date_trunc</span><span class="p">(</span><span class="s1">'day'</span><span class="p">,</span> <span class="nb">time</span><span class="p">)</span> <span class="k">as</span> <span class="k">day</span><span class="p">,</span> <span class="k">count</span><span class="p">(</span><span class="n">ident</span><span class="p">)</span> <span class="k">from</span> <span class="n">logs</span>
<span class="k">where</span> <span class="n">account</span> <span class="o">=</span> <span class="s1">'ООО "Рога и копыта"'</span>
<span class="k">and</span> <span class="nb">time</span> <span class="o">&gt;</span> <span class="s1">'2022-05-01 00:00:00'</span>
<span class="k">and</span> <span class="n">status</span> <span class="k">in</span> <span class="p">(</span><span class="s1">'Допуск (телефон)'</span><span class="p">,</span> <span class="s1">'Допуск (пульт)'</span><span class="p">)</span>
<span class="k">and</span> <span class="k">type</span> <span class="k">in</span> <span class="p">(</span><span class="s1">'PP'</span><span class="p">,</span> <span class="s1">'Звонок'</span><span class="p">)</span>
<span class="k">group</span> <span class="k">by</span> <span class="k">day</span>
<span class="k">order</span> <span class="k">by</span> <span class="k">day</span> <span class="k">desc</span>
<span class="k">limit</span> <span class="mi">50</span>
</code></pre></div></div>

<p>Число телефонов и пультов на помещение:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="n">account</span><span class="p">,</span> <span class="k">count</span><span class="p">(</span><span class="k">distinct</span> <span class="n">ident</span><span class="p">)</span> <span class="k">as</span> <span class="n">amount</span> <span class="k">from</span> <span class="n">logs</span>
<span class="k">where</span> <span class="n">account</span> <span class="o">&lt;&gt;</span> <span class="s1">'Нет в базе'</span>
<span class="k">and</span> <span class="nb">time</span> <span class="o">&gt;</span> <span class="s1">'2022-05-01 00:00:00'</span>
<span class="k">and</span> <span class="n">status</span> <span class="k">in</span> <span class="p">(</span><span class="s1">'Допуск (телефон)'</span><span class="p">,</span> <span class="s1">'Допуск (пульт)'</span><span class="p">)</span>
<span class="k">group</span> <span class="k">by</span> <span class="n">account</span>
<span class="k">order</span> <span class="k">by</span> <span class="n">amount</span> <span class="k">desc</span>
<span class="k">limit</span> <span class="mi">100</span>
</code></pre></div></div>

<p>Среднее число открываний в день:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="n">account</span><span class="p">,</span> <span class="k">count</span><span class="p">(</span><span class="n">ident</span><span class="p">)</span> <span class="o">/</span> <span class="k">count</span><span class="p">(</span><span class="k">distinct</span> <span class="n">date_trunc</span><span class="p">(</span><span class="s1">'day'</span><span class="p">,</span> <span class="nb">time</span><span class="p">))</span> <span class="k">as</span> <span class="n">per_day</span>
<span class="k">from</span> <span class="n">logs</span>
<span class="k">where</span> <span class="n">account</span> <span class="o">&lt;&gt;</span> <span class="s1">'Нет в базе'</span>
<span class="k">and</span> <span class="nb">time</span> <span class="o">&gt;</span> <span class="s1">'2022-05-01 00:00:00'</span>
<span class="k">and</span> <span class="n">status</span> <span class="k">in</span> <span class="p">(</span><span class="s1">'Допуск (телефон)'</span><span class="p">,</span> <span class="s1">'Допуск (пульт)'</span><span class="p">)</span>
<span class="k">and</span> <span class="k">type</span> <span class="k">in</span> <span class="p">(</span><span class="s1">'PP'</span><span class="p">,</span> <span class="s1">'Звонок'</span><span class="p">)</span>
<span class="k">group</span> <span class="k">by</span> <span class="n">account</span>
<span class="k">order</span> <span class="k">by</span> <span class="n">per_day</span> <span class="k">desc</span>
<span class="k">limit</span> <span class="mi">100</span>
</code></pre></div></div>

<p>И еще штук десять подобных запросов. В итоге нашли несколько аномалий, с
нарушителями был разговор.</p>

<p>Из недавнего: понадобилось считать рабочие часы по неделям. Что в Экселе, что
Гугле это оказался адский ад, потому что тип <code class="language-plaintext highlighter-rouge">time</code> не переполняется. То есть если
сложить 7 + 7 + 7 + 7 + 7 часов (пять рабочих дней), получим 11 часов, потому что 24
уйдут в перекрут. Просидел час, думая, как это решить, и так и не решил.</p>

<p>Но выручил Постгрес! Его тип <code class="language-plaintext highlighter-rouge">time</code> тоже не поддерживает переполнение, но есть
тип <code class="language-plaintext highlighter-rouge">interval</code>, который прекрасно складывается сам с собой. Поэтому создаем
таблицу с двумя колонками: дата и интервал:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">create</span> <span class="k">table</span> <span class="k">work</span> <span class="p">(</span><span class="nb">date</span> <span class="nb">date</span><span class="p">,</span> <span class="n">hours</span> <span class="n">interval</span><span class="p">);</span>
</code></pre></div></div>

<p>Импорт:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">\</span><span class="k">copy</span> <span class="k">work</span> <span class="k">from</span> <span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">ivan</span><span class="o">/</span><span class="n">Downloads</span><span class="o">/</span><span class="n">foobar</span><span class="p">.</span><span class="n">csv</span>
  <span class="k">with</span> <span class="p">(</span><span class="n">format</span> <span class="n">csv</span><span class="p">);</span>
</code></pre></div></div>

<p>Удаляем пустые интервалы:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">delete</span> <span class="k">from</span> <span class="k">work</span> <span class="k">where</span> <span class="n">hours</span> <span class="k">is</span> <span class="k">null</span><span class="p">;</span>
</code></pre></div></div>

<p>Всего часов:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="k">sum</span><span class="p">(</span><span class="n">hours</span><span class="p">)</span> <span class="k">from</span> <span class="k">work</span><span class="p">;</span>
</code></pre></div></div>

<p>Отчет по неделям:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="n">date_trunc</span><span class="p">(</span><span class="s1">'week'</span><span class="p">,</span> <span class="nb">date</span><span class="p">)</span> <span class="k">as</span> <span class="n">week</span><span class="p">,</span> <span class="k">sum</span><span class="p">(</span><span class="n">hours</span><span class="p">)</span>
<span class="k">from</span> <span class="k">work</span>
<span class="k">group</span> <span class="k">by</span> <span class="n">week</span>
<span class="k">order</span> <span class="k">by</span> <span class="n">week</span><span class="p">;</span>
</code></pre></div></div>

<p>И все это — не выходя из консоли <code class="language-plaintext highlighter-rouge">psql</code>. Представьте, какой гемор был бы
построить это в Экселе, Гугле или даже на языке программирования вроде
Питона. Там с одним только парсингом дат и времени наешься, а тут все из
коробки.</p>

<p>Можно сбросить все отчеты в CSV одной командой, чтобы пересохранить в Excel и
отправить кому-то по работе.</p>

<p>Словом, одно из немногих утешений сегодня — это SQL/Postgres. Надежный как
скала, полезный, простой и востребованный.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/so-popups/">Выпадашки на StackOverflow</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2023-09-27T00:00:00+00:00">
        Sep 27, 2023
    </time>

    <a href="/tag/ui/" rel="tag">ui</a>, <a href="/tag/stackoverflow/" rel="tag">stackoverflow</a>, <a href="/tag/so/" rel="tag">so</a>, <a href="/tag/popups/" rel="tag">popups</a>

</div>


            <div class="entry">
                
                    <p><img src="/assets/static/aws/so-popups/1.jpeg" /></p>

<p>Я как-то <a href="/cookie-popups/">уже писал</a>: нам не везет с дизайнерами. Всякие Гуглы
и StackOverflow берут ребят с выпадашечным мышлением. Каждый раз, чтобы донести
информацию до пользователя, дизайнер ставит выпадашку. При этом все равно, что
выпадашка Васи наползает на выпадашку Пети. Это не его проблема, он добавил, а
остальное его не касается.</p>

<p>Сегодняшняя страница Stack Overflow как я ее вижу. Слой с бессмысленным текстом
наползает на какое-то дерьмо про искусственный интеллект. Выпадашка на
выпадашке. Интересно, как в SO устроена работа дизайнеров и контроль качества?
Это же Провал Провалыч, и причина одна — несогласованность между дизайнерами.</p>

<p>Нельзя так.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/slack-outdated/">Слак устарел</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2023-09-27T00:00:00+00:00">
        Sep 27, 2023
    </time>

    <a href="/tag/slack/" rel="tag">slack</a>, <a href="/tag/ui/" rel="tag">ui</a>, <a href="/tag/idiots/" rel="tag">idiots</a>

</div>


            <div class="entry">
                
                    <p>Этим утром Слак порадовал вдвойне: сообщил, что устарел не только он, но и моя
операционная система.</p>

<p><img src="/assets/static/aws/slack/1.jpeg" /></p>

<p>Вообще, радует эта формулировка: программа устарела. Лежат себе не диске
байты, работают, двигают другие байты, и вдруг раз — устарели. Срок годности
вышел, что ли? Или ноут долго на солнце стоял?</p>

<p>Всё еще надеясь на лучшее, скачал последний Слак, но увы — программа не
запускается, нужна версия Мака не ниже чего-то там.</p>

<p><img src="/assets/static/aws/slack/2.jpeg" /></p>

<p>“Устаревание” программы ещё можно понять: ленивые жопы не хотят поддерживать
то, что сами же написали. Плохо, но не критично. А вот с операционкой я не пойму.
Во-первых, ваш Слак — это Хром и Node.js, что там может требовать новой
операционки? Обычный Хром не требует обновления Мака, а вы что, какие-то
особенные?</p>

<p>Во-вторых, допускаю, что в новой операционке есть какая-то лабуда, но вопрос —
она действительно нужна в повседневной работе? Без неё не напишешь сообщение
и не позвонишь? А как раньше без неё жили?</p>

<p>В-третьих, обновление операционки — это простой в работе в лучшем случае на
полдня. Один шанс из ста, что все программы продолжат работу и пакеты не слетят.
Вот представь, разработчик Слаки, ты приходишь на работу и хоба! — ничего не
можешь сделать, пока не обновишь операционку. Таски не двигаешь, часы не
трекаешь, на митинги не ходишь.</p>

<p>Не нравится? А тебе, значит, можно так делать — отрубить мне программу для
общения по работе? Ты хотя бы представил мысленно, что сделает пользователь,
когда увидит это сообщение?</p>

<p>Эх, ребята из Слаки! Откуда вас понабрали? Нет у вас ни этики, ни эмпатии, ни
мозгов.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/sber-pipeline/">Оплата в Сбере</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2023-09-27T00:00:00+00:00">
        Sep 27, 2023
    </time>

    <a href="/tag/sber/" rel="tag">sber</a>, <a href="/tag/ui/" rel="tag">ui</a>

</div>


            <div class="entry">
                
                    <p><img src="/assets/static/aws/sber-pipeline/1.jpg" /></p>

<p>Кто пользуется Сбером, объясните, пожалуйста. Почему, чтобы заплатить за
музыкалку, нужно пять экранов? Не один, не два, а пять? При этом каждый экран
повторяет прошлый на 90%: это реквизиты, всякие КБК, ОКТМО и прочая хрень,
интересная только бухгалтеру.</p>

<p>Вот я накидал скриншотов:</p>

<p>Первый экран — реквизиты и кнопка “продолжить”.</p>

<p>Второй экран — те же реквизиты и выбор документа.</p>

<p>Третий экран — опять реквизиты(!) и серия/номер документа.</p>

<p>Четвёртый экран — РЕКВИЗИТЫ и сумма платежа.</p>

<p>Пятый экран — РЕКВИЗИТЫ и выбор счета.</p>

<p>Та же беда с коммуналкой, всякими карате, рисовалками и прочее. В коммуналке,
кстати, еще +3 экрана на ввод показаний с счётчиков.</p>

<p>Не многовато ли?</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/pao-tns/">Извинения за неудобства</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2023-09-27T00:00:00+00:00">
        Sep 27, 2023
    </time>

    <a href="/tag/mail/" rel="tag">mail</a>, <a href="/tag/pao/" rel="tag">pao</a>, <a href="/tag/tns/" rel="tag">tns</a>

</div>


            <div class="entry">
                
                    <p>Два года назад <a href="/mail-rules/">я писал о правилах</a> работы с почтой. Среди прочего
там есть важный пункт: если вы отправили плохое письмо, то нельзя слать вдогонку
правочки и просьбы посмотреть в других письмах. Нужно отправить новое письмо, в
котором все правильно.</p>

<p>Конечно, нашему “ПАО ТНС Энерго Воронеж” (что за бредовое название) не
знакомы эти правила. Что с них взять? Но давайте поучимся чужих ошибках.</p>

<p><img src="/assets/static/aws/tns/1.jpeg" /></p>

<p>В этом месяце ребята лоханулись: разослали квитанции с битыми QR-кодами. Ну,
бывает, вдруг Node.js-программист обновил package.json? Важно то, что с этим
сделает руководство. А оно пишет: берите коды из прошлых писем и примите
извинения. Но в кодах зашито назначение платежа, и Сбербанк не дает его
поменять. А платеж по реквизитам это просто ад: у “ПАО ТНС” сто филиалов, и
какой выбрать — неизвестно.</p>

<p>Конечно, надо было сгенерить новые квитанции и разослать вместо сломанных.
Простое правило: кто накосячил, тот и исправляет.</p>

<p>Повторюсь, к ПАО ТНС Энерго Воронеж претензий особо нет. Большая фирма,
бюрократия, и ничего кроме “примите извинения” они не могут.
Для нас главное — не допустить такого в своей работе.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/masked-input/">Ввод по маске</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2023-09-27T00:00:00+00:00">
        Sep 27, 2023
    </time>

    <a href="/tag/ui/" rel="tag">ui</a>, <a href="/tag/frontend/" rel="tag">frontend</a>, <a href="/tag/jquery/" rel="tag">jquery</a>

</div>


            <div class="entry">
                
                    <p>Каждый мамкин фронтендер знает: если в форме есть поле телефона, ставим плагин
jQuery под названием Masked Input и не паримся. С ним нельзя ввести буквы,
скобки, дефисы и прочий мусор.</p>

<p><img src="/assets/static/aws/masked-input/1.jpeg" /></p>

<p>Но мамкин фронтендер не знает: если вставить в поле “89623289677” (скажем, из
Экселя или менеджера паролей), то всратый плагин поместит восьмерку после +7 и
отбросит последнюю цифру. Результат будет как на второй картинке.</p>

<p><img src="/assets/static/aws/masked-input/2.jpeg" /></p>

<p>То есть всего-то испортили данные, но никого это не волнует. Подумаешь, не
придет смс, не дозвонится курьер, не выдадут посылку. Фронтендеру не до этих
мелочей.</p>

<p>Недаром говорят: благие намерения ведут в ад. Хотели сделать удобно на фронте, в
итоге добавили баг.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/it-errors/">Ошибки</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2023-09-27T00:00:00+00:00">
        Sep 27, 2023
    </time>

    <a href="/tag/it/" rel="tag">it</a>, <a href="/tag/errors/" rel="tag">errors</a>

</div>


            <div class="entry">
                
                    <p>Главная беда этой нашей айтишечки — сообщения об ошибках, не связанные с их
устранением. Примеров можно найти миллион, но вот вам один.</p>

<p>Собираю одну фигню в докере, и команда <code class="language-plaintext highlighter-rouge">apt-get update</code> падает с сообщением, что
репозиторий не подписан:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>The repository 'http://archive.ubuntu.com/ubuntu focal InRelease' is not signed.
</code></pre></div></div>

<p>При этом на другом ноуте все собирается как надо.</p>

<p>Оказалось, что это мулька самого Докера, и лечится она командой prune:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker image prune <span class="nt">-f</span>
docker container prune <span class="nt">-f</span>
</code></pre></div></div>

<p>Очевидно, без гугла и SO эту проблему не решить в принципе.</p>

<p>В современной айтишке много абстракций, и каждая из них не знает о
другой. Отсюда эти уродские сообщения: абстракция А считает что-то
неподписанным, потому что в Б нет места. А не находит файлы, потому что они не
смонтированы в Б. А валится, потому что в Б другая локаль или кодировка по
умлочанию.</p>

<p>Задача хорошего программиста в том, чтобы давать понятные сообщения об
ошибках. Наверное, вас тоже бесило, когда Java говорит: <code class="language-plaintext highlighter-rouge">port is already in
use</code>. Блин, какой порт? У меня их десять в проекте, тяжело добавить цифру в
сообщение?</p>

<p>Или тот же Вим. По всему миру люди страдают, не знают как из него выйти. Вопрос
на SO набрал миллион просмотров и растет дальше. И что делают разработчики вима?
Вместо того, чтобы добавить бар с действиями как в Nano, объясняют, что
пользователи тупые.</p>

<p>Напоминает мост в Питере со знаком “Газель не проедет”, где разбились сто
Газелей. Вместо того, чтобы порвать на тряпки мэра и начальника ГИБДД, ставят
знаки и постят картинки в Контакте.</p>

<p>То же самое происходит у нас. Вместо понятного сообщения мы ждем, что его
предоставит вышестоящий слой. Но это бессмысленно: не сделаем мы — не сделает
никто.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/firewall/">Фаервол</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2023-09-27T00:00:00+00:00">
        Sep 27, 2023
    </time>

    <a href="/tag/macos/" rel="tag">macos</a>, <a href="/tag/firewall/" rel="tag">firewall</a>, <a href="/tag/lulu/" rel="tag">lulu</a>

</div>


            <div class="entry">
                
                    <p>Лучшая вещь, что случилась со мной в последнее время — это установка фаервола на
всех маках. Вот как это произошло.</p>

<p>Когда-то я жаловался, что программы без спроса лезут в интернет
обновляться. Открыл Саблайм — а он показывает модалку, что вышла новая
версия. Открыл то, другое, а там то же самое: скачай-обновись.</p>

<p>Идея как это победить простая — нужно отобрать у программы доступ в интернет. Я
пошел настраивать встроенный фаервол, но оказалось, он убогий: закрывает только
входящие соединения, а исходящие не трогает. В результате даже если добавить в
список программу, она спокойно идет в сеть.</p>

<p>Путем гугления нашел программу Lulu. Хоть название и затасканное, программа
просто супер: удобный интерфейс и настройка. Lulu делит программы на группы:
родные Эпла, уже установленные и другие. Можно включать и выключать целые
группы, а можно по отдельности. Правила формируются в разрезе программ, папок,
регулярных выражений.</p>

<p>Можно настроить гибкий контроль по урлам. Например, дать программе доступ к
хосту <code class="language-plaintext highlighter-rouge">sync.blabla.com</code> для синхронизации, но запретить обновления по хосту
<code class="language-plaintext highlighter-rouge">update.blabla.com</code>.</p>

<p>Можно дать временный доступ по номеру процесса. Когда программа запуститься в
cледующий раз, номер будет другим, и Lulu спросит опять.</p>

<p>Фаервол может работать в интерактивном режиме, показывая диалог на события,
которых нет в правилах, а может молча разрешать или разрешать все, что
происходит.</p>

<p>Для себя я сделал так: удалил все правила, кроме Эпловских, а затем настраивал
вручную. Запретил все программы Адоба, офисного пакета, всякие редакторы вроде
Саблайма — их задача работать с текстом, а не лазить за обновлениями. Запретил
обновки для Dash, программы оффлайн-документации, и много что другое.</p>

<p>На старом ноуте обнаружил несколько вирусов. Это программы с названиями типа
robstoaf, прописанные в автозагрузке. Время от времени они ходят в сеть на левые
хосты. Возможно, крадут историю браузеров или это ботнет. Так что не слушайте
байки про то, что под Мак вирусов нет.</p>

<p>Что немаловажно, Lulu запрашивает подтверждение, когда левая программа хочет
добавить себя в автозагрузку. Всякое дерьмо вроде Zoom, MS Teams прописывают
себя там, и в итоге запускаются в фоне, даже если вы не просили. Больше этого
беспредела нет.</p>

<p>Программа так понравилась, что я хотел перевести автору денег, долларов
сто. Хотел скинуть с Пейпала, а у него только патреон — то есть регистрируйся,
вводи персональные данные, карту, подтверждай — извините, нет.</p>

<p>Кроме Lulu, у автора есть смежные утилиты для безопасности, например монитор
клавиатуры на предмет прослушки и что-то еще второстепенное.</p>

<p>Словом, не знаю как жить без Lulu: теперь это первая программа, которую я ставлю
на Мак. Как раз недавно ставил ее на свежий ноут. Неистово рекомендую!</p>

<p>Картинки, описание и загрузка здесь:
https://objective-see.org/products/lulu.html</p>

                
            </div>

        </li>
        
    </ul>

    <h4>
        
        <a href="/page4" class="previous">&larr;</a>
        
        <span class="page_number ">Страница 5 из 71</span>
        
        <a href="/page6" class="next">&rarr;</a>
        
    </h4>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Ivan Grishaev's blog</li>
          <li><a href="mailto:ivan@grishaev.me">ivan@grishaev.me</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
            <li><a href="https://github.com/igrishaev">GitHub</a></li>
            <li><a href="tg://resolve?domain=igrishaev_blog">Telegram</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Writing on programming, education, books and negotiations.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
