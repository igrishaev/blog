<!DOCTYPE html>
<html lang="ru">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Ivan Grishaev's blog</title>
  <meta name="description" content="Writing on programming, education, books and negotiations.
">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/custom.css">
  <link rel="canonical" href="https://grishaev.me/page5/">
  <link rel="alternate" type="application/rss+xml" title="Ivan Grishaev's blog" href="https://grishaev.me/feed.xml">

  <link rel="shortcut icon" type="image/x-icon" href="/assets/static/favicons/favicon.ico">

  <script type="text/javascript" src="/assets/typo.js"></script>

</head>


  <body>
    <header class="site-header">

    <div class="wrapper flex-container">

        <div>
            <a href="/">
                <img id="avatar" src="/assets/static/avatar.jpg" alt="Ivan Grishaev">
            </a>
        </div>

        <div class="flex-container-vert" style="margin-left: 15px; width: 80%">

            <div class="flex-container full-width">
                <p style="margin-bottom: 5px">Ivan Grishaev's blog</p>
                <div class="flex-huge"></div>
                <div >
<form id="search-form"
      target="_blank"
      style="display: inline"
      method="get"
      action="https://www.google.com/search">

    <input name="sitesearch"
           value="grishaev.me"
           type="hidden">

    <input type="text"
           required="required"
           name="q"
           placeholder="Google search..."
           autocomplete="off">

    <button style="border: none; background-color: transparent; cursor: pointer;"
            type="submit">&#x1f50d;</button>

</form>
</div>
            </div>

            <p><small>Writing on programming, education, books and negotiations.
</small></p>

            <div class="flex-container">
                <a class="menu-item" href="/">Home</a>
                <a class="menu-item" href="/about/">About</a>
                <a class="menu-item" href="/bookshelf/">Bookshelf</a>
                <a class="menu-item" href="/feed.xml">RSS</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor" href="/tag/clojure/">Clojure</a>
                <a class="menu-item minor" href="/tag/emacs/">Emacs</a>
                <a class="menu-item minor" href="/tag/python/">Python</a>
                <a class="menu-item minor" href="/tag/programming/">Programming</a>
                <a class="menu-item minor" href="/interview/">Interview</a>
                <a class="menu-item minor" href="/video/">Video</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor hl" href="/clojure-in-prod/">Книга «Clojure на производстве»</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor hl" href="/clojure-in-prod-2/">Книга «Clojure на производстве», второй том</a>
            </div>

        </div>
    </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="home">

    <ul class="post-list">
        
        <li>

            <h2>
                <a class="post-link" href="/win-skynet/">Винда и Скайнет</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2024-07-27T00:00:00+00:00">
        Jul 27, 2024
    </time>

    <a href="/tag/windows/" rel="tag">windows</a>, <a href="/tag/skynet/" rel="tag">skynet</a>

</div>


            <div class="entry">
                
                    <p>То, что произошло недавно с виндой, напоминает Скайнет из франшизы про
Терминатора. Напомню, по сюжету все компьютеры захватил вирус. Далее он построил
роботов, которые пошли убивать людей. На тот момент это было слишком
фантастично, потому что единовременно обрушить все компьютеры в те дни было
невозможно. Не было такой связанности и централизованности. Не было такого, что
каждый утюг качает обновления по три раза в день и ставит автоматом.</p>

<p>А сегодня — пожалуйста! Какие-то бедолаги налажали с указателями, и легла сотая
часть компов на виндузе. Если вам кажется, то это мало, то вы не правы. В одном
только здании может быть нескольких сотен устройств на винде. Тем сотым компом,
что лег из-за обновления, может быть кассовый сервер в Пятерочке, банкомат,
шлагбаум на вокзале, дашборд службы спасения.</p>

<p>Это наводит на рассуждения. Были же истории с пилотами, которые нарочно гробили
себя и сотни пассажиров. Порой я думаю: вдруг найдется такой же маньяк, только в
цифровой сфере? Кто-то, кто устроит цифровой Judgement Day. Он выпустит
обновление, которое разойдется по всем виндовым компам, подождет годик-другой и
потом вжух — затрет файлы нулями, подаст напряжение на USB-порты, разгонит
видеокарты, словом — сделает максимум деструктива.</p>

<p>Все это фантазии, но проблема в том, что они уже не так фантастичны, как в
терминаторе. Теоретически они стали возможны, и Микрософт сотоварищи это
доказали.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/json-sql/">Как наполнить базу сгенерированными джейсонами</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2024-07-27T00:00:00+00:00">
        Jul 27, 2024
    </time>

    <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/sql/" rel="tag">sql</a>, <a href="/tag/json/" rel="tag">json</a>, <a href="/tag/postgres/" rel="tag">postgres</a>

</div>


            <div class="entry">
                
                    <p>Предположим, у вас Postgres с миллионами JSONb-документов. Вы хотите проверить
нагрузку на стейджинге, но данные с прода брать нельзя – их нужно сгенерить. Тут
начинаются проблемы.</p>

<p>Размножить один и тот же джейсон будет неправильным, потому что все они дадут
одинаковое значение индекса. В итоге индекс будет “перекошен”: миллион записей
попадут в один блок, а остальные сто тысяч будут равномерны. В реальности так не
бывает.</p>

<p>Второй вопрос – как генерить. Можно взять язык, на котором вы пишете, и
наколбасить случайные словари в CSV. Потом сжать в gzip, перетащить на сервер с
базой, распаковать и вставить через COPY IN. Но придется писать код и воевать с
передачей файлов по SCP/SSH.</p>

<p>Я склоняюсь к вот такому костылику.</p>

<p>Берем с прода любой JSON, записываем в локальный файл с красивым
форматированием. Например:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"meta"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"eyes"</span><span class="p">:</span><span class="w"> </span><span class="s2">"brown"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"attrs"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"email"</span><span class="p">:</span><span class="w"> </span><span class="s2">"petr@test.com"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Petr Ivanov"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"roles"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"user"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"admin"</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Здесь он маленький для экономии места, а на проде может быть пять экранов. После
этого пропускам файл через серию регулярок:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat </span>sample.json | <span class="nb">sed</span> <span class="se">\</span>
     <span class="nt">-e</span> <span class="s2">"s/</span><span class="se">\"</span><span class="s2">/'/g"</span> <span class="nt">-e</span> <span class="s1">'s/: /, /g'</span> <span class="se">\</span>
     <span class="nt">-e</span> <span class="s1">'s/{/jsonb_build_object(/g'</span> <span class="se">\</span>
     <span class="nt">-e</span> <span class="s1">'s/}/\)/g'</span> <span class="se">\</span>
     <span class="nt">-e</span> <span class="s1">'s/\[/jsonb_build_array(/g'</span> <span class="se">\</span>
     <span class="nt">-e</span> <span class="s1">'s/\]/)/g'</span>
</code></pre></div></div>

<p>Получается SQL-код, который строит тот же самый JSON:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">jsonb_build_object</span><span class="p">(</span>
    <span class="s1">'meta'</span><span class="p">,</span> <span class="n">jsonb_build_object</span><span class="p">(</span>
        <span class="s1">'eyes'</span><span class="p">,</span> <span class="s1">'brown'</span>
    <span class="p">),</span>
    <span class="s1">'attrs'</span><span class="p">,</span> <span class="n">jsonb_build_object</span><span class="p">(</span>
        <span class="s1">'email'</span><span class="p">,</span> <span class="s1">'petr@test.com'</span><span class="p">,</span>
        <span class="s1">'name'</span><span class="p">,</span> <span class="s1">'Petr Ivanov'</span>
    <span class="p">),</span>
    <span class="s1">'roles'</span><span class="p">,</span> <span class="n">jsonb_build_array</span><span class="p">(</span>
        <span class="s1">'user'</span><span class="p">,</span>
        <span class="s1">'admin'</span>
    <span class="p">)</span>
<span class="p">)</span>
</code></pre></div></div>

<p>Наберите в консоли <code class="language-plaintext highlighter-rouge">SELECT</code> и вставьте эту колбасу. База выплюнет в точности тот
JSON, который был в файле.</p>

<p>Если форматировать JSON лень, добавьте в пайп утилиту <code class="language-plaintext highlighter-rouge">jq</code> — по умолчанию она
просто форматирует документ.</p>

<p>Это был только один джейсон. Теперь размножим его с помощью <code class="language-plaintext highlighter-rouge">select ... from
generate_series...</code></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="n">jsonb_build_object</span><span class="p">(</span>
    <span class="s1">'meta'</span><span class="p">,</span> <span class="n">jsonb_build_object</span><span class="p">(</span>
        <span class="s1">'eyes'</span><span class="p">,</span> <span class="s1">'brown'</span>
    <span class="p">),</span>
    <span class="s1">'attrs'</span><span class="p">,</span> <span class="n">jsonb_build_object</span><span class="p">(</span>
        <span class="s1">'email'</span><span class="p">,</span> <span class="s1">'petr@test.com'</span><span class="p">,</span>
        <span class="s1">'name'</span><span class="p">,</span> <span class="s1">'Petr Ivanov'</span>
    <span class="p">),</span>
    <span class="s1">'roles'</span><span class="p">,</span> <span class="n">jsonb_build_array</span><span class="p">(</span>
        <span class="s1">'user'</span><span class="p">,</span>
        <span class="s1">'admin'</span>
    <span class="p">)</span>
<span class="p">)</span> <span class="k">as</span> <span class="n">document</span>
<span class="k">from</span>
    <span class="n">generate_series</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="k">as</span> <span class="n">x</span><span class="p">;</span>
</code></pre></div></div>

<p>Выборка вернет столько документов, сколько чисел в диапазоне
<code class="language-plaintext highlighter-rouge">generate_series</code>. Но это один и тот же документ, что не подходит. Пройдитесь по
значимым полям документа и замените статичные строки на форматирование, например
так (переменная <code class="language-plaintext highlighter-rouge">x</code> ссылается на текущее значение <code class="language-plaintext highlighter-rouge">generate_series</code>):</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="n">jsonb_build_object</span><span class="p">(</span>
    <span class="s1">'meta'</span><span class="p">,</span> <span class="n">jsonb_build_object</span><span class="p">(</span>
        <span class="s1">'eyes'</span><span class="p">,</span> <span class="n">format</span><span class="p">(</span><span class="s1">'color-%s'</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="p">),</span>
    <span class="s1">'attrs'</span><span class="p">,</span> <span class="n">jsonb_build_object</span><span class="p">(</span>
        <span class="s1">'email'</span><span class="p">,</span> <span class="n">format</span><span class="p">(</span><span class="s1">'user-%s@test.com'</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span>
        <span class="s1">'name'</span><span class="p">,</span> <span class="n">format</span><span class="p">(</span><span class="s1">'Test Name %s'</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="p">),</span>
    <span class="s1">'roles'</span><span class="p">,</span> <span class="n">jsonb_build_array</span><span class="p">(</span>
        <span class="s1">'user'</span><span class="p">,</span>
        <span class="s1">'admin'</span>
    <span class="p">)</span>
<span class="p">)</span> <span class="k">as</span> <span class="n">document</span>
<span class="k">from</span>
    <span class="n">generate_series</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="k">as</span> <span class="n">x</span><span class="p">;</span>
</code></pre></div></div>

<p>Новая выборка станет такой:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>                                                     document
-------------------------------------------------------------------------------------------------------------------------
 {"meta": {"eyes": "color-1"}, "attrs": {"name": "Test Name 1", "email": "user-1@test.com"}, "roles": ["user", "admin"]}
 {"meta": {"eyes": "color-2"}, "attrs": {"name": "Test Name 2", "email": "user-2@test.com"}, "roles": ["user", "admin"]}
 {"meta": {"eyes": "color-3"}, "attrs": {"name": "Test Name 3", "email": "user-3@test.com"}, "roles": ["user", "admin"]}
 {"meta": {"eyes": "color-4"}, "attrs": {"name": "Test Name 4", "email": "user-4@test.com"}, "roles": ["user", "admin"]}
 {"meta": {"eyes": "color-5"}, "attrs": {"name": "Test Name 5", "email": "user-5@test.com"}, "roles": ["user", "admin"]}
(5 rows)
</code></pre></div></div>

<p>Вставим выборку в таблицу документов:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">create</span> <span class="k">table</span> <span class="n">documents</span><span class="p">(</span><span class="n">id</span> <span class="n">uuid</span><span class="p">,</span> <span class="n">document</span> <span class="n">jsonb</span><span class="p">)</span>
</code></pre></div></div>

<p>Для этого допишем в запрос шапку <code class="language-plaintext highlighter-rouge">INSERT</code>:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">insert</span> <span class="k">into</span> <span class="n">documents</span> <span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">document</span><span class="p">)</span>
<span class="k">select</span>
    <span class="n">gen_random_uuid</span><span class="p">()</span> <span class="k">as</span> <span class="n">id</span><span class="p">,</span>
    <span class="n">jsonb_build_object</span><span class="p">(</span>
        <span class="s1">'__generated__'</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span>
        <span class="s1">'meta'</span><span class="p">,</span> <span class="n">jsonb_build_object</span><span class="p">(</span>
            <span class="s1">'eyes'</span><span class="p">,</span> <span class="n">format</span><span class="p">(</span><span class="s1">'color-%s'</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="p">),</span>
        <span class="s1">'attrs'</span><span class="p">,</span> <span class="n">jsonb_build_object</span><span class="p">(</span>
            <span class="s1">'email'</span><span class="p">,</span> <span class="n">format</span><span class="p">(</span><span class="s1">'user-%s@test.com'</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span>
            <span class="s1">'name'</span><span class="p">,</span> <span class="n">format</span><span class="p">(</span><span class="s1">'Test Name %s'</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="p">),</span>
        <span class="s1">'roles'</span><span class="p">,</span> <span class="n">jsonb_build_array</span><span class="p">(</span>
            <span class="s1">'user'</span><span class="p">,</span>
            <span class="s1">'admin'</span>
        <span class="p">)</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">document</span>
<span class="k">from</span>
    <span class="n">generate_series</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span> <span class="k">as</span> <span class="n">x</span>
<span class="n">returning</span>
    <span class="n">id</span><span class="p">;</span>
</code></pre></div></div>

<p>Обратите внимание на поле <code class="language-plaintext highlighter-rouge">__generated__</code>: я добавил его, чтобы отличить обычный
документ от сгенерированного.</p>

<p>Запустите запрос, и в таблице окажется миллион случайных документов. Вставка
может занять до пары минут, потому что JSONb — дорогое удовольствие.</p>

<p>Если что-то пошло не так, удалите сгенерированные документы запросом:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">delete</span> <span class="k">from</span> <span class="n">documents</span>
<span class="k">where</span> <span class="n">document</span> <span class="o">-&gt;</span> <span class="s1">'__generated__'</span> <span class="o">=</span> <span class="s1">'true'</span><span class="p">::</span><span class="n">jsonb</span><span class="p">;</span>
</code></pre></div></div>

<p>Удобство в том, что не нужны питоны-джавы, все делается силами SQL. Не придется
генерировать CSV и перетаскивать на сервер. Просто выполнили запрос — и пошли
дальше.</p>

<p>Обязательно сохраните скрипт в недрах проекта. Он понадобится если не завтра, то
через месяц, а если не вам, то коллеге. И вы такой раз — как Джонни Старк на
картинке.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/js-madness/">Помешательство</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2024-07-24T00:00:00+00:00">
        Jul 24, 2024
    </time>

    <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/javascript/" rel="tag">javascript</a>, <a href="/tag/frontend/" rel="tag">frontend</a>, <a href="/tag/madness/" rel="tag">madness</a>

</div>


            <div class="entry">
                
                    <p>Может быть, писал про это раньше, лень искать.</p>

<p>Допустим, у нас современное веб-приложение: на сервере только REST API, а рендер
силами JavaScript. Одна из апишек отдает сведения о покупках: число, сумму и
дату последней покупки. Что-то вроде такого:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"total_orders"</span><span class="p">:</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span><span class="w">
  </span><span class="nl">"total_sum"</span><span class="p">:</span><span class="w"> </span><span class="s2">"523626"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"last_order_date"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2023-12-23T12:23:55Z"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>(сумма в копейках, если что)</p>

<p>Ожидается, что на клиенте мы покажем эту информацию так:</p>

<blockquote>
  <p>Вы совершили семь покупок на сумму 5.236 рублей 26 копеек. Последний раз вы
покупали 23 декабря, 20 дней назад.</p>
</blockquote>

<p>Чтобы отрендерить этот блок, нам понадобятся:</p>

<ul>
  <li>библиотека “число прописью”, чтобы 7 стало “семь”;</li>
  <li>склонение с учетом числительных: 1 покупка, 3 покупки, 5 покупок;</li>
  <li>форматирование суммы;</li>
  <li>форматирование дат;</li>
  <li>вычитание дат (20 дней назад);</li>
  <li>возможно, мультиязычные шаблоны, если в приложении несколько языков.</li>
</ul>

<p>И думаю: есть же люди, которые всерьез делают это на JavaScript(!) в
браузере(!!). Подключают тонны библиотек из npm, пишут экраны кода, компилируют
мегабайтные бандлы. Запускают всю эту машинерию, кодят месяц и в итоге получают
что-то похожее на результат. Который, конечно, работает только в Хроме на
4К-мониторе. На мобиле обрежется, в Фаерфоксе разъедется, в Сафари будет белый
экран.</p>

<p>Что движет этими людьми, интересно? И кто за них отвечает? Что за извращенное
удовольствие: из всех вариантов выбрать самый хрупкий и тяжелый?</p>

<p>Похоже на массовое помешательство.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/bye-googl/">Прощай, Goo.gl!</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2024-07-24T00:00:00+00:00">
        Jul 24, 2024
    </time>

    <a href="/tag/google/" rel="tag">google</a>

</div>


            <div class="entry">
                
                    <p>Новость о том, что Гугл отключает сокращалку goo.gl, вызвала вьетнамские
флешбеки.</p>

<p>Пятнадцать лет назад я был ее активным пользователем. Я тогда жил в Чите и
работал в славной компании “Читаэнергосбыт”. Параллельно я пытался сделать
какой-нибудь стартап. А поскольку ничего придумать не мог, все поделки сводились
к перекладыванию данных: из RSS в Твиттер, из одной соцсети в другую и так
далее.</p>

<p>В те времена у Твиттера не было сокращалки урлов. Вставил в сообщение ссылку — и
прощай 40-50 символов. Сегодня это звучит дико, но тем не менее. Это был золотой
век всяких tr.im, bit.ly и goo.gl — пока у каждой соцести не появились
внутренние сокращалки.</p>

<p>Пока я тестировал свои поделки, сократил около 15 тысяч урлов. Я даже написал
<a href="https://github.com/igrishaev/googl-python">библиотеку-клиент</a>, и это был, наверное, мой первый опенсорс.</p>

<p>Так вот, возвращаясь к закрытию сокращалки. Если бы я услышал эту новость хотя
бы год назад, я бы вознегодовал и написал гневный пост: как так, денег и
поддержки не просит, зачем закрывать? А сегодня мне безразлично.</p>

<p>Во-первых, технически забрать данные об урлах проще простого. Не нужные никакие
экспорты, достаточно баш-скрипта с курлом и флажком “don’t follow
redirects”. Если у вас на сайте есть гугловые ссылки, заменить их нормальными —
дело часа. Это технический аспект.</p>

<p>Второй аспект — моральный. Сокращалки урлов устарели и считаются моветоном. Ими
пользуются мошенники, СЕО-дрочеры и всякий озабоченный люд, которым важно,
сколько раз нажали ссылку, вместо того, что было за ней. Если я вижу сокращенную
ссылку, я никогда не нажму на нее, и советую вам то же самое.</p>

<p>У сокращалок урлов был короткий период расцвета. Тогда еще не знали последствий,
и сокращать урлы считалось крутым и молодежным. Были плагины для форумов и
вордпрессов, которые сокращали все ссылки и подкачивали в админку стату
переходов. Но все это в прошлом: у крупных игроков свои методы отслеживания
ссылок, а мелким игрокам пользы от сокращалок нет.</p>

<p>Третий аспект касается денег. Обязательно найдется тот, кто скажет: у Гугла
денег куры не клюют, пусть поддерживают. Дело в том, что это противоречит миссии
Гугла. Его цель — зарабатывать деньги. Это ясно уже лет десять, и почему
сокращалка урлов, не приносящая денег, должна быть исключением? Она не приносит
денег, поэтому ее нужно закрыть.</p>

<p>Ситуация, когда какой-нибудь менеждер толкает речь на совете директоров о том,
что мы должны поддерживать пользователей, потому что обещали им… и все такие:
да, что же с нами стало, давайте оставим, только бы не сделать пользователям
плохо… Представили картину? Так не бывает. Это возможно в фильме, но не в
реальности.</p>

<p>На эту тему советую почитать “Цель 2” Голдрата, причем не обязательно целиком, а
хотя бы первую главу. Там как раз заседание директоров, и акулы рвут на части
благие намерения. Почему — хорошо описано в диалоге с одной из акул во второй
главе.</p>

<p>Так что все своим чередом. Конфето-букетные отношения между пользователями и
Гуглом закончились, остался один расчет. Гугл закрыл еще один сервис. Эпоха
ушла, жизнь продолжается.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/money-input/">Ввод денег</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2024-07-20T00:00:00+00:00">
        Jul 20, 2024
    </time>

    <a href="/tag/ui/" rel="tag">ui</a>, <a href="/tag/money/" rel="tag">money</a>, <a href="/tag/widget/" rel="tag">widget</a>

</div>


            <div class="entry">
                
                    <p>Интересно, бывают ли безглючные виджеты для ввода денег? Например, чтобы ввести
тысячу сорок три рубля и тринадцать копеек — при этом так, чтобы не помянуть
разработчика и его родню.</p>

<p>По умолчанию в поле стоит ноль, и запросто бывает так, что курсор падает перед
ним. В результате цифра умножается на десять. Что-то вроде такого:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>|0
123|0
</code></pre></div></div>

<p>Ни один виджет не работает со вставкой. Разработчик думает, что клиент сел — и
такой ввел шесть цифр по памяти. На практике люди копируют цифры изо всяких
экселей и платежек. Везде беда с десятичным разделителем, пробелами и позицией
курсора.</p>

<p>Зачем эти потуги, если результат все равно бажный?</p>

<p>Интересное решение я видел у Пейпала. У них ввод суммы сделан как в старых
терминалах. Нужно ввести сумму с точностью до цента, при этом цифры наползают
справа налево. Постарался изобразить это табличкой:</p>

<table>
  <thead>
    <tr>
      <th>state</th>
      <th>input</th>
      <th>result</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0.00</td>
      <td>1</td>
      <td>0.01</td>
    </tr>
    <tr>
      <td>0.01</td>
      <td>2</td>
      <td>0.12</td>
    </tr>
    <tr>
      <td>0.12</td>
      <td>3</td>
      <td>1.23</td>
    </tr>
    <tr>
      <td>1.23</td>
      <td>4</td>
      <td>12.34</td>
    </tr>
  </tbody>
</table>

<p>Все жестко, никаких вариантов. Не уверен, что такой ввод подойдет нам, потому
что у нас нет таких терминалов. Но взять на заметку стоит: меньше вариативности
— больше надежности.</p>

<p>PS: не привожу скришноты, потому что не вижу смысла. Любой банк, любое
приложение. Виджеты денег не работают нигде.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/aws-sdk-last/">И ещё об AWS SDK</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2024-07-20T00:00:00+00:00">
        Jul 20, 2024
    </time>

    <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/aws/" rel="tag">aws</a>, <a href="/tag/sdk/" rel="tag">sdk</a>, <a href="/tag/s3/" rel="tag">s3</a>

</div>


            <div class="entry">
                
                    <p>Последняя заметка об AWS SDK и все — закрываю тему, чтобы не утомлять.</p>

<p>Почему я взъелся на этот SDK? Потому что в мире Кложи это своего рода
проклятье. Нужно работать с сервисами Амазона и казалось бы — бери Джавный SDK и
пиши обертку. Но библиотеки Амазона ужасны: нужно 25 пакетов ради HTTP-запроса,
а классы написаны по отвратительному паттерну. Вдобавок это добро не
компилируется Граалем — а у нас все на нем. В результате у нас самописные
клиенты к S3, Dynamo, CloudWatch и десятку других сервисов.</p>

<p>Меня это совсем не радует, потому что клиенты реализованы частично. Если нужна
новая апишка, то открывай доку и пиши код. Самая жесть с сигнатурами. За
короткое время я нашел два бага в библиотеке aws-sign, которая подписывает
запрос. Отлаживать сигнатуры — такая грусть и боль, что и не хочется вспоминать.</p>

<p>Узнав про SDK 2.0, я подумал, что пора перевести наш зоопарк на официальные
библиотеки AWS. Пусть их поддерживают другие люди, а нам не придется кувыркаться
с сигнатурами и прочим. Быстрый гуглеж показал, что SDK 2.0 дружит с Граалем, и
я засел.</p>

<p>Написал обертку, компилирую — не работает. Полез в интернет и выяснилось,
что… даже руки опускаются от отчаяния. Релиз, который поддерживает GraalVM и
компиляцию native-image, был год назад. За это время код поменяли, а нового
релиза с Граалем не делали.</p>

<p>Может быть, со стороны это звучит непоятно, но я поражен. Либо ты поддерживаешь
GraalVM, либо нет. Он накладывает ограничения на Джава-код, поэтому важно
принять решение и следовать ему. А у ребят из Амазона получились релизы
Шредингера: этот поддерживает, тот нет, а следующий, возможно, будет снова
поддерживать.</p>

<p>Технически это лечится дополнительным шагом в CI, где текущая ветка
компилируется Граалем, и если что-то не так — изменения не принимаются. Новый
шаг добавляется в CI за пару часов без преувеличений. И только после этого можно
писать в readme: да, мы поддерживаем Грааль. А не так — один раз получилось,
значит, получится всегда.</p>

<p>Мысль о стажерах, которых сажают писать SDK, пока нет другой работы, крепнет во
мне все сильнее.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/aws-sdk-fix/">SDK, работа над ошибками</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2024-07-20T00:00:00+00:00">
        Jul 20, 2024
    </time>

    <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/aws/" rel="tag">aws</a>, <a href="/tag/sdk/" rel="tag">sdk</a>, <a href="/tag/s3/" rel="tag">s3</a>

</div>


            <div class="entry">
                
                    <p>Давайте поможем инженерам из Amazon с их SDK 2.0. Разберем наиболее серьезную
ошибку – частичную инициализацию объекта.</p>

<p>В прошлой заметке я упоминал, как создаются объекты в SDK. Если коротко, у
классов скрыты конструкторы, и нужно пользоваться билдером. Получается что-то
вроде такого:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">GetObjectRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="nc">GetObjectRequest</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
  <span class="o">.</span><span class="na">bucket</span><span class="o">(</span><span class="s">"acme-releases"</span><span class="o">)</span>
  <span class="o">.</span><span class="na">key</span><span class="o">(</span><span class="s">"path/to/file.txt"</span><span class="o">)</span>
  <span class="o">.</span><span class="na">ifEtagMatches</span><span class="o">(</span><span class="s">"...."</span><span class="o">)</span>
  <span class="o">.</span><span class="na">ifModifiedSince</span><span class="o">(</span><span class="s">"..."</span><span class="o">)</span>
  <span class="o">.</span><span class="na">build</span><span class="o">()</span>
</code></pre></div></div>

<p>Билдер не знает, какие из параметров обязательны, а какие нет. В примере выше
код работает. Если убрать вызов .bucket или .key, все скомпилируется, но при
запуске получим:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Execution error (IllegalArgumentException)
at ....xml.internal.marshall.SimpleTypePathMarshaller

Parameter 'Bucket' must not be null
</code></pre></div></div>

<p>Обратите внимание, что ошибка приехала из какого-то XML-маршаллера, хотя
никакого XML и тем более маршаллизации здесь нет. Тело пустое, и просто
составляется URL.</p>

<p>Подчеркну: программистам из Амазона вполне ОК, что объект инициирован
частично. Спрашивается, что можно сделать с объектом <code class="language-plaintext highlighter-rouge">GetObjectRequest</code>, если у
него не заполнен бакет? Ничего. Зачем тогда позволять такую ситуацию?</p>

<p>Как они вообще представляют работу со своим SDK? Пользователь садится и
перебором проверяет, какие поля нужны, а какие нет? Ладно я знаю, что бакет и
ключ необходимы, но ведь кто-то не знает. И узнает он только когда бахнет прод.</p>

<p>Проблема решается просто. Все поля объекта делятся на обязательные и нет – по
аналогии с аргументами <code class="language-plaintext highlighter-rouge">args</code> и <code class="language-plaintext highlighter-rouge">kwargs</code> в Питоне. Обязательные поля потому так
и называются, что без них невозможно дернуть конструктор или порождающий
статичный метод. В нашем случае обязательны бакет и ключ. С ними код становится
таким:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">GetObjectRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">GetObjectRequest</span><span class="o">(</span>
  <span class="s">"acme-releases"</span><span class="o">,</span> <span class="s">"path/to/file"</span>
<span class="o">).</span><span class="na">withEtag</span><span class="o">(</span><span class="s">"..."</span><span class="o">)</span>
  <span class="o">.</span><span class="na">withModifiedSince</span><span class="o">(</span><span class="s">"..."</span><span class="o">)</span>
</code></pre></div></div>

<p>либо то же самое с билдером:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">GetObjectRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="nc">GetObjectRequest</span><span class="o">.</span><span class="na">builder</span><span class="o">(</span>
  <span class="s">"acme-releases"</span><span class="o">,</span> <span class="s">"path/to/file"</span><span class="o">)</span>
<span class="o">.</span><span class="na">etag</span><span class="o">(</span><span class="s">"..."</span><span class="o">)</span>
  <span class="o">.</span><span class="na">modifiedSince</span><span class="o">(</span><span class="s">"..."</span><span class="o">)</span>
  <span class="o">.</span><span class="na">build</span><span class="o">()</span>
</code></pre></div></div>

<p>То есть хоть разбейся в лепешку, но обязательные параметры передай.</p>

<p>Ну? Что мешало так сделать? Здесь даже паттерны сохранены, чтобы не пострадало
чувство прекрасного.</p>

<p>Заметим, что я не говорю отсебятину: все это сказано в книге Effective Java
авторства Джошуа Блоха. Он так и пишет: используйте неизменяемые объекты, не
допускайте частичной инициализации, требуйте обязательные поля сразу – не
надейтесь, что кто-то заполнит из позже. Кумир джавистов говорит, как делать
правильно. Почему в Амазоне решили, что сами с усами?</p>

<p>Впрочем, пока я писал это, подумал – может, все гораздо проще? Может быть, за
SDK сажают мидлов и стажеров, пока они без задач? Скажем, наняли стажера, а у
тимлида релиз, погружать человека некогда, поэтому его сажают за SDK. Вполне
похоже на правду.</p>

<p>У нас так было в Датаарте: пока человек без работы, его сажали за всякий
внутренний хлам. Форму заказа пиццы, аукцион парковочных мест, каталог
сотрудников. Все это было крайне низкого качества, потому что шло через десятки
джунов и мидлов без какого-либо контроля качества.</p>

<p>Может и в Амазоне такой же порядок? Кто знает, расскажите. Потому что чем иначе
объяснить такое качество SDK – я не знаю.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/solid/">SOLID</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2024-07-19T00:00:00+00:00">
        Jul 19, 2024
    </time>

    <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/solid/" rel="tag">solid</a>

</div>


            <div class="entry">
                
                    
<p>На мой взгляд, у SOLID есть важное и полезное применение — унижать людей на
собесах. Очень помогает в найме, когда на должность претендует сто человек, а
нам не нужны неудачники. Уверен, в Амазон брали только тех, кто этот SOLID
знает. <a href="/patterns/">Результат налицо</a>.</p>

<p>О других преимуществах SOLID мне неизвестно.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/patterns/">Паттерны</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2024-07-19T00:00:00+00:00">
        Jul 19, 2024
    </time>

    <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/patterns/" rel="tag">patterns</a>, <a href="/tag/java/" rel="tag">java</a>

</div>


            <div class="entry">
                
                    <p>Одна из худших вещей в айти – это паттерны. Когда я слышу “паттерн”, меня
трясет. Хочется, чтобы паттернов было как можно меньше, а может быть, однажды мы
доживем до счастливого дня, когда в программировании не будет паттернов.</p>

<p>Откуда такой радикализм? Дело в том, что паттерн – это костыль. Помните картинку
с жуком, где слева баг, а справа фича? То же самое с паттерном. Это прокол
языка, который решили подпереть костылем.</p>

<p>Builder, Visitor, Singleton – все это ошибки в дизайне языка. Чемпионами по их
количеству являются C++ и Java. Вряд ли кто-то в здравом уме назовет их хорошо
спроектированными языками.</p>

<p>Builder – прямое следствие того, что нет параметров по умолчанию. Visitor – цена
за убогую систему типов и ООП в целом. Singleton вообще рак мозга – кто-то
решил, что объект нельзя создать дважды, хотя внятного объяснения этому нет.</p>

<p>Если взять любую книгу по Джаве, половина ее будет о том, как делать не надо и
какой паттерн брать взамен. Не лучше ли убрать из языка то, чего делать не надо?
Я понимаю, легаси и все такое, но все же.</p>

<p>Книги Банды Четырех и талмуды толщиной с руку, где учат паттернам, наводят
гнетущее впечатление. Столько труда потрачено на костыли, чтобы обойти ошибки
языка!</p>

<p>Паттерн – это о том, как сделать удобней компилятору или IDE. Ни слова о том,
чтобы сделать удобно потребителю кода.</p>

<p>Беда паттернов в том, что они плохо влияют на программиста. Он буквально тупеет,
не понимая, что по-прежнему пишет плохой код, просто теперь можно сослаться на
книги или громкие имена. Мышление паттернами – это натуральная деградация. Есть
надежда, если Джава-программист поддерживает форму, ковыряясь с Лиспом или
Хаскелем. Но если он видит только паттерны с десяти до шести, это путь к
деградации и больше никуда.</p>

<p>Пример из реальной жизни – Amazon AWS SDK для Джавы. Казалось бы: самое
популярное облако, самый популярный язык, самые сильные программисты. Почему же
они пишут абсолютное говно, которым нельзя пользоваться? Потому что в голове
паттерны, а не задача сделать удобно.</p>

<p>Если вы не знаете, все пакеты SDK V1 следуют паттерну POJO. Это когда каждый
класс SDK имеет нулевой конструктор и пачку геттеров и сеттеров. Например,
какой-нибудь GetObjectRequest создается так:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">GetObjectRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">GetObjectRequest</span><span class="o">();</span>
<span class="n">request</span><span class="o">.</span><span class="na">setBucket</span><span class="o">(</span><span class="s">"some_bucket"</span><span class="o">)</span>
<span class="n">request</span><span class="o">.</span><span class="na">setKey</span><span class="o">(</span><span class="s">"path/to/file.txt"</span><span class="o">)</span>
<span class="n">request</span><span class="o">.</span><span class="na">setIfModifiedSince</span><span class="o">(...)</span>
</code></pre></div></div>

<p>И таких классов тысячи – в буквальном смысле. Нигде не сказано, какой из
сеттеров является обязательным. Можно запросто убрать вызов <code class="language-plaintext highlighter-rouge">setBucket</code>, и
запрос будет без бакета. При запуске кода вы получите исключение в рантайме.</p>

<p>Паттерн есть? Есть. Удобно? Нет. Вы же не будете гонять код вручную на S3 каждый
раз, когда меняете какой-то сеттер. Поэтому все сводится к тому, чтобы поправить
код, прогнать CI и задеплоить на тестовое окружение, чтобы дернуть там и
убедиться, что работает. Займет час. Умные ребята поднимают для этого Докер с
локальным min.io, но так бывает не везде.</p>

<p>Написав тысячи битых классов, инженеры Амазона почесали голову и сели за AWS SDK
V2.0. На этот раз с другим паттерном – Builder. Теперь каждый класс создается
цепочкой:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">GetObjectRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="nc">GetObjectRequest</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
  <span class="o">.</span><span class="na">bucket</span><span class="o">(</span><span class="s">"some_bucket"</span><span class="o">)</span>
  <span class="o">.</span><span class="na">key</span><span class="o">(</span><span class="s">"path/to/file.txt"</span><span class="o">)</span>
  <span class="o">.</span><span class="na">ifModifiedSince</span><span class="o">(...)</span>
  <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</code></pre></div></div>

<p>Казалось бы, удобно, современно, все как у Джошуа Блоха. Однако я по-прежнему не
вижу, какие параметры обязательны. Легко пропустить метод .bucket и получить
объект, который не знает, в какой бакет обращаться.</p>

<p>А вот реальный пример с тегом. Тег – это объект, который хранит пару
ключ-значение. Других полей у него нет. Казалось бы, сделай конструктор с двумя
полями, чтобы было так:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Tag</span> <span class="n">tag</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Tag</span><span class="o">(</span><span class="s">"release"</span><span class="o">,</span> <span class="s">"test-123.4"</span><span class="o">);</span>
</code></pre></div></div>

<p>Но нельзя, у нас же паттерн! Нужен билдер и методы для каждого поля. В
результате имеем:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Tag</span> <span class="n">tag</span> <span class="o">=</span> <span class="nc">Tag</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">value</span><span class="o">(</span><span class="s">"42"</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>

<span class="err">#</span><span class="n">object</span><span class="o">[....</span><span class="na">s3</span><span class="o">.</span><span class="na">model</span><span class="o">.</span><span class="na">Tag</span> <span class="o">...</span> <span class="s">"Tag(Value=42)"</span><span class="o">]</span>
</code></pre></div></div>

<p>Смотрю и не понимаю – как так? Почему позволено иметь тег, в котором нет имени
поля?! Оно же Null и в будущем свалится с ошибкой. Как вообще можно создать тег
без имени и значения? Кто был тот тупица, который все это дизайнил? Кто нанял
клоунов в Амазон за 250 тысяч в год, чтобы они писали подобный код?</p>

<p>Они наколбасили сто новых пакетов и классов с новым паттерном. Но как было
невозможно пользоваться, так и осталось. Как так получилось?</p>

<p>Понятно, это вопросы в никуда. Программисты пишут SDK по паттерну – как сказал
знакомый джавист, “ходят строем”. Главное, чтобы строй шел ровно, а куда он
придет – и надо ли было идти – мало кто задается вопросом.</p>

<p>Пожелаю читателю использовать паттерны как можно меньше. Если вы слышите
“паттерн” – это тревожный знак.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/en/clojure-with-retry/">Clojure AntiPatterns: the with-retry macro </a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2024-07-18T00:00:00+00:00">
        Jul 18, 2024
    </time>

    <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/clojure/" rel="tag">clojure</a>, <a href="/tag/retry/" rel="tag">retry</a>, <a href="/tag/s3/" rel="tag">s3</a>

</div>


            <div class="entry">
                
                    <p>Most of clojurians write good things about Clojure only. I decided to start
sharing techniques and patterns that I consider bad practices. We still have
plenty of them in Clojure projects, unfortunately.</p>

<p>My first candidate is widely used, casual macro called <code class="language-plaintext highlighter-rouge">with-retry</code>:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">defmacro</span><span class="w"> </span><span class="n">with-retry</span><span class="w"> </span><span class="p">[[</span><span class="n">attempts</span><span class="w"> </span><span class="n">timeout</span><span class="p">]</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">body</span><span class="p">]</span><span class="w">
  </span><span class="o">`</span><span class="p">(</span><span class="nb">loop</span><span class="w"> </span><span class="p">[</span><span class="n">n</span><span class="o">#</span><span class="w"> </span><span class="o">~</span><span class="n">attempts</span><span class="p">]</span><span class="w">
     </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[[</span><span class="n">e</span><span class="o">#</span><span class="w"> </span><span class="n">result</span><span class="o">#</span><span class="p">]</span><span class="w">
           </span><span class="p">(</span><span class="nf">try</span><span class="w">
             </span><span class="p">[</span><span class="n">nil</span><span class="w"> </span><span class="p">(</span><span class="nf">do</span><span class="w"> </span><span class="o">~@</span><span class="n">body</span><span class="p">)]</span><span class="w">
             </span><span class="p">(</span><span class="nf">catch</span><span class="w"> </span><span class="n">Throwable</span><span class="w"> </span><span class="n">e</span><span class="o">#</span><span class="w">
               </span><span class="p">[</span><span class="n">e</span><span class="o">#</span><span class="w"> </span><span class="n">nil</span><span class="p">]))]</span><span class="w">
       </span><span class="p">(</span><span class="k">cond</span><span class="w">

         </span><span class="p">(</span><span class="nb">nil?</span><span class="w"> </span><span class="n">e</span><span class="o">#</span><span class="p">)</span><span class="w">
         </span><span class="n">result</span><span class="o">#</span><span class="w">

         </span><span class="p">(</span><span class="nb">&gt;</span><span class="w"> </span><span class="n">n</span><span class="o">#</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w">
         </span><span class="p">(</span><span class="nf">do</span><span class="w">
           </span><span class="p">(</span><span class="nf">Thread/sleep</span><span class="w"> </span><span class="o">~</span><span class="n">timeout</span><span class="p">)</span><span class="w">
           </span><span class="p">(</span><span class="nf">recur</span><span class="w"> </span><span class="p">(</span><span class="nb">dec</span><span class="w"> </span><span class="n">n</span><span class="o">#</span><span class="p">)))</span><span class="w">

         </span><span class="no">:else</span><span class="w">
         </span><span class="p">(</span><span class="nf">throw</span><span class="w"> </span><span class="p">(</span><span class="nb">new</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="s">"all attempts exhausted"</span><span class="w"> </span><span class="n">e</span><span class="o">#</span><span class="p">))))))</span><span class="w">
</span></code></pre></div></div>

<p>This is a very basic implementation. It catches all possible exceptions, has a
strict number of attempts, and the constant delay time. Typical usage:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">with-retry</span><span class="w"> </span><span class="p">[</span><span class="mi">3</span><span class="w"> </span><span class="mi">2000</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nf">get-file-from-network</span><span class="w"> </span><span class="s">"/path/to/file.txt"</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<p>Should network blink, most likely you’ll get a file anyway.</p>

<p>Clojure people who don’t like macros write a function like this:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">with-retry</span><span class="w"> </span><span class="p">[[</span><span class="n">attempts</span><span class="w"> </span><span class="n">timeout</span><span class="p">]</span><span class="w"> </span><span class="n">func</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nb">loop</span><span class="w"> </span><span class="p">[</span><span class="n">n</span><span class="w"> </span><span class="n">attempts</span><span class="p">]</span><span class="w">
    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[[</span><span class="n">e</span><span class="w"> </span><span class="n">result</span><span class="p">]</span><span class="w">
          </span><span class="p">(</span><span class="nf">try</span><span class="w">
            </span><span class="p">[</span><span class="n">nil</span><span class="w"> </span><span class="p">(</span><span class="nf">func</span><span class="p">)]</span><span class="w">
            </span><span class="p">(</span><span class="nf">catch</span><span class="w"> </span><span class="n">Throwable</span><span class="w"> </span><span class="n">e</span><span class="w">
              </span><span class="p">[</span><span class="n">e</span><span class="w"> </span><span class="n">nil</span><span class="p">]))]</span><span class="w">
      </span><span class="p">(</span><span class="k">cond</span><span class="w">

        </span><span class="p">(</span><span class="nb">nil?</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w">
        </span><span class="n">result</span><span class="w">

        </span><span class="p">(</span><span class="nb">&gt;</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w">
        </span><span class="p">(</span><span class="nf">do</span><span class="w">
          </span><span class="p">(</span><span class="nf">Thread/sleep</span><span class="w"> </span><span class="n">timeout</span><span class="p">)</span><span class="w">
          </span><span class="p">(</span><span class="nf">recur</span><span class="w"> </span><span class="p">(</span><span class="nb">dec</span><span class="w"> </span><span class="n">n</span><span class="p">)))</span><span class="w">

        </span><span class="no">:else</span><span class="w">
        </span><span class="p">(</span><span class="nf">throw</span><span class="w"> </span><span class="p">(</span><span class="nb">new</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="s">"all attempts exhausted"</span><span class="w"> </span><span class="n">e</span><span class="p">))))))</span><span class="w">
</span></code></pre></div></div>

<p>It acts the same but accepts not arbitrary code but a function. A form can be
easily turned into a function by putting a sharp sign in front of it. After all,
it looks almost the same:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">with-retry</span><span class="w"> </span><span class="p">[</span><span class="mi">3</span><span class="w"> </span><span class="mi">2000</span><span class="p">]</span><span class="w">
  </span><span class="o">#</span><span class="p">(</span><span class="nf">get-file-from-network</span><span class="w"> </span><span class="s">"/path/to/file.txt"</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<p>Although it is considered being a good practice, here is the outcome of using it
in production.</p>

<p>Practice proves that, even if you wrap something into that macro, you cannot
recover from a failure anyway. Imagine you’re downloading a file from S3 and
pass wrong credentials. You cannot recover no matter how many times you
retry. Wrong creds remain wrong forever. Now there is a missing file: again, no
matter how hard you retry, it’s all in vain and you only waste resources. Should
you put a file into S3, and submit wrong headers, it’s the same. If your network
is misconfigured or some resources are blocked, or you have no permissions, it’s
the same again: <strong>no matter how long have you been trying, it’s useless</strong>.</p>

<p>There might be dozens of reasons when your request fails, and there is no way to
recover. Instead of invoking a resource again and again, you must investigate
what went wrong.</p>

<p>There might be some rare cases which are worth retrying though. One of them is
an <code class="language-plaintext highlighter-rouge">IOException</code> caused by a network blink. But in fact, modern HTTP clients
already handle it for you. If you <code class="language-plaintext highlighter-rouge">GET</code> a resource and receive an <code class="language-plaintext highlighter-rouge">IOException</code>,
most likely your client has already done three attempts silently with growing
timeouts. By wrapping the call <code class="language-plaintext highlighter-rouge">with-retry</code>, you perform 9 attempts or so under
the hood.</p>

<p>Another case might be 429 error code which stands for rate limitation on the
server side. Personally I don’t think that a slight delay may help. Most likely
you need to bump the limits, rotate API keys and so on but not <code class="language-plaintext highlighter-rouge">Thread.sleep</code> in
the middle of code.</p>

<p>I’ve seen terrible usage of <code class="language-plaintext highlighter-rouge">with-retry</code> macro across various projects. One
developer specified 10 attempts with 10 seconds timeout to reach a remote API
for sure. But he was calling the wrong API handler in fact.</p>

<p>Another developer put two nested <code class="language-plaintext highlighter-rouge">with-macro</code> forms. They belonged to different
functions and thus could not be visible at once. I’m reproducing a simplified
version:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">with-retry</span><span class="w"> </span><span class="p">[</span><span class="mi">4</span><span class="w"> </span><span class="mi">1000</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nf">do-this</span><span class="w"> </span><span class="n">...</span><span class="p">)</span><span class="w">
  </span><span class="p">(</span><span class="nf">do-that</span><span class="w"> </span><span class="n">...</span><span class="p">)</span><span class="w">
  </span><span class="p">(</span><span class="nf">with-retry</span><span class="w"> </span><span class="p">[</span><span class="mi">3</span><span class="w"> </span><span class="mi">2000</span><span class="p">]</span><span class="w">
    </span><span class="p">(</span><span class="nf">do-something-else...</span><span class="p">)))</span><span class="w">
</span></code></pre></div></div>

<p>According to math, 4 times 3 is 12. When the <code class="language-plaintext highlighter-rouge">(do-something-else)</code> function
failed, the whole top-level block started again. It led to 12 executions in
total with terrible side effects and logs which I could not investigate.</p>

<p>One more case: a developer wrapped a chunk of logic that inserted something into
the database. He messed up with foreign keys so the records could not be
stored. Postgres replied with an error “foreign key constraint violation” yet
the macro tried to store them three times before failing completely. Three
broken SQL invocations… for what? Why?</p>

<p>So. Whenever you use <code class="language-plaintext highlighter-rouge">with-retry</code>, most likely it’s a bad sign. Most often you
cannot recover from a failure no matter if you add two numbers, upload a file,
or write into a database. You should only retry in certain situations like
<code class="language-plaintext highlighter-rouge">IOException</code> or rate limiting. But even those cases are questionable and might
be mitigated with no retrying.</p>

<p>Next time you’re going to cover a block of logic <code class="language-plaintext highlighter-rouge">with-retry</code>, think hard if you
really need to retry. Will it really help in case of wrong creds, a missing
file, incorrect signature or similar things? Perhaps not. Thus, don’t retry in
vain. Just fail and write detailed logs. Then find the real problem, fix it and
let it never happen again.</p>

                
            </div>

        </li>
        
    </ul>

    <h4>
        
        <a href="/page4" class="previous">&larr;</a>
        
        <span class="page_number ">Страница 5 из 83</span>
        
        <a href="/page6" class="next">&rarr;</a>
        
    </h4>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Ivan Grishaev's blog</li>
          <li><a href="mailto:ivan@grishaev.me">ivan@grishaev.me</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
            <li><a href="https://github.com/igrishaev">GitHub</a></li>
            <li><a href="https://t.me/igrishaev_blog">Telegram</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Writing on programming, education, books and negotiations.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
