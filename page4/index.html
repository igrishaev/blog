<!DOCTYPE html>
<html lang="ru">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Ivan Grishaev's blog</title>
  <meta name="description" content="Writing on programming, education, books and negotiations.
">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/custom.css">
  <link rel="canonical" href="https://grishaev.me/page4/">
  <link rel="alternate" type="application/rss+xml" title="Ivan Grishaev's blog" href="https://grishaev.me/feed.xml">

  <link rel="shortcut icon" type="image/x-icon" href="/assets/static/favicons/favicon.ico">

  <script type="text/javascript" src="/assets/typo.js"></script>

</head>


  <body>
    <header class="site-header">

    <div class="wrapper flex-container">

        <div>
            <a href="/">
                <img id="avatar" src="/assets/static/avatar.jpg" alt="Ivan Grishaev">
            </a>
        </div>

        <div class="flex-container-vert" style="margin-left: 15px; width: 80%">

            <div class="flex-container full-width">
                <p style="margin-bottom: 5px">Ivan Grishaev's blog</p>
                <div class="flex-huge"></div>
                <div >
<form id="search-form"
      target="_blank"
      style="display: inline"
      method="get"
      action="https://www.google.com/search">

    <input name="sitesearch"
           value="grishaev.me"
           type="hidden">

    <input type="text"
           required="required"
           name="q"
           placeholder="Google search..."
           autocomplete="off">

    <button style="border: none; background-color: transparent; cursor: pointer;"
            type="submit">&#x1f50d;</button>

</form>
</div>
            </div>

            <p><small>Writing on programming, education, books and negotiations.
</small></p>

            <div class="flex-container">
                <a class="menu-item" href="/">Home</a>
                <a class="menu-item" href="/about/">About</a>
                <a class="menu-item" href="/bookshelf/">Bookshelf</a>
                <a class="menu-item" href="/feed.xml">RSS</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor" href="/tag/clojure/">Clojure</a>
                <a class="menu-item minor" href="/tag/emacs/">Emacs</a>
                <a class="menu-item minor" href="/tag/python/">Python</a>
                <a class="menu-item minor" href="/tag/programming/">Programming</a>
                <a class="menu-item minor" href="/interview/">Interview</a>
                <a class="menu-item minor" href="/video/">Video</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor hl" href="/clojure-in-prod/">Книга «Clojure на производстве»</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor hl" href="/clojure-in-prod-2/">Книга «Clojure на производстве», второй том</a>
            </div>

        </div>
    </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="home">

    <ul class="post-list">
        
        <li>

            <h2>
                <a class="post-link" href="/nesting-01/">Вложенность</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2024-01-25T00:00:00+00:00">
        Jan 25, 2024
    </time>

    <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/nesting/" rel="tag">nesting</a>

</div>


            <div class="entry">
                
                    <p>Об этом никто не пишет, а ведь проблема серьезная. Я говорю о лишней вложенности
данных. Недавний пример:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="no">:manager</span><span class="w">
 </span><span class="p">{</span><span class="no">:risk</span><span class="w">
  </span><span class="p">{</span><span class="no">:time</span><span class="w"> </span><span class="s">"10:30"</span><span class="w">
   </span><span class="no">:task-id</span><span class="w"> </span><span class="mi">100400</span><span class="p">}}</span><span class="w">
 </span><span class="no">:accounter</span><span class="w">
 </span><span class="p">{</span><span class="no">:business</span><span class="w">
  </span><span class="p">{</span><span class="no">:time</span><span class="w"> </span><span class="s">"12:35"</span><span class="w">
   </span><span class="no">:task-id</span><span class="w"> </span><span class="mi">100500</span><span class="p">}}}</span><span class="w">
</span></code></pre></div></div>

<p>Это вложенная мапа: на первом уровне роль менеджера, на втором тип апрува, на
третьем — детали апрува: дата и ссылка на задачу. Спрашивается, зачем было
группировать события по роли и типу? Какой смысл? Почему не записать два
события:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[{</span><span class="no">:role</span><span class="w"> </span><span class="no">:manager</span><span class="w">
  </span><span class="no">:type</span><span class="w"> </span><span class="no">:risk</span><span class="w">
  </span><span class="no">:time</span><span class="w"> </span><span class="s">"10:30"</span><span class="w">
  </span><span class="no">:task-id</span><span class="w"> </span><span class="mi">100400</span><span class="p">}</span><span class="w">
 </span><span class="p">{</span><span class="no">:role</span><span class="w"> </span><span class="no">:accounter</span><span class="w">
  </span><span class="no">:type</span><span class="w"> </span><span class="no">:business</span><span class="w">
  </span><span class="no">:time</span><span class="w"> </span><span class="s">"12:35"</span><span class="w">
  </span><span class="no">:task-id</span><span class="w"> </span><span class="mi">100500</span><span class="p">}]</span><span class="w">
</span></code></pre></div></div>

<p>Плоско, понятно, нет вложенности. Кому надо, сгруппируют и по роли, и по дате, и
бог знает как еще. А когда сгруппировано до нас, сперва нужно распутать, а потом
группировать как надо.</p>

<p>Второй пример: есть мапа с ключом children, в которой вектор мап. В каждой мапе
— айдишка и имя:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="no">:children</span><span class="w">
 </span><span class="p">[{</span><span class="no">:id</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="no">:name</span><span class="w"> </span><span class="s">"test1"</span><span class="p">}</span><span class="w">
  </span><span class="p">{</span><span class="no">:id</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="no">:name</span><span class="w"> </span><span class="s">"test2"</span><span class="p">}</span><span class="w">
  </span><span class="p">{</span><span class="no">:id</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="no">:name</span><span class="w"> </span><span class="s">"test3"</span><span class="p">}]}</span><span class="w">
</span></code></pre></div></div>

<p>Нужно построить индекс <code class="language-plaintext highlighter-rouge">id =&gt; name</code>, чтобы потом по нему искать. Я быстренько
прошел по children и собрал словарь:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="mi">1</span><span class="w"> </span><span class="s">"test2"</span><span class="w">
 </span><span class="mi">2</span><span class="w"> </span><span class="s">"test2"</span><span class="w">
 </span><span class="mi">3</span><span class="w"> </span><span class="s">"test3"</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>На проде — сплошные промахи мимо индекса. Что такое? Оказалось, не до конца
прокрутил файлик. У некоторых children есть свои children, то есть структура
такая:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="no">:children</span><span class="w">
 </span><span class="p">[{</span><span class="no">:id</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="no">:name</span><span class="w"> </span><span class="s">"test1"</span><span class="p">}</span><span class="w">
  </span><span class="p">{</span><span class="no">:id</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="no">:name</span><span class="w"> </span><span class="s">"test2"</span><span class="p">}</span><span class="w">
  </span><span class="p">{</span><span class="no">:id</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="no">:name</span><span class="w"> </span><span class="s">"test3"</span><span class="p">}</span><span class="w">
  </span><span class="p">{</span><span class="no">:id</span><span class="w"> </span><span class="mi">4</span><span class="w">
   </span><span class="no">:name</span><span class="w"> </span><span class="s">"test4"</span><span class="w">
   </span><span class="no">:children</span><span class="w">
   </span><span class="p">[{</span><span class="no">:id</span><span class="w"> </span><span class="mi">5</span><span class="w">
     </span><span class="no">:name</span><span class="w"> </span><span class="s">"test5"</span><span class="p">}</span><span class="w">
    </span><span class="p">{</span><span class="no">:id</span><span class="w"> </span><span class="mi">6</span><span class="w">
     </span><span class="no">:name</span><span class="w"> </span><span class="s">"test6"</span><span class="w">
     </span><span class="no">:children</span><span class="w">
     </span><span class="p">[</span><span class="n">...</span><span class="p">]}]}]}</span><span class="w">
</span></code></pre></div></div>

<p>При этом ограничения в глубину нет: может быть два уровня, может двадцать.</p>

<p>Вот опять: кто этот гений, который сгруппировал? Как ты будешь это обходить?
Ладно у меня Кложа, я написал <code class="language-plaintext highlighter-rouge">(tree-seq :children :children data)</code> и готово. А
на каком-нибудь Питоне или Джаве голову сломаешь – тут дерево с обходом, нужен
стек или очередь. Алгоритмы!</p>

<p>Сделай ты плоский список и добавь parent_id. Кому надо, построит иерархию:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[{</span><span class="no">:id</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="no">:name</span><span class="w"> </span><span class="s">"test1"</span><span class="p">}</span><span class="w">
 </span><span class="p">{</span><span class="no">:id</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="no">:name</span><span class="w"> </span><span class="s">"test2"</span><span class="p">}</span><span class="w">
 </span><span class="p">{</span><span class="no">:id</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="no">:name</span><span class="w"> </span><span class="s">"test3"</span><span class="p">}</span><span class="w">
 </span><span class="p">{</span><span class="no">:id</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="no">:name</span><span class="w"> </span><span class="s">"test4"</span><span class="p">}</span><span class="w">
 </span><span class="p">{</span><span class="no">:id</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="no">:name</span><span class="w"> </span><span class="s">"test5"</span><span class="w"> </span><span class="no">:parent-id</span><span class="w"> </span><span class="mi">4</span><span class="p">}</span><span class="w">
 </span><span class="p">{</span><span class="no">:id</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="no">:name</span><span class="w"> </span><span class="s">"test6"</span><span class="w"> </span><span class="no">:parent-id</span><span class="w"> </span><span class="mi">5</span><span class="p">}]</span><span class="w">
</span></code></pre></div></div>

<p>И такое постоянно. Беру любой JSON и вижу, как его можно упростить, убрав лишнюю
вложенность. Вдвойне обидно, что на эту вложенность кто-то тратил время, а она
не нужна!</p>

<p>Особенно я не люблю, когда вкладывают равнозначные сущности. Например, у нас два
автора и у каждого две книги. JSON выглядит так:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[{</span><span class="no">:id</span><span class="w"> </span><span class="mi">1</span><span class="w">
  </span><span class="no">:name</span><span class="w"> </span><span class="s">"John Smith"</span><span class="w">
  </span><span class="no">:books</span><span class="w">
  </span><span class="p">[{</span><span class="no">:id</span><span class="w"> </span><span class="mi">20</span><span class="w">
    </span><span class="no">:title</span><span class="w"> </span><span class="s">"The Best Novels"</span><span class="p">}</span><span class="w">
   </span><span class="p">{</span><span class="no">:id</span><span class="w"> </span><span class="mi">30</span><span class="w">
    </span><span class="no">:title</span><span class="w"> </span><span class="s">"Poems"</span><span class="p">}]}</span><span class="w">
 </span><span class="p">{</span><span class="no">:id</span><span class="w"> </span><span class="mi">2</span><span class="w">
  </span><span class="no">:name</span><span class="w"> </span><span class="s">"Sam Doe"</span><span class="w">
  </span><span class="no">:books</span><span class="w">
  </span><span class="p">[{</span><span class="no">:id</span><span class="w"> </span><span class="mi">40</span><span class="w">
    </span><span class="no">:title</span><span class="w"> </span><span class="s">"Some Story"</span><span class="p">}</span><span class="w">
   </span><span class="p">{</span><span class="no">:id</span><span class="w"> </span><span class="mi">50</span><span class="w">
    </span><span class="no">:title</span><span class="w"> </span><span class="s">"Achieves"</span><span class="p">}]}]</span><span class="w">
</span></code></pre></div></div>

<p>Что если нужны не книги по авторам, а просто все книги? Опять ходи собирай.</p>

<p>Я придумал способ как бороться такими случаями. О нем — в следующий раз.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/lotus-pose/">Поза лотоса</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2024-01-25T00:00:00+00:00">
        Jan 25, 2024
    </time>

    <a href="/tag/life/" rel="tag">life</a>, <a href="/tag/idiots/" rel="tag">idiots</a>, <a href="/tag/designers/" rel="tag">designers</a>, <a href="/tag/lotus/" rel="tag">lotus</a>

</div>


            <div class="entry">
                
                    <p><img src="/assets/static/aws/lotus/1.jpeg" /></p>

<p>Когда я вижу программиста в позе лотоса, в голове играет сюжет.</p>

<p>К автору картинки приезжает особая команда. Обученные люди сажают автора в позу
лотоса и дают ноутбук. Его заставляют работать в этой позе час. За попытку
встать, размяться, подвигать шеей — избиение ноутбуком по голове, а отсчет
времени сбрасывается.</p>

<p>Глядишь, так дизайнеры отучатся рисовать программиста в позе лотоса!</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/boy-heron/">Мальчик и птица</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2024-01-25T00:00:00+00:00">
        Jan 25, 2024
    </time>

    <a href="/tag/movies/" rel="tag">movies</a>, <a href="/tag/anime/" rel="tag">anime</a>

</div>


            <div class="entry">
                
                    <p>Я знал, что этого делать не следует, но сделал — сходил на мульт “Мальчик и
птица”. Будет много скепсиса и спойлеров, я предупреждал.</p>

<p>Писать о мультике тяжело. Хаяо Миядзаки — гений и наше все, поэтому любая
критика в его адрес — что карикатуры на Мухаммеда: порвут на части. Я не буду
критиковать мастера, а только опишу ощущения от просмотра.</p>

<p>Начнем с того, что фильму не повезло с названием. В оригинале он называется “Как
поживаете?” — это заголовок книги, по которой он снят. Однако связи между
сюжетом и названием нет. Лишь один раз герой находит книгу с таким заголовком и
благополучно забывает о ней. Кто и как поживает — не ясно.</p>

<p><img src="/assets/static/aws/heron/1.jpg" /></p>

<p>В американском прокате мульт назвали “The boy and the heron” — мальчик и
цапля. Это правильно, потому что мальчика и (псевдо)цаплю мы видим большую часть
фильма. И хотя у слова “heron” однозначный перевод — цапля, Карл!, — в русском
прокате она стала птицей. Эта претензия не к Миядзаки, а к переводчикам.</p>

<p>В целом, мульт страдает от тех же проблем, что и <a href="/avatar2/">второй Аватар</a>. При
запредельном качестве картинки в нем никакой сюжет, все скомкано и
ситуативно. Зрителя отвлекает миллион незначащих деталей. Досадно, что бюджет
спустили на визуальную красоту, попустившись смыслом.</p>

<p><img src="/assets/static/aws/heron/2.jpg" /></p>

<p>Мульт идет 2 часа 10 минут — не так уж и мало. Первые 40 минут — это топтание на
тему “не ходи в запретное место”. Понятно, что когда ребенку говорят не ходить
куда-то, он пойдет, вопрос в том, как скоро. Но с этим большая затяжка.</p>

<p>Когда герой входит в запретное место, начинается фантасмагория. Каждые десять
минут он проваливается в новый мир со своими причудами. Мелькают локации,
существа, загадочные сцены. Все это красиво, но требует ответов: кто это,
откуда, зачем и что если? Режиссер не считает нужным все это объяснять; он
забрасывает героя в новую локацию, где другие существа, враги и друзья. Словно
летишь на карусели и видишь только мелькание.</p>

<p><img src="/assets/static/aws/heron/3.jpg" /></p>

<p>Иногда режиссер дает отдохнуть: показывает пять минут, как девушка режет хлеб,
мажет маслом и ест. Ме-е-едленно и основа-а-ательно. Без музыки, только звон
посуды и скрип пола. Красиво, но опять же — назрел миллион вопросов, может,
объясните хоть что-нибудь? А бутерброд потерпит.</p>

<p>Если вы думаете, что я цепляюсь зря, то вот малая толика вопросов:</p>

<ul>
  <li>Зачем герой рассек голову камнем?</li>
  <li>Зачем мачеха пошла в башню?</li>
  <li>Почему нельзя входить в родильную комнату?</li>
  <li>Почему мачеха гонит героя прочь?</li>
  <li>Какую роль играл нерожденный ребенок? Его хотели забрать? Кто и зачем?</li>
  <li>Какую цель преследовал король попугаев?</li>
  <li>Что за камни, из которых колдун строил башню? Почему они злые?</li>
  <li>Что за хранитель гробницы? Почему его не показали?</li>
  <li>Это все один мир или разные?</li>
  <li>Если парень в мире мертвых — он умер?</li>
  <li>Мать парня умерла в больнице или вознеслась на небо, потому что была огненным духом?</li>
  <li>Что стало в параллельном мире после апокалипсиса?</li>
  <li>Куда делся дед-колдун? Кто унаследовал его?</li>
</ul>

<p>Этих вопросов я могу написать пару экранов, но не вижу смысла. Спрашиваю вас:
может быть, из всей этой каши надо было выбрать что-то одно и хорошенько его
проработать? А не вываливать на голову, как тарелку с лапшой.</p>

<p><img src="/assets/static/aws/heron/4.jpg" /></p>

<p>Как я уже говорил, сюжету не хватает целостности: непонятно, какую проблему
решает герой. Он отправился в башню, чтобы спасти мачеху, однако:</p>

<ul>
  <li>
    <p>на чердаке он находит послание умершей матери — книгу “Как поживаете?”. Что
там написано и какую роль играет находка — не ясно.</p>
  </li>
  <li>
    <p>В мире мертвых живут забавные пузыри, которые улетают и становятся
людьми. Этих пузырей жрут пеликаны. Показана сцена, где они слопали почти все
пузыри. Как это относится к мачехе? Мы ее спасаем или нерожденных людей?</p>
  </li>
  <li>
    <p>В мире мертвых живет женщина-рыболов, при этом она вовсе не мертвая. Что она
там делает и зачем помогает герою — непонятно.</p>
  </li>
  <li>
    <p>В другом мире живет горящая девочка, которую приносят в жертву главному
колдуну. Намекается, что девочка — сестра мачехи и мать героя в мире людей. Как
все это связано, можно только гадать.</p>
  </li>
</ul>

<p>В сюжете напутаны сложные отношения: смущение подростка перед молодой мачехой,
отстранение от отца, наставничество колдуна. Все это эпизодически, ситуативно,
без малейшей проработки.</p>

<p>Пожалуй, главное: нет морали. Совершенно не ясно, от чего предостерегает
режиссер. Как жить, чтобы это не повторилось? Или наоборот: все, что случилось —
хорошо? Где ориентиры?</p>

<p><img src="/assets/static/aws/heron/5.jpg" /></p>

<p>Изумила пара сцен:</p>

<ul>
  <li>
    <p>отец дает беременной жене чемодан со словами “осторожно, он тяжелый”. После
чего смотрит, как она тащит его в коляску. Помочь беременной жене? Не слышали.</p>
  </li>
  <li>
    <p>Парнишка бьет себя камнем по голове, из нее вытекает ЛИТР крови. Парень
спокойно идет домой. Хотел бы я это видеть. Нельзя было как-то реалистичней? Как
писал выше, тема самонаказания не раскрыта.</p>
  </li>
</ul>

<p>Словом, если вы смотрели другие мульты Миядзаки, сходите на “Мальчика и птицу”
из чувства долга: все-таки прощальный мульт. Недочеты можно списать на фирменный
стиль автора: кроме него таких мультов (почти) никто не делает. В отрыве от
остального творчества Миядзаки мульт затянут и скучноват. Очень на любителя.</p>

<p>PS: если речь пошла об аниме, в следующем посте расскажу о другом мульте,
который, напротив, советую посмотреть.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/en/pg2-bench-2">PG2 benchmarks, part 2</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2024-01-24T00:00:00+00:00">
        Jan 24, 2024
    </time>

    <a href="/tag/clojure/" rel="tag">clojure</a>, <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/postgres/" rel="tag">postgres</a>, <a href="/tag/sql/" rel="tag">sql</a>

</div>


            <div class="entry">
                
                    
<h2>

    Table of Content

</h2>

<ul id="toc-item-pg2-bench-2">
  <li><a href="#introduction" id="toc-item-pg2-bench-2-introduction">Introduction</a></li>
  <li><a href="#test-1-sending-1000-requests-in-series" id="toc-item-pg2-bench-2-test-1-sending-1000-requests-in-series">Test 1. Sending 1000 requests in series</a></li>
  <li><a href="#test-2-sending-1000-requests-with-concurrency-of-16" id="toc-item-pg2-bench-2-test-2-sending-1000-requests-with-concurrency-of-16">Test 2. Sending 1000 requests with concurrency of 16</a></li>
  <li><a href="#test-3-sending-1000-requests-with-concurrency-of-64" id="toc-item-pg2-bench-2-test-3-sending-1000-requests-with-concurrency-of-64">Test 3. Sending 1000 requests with concurrency of 64</a></li>
</ul>

<p>In the <a href="/en/pg2-bench-1">previous post</a>, I was measuring bare query/execute/copy functions
of the library. Although it’s useful, it doesn’t render the whole picture
because it’s unclear how an application will benefit from faster DB access.</p>

<p>This post covers the second group of benchmarks I made: a simple HTTP server
that reads random data from the database and responds with JSON. The benchmark
compares PG2 and Next.JDBC as before.</p>

<h2 id="introduction">Introduction</h2>

<p>Some general notes: the server uses Ring Jetty version 1.7.1, JVM 21, Ring-JSON
0.5.1 for middleware. The handles are synchronous. The application uses
connection pools for both libraries, and the pools are opened in advance when
the server gets started. The maximum allowed pool size is 64. HTTP requests are
sent by the <code class="language-plaintext highlighter-rouge">ab</code> utility with different <code class="language-plaintext highlighter-rouge">-n</code> and <code class="language-plaintext highlighter-rouge">-c</code> keys; the <code class="language-plaintext highlighter-rouge">-l</code> flag is
always sent.</p>


                    <p><a href="/en/pg2-bench-2">Read more &rarr;</a></p>
                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/en/pg2-bench-1">PG2 early announce and benchmarks, part 1</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2024-01-22T00:00:00+00:00">
        Jan 22, 2024
    </time>

    <a href="/tag/clojure/" rel="tag">clojure</a>, <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/postgres/" rel="tag">postgres</a>, <a href="/tag/sql/" rel="tag">sql</a>

</div>


            <div class="entry">
                
                    
<p><em>TL;DR: <a href="https://github.com/igrishaev/pg2">https://github.com/igrishaev/pg2</a></em></p>

<h2>

    Table of Content

</h2>

<ul id="toc-item-pg2-bench-1">
  <li><a href="#introduction" id="toc-item-pg2-bench-1-introduction">Introduction</a></li>
  <li><a href="#how-the-benchmarks-were-made" id="toc-item-pg2-bench-1-how-the-benchmarks-were-made">How the benchmarks were made</a></li>
  <li><a href="#test-1-querying-a-single-column-series-based-query-with-50000-rows" id="toc-item-pg2-bench-1-test-1-querying-a-single-column-series-based-query-with-50000-rows">Test 1. Querying a single-column, series-based query with 50000 rows</a></li>
  <li><a href="#benchmark-2-a-complex-multi-column-randomly-generated-select-query" id="toc-item-pg2-bench-1-benchmark-2-a-complex-multi-column-randomly-generated-select-query">Benchmark 2. A complex, multi-column, randomly generated SELECT query</a></li>
  <li><a href="#test-3-querying-randomly-generated-json" id="toc-item-pg2-bench-1-test-3-querying-randomly-generated-json">Test 3. Querying randomly generated JSON</a></li>
  <li><a href="#test-4-inserting-a-single-row-with-no-transaction" id="toc-item-pg2-bench-1-test-4-inserting-a-single-row-with-no-transaction">Test 4. Inserting a single row with no transaction</a></li>
  <li><a href="#test-5-inserting-a-row-in-a-transaction" id="toc-item-pg2-bench-1-test-5-inserting-a-row-in-a-transaction">Test 5. Inserting a row in a transaction</a></li>
  <li><a href="#test-6-copy-in-a-vast-csv-file-from-disk" id="toc-item-pg2-bench-1-test-6-copy-in-a-vast-csv-file-from-disk">Test 6. COPY IN a vast CSV file from disk</a></li>
  <li><a href="#test-7-copy-in-a-collection-of-rows-in-csv-format" id="toc-item-pg2-bench-1-test-7-copy-in-a-collection-of-rows-in-csv-format">Test 7. Copy IN a collection of rows in CSV format</a></li>
  <li><a href="#test-8-copy-in-a-collection-of-rows-in-binary-format" id="toc-item-pg2-bench-1-test-8-copy-in-a-collection-of-rows-in-binary-format">Test 8. Copy IN a collection of rows in binary format</a></li>
  <li><a href="#test-9-copy-out-a-table-into-an-outputstream" id="toc-item-pg2-bench-1-test-9-copy-out-a-table-into-an-outputstream">Test 9. COPY OUT a table into an OutputStream</a></li>
  <li><a href="#test-10-measuring-connection-pools" id="toc-item-pg2-bench-1-test-10-measuring-connection-pools">Test 10. Measuring connection pools</a></li>
</ul>

<h2 id="introduction">Introduction</h2>

<p>During the last year, I was working on <a href="https://github.com/igrishaev/pg">PG</a> — JDBC-free PostgreSQL driver in
pure Clojure. By purity it means, there is only a TCP socket to read and write
bytes according to the official PostgreSQL protocol, and nothing more.</p>

<p>It was fun: the very idea of implementing something low-level in Clojure was a
challenge. I’ve made a series of tricks to squeeze the performance: mutable
collections in favour of Clojure’s ones, special macros to traverse collections
using Iterator and .forEach, and so on. After all, my driver was about 1.5 times
slower than Next.JDBC, and I still think there is room for further improvement.</p>

<p>One may ask what is the point of making a driver from scratch in 2024. The
reason is, I’m still missing plenty of Postgres features when working with it
from Clojure. Namely:</p>

<ul>
  <li>
    <p>no built-in JSON support. In every project, I’ve got to extend some protocols
with PGObject, encode and decode the JSON manually;</p>
  </li>
  <li>
    <p>no COPY support. In Postgres, COPY IN/OUT is one of the best features I can
remember. But there is no built-in CSV nor binary encoding, for example.</p>
  </li>
  <li>
    <p>Poor time support: selecting a timestamp returns an instance of
<code class="language-plaintext highlighter-rouge">java.sql.Timestamp</code> which is based on <code class="language-plaintext highlighter-rouge">java.util.Date</code>: a mutable object
deprecated in Java 1.1.</p>
  </li>
  <li>
    <p>Poor array support: only a certain number of types, no multidimensional
arrays, etc.</p>
  </li>
  <li>
    <p>No built-in connection pool.</p>
  </li>
</ul>

<p>Today I deprecated the PG project in favour of <a href="https://github.com/igrishaev/pg2">PG2</a>. This is a successor
of PG(one), my second attempt to make a JDBC-free driver for Postgres. This time
around, it’s written completely in Java with a thin Clojure layer. I’ve made
some benchmarks and it looks like PG2 2-3 times faster than Next.JDBC. There is
no documentation yet, only integration tests that cover plenty of cases (I
borrowed the old tests and improved then). Although the documentation is highly
required, I could not wait to announce PG2 and share the benchmarks.</p>

<h2 id="how-the-benchmarks-were-made">How the benchmarks were made</h2>

<p>I’ve got three Mac devices with core i5, i9, and ARM M1 processors. On each
device, I’ve got PostgreSQL installed. All the settings are default, no changes
are made. JVM is version 21 although the 16th is the minimum version. The
benchmarks are made with Criterium version 0.4.6.</p>

<p>There are two types of benchmarks, actually. In the first group, I measure
query/execute functions using the Criterium framework. In the second group, I’m
running a simple HTTP server using Ring + Jetty + JSON and measuring requests
per second with Apache Benchmark (ab). For each test, I show the source code
with a chart and comments.</p>

<p>The source code of benchmarks can be found <a href="https://github.com/igrishaev/pg2/blob/master/pg-bench/src/pg/bench.clj">in the repository</a>.</p>


                    <p><a href="/en/pg2-bench-1">Read more &rarr;</a></p>
                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/pre-2024/">Предновогоднее</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2023-12-31T00:00:00+00:00">
        Dec 31, 2023
    </time>

    <a href="/tag/ny/" rel="tag">NY</a>, <a href="/tag/2024/" rel="tag">2024</a>

</div>


            <div class="entry">
                
                    <p>Этот пост — просто чтобы сказать что-нибудь хорошее перед Новым годом.</p>

<p>Спасибо всем, кто меня читает. Я отключил аналитику и не знаю, становится ли
читателей больше или меньше. Хочется верить, что кому-то все еще интересны мои
статьи. Надеюсь, это сохранится и в будущем.</p>

<p>Недавно я перенес партию заметок и Телеграма в блог, и в комментариях упрекнули,
что много нытья про плохой софт. Я перечитал и понял, что это так. Давно
заметил: находить недостатки в чужой работе легко. Можно взять айфон и найти
сотню недостатков в интерфейсе. Это обеспечит блог постами на год вперед, но
кому интересен поток жалоб?</p>

<p>Поэтому я решил писать меньше о проблемах софта и больше — о чем-нибудь
другом. На ум приходят такие темы:</p>

<ul>
  <li>
    <p>большой пост про майнинг с картинками. Я майнил два года, были фермы, горы
железа и прочего. Год назад я вышел из майнинга и теперь могу рассказать о
нем.</p>
  </li>
  <li>
    <p>драйвер для Постгреса. Недавно я переписал его на Джаве и теперь он в три раза
быстрее, чем next.jdbc Шона Корфилда. Пишу и сам в это не верю. Но многое
нужно поправить, прежде чем выкатить релиз.</p>
  </li>
  <li>
    <p>пост про 1С, на котором я писал года три-четыре еще в Чите. Меня задевает,
когда про 1С рассуждают те, кто знает его со слов свата кума сестры. Расскажу,
как за вечер сделать на 1С то, что фронтендеры пилят месяцами.</p>
  </li>
</ul>

<p>Всем удачи и добра, увидимся в новом году.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/yt-player/">Плеер в Ютубе</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2023-12-29T00:00:00+00:00">
        Dec 29, 2023
    </time>

    <a href="/tag/ui/" rel="tag">ui</a>, <a href="/tag/youtube/" rel="tag">youtube</a>

</div>


            <div class="entry">
                
                    <p>У плеера в Ютубе серьезный косяк, от которого просто опускаются руки. Он не
целостный, а состоит из многих виджетов. При этом кнопка пробела влияет на тот
виджет, что сейчас активен.</p>

<p>Пример: если щелкнуть по видео, фокус будет на временной шкале. Пробел ставит
видео на паузу. Если кликнуть по динамику, выключится звук, и фокус окажется на
виджете звука. Нажимая пробел, вы будете включать и выключать звук.</p>

<p>Если кликнуть по кнопке субтитров, пробел переключится на их включение и
выключение. Аналогично с гайкой и выпадашкой из нее.</p>

<p>Ясен хрен, так быть не должно. Пробел должен отвечать за что-то одно, а не все
разом в зависимости от того, где сейчас фокус. Это мышление кодера: да, плеер
сложный и логично, что он состоит из компонентов. Но какое мне дело как
пользователю? Представьте радиоприемник, где у кнопок разные функции в
зависимости от угла к северу или фазы Луны. А для фронтендера это — обычное
дело.</p>

<p>Наконец, попытайтесь объяснить эти мульки пожилому родственнику или ребенку,
которого вы усадили смотреть Ютуб. И в последний момент черт дернул вас кликнуть
по виджету звука. В итоге фокус остался на нем, и каждый раз, когда родственник
жал пробел, чтобы поставить на паузу, он выключал звук.</p>

<p>Я уже говорил, что нам не везет с фронтендерами. Почему-то они не могут сделать
нормальный интефейс, хоть в Гугле, хоть Амазоне, получая при этом космические
деньги.</p>

<p>Чтож, подождем.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/update-observation/">Наблюдение</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2023-12-29T00:00:00+00:00">
        Dec 29, 2023
    </time>

    <a href="/tag/update/" rel="tag">update</a>, <a href="/tag/software/" rel="tag">software</a>

</div>


            <div class="entry">
                
                    <p>Обновить программу, которая долго просит обновиться, в надежде, что она оставит
тебя в покое – то же самое, что дать денег алкашу. Через какое-то время он
придет снова, но будет просить настойчивее.</p>

<p>Нужно расстаться раньше этого.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/two-problems/">Две проблемы</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2023-12-29T00:00:00+00:00">
        Dec 29, 2023
    </time>

    <a href="/tag/work/" rel="tag">work</a>, <a href="/tag/problems/" rel="tag">problems</a>, <a href="/tag/absctractions/" rel="tag">absctractions</a>

</div>


            <div class="entry">
                
                    <p>Говорят, в программировании две проблемы: инвалидация кэша и именование
переменных. Не знаю, я никогда не испытывал с этим проблем. Чтобы не сбрасывать
кэш, просто пиши без кэша. Проще оптимизировать SQL-запрос, чем возиться с
условным Редисом.</p>

<p>Переменные называй как хочешь, главное — не терять темп при написании кода. Если
я думаю над именем больше секунды, то пишу foo и bar. Когда код готов,
становится ясно, во что их переименовать.</p>

<p>Истинные две проблемы программирования другие.</p>

<p>Первая — программист закладывает абстракции там, где не следует. Иными словами,
готовится к тому, что никогда не произойдет. Например, делает наследование из
трех классов или внедряет ОРМ на случай переезда на другую базу. И никогда не
переезжает.</p>

<p>Вторая проблема — наоборот: программист не оставляет шанса поправить его
код. Скажем, сервис должен вернуть список сущностей, и программист честно отдает
массив в JSON. И теперь нужно добавить в ответ какую-то мету, но сделать это
нелья — у нас вектор, а не мапа. Приходится исправлять на мапу и выносить мозг
клиентам, чтобы поправили у себя.</p>

<p>Как только первое и второе правила согласуются с реальностью, жить и работать
становится проще.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/things-1/">Вещи, которые должны были сделать жизнь лучше (1)</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2023-12-29T00:00:00+00:00">
        Dec 29, 2023
    </time>

    <a href="/tag/things/" rel="tag">things</a>

</div>


            <div class="entry">
                
                    <p>В этом посте я собирал технологии, которые должны были сделать нашу жизнь лучше,
но не срослось. Пока что это первая часть. Список далеко не полный, если у вас
есть что добавить, пишите — внесу.</p>

<p><strong>Уведомления</strong></p>

<p>Идея была хорошая: программа, даже если она не запущена, показывает текст о том,
что случилось. Но уведомления приняли лавинообразный характер. Представьте, что
творится с телефоном, где 40 приложений, и каждое шлет уведомления. Большая их
часть бессмысленна и нужна только затем, чтобы пользователь открыл
программу. Поэтому первое, что делает нормальный человек при покупке телефона —
откючает весь этот зоопарк.</p>

<p>А есть еще уведомления в браузере! Кто их там включает в здравом уме, не
представляю.</p>

<p><strong>Обновления</strong></p>

<p>Мы живем в мире непрерывных обновлений. Обновляются программы, пакеты, прошивки,
операционные системы. По умолчанию обновления включены, и это настоящий ад.</p>

<p>Редкая программа обновлятся молча. Чаще всего нам показывают модалки, которые
нельзя скрыть. Никого не волнует, что обновление одной программы сломало
другую. Обновления рушат процессы, вынуждают людей простаивать, потому что ноут
ушел в обновление. Скрипт, который стабильно работал полгода, упал из-за нового
пакета.</p>

<p>Происходит то же самое, что с уведомлениями: когда непрерывно обновляется все,
лучше бы не обновлялось ничего.</p>

<p><strong>Голосовые меню</strong></p>

<p>Верю, что за ними стояли благие намерения: дозвонился человек, а мы ему и курсы
валют расскажем, и расписание отделений, и ставки по вкладам — только нажми
кнопку. Проблема в том, что чаще всего человек звонит с одной целью — обсудить
вопрос с другим человеком. Голосовое меню становится препятствием, и
единственное, чего хочет клиент — чтобы его поскорей соединили с оператором.</p>

<p>Например, десять вечера, ребенок заболел. Я звоню в аптеку, чтобы узнать, есть
ли то, что нужно. А там номер 8-800: сначала здравствуйте, потом свежие
предложения, перечисление пунктов меню. Оператор поддержки сидит в Туле за
тысячу километров. Какая от него может быть помощь? Поэтому я звоню только в
аптеки с городским номером.</p>

<p>Забавно, что лет двенадцать назад я делал голосовое меню для Энергосбыта в
Чите. Находил это очень важным и полезным для абонентов.</p>

<p><strong>Синтез речи</strong></p>

<p>С обработкой речи ситуация спорная. С одной стороны, прикольно управлять Алисой:
включать музыку, спрашивать погоду и всякие мелочи. С другой стороны, технологии
речи привели к телефонному спаму. Раз в пару дней звонок из банка, где
заскриптован разговор сотрудника, предлагающего кредит. Сделано очень
реалистично: если не прислушаться, можно разговаривать с машиной, как с живым
человеком. Эту технику переняли различные мошенники, и их жертв стало больше.</p>

<p>Фирм, которые предлагают телефонный спам, совсем немного, буквально пять. Одна
из них находится в Воронеже. У нас на митапе выступал ее основатель. Если
отбросить мыльную формулировку “оказание услуг по информированию населения
посредством телефонной и сотовой связи”, то останется то, ради чего фирма и
создавалась — спам. Так что имейте ввиду: когда вам звонит робот с предложением
списать долги, велика вероятность, что это дело рук одного хорошего воронежца.</p>

<p><em>(продолжение следует)</em></p>

                
            </div>

        </li>
        
    </ul>

    <h4>
        
        <a href="/page3" class="previous">&larr;</a>
        
        <span class="page_number ">Страница 4 из 73</span>
        
        <a href="/page5" class="next">&rarr;</a>
        
    </h4>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Ivan Grishaev's blog</li>
          <li><a href="mailto:ivan@grishaev.me">ivan@grishaev.me</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
            <li><a href="https://github.com/igrishaev">GitHub</a></li>
            <li><a href="tg://resolve?domain=igrishaev_blog">Telegram</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Writing on programming, education, books and negotiations.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
