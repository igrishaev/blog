<!DOCTYPE html>
<html lang="ru">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Ivan Grishaev's blog</title>
  <meta name="description" content="Writing on programming, education, books and negotiations.
">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/custom.css">
  <link rel="canonical" href="https://grishaev.me/page13/">
  <link rel="alternate" type="application/rss+xml" title="Ivan Grishaev's blog" href="https://grishaev.me/feed.xml">

  <link rel="shortcut icon" type="image/x-icon" href="/assets/static/favicons/favicon.ico">

  <script type="text/javascript" src="/assets/typo.js"></script>

</head>


  <body>
    <header class="site-header">

    <div class="wrapper flex-container">

        <div>
            <a href="/">
                <img id="avatar" src="/assets/static/avatar.jpg" alt="Ivan Grishaev">
            </a>
        </div>

        <div class="flex-container-vert" style="margin-left: 15px; width: 80%">

            <div class="flex-container full-width">
                <p style="margin-bottom: 5px"><a href="/">Ivan Grishaev's blog</a></p>
                <div class="flex-huge"></div>
                <div >
<form id="search-form"
      target="_blank"
      style="display: inline"
      method="get"
      action="https://www.google.com/search">

    <input name="sitesearch"
           value="grishaev.me"
           type="hidden">

    <input type="text"
           required="required"
           name="q"
           placeholder="Google search..."
           autocomplete="off">

    <button style="border: none; background-color: transparent; cursor: pointer;"
            type="submit">&#x1f50d;</button>

</form>
</div>
            </div>

            <p><small>Writing on programming, education, books and negotiations.
</small></p>

            <div class="flex-container">
                <a class="menu-item" href="/">Home</a>
                <a class="menu-item" href="/about/">About</a>
                <a class="menu-item" href="/open-source/">Open Source</a>
                <a class="menu-item" href="/bookshelf/">Bookshelf</a>
                <a class="menu-item" href="/feed.xml">RSS</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor" href="/tag/clojure/">Clojure</a>
                <a class="menu-item minor" href="/tag/emacs/">Emacs</a>
                <a class="menu-item minor" href="/tag/python/">Python</a>
                <a class="menu-item minor" href="/tag/programming/">Programming</a>
                <a class="menu-item minor" href="/interview/">Interview</a>
                <a class="menu-item minor" href="/video/">Video</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor hl" href="/clojure-in-prod/">Книга «Clojure на производстве»</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor hl" href="/clojure-in-prod-2/">Книга «Clojure на производстве», второй том</a>
            </div>

        </div>
    </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="home">

    <ul class="post-list">
        
        <li>

            <h2>
                <a class="post-link" href="/ai-everywhere/">Всюду AI</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2024-11-22T00:00:00+00:00">
        Nov 22, 2024
    </time>

    <a href="/tag/ai/" rel="tag">ai</a>, <a href="/tag/life/" rel="tag">life</a>

</div>


            <div class="entry">
                
                    <p>Наиболее раздражающий тренд сегодня — это когда каждая программа подсовывает
AI. Открываешь гугло-док, а сверху плашка: попробуй Gemini at no
cost. Открываешь Feedly — а там AI-анализатор твоих фидов. Открываешь Хром — а
там AI-алгоритм для группировки вкладок.</p>

<p>Все это в выпадашках, выпадашках, выпадашках. Даже если закрыл, покажут через
два дня опять.</p>

<p>Когда-нибудь AI-истерия, конечно, пройдет. Просто иной раз думаешь — почему я
опять должен пережидать очередной вирусняк? Ждать, пока программы отпустит от
блокчейна, BLM, прайда и прочего? Я ведь не просил, оно само пришло.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/ring-jdk-adapter/">Ring JDK Adapter</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2024-11-15T00:00:00+00:00">
        Nov 15, 2024
    </time>

    <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/clojure/" rel="tag">clojure</a>, <a href="/tag/ring/" rel="tag">ring</a>, <a href="/tag/http/" rel="tag">http</a>, <a href="/tag/java/" rel="tag">java</a>

</div>


            <div class="entry">
                
                    
<p><a href="https://github.com/igrishaev/ring-jdk-adapter">Ring JDK Adapter</a> is a small wrapper on top of a built-in HTTP server
available in Java. It’s like Jetty but has no dependencies. It’s almost as fast
as Jetty, too (see benchmars below).</p>

<h2 id="why">Why</h2>

<p>Sometimes you want a local HTTP server in Clojure, e.g. for testing or mocking
purposes. There is a number of adapters for Ring but all of them rely on third
party servers like Jetty, Undertow, etc. Running them means to fetch plenty of
dependencies. This is tolerable to some extent, yet sometimes you really want
something quick and simple.</p>

<p>Since version 9 or 11 (I don’t remember for sure), Java ships its own HTTP
server. The package name is <code class="language-plaintext highlighter-rouge">com.sun.net.httpserver</code> and the module name is
<code class="language-plaintext highlighter-rouge">jdk.httpserver</code>. The library provides an adapter to serve Ring handlers. It’s
completely free from any dependencies.</p>

<p>Ring JDK Adapter is a great choice for local HTTP stubs or mock services that
mimic HTTP services. Despite some people think it’s for development purposes
only, the server is pretty fast! One can use it even in production.</p>

<h2 id="availability">Availability</h2>

<p>It’s worth mentioning that some Java installations may miss the <code class="language-plaintext highlighter-rouge">jdk.httpserver</code>
module. Please ensure the JVM you’re using in production supports it
first. Check out the following links:</p>

<ul>
  <li><a href="https://stackoverflow.com/questions/58764710/is-package-com-sun-net-httpserver-standard">StackOverflow: Is package com.sun.net.httpserver
standard?</a></li>
  <li><a href="https://docs.oracle.com/en/java/javase/21/docs/api/index.html">Java® Platform, Standard Edition &amp; Java Development Kit Version 21 API Specification</a></li>
</ul>

<h2 id="installation">Installation</h2>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">;; lein</span><span class="w">
</span><span class="p">[</span><span class="n">com.github.igrishaev/ring-jdk-adapter</span><span class="w"> </span><span class="s">"0.1.0"</span><span class="p">]</span><span class="w">

</span><span class="c1">;; deps</span><span class="w">
</span><span class="n">com.github.igrishaev/ring-jdk-adapter</span><span class="w"> </span><span class="p">{</span><span class="no">:mvn/version</span><span class="w"> </span><span class="s">"0.1.0"</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Requires Java version at least 16, Clojure at least 1.8.0.</p>

<h2 id="quick-demo">Quick Demo</h2>

<p>Import the namespace, declare a Ring handler as usual:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">ns</span><span class="w"> </span><span class="n">demo</span><span class="w">
  </span><span class="p">(</span><span class="no">:require</span><span class="w">
   </span><span class="p">[</span><span class="n">ring.adapter.jdk</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">jdk</span><span class="p">]))</span><span class="w">

</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">handler</span><span class="w"> </span><span class="p">[</span><span class="n">request</span><span class="p">]</span><span class="w">
  </span><span class="p">{</span><span class="no">:status</span><span class="w"> </span><span class="mi">200</span><span class="w">
   </span><span class="no">:headers</span><span class="w"> </span><span class="p">{</span><span class="s">"Content-Type"</span><span class="w"> </span><span class="s">"text/plain"</span><span class="p">}</span><span class="w">
   </span><span class="no">:body</span><span class="w"> </span><span class="s">"Hello world!"</span><span class="p">})</span><span class="w">
</span></code></pre></div></div>

<p>Pass it into the <code class="language-plaintext highlighter-rouge">server</code> function and check the http://127.0.0.1:8082 page in
your browser:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">server</span><span class="w">
  </span><span class="p">(</span><span class="nf">jdk/server</span><span class="w"> </span><span class="n">handler</span><span class="w"> </span><span class="p">{</span><span class="no">:port</span><span class="w"> </span><span class="mi">8082</span><span class="p">}))</span><span class="w">
</span></code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">server</code> function returns an instance of the <code class="language-plaintext highlighter-rouge">Server</code> class. To stop it,
pass the result into the <code class="language-plaintext highlighter-rouge">jdk/stop</code> or <code class="language-plaintext highlighter-rouge">jdk/close</code> functions:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">jdk/stop</span><span class="w"> </span><span class="n">server</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>Since the <code class="language-plaintext highlighter-rouge">Server</code> class implements <code class="language-plaintext highlighter-rouge">AutoCloseable</code> interface, it’s compatible
with the <code class="language-plaintext highlighter-rouge">with-open</code> macro:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nb">with-open</span><span class="w"> </span><span class="p">[</span><span class="n">server</span><span class="w"> </span><span class="p">(</span><span class="nf">jdk/server</span><span class="w"> </span><span class="n">handler</span><span class="w"> </span><span class="n">opt?</span><span class="p">)]</span><span class="w">
  </span><span class="n">...</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>The server gets closed once you’ve exited the macro. Here is a similar
<code class="language-plaintext highlighter-rouge">with-server</code> macro which acts the same:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">jdk/with-server</span><span class="w"> </span><span class="p">[</span><span class="n">handler</span><span class="w"> </span><span class="n">opt?</span><span class="p">]</span><span class="w">
  </span><span class="n">...</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<h2 id="parameters">Parameters</h2>

<p>The <code class="language-plaintext highlighter-rouge">server</code> function and the <code class="language-plaintext highlighter-rouge">with-server</code> macro accept the second optional map
of the parameters:</p>

<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Default</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:host</code></td>
      <td>127.0.0.1</td>
      <td>Host name to listen</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:port</code></td>
      <td>8080</td>
      <td>Port to listen</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:stop-delay-sec</code></td>
      <td>0</td>
      <td>How many seconds to wait when stopping the server</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:root-path</code></td>
      <td>/</td>
      <td>A path to mount the handler</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:threads</code></td>
      <td>0</td>
      <td>Amount of CPU threads. When &gt; thn 0, a new <code class="language-plaintext highlighter-rouge">FixedThreadPool</code> executor is used</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:executor</code></td>
      <td>null</td>
      <td>A custom instance of <code class="language-plaintext highlighter-rouge">Executor</code>. Might be a virtual executor as well</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:socket-backlog</code></td>
      <td>0</td>
      <td>A numeric value passed into the <code class="language-plaintext highlighter-rouge">HttpServer.create</code> method</td>
    </tr>
  </tbody>
</table>

<p>Example:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">server</span><span class="w">
  </span><span class="p">(</span><span class="nf">jdk/server</span><span class="w"> </span><span class="n">handler</span><span class="w">
              </span><span class="p">{</span><span class="no">:host</span><span class="w"> </span><span class="s">"0.0.0.0"</span><span class="w"> </span><span class="c1">;; listen all addresses</span><span class="w">
               </span><span class="no">:port</span><span class="w"> </span><span class="mi">8800</span><span class="w">      </span><span class="c1">;; a custom port</span><span class="w">
               </span><span class="no">:threads</span><span class="w"> </span><span class="mi">8</span><span class="w">      </span><span class="c1">;; use custom fixed trhead executor</span><span class="w">
               </span><span class="no">:root-path</span><span class="w"> </span><span class="s">"/my/app"</span><span class="p">}))</span><span class="w">
</span></code></pre></div></div>

<p>When run, the handler above is be available by the address
http://127.0.0.1:8800/my/app in the browser.</p>

<h2 id="body-type">Body Type</h2>

<p>JDK adapter supports the following response <code class="language-plaintext highlighter-rouge">:body</code> types:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">java.lang.String</code></li>
  <li><code class="language-plaintext highlighter-rouge">java.io.InputStream</code></li>
  <li><code class="language-plaintext highlighter-rouge">java.io.File</code></li>
  <li><code class="language-plaintext highlighter-rouge">java.lang.Iterable&lt;?&gt;</code> (see below)</li>
  <li><code class="language-plaintext highlighter-rouge">null</code> (nothing gets sent)</li>
</ul>

<p>When the body is <code class="language-plaintext highlighter-rouge">Iterable</code> (might be a lazy seq as well), every item is sent as
a string in UTF-8 encoding. Null values are skipped.</p>

<h2 id="middleware">Middleware</h2>

<p>To gain all the power of Ring (parsed parameters, JSON, sessions, etc), wrap
your handler with the standard middleware:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">ns</span><span class="w"> </span><span class="n">demo</span><span class="w">
  </span><span class="p">(</span><span class="no">:require</span><span class="w">
    </span><span class="p">[</span><span class="n">ring.middleware.params</span><span class="w"> </span><span class="no">:refer</span><span class="w"> </span><span class="p">[</span><span class="n">wrap-params</span><span class="p">]]</span><span class="w">
    </span><span class="p">[</span><span class="n">ring.middleware.keyword-params</span><span class="w"> </span><span class="no">:refer</span><span class="w"> </span><span class="p">[</span><span class="n">wrap-keyword-params</span><span class="p">]]</span><span class="w">
    </span><span class="p">[</span><span class="n">ring.middleware.multipart-params</span><span class="w"> </span><span class="no">:refer</span><span class="w"> </span><span class="p">[</span><span class="n">wrap-multipart-params</span><span class="p">]]))</span><span class="w">

</span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">handler</span><span class="w"> </span><span class="p">(</span><span class="nb">-&gt;</span><span class="w"> </span><span class="n">handler</span><span class="w">
                  </span><span class="n">wrap-keyword-params</span><span class="w">
                  </span><span class="n">wrap-params</span><span class="w">
                  </span><span class="n">wrap-multipart-params</span><span class="p">)]</span><span class="w">
  </span><span class="p">(</span><span class="nf">jdk/server</span><span class="w"> </span><span class="n">handler</span><span class="w"> </span><span class="p">{</span><span class="no">:port</span><span class="w"> </span><span class="mi">8082</span><span class="p">}))</span><span class="w">
</span></code></pre></div></div>

<p>The wrapped handler will receive a <code class="language-plaintext highlighter-rouge">request</code> map with parsed <code class="language-plaintext highlighter-rouge">:query-params</code>,
<code class="language-plaintext highlighter-rouge">:form-params</code>, and <code class="language-plaintext highlighter-rouge">:params</code> fields. These middleware come from the <code class="language-plaintext highlighter-rouge">ring-core</code>
library which you need to add into your dependencies. The same applies to
handling JSON and the <code class="language-plaintext highlighter-rouge">ring-json</code> library.</p>

<h2 id="exception-handling">Exception Handling</h2>

<p>If something gets wrong while handling a request, you’ll get a plain text page
with a short message and a stack trace:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">handler</span><span class="w"> </span><span class="p">[</span><span class="n">request</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="c1">;; !</span><span class="w">
  </span><span class="p">{</span><span class="no">:status</span><span class="w"> </span><span class="mi">200</span><span class="w">
   </span><span class="no">:headers</span><span class="w"> </span><span class="p">{</span><span class="s">"Content-Type"</span><span class="w"> </span><span class="s">"text/plain"</span><span class="p">}</span><span class="w">
   </span><span class="no">:body</span><span class="w"> </span><span class="s">"hello"</span><span class="p">})</span><span class="w">
</span></code></pre></div></div>

<p>This is what you’ll get in the browser:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>failed to execute ring handler
java.lang.ArithmeticException: Divide by zero
	at clojure.lang.Numbers.divide(Numbers.java:190)
	at clojure.lang.Numbers.divide(Numbers.java:3911)
	at bench$handler.invokeStatic(form-init14855917186251843338.clj:8)
	at bench$handler.invoke(form-init14855917186251843338.clj:7)
	at ring.adapter.jdk.Handler.handle(Handler.java:112)
	at jdk.httpserver/com.sun.net.httpserver.Filter$Chain.doFilter(Filter.java:98)
	at jdk.httpserver/sun.net.httpserver.AuthFilter.doFilter(AuthFilter.java:82)
	at jdk.httpserver/com.sun.net.httpserver.Filter$Chain.doFilter(Filter.java:101)
	at jdk.httpserver/sun.net.httpserver.ServerImpl$Exchange$LinkHandler.handle(ServerImpl.java:873)
	at jdk.httpserver/com.sun.net.httpserver.Filter$Chain.doFilter(Filter.java:98)
	at jdk.httpserver/sun.net.httpserver.ServerImpl$Exchange.run(ServerImpl.java:849)
	at jdk.httpserver/sun.net.httpserver.ServerImpl$DefaultExecutor.execute(ServerImpl.java:204)
	at jdk.httpserver/sun.net.httpserver.ServerImpl$Dispatcher.handle(ServerImpl.java:567)
	at jdk.httpserver/sun.net.httpserver.ServerImpl$Dispatcher.run(ServerImpl.java:532)
	at java.base/java.lang.Thread.run(Thread.java:1575)
</code></pre></div></div>

<p>To prevent this data from being leaked to the client, use your own
<code class="language-plaintext highlighter-rouge">wrap-exception</code> middleware, something like this:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">wrap-exception</span><span class="w"> </span><span class="p">[</span><span class="n">handler</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="k">fn</span><span class="w"> </span><span class="p">[</span><span class="n">request</span><span class="p">]</span><span class="w">
    </span><span class="p">(</span><span class="nf">try</span><span class="w">
      </span><span class="p">(</span><span class="nf">handler</span><span class="w"> </span><span class="n">request</span><span class="p">)</span><span class="w">
      </span><span class="p">(</span><span class="nf">catch</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="w">
        </span><span class="p">(</span><span class="nf">log/errorf</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="n">...</span><span class="p">)</span><span class="w">
        </span><span class="p">{</span><span class="no">:status</span><span class="w"> </span><span class="mi">500</span><span class="w">
         </span><span class="no">:headers</span><span class="w"> </span><span class="p">{</span><span class="n">...</span><span class="p">}</span><span class="w">
         </span><span class="no">:body</span><span class="w"> </span><span class="s">"No cigar! Roll again!"</span><span class="p">}))))</span><span class="w">
</span></code></pre></div></div>

<h2 id="benchmarks">Benchmarks</h2>

<p>As mentioned above, the JDK server although though is for dev purposes only, is
not so bad! The chart below proves it’s almost as fast as Jetty. There are five
attempts of <code class="language-plaintext highlighter-rouge">ab -l -n 1000 -c 50 ...</code> made against both Jetty and JDK servers
(1000 requests in total, 50 parallel). The levels of RPS are pretty equal: about
12-13K requests per second.</p>

<p>Measured on Macbook M3 Pro 32Gb, default settings, the same REPL.</p>

<p><img src="/assets/static/aws/ring-jdk-adapter/chart_1.svg" width="100%" height="auto" /></p>


                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/python-warn/">Python Software Foundation</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2024-11-12T00:00:00+00:00">
        Nov 12, 2024
    </time>

    <a href="/tag/programming/" rel="tag">programming</a>

</div>


            <div class="entry">
                
                    <p>По мотивам событий с Линуксом обратим внимание на Питон. Итак, имеем Python
Software Foundation, некоммерческая организация, у которой на уме только добро и
радуга.</p>

<p>Смотрим: <a href="https://en.wikipedia.org/wiki/Python_Software_Foundation">штаб-квартира в США</a>, адрес Wilmington, Delaware, United States.</p>

<p><a href="https://www.python.org/psf/records/staff/">Все руководители</a> из США: на странице персонала выделяем любое имя,
копируем в Гугл и добавляем “linkedin”. Страну видно даже без перехода в
профиль.</p>

<p><a href="https://www.python.org/psf/sponsors/">Ключевые спонсоры</a>: NVidia, Bloomberg, Microsoft, AWS, Red Hat и
другие.</p>

<p>Любой суд признает Питон цифровым продуктом США со всем последствиями. Не то
чтобы я об этом волнуюсь, но нужно иметь в виду: в любой момент разговоры про
опенсорс закончатся, и подключатся юристы.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/maillists/">Почтовые рассылки</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2024-11-12T00:00:00+00:00">
        Nov 12, 2024
    </time>

    <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/email/" rel="tag">email</a>, <a href="/tag/linux/" rel="tag">linux</a>

</div>


            <div class="entry">
                
                    <p>Когда читаю рассылки Линукса или Постгреса, убеждаюсь: можно быть крутым
разработчиком, но не уметь пользоваться почтой. Напомню главный критерий:
никогда не цитировать все письмо. Нужно цитировать только то, на что конкретно
отвечаешь или то, что было давно и теперь долго искать.</p>

<p>Цитирование всего письма — это засорение переписки и визуальный шум. Бывает,
человек отвечает двумя предложениями, а за ними борода цитат на два
экрана. Обязательно найдется чудак с консольным клиентом, который сломает
цитирование левым тегом, и оно не будет распознаваться другими клиентами.</p>

<p>Наверное, на десять человек приходится один, у которого почта настроена
нормально. Когда я смотрю на это, думаю: ты хоть видел со стороны, как выглядит
переписка? В чем сложность зайти в опции и снять флажок, чтобы при ответе письмо
было пустым? Сегодня даже самый кривой почтовый клиент выстраивает цепочки
писем.</p>

<p>Перечитать: <a href="/mail-rules/">как пользоваться почтой</a>.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/lenin-picture/">Картина с Лениным</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2024-11-12T00:00:00+00:00">
        Nov 12, 2024
    </time>

    <a href="/tag/lenin/" rel="tag">lenin</a>, <a href="/tag/art/" rel="tag">art</a>, <a href="/tag/composition/" rel="tag">composition</a>

</div>


            <div class="entry">
                
                    <p><img src="/assets/static/aws/lenin-picture/1.jpeg" /></p>

<p>В одном из чатов скинули мем. Давайте проигнорируем текстовую часть и рассмотрим
картину. Она хороша свой композицией, и сейчас я объясню почему.</p>

<p>Композиция в живописи — это такое расположение объектов, при котором они
согласованы и уравновешены. Согласованность означает правильное расположение в
пространстве, непротиворечивость углов, света, геометрии. Уравновешенность
означает, что на каждый ключевой объект приходится парный, противоположный ему в
цвете, размере, динамике.</p>

<p>Звучит непонятно, но вот несколько примеров. Центральный объект никогда не
находится в центре картины, потому что иначе рушится композиция. Центр — это
смерть композиции, ее тупик. Какой-то объект может быть в центре, но другие,
более важные объекты, должны оттягивать на себя внимание зрителя. Большой темный
объект можно уравновесить небольшим светлым с другой стороны. Статику
уравновешивают движением. Например, когда герой заносит меч над чудовищем, его
массу и статику уравновешивает тонкость и скорость меча.</p>

<p>Теперь посмотрим на картину. Очевидно, Ленин — главный персонаж, но он находится
не в центре, а левее. Напротив него юноша, с которым он ведет диалог. Юноша
“подсвечен”, чтобы было понятно, к кому обращается Ленин. Их лица — ключевые
объекты картины, а между ними — указательный палец Ленина. Именно палец
находится в центре картины, как бы говоря: истина здесь. Таким образом палец и
лица по обе стороны образуют центр композиции.</p>

<p>Другие детали: в левой части находится сцена с обилием красного: знамя и
скатерть. Этот красный уравновешен косынкой девушки справа. Ничто не мешало
сделать косынку такой же блеклой, как одежда других людей. Но она именно
красная, чтобы выступить противовесом.</p>

<p>Геометрия: обратите внимание на положение Ленина и зрителей. Ленин отделен от
них небольшим коридорчиком, и в результате персонаж уравновешивает толпу. Если
поделить картину ровно пополам, то получится один человек против многих. Это
снова динамика, контраст величин. В целом толпа образует полукруг, все взгляды
устремлены в центр — и композиция получается замкнутой.</p>

<p>Наверное, кто-то лучше разбирается в живописи и видит больше деталей. Но мне
хватает и этих. Не важно, какое у вас отношение к Ленину — полюбоваться картиной
стоит.</p>

<p>Полная версия картины:</p>

<p><img src="/assets/static/aws/lenin-picture/2.jpeg" /></p>

<p>“В.И. Ленин среди делегатов III съезда РКСМ”. Белоусов П.П., холст, масло.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/darvin/">Теория Дарвина</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2024-11-12T00:00:00+00:00">
        Nov 12, 2024
    </time>

    <a href="/tag/life/" rel="tag">life</a>, <a href="/tag/darvin/" rel="tag">darvin</a>

</div>


            <div class="entry">
                
                    <p>Теория Дарвина о происхождении видов считается главенствующей, занимает
центральное место в учебниках. Но она так и не нашла поддержки в обществе. Как
двести лет назад ее не принимали, так не принимают и сейчас.</p>

<p>Проверить это легко: спросите десять знакомых о том, что они думают о
происхождении человека. Вам ответят про инопланетян, бога, высший разум, а также
что все очень сложно. Может быть, один что-то скажет про Дарвина, но очень
неуверенно.</p>

<p>Забавляет, что когда спрашивают про теорию Дарвина, употребляют слово
“веришь”. Ты веришь в теорию Дарвина? Для меня это звучит как “веришь в синус”
или “веришь в производную.” Все это модели, работа которых доказана — как в них
можно верить или не верить? Ну, не веришь ты в производную — это ей все равно,
ровно как и теории Дарвина.</p>

<p>Поэтому теория Дарвина как бы с нами, но как бы и нет. Каждый изучает ее в
школе, чтобы позже переключиться на инопланетян.</p>

<p>Интересно, думал ли Дарвин о том, сколько времени уйдет на адаптацию общества к
его теории? Сколько бы столетий он не прикинул — боюсь, он ошибался. Нужно еще.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/color-correction/">Цветокоррекция</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2024-11-12T00:00:00+00:00">
        Nov 12, 2024
    </time>

    <a href="/tag/color/" rel="tag">color</a>, <a href="/tag/correction/" rel="tag">correction</a>, <a href="/tag/movies/" rel="tag">movies</a>

</div>


            <div class="entry">
                
                    <p>В последнее время раздражает цветокоррекция видео. Это когда накидывают слой,
под которым все становится однотонным или близко к этому. Например, серых и
металлических оттенков, бурых, цвета мокрого афальта.</p>

<p>Поставьте любой фильм на паузу и убедитесь, что картинка выглядит как сквозь
бутылочное стекло.</p>

<p>На Хабре была интересная статья: кто-то прогнал все фильмы о Гарри Поттере через
программу, которая строит гистограмму цветов. Не нашел ссылку, но помню красивые
гистограммы и вывод: в каждом следующем фильме коррекции становилась больше. В
последнем Поттере из цветов остались только зеленый и синий могильных тонов.</p>

<p>Я в курсе, зачем нужна коррекция, и я за то, когда ее применяют по
делу. Например, в классической “Матрице”, когда действие происходит в программе,
все зеленое. Когда герои перемещаются в реальный мир — цветное. Коррекцией
выделяют особые моменты, например сны, кошмары или катастрофы. Коррекция нужна
для компоузинга, чтобы актеры, фон и эффекты были согласованы.</p>

<p>Но сегодня такое чувство, что коррекцию ставят не задумываясь. Просто жахнули
корректирующий слой в редакторе, потому что так делают другие. В результате
цвета сузились до пещерных оттенков — серого, коричневого, бурого — и это
считается круто.</p>

<p>Корректируют цвета в интервью, подкастах, обзорах техники — зачем? То же самое с
фотографиями, например свадебными. Их нужно прогнать через сто фильтров с
коррекцией. Сюда же эротика: снял ты красивое тело, молодец, но нет — нужно,
чтобы оно сливалось с интерьером, как хамелеон.</p>

<p>Дизайнеры и монтажеры не понимают: когда одно и то же используется везде, оно
приедается и выглядит глупо.</p>

<p>Замечаю такую же историю в играх. Запускаешь игрушку, пропускаешь логотипы и
вжух — экран моргает, и накладывается глобальная коррекция цветов. Синий
становится мокрым асфальтом, красный — бордовым, появляются серо-бурые
оттенки. Если свернуть игру, можно наблюдать эффект в операционке. Опять же,
зачем насильно глушить цвета? Кто просил?</p>

<p>Коррекция нужна, но слишком часто я замечаю обратное.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/android-mem-3/">Память у Андроида (3)</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2024-11-12T00:00:00+00:00">
        Nov 12, 2024
    </time>

    <a href="/tag/android/" rel="tag">android</a>, <a href="/tag/memory/" rel="tag">memory</a>, <a href="/tag/storage/" rel="tag">storage</a>

</div>


            <div class="entry">
                
                    <p>И еще про Андроид. Я не хотел, но сама жизнь вынуждает.</p>

<p>Этим утром обратилась женщина, друг семьи. Классика: телефон — Андроид, 32 гига,
забит под ноль фотками и видео всяких утренников. Вацап раздулся до 8
гигов. Женщина жила в таком режиме годами, телефон как-то шевелился. Но вот
приплыли: Вацап устарел, просит обновить. Женщина не понимает, что от нее хотят.</p>

<p>Нажимаю “скачать”, Вацап перекидывает в Google Play. А там плашка: в целях
безопасности подтвердите аккаунт, запрашивает пароль к гугло-почте. Разумеется,
женщина не знает не то что пароль, а что такое гугло-аккаунт в принципе. Судя по
всему, этот аккаунт ей создали в отделении связи, где она покупала телефон.</p>

<p>Сразу вопрос: какие именно “цели безопасности” преследует Гугл? В чем проблема
обновить приложение? Это же всем на пользу: Гуглу, производителю, пользователю.</p>

<p>Пытаюсь подобрать пароль по фамилии и году рождения — Гугл не знает этой
почты. Возможно, удалил из-за неактивности. Пытаюсь создать новый акк — не
принимает российский номер.</p>

<p>Ладно, качаю APK с сайта Вацапа. Разрешаю установку из сторонних
источников. Тыкаю на APK — он немного тупит, потом говорит, что не смог. Никаких
деталей, ошибок, все молчком. Я думал минут десять, ребутнул телефон и
догадался: бедняге не хватает места. А сказать об этом нельзя? Удалил левые
приложения, какой-то утренник — и APK поставился.</p>

<p>Женщина видит Вацап и чуть не плачет от радости. У нее там родительский чат,
секции внуков, подруги детства, соседи, ТСЖ, работа, клиенты. Предлагает деньги,
еле отговорил. Представьте, что потеряли доступ к почте, на которой сидели 10
лет — вот так себя чувствовала она.</p>

<p>Я смотрю на это и не понимаю: почему нельзя сделать так, чтобы человек просто
пользовался телефоном? Почему его нужно носить Ване-программисту, чтобы он
работал? Почему нельзя продумать сценарии, чтобы избежать таких ситуаций? Опять
пользователи не те попались?</p>

<p>Я не настаиваю насчет компьютеров: они явно не для людей. Это техника для
обученного персонала. Но телефон, блин, это же повседневная вещь. Нам же
показывали в презентациях: тыкаешь пальчиком, и оно все само. А на практике
совсем не так. Неужели нам врали?</p>

<p>Какой-то сплошной гиговский бред, и ничего больше.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/en/pg-version-1.18/">PG2 release 0.1.18</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2024-11-01T00:00:00+00:00">
        Nov 1, 2024
    </time>

    <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/sql/" rel="tag">sql</a>, <a href="/tag/clojure/" rel="tag">clojure</a>, <a href="/tag/postgres/" rel="tag">postgres</a>

</div>


            <div class="entry">
                
                    
<p><a href="https://github.com/igrishaev/pg2">PG2 version 0.1.18</a> is available (it’s a client for Postgres). This
release brings two major features:</p>

<ul>
  <li>built-in pgvector extension support;</li>
  <li>better type mapping between Postgres and Clojure.</li>
</ul>

<h2 id="pgvector-support">PGVector Support</h2>

<p>Pgvector is a <a href="https://github.com/pgvector/pgvector">well known extension</a> for PostgreSQL. It provides a
fast and robust vector type which is quite useful for heavy
computations. Pgvector also provides a sparse version of a vector to save space.</p>

<p>This section covers how to use types provided by the extension with PG2.</p>

<h3 id="vector">Vector</h3>

<p>First, install <code class="language-plaintext highlighter-rouge">pgvector</code> as the official readme file prescribes. Now that you
have it installed, try a simple table with the <code class="language-plaintext highlighter-rouge">vector</code> column:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">conn</span><span class="w">
  </span><span class="p">(</span><span class="nf">jdbc/get-connection</span><span class="w"> </span><span class="p">{</span><span class="n">...</span><span class="p">}))</span><span class="w">

</span><span class="p">(</span><span class="nf">pg/query</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="s">"create temp table test (id int, items vector)"</span><span class="p">)</span><span class="w">

</span><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="s">"insert into test values (1, '[1,2,3]')"</span><span class="p">)</span><span class="w">
</span><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="s">"insert into test values (2, '[1,2,3,4,5]')"</span><span class="p">)</span><span class="w">

</span><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="s">"select * from test order by id"</span><span class="p">)</span><span class="w">

</span><span class="c1">;; [{:id 1, :items "[1,2,3]"} {:id 2, :items "[1,2,3,4,5]"}]</span><span class="w">
</span></code></pre></div></div>

<p>It works, but we got the result unparsed: the <code class="language-plaintext highlighter-rouge">:items</code> field in each row is a
string. This is because, to take a custom type into account when encoding and
decoding data, you need to specify something. Namely, pass the <code class="language-plaintext highlighter-rouge">:with-pgvector?</code>
flag to the config map as follows:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">config</span><span class="w">
  </span><span class="p">{</span><span class="no">:host</span><span class="w"> </span><span class="s">"127.0.0.1"</span><span class="w">
   </span><span class="no">:port</span><span class="w"> </span><span class="mi">5432</span><span class="w">
   </span><span class="no">:user</span><span class="w"> </span><span class="s">"test"</span><span class="w">
   </span><span class="no">:password</span><span class="w"> </span><span class="s">"test"</span><span class="w">
   </span><span class="no">:database</span><span class="w"> </span><span class="s">"test"</span><span class="w">
   </span><span class="no">:with-pgvector?</span><span class="w"> </span><span class="n">true</span><span class="p">})</span><span class="w">

</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">conn</span><span class="w">
  </span><span class="p">(</span><span class="nf">jdbc/get-connection</span><span class="w"> </span><span class="n">config</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<p>Now the strings are parsed into a Clojure vector of <code class="language-plaintext highlighter-rouge">double</code> values:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="s">"select * from test order by id"</span><span class="p">)</span><span class="w">

</span><span class="p">[{</span><span class="no">:id</span><span class="w"> </span><span class="mi">1</span><span class="n">,</span><span class="w"> </span><span class="no">:items</span><span class="w"> </span><span class="p">[</span><span class="mf">1.0</span><span class="w"> </span><span class="mf">2.0</span><span class="w"> </span><span class="mf">3.0</span><span class="p">]}</span><span class="w">
 </span><span class="p">{</span><span class="no">:id</span><span class="w"> </span><span class="mi">2</span><span class="n">,</span><span class="w"> </span><span class="no">:items</span><span class="w"> </span><span class="p">[</span><span class="mf">1.0</span><span class="w"> </span><span class="mf">2.0</span><span class="w"> </span><span class="mf">3.0</span><span class="w"> </span><span class="mf">4.0</span><span class="w"> </span><span class="mf">5.0</span><span class="p">]}]</span><span class="w">
</span></code></pre></div></div>

<p>To insert a vector, pass it as a Clojure vector as well:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="s">"insert into test values ($1, $2)"</span><span class="w">
            </span><span class="p">{</span><span class="no">:params</span><span class="w"> </span><span class="p">[</span><span class="mi">3</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="mi">5</span><span class="p">]]})</span><span class="w">
</span></code></pre></div></div>

<p>It can be also a lazy collection of numbers produced by a <code class="language-plaintext highlighter-rouge">map</code> call:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="s">"insert into test values ($1, $2)"</span><span class="w">
            </span><span class="p">{</span><span class="no">:params</span><span class="w"> </span><span class="p">[</span><span class="mi">4</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="nb">inc</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="mi">5</span><span class="p">])]})</span><span class="w">
</span></code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">vector</code> column above doesn’t have an explicit size. Thus, vectors of any
size can be stored in that column. You can limit the size by providing it in
parentheses:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pg/query</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="s">"create temp table test2 (id int, items vector(5))"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>Now if you pass a vector of a different size, you’ll get an error response from
the database:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="s">"insert into test2 values (1, '[1,2,3]')"</span><span class="p">)</span><span class="w">

</span><span class="c1">;; Server error response: {severity=ERROR, code=22000, file=vector.c, line=77,</span><span class="w">
</span><span class="c1">;; function=CheckExpectedDim, message=expected 5 dimensions, not 3,</span><span class="w">
</span><span class="c1">;; verbosity=ERROR}</span><span class="w">
</span></code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">vector</code> type supports both text and binary modes of PostgreSQL wire
protocol.</p>

<h3 id="sparse-vector">Sparse Vector</h3>

<p>The <code class="language-plaintext highlighter-rouge">pgvector</code> extension provides a special <code class="language-plaintext highlighter-rouge">sparsevec</code> type to store vectors
where only certain elements are filled. All the rest elements are considered as
zero. For example, you have a vector of 1000 items where the 3rd item is 42.001,
and 10th item is 99.123. Storing it as a native vector of 1000 double numbers is
inefficient. It can be written as follows which takes much less:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{3:42.001,10:99.123}/1000
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">sparsevec</code> Postgres type acts exactly like this: internally, it’s a sort of
a map that stores the size (1000) and the <code class="language-plaintext highlighter-rouge">{index -&gt; value}</code> mapping. An
important note is that <strong>indexes are counted from one, not zero</strong> (see the
README.md file of the extension for details).</p>

<p>PG2 provides a special wrapper for a sparse vector. A brief demo:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="s">"create temp table test3 (id int, v sparsevec)"</span><span class="p">)</span><span class="w">

</span><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="s">"insert into test3 values (1, '{2:42.00001,7:99.00009}/9')"</span><span class="p">)</span><span class="w">

</span><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="s">"select * from test3"</span><span class="p">)</span><span class="w">

</span><span class="c1">;; [{:v &lt;SparseVector {2:42.00001,7:99.00009}/9&gt;, :id 1}]</span><span class="w">
</span></code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">v</code> field above is an instance of the <code class="language-plaintext highlighter-rouge">org.pg.type.SparseVector</code>
class. Let’s look at it closer:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">;; put it into a separate variable</span><span class="w">
</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">-sv</span><span class="w">
  </span><span class="p">(</span><span class="nb">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="s">"select * from test3"</span><span class="p">)</span><span class="w">
      </span><span class="nb">first</span><span class="w">
      </span><span class="no">:v</span><span class="p">))</span><span class="w">

</span><span class="p">(</span><span class="nf">type</span><span class="w"> </span><span class="n">-sv</span><span class="p">)</span><span class="w">

</span><span class="n">org.pg.type.SparseVector</span><span class="w">
</span></code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">-sv</code> value has a number of interesting traits. To turn in into a native
Clojure map, just <code class="language-plaintext highlighter-rouge">deref</code> it:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">-sv</span><span class="w">

</span><span class="p">{</span><span class="no">:nnz</span><span class="w"> </span><span class="mi">2</span><span class="n">,</span><span class="w"> </span><span class="no">:index</span><span class="w"> </span><span class="p">{</span><span class="mi">1</span><span class="w"> </span><span class="mf">42.00001</span><span class="n">,</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mf">99.00009</span><span class="p">}</span><span class="n">,</span><span class="w"> </span><span class="no">:dim</span><span class="w"> </span><span class="mi">9</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>It mimics the <code class="language-plaintext highlighter-rouge">nth</code> access as the standard Clojure vector does:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nb">nth</span><span class="w"> </span><span class="n">-sv</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="c1">;; 0.0</span><span class="w">
</span><span class="p">(</span><span class="nb">nth</span><span class="w"> </span><span class="n">-sv</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="c1">;; 42.00001</span><span class="w">
</span><span class="p">(</span><span class="nb">nth</span><span class="w"> </span><span class="n">-sv</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="c1">;; 0.0</span><span class="w">
</span></code></pre></div></div>

<p>To turn in into a native vector, just pass it into the <code class="language-plaintext highlighter-rouge">vec</code> function:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">vec</span><span class="w"> </span><span class="n">-sv</span><span class="p">)</span><span class="w">

</span><span class="p">[</span><span class="mf">0.0</span><span class="w"> </span><span class="mf">42.00001</span><span class="w"> </span><span class="mf">0.0</span><span class="w"> </span><span class="mf">0.0</span><span class="w"> </span><span class="mf">0.0</span><span class="w"> </span><span class="mf">0.0</span><span class="w"> </span><span class="mf">99.00009</span><span class="w"> </span><span class="mf">0.0</span><span class="w"> </span><span class="mf">0.0</span><span class="p">]</span><span class="w">
</span></code></pre></div></div>

<p>There are several ways you can insert a sparse vector into the database. First,
pass an ordinary vector:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="s">"insert into test3 values ($1, $2)"</span><span class="w">
            </span><span class="p">{</span><span class="no">:params</span><span class="w"> </span><span class="p">[</span><span class="mi">2</span><span class="w"> </span><span class="p">[</span><span class="mi">5</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="p">]]})</span><span class="w">
</span></code></pre></div></div>

<p>Internally, zero values get eliminated, and the vector is transformed into a
<code class="language-plaintext highlighter-rouge">SparseVector</code> instance. Now read it back:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="s">"select * from test3 where id = 2"</span><span class="p">)</span><span class="w">

</span><span class="p">[{</span><span class="no">:v</span><span class="w"> </span><span class="n">&lt;SparseVector</span><span class="w"> </span><span class="p">{</span><span class="mi">1</span><span class="no">:5.0,2:2.0,3:6.0,5:2.0,6:5.0</span><span class="p">}</span><span class="n">/8&gt;,</span><span class="w"> </span><span class="no">:id</span><span class="w"> </span><span class="mi">2</span><span class="p">}]</span><span class="w">
</span></code></pre></div></div>

<p>The second way is to pass a <code class="language-plaintext highlighter-rouge">SparseVector</code> instance produced by the
<code class="language-plaintext highlighter-rouge">pg.type/-&gt;sparse-vector</code> function. It accepts the size of the vector and a
mapping of <code class="language-plaintext highlighter-rouge">{index =&gt; value}</code>:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">require</span><span class="w"> </span><span class="o">'</span><span class="p">[</span><span class="n">pg.type</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">t</span><span class="p">])</span><span class="w">

</span><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="s">"insert into test3 values ($1, $2)"</span><span class="w">
            </span><span class="p">{</span><span class="no">:params</span><span class="w"> </span><span class="p">[</span><span class="mi">3</span><span class="w"> </span><span class="p">(</span><span class="nf">t/-&gt;sparse-vector</span><span class="w"> </span><span class="mi">9</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="w"> </span><span class="mf">523.23423</span><span class="w">
                                              </span><span class="mi">7</span><span class="w"> </span><span class="mf">623.52346</span><span class="p">})]})</span><span class="w">
</span></code></pre></div></div>

<p>Finally, you can pass a string representation of a sparse vector:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">pg/execute</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="s">"insert into test3 values ($1, $2)"</span><span class="w">
            </span><span class="p">{</span><span class="no">:params</span><span class="w"> </span><span class="p">[</span><span class="mi">3</span><span class="w"> </span><span class="s">"{1:5.0,2:2.0,3:6.0,5:2.0,6:5.0}/8"</span><span class="p">]})</span><span class="w">
</span></code></pre></div></div>

<p>Like the <code class="language-plaintext highlighter-rouge">vector</code> type, <code class="language-plaintext highlighter-rouge">sparsevec</code> can be also limited to a certain size:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">create</span> <span class="k">table</span> <span class="p">...</span> <span class="p">(</span><span class="n">id</span> <span class="nb">int</span><span class="p">,</span> <span class="n">items</span> <span class="n">sparsevec</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">sparsevec</code> type supports both binary and text Postgres wire protocol.</p>

<h3 id="custom-schemas">Custom Schemas</h3>

<p>The text above assumes you have the <code class="language-plaintext highlighter-rouge">pgvector</code> extension installed globally
meaning it is hosted in the <code class="language-plaintext highlighter-rouge">public</code> schema. Sometimes though, extensions are
setup per schema. For example only a schema named <code class="language-plaintext highlighter-rouge">sales</code> has access to the
<code class="language-plaintext highlighter-rouge">pgvector</code> extension but nobody else.</p>

<p>If it’s your case and you installed <code class="language-plaintext highlighter-rouge">pgvector</code> into a certain schema, the
standard <code class="language-plaintext highlighter-rouge">:with-pgvector?</code> flag won’t work. By default, PG2 scans the <code class="language-plaintext highlighter-rouge">pg_types</code>
table for the <code class="language-plaintext highlighter-rouge">public.vector</code> and <code class="language-plaintext highlighter-rouge">public.sparsevec</code> types. Since the schema
name is not <code class="language-plaintext highlighter-rouge">public</code> but <code class="language-plaintext highlighter-rouge">sales</code>, you need to specify it by passing a special
option called <code class="language-plaintext highlighter-rouge">:type-map</code>. It’s a map where keys are fully qualified type names
(either a keyword or a string), and values are predefined instances of the
<code class="language-plaintext highlighter-rouge">IProcessor</code> interface:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">config</span><span class="w">
  </span><span class="p">{</span><span class="no">:host</span><span class="w"> </span><span class="s">"127.0.0.1"</span><span class="w">
   </span><span class="no">:port</span><span class="w"> </span><span class="mi">5432</span><span class="w">
   </span><span class="no">:user</span><span class="w"> </span><span class="s">"test"</span><span class="w">
   </span><span class="no">:password</span><span class="w"> </span><span class="s">"test"</span><span class="w">
   </span><span class="no">:database</span><span class="w"> </span><span class="s">"test"</span><span class="w">
   </span><span class="no">:type-map</span><span class="w"> </span><span class="p">{</span><span class="s">"sales.vector"</span><span class="w"> </span><span class="n">t/vector</span><span class="w">
              </span><span class="s">"sales.sparsevec"</span><span class="w"> </span><span class="n">t/sparsevec</span><span class="p">}})</span><span class="w">
</span></code></pre></div></div>

<p>You can rely on keywords as well:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">config</span><span class="w">
  </span><span class="p">{</span><span class="no">:host</span><span class="w"> </span><span class="s">"127.0.0.1"</span><span class="w">
   </span><span class="no">:port</span><span class="w"> </span><span class="mi">5432</span><span class="w">
   </span><span class="no">:user</span><span class="w"> </span><span class="s">"test"</span><span class="w">
   </span><span class="no">:password</span><span class="w"> </span><span class="s">"test"</span><span class="w">
   </span><span class="no">:database</span><span class="w"> </span><span class="s">"test"</span><span class="w">
   </span><span class="no">:type-map</span><span class="w"> </span><span class="p">{</span><span class="no">:sales/vector</span><span class="w"> </span><span class="n">t/vector</span><span class="w">
              </span><span class="no">:sales/sparsevec</span><span class="w"> </span><span class="n">t/sparsevec</span><span class="p">}})</span><span class="w">
</span></code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">t</code> alias references the <code class="language-plaintext highlighter-rouge">pg.type</code> namespace.</p>

<p>Now if you install the extension into the <code class="language-plaintext highlighter-rouge">statistics</code> schema as well, add it
into the map:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">config</span><span class="w">
  </span><span class="p">{</span><span class="no">:host</span><span class="w"> </span><span class="s">"127.0.0.1"</span><span class="w">
   </span><span class="no">:port</span><span class="w"> </span><span class="mi">5432</span><span class="w">
   </span><span class="no">:user</span><span class="w"> </span><span class="s">"test"</span><span class="w">
   </span><span class="no">:password</span><span class="w"> </span><span class="s">"test"</span><span class="w">
   </span><span class="no">:database</span><span class="w"> </span><span class="s">"test"</span><span class="w">
   </span><span class="no">:type-map</span><span class="w"> </span><span class="p">{</span><span class="no">:sales/vector</span><span class="w"> </span><span class="n">t/vector</span><span class="w">
              </span><span class="no">:sales/sparsevec</span><span class="w"> </span><span class="n">t/sparsevec</span><span class="w">
              </span><span class="no">:statistics/vector</span><span class="w"> </span><span class="n">t/vector</span><span class="w">
              </span><span class="no">:statistics/sparsevec</span><span class="w"> </span><span class="n">t/sparsevec</span><span class="p">}})</span><span class="w">
</span></code></pre></div></div>

<p>Should you make a mistake in a fully qualified type name, it will be ignored,
and you’ll get value from the database unparsed. The actual value depends on the
binary encoding and decoding options of a connection. By default, it uses text
protocol so you’ll get a string like “[1, 2, 3]”. For binary encoding and
decoding, you’ll get a byte array that holds raw Postgres payload.</p>

<h2 id="custom-type-processors">Custom Type Processors</h2>

<p>PG2 version 0.1.18 has the entire type system refactored. It introduces a
conception of type processors which allows to connect Postgres types with
Java/Clojure ones with ease.</p>

<p>When reading data from Postgres, the client knows only the OID of a type of a
column. This OID is just an integer number points to a certain type. The default
builtin types are hard-coded in Postgres, and thus their OIDs are known in
advance.</p>

<p>Say, it’s for sure that the <code class="language-plaintext highlighter-rouge">int4</code> type has OID 23, and <code class="language-plaintext highlighter-rouge">text</code> has
OID 25. That’s true for any Postgres installation. Any Postgres client has a
kind of a hash map or a Enum class with these OIDs.</p>

<p>Things get worse when you define custom types. These might be either enums or
complex types defined by extensions: <code class="language-plaintext highlighter-rouge">pgvector</code>, <code class="language-plaintext highlighter-rouge">postgis</code> and so on. You cannot
guess OIDs of types any longer because they are generated in runtime. Their
actual values depend on a specific machine. On prod, the <code class="language-plaintext highlighter-rouge">public.vector</code> type
has OID 10541, on pre-prod it’s 9621, and in Docker you’ll get 1523.</p>

<p>Moreover, a type name is unique only across a schema that’s holding it. You can
easily have two different enum types called <code class="language-plaintext highlighter-rouge">status</code> defined in various
schemas. Thus, relying on a type name is not a good option unless it’s fully
qualified.</p>

<p>To deal with all said above, a new conception of type mapping was introduced.</p>

<p>First, if a certain OID is builtin (meaning it exists the list of predefined
OIDs), it gets processed as before.</p>

<p>When you connect to a database, you can pass a mapping like <code class="language-plaintext highlighter-rouge">{schema.typename =&gt;
Processor}</code>. When pg2 has established a connection, it executes an internal
query to discover type mapping. Namely, it reads the <code class="language-plaintext highlighter-rouge">pg_type</code> table to get OIDs
that have provided schemas and type name. The query looks like this:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span>
    <span class="n">pg_type</span><span class="p">.</span><span class="n">oid</span><span class="p">,</span> <span class="n">pg_namespace</span><span class="p">.</span><span class="n">nspname</span> <span class="o">||</span> <span class="s1">'.'</span> <span class="o">||</span> <span class="n">pg_type</span><span class="p">.</span><span class="n">typname</span> <span class="k">as</span> <span class="k">type</span>
<span class="k">from</span>
    <span class="n">pg_type</span><span class="p">,</span> <span class="n">pg_namespace</span>
<span class="k">where</span>
    <span class="n">pg_type</span><span class="p">.</span><span class="n">typnamespace</span> <span class="o">=</span> <span class="n">pg_namespace</span><span class="p">.</span><span class="n">oid</span>
    <span class="k">and</span> <span class="n">pg_namespace</span><span class="p">.</span><span class="n">nspname</span> <span class="o">||</span> <span class="s1">'.'</span> <span class="o">||</span> <span class="n">pg_type</span><span class="p">.</span><span class="n">typname</span> <span class="k">in</span> <span class="p">(</span>
        <span class="s1">'schema1.type1'</span><span class="p">,</span>
        <span class="s1">'schema2.type2'</span><span class="p">,</span>
        <span class="p">...</span>
    <span class="p">);</span>
</code></pre></div></div>

<p>It returns pairs of OID and the full type name:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>121512 | schema1.type1
 21234 | schema2.type2
</code></pre></div></div>

<p>Now PG2 knows that the OID 121512 specifies <code class="language-plaintext highlighter-rouge">schema1.type1</code> but nothing else.</p>

<p>Finally, from the map <code class="language-plaintext highlighter-rouge">{schema.typename =&gt; Processor}</code> you submitted before, PG2
builds a map <code class="language-plaintext highlighter-rouge">{OID =&gt; Processor}</code>. If the OID is not a default one, it checks
this map trying to find a processor object.</p>

<p>A processor object is an instance of the <code class="language-plaintext highlighter-rouge">org.pg.processor.IProcessor</code>
interface, or, if more precisely, an abstract <code class="language-plaintext highlighter-rouge">AProcessor</code> which is partially
implemented. It has four methods:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">ByteBuffer</span> <span class="nf">encodeBin</span><span class="o">(</span><span class="nc">Object</span> <span class="n">value</span><span class="o">,</span>  <span class="nc">CodecParams</span> <span class="n">codecParams</span><span class="o">);</span>
    <span class="nc">String</span> <span class="nf">encodeTxt</span><span class="o">(</span><span class="nc">Object</span> <span class="n">value</span><span class="o">,</span>  <span class="nc">CodecParams</span> <span class="n">codecParams</span><span class="o">);</span>
    <span class="nc">Object</span> <span class="nf">decodeBin</span><span class="o">(</span><span class="nc">ByteBuffer</span> <span class="n">bb</span><span class="o">,</span> <span class="nc">CodecParams</span> <span class="n">codecParams</span><span class="o">);</span>
    <span class="nc">Object</span> <span class="nf">decodeTxt</span><span class="o">(</span><span class="nc">String</span> <span class="n">text</span><span class="o">,</span>   <span class="nc">CodecParams</span> <span class="n">codecParams</span><span class="o">);</span>
</code></pre></div></div>

<p>Depending on whether you’re decoding (reading) the data or encoding them
(e.g. passing parameters), and the current format (text or binary), a
corresponding method is called. By extending all four methods, you can handle
any type you want.</p>

<p>At the moment, there are about 25 processors implementing standard types:
<code class="language-plaintext highlighter-rouge">int2</code>, <code class="language-plaintext highlighter-rouge">int4</code>, <code class="language-plaintext highlighter-rouge">text</code>, <code class="language-plaintext highlighter-rouge">float4</code>, and so on. Find them in the
<code class="language-plaintext highlighter-rouge">pg-core/src/java/org/pg/processor</code> directory. There is also a couple of
processors for the <code class="language-plaintext highlighter-rouge">pgvector</code> extension in the <code class="language-plaintext highlighter-rouge">pgvector</code> subdirectory.</p>

<p>The next step is to implement processors for the <code class="language-plaintext highlighter-rouge">postgis</code> extension.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/android-mem-2/">Память у Андроида (2)</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2024-11-01T00:00:00+00:00">
        Nov 1, 2024
    </time>

    <a href="/tag/android/" rel="tag">android</a>, <a href="/tag/memory/" rel="tag">memory</a>, <a href="/tag/storage/" rel="tag">storage</a>

</div>


            <div class="entry">
                
                    <p>Продолжение <a href="/android-mem-1/">прошлой заметки</a> про Андроид.</p>

<p>На мой взгляд, 90 процентов всех телефонов страдают от нехватки места. Сценарий
один и тот же: человек покупает телефон и фотографирует каждый угол. Еще
он ставит три мессенджера, и в каждом ему присылают прикольные видосы и
гифки. Проходит полгода, и места не остается.</p>

<p>Человек запускает менеджер очистки, но это сплошное издевательство. Менеджер
говорит: у тебя занято 20 гигов фотками и видео, удаляй сам. А так я могу
очистить временные файлы на сумму 30 мегабайтов.</p>

<p>Я проходил это десять раз, не меньше. Покупаешь телефон маме, жене, детям,
родственникам — и через полгода они приходят к тебе с вопросом “закончилось
место”. Ты скидываешь фотки на комп, и на год тебя оставляют в покое.</p>

<p>Я понимаю, проблему с местом было трудно предсказать, когда Андроид только
вышел. Но на третий-четвертый год это стало очевидно: места никогда не хватает,
аппетиты пользователей растут, ровно и как возможности приложений.</p>

<p>Принято считать, что за местом должен следить пользователь: регулярно смотреть
статистику, удалять файлы, настраивать кеши в мессенджерах. Да, некоторые это
делают. Но как должны справляться с этим обычные люди? Скажем, чтобы настроить
кеш в Телеграме, нужно нажать многоточие, потом гайку, потом смотаться до Data &amp;
Storage, и там выставить опции. Вы считаете, ваша мама это сделает? А потом то
же самое в Вацапе и Вайбере?</p>

<p>Когда я на это жалуюсь, мне говорят — что ты хотел? Тут ничего не поделаешь. А
на самом деле поделать можно много чего.</p>

<p>Заботу о диске должна брать на себя операционная система. Во-первых, если
свободного места меньше 70%, то старые фотки уменьшаются в
разрешении. Современные телефоны производят джипеги по 3-7 магабайтов — такие
фотографии можно печатать в натуральный рост. Это, мягко говоря, избыточно для
экрана размером с ладонь. Когда места перестает хватать, старые фотки сжимаются
до 700 килобайт, освобождая от 2.5 до 5 магабайтов. Сто фоток — полгига.</p>

<p>Разумеется, этот процесс должен действовать тонко, а именно: брать самые
неиспользуемые фотки; пропускать те, которые отмеченные лайком или которые
пользователь часто открывает. Это не подойдет свадебным фотографом, но и
организация фото у таких людей выстроена не так, как у обывателей.</p>

<p>То же самое с видео: если сейчас ночь, и заряд батареи выше порога, то берется
старое видео и перегоняется в низкое разрешение. Как и в случае с джипегами, на
экране размером в ладонь никто не заметит разницы, а это дает 200-300 мегов с
каждого ролика.</p>

<p>Насчет кешей и разбухающих приложений. Ожидать, что человек откроет каждое
приложение и все настроит — идиотизм. Когда системе не хватает места, она
рассылает приложениям системный вызов а-ля “срочно удали кеши”. Можно добавить
параметр — уровень критичности. Если он зеленый, то можно ничего не удалять,
если желтый — удалить все данные, кроме последнего месяца, если красный — то
все.</p>

<p>Вы скажете, что никто не будет этого делать. А между прочим, это в интересах
самих приложений. Потому что если на телефоне 2% свободного места, то
пользоваться условным Телеграмом невозможно. А если каждое приложение освободит
по 200-400 мегабайтов, то в сумме будет пара гигов, и телефон худо-бедно
заработает.</p>

<p>Наконец, самое важное — старые данные можно удалять без спроса пользователя. Да,
вот так просто взять и удалить. Объяснение этому простое: представьте, что
человек собрался в компании и хочет снять видео. А места нет. И у нас выбор:
либо сказать, что места нет и заставить чистить файлы самому, либо удалить
фотографии пятилетней давности, которые человек ни разу не открывал. Что лучше?</p>

<p>В большинстве случаев — второе, потому что человеку интересно то, что происходит
сейчас. Ему важно записать видео именно пока он в компании, а не удалять файлы,
пока остальные веселятся. Интерес к фото и видео можно представить как правую
половину гауссианы: она резко спадает во времени, и нет беды в том, чтобы
подчищать старье за пользователя.</p>

<p>Если хотите, аналогия. Современные телефоны работают как резервуар: сначала он
наполняется, а если вливать больше, то польется мимо. Это неправильно: телефон
должен быть как проточный бассейн с входом и выходом. Когда в него вливается
сверх меры, то с другой стороны выливается.</p>

<p>По такому принципу телефон может работать годами, не вынося владельцу мозг
нехваткой места.</p>

<p>Допускаю, что есть программы, которые умеют что-то подобное, но это сторонние
программы, их нужно ставить, покупать, разбираться с ними. Нет из коробки — нет
как такового. А еще телефон, который вместо двух лет прослужил бы пять, мягко
говоря, не согласуется с бизнес-моделью всяких Гуглов, Ксяоми и прочих.</p>

<p>Хочу лишь показать — многие вещи можно переосмыслить, и технически они
возможны. Дело в бизнесе и отношении к ним.</p>

                
            </div>

        </li>
        
    </ul>

    <h4>
        
        <a href="/page12" class="previous">&larr;</a>
        
        <span class="page_number ">Страница 13 из 97</span>
        
        <a href="/page14" class="next">&rarr;</a>
        
    </h4>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Ivan Grishaev's blog</li>
          <li><a href="mailto:ivan@grishaev.me">ivan@grishaev.me</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
            <li><a href="https://github.com/igrishaev">GitHub</a></li>
            <li><a href="https://t.me/igrishaev_blog">Telegram</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Writing on programming, education, books and negotiations.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
