<!DOCTYPE html>
<html lang="ru">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Разбираемся в часовыми поясами. Инструкция по безопасной работе со временем</title>
  <meta name="description" content="">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/custom.css">
  <link rel="canonical" href="https://grishaev.me/timezone/">
  <link rel="alternate" type="application/rss+xml" title="Ivan Grishaev's blog" href="https://grishaev.me/feed.xml">

  <link rel="shortcut icon" type="image/x-icon" href="/assets/static/favicons/favicon.ico">

  <script type="text/javascript" src="/assets/typo.js"></script>

</head>


  <body>
    <header class="site-header">

    <div class="wrapper flex-container">

        <div>
            <a href="/">
                <img src="/assets/static/photo-round-small.png" alt="Ivan Grishaev">
            </a>
        </div>

        <div class="flex-container-vert" style="margin-left: 15px; width: 80%">

            <div class="flex-container full-width">
                <p style="margin-bottom: 5px">Ivan Grishaev's blog</p>
                <div class="flex-huge"></div>
                <div >
<form id="search-form"
      target="_blank"
      style="display: inline"
      method="get"
      action="https://www.google.com/search">

    <input name="sitesearch"
           value="grishaev.me"
           type="hidden">

    <input type="text"
           required="required"
           name="q"
           placeholder="Google search..."
           autocomplete="off">

    <button style="border: none; background-color: transparent; cursor: pointer;"
            type="submit">&#x1f50d;</button>

</form>
</div>
            </div>

            <p><small>Writing on programming, education, books and negotiations.
</small></p>

            <div class="flex-container">
                <a class="menu-item" href="/">Home</a>
                <a class="menu-item" href="/about/">About</a>
                <a class="menu-item" href="/bookshelf/">Bookshelf</a>
                <a class="menu-item" href="/feed.xml">RSS</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor" href="/tag/clojure/">Clojure</a>
                <a class="menu-item minor" href="/tag/emacs/">Emacs</a>
                <a class="menu-item minor" href="/tag/python/">Python</a>
                <a class="menu-item minor" href="/tag/programming/">Programming</a>
                <a class="menu-item minor" href="/interview/">Interview</a>
                <a class="menu-item minor" href="/video/">Video</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor hl" href="/clojure-in-prod/">Книга «Clojure на производстве»</a>
            </div>

        </div>
    </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">

    <h1 class="post-title" itemprop="name headline">Разбираемся в часовыми поясами. Инструкция по безопасной работе со временем</h1>

    
<div class="post-meta">

    <time class="post-time"
          datetime="2017-12-13T00:00:00+00:00">
        Dec 13, 2017
    </time>

    <a href="/tag/time/" rel="tag">time</a>, <a href="/tag/backend/" rel="tag">backend</a>, <a href="/tag/frontend/" rel="tag">frontend</a>

</div>


  </header>

  <div class="post-content" itemprop="articleBody">
    
<p>Во всех проектах, где мне приходилось работать (включая текущий), были
проблемы с <a href="https://ru.wikipedia.org/wiki/Часовой_пояс">часовыми поясами</a>. В этой статье я обобщу
полученный опыт о работе со временем. Разберемся раз и навсегда как
обращаться с ним правильно.</p>

<p>Зоны и их преобразования – достаточно тяжелая для изучения тема. Это
не проходят в институтах, об этом мало статей на популярных
ресурсах. Разработчики учатся работать со временем методом проб и
ошибок.</p>

<p>В одном из прошлых проектов в нашей команде не было никого, кто бы мог
внятно донести лучшие практики работы со временем. Коллективное
незнание было компенсировано харизмой и желанием писать много кода.</p>

<p>Мы воздвигли модуль полный костылей и багов, которые ловили в
проде. Провалы становились очевидны когда исправлять их было уже
затратно. Скорее всего, в вашем проекте дела обстоят так же.</p>

<p>Не устану повторять случай с коллегой, который работал в лондонском
стартапе. Лондон это такой город, от которого отсчитываются часовые
пояса, потому что через него проходит нулевой меридиан. Иначе говоря,
локальное и общемировое времена в Лондоне одинаковы (не считая
обозначения зоны, конечно).</p>

<p>Пока разработка шла в Лондоне, никто и не думал ни про какие зоны, и
код писали без их учета. Разработчик с зоной +3 столкнулся с тем, что
не проходит ни один тест, потому что время прибито гвоздями без учета
пояса. В итоге коллега проработал у них год сидя с переведенными
часами. Было проще поменять зону локально, чем исправить код.</p>

<p>Забавно, что бизнес той фирмы был связан с расписанием общественного
транспорта, где время имеет решающую роль. Это снова поднимает вопросы
о том, кто и как пишет повседневное ПО.</p>

<p>В нашем проекте фронтендер решил, что он умнее системы и что нужно
помочь клиенту перевести локальное время в UTC. И тем самым заложил в
систему трудноуловимый баг. При отправке объекта Date через Ajax
первый автоматически приводится к общемировому времени. Затем срабатывал
обработчик коллеги, который тоже корректировал пояс. Получается,
что мы дважды вычитали локальное время на клиенте и тем самым портили
любую дату с сервера.</p>

<p>Теперь представьте, что будет, если показать не то время на сайте
продажи авиабилетов. Или прислать смс-напоминание с ошибкой в
приведении часовых зон. Это будет стоить колоссальных денег и нервов.</p>

<p>Я заметил, что откровенно плохо обстоит со временем у
фронтендеров. Это связано с тем, что время – скорее серверная часть
приложения, и к тому же требует некоторой подготовки и мышления. Чаще
всего ошибки случались на стороне клиентской части.</p>

<p><strong>Главное правило:</strong> никогда не пишите свой код для операций над
временными зонами. Все современные библиотеки уже имеют этот
функционал из коробки. Обертки над временными операциями должны быть
минимальными. Если модуль разрастается без контроля, вы явно пишете
говнокод. Остановитесь, пока весь проект не стал зависеть от кривых
классов или функций.</p>

<p>Хорошей практикой будет избегать преобразований на местах внутри
бизнес-логики. Лучше создать отдельный модуль и наполнять его
вспомогательным кодом. Логично, что если где-то выяснится, что нужно
было отнимать интервал, а не прибавлять, то исправить одну функцию
будет проще, чем сканировать весь проект.</p>

<p>Для работы со временем лучше сразу брать хорошую стороннюю
библиотеку. Время настолько сложная вещь, что редкий язык может
похвастаться качественной коробочной реализацией. В Джаваскрипте
объект <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date">Date</a> убог. В Джаве класс <a href="https://docs.oracle.com/javase/7/docs/api/java/util/Date.html">java.util.Date</a>
был объявлен deprecated уже с версии 1.1, то есть почти сразу. Родной
<a href="https://docs.python.org/3/library/datetime.html">datetime</a> в Питоне приемлем только для базовых задач.</p>

<p>Не нужно думать, что “мне только оберточку написать”, зато без
зависимостей. Время – важно. Пусть будут зависимости, но меньше
багов.</p>

<p>Рассмотрим основные положения о часовых поясах. Если оставить в
стороне политические и географические причины, то в силу сферической
природы мира разные люди могут наблюдать одно и то же положение Солнца
на небосводе в разные моменты времени. Назовем это локальным
временем. Последнее работает только в пределах того меридиана, дальше
начинается неопределенность.</p>

<p>(Конечно, часовые пояса идут не идеально ровно как полоски на
арбузе. Еще недавно в России меняли временные зоны – объединяли и
делили соседние. Так, стараниями Медведева в моей родной Чите зимой в
16 часов было уже темно как ночью. Но для простоты будем считать, что
пояса распределены равномерно.)</p>

<p>Поэтому фраза “созвонимся в три часа” в общемировом масштаба не значит
ничего. По чьему времени в три часа? По Москве? Нью-Йорку? Очевидно,
нужна особая метка чтобы обозначить, откуда это время получено. Тогда
путем простых вычислений можно перевести время из одной метки в
другую. Эта метка и называется временной зоной.</p>

<p>Обозначение у нее может быть разное, например смещение в часах
(+03:00), имя части света и города через косую черту (Europe/Berlin)
или одна из аббревиатур (CET, Центральное Европейское время), но это
уже тонкости стандартов кадирования. Важно то, что теперь время
привязано к конкретной местности и может быть преобразовано в
универсальное время UTC.</p>

<p><a href="https://en.wikipedia.org/wiki/Coordinated_Universal_Time">UTC</a> – универсальное координированное время – это
современный стандарт отсчета, пришедший на смену GMT. Не будем сейчас
разбирать его особенности, достаточно сказать, что на шкале поясов он
играет роль нуля: именно от него отсчитываются отрицательные
(западные) и положительные (восточные) зоны.</p>

<p>Например, я живу в Воронеже, мой пояс третий по счету на восток,
поэтому я могу написать в резюме “when calling, please consider my +3
UTC timezone” или просто “my TZ is +3”. Тогда заказчик из Лондона, у
которого нулевой пояс, добавит к своему времени 3 часа и получит мое
локальное время.</p>

<p>Я подвожу вас к мысли, что в приложениях недостаточно знать только
время, нужно знать еще и зону, иначе одно и то же время может быть
истолковано по-разному. Так мы переходим к технической части статьи.</p>

<p>Ваш сервер и база данных отвечают за хранение дат. Современные БД
(здесь и далее – PostgreSQL) предоставляют два типа полей: это
<code class="language-plaintext highlighter-rouge">timestamp with time zone</code> и <code class="language-plaintext highlighter-rouge">timestamp without time zone</code>, то есть с
зоной или без. Если в первое поле записать дату с зоной, то БД
сконвертирует ее в UTC, потому что так удобней. А при выводе этой даты
в утилитах она будет представлена в локальном времени того
пользователя, кто сейчас ее просматривает.</p>

<p>Рассмотрим пример:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">create</span> <span class="k">table</span> <span class="n">foo</span> <span class="p">(</span>
  <span class="n">ts_z</span> <span class="nb">timestamp</span> <span class="k">with</span> <span class="nb">time</span> <span class="k">zone</span><span class="p">,</span>
  <span class="n">ts</span> <span class="nb">timestamp</span> <span class="k">without</span> <span class="nb">time</span> <span class="k">zone</span>
<span class="p">);</span>

<span class="k">CREATE</span> <span class="k">TABLE</span>

<span class="k">insert</span> <span class="k">into</span> <span class="n">foo</span> <span class="p">(</span><span class="n">ts_z</span><span class="p">)</span> <span class="k">values</span>
  <span class="p">(</span><span class="s1">'2017-12-13T10:00:00-05:00'</span><span class="p">::</span><span class="nb">timestamp</span> <span class="k">with</span> <span class="nb">time</span> <span class="k">zone</span><span class="p">);</span>

<span class="k">INSERT</span> <span class="mi">0</span> <span class="mi">1</span>

<span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">foo</span><span class="p">;</span>
</code></pre></div></div>

<p>Результат:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>          ts_z          | ts
------------------------+----
 2017-12-13 18:00:00+03 |
(1 row)
</code></pre></div></div>

<p>Я создал таблицу с двумя полями: время с зоной и без. Потом записал в
поле с временной зоной время с часовым поясом Нью-Йорка. В базе оно
будет храниться как <code class="language-plaintext highlighter-rouge">2017-12-13 15:00:00 UTC</code>. Но при выводе я увижу
время в консоли в моем локальном времени. Все верно, мой пояс +3, дата
была приведена верно.</p>

<p>А в поле <code class="language-plaintext highlighter-rouge">ts</code> нужно писать только время по UTC, иначе будет ошибка:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">insert</span> <span class="k">into</span> <span class="n">foo</span> <span class="p">(</span><span class="n">ts</span><span class="p">)</span> <span class="k">values</span>
  <span class="p">(</span><span class="s1">'2017-12-13T10:00:00-05:00'</span><span class="p">::</span><span class="nb">timestamp</span> <span class="k">with</span> <span class="nb">time</span> <span class="k">zone</span><span class="p">);</span>

<span class="k">INSERT</span> <span class="mi">0</span> <span class="mi">1</span>

<span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">foo</span><span class="p">;</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>          ts_z          |         ts
------------------------+---------------------
 2017-12-13 18:00:00+03 |
                        | 2017-12-13 18:00:00
(2 rows)
</code></pre></div></div>

<p>Видим, что во второе поле записалось не то, что нужно: правильное
время по UTC должно быть 15 часов, а не 18. Вот как нужно было
сделать:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">insert</span> <span class="k">into</span> <span class="n">foo</span> <span class="p">(</span><span class="n">ts</span><span class="p">)</span> <span class="k">values</span>
  <span class="p">(</span><span class="s1">'2017-12-13T10:00:00-05:00'</span><span class="p">::</span><span class="nb">timestamp</span> <span class="k">with</span> <span class="nb">time</span> <span class="k">zone</span> <span class="k">AT</span> <span class="nb">TIME</span> <span class="k">ZONE</span> <span class="s1">'UTC'</span><span class="p">);</span>

<span class="k">INSERT</span> <span class="mi">0</span> <span class="mi">1</span>

<span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">foo</span><span class="p">;</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>          ts_z          |         ts
------------------------+---------------------
 2017-12-13 18:00:00+03 |
                        | 2017-12-13 18:00:00
                        | 2017-12-13 15:00:00
(3 rows)
</code></pre></div></div>

<p>Эта и другие ошибки будут рассмотрены ниже.</p>

<p>В различных библиотеках и ORM при выборке подобных дат они
восстанавливаются в объекты языка с заполненной часовой зоной (поля
tz, zone, tzinfo и тд).</p>

<p>Вариант дат без зон тоже имеет право на жизнь, и на мой взгляд он
проще. В команде вы просто соглашаетесь, что все даты хранятся как
локальное время по UTC. Все библиотеки имеют функции и методы для
работы с таким временем, например, <code class="language-plaintext highlighter-rouge">datetime.utcnow()</code> в Питоне,
<code class="language-plaintext highlighter-rouge">moment.utc()</code> в JS и тд.</p>

<p>Клиент и сервер должны обмениваться друг с другом только датами в
UTC. Универсальное время переводится в локальное на стороне клиента
исходя из локального смещения относительно нулевого меридиана. Эту
величину можно определить методом <code class="language-plaintext highlighter-rouge">.getTimezoneOffset()</code> объекта
<code class="language-plaintext highlighter-rouge">Date</code> на клиенте.</p>

<p>При передаче дат клиенту вы кодируете их в <a href="https://en.wikipedia.org/wiki/ISO_8601">ISO-формат</a> с
зоной. Если зона UTC, она обозначается буквой Z. Таким образом, в
текстовом представлении время, отправляемое клиенту будет выглядеть
так:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>"2017-12-12T14:12:23.502Z"
</code></pre></div></div>

<p>Слева направо: год, месяц, день, разделитель, часы, минуты, секунды,
микросекунды, индикатор нулевой зоны UTC.</p>

<p>При кодировании даты без зоны некоторые библиотеки могут не добавить
<code class="language-plaintext highlighter-rouge">Z</code> на конце, что может запутать клиента. Обязательно учтите это:
добавьте в модуль функцию, которая будет добавлять Z к результирующей
строке и пользуйтесь только этой функцией (см. выше о единой кодовой
базе для работы со временем).</p>

<p>На этом этапе нельзя не заметить, насколько убог формат JSON: он не
может передавать даты и не расширяется.</p>

<p>В обратную сторону с клиента на сервер даты передаются в таком же
формате: ISO-строка в UTC с <code class="language-plaintext highlighter-rouge">Z</code> на конце в качестве зоны.</p>

<p>Рассмотрим, что делать клиенту с полученной строкой. Легче всего
восстановить ее в объект библиотекой <a href="https://momentjs.com/">moment.js</a>:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">moment</span><span class="p">(</span><span class="dl">"</span><span class="s2">2017-12-12T14:20:05.849Z</span><span class="dl">"</span><span class="p">).</span><span class="nx">format</span><span class="p">()</span>
<span class="dl">"</span><span class="s2">2017-12-12T17:20:05+03:00</span><span class="dl">"</span>
</code></pre></div></div>

<p>Видим, что все правильно: мой пояс +3, часы были увеличены на эту
разницу, на конце индикатор +03:00.</p>

<p>В сторону: сейчас кто-то встанет и начнет заливать, что moment.js уже
не популярен, и что горячие парни пишут какую-то новую либу на замену
ей. Мой совет – шлите лесом таких советчиков. Нам нужно проверенное
решение, а не модная поделка.</p>

<p>В каком формате показывать дату – зависит от вас. В каждой стране
свои форматы, определяющие порядок следования составляющих (день,
месяц или месяц, день), разделителей (точка, косая черта, дефис),
написание месяцев (Dec, December). Важно понять, что успешный вывод
даты зависит от того, была ли правильно она восстановлена из строки на
этапе ранее.</p>

<p>Стоит запомнить: если показ даты требует от вас каких-то махинаций
вроде прибавления или вычитания часов, минут или что-то в этом роде –
срочно остановитесь, вы гарантированно что-то делаете неправильно. Или
должно быть четкое понимание, почему нельзя сделать по-другому.</p>

<p>При передаче JSON-тела на сервер объект Date не нужно приводить в
ISO-строку вручную. Для этого существует метод <code class="language-plaintext highlighter-rouge">.toJSON()</code>, который
автоматически будет вызван при кодировании внешнего словаря. Например:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">();</span>
<span class="nx">Tue</span> <span class="nx">Dec</span> <span class="mi">12</span> <span class="mi">2017</span> <span class="mi">18</span><span class="p">:</span><span class="mi">40</span><span class="p">:</span><span class="mi">48</span> <span class="nx">GMT</span><span class="o">+</span><span class="mi">0300</span> <span class="p">(</span><span class="nx">MSK</span><span class="p">)</span>

<span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span><span class="na">foo</span><span class="p">:</span> <span class="mi">42</span><span class="p">,</span> <span class="na">bar</span><span class="p">:</span> <span class="nx">d</span><span class="p">})</span>
<span class="dl">"</span><span class="s2">{</span><span class="dl">"</span><span class="nx">foo</span><span class="dl">"</span><span class="s2">:42,</span><span class="dl">"</span><span class="nx">bar</span><span class="dl">"</span><span class="s2">:</span><span class="dl">"</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">12</span><span class="nx">T15</span><span class="p">:</span><span class="mi">40</span><span class="p">:</span><span class="mf">48.573</span><span class="nx">Z</span><span class="dl">"</span><span class="s2">}</span><span class="dl">"</span>
</code></pre></div></div>

<p>Рассмотрим основные ошибки, связанные с обработкой времени и как с
ними бороться. Начнем с сервера.</p>

<ul>
  <li>Тип поля указан <code class="language-plaintext highlighter-rouge">timestamp with time zone</code>, но вы передаете объект
времени без зоны.</li>
</ul>

<p>В этом случае сервер подставит текущую зону, то есть ту, в которой
расположен сервер. Если пользователь расположен далеко, например, на
другом континенте, это может вызвать значительные неудобства. Скажем,
пользователь из Нью-Йорка (-5 UTC) передал на сервер время
<code class="language-plaintext highlighter-rouge">"2017-12-12T14:20:00Z"</code>. Сервер расположен в Швейцарии (+1 UTC). По
какой-то причине зона была отброшена, и в базу вместо
<code class="language-plaintext highlighter-rouge">"2017-12-12T23:20:00 UTC"</code> (исходное плюс 5 часов) записалось
<code class="language-plaintext highlighter-rouge">"2017-12-12T13:20:00 UTC"</code> (исходное минус 1 час). Ошибка в 10 часов!
Представьте, что это напоминания о поездке или рассылка смс.</p>

<ul>
  <li>Тип поля <code class="language-plaintext highlighter-rouge">timestamp without time zone</code>, но в базу пишется локальное
время сервера.</li>
</ul>

<p>Убедитесь, что для получения текущего времени вы используете функцию с
<code class="language-plaintext highlighter-rouge">utc</code> в ее имени, например, datetime.utcnow() вместо datetime.now() и
аналогично в других языках. В PostgreSQL аналогично: почти для всех
вызовов временных функций нужно указывать зону UTC. Сравните:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; select current_timestamp;
       now
-------------------------------
 2017-12-12 19:03:07.683706+03


&gt; select current_timestamp at time zone 'UTC';
     timezone
--------------------------
 2017-12-12 16:04:21.7177
</code></pre></div></div>

<p>Перевести зону из одной в другую на уровне БД можно следующим
оператором:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span>
  <span class="s1">'2017-12-13T10:00:00-05:00'</span><span class="p">::</span><span class="nb">timestamp</span> <span class="k">with</span> <span class="nb">time</span> <span class="k">zone</span> <span class="k">AT</span> <span class="nb">TIME</span> <span class="k">ZONE</span> <span class="s1">'UTC'</span>
  <span class="k">as</span> <span class="n">right_time</span><span class="p">;</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>     right_time
---------------------
 2017-12-13 15:00:00
</code></pre></div></div>

<p>Теперь клиент.</p>

<ul>
  <li>С сервера приходят UTC-даты в ISO, но без метки Z, например
<code class="language-plaintext highlighter-rouge">"2017-12-12T14:20:05"</code>.</li>
</ul>

<p>Попытка отобразить такую дату с помощью moment.js, как мы делали выше,
приведет к ошибке:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">moment</span><span class="p">(</span><span class="dl">"</span><span class="s2">2017-12-12T14:20:05</span><span class="dl">"</span><span class="p">).</span><span class="nx">format</span><span class="p">()</span>
<span class="dl">"</span><span class="s2">2017-12-12T14:20:05+03:00</span><span class="dl">"</span>
</code></pre></div></div>

<p>Вариантов тут два: либо приклеить к строке со временем нужную зону,
либо явно указать библиотеке, что это время в UTC:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">moment</span><span class="p">.</span><span class="nx">utc</span><span class="p">(</span><span class="dl">"</span><span class="s2">2017-12-12T14:20:05</span><span class="dl">"</span><span class="p">).</span><span class="nx">local</span><span class="p">().</span><span class="nx">format</span><span class="p">()</span>
<span class="dl">"</span><span class="s2">2017-12-12T17:20:05+03:00</span><span class="dl">"</span>
</code></pre></div></div>

<p>Метод <code class="language-plaintext highlighter-rouge">.utc()</code> парсит строку с учетом того, что результат будет время
по UTC. Метод <code class="language-plaintext highlighter-rouge">.local()</code> преобразует его к локальному времени на
основании смещения, которое берется из браузера. Теперь все правильно.</p>

<ul>
  <li>С сервера приходит его локальное время.</li>
</ul>

<p>Это беда, но лечится явным указанием зоны. Например, вы в Москве, а
сервер в Нью-Йорке. Он отдает локальное время
<code class="language-plaintext highlighter-rouge">"2017-12-12T14:20:05"</code>. Нью-Йорк в минус пятом часовом
поясе. Приклеим зону к строке и распарсим:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">moment</span><span class="p">(</span><span class="dl">"</span><span class="s2">2017-12-12T14:20:05</span><span class="dl">"</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">-05:00</span><span class="dl">"</span><span class="p">).</span><span class="nx">format</span><span class="p">()</span>
<span class="dl">"</span><span class="s2">2017-12-12T22:20:05+03:00</span><span class="dl">"</span>
</code></pre></div></div>

<p>Значит, это 22:20 вечера по Москве. Проверим устно: если от НЙ до
нулевого меридиана 5 часов, а потом еще 3 часа до Москвы, то в сумме 8
часов. 14 + 8 = 22 часа местного времени.</p>

<ul>
  <li>Сервер отдает время в виде “unix epoch”.</li>
</ul>

<p>Это значит в количестве секунд со дня рождения ОС Юникс – 1 января
1970 года. Такое время всегда представлено в UTC. Отобразить его
пользователю можно так:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">moment</span><span class="p">.</span><span class="nx">unix</span><span class="p">(</span><span class="mi">1513107997</span><span class="p">).</span><span class="nx">format</span><span class="p">()</span>
<span class="dl">"</span><span class="s2">2017-12-12T22:46:37+03:00</span><span class="dl">"</span>
</code></pre></div></div>

<p>На мой взгляд, хранение времени в виде числа секунд имеет ряд
недостатков. Во-первых, оно совершенно нечитаемо. По набору цифр
невозможно определить даже год с точностью до десятка. Во-вторых, это
не оптимально. Современные БД хранят даты в таком виде, чтобы было
удобно обращаться к их составным частям. Напротив, хранение в дат в
секундах требует постоянной конвертации.</p>

<p>Обобщу вышесказанное.</p>

<p>Научиться работать со временем не сложно. Главное – не оправдывать
лень и не дожидаться момента, когда съедут все даты вечером в
пятницу. Время – важно.</p>

<p>Воздержитесь от собственных поделок для работы с часовыми
поясами. Оставляйте операции со временем на откуп проверенным
библиотекам. Выносите вспомогательные функции в особый модуль.</p>

<p>Храните даты на сервере либо с временной зоной UTC, либо без нее, но
подразумевая это.</p>

<p>Клиент и сервер должны пересылать даты только в UTC с нулевой зоной Z.</p>

<p>Локальное время выводится на клиенте из UTC относительно локального
смещения пользователя.</p>

<p>При кодировании дат в JSON последний сам позаботится часовом поясе. Вы
не должны что-то прибавлять или вычитать.</p>

<p>Маленький бонус: рассмотрим как быть, если формировать локальное время
нужно не на клиенте, а на сервере. До сих пор я вел разговор в том
ключе, что у нас Single page application и все рендериться на
клиенте. Однако, чисто серверные приложения никуда не делись, и такая
задача тоже может возникнуть.</p>

<p>Представим, что даты хранятся в UTC, но вот пришел HTTP-запрос от
какого-то пользователя, и нужно показать даты в его локальном
формате. Как быть?</p>

<p>Пока у нас нет никаких данных о пользователе, можно, используя его IP,
через сторонний сервис или библиотеку с локальной базой адресов на
борту хотя бы примерно определить его страну или даже город. По этом
данным станет легко вывести временной пояс.</p>

<p>Но страна вовсе не означает время. Так, пользователь Воронежа может
сидеть через прокси или Тор с выходной нодой где-то в Индии, но при
это его локальное время не имеет отношения к этой стране.</p>

<p>Узнать локальное смещение можно через специальный метод объекта <code class="language-plaintext highlighter-rouge">Date</code>:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">()).</span><span class="nx">getTimezoneOffset</span><span class="p">()</span>
<span class="o">-</span><span class="mi">180</span>
</code></pre></div></div>

<p>Оно выражено в минутах и имеет знак противоположный часовому
поясу. Если у меня зона +3, то смещение будет -180 минут.</p>

<p>С помощью скрипта это значение можно положить в куки на стороне
клиента, и тогда все последующие запросы к серверу будут сообщать о
настоящем часовом поясе пользователя.</p>

<p>Чтобы привести время UTC в локальное на сервере, достаточно вычесть из
первого смещение в минутах. При этом нужно держать в уме знак:
вычитание отрицательных минут означает их прибавление, что нам и
нужно.</p>

<p>Рассмотрим код на Питоне:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>

<span class="n">utc</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="n">utcnow</span><span class="p">()</span>
<span class="n">loc</span> <span class="o">=</span> <span class="n">utc</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=-</span><span class="mi">180</span><span class="p">)</span>

<span class="n">utc</span> <span class="c1"># datetime.datetime(2017, 12, 13, 13, 57, 18, 108606)
</span><span class="n">loc</span> <span class="c1"># datetime.datetime(2017, 12, 13, 16, 57, 18, 108606)
</span></code></pre></div></div>

<p>Локальное время на 3 часа больше, теперь эту дату можно показывать
пользователю.</p>

<p>Это был пример явной манипуляции с часовыми поясами. Выше я писал, что
этого следует избегать. Однако, здесь явно присутствует понимание
того, что мы делаем. Простой вычет будет эффективней и проще
использования навороченной библиотеки с часовыми поясами.</p>

<p>Ну вот и все, думаю, это было не сложно. Я не люблю просить о репостах
и никогда не делал этого, но на этот раз сделаю исключение. Прошу
показать эту статью тем, кто связан с веб-разработкой, особенно
фронтендом. Возможно, хоть где-то удастся избежать ошибок вроде тех,
что я описал в самом начале. Может, хоть немного облегчатся чьи-то
будни.</p>

<p>Награда для тех, кто прочел до конца:</p>

<iframe width="640" height="360" src="https://www.youtube.com/embed/VY3O2aGfzhs" gesture="media" allow="encrypted-media" allowfullscreen=""></iframe>

  </div>

</article>

<center>
    <p>
        <small>Нашли ошибку? Выделите мышкой и нажмите Ctrl/&#8984;+Enter</small>
    </p>
</center>






<center>Комментарии</center>

<div id="comments">
  
    <div id="comment-4310558048" class="comment-block">
      <p class="comment-lead">
        <small>
          <em>
            sashashakun,
            28th Jan 2019,
            <a href="#comment-4310558048">link</a>
            
          </em>
        </small>
      </p>
      <div><p>Спасибо за статью!</p>
<p>&gt;Но стана вовсе не означает время.<br />кажется опечатка: стРана</p>
</div>
    </div>
  
    <div id="comment-4392609353" class="comment-block">
      <p class="comment-lead">
        <small>
          <em>
            Роман Ковалев,
            24th Mar 2019,
            <a href="#comment-4392609353">link</a>
            
          </em>
        </small>
      </p>
      <div><p>Отлично! Очень понравилось, спасибо! Нашел ответы на вопросы, которые ношу в голове последние лет пять. ))</p>
</div>
    </div>
  
    <div id="comment-4606662384" class="comment-block">
      <p class="comment-lead">
        <small>
          <em>
            Anatoliy,
            6th Sep 2019,
            <a href="#comment-4606662384">link</a>
            
          </em>
        </small>
      </p>
      <div><p>Отличная статья. Хотя и не на все свои вопросы я нашел ответы.<br />А что если у меня сервис бронирования времени с прикрученым напоминанием за сутки? <br />А потребители могут быть в разных временных поясах. Как сделать серивис максимально гибким в вопросе работы со временем? Можно, конечно, каждому клиенту выделять отдельную инстанцию сервиса с прописанной в конфиге зоной, так сказать, спэшл фор ю. А если так делать нет возможности? Как-то просить зону с UI? хранение в базе только смещения не годиться, т.к. есть перевод часов.....и если бронь была сделана до перевода, то и смещение прописалось то, что было до перевода. Пока вариант - хранить зону в виде строки, типа "Europe/Helsinki", само время и дату - как просто не привязанную к таймлайну велечину (в Java - LocalDateTime).</p>
</div>
    </div>
  
    <div id="comment-4607442381" class="comment-block">
      <p class="comment-lead">
        <small>
          <em>
            Ivan Grishaev,
            7th Sep 2019,
            <a href="#comment-4607442381">link</a>
            , <a href="#comment-4606662384">parent</a>
          </em>
        </small>
      </p>
      <div><p>Если потребители в разных поясах, то  на сервере вы храните часовую зону каждого пользователя. Узнать ее можно разными способами, например по IP-адресу или просто через диалог. Затем рассчитываете локальное время пользователя, удобное ему, и отправляете сообщение.</p>
</div>
    </div>
  
    <div id="comment-4765137114" class="comment-block">
      <p class="comment-lead">
        <small>
          <em>
            Adel,
            21st Jan 2020,
            <a href="#comment-4765137114">link</a>
            
          </em>
        </small>
      </p>
      <div><p>Спасибо за статью!</p>
<p></p>
<blockquote>Скажем, пользователь из Нью-Йорка (-5 UTC) передал на сервер время "2017-12-12T14:20:00Z". Сервер расположен в Швейцарии (+1 UTC). По какой-то причине зона была отброшена, и в базу вместо "2017-12-12T23:20:00 UTC" (исходное плюс 5 часов) [...]<br /></blockquote>
<p></p>
<p>Почему 23:20:00? Разве не 19:20:00?</p>
</div>
    </div>
  
</div>









<form id="comment-form" method="POST" action="https://functions.yandexcloud.net/d4ehfuf08fjfjr59ivnf">

    <div class="block">
        <p class="comment-form-label"><small>Your name</small></p>
        <input required id="comment-form-author" name="author" type="text">
    </div>

    <div class="block">
        <p class="comment-form-label"><small>Comment (markdown syntax)</small></p>
        <textarea required id="comment-form-comment" name="comment"></textarea>
    </div>

    <input required name="path" type="hidden" value="/timezone/">
    <input required name="captcha" type="hidden" value="9 &#215; 6">

    <div class="block">
        <span class="comment-form-label"><small>9 &#215; 6 = </small></span>
        <input required id="comment-form-solution" name="solution" type="text">
    </div>

    <div class="block">
        <button id="comment-form-send" type="submit">Send</button>
    </div>

</form>


      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Ivan Grishaev's blog</li>
          <li><a href="mailto:ivan@grishaev.me">ivan@grishaev.me</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
            <li><a href="https://github.com/igrishaev">GitHub</a></li>
            <li><a href="tg://resolve?domain=igrishaev_blog">Telegram</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Writing on programming, education, books and negotiations.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
