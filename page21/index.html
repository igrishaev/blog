<!DOCTYPE html>
<html lang="ru">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Ivan Grishaev's blog</title>
  <meta name="description" content="Writing on programming, education, books and negotiations.
">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/custom.css">
  <link rel="canonical" href="https://grishaev.me/page21/">
  <link rel="alternate" type="application/rss+xml" title="Ivan Grishaev's blog" href="https://grishaev.me/feed.xml">

  <link rel="shortcut icon" type="image/x-icon" href="/assets/static/favicons/favicon.ico">

  <script type="text/javascript" src="/assets/typo.js"></script>

</head>


  <body>
    <header class="site-header">

    <div class="wrapper flex-container">

        <div>
            <a href="/">
                <img id="avatar" src="/assets/static/avatar.jpg" alt="Ivan Grishaev">
            </a>
        </div>

        <div class="flex-container-vert" style="margin-left: 15px; width: 80%">

            <div class="flex-container full-width">
                <p style="margin-bottom: 5px">Ivan Grishaev's blog</p>
                <div class="flex-huge"></div>
                <div >
<form id="search-form"
      target="_blank"
      style="display: inline"
      method="get"
      action="https://www.google.com/search">

    <input name="sitesearch"
           value="grishaev.me"
           type="hidden">

    <input type="text"
           required="required"
           name="q"
           placeholder="Google search..."
           autocomplete="off">

    <button style="border: none; background-color: transparent; cursor: pointer;"
            type="submit">&#x1f50d;</button>

</form>
</div>
            </div>

            <p><small>Writing on programming, education, books and negotiations.
</small></p>

            <div class="flex-container">
                <a class="menu-item" href="/">Home</a>
                <a class="menu-item" href="/about/">About</a>
                <a class="menu-item" href="/bookshelf/">Bookshelf</a>
                <a class="menu-item" href="/feed.xml">RSS</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor" href="/tag/clojure/">Clojure</a>
                <a class="menu-item minor" href="/tag/emacs/">Emacs</a>
                <a class="menu-item minor" href="/tag/python/">Python</a>
                <a class="menu-item minor" href="/tag/programming/">Programming</a>
                <a class="menu-item minor" href="/interview/">Interview</a>
                <a class="menu-item minor" href="/video/">Video</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor hl" href="/clojure-in-prod/">Книга «Clojure на производстве»</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor hl" href="/clojure-in-prod-2/">Книга «Clojure на производстве», второй том</a>
            </div>

        </div>
    </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="home">

    <ul class="post-list">
        
        <li>

            <h2>
                <a class="post-link" href="/de-js-4/">Деджаваскриптизиция (4)</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2022-10-01T00:00:00+00:00">
        Oct 1, 2022
    </time>

    <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/javascript/" rel="tag">javascript</a>, <a href="/tag/blog/" rel="tag">blog</a>, <a href="/tag/disqus/" rel="tag">disqus</a>, <a href="/tag/comments/" rel="tag">comments</a>

</div>


            <div class="entry">
                
                    <p>Пора заканчивать эпопею про избавление от Js. Чтобы не утомлять, расскажу о последнем штрихе — как внедрил капчу для комментариев.</p>

<p>Как только я убрал Disqus, полезли спамные комментарии. Каждый день приходят два-три предложения купить виагру, надувную лодку или просто левые ссылки. Поскольку каждый комментарий открывает PR в репозиторий, все остается в истории Гитхаба. Посмотреть на это добро <a href="https://github.com/igrishaev/blog/pulls?q=is%3Apr+is%3Aclosed">можно по ссылке</a>.</p>

<p>Разгребать подобные комментарии нет желания, поэтому должна быть минимальная защита от спама. С условием — без Js. Надумал такую схему:</p>

<ul>
  <li>капча генерируется на этапе сборки блога. На выходе получается HTML-форма с полем captcha и значением 2 × 5.</li>
  <li>В форму добавляется поле для решения.</li>
  <li>Сервер парсит капчу, решает и сверяет с ответом. Если что-то не так, заворачивает комментарий.</li>
</ul>

<p>Как ни странно, даже на таком примитиве боты отваливаются. Разве что с оговоркой: когда был оператор +, боты решали капчу. Как только заменил на <code class="language-plaintext highlighter-rouge">×</code> (знак умножения в юникоде), стала тишь да благодать. Надеюсь, читатель не забыл таблицу умножения! Тестируя форму, сам подвис с примером <code class="language-plaintext highlighter-rouge">8 × 9</code>.</p>

<p>Техническая сторона: вот построить капчу в шаблоне:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
{% assign val1 = '1 2 3 4 5 6 7 8 9' | split: ' ' | sample %}
{% assign val2 = '1 2 3 4 5 6 7 8 9' | split: ' ' | sample %}
{% assign op   = '&amp;#215;'            | split: ' ' | sample %}
{% assign captcha = val1 | append: " " | append: op | append: " " | append: val2 %}

</code></pre></div></div>

<p>Замечу, что при каждой сборке блога значения будут разные.</p>

<p>Скрытое поле в форме:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="nt">&lt;input</span> <span class="na">required</span> <span class="na">name=</span><span class="s">"captcha"</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">value=</span><span class="s">"{{ captcha }}"</span><span class="nt">&gt;</span>

</code></pre></div></div>

<p>Виджет для ввода решения:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"block"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"comment-form-label"</span><span class="nt">&gt;&lt;small&gt;</span>{{ captcha }} = <span class="nt">&lt;/small&gt;&lt;/span&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">required</span> <span class="na">id=</span><span class="s">"comment-form-solution"</span> <span class="na">name=</span><span class="s">"solution"</span> <span class="na">type=</span><span class="s">"text"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/div&gt;</span>

</code></pre></div></div>

<p>Наконец, серверный код проверки капчи:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">d</span><span class="err">е</span><span class="k">fn</span><span class="w"> </span><span class="n">validate-captcha</span><span class="w"> </span><span class="p">[</span><span class="n">captcha</span><span class="w"> </span><span class="n">solution</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nb">when-let</span><span class="w"> </span><span class="p">[[</span><span class="n">_</span><span class="w"> </span><span class="n">val1-raw</span><span class="w"> </span><span class="n">op-raw</span><span class="w"> </span><span class="n">val2-raw</span><span class="p">]</span><span class="w">
             </span><span class="p">(</span><span class="nb">re-find</span><span class="w"> </span><span class="o">#</span><span class="s">"^(-?\d+) (.+?) (-?\d+)$"</span><span class="w"> </span><span class="n">captcha</span><span class="p">)]</span><span class="w">

    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">val1</span><span class="w">
          </span><span class="p">(</span><span class="nf">Integer/parseInt</span><span class="w"> </span><span class="n">val1-raw</span><span class="p">)</span><span class="w">

          </span><span class="n">val2</span><span class="w">
          </span><span class="p">(</span><span class="nf">Integer/parseInt</span><span class="w"> </span><span class="n">val2-raw</span><span class="p">)</span><span class="w">

          </span><span class="n">op</span><span class="w">
          </span><span class="p">(</span><span class="nf">case</span><span class="w"> </span><span class="n">op-raw</span><span class="w">
            </span><span class="p">(</span><span class="s">"+"</span><span class="w"> </span><span class="s">"&amp;#43;"</span><span class="p">)</span><span class="w"> </span><span class="nb">+</span><span class="w">
            </span><span class="p">(</span><span class="s">"*"</span><span class="w"> </span><span class="s">"×"</span><span class="w"> </span><span class="s">"&amp;#215;"</span><span class="p">)</span><span class="w"> </span><span class="nb">*</span><span class="w">
            </span><span class="n">nil</span><span class="p">)]</span><span class="w">

      </span><span class="p">(</span><span class="nb">when</span><span class="w"> </span><span class="p">(</span><span class="nb">and</span><span class="w"> </span><span class="n">val1</span><span class="w"> </span><span class="n">val2</span><span class="w"> </span><span class="n">op</span><span class="p">)</span><span class="w">
        </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">str</span><span class="w"> </span><span class="p">(</span><span class="nf">op</span><span class="w"> </span><span class="n">val1</span><span class="w"> </span><span class="n">val2</span><span class="p">))</span><span class="w">
           </span><span class="p">(</span><span class="nf">str/trim</span><span class="w"> </span><span class="n">solution</span><span class="p">))))))</span><span class="w">
</span></code></pre></div></div>

<p>Грубо, неуклюже, но работает.</p>

<p>На этом я закончу тему с избавлением от Js. На мой взгляд, цели достигнуты, жить с новыми комментариями можно. Это был интересный опыт, в будущем пригодится.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/de-js-3/">Деджаваскриптизиция (3)</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2022-09-20T00:00:00+00:00">
        Sep 20, 2022
    </time>

    <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/javascript/" rel="tag">javascript</a>, <a href="/tag/blog/" rel="tag">blog</a>, <a href="/tag/disqus/" rel="tag">disqus</a>, <a href="/tag/comments/" rel="tag">comments</a>

</div>


            <div class="entry">
                
                    <p>Сбылась мечта идиота: теперь на сайте работают комментарии без строчки кода на Джаваскрипте. Смотайте экран вниз, там форма. Требуется только имя и тело комментария. Ввели, отправили, и через некоторое время он появится в блоге.</p>

<p>Форма:</p>

<p><img src="/assets/static/aws/de-js3/1.jpg" /></p>

<p>Экран возврата:</p>

<p><img src="/assets/static/aws/de-js3/2.jpg" /></p>

<p>А что, мне нравится.</p>

<p>Расскажу, как это работает. <a href="/de-js-2/">В прошлый раз</a> я перенес комментарии Disqus в репозиторий. Каждый комментарий — это файл формата YAML + markdown. В числе прочего он хранит ссылку на пост. Когда я собираю блог, в подвал каждой заметки подставляются ее комментарии.</p>

<p>Для приема комментариев я следую тому же принципу: чтобы они появились на сайте, нужно создать файл в репозитории. Теоретически любой может оформить pull request, но это сложно. Должен быть сервис, который преобразует ввод пользователя в pull request для блога. Этот сервис я написал и назвал <a href="https://github.com/igrishaev/blog-backend">blog-backend</a>.</p>

<p>Сервис напоминает веб-приложение: оно принимает HTTP-запрос с формой. После прелюдии с валидацией перехожу к главному: интеграции с Гитхабом. Это оказалось не так-то просто. У Гитхаба уже <a href="https://docs.github.com/en/rest">три рестовых API</a>, но ни одно не покрывает все возможности. Кроме REST есть <a href="https://docs.github.com/en/graphql">убер-апишка на GraphQL</a> — она-то мне и нужна.</p>

<p>Интеграция с GraphQL была нелегкой: это самобытный язык и вещь в себе. Если бы в текущем проекте не было GraphQL, я бы полез на стенку. Во-вторых, сложность процесса: чтобы сделать PR силами API, нужно четыре вызова:</p>

<ol>
  <li>получить метаданные репозитория, в том числе последний коммит;</li>
  <li>создать ветку от этого коммита;</li>
  <li>сделать коммит в новую ветку;</li>
  <li>сделать PR.</li>
</ol>

<p>Как по мне, апишка не консистентна: где-то на репозиторий ссылаешься по имени, а где-то по машинному ID, который приходит из метаданных. То же самое с ветками: где-то имя, где-то айдишник. Ответы GraphQL развесистые, с глубокой вложенностью. Например, последний коммит ветки погружен на пять уровней:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(-&gt; resp-get-repo :data :repository :ref :target :oid)
</code></pre></div></div>

<p>С такой апишкой невозможно программировать без образца данных.</p>

<p>Когда подружился с Гитхабом, настала проблема хостинга: где и как размещать логику. Мне понравился опыт с облаком Яндекса, и я продолжил эксперименты. Сервис написан на Кложе, скомпилирован Граалем в бинарь и хостится в <a href="https://cloud.yandex.ru/docs/functions/concepts/">Яндекс.Функции</a> — аналоге AWS Lambda.</p>

<p>В свою очередь, Яндекс.Функция — это облачный сервис, где размещают какой-то код и дергают его по запросу. Отличие от обычного хостинга в том, что у лямбды нет состояния: она запускается на короткое время и умирает. В зависимости от окружения лямбда может умереть не сразу, и если ее дернуть повторно, сработает уже запущенный экземпляр. На базе этого делают “прогрев” лямбд, у которых окружение стартует медленно, например Java. В моем случае граальный бинарник быстрый как не весть что, прогрева ему не надо.</p>

<p>Лямбду можно вызывать разными способами, в том числе HTTP-запросом. У каждой лямбды свой урл, который может быть приватным и публичным. Его можно указать в разных сервисах, что отлично подходит для ботов.</p>

<p>По сравнению с VM-хостингом у лямбды следующие плюсы:</p>

<ul>
  <li>не нужна виртуальная машина и ее настройка;</li>
  <li>не нужен домен;</li>
  <li>лямбды экстремально дешевы, потому оплачивается только время работы с округлением до 0.1 секунды;</li>
  <li>лямбды поощряют писать код без компонентов и состояния, что как бальзам на душу после проектов по работе.</li>
</ul>

<p>Поначалу я был крайне скептичен к лямбдам, но теперь вижу в них особую прелесть. Единственный момент — пришлось написать код, чтобы подружить Кложу и Ring с окружением лямбды. Также поправил компиляцию Граалем, чтобы в бинарнике была верная кодировка. В будущем я планирую вынести код Яндекс.Облака в отдельную библиотеку, чтобы избавиться от копипасты.</p>

<p>Форма поддерживает синтаксис Markdown. Пока что нет кнопок выделения текста болдом и италиком, сделаю потом. Форма отправляется чистым POST, никаких аяксов, хотя первую версию я сделал на fetch, JSON и CORS. Про CORS я все забыл, и пришлось читать <a href="/cors/">свою же статью</a> о том, как все настроить.</p>

<p>Новые комментарии совмещают модерацию. После отправки создается PR в блог, мне приходит письмо, а пользователь переходит на прошлую страницу. Если все в порядке, я мерджу ветку и заливаю свежий билд блога. Таким образом, с момента публикации комментария может пройти от пяти минут до нескольких дней, но это ничего.</p>

<p>Первые комментарии я получил от кого? Правильно, от спамеров. Этим утром предложили виагру, казино и просто левые ссылки. Вот ссылка <a href="https://github.com/igrishaev/blog/pull/120/files">на уже закрытый RP</a> и его содержимое:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>---
id: 1663659055173
is_spam: false
is_deleted: false
post: /bookshelf/
date: 2022-09-20 07:30:55 +0000
author_fullname: 'epiehuliqukib'
---

http://slkjfdf.net/ - Tatacatay &lt;a href="http://slkjfdf.net/"&gt;Aebaluk&lt;/a&gt;
lwk.wlgg.grishaev.me.mrq.mn http://slkjfdf.net/
</code></pre></div></div>

<p>Очевидно, нужно вводить капчу для защиты от ботов. Я рассматриваю это как новый вызов: как сделать капчу без Javascript в статичном блоге? Уже есть мыслишки, расскажу в четвертой части эпопеи.</p>

<p>Наконец, последний тезис — зачем вы это делаете, мистер Андерсон? Зачем эти отказы, костыли, превозможения? Ответ — потому что могу. Просто хочется экспериментов. Надоели тормозные сайты с JS, хочу маленький оазис в своем огороде.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/clj-repl-part-4/">REPL, Cider, Emacs (часть 4/4)</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2022-09-14T00:00:00+00:00">
        Sep 14, 2022
    </time>

    <a href="/tag/clojure/" rel="tag">clojure</a>, <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/repl/" rel="tag">repl</a>, <a href="/tag/emacs/" rel="tag">emacs</a>, <a href="/tag/cider/" rel="tag">cider</a>

</div>


            <div class="entry">
                
                    
<h2>Все части</h2>

<ul>
  <li><a href="/clj-repl-part-1/">Первая часть</a></li>
  <li><a href="/clj-repl-part-2/">Вторая часть</a></li>
  <li><a href="/clj-repl-part-3/">Третья часть</a></li>
  <li><a href="/clj-repl-part-4/">Четвертая часть</a></li>
</ul>

<h2>

    Оглавление

</h2>

<ul id="toc-item-clojure-repl-toc">
  <li><a href="#отладка-в-cider" id="toc-item-clojure-repl-toc-отладка-в-cider">Отладка в Cider</a>    <ul>
      <li><a href="#ограничения" id="toc-item-clojure-repl-toc-ограничения">Ограничения</a></li>
      <li><a href="#итог" id="toc-item-clojure-repl-toc-итог">Итог</a></li>
    </ul>
  </li>
  <li><a href="#nrepl-в-docker" id="toc-item-clojure-repl-toc-nrepl-в-docker">nREPL в Docker</a></li>
  <li><a href="#nrepl-в-боевом-режиме" id="toc-item-clojure-repl-toc-nrepl-в-боевом-режиме">nREPL в боевом режиме</a>    <ul>
      <li><a href="#nrepl-в-системе" id="toc-item-clojure-repl-toc-nrepl-в-системе">nREPL в системе</a></li>
      <li><a href="#безопасность" id="toc-item-clojure-repl-toc-безопасность">Безопасность</a></li>
    </ul>
  </li>
  <li><a href="#repl-в-других-средах" id="toc-item-clojure-repl-toc-repl-в-других-средах">REPL в других средах</a>    <ul>
      <li><a href="#поддержка-cider" id="toc-item-clojure-repl-toc-поддержка-cider">Поддержка Cider</a></li>
      <li><a href="#прочие-сведения" id="toc-item-clojure-repl-toc-прочие-сведения">Прочие сведения</a></li>
      <li><a href="#rebl" id="toc-item-clojure-repl-toc-rebl">REBL</a></li>
    </ul>
  </li>
  <li><a href="#заключение" id="toc-item-clojure-repl-toc-заключение">Заключение</a></li>
</ul>

<h2 id="отладка-в-cider">Отладка в Cider</h2>

<p>Мы исследовали отладку так долго, чтобы читатель убедился: в ней нет никакой магии. Отладчик — это код, который внедряется в исходный код и заставляет его работать с паузами. Во время паузы отладчик ждет команду пользователя и исполняет ее.</p>

<p>Теперь когда вы знакомы с самодельным отладчиком, рассмотрим, что предлагает Cider. В нашем распоряжении два тега: <code class="language-plaintext highlighter-rouge">#break</code> и <code class="language-plaintext highlighter-rouge">#dbg</code>. Первый тег означает точку останова (брейкпоинт) в месте, где он расположен. Поставьте <code class="language-plaintext highlighter-rouge">#break</code> в середину произвольного кода. Перед тем как запустить код, выполните его командой <code class="language-plaintext highlighter-rouge">cider-eval-...</code>, иначе эффект не вступит в силу.</p>

<p>Тег <code class="language-plaintext highlighter-rouge">#break</code> ссылается на функцию <code class="language-plaintext highlighter-rouge">breakpoint-reader</code> из модуля <code class="language-plaintext highlighter-rouge">cider.nrepl.middleware.debug</code>. Она принимает форму и добавляет в ее метаданные особое поле – признак отладки. Далее сработает оснащение (или инструментирование) — алгоритм, который ищет отмеченные формы и оборачивает их кодом, который запускает отладку.</p>

<p>Когда оснащенный код запущен, в нужных местах он прерывается, и от клиента ожидают команду. Можно узнать локальные переменные, выполнить выражение или перейти к следующей точке. Так продолжается до тех пор, пока код не выполнен целиком.</p>

<p>В Emacs нет графических средств отладки. Информация выводится либо рядом с кодом, либо в отдельных буферах. В режиме отладки файл нельзя редактировать; клавиши не вводят текст, а вызывают команды. Ошибка новичков в том, что, попав в отладку, они нажимают все подряд, и процесс протекает с ошибками. Ниже мы рассмотрим процедуру так, чтобы с вами этого не случилось.</p>


                    <p><a href="/clj-repl-part-4/">Read more &rarr;</a></p>
                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/de-js-2/">Деджаваскриптизиция (2)</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2022-09-13T00:00:00+00:00">
        Sep 13, 2022
    </time>

    <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/javascript/" rel="tag">javascript</a>, <a href="/tag/blog/" rel="tag">blog</a>, <a href="/tag/disqus/" rel="tag">disqus</a>

</div>


            <div class="entry">
                
                    <p>Сделал то, что намеревался: удалил с сайта все сторонние сервисы. Больше нет социальных кнопок, гугло-аналитики и, самое важное, комментариев Disqus. На страницах вообще нет аякса за тем исключением, когда встроен плеер Ютуба. Красота.</p>

<p>Отдельно расскажу про комментарии. Теперь они встроены в блог, являются его частью, а не лежат на серверах Disqus. Для этого я написал импорт из XML. Ясное дело, на Кложе, <a href="https://github.com/igrishaev/blog/blob/master/clj-comments/src/clj_comments/core.clj">исходники на Гитхабе</a>.</p>

<p>Если вкратце, код пробегает по XML, строит мапы и индексы по ID. Для каждого комментария он создает файл вроде <code class="language-plaintext highlighter-rouge">_comments/2016-08-08-08-27-14.md</code> с содержимым:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>---
id: 2826354744
is_spam: false
is_deleted: false
post: /interview/
date: 2016-08-08T08:27:14Z
author_fullname: 'Александр'
author_nickname: 'VinokurovAlexnader'
author_is_anon: false
---

&lt;p&gt;Вопрос "Есть кортеж из трех элементов. Назначить переменным a, b, c его значения".&lt;/p&gt;
&lt;p&gt;У Вас ответ:&lt;br&gt;a, b, c = [1, 2, 3]&lt;/p&gt;
&lt;p&gt;Но это список, а не кортеж. С кортежом будет вот так:&lt;br&gt;a, b, c = (1, 2, 3)&lt;/p&gt;
</code></pre></div></div>

<p>Всего таких файлов 993. В шаблон заметки я добавил код для вывода комментариев:</p>

<pre><code class="language-jinja2">{% assign comments = site.comments | where:'post', include.permalink %}
{% if comments.size == 0 %}
&lt;center&gt;Комментариев пока нет&lt;/center&gt;
{% else %}
&lt;center&gt;Комментарии&lt;/center&gt;
&lt;div class="comments-block"&gt;
  {% for comment in comments %}
    &lt;div class="comment-block"&gt;
      &lt;p class="comment-lead"&gt;
        &lt;small&gt;
          &lt;em&gt;{{ comment.author_fullname or comment.author_nickname }}, {{ comment.date | date_to_string: "ordinal", "RU" }}&lt;/em&gt;
        &lt;/small&gt;
      &lt;/p&gt;
      &lt;div&gt;{{ comment.content | markdownify }}&lt;/div&gt;
    &lt;/div&gt;
  {% endfor %}
&lt;/div&gt;
{% endif %}
</code></pre>

<p>Получилось неоптимально, потому что на каждый пост происходит линейный поиск. В идеале нужно один раз построить словарь URL =&gt; список комментариев и затем брать оттуда. Но я не настолько хорошо знаю Jekyll и Ruby, чтобы это запилить.</p>

<p>Ради интереса проверьте страницы, где много комментариев, например <a href="/ivi/#comments-block">про сервис IVI</a> или <a href="/interview/#comments-block">про интервью</a>. Лично мне результат нравится: чистенький HTML, минимум CSS, все лаконично. На текущий момент не учитывается структура, но технически это возможно: каждый комментарий знает ID родителя, и однажды их вывод можно улучшить.</p>

<p><img src="/assets/static/aws/de-js2/2.png" /></p>

<p>Теперь главное: как сделать прием комментариев. Мне накидали советов, плюс я гуглил, и все сводится двум решениям: Гитхаб или self-hosted сервис.</p>

<p>Напомню, как работает Гитхаб: люди пишут комменты к какому-либо issue. Зная номер issue, легко выгрести комментарии GET-запросом, сгенерить HTML и вставить под заметкой. <a href="https://blog.rpsl.info/2020/09/how-migrate-comments-from-disqus-to-github/">Выглядит красиво</a>:</p>

<p><img src="/assets/static/aws/de-js2/1.png" /></p>

<p>, но меня тревожат две вещи.</p>

<ol>
  <li>Комментарии лежат в чужом сервисе, который может отвалиться из-за санкций или Роскомнадзора.</li>
  <li>Обязательна авторизация через Гитхаб — не у всех есть учетная запись.</li>
</ol>

<p>Self-hosted-решения вроде <a href="https://remark42.com/">Remark42</a> интересны, но вынуждают держать виртуалку, платить за нее и делать бекапы. Придется возиться.</p>

<p>Я придумал так. Пишем лямбду для Яндекс.Облака (на Кложе с компиляцией Граалем). Лямбда принимает POST-запросы с сайта. На сайте висит статичная форма с полем action=URL нашей лямбды. Отправить форму может любой желающий, даже тот, у кого нет учетки в Гитхабе, Твиттере, Инстаграме и так далее.</p>

<p>Получив запрос, лямбда создает pull request в репозитории блога. Для этого не нужен git: все возможности Гитхаба доступны <a href="https://docs.github.com/en/rest/pulls/pulls#create-a-pull-request">в REST API</a>. Pull request содержит новый файл с комментарием в папке <code class="language-plaintext highlighter-rouge">_comments</code>. Мне приходит письмо. Если норм, я нажимаю Merge, блог собирается и выкатывается новая версия.</p>

<p>Одновременно получается модерация: если кто-то написал дичь, я отклоняю PR, и делу конец.</p>

<p>Открыв PR, лямбда перенаправляет пользователя обратно в блог со словами “спасибо, ваш комментарий скоро появится”.</p>

<p>Вот такую штуку я хочу запилить. А пока что комментации работают только в Телеграме.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/de-js/">Деджаваскриптизиция</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2022-09-11T00:00:00+00:00">
        Sep 11, 2022
    </time>

    <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/javascript/" rel="tag">javascript</a>, <a href="/tag/blog/" rel="tag">blog</a>, <a href="/tag/disqus/" rel="tag">disqus</a>

</div>


            <div class="entry">
                
                    <p>Как вы думаете, сколько запросов делает браузер, пока вы читаете заметку в моем блоге? Я тоже не знал. Десять, двадцать? Что гадать, если можно проверить!</p>

<p>Открываем консоль разработчика, вкладка Network. Виден всякий ajax/js-хлам. Тык правой кнопкой → “Save all as HAR with content”:</p>

<p><img src="/assets/static/aws/de-js/1.png" /></p>

<p>Получаем жирный JSON со всеми запросами. Вот как выдрать из него урлы:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat </span>grishaev.me.har | jq <span class="s1">'.log.entries[].request.url'</span> | <span class="nb">sort</span> <span class="o">&gt;</span> urls.txt
</code></pre></div></div>

<p>Если открыть <code class="language-plaintext highlighter-rouge">urls.txt</code> и удалить адреса с доменом <code class="language-plaintext highlighter-rouge">grishaev.me</code> (коих 5 штук), получится… 69 запросов. Вот они:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://a.disquscdn.com/1662551939/images/noavatar92.png
https://a.disquscdn.com/1662551939/images/noavatar92.png
https://accounts.google.com/o/oauth2/iframe
https://accounts.google.com/o/oauth2/iframerpc?action=checkOrigin&amp;origin=https%3A%2F%2Fdisqus.com&amp;client_id=508198334196-bgmagrg0a2rub674g0shidj8fnd50dji.apps.googleusercontent.com
https://accounts.google.com/o/oauth2/iframerpc?action=issueToken&amp;response_type=token%20id_token&amp;login_hint=AJDLj6J0ayD55kiHpX6FEyK8AjchAx-IxO13rW-0myyrGzenEj7YZFquZJE4XTK6YDPt86Y7SJkVEXs3QpNMeay0bCjiNqDIwg&amp;client_id=508198334196-bgmagrg0a2rub674g0shidj8fnd50dji.apps.googleusercontent.com&amp;origin=https%3A%2F%2Fdisqus.com&amp;scope=profile%20email&amp;ss_domain=https%3A%2F%2Fdisqus.com&amp;include_granted_scopes=true
https://apis.google.com/_/scs/abc-static/_/js/k=gapi.lb.en.z9QjrzsHcOc.O/m=auth2/rt=j/sv=1/d=1/ed=1/rs=AHpOoo8359JQqZQ0dzCVJ5Ui3CZcERHEWA/cb=gapi.loaded_0?le=scs
https://apis.google.com/js/api.js
https://c.disquscdn.com/get?url=https%3A%2F%2Fgrishaev.me%2Fassets%2Fstatic%2Faws%2Fbw%2Fui.png&amp;key=5su7aFyKRIY_tqfWlxdSzw&amp;h=200
https://c.disquscdn.com/get?url=https%3A%2F%2Fgrishaev.me%2Fassets%2Fstatic%2Faws%2Fmail%2F2.png&amp;key=P-FCJdQOuptvsG613K8vJA&amp;h=200
https://c.disquscdn.com/get?url=https%3A%2F%2Fs3.amazonaws.com%2Figrishaev.public%2Fexcel%2Fgood.jpg&amp;key=8OltNCXozdgFxMHmgBTDtQ&amp;h=200
https://c.disquscdn.com/get?url=https%3A%2F%2Fs3.amazonaws.com%2Figrishaev.public%2Ftele%2Fscan.jpg&amp;key=3S4NMvR9Sa2dqAik9FSSBw&amp;h=200
https://c.disquscdn.com/get?url=https%3A%2F%2Fs3.amazonaws.com%2Figrishaev.public%2Fvlc%2Feat.png&amp;key=_fOEu4w6cw03wCawGGrA_Q&amp;h=200
https://c.disquscdn.com/next/current/embed/lang/ru.js
https://c.disquscdn.com/next/current/publisher-admin/assets/img/emoji/funny-512x512.png
https://c.disquscdn.com/next/current/publisher-admin/assets/img/emoji/sad-512x512.png
https://c.disquscdn.com/next/current/publisher-admin/assets/img/emoji/upvote-512x512.png
https://c.disquscdn.com/next/current/recommendations/lang/ru.js
https://c.disquscdn.com/next/embed/alfie_v4.63f1ab6d6b9d5807dc0c94ef3fe0b851.js
https://c.disquscdn.com/next/embed/assets/font/icons.4cc7a703d2fdfe684151ff8ac24d45f1.woff2
https://c.disquscdn.com/next/embed/assets/img/disqus-social-icon-dark.a621bea3e02c9fa04fd3965a3d6f424d.svg
https://c.disquscdn.com/next/embed/assets/img/loader.ba7c86e8b4b6135bb668d05223f8f127.gif
https://c.disquscdn.com/next/embed/assets/img/sprite.ad630a07080a45451f139a7487853ff8.png
https://c.disquscdn.com/next/embed/assets/img/svg-sprite.4da5413f5086c5755b46094b813dbfcd.svg
https://c.disquscdn.com/next/embed/common.bundle.33bc87b2c4f9324203cc85b7dd1d0492.js
https://c.disquscdn.com/next/embed/common.bundle.33bc87b2c4f9324203cc85b7dd1d0492.js
https://c.disquscdn.com/next/embed/lounge.bundle.8d28276e15f31af0eebfd934278922d1.js
https://c.disquscdn.com/next/embed/lounge.bundle.8d28276e15f31af0eebfd934278922d1.js
https://c.disquscdn.com/next/embed/lounge.load.0837a7fb2afa86b68e4ee5098ec9905b.js
https://c.disquscdn.com/next/embed/styles/lounge.4ceaf0673822a0def820ebdc38d84415.css
https://c.disquscdn.com/next/embed/styles/lounge.4ceaf0673822a0def820ebdc38d84415.css
https://c.disquscdn.com/next/recommendations/assets/img/img-placeholder.df52e7638153b73862008d3d0556fdda.png
https://c.disquscdn.com/next/recommendations/common.bundle.a59fbd11efae764ccd959d61e4925fee.js
https://c.disquscdn.com/next/recommendations/common.bundle.a59fbd11efae764ccd959d61e4925fee.js
https://c.disquscdn.com/next/recommendations/recommendations.bundle.926bc472e4859a48daa346b4ba2ab4f4.js
https://c.disquscdn.com/next/recommendations/recommendations.bundle.926bc472e4859a48daa346b4ba2ab4f4.js
https://c.disquscdn.com/next/recommendations/recommendations.load.9d352c9674ae8172f8669d3aa3a905e9.js
https://c.disquscdn.com/next/recommendations/styles/recommendations.10022a97346f1c6e3798931bbd8e4bb5.css
https://c.disquscdn.com/next/recommendations/styles/recommendations.10022a97346f1c6e3798931bbd8e4bb5.css
https://cdn.viglink.com/images/pixel.gif?ch=1&amp;rn=8.95348561821992
https://cdn.viglink.com/images/pixel.gif?ch=2&amp;rn=8.95348561821992
https://connect.facebook.net/en_US/sdk.js
https://disqus.com/api/3.0/discovery/listRecommendations.json?forum=igrishaev&amp;thread=url%3Ahttps%3A%2F%2Fgrishaev.me%2Fen%2Fzippo%2F&amp;limit=8&amp;api_key=E8Uh5l5fHZ6gD8U3KycjAIAk46f68Zw7C6eW8WSjZvCLXebZ7p0r1yrYDrLilk2F
https://disqus.com/api/3.0/forums/details?forum=igrishaev&amp;attach=forumFeatures&amp;api_key=E8Uh5l5fHZ6gD8U3KycjAIAk46f68Zw7C6eW8WSjZvCLXebZ7p0r1yrYDrLilk2F
https://disqus.com/api/3.0/forums/details?forum=igrishaev&amp;attach=forumFeatures&amp;api_key=E8Uh5l5fHZ6gD8U3KycjAIAk46f68Zw7C6eW8WSjZvCLXebZ7p0r1yrYDrLilk2F
https://disqus.com/api/3.0/threadReactions/loadReactions?thread=9335567925&amp;api_key=E8Uh5l5fHZ6gD8U3KycjAIAk46f68Zw7C6eW8WSjZvCLXebZ7p0r1yrYDrLilk2F
https://disqus.com/embed/comments/?base=default&amp;f=igrishaev&amp;t_u=https%3A%2F%2Fgrishaev.me%2Fen%2Fzippo%2F&amp;t_d=Zippo%3A%20additions%20to%20the%20standard%20clojure.zip%20package.&amp;t_t=Zippo%3A%20additions%20to%20the%20standard%20clojure.zip%20package.&amp;s_o=default
https://disqus.com/next/config.js
https://disqus.com/next/config.js
https://disqus.com/next/config.js
https://disqus.com/recommendations/?base=default&amp;f=igrishaev&amp;t_u=https%3A%2F%2Fgrishaev.me%2Fen%2Fzippo%2F&amp;t_d=Zippo%3A%20additions%20to%20the%20standard%20clojure.zip%20package.&amp;t_t=Zippo%3A%20additions%20to%20the%20standard%20clojure.zip%20package.
https://fonts.googleapis.com/css?family=PT+Serif:400,400i,700,700i&amp;display=swap&amp;subset=cyrillic,cyrillic-ext,latin-ext
https://fonts.gstatic.com/s/ptserif/v17/EJRSQgYoZZY2vCFuvAnt66qSVyvVp8NA.woff2
https://fonts.gstatic.com/s/ptserif/v17/EJRVQgYoZZY2vCFuvAFSzr-_dSb_nco.woff2
https://fonts.gstatic.com/s/ptserif/v17/EJRVQgYoZZY2vCFuvAFWzr-_dSb_.woff2
https://glitter.services.disqus.com/urls/?callback=dsqGlitterResponseHandler&amp;forum_shortname=igrishaev&amp;thread_id=9335567925&amp;referer=https%3A%2F%2Fgrishaev.me%2F
https://igrishaev.disqus.com/embed.js
https://igrishaev.disqus.com/recommendations.js
https://io.narrative.io/?companyId=19&amp;id=disqus_id%3Ac6g0c4dk2irns7l&amp;ret=img&amp;ref=https%3A%2F%2Fgrishaev.me%2Fen%2Fzippo%2F
https://links.services.disqus.com/api/ping
https://live.rezync.com/pixel.html?c=4656c20ee35215f78e9273796625d90b&amp;cid=c6g0c4dk2irns7l&amp;pctry=RU&amp;referrer=https%3A%2F%2Fgrishaev.me%2Fen%2Fzippo%2F
https://mc.yandex.ru/metrika/tag.js
https://pippio.com/api/sync?pid=1391&amp;ref=https%3A%2F%2Fgrishaev.me%2Fen%2Fzippo%2F&amp;it=1&amp;iv=c6g0c4dk2irns7l
https://referrer.disqus.com/juggler/event.gif?abe=1&amp;embed_hidden=0&amp;load_time=1311&amp;event=init_embed&amp;thread=9335567925&amp;forum=igrishaev&amp;forum_id=3964395&amp;imp=2l7278t3kf6iha&amp;prev_imp&amp;thread_slug=zippo_additions_to_the_standard_clojurezip_package&amp;user_type=anon&amp;referrer=https%3A%2F%2Fgrishaev.me%2F&amp;theme=next&amp;dnt=0&amp;tracking_enabled=1&amp;experiment=network_default&amp;variant=fallthrough&amp;service=dynamic&amp;promoted_enabled=true&amp;max_enabled=true
https://referrer.disqus.com/juggler/event.js?experiment=network_default&amp;variant=fallthrough&amp;page_referrer=https%3A%2F%2Fgrishaev.me%2F&amp;product=embed&amp;thread=9335567925&amp;thread_id=9335567925&amp;forum=igrishaev&amp;forum_id=3964395&amp;zone=thread&amp;page_url=https%3A%2F%2Fgrishaev.me%2Fen%2Fzippo%2F&amp;service=dynamic&amp;verb=view&amp;object_type=product&amp;object_id=embed&amp;extra_data=%7B%22color_scheme%22%3A%22light%22%2C%22anchor_color%22%3A%22rgb(42%2C122%2C226)%22%2C%22typeface%22%3A%22serif%22%2C%22width%22%3A740%7D&amp;event=activity&amp;imp=2l7278t3kf6iha&amp;prev_imp=&amp;section=default&amp;area=n%2Fa
https://referrer.disqus.com/juggler/stat.gif?event=lounge.loading.view
https://www.google-analytics.com/analytics.js
https://www.gstatic.com/_/mss/boq-identity/_/js/k=boq-identity.IdpIFrameHttp.en_US.z2a12LkW96g.es5.O/d=1/rs=AOaEmlHeSnuHrM44y1tAD9SSj44ODEuRFQ/m=base
https://yastatic.net/es5-shims/0.0.2/es5-shims.min.js
https://yastatic.net/share2/share.js
</code></pre></div></div>

<p>Да, Карл: шестьдесят девять запросов на всякие аналитики, кнопки шаринга и комментарии Disqus. Не знаю, почему некоторые урлы повторяются, выяснять это нет никакого желания. Важное уточнение: 69 – это только в начале. Если промотать страницу и написать комментарий, подгрузится еще пачка скриптов.</p>

<p>С Disqus вообще беда: с недавних пор они внедрили рекламу. Блокировщики справляются, но как-то раз я зашел на сайт из голого Сафари и о…уел от того, что творит Disqus на странице:</p>

<p><img src="/assets/static/aws/de-js/2.jpg" /></p>

<p><img src="/assets/static/aws/de-js/3.jpg" /></p>

<p>На мобиле еще хуже: баннеры выстраиваются вертикально, и нужно мотать два экрана.</p>

<p>Кое-что из этого можно отключить в настройках, но в целом от рекламы нельзя избавиться, не заплатив. Да и не в рекламе дело, а в адском количестве скриптов. Сомневаюсь, что купив подписку, можно убавить их число.</p>

<p><img src="/assets/static/aws/de-js/4.png" /></p>

<p>Ясно одно: это не правильно, нужно исправлять.</p>

<p>Социальные кнопки и гугло-аналитику банально удалю. За кнопки мне стыдно, потому что это рудимент нулевых. Сегодня они встречаются разве что на сайтах, сделанных в говно-CMS вроде Джумлы, Друпала и Вордпресса. Аналитика была б хороша, если б Гугл не плевал на все этические нормы. Выбирая между желанием посмотреть, кто и что читает и приватностью читателей, я предпочту второе.</p>

<p>Самое интересное с комментариями. Не сказать, что мои заметки активно комментируют, но время от времени это случается. Особо приятно получить комментарий от бывших коллег, с которыми когда-то работал. Несколько раз в комментариях писали ценные вещи, и я был искренне благодарен.</p>

<p>У меня возникла идея перенести комментарии Disqus в блог. Технически это возможно: в админке Disqus выгружаем все комментарии, получаем жирный XML-файл (про JSON ребята не слышали). Далее пишем скрипт, который обходит XML и дописывает в файлы с постами. Однажды я уже делал так, <a href="/new-blog/">когда мигрировал</a> с Эгеи (движка на PHP), только вместо XML был дамп MySQL.</p>

<p>Остался последний вопрос: как сделать прием комментариев без Disqus? У меня есть одна мысль, но я опишу ее в другой раз, а пока что послушаю ваши советы.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/clj-repl-part-3/">REPL, Cider, Emacs (часть 3/4)</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2022-09-05T00:00:00+00:00">
        Sep 5, 2022
    </time>

    <a href="/tag/clojure/" rel="tag">clojure</a>, <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/repl/" rel="tag">repl</a>, <a href="/tag/emacs/" rel="tag">emacs</a>, <a href="/tag/cider/" rel="tag">cider</a>

</div>


            <div class="entry">
                
                    
<h2>Все части</h2>

<ul>
  <li><a href="/clj-repl-part-1/">Первая часть</a></li>
  <li><a href="/clj-repl-part-2/">Вторая часть</a></li>
  <li><a href="/clj-repl-part-3/">Третья часть</a></li>
  <li><a href="/clj-repl-part-4/">Четвертая часть</a></li>
</ul>

<h2>

    Оглавление

</h2>

<ul id="toc-item-clojure-repl-toc">
  <li><a href="#пространства-имен" id="toc-item-clojure-repl-toc-пространства-имен">Пространства имен</a></li>
  <li><a href="#переход-к-определению" id="toc-item-clojure-repl-toc-переход-к-определению">Переход к определению</a>    <ul>
      <li><a href="#xref" id="toc-item-clojure-repl-toc-xref">Xref</a></li>
      <li><a href="#imenu" id="toc-item-clojure-repl-toc-imenu">Imenu</a></li>
    </ul>
  </li>
  <li><a href="#тесты-в-cider" id="toc-item-clojure-repl-toc-тесты-в-cider">Тесты в Cider</a></li>
  <li><a href="#отладка-сообщений-nrepl" id="toc-item-clojure-repl-toc-отладка-сообщений-nrepl">Отладка сообщений nREPL</a></li>
  <li><a href="#отладка-кода" id="toc-item-clojure-repl-toc-отладка-кода">Отладка кода</a>    <ul>
      <li><a href="#наивные-способы" id="toc-item-clojure-repl-toc-наивные-способы">Наивные способы</a></li>
      <li><a href="#внедрение-в-чужой-код" id="toc-item-clojure-repl-toc-внедрение-в-чужой-код">Внедрение в чужой код</a></li>
      <li><a href="#подготовка-к-отладке" id="toc-item-clojure-repl-toc-подготовка-к-отладке">Подготовка к отладке</a></li>
      <li><a href="#продвинутый-eval" id="toc-item-clojure-repl-toc-продвинутый-eval">Продвинутый eval</a></li>
      <li><a href="#отладчик-своими-руками" id="toc-item-clojure-repl-toc-отладчик-своими-руками">Отладчик своими руками</a></li>
      <li><a href="#множественная-отладка-теория" id="toc-item-clojure-repl-toc-множественная-отладка-теория">Множественная отладка (теория)</a></li>
      <li><a href="#отладочный-тег" id="toc-item-clojure-repl-toc-отладочный-тег">Отладочный тег</a></li>
    </ul>
  </li>
</ul>

<h2 id="пространства-имен">Пространства имен</h2>

<p>При работе с REPL мы всегда находимся в каком-то пространстве. По умолчанию оно написано в приглашении:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">user=&gt;</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>Если перейти в другое пространство, изменится и приглашение:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">user=&gt;</span><span class="w"> </span><span class="p">(</span><span class="nb">in-ns</span><span class="w"> </span><span class="ss">'foobar</span><span class="p">)</span><span class="w">
</span><span class="n">foobar=&gt;</span><span class="w">
</span></code></pre></div></div>

<p>Код, что мы вводим в REPL, вычисляется в текущем пространстве. Если объявить в модуле <code class="language-plaintext highlighter-rouge">user</code> переменную:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nb">in-ns</span><span class="w"> </span><span class="ss">'user</span><span class="p">)</span><span class="w">
</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">number</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>, а затем сослаться на нее в пространстве <code class="language-plaintext highlighter-rouge">foobar</code>, получим ошибку, что символ <code class="language-plaintext highlighter-rouge">number</code> не найден в текущем контексте:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nb">in-ns</span><span class="w"> </span><span class="ss">'foobar</span><span class="p">)</span><span class="w">
</span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">number</span><span class="p">)</span><span class="w">

</span><span class="n">Syntax</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">compiling</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="p">(</span><span class="nf">repl-chapter</span><span class="no">:localhost:53495</span><span class="p">(</span><span class="nf">clj</span><span class="p">)</span><span class="nb">*</span><span class="no">:1:8440</span><span class="p">)</span><span class="nb">.</span><span class="w">
</span><span class="n">Unable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="nb">resolve</span><span class="w"> </span><span class="nb">symbol</span><span class="err">:</span><span class="w"> </span><span class="n">number</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">context</span><span class="w">
</span></code></pre></div></div>

<p>Другой пример: объявим в модулях <code class="language-plaintext highlighter-rouge">user</code> и <code class="language-plaintext highlighter-rouge">foobar</code> переменные <code class="language-plaintext highlighter-rouge">number</code> со значениями 1 и 2. Теперь одна и та же форма <code class="language-plaintext highlighter-rouge">(inc number)</code> даст разный результат в зависимости от того, какое пространство текущее. Поэтому перед вычислением мы должны убедиться, что находимся в нужном пространстве имен.</p>

<p>Чтобы уберечь нас от подобных ошибок, nREPL учитывает параметр <code class="language-plaintext highlighter-rouge">ns</code> в сообщениях. Когда мы выполняем код при помощи <code class="language-plaintext highlighter-rouge">cider-eval-...</code>, в сообщении, помимо полей <code class="language-plaintext highlighter-rouge">op</code> и <code class="language-plaintext highlighter-rouge">code</code>, передается <code class="language-plaintext highlighter-rouge">ns</code>. Его значение Cider находит из формы <code class="language-plaintext highlighter-rouge">(ns...)</code> в начале файла. Вычисляя форму, сервер временно меняет пространство, и результат совпадает с тем, что ожидают.</p>


                    <p><a href="/clj-repl-part-3/">Read more &rarr;</a></p>
                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/en/zippo/">Zippo: additions to the standard clojure.zip package.</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2022-09-02T00:00:00+00:00">
        Sep 2, 2022
    </time>

    <a href="/tag/clojure/" rel="tag">clojure</a>, <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/zippers/" rel="tag">zippers</a>

</div>


            <div class="entry">
                
                    
<p>The <code class="language-plaintext highlighter-rouge">clojure.zip</code> package is a masterpiece yet misses some utility
functions. For example, finding locations, bulk updates, lookups, breadth-first
traversing and so on. <a href="https://github.com/igrishaev/zippo">Zippo</a>, the library I’m introducing in this post,
brings some bits of missing functionality.</p>

<h3 id="installation">Installation</h3>

<p>Lein:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="n">com.github.igrishaev/zippo</span><span class="w"> </span><span class="s">"0.1.0"</span><span class="p">]</span><span class="w">
</span></code></pre></div></div>

<p>Deps.edn</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="n">com.github.igrishaev/zippo</span><span class="w"> </span><span class="p">{</span><span class="no">:mvn/version</span><span class="w"> </span><span class="s">"0.1.0"</span><span class="p">}}</span><span class="w">
</span></code></pre></div></div>

<h3 id="usage--examples">Usage &amp; examples</h3>

<p>First, import both Zippo and <code class="language-plaintext highlighter-rouge">clojure.zip</code>:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">ns</span><span class="w"> </span><span class="n">zippo.core-test</span><span class="w">
  </span><span class="p">(</span><span class="no">:require</span><span class="w">
   </span><span class="p">[</span><span class="n">clojure.zip</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">zip</span><span class="p">]</span><span class="w">
   </span><span class="p">[</span><span class="n">zippo.core</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">zippo</span><span class="p">]))</span><span class="w">
</span></code></pre></div></div>

<p>Declare a zipper:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">z</span><span class="w">
  </span><span class="p">(</span><span class="nf">zip/vector-zip</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="p">[</span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="p">[[</span><span class="mi">4</span><span class="p">]]]))</span><span class="w">
</span></code></pre></div></div>

<p>Now check out the following Zippo functions.</p>

<h4 id="a-finite-seq-of-locations">A finite seq of locations</h4>

<p>The <code class="language-plaintext highlighter-rouge">loc-seq</code> funtion takes a location and returns a lazy seq of locations
untill it reaches the end:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">locs</span><span class="w"> </span><span class="p">(</span><span class="nf">zippo/loc-seq</span><span class="w"> </span><span class="n">z</span><span class="p">)]</span><span class="w">
  </span><span class="p">(</span><span class="nf">mapv</span><span class="w"> </span><span class="n">zip/node</span><span class="w"> </span><span class="n">locs</span><span class="p">))</span><span class="w">

</span><span class="c1">;; get a vector of notes to reduce the output</span><span class="w">
</span><span class="p">[[</span><span class="mi">1</span><span class="w"> </span><span class="p">[</span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="p">[[</span><span class="mi">4</span><span class="p">]]]</span><span class="w">
 </span><span class="mi">1</span><span class="w">
 </span><span class="p">[</span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="p">]</span><span class="w">
 </span><span class="mi">2</span><span class="w">
 </span><span class="mi">3</span><span class="w">
 </span><span class="p">[[</span><span class="mi">4</span><span class="p">]]</span><span class="w">
 </span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w">
 </span><span class="mi">4</span><span class="p">]</span><span class="w">
</span></code></pre></div></div>

<p>This is quite useful to traverse a zipper without keeping in mind the ending
condition (<code class="language-plaintext highlighter-rouge">zip/end?</code>).</p>

<h4 id="finding-locations">Finding locations</h4>

<p>The <code class="language-plaintext highlighter-rouge">loc-find</code> function looks for the first location that matches a predicate:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">loc</span><span class="w"> </span><span class="p">(</span><span class="nf">zippo/loc-find</span><span class="w">
           </span><span class="n">z</span><span class="w">
           </span><span class="p">(</span><span class="k">fn</span><span class="w"> </span><span class="p">[</span><span class="n">loc</span><span class="p">]</span><span class="w">
             </span><span class="p">(</span><span class="nb">-&gt;</span><span class="w"> </span><span class="n">loc</span><span class="w"> </span><span class="n">zip/node</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="mi">3</span><span class="p">))))]</span><span class="w">

  </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="p">(</span><span class="nf">zip/node</span><span class="w"> </span><span class="n">loc</span><span class="p">))))</span><span class="w">
</span></code></pre></div></div>

<p>Above, we found a location which node equals 3.</p>

<p>The <code class="language-plaintext highlighter-rouge">loc-find-all</code> function finds all the locatins that match the predicate:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">locs</span><span class="w"> </span><span class="p">(</span><span class="nf">zippo/loc-find-all</span><span class="w">
            </span><span class="n">z</span><span class="w">
            </span><span class="p">(</span><span class="nf">zippo/-&gt;loc-pred</span><span class="w"> </span><span class="p">(</span><span class="nf">every-pred</span><span class="w"> </span><span class="n">int?</span><span class="w"> </span><span class="n">even?</span><span class="p">)))]</span><span class="w">

  </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">[</span><span class="mi">2</span><span class="w"> </span><span class="mi">4</span><span class="p">]</span><span class="w">
         </span><span class="p">(</span><span class="nf">mapv</span><span class="w"> </span><span class="n">zip/node</span><span class="w"> </span><span class="n">locs</span><span class="p">))))</span><span class="w">
</span></code></pre></div></div>

<p>Since the predicate accepts a location, you can check its children, siblings and
so on. For example, check if a location belongs to a special kind of parent.</p>

<p>However, most of the time you’re interested in a value (node) rather than a
location. The <code class="language-plaintext highlighter-rouge">-&gt;loc-pred</code> function converts a node predicate, which accepts a
node, into a location predicate. In the example above, the line</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">zippo/-&gt;loc-pred</span><span class="w"> </span><span class="p">(</span><span class="nf">every-pred</span><span class="w"> </span><span class="n">int?</span><span class="w"> </span><span class="n">even?</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<p>makes a location predicate which node is an even integer.</p>

<h4 id="updating-a-zipper">Updating a zipper</h4>

<p>Zippo offers some functions to update a zipper.</p>

<p>The <code class="language-plaintext highlighter-rouge">loc-update</code> one takes a location predicate, an update function and the rest
arguments. Here is how you douple all the even numbers in a nested vector:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">loc</span><span class="w">
      </span><span class="p">(</span><span class="nf">zippo/loc-update</span><span class="w">
       </span><span class="n">z</span><span class="w">
       </span><span class="p">(</span><span class="nf">zippo/-&gt;loc-pred</span><span class="w"> </span><span class="p">(</span><span class="nf">every-pred</span><span class="w"> </span><span class="n">int?</span><span class="w"> </span><span class="n">even?</span><span class="p">))</span><span class="w">
       </span><span class="n">zip/edit</span><span class="w"> </span><span class="nb">*</span><span class="w"> </span><span class="mi">2</span><span class="p">)]</span><span class="w">

  </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="p">[</span><span class="mi">4</span><span class="w"> </span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="p">[[</span><span class="mi">8</span><span class="p">]]]</span><span class="w">
         </span><span class="p">(</span><span class="nf">zip/root</span><span class="w"> </span><span class="n">loc</span><span class="p">))))</span><span class="w">
</span></code></pre></div></div>

<p>For the updating function, one may use <code class="language-plaintext highlighter-rouge">zip/append-child</code> to append a child,
<code class="language-plaintext highlighter-rouge">zip/remove</code> to drop the entire location and so on:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">loc</span><span class="w">
      </span><span class="p">(</span><span class="nf">zippo/loc-update</span><span class="w">
       </span><span class="n">z</span><span class="w">
       </span><span class="p">(</span><span class="k">fn</span><span class="w"> </span><span class="p">[</span><span class="n">loc</span><span class="p">]</span><span class="w">
         </span><span class="p">(</span><span class="nb">-&gt;</span><span class="w"> </span><span class="n">loc</span><span class="w"> </span><span class="n">zip/node</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">[</span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="p">])))</span><span class="w">
       </span><span class="n">zip/append-child</span><span class="w">
       </span><span class="no">:A</span><span class="p">)]</span><span class="w">

  </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="p">[</span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="no">:A</span><span class="p">]</span><span class="w"> </span><span class="p">[[</span><span class="mi">4</span><span class="p">]]]</span><span class="w">
         </span><span class="p">(</span><span class="nf">zip/root</span><span class="w"> </span><span class="n">loc</span><span class="p">))))</span><span class="w">
</span></code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">node-update</code> function is similar but acts on nodes. Instead of <code class="language-plaintext highlighter-rouge">loc-pred</code>
and <code class="language-plaintext highlighter-rouge">loc-fn</code>, it accepts <code class="language-plaintext highlighter-rouge">node-pred</code> and <code class="language-plaintext highlighter-rouge">node-fn</code> what operate on nodes.</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">loc</span><span class="w">
    </span><span class="p">(</span><span class="nf">zippo/node-update</span><span class="w">
     </span><span class="n">z</span><span class="w">
     </span><span class="n">int?</span><span class="w">
     </span><span class="nb">inc</span><span class="p">)]</span><span class="w">
</span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">[</span><span class="mi">2</span><span class="w"> </span><span class="p">[</span><span class="mi">3</span><span class="w"> </span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="p">[[</span><span class="mi">5</span><span class="p">]]]</span><span class="w">
       </span><span class="p">(</span><span class="nf">zip/root</span><span class="w"> </span><span class="n">loc</span><span class="p">))))</span><span class="w">
</span></code></pre></div></div>

<h4 id="slicing-a-zipper-by-layers">Slicing a zipper by layers</h4>

<p>Sometimes, you need to slice a zipper on layers. This is what is better seen on
a chart:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>     +---ROOT---+    ;; layer 1
     |          |
   +-A-+      +-B-+  ;; layer 2
   | | |      | | |
   X Y Z      J H K  ;; layer 3
</code></pre></div></div>

<ul>
  <li>Layer 1 is <code class="language-plaintext highlighter-rouge">[Root]</code>;</li>
  <li>Layer 1 is <code class="language-plaintext highlighter-rouge">[A B]</code>;</li>
  <li>Layer 3 is <code class="language-plaintext highlighter-rouge">[X Y Z J H K]</code></li>
</ul>

<p>The <code class="language-plaintext highlighter-rouge">loc-layers</code> function takes a location and builds a lazy seq of layers. The
first layer is the given location, then its children, the children of children
and so on.</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">layers</span><span class="w">
      </span><span class="p">(</span><span class="nf">zippo/loc-layers</span><span class="w"> </span><span class="n">z</span><span class="p">)]</span><span class="w">

  </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="o">'</span><span class="p">(([</span><span class="mi">1</span><span class="w"> </span><span class="p">[</span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="p">[[</span><span class="mi">4</span><span class="p">]]])</span><span class="w">
           </span><span class="p">(</span><span class="nf">1</span><span class="w"> </span><span class="p">[</span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="p">[[</span><span class="mi">4</span><span class="p">]])</span><span class="w">
           </span><span class="p">(</span><span class="nf">2</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="p">[</span><span class="mi">4</span><span class="p">])</span><span class="w">
           </span><span class="p">(</span><span class="nf">4</span><span class="p">))</span><span class="w">
         </span><span class="p">(</span><span class="k">for</span><span class="w"> </span><span class="p">[</span><span class="n">layer</span><span class="w"> </span><span class="n">layers</span><span class="p">]</span><span class="w">
           </span><span class="p">(</span><span class="k">for</span><span class="w"> </span><span class="p">[</span><span class="n">loc</span><span class="w"> </span><span class="n">layer</span><span class="p">]</span><span class="w">
             </span><span class="p">(</span><span class="nf">zip/node</span><span class="w"> </span><span class="n">loc</span><span class="p">))))))</span><span class="w">
</span></code></pre></div></div>

<h4 id="breadth-first-seq-of-locations">Breadth-first seq of locations</h4>

<p>The <code class="language-plaintext highlighter-rouge">clojure.zip</code> package uses <a href="https://en.wikipedia.org/wiki/Depth-first_search">depth-first method</a> of traversing a
tree. Let’s number the items:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>       +-----ROOT[1]----+
       |                |
 +----A[2]---+     +---B[6]--+
 |     |     |     |    |    |
 X[3] Y[4] Z[5]   J[7] H[8] K[9]
</code></pre></div></div>

<p>This sometimes may end up with an infinity loop when you generate children
on the fly.</p>

<p>The <code class="language-plaintext highlighter-rouge">loc-seq-breadth</code> functions offers the opposite way of traversing a zipper:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>       +-----ROOT[1]----+
       |                |
 +----A[2]---+     +---B[3]--+
 |     |     |     |    |    |
 X[4] Y[5] Z[6]   J[7] H[8] K[9]
</code></pre></div></div>

<p>This is useful to solve some special tasks related to zippers.</p>

<h4 id="lookups">Lookups</h4>

<p>When working with zippers, you often need such functionality as “go
up/left/right until meet something”. For example, from a given location, go up
until a parent has a special attribute. Zippo offers four functions for that,
namely <code class="language-plaintext highlighter-rouge">lookup-up</code>, <code class="language-plaintext highlighter-rouge">lookup-left</code>, <code class="language-plaintext highlighter-rouge">lookup-right</code>, and <code class="language-plaintext highlighter-rouge">lookup-down.</code> All of
them take a location and a predicate:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">loc</span><span class="w">
      </span><span class="p">(</span><span class="nf">zip/vector-zip</span><span class="w"> </span><span class="p">[</span><span class="no">:a</span><span class="w"> </span><span class="p">[</span><span class="no">:b</span><span class="w"> </span><span class="p">[</span><span class="no">:c</span><span class="w"> </span><span class="p">[</span><span class="no">:d</span><span class="p">]]]</span><span class="w"> </span><span class="no">:e</span><span class="p">])</span><span class="w">

      </span><span class="n">loc-d</span><span class="w">
      </span><span class="p">(</span><span class="nf">zippo/loc-find</span><span class="w"> </span><span class="n">loc</span><span class="w">
                      </span><span class="p">(</span><span class="nf">zippo/-&gt;loc-pred</span><span class="w">
                       </span><span class="p">(</span><span class="k">fn</span><span class="w"> </span><span class="p">[</span><span class="nb">node</span><span class="p">]</span><span class="w">
                         </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="nb">node</span><span class="w"> </span><span class="no">:d</span><span class="p">))))</span><span class="w">

      </span><span class="n">loc-b</span><span class="w">
      </span><span class="p">(</span><span class="nf">zippo/lookup-up</span><span class="w"> </span><span class="n">loc-d</span><span class="w">
                       </span><span class="p">(</span><span class="nf">zippo/-&gt;loc-pred</span><span class="w">
                        </span><span class="p">(</span><span class="k">fn</span><span class="w"> </span><span class="p">[</span><span class="nb">node</span><span class="p">]</span><span class="w">
                          </span><span class="p">(</span><span class="nb">and</span><span class="w"> </span><span class="p">(</span><span class="nb">vector?</span><span class="w"> </span><span class="nb">node</span><span class="p">)</span><span class="w">
                               </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="no">:b</span><span class="w"> </span><span class="p">(</span><span class="nb">first</span><span class="w"> </span><span class="nb">node</span><span class="p">))))))]</span><span class="w">

  </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="no">:d</span><span class="w"> </span><span class="p">(</span><span class="nf">zip/node</span><span class="w"> </span><span class="n">loc-d</span><span class="p">)))</span><span class="w">

  </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">[</span><span class="no">:b</span><span class="w"> </span><span class="p">[</span><span class="no">:c</span><span class="w"> </span><span class="p">[</span><span class="no">:d</span><span class="p">]]]</span><span class="w"> </span><span class="p">(</span><span class="nf">zip/node</span><span class="w"> </span><span class="n">loc-b</span><span class="p">))))</span><span class="w">
</span></code></pre></div></div>

<p>In the example above, first we find the <code class="language-plaintext highlighter-rouge">:d</code> location. From there, we go up
until we meet <code class="language-plaintext highlighter-rouge">[:b [:c [:d]]]</code>. If there is no such a location, the result will
be nil.</p>

<h3 id="also-see">Also See</h3>

<p>The code from this library was used for <a href="/en/clojure-zippers/">Clojure Zippers manual</a>
– the complete guide to zippers in Clojure from the very scratch.</p>

<p>© 2022 Ivan Grishaev</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/deformation/">Деформация</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2022-08-27T00:00:00+00:00">
        Aug 27, 2022
    </time>

    <a href="/tag/life/" rel="tag">life</a>, <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/telegram/" rel="tag">telegram</a>

</div>


            <div class="entry">
                
                    <p>Последний месяц я вожусь с ботами для Телеграма. Занятная вещь, и как-нибудь расскажу об этом подробней. А пока что мелкое наблюдение.</p>

<p>Чтобы отсечь спамеров, мой бот выводит задачу уровня <code class="language-plaintext highlighter-rouge">3 + 5</code> и кнопки с ответами. Кнопок шесть: одна правильная, остальные неправильные. Писать текст нельзя, только жать на кнопку. Если ответил верно, ограничения снимаются. После трех ошибок бан.</p>

<p>Код для генерации кнопок я писал впопыхах. Коротко, он такой: взять пять случайных чисел, добавить к ним ответ, перемешать. Но не учел, что в случайных числах может выпасть ответ, из-за чего будет две правильные кнопки. Это случается редко, но все же. Вот один из случаев:</p>

<p><img src="/assets/static/aws/2buttons/1.jpeg" /></p>

<p>Так вот, наблюдение: когда айтишник видит два правильных ответа, у него рвется шаблон. Начинаются фразочки OMG какой ответ правильный!! и прочая истерика. Тут у меня происходит двоемыслие.</p>

<p>С одной стороны, что значит “какой ответ правильный”? Если задача <code class="language-plaintext highlighter-rouge">3 + 5</code> и две кнопки 8, обе из них правильные. Не бывает двух разных цифр 8 — она одна. Поэтому вместо истерики надо жать ту кнопку, которая по душе — ближе, дальше, круглее, — главное, чтобы на ней была восьмерка.</p>

<p>С другой стороны, айтишников легко понять. Мы привыкли, что за текстом на кнопке стоит айдишник, который уходит на сервер, и все рассчитывается по айдишнику. Вполне возможно, у первой кнопки “8” айди <code class="language-plaintext highlighter-rouge">btn_4</code>, а у второй — <code class="language-plaintext highlighter-rouge">btn_9</code>. И не докажешь, что не верблюд.</p>

<p><img src="/assets/static/aws/2buttons/2.jpg" /></p>

<p>Помню, меня страшно бесили тесты по английскому на компе. Нужно было перетащить слова в прочерки, при этом глагол is часто встречался дважды. И хотя я все расставлял правильно, получал ошибку. Оказалось, у каждого слова свой айдишник, а в базе данных задана их последовательность. Имеем два is с номерами 2 и 5. Не так расставил — ошибка.</p>

<p>В итоге скрипт, написанный на коленке, разошелся по школам, сайтам, университетам. Где только я с ним не сталкивался! Даже недавно, во время ковидного дурдома, сын делал английский онлайн, и там была та же проблема.</p>

<p>Происходит деформация: даже если на двух кнопках написано одно и то же, мы не верим. Мы ищем подвох, потому что слишком часто были обмануты. В результате две кнопки 8 кажутся такой же ошибкой, как 3 + 5 = 9.</p>

<p>Сюда же следует отнести штучки JavaScript вроде <code class="language-plaintext highlighter-rouge">[1, 2, 3] == [1, 2, 3]</code>. Только что проверил в консоли — вернет ложь. На JavaScript работают миллионы сайтов и устройств, а конца этому не видно. Весь этот бред так и тянется от стандарта к стандарту.</p>

<p>В результате разработчик настолько привык к граблям технологий, что всячески оправдывает их косяки и ищет злой умысел там, где его нет. Так быть не должно.</p>

<p>Подобно тому, как нужно не курить, не бухать и заниматься спортом, нужно работать с правильными технологиями. Такими, где массив <code class="language-plaintext highlighter-rouge">[1, 2, 3]</code> все-таки равен другому такому же массиву; где нет пяти функций сравнения; где код вернет то, что ожидаешь, а не то, что прописано на сотой странице стандарта. И деформации в голове станет меньше.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/clj-repl-part-2/">REPL, Cider, Emacs (часть 2/4)</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2022-08-20T00:00:00+00:00">
        Aug 20, 2022
    </time>

    <a href="/tag/clojure/" rel="tag">clojure</a>, <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/repl/" rel="tag">repl</a>, <a href="/tag/emacs/" rel="tag">emacs</a>, <a href="/tag/cider/" rel="tag">cider</a>

</div>


            <div class="entry">
                
                    
<h2>Все части</h2>

<ul>
  <li><a href="/clj-repl-part-1/">Первая часть</a></li>
  <li><a href="/clj-repl-part-2/">Вторая часть</a></li>
  <li><a href="/clj-repl-part-3/">Третья часть</a></li>
  <li><a href="/clj-repl-part-4/">Четвертая часть</a></li>
</ul>

<h2>

    Оглавление

</h2>

<ul id="toc-item-clojure-repl-toc">
  <li><a href="#repl-в-редакторе" id="toc-item-clojure-repl-toc-repl-в-редакторе">REPL в редакторе</a>    <ul>
      <li><a href="#недостатки" id="toc-item-clojure-repl-toc-недостатки">Недостатки</a></li>
    </ul>
  </li>
  <li><a href="#знакомство-с-nrepl" id="toc-item-clojure-repl-toc-знакомство-с-nrepl">Знакомство с nREPL</a>    <ul>
      <li><a href="#запуск-nrepl" id="toc-item-clojure-repl-toc-запуск-nrepl">Запуск nREPL</a></li>
      <li><a href="#внутреннее-устройство" id="toc-item-clojure-repl-toc-внутреннее-устройство">Внутреннее устройство</a></li>
      <li><a href="#транспорт" id="toc-item-clojure-repl-toc-транспорт">Транспорт</a></li>
      <li><a href="#middleware" id="toc-item-clojure-repl-toc-middleware">Middleware</a></li>
    </ul>
  </li>
  <li><a href="#подключение-из-clojure" id="toc-item-clojure-repl-toc-подключение-из-clojure">Подключение из Clojure</a>    <ul>
      <li><a href="#коротко-о-bencode" id="toc-item-clojure-repl-toc-коротко-о-bencode">Коротко о Bencode</a></li>
    </ul>
  </li>
  <li><a href="#клиенты-nrepl-для-редакторов" id="toc-item-clojure-repl-toc-клиенты-nrepl-для-редакторов">Клиенты nREPL для редакторов</a></li>
  <li><a href="#emacs-и-cider" id="toc-item-clojure-repl-toc-emacs-и-cider">Emacs и Cider</a>    <ul>
      <li><a href="#первые-шаги" id="toc-item-clojure-repl-toc-первые-шаги">Первые шаги</a></li>
      <li><a href="#выполнение-кода" id="toc-item-clojure-repl-toc-выполнение-кода">Выполнение кода</a></li>
      <li><a href="#dev-секции" id="toc-item-clojure-repl-toc-dev-секции">Dev-секции</a></li>
      <li><a href="#сниппеты" id="toc-item-clojure-repl-toc-сниппеты">Сниппеты</a></li>
    </ul>
  </li>
</ul>

<h2 id="repl-в-редакторе">REPL в редакторе</h2>

<p>До сих пор мы набирали код в терминале, что не совсем удобно. Терминал подходит для коротких команд, но плохо справляется с многострочным вводом. Будет правильно набрать код в редакторе, а затем скопировать в терминал. Код останется в файле, и не придется печатать его в следующий раз.</p>

<p>Со временем вы заметите, что переключение между редактором и терминалом отнимает время. Было бы здорово связать редактор с REPL напрямую. Вы набираете код и с помощью комбинации клавиш выполняете в REPL. В отдельной области редактор показывает результат. С таким подходом нам доступна мощь обеих сред: REPL и редактора.</p>


                    <p><a href="/clj-repl-part-2/">Read more &rarr;</a></p>
                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/web-files/">Веб-файлы</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2022-08-16T00:00:00+00:00">
        Aug 16, 2022
    </time>

    <a href="/tag/ui/" rel="tag">ui</a>, <a href="/tag/dropbox/" rel="tag">dropbox</a>

</div>


            <div class="entry">
                
                    <p>Каждый раз, когда вижу файловый интерфейс в вебе, думаю: почему такой пиздец? Я не люблю материться и делаю это редко. Но когда вижу браузерные поделки, хочется закрыть глаза от отчаяния.</p>

<p>Вот скриншоты с официального сайта Дропбокса. Первая картинка:</p>

<p><img src="/assets/static/aws/web-files/1.jpg" /></p>

<p>Что мы видим? Всюду адская разреженность. Изображение с отступами, сверху и справа два жирных бара. Иконки в барах мелкие и висят в воздухе. Дикая несогласованность элементов: сперва кнопка с надписью, кнопка с многоточием, заголовок, синяя кнопка со стрелкой вниз.</p>

<p>Что делает заголовок среди кнопок? Там не поместится ничего длиннее пары слов. Почему кнопка Share синяя, в чем ее особый статус? Почему выпадашка слева отмечена многоточием, а у Share стрелка вниз?</p>

<p>Зачем колокольчик в окне просмотра файла? Это события, связанные с этим файлом или любые события? Зачем сайдбар справа? Нельзя было уместить жалкие три кнопки наверху?</p>

<p>Другая картинка:</p>

<p><img src="/assets/static/aws/web-files/2.png" /></p>

<p>То же самое: адская разреженность. На месте трех файлов было легко уместить пятнадцать без потери смысла и качества.</p>

<p>Наверху значок лупы, но поля ввода нет. Полагаю, оно появится по клику на лупу. Зачем кликать, если можно сразу нарисовать поле?</p>

<p>Зачем земной шар? Открыть какую-то ссылку? Если да, то какую, и зачем мне туда переходить? Почему бы не разместить гиперссылку с текстом, например, “на сайт”?</p>

<p>Полоса с текстом “Syncing” срезает столько места, что хватило бы на пару файлов.</p>

<p>Третья картинка, но там уже нечего комментировать: сочетание косяков в разных пропорциях.</p>

<p><img src="/assets/static/aws/web-files/3.jpg" /></p>

<p>А вот картинка, открытая в Preview на маке:</p>

<p><img src="/assets/static/aws/web-files/4.jpg" /></p>

<ul>
  <li>заголовок отдельно от кнопок. Влезет даже предложение.</li>
  <li>изображение занимает максимальную площадь</li>
  <li>виджет поиска отрисован с полем ввода</li>
  <li>все иконки одинаковы и пригнаны друг к другу</li>
  <li>по желанию в тулбар можно загнать другие иконки и поменять их местами</li>
  <li>можно сменить показ иконок: только картинка, только текст или вместе.</li>
</ul>

<p>Дело даже не в маке: если взять Total Commander или виндовый Explorer, там то же самое: информация показана компактно и удобно. Могут быть придирки к конкретной программе: скажем, Explorer в режиме значков такой себе, но со списком можно жить. Это уже дело вкуса. Важно, что всем файловым менеджерам свойственна компактность и гибкость в настройках.</p>

<p><img src="/assets/static/aws/web-files/5.png" /></p>

<p>А с вебом беда. Мамкины дизайнеры каждый день видят нормальный интерфейс, но рисуют в Фигме говно. Хотя ничего придумывать не надо: повтори Finder или Explorer, и люди скажут спасибо. Но нет: дизайнер дизайнерит.</p>

<p>Беда не только у Дропбокса. Гугл, Слак и другие тяжеловесы не могут показать файлы в браузере. Каждый раз выходит ужас: растрата места, жирные бары, несогласованные кнопки — тут многоточие, там выпадашка. Иконки либо мелкие, либо гротескно жирные, словно в азбуке для малышей. Ни у одной иконки нет подписи, нужно наводить курсор или жать наудачу.</p>

<p>Невозможно. Считаю, в целях воспитания нужно отобрать у дизайнеров родной файловый менеджер и выдать то, что они производят. Тогда дело быстро пойдет на лад.</p>

                
            </div>

        </li>
        
    </ul>

    <h4>
        
        <a href="/page20" class="previous">&larr;</a>
        
        <span class="page_number ">Страница 21 из 78</span>
        
        <a href="/page22" class="next">&rarr;</a>
        
    </h4>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Ivan Grishaev's blog</li>
          <li><a href="mailto:ivan@grishaev.me">ivan@grishaev.me</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
            <li><a href="https://github.com/igrishaev">GitHub</a></li>
            <li><a href="tg://resolve?domain=igrishaev_blog">Telegram</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Writing on programming, education, books and negotiations.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
