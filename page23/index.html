<!DOCTYPE html>
<html lang="ru">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Ivan Grishaev's blog</title>
  <meta name="description" content="Writing on programming, education, books and negotiations.
">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/custom.css">
  <link rel="canonical" href="https://grishaev.me/page23/">
  <link rel="alternate" type="application/rss+xml" title="Ivan Grishaev's blog" href="https://grishaev.me/feed.xml">

  <link rel="shortcut icon" type="image/x-icon" href="/assets/static/favicons/favicon.ico">

  <script type="text/javascript" src="/assets/typo.js"></script>

</head>


  <body>
    <header class="site-header">

    <div class="wrapper flex-container">

        <div>
            <a href="/">
                <img src="/assets/static/photo-round-small.png" alt="Ivan Grishaev">
            </a>
        </div>

        <div class="flex-container-vert" style="margin-left: 15px; width: 80%">

            <div class="flex-container full-width">
                <p style="margin-bottom: 5px">Ivan Grishaev's blog</p>
                <div class="flex-huge"></div>
                <div >
<form id="search-form"
      target="_blank"
      style="display: inline"
      method="get"
      action="https://www.google.com/search">

    <input name="sitesearch"
           value="grishaev.me"
           type="hidden">

    <input type="text"
           required="required"
           name="q"
           placeholder="Google search..."
           autocomplete="off">

    <button style="border: none; background-color: transparent; cursor: pointer;"
            type="submit">&#x1f50d;</button>

</form>
</div>
            </div>

            <p><small>Writing on programming, education, books and negotiations.
</small></p>

            <div class="flex-container">
                <a class="menu-item" href="/">Home</a>
                <a class="menu-item" href="/about/">About</a>
                <a class="menu-item" href="/bookshelf/">Bookshelf</a>
                <a class="menu-item" href="/feed.xml">RSS</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor" href="/tag/clojure/">Clojure</a>
                <a class="menu-item minor" href="/tag/emacs/">Emacs</a>
                <a class="menu-item minor" href="/tag/python/">Python</a>
                <a class="menu-item minor" href="/tag/programming/">Programming</a>
                <a class="menu-item minor" href="/interview/">Interview</a>
                <a class="menu-item minor" href="/video/">Video</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor hl" href="/clojure-in-prod/">Книга «Clojure на производстве»</a>
            </div>

        </div>
    </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="home">

    <ul class="post-list">
        
        <li>

            <h2>
                <a class="post-link" href="/en/clj-stream/">First Clojure stream in English</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2017-12-18T00:00:00+00:00">
        Dec 18, 2017
    </time>

    <a href="/tag/clojure/" rel="tag">clojure</a>, <a href="/tag/stream/" rel="tag">stream</a>, <a href="/tag/etaoin/" rel="tag">etaoin</a>

</div>


            <div class="entry">
                
                    <p>Last Sunday, I tried to stream some Clojure coding commenting it in
English. Although I was nervous a bit and thus sounded weird, I think the result
worth publishing it here:</p>

<iframe width="640" height="360" src="https://www.youtube.com/embed/cLL_5rETLWY" gesture="media" allow="encrypted-media" allowfullscreen=""></iframe>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/timezone/">Разбираемся в часовыми поясами. Инструкция по безопасной работе со временем</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2017-12-13T00:00:00+00:00">
        Dec 13, 2017
    </time>

    <a href="/tag/time/" rel="tag">time</a>, <a href="/tag/backend/" rel="tag">backend</a>, <a href="/tag/frontend/" rel="tag">frontend</a>

</div>


            <div class="entry">
                
                    
<p>Во всех проектах, где мне приходилось работать (включая текущий), были
проблемы с <a href="https://ru.wikipedia.org/wiki/Часовой_пояс">часовыми поясами</a>. В этой статье я обобщу
полученный опыт о работе со временем. Разберемся раз и навсегда как
обращаться с ним правильно.</p>

<p>Зоны и их преобразования – достаточно тяжелая для изучения тема. Это
не проходят в институтах, об этом мало статей на популярных
ресурсах. Разработчики учатся работать со временем методом проб и
ошибок.</p>

<p>В одном из прошлых проектов в нашей команде не было никого, кто бы мог
внятно донести лучшие практики работы со временем. Коллективное
незнание было компенсировано харизмой и желанием писать много кода.</p>

<p>Мы воздвигли модуль полный костылей и багов, которые ловили в
проде. Провалы становились очевидны когда исправлять их было уже
затратно. Скорее всего, в вашем проекте дела обстоят так же.</p>

<p>Не устану повторять случай с коллегой, который работал в лондонском
стартапе. Лондон это такой город, от которого отсчитываются часовые
пояса, потому что через него проходит нулевой меридиан. Иначе говоря,
локальное и общемировое времена в Лондоне одинаковы (не считая
обозначения зоны, конечно).</p>

<p>Пока разработка шла в Лондоне, никто и не думал ни про какие зоны, и
код писали без их учета. Разработчик с зоной +3 столкнулся с тем, что
не проходит ни один тест, потому что время прибито гвоздями без учета
пояса. В итоге коллега проработал у них год сидя с переведенными
часами. Было проще поменять зону локально, чем исправить код.</p>

<p>Забавно, что бизнес той фирмы был связан с расписанием общественного
транспорта, где время имеет решающую роль. Это снова поднимает вопросы
о том, кто и как пишет повседневное ПО.</p>

<p>В нашем проекте фронтендер решил, что он умнее системы и что нужно
помочь клиенту перевести локальное время в UTC. И тем самым заложил в
систему трудноуловимый баг. При отправке объекта Date через Ajax
первый автоматически приводится к общемировому времени. Затем срабатывал
обработчик коллеги, который тоже корректировал пояс. Получается,
что мы дважды вычитали локальное время на клиенте и тем самым портили
любую дату с сервера.</p>

<p>Теперь представьте, что будет, если показать не то время на сайте
продажи авиабилетов. Или прислать смс-напоминание с ошибкой в
приведении часовых зон. Это будет стоить колоссальных денег и нервов.</p>

<p>Я заметил, что откровенно плохо обстоит со временем у
фронтендеров. Это связано с тем, что время – скорее серверная часть
приложения, и к тому же требует некоторой подготовки и мышления. Чаще
всего ошибки случались на стороне клиентской части.</p>

<p><strong>Главное правило:</strong> никогда не пишите свой код для операций над
временными зонами. Все современные библиотеки уже имеют этот
функционал из коробки. Обертки над временными операциями должны быть
минимальными. Если модуль разрастается без контроля, вы явно пишете
говнокод. Остановитесь, пока весь проект не стал зависеть от кривых
классов или функций.</p>

<p>Хорошей практикой будет избегать преобразований на местах внутри
бизнес-логики. Лучше создать отдельный модуль и наполнять его
вспомогательным кодом. Логично, что если где-то выяснится, что нужно
было отнимать интервал, а не прибавлять, то исправить одну функцию
будет проще, чем сканировать весь проект.</p>

<p>Для работы со временем лучше сразу брать хорошую стороннюю
библиотеку. Время настолько сложная вещь, что редкий язык может
похвастаться качественной коробочной реализацией. В Джаваскрипте
объект <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date">Date</a> убог. В Джаве класс <a href="https://docs.oracle.com/javase/7/docs/api/java/util/Date.html">java.util.Date</a>
был объявлен deprecated уже с версии 1.1, то есть почти сразу. Родной
<a href="https://docs.python.org/3/library/datetime.html">datetime</a> в Питоне приемлем только для базовых задач.</p>

<p>Не нужно думать, что “мне только оберточку написать”, зато без
зависимостей. Время – важно. Пусть будут зависимости, но меньше
багов.</p>

<p>Рассмотрим основные положения о часовых поясах. Если оставить в
стороне политические и географические причины, то в силу сферической
природы мира разные люди могут наблюдать одно и то же положение Солнца
на небосводе в разные моменты времени. Назовем это локальным
временем. Последнее работает только в пределах того меридиана, дальше
начинается неопределенность.</p>

<p>(Конечно, часовые пояса идут не идеально ровно как полоски на
арбузе. Еще недавно в России меняли временные зоны – объединяли и
делили соседние. Так, стараниями Медведева в моей родной Чите зимой в
16 часов было уже темно как ночью. Но для простоты будем считать, что
пояса распределены равномерно.)</p>

<p>Поэтому фраза “созвонимся в три часа” в общемировом масштаба не значит
ничего. По чьему времени в три часа? По Москве? Нью-Йорку? Очевидно,
нужна особая метка чтобы обозначить, откуда это время получено. Тогда
путем простых вычислений можно перевести время из одной метки в
другую. Эта метка и называется временной зоной.</p>

<p>Обозначение у нее может быть разное, например смещение в часах
(+03:00), имя части света и города через косую черту (Europe/Berlin)
или одна из аббревиатур (CET, Центральное Европейское время), но это
уже тонкости стандартов кадирования. Важно то, что теперь время
привязано к конкретной местности и может быть преобразовано в
универсальное время UTC.</p>

<p><a href="https://en.wikipedia.org/wiki/Coordinated_Universal_Time">UTC</a> – универсальное координированное время – это
современный стандарт отсчета, пришедший на смену GMT. Не будем сейчас
разбирать его особенности, достаточно сказать, что на шкале поясов он
играет роль нуля: именно от него отсчитываются отрицательные
(западные) и положительные (восточные) зоны.</p>

<p>Например, я живу в Воронеже, мой пояс третий по счету на восток,
поэтому я могу написать в резюме “when calling, please consider my +3
UTC timezone” или просто “my TZ is +3”. Тогда заказчик из Лондона, у
которого нулевой пояс, добавит к своему времени 3 часа и получит мое
локальное время.</p>

<p>Я подвожу вас к мысли, что в приложениях недостаточно знать только
время, нужно знать еще и зону, иначе одно и то же время может быть
истолковано по-разному. Так мы переходим к технической части статьи.</p>

<p>Ваш сервер и база данных отвечают за хранение дат. Современные БД
(здесь и далее – PostgreSQL) предоставляют два типа полей: это
<code class="language-plaintext highlighter-rouge">timestamp with time zone</code> и <code class="language-plaintext highlighter-rouge">timestamp without time zone</code>, то есть с
зоной или без. Если в первое поле записать дату с зоной, то БД
сконвертирует ее в UTC, потому что так удобней. А при выводе этой даты
в утилитах она будет представлена в локальном времени того
пользователя, кто сейчас ее просматривает.</p>

<p>Рассмотрим пример:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">create</span> <span class="k">table</span> <span class="n">foo</span> <span class="p">(</span>
  <span class="n">ts_z</span> <span class="nb">timestamp</span> <span class="k">with</span> <span class="nb">time</span> <span class="k">zone</span><span class="p">,</span>
  <span class="n">ts</span> <span class="nb">timestamp</span> <span class="k">without</span> <span class="nb">time</span> <span class="k">zone</span>
<span class="p">);</span>

<span class="k">CREATE</span> <span class="k">TABLE</span>

<span class="k">insert</span> <span class="k">into</span> <span class="n">foo</span> <span class="p">(</span><span class="n">ts_z</span><span class="p">)</span> <span class="k">values</span>
  <span class="p">(</span><span class="s1">'2017-12-13T10:00:00-05:00'</span><span class="p">::</span><span class="nb">timestamp</span> <span class="k">with</span> <span class="nb">time</span> <span class="k">zone</span><span class="p">);</span>

<span class="k">INSERT</span> <span class="mi">0</span> <span class="mi">1</span>

<span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">foo</span><span class="p">;</span>
</code></pre></div></div>

<p>Результат:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>          ts_z          | ts
------------------------+----
 2017-12-13 18:00:00+03 |
(1 row)
</code></pre></div></div>

<p>Я создал таблицу с двумя полями: время с зоной и без. Потом записал в
поле с временной зоной время с часовым поясом Нью-Йорка. В базе оно
будет храниться как <code class="language-plaintext highlighter-rouge">2017-12-13 15:00:00 UTC</code>. Но при выводе я увижу
время в консоли в моем локальном времени. Все верно, мой пояс +3, дата
была приведена верно.</p>

<p>А в поле <code class="language-plaintext highlighter-rouge">ts</code> нужно писать только время по UTC, иначе будет ошибка:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">insert</span> <span class="k">into</span> <span class="n">foo</span> <span class="p">(</span><span class="n">ts</span><span class="p">)</span> <span class="k">values</span>
  <span class="p">(</span><span class="s1">'2017-12-13T10:00:00-05:00'</span><span class="p">::</span><span class="nb">timestamp</span> <span class="k">with</span> <span class="nb">time</span> <span class="k">zone</span><span class="p">);</span>

<span class="k">INSERT</span> <span class="mi">0</span> <span class="mi">1</span>

<span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">foo</span><span class="p">;</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>          ts_z          |         ts
------------------------+---------------------
 2017-12-13 18:00:00+03 |
                        | 2017-12-13 18:00:00
(2 rows)
</code></pre></div></div>

<p>Видим, что во второе поле записалось не то, что нужно: правильное
время по UTC должно быть 15 часов, а не 18. Вот как нужно было
сделать:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">insert</span> <span class="k">into</span> <span class="n">foo</span> <span class="p">(</span><span class="n">ts</span><span class="p">)</span> <span class="k">values</span>
  <span class="p">(</span><span class="s1">'2017-12-13T10:00:00-05:00'</span><span class="p">::</span><span class="nb">timestamp</span> <span class="k">with</span> <span class="nb">time</span> <span class="k">zone</span> <span class="k">AT</span> <span class="nb">TIME</span> <span class="k">ZONE</span> <span class="s1">'UTC'</span><span class="p">);</span>

<span class="k">INSERT</span> <span class="mi">0</span> <span class="mi">1</span>

<span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">foo</span><span class="p">;</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>          ts_z          |         ts
------------------------+---------------------
 2017-12-13 18:00:00+03 |
                        | 2017-12-13 18:00:00
                        | 2017-12-13 15:00:00
(3 rows)
</code></pre></div></div>

<p>Эта и другие ошибки будут рассмотрены ниже.</p>

<p>В различных библиотеках и ORM при выборке подобных дат они
восстанавливаются в объекты языка с заполненной часовой зоной (поля
tz, zone, tzinfo и тд).</p>

<p>Вариант дат без зон тоже имеет право на жизнь, и на мой взгляд он
проще. В команде вы просто соглашаетесь, что все даты хранятся как
локальное время по UTC. Все библиотеки имеют функции и методы для
работы с таким временем, например, <code class="language-plaintext highlighter-rouge">datetime.utcnow()</code> в Питоне,
<code class="language-plaintext highlighter-rouge">moment.utc()</code> в JS и тд.</p>

<p>Клиент и сервер должны обмениваться друг с другом только датами в
UTC. Универсальное время переводится в локальное на стороне клиента
исходя из локального смещения относительно нулевого меридиана. Эту
величину можно определить методом <code class="language-plaintext highlighter-rouge">.getTimezoneOffset()</code> объекта
<code class="language-plaintext highlighter-rouge">Date</code> на клиенте.</p>

<p>При передаче дат клиенту вы кодируете их в <a href="https://en.wikipedia.org/wiki/ISO_8601">ISO-формат</a> с
зоной. Если зона UTC, она обозначается буквой Z. Таким образом, в
текстовом представлении время, отправляемое клиенту будет выглядеть
так:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>"2017-12-12T14:12:23.502Z"
</code></pre></div></div>

<p>Слева направо: год, месяц, день, разделитель, часы, минуты, секунды,
микросекунды, индикатор нулевой зоны UTC.</p>

<p>При кодировании даты без зоны некоторые библиотеки могут не добавить
<code class="language-plaintext highlighter-rouge">Z</code> на конце, что может запутать клиента. Обязательно учтите это:
добавьте в модуль функцию, которая будет добавлять Z к результирующей
строке и пользуйтесь только этой функцией (см. выше о единой кодовой
базе для работы со временем).</p>

<p>На этом этапе нельзя не заметить, насколько убог формат JSON: он не
может передавать даты и не расширяется.</p>

<p>В обратную сторону с клиента на сервер даты передаются в таком же
формате: ISO-строка в UTC с <code class="language-plaintext highlighter-rouge">Z</code> на конце в качестве зоны.</p>

<p>Рассмотрим, что делать клиенту с полученной строкой. Легче всего
восстановить ее в объект библиотекой <a href="https://momentjs.com/">moment.js</a>:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">moment</span><span class="p">(</span><span class="dl">"</span><span class="s2">2017-12-12T14:20:05.849Z</span><span class="dl">"</span><span class="p">).</span><span class="nx">format</span><span class="p">()</span>
<span class="dl">"</span><span class="s2">2017-12-12T17:20:05+03:00</span><span class="dl">"</span>
</code></pre></div></div>

<p>Видим, что все правильно: мой пояс +3, часы были увеличены на эту
разницу, на конце индикатор +03:00.</p>

<p>В сторону: сейчас кто-то встанет и начнет заливать, что moment.js уже
не популярен, и что горячие парни пишут какую-то новую либу на замену
ей. Мой совет – шлите лесом таких советчиков. Нам нужно проверенное
решение, а не модная поделка.</p>

<p>В каком формате показывать дату – зависит от вас. В каждой стране
свои форматы, определяющие порядок следования составляющих (день,
месяц или месяц, день), разделителей (точка, косая черта, дефис),
написание месяцев (Dec, December). Важно понять, что успешный вывод
даты зависит от того, была ли правильно она восстановлена из строки на
этапе ранее.</p>

<p>Стоит запомнить: если показ даты требует от вас каких-то махинаций
вроде прибавления или вычитания часов, минут или что-то в этом роде –
срочно остановитесь, вы гарантированно что-то делаете неправильно. Или
должно быть четкое понимание, почему нельзя сделать по-другому.</p>

<p>При передаче JSON-тела на сервер объект Date не нужно приводить в
ISO-строку вручную. Для этого существует метод <code class="language-plaintext highlighter-rouge">.toJSON()</code>, который
автоматически будет вызван при кодировании внешнего словаря. Например:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">();</span>
<span class="nx">Tue</span> <span class="nx">Dec</span> <span class="mi">12</span> <span class="mi">2017</span> <span class="mi">18</span><span class="p">:</span><span class="mi">40</span><span class="p">:</span><span class="mi">48</span> <span class="nx">GMT</span><span class="o">+</span><span class="mi">0300</span> <span class="p">(</span><span class="nx">MSK</span><span class="p">)</span>

<span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span><span class="na">foo</span><span class="p">:</span> <span class="mi">42</span><span class="p">,</span> <span class="na">bar</span><span class="p">:</span> <span class="nx">d</span><span class="p">})</span>
<span class="dl">"</span><span class="s2">{</span><span class="dl">"</span><span class="nx">foo</span><span class="dl">"</span><span class="s2">:42,</span><span class="dl">"</span><span class="nx">bar</span><span class="dl">"</span><span class="s2">:</span><span class="dl">"</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">12</span><span class="nx">T15</span><span class="p">:</span><span class="mi">40</span><span class="p">:</span><span class="mf">48.573</span><span class="nx">Z</span><span class="dl">"</span><span class="s2">}</span><span class="dl">"</span>
</code></pre></div></div>

<p>Рассмотрим основные ошибки, связанные с обработкой времени и как с
ними бороться. Начнем с сервера.</p>

<ul>
  <li>Тип поля указан <code class="language-plaintext highlighter-rouge">timestamp with time zone</code>, но вы передаете объект
времени без зоны.</li>
</ul>

<p>В этом случае сервер подставит текущую зону, то есть ту, в которой
расположен сервер. Если пользователь расположен далеко, например, на
другом континенте, это может вызвать значительные неудобства. Скажем,
пользователь из Нью-Йорка (-5 UTC) передал на сервер время
<code class="language-plaintext highlighter-rouge">"2017-12-12T14:20:00Z"</code>. Сервер расположен в Швейцарии (+1 UTC). По
какой-то причине зона была отброшена, и в базу вместо
<code class="language-plaintext highlighter-rouge">"2017-12-12T23:20:00 UTC"</code> (исходное плюс 5 часов) записалось
<code class="language-plaintext highlighter-rouge">"2017-12-12T13:20:00 UTC"</code> (исходное минус 1 час). Ошибка в 10 часов!
Представьте, что это напоминания о поездке или рассылка смс.</p>

<ul>
  <li>Тип поля <code class="language-plaintext highlighter-rouge">timestamp without time zone</code>, но в базу пишется локальное
время сервера.</li>
</ul>

<p>Убедитесь, что для получения текущего времени вы используете функцию с
<code class="language-plaintext highlighter-rouge">utc</code> в ее имени, например, datetime.utcnow() вместо datetime.now() и
аналогично в других языках. В PostgreSQL аналогично: почти для всех
вызовов временных функций нужно указывать зону UTC. Сравните:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; select current_timestamp;
       now
-------------------------------
 2017-12-12 19:03:07.683706+03


&gt; select current_timestamp at time zone 'UTC';
     timezone
--------------------------
 2017-12-12 16:04:21.7177
</code></pre></div></div>

<p>Перевести зону из одной в другую на уровне БД можно следующим
оператором:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span>
  <span class="s1">'2017-12-13T10:00:00-05:00'</span><span class="p">::</span><span class="nb">timestamp</span> <span class="k">with</span> <span class="nb">time</span> <span class="k">zone</span> <span class="k">AT</span> <span class="nb">TIME</span> <span class="k">ZONE</span> <span class="s1">'UTC'</span>
  <span class="k">as</span> <span class="n">right_time</span><span class="p">;</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>     right_time
---------------------
 2017-12-13 15:00:00
</code></pre></div></div>

<p>Теперь клиент.</p>

<ul>
  <li>С сервера приходят UTC-даты в ISO, но без метки Z, например
<code class="language-plaintext highlighter-rouge">"2017-12-12T14:20:05"</code>.</li>
</ul>

<p>Попытка отобразить такую дату с помощью moment.js, как мы делали выше,
приведет к ошибке:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">moment</span><span class="p">(</span><span class="dl">"</span><span class="s2">2017-12-12T14:20:05</span><span class="dl">"</span><span class="p">).</span><span class="nx">format</span><span class="p">()</span>
<span class="dl">"</span><span class="s2">2017-12-12T14:20:05+03:00</span><span class="dl">"</span>
</code></pre></div></div>

<p>Вариантов тут два: либо приклеить к строке со временем нужную зону,
либо явно указать библиотеке, что это время в UTC:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">moment</span><span class="p">.</span><span class="nx">utc</span><span class="p">(</span><span class="dl">"</span><span class="s2">2017-12-12T14:20:05</span><span class="dl">"</span><span class="p">).</span><span class="nx">local</span><span class="p">().</span><span class="nx">format</span><span class="p">()</span>
<span class="dl">"</span><span class="s2">2017-12-12T17:20:05+03:00</span><span class="dl">"</span>
</code></pre></div></div>

<p>Метод <code class="language-plaintext highlighter-rouge">.utc()</code> парсит строку с учетом того, что результат будет время
по UTC. Метод <code class="language-plaintext highlighter-rouge">.local()</code> преобразует его к локальному времени на
основании смещения, которое берется из браузера. Теперь все правильно.</p>

<ul>
  <li>С сервера приходит его локальное время.</li>
</ul>

<p>Это беда, но лечится явным указанием зоны. Например, вы в Москве, а
сервер в Нью-Йорке. Он отдает локальное время
<code class="language-plaintext highlighter-rouge">"2017-12-12T14:20:05"</code>. Нью-Йорк в минус пятом часовом
поясе. Приклеим зону к строке и распарсим:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">moment</span><span class="p">(</span><span class="dl">"</span><span class="s2">2017-12-12T14:20:05</span><span class="dl">"</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">-05:00</span><span class="dl">"</span><span class="p">).</span><span class="nx">format</span><span class="p">()</span>
<span class="dl">"</span><span class="s2">2017-12-12T22:20:05+03:00</span><span class="dl">"</span>
</code></pre></div></div>

<p>Значит, это 22:20 вечера по Москве. Проверим устно: если от НЙ до
нулевого меридиана 5 часов, а потом еще 3 часа до Москвы, то в сумме 8
часов. 14 + 8 = 22 часа местного времени.</p>

<ul>
  <li>Сервер отдает время в виде “unix epoch”.</li>
</ul>

<p>Это значит в количестве секунд со дня рождения ОС Юникс – 1 января
1970 года. Такое время всегда представлено в UTC. Отобразить его
пользователю можно так:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">moment</span><span class="p">.</span><span class="nx">unix</span><span class="p">(</span><span class="mi">1513107997</span><span class="p">).</span><span class="nx">format</span><span class="p">()</span>
<span class="dl">"</span><span class="s2">2017-12-12T22:46:37+03:00</span><span class="dl">"</span>
</code></pre></div></div>

<p>На мой взгляд, хранение времени в виде числа секунд имеет ряд
недостатков. Во-первых, оно совершенно нечитаемо. По набору цифр
невозможно определить даже год с точностью до десятка. Во-вторых, это
не оптимально. Современные БД хранят даты в таком виде, чтобы было
удобно обращаться к их составным частям. Напротив, хранение в дат в
секундах требует постоянной конвертации.</p>

<p>Обобщу вышесказанное.</p>

<p>Научиться работать со временем не сложно. Главное – не оправдывать
лень и не дожидаться момента, когда съедут все даты вечером в
пятницу. Время – важно.</p>

<p>Воздержитесь от собственных поделок для работы с часовыми
поясами. Оставляйте операции со временем на откуп проверенным
библиотекам. Выносите вспомогательные функции в особый модуль.</p>

<p>Храните даты на сервере либо с временной зоной UTC, либо без нее, но
подразумевая это.</p>

<p>Клиент и сервер должны пересылать даты только в UTC с нулевой зоной Z.</p>

<p>Локальное время выводится на клиенте из UTC относительно локального
смещения пользователя.</p>

<p>При кодировании дат в JSON последний сам позаботится часовом поясе. Вы
не должны что-то прибавлять или вычитать.</p>

<p>Маленький бонус: рассмотрим как быть, если формировать локальное время
нужно не на клиенте, а на сервере. До сих пор я вел разговор в том
ключе, что у нас Single page application и все рендериться на
клиенте. Однако, чисто серверные приложения никуда не делись, и такая
задача тоже может возникнуть.</p>

<p>Представим, что даты хранятся в UTC, но вот пришел HTTP-запрос от
какого-то пользователя, и нужно показать даты в его локальном
формате. Как быть?</p>

<p>Пока у нас нет никаких данных о пользователе, можно, используя его IP,
через сторонний сервис или библиотеку с локальной базой адресов на
борту хотя бы примерно определить его страну или даже город. По этом
данным станет легко вывести временной пояс.</p>

<p>Но страна вовсе не означает время. Так, пользователь Воронежа может
сидеть через прокси или Тор с выходной нодой где-то в Индии, но при
это его локальное время не имеет отношения к этой стране.</p>

<p>Узнать локальное смещение можно через специальный метод объекта <code class="language-plaintext highlighter-rouge">Date</code>:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">()).</span><span class="nx">getTimezoneOffset</span><span class="p">()</span>
<span class="o">-</span><span class="mi">180</span>
</code></pre></div></div>

<p>Оно выражено в минутах и имеет знак противоположный часовому
поясу. Если у меня зона +3, то смещение будет -180 минут.</p>

<p>С помощью скрипта это значение можно положить в куки на стороне
клиента, и тогда все последующие запросы к серверу будут сообщать о
настоящем часовом поясе пользователя.</p>

<p>Чтобы привести время UTC в локальное на сервере, достаточно вычесть из
первого смещение в минутах. При этом нужно держать в уме знак:
вычитание отрицательных минут означает их прибавление, что нам и
нужно.</p>

<p>Рассмотрим код на Питоне:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>

<span class="n">utc</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="n">utcnow</span><span class="p">()</span>
<span class="n">loc</span> <span class="o">=</span> <span class="n">utc</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=-</span><span class="mi">180</span><span class="p">)</span>

<span class="n">utc</span> <span class="c1"># datetime.datetime(2017, 12, 13, 13, 57, 18, 108606)
</span><span class="n">loc</span> <span class="c1"># datetime.datetime(2017, 12, 13, 16, 57, 18, 108606)
</span></code></pre></div></div>

<p>Локальное время на 3 часа больше, теперь эту дату можно показывать
пользователю.</p>

<p>Это был пример явной манипуляции с часовыми поясами. Выше я писал, что
этого следует избегать. Однако, здесь явно присутствует понимание
того, что мы делаем. Простой вычет будет эффективней и проще
использования навороченной библиотеки с часовыми поясами.</p>

<p>Ну вот и все, думаю, это было не сложно. Я не люблю просить о репостах
и никогда не делал этого, но на этот раз сделаю исключение. Прошу
показать эту статью тем, кто связан с веб-разработкой, особенно
фронтендом. Возможно, хоть где-то удастся избежать ошибок вроде тех,
что я описал в самом начале. Может, хоть немного облегчатся чьи-то
будни.</p>

<p>Награда для тех, кто прочел до конца:</p>

<iframe width="640" height="360" src="https://www.youtube.com/embed/VY3O2aGfzhs" gesture="media" allow="encrypted-media" allowfullscreen=""></iframe>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/clj-stream-2/">Пробный стрим про Кложу и Биткоин</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2017-12-08T00:00:00+00:00">
        Dec 8, 2017
    </time>

    <a href="/tag/stream/" rel="tag">stream</a>, <a href="/tag/bitcoin/" rel="tag">bitcoin</a>

</div>


            <div class="entry">
                
                    
<p>Вчера стримил Кложу. Писал библиотеку-обертку для популярных Биткоин-кошельков:
Bitcoin.Core и Electrum. Неплохо пролучилось для первого раза, на мой
взгляд. Надо попробовать стрим на английском. <a href="https://github.com/igrishaev/clj-bitcoin">Код на Гитхабе.</a></p>

<iframe width="640" height="360" src="https://www.youtube.com/embed/JtKmeTZNT7w" gesture="media" allow="encrypted-media" allowfullscreen=""></iframe>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/gov/">Государство -- враг</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2017-12-01T00:00:00+00:00">
        Dec 1, 2017
    </time>

    <a href="/tag/gov/" rel="tag">gov</a>

</div>


            <div class="entry">
                
                    
<p>На одной из встреч Рефакторинга наш юрист Александр Мазалов <a href="https://www.youtube.com/watch?v=ENGUmiVgu9U">хорошо
сказал</a>, что государство это машина, которая умеет только бить кувалдой
по голове. С остальными функциями оно справляется плохо.</p>

<p>Кто-то наверняка встанет и начнет разливаться про социальную защищенность и
налоги. Но вот что, послушайте историю с обычным штрафом. Проверим, справедлив
ли тезис или нет.</p>

<p>Значит, выписали мне обычный штраф за превышение – не увидел знак 40 км,
проехал на 60. Оплатил в мобильном приложении Сбера. Через месяц падает письмо с
Госуслуг: все тот же неоплаченный штраф. Поскольку искать что-то в истории
Сбербанка это слезы и боль, решил, что, может быть, не нажал на последнюю кнопку
в форме или как-то иначе затупил. Оплатил через Тинькова, на этот раз проверил,
что деньги списались.</p>

<p>Через месяц приходит письмо, что будем тебя судить за неоплаченный
штраф. Удаляю. Еще через месяц – смс из Сбера, что со счета арестованы 800
рублей.</p>

<p>Я звоню, барышня говорит да, пришел запрос от приставов на арест денег за
неуплаченный штраф. Почему же вы, черти, не защитили клиента? Вы же могли
проверить по коду или реквизитам, что штраф погашен? И сами разрулить?</p>

<p>Нет, говорят, такой регламент определен государством. Нам сказали списать, мы по
закону обязаны, а за что – не наше дело, разруливай сами</p>

<p>Ладно, звоню приставам. Там колл-центр. Напрямую дозвониться нельзя. По телефону
ничего решить невозможно, только лично и с паспортом. Контора у черта на рогах,
ехать по адовым пробкам. Можно почтой, но все документы должны быть заверены у
нотариуса, отвечать будут месяц (плюс еще месяц на доставку нашей почтой).</p>

<p>Короче, оценил я затраты времени и сил и плюнул на это дело. Пусть подавятся.</p>

<p>Через месяц снова арестовывают 800 рублей. Тут уж я решил разорвать колесо
Сансары и поехал.</p>

<p>В конторе убогость: бывший подъезд панельной пятиэтажки, толпа, стульев нет,
стоит школьная парта. Даже сеть не ловит.</p>

<p>Показываю приставу бумаги и смс. Думал, что он начнет возмущаться, что не может
быть, все по закону. А он с невозмутимым лицом говорит: да, бывает. Я по ошибке
списал и в отпуск ушел, а задачу не закрыл. Пришла коллега и снова списала.</p>

<p>Конечно, денег он мне не вернул, но дал бумагу. Езжай с ней в ГИБДД. А вы-то
сами, говорю, не в состоянии это утрясти? Нет. Ну и чтоб вас не томить: там тоже
стоял, ждал приема, потом мент полчаса тупил в комп и дал последнюю,
ультимейт-бумагу, которую нужно отправить в какой-то другой центр ГИБДД.</p>

<p>А сами-то, бляди, вы не можете отправить? Нет.</p>

<p>И в общем, через месяц после того как бумагу доставил, приходит заказное письмо:
да, вернем вам деньги. И еще через месяц падает нотификация со Сбера, что деньги
поступили. Аминь.</p>

<p>Началась эта петрушка ранним летом, закончилась поздней осенью. Просто из
интереса решил проверить, к чему все придет.</p>

<p>Главный вывод: государство не заинтересовано в восстановлении
справедливости. Битье по голове работает как часы, все остальное – нет. Если бы
это была обычная жалобная заметка, коих в сети тысячи, то можно было бы и
закончить. Но я хочу обратить внимание на дизайн всей системы.</p>

<p>Смотрите, все связи устроены так, что нигде не предусматривается обратное
распространение сигнала. Во всех случаях одно ведомство передавало сигнал
другому, но как только нужно наоборот – вот тебе бумага, вези на другой конец
города. Вы же, менты и банкиры, для нужд внутреннего документооборота не
колесите по городу на личном транспорте? У вас же почта, курьеры, приватные
сети. Но в обратную сторону ничего не работает.</p>

<p>Регламент отношений между ведомостями проектировал не один человек, а целая
группа. Ни у кого не возникла мысль, как автоматически разрулить ошибку. В
приставах же не роботы сидят, а люди, они ошибаются. Должен быть отдельный
регламент по обработке ошибок. Нельзя сплавлять их на конечного человека.</p>

<p>Все это вместе пример плохого дизайна. Это распределенная система, в которой
совершенно не учтены ошибки и порядок их разрешения.</p>

<p>К сожалению, именно так мы и пишем программы. Не тот параметр – упало. В
словаре нет ключа – упало, и пусть десять запущенных тредов тоже упадут. Сервер
ответил 404 – исключение, программа завершилась. Приложение, как попка-дурак,
каждый раз спрашивает одно и то же. Все делай сам: нажимай, логируй, проверяй.</p>

<p>Никого не волнует, что не ты должен этим заниматься.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/hate/">Бесы</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2017-11-26T00:00:00+00:00">
        Nov 26, 2017
    </time>

    <a href="/tag/hate/" rel="tag">hate</a>

</div>


            <div class="entry">
                
                    <p>Отписываюсь от авторов, которые злоупотребляют темой “как же меня
бесит”. Особенно когда материал касается людей: не так говорят, не так делают,
пользуются не теми программами. Хватит, надоело.</p>

<p>Жалобу на неудобный дизайн или кривой код я воспринимаю как рабочую заметку. Это
ошибка в работе, и ее можно исправить: завести таску в джире, повесить на
человека, затрекать время. Изжить проблему со временем.</p>

<p>Но жалобы на людей или насмешки по поводу одежды или внешности не идут ни в
какие рамки. Такие заметки ни что иное как провокация. Можно долго врать, что ты
просто высказываешь мнение, и никто не обязан его слушать, но врешь в первую
очередь самому себе.</p>

<p>Люди физически не могут молчать, особенно когда их мнение резко расходится с
высказанным. Идея о том, что все вокруг соберутся такие продвинутые, молча
выслушают и пройдут мимо – бред. Подобного рода заметки – банальный вброс и
срач.</p>

<p>Представим, я напишу пост о том, как меня бесят инвалиды. И каждому, кто напишет
в личку, буду отвечать: я ведь не говорил, что инвалиды плохие, просто они меня
бесят. Это вы лезете в мою жизнь. Технически все нормально, но это поведение,
так сказать, не очень порядочного человека.</p>

<p>Зачем же ты провоцируешь окружающих? Кому от этого поста стало легче? Число
бесящих тебя людей сократилось? Они поняли свои ошибки, исправились?</p>

<p>Нет же. Каждый, кто хоть немного работал с людьми знает, что человек меняется
годами и десятилетиями. Ты собрал трафик, вызвал дискуссию, но на самом деле
банально поссорил кого-то.</p>

<p>Еще и пишешь продолжение, что я Д’Артаньян, а вы ничего не поняли. Не
профессионально и не по мужски.</p>

<p>И заодно заканчивайте жаловаться на плохое меню в кафе, ожидание в ресторане,
отсутствие парковки, грубую продавщицу, платную подписку в программе, низкую
зарплату, сложные вопросы на собеседованиях, дурака-начальника, рост тарифов и
курс доллара.</p>

<p>Все это останется даже когда вас не станет. А вот как жить так, чтобы ничего из
вышеперечисленного на вас не влияло – вопрос гораздо интересней.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/read-30/">Ссылки на выходные #30</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2017-11-25T00:00:00+00:00">
        Nov 25, 2017
    </time>

    <a href="/tag/read/" rel="tag">read</a>, <a href="/tag/life/" rel="tag">life</a>

</div>


            <div class="entry">
                
                    
<ul>
  <li>
    <p><a href="http://maximilyahov.ru/blog/all/unthinkable/">Голубь, лаборант, Ницше и проблема мышления</a></p>

    <p>Прекрасный пост Ильяхова.</p>
  </li>
  <li>
    <p><a href="http://torshina.me/vas-eche-na-zaebalo-razvivayutsya-i-samosovershenstvuyutsya">Заебали хуесосы, которые постоянно учатся новому, развиваются и самосовершенствуются</a></p>

    <p>Торшина, и этим все сказано.</p>
  </li>
  <li>
    <p><a href="https://dev.to/agazaboklicka/are-you-programming-in-your-comfort-zone-please-dont-69i">Are you (programming) in your comfort zone? Please don’t.</a></p>

    <p>О вреде зоны конфорта в работе.</p>
  </li>
  <li>
    <p><a href="https://varlamov.ru/2663443.html">Почему не надо спрашивать народ</a></p>

    <p>Актуально для воронежцев.</p>
  </li>
</ul>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/en/ui-test/">Thoughts on UI tests</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2017-11-20T00:00:00+00:00">
        Nov 20, 2017
    </time>

    <a href="/tag/clojure/" rel="tag">clojure</a>, <a href="/tag/integration/" rel="tag">integration</a>, <a href="/tag/tests/" rel="tag">tests</a>, <a href="/tag/selenium/" rel="tag">selenium</a>

</div>


            <div class="entry">
                
                    <p>Generally, I’m a big fan of writing test. They are great: once you add them, you
cannot break logic silently anymore. The time you’ve spent on writing tests pays
off completely in that manner you won’t need to fix production on Friday’s
night. Tests cannot guarantee your code is free from errors completely,
though. But having properly designed tests greatly reduces the number of
potential mistakes.</p>

<p>For a long time, I’ve been developing only server-side tests whereas the UI
behavior was tested manually. That has been worked until the moment when we
understood we break the UI too often. That’s how the question about having UI
tests has appeared.</p>

<p><strong>TL;DR:</strong> I didn’t anticipate maintaining client-side tests (also known as
integration test) would be so costly. Yet I managed to get stable UI tests, it
took long time of debugging, reading the source code of webdrivers and
Google/StackOverflow surfing. Here are some random thoughts on the subject.</p>

<h3 id="ui-tests-are-complex">UI tests are complex</h3>

<p>The first issue you might face when dealing with UI tests (and it has never been
written clearly in any documentation or manual) is they are unstable and flaking
by their nature. In technical terms, they are fragile and difficult to
maintain. Testing UI involves lots of technologies and protocols. Under the
hood, there is an entire stack of nested calls.  Let’s consider a typical
PHP/JS-driven web-application with Selenium-based tests. Now follow the testing
pipeline.</p>

<p>Before you run a test, you should launch the application server (probably your
REST backend) and Selenium server. Then, once you’ve started a test, it sends
request to Selenium to start a new browser session. Java spawns a new process of
webdriver – a special program that helps to automate browsers. The driver tries
to discover a browser installed on your machine. If everything is alright, the
browser process starts. Just a note: you have not done anything important yet,
but there are four processes are running already (the app, Selenium, webdriver,
browser).</p>

<p>Now then, every time you call for something like</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">driver</span><span class="p">.</span><span class="n">find_element_by_id</span><span class="p">(</span><span class="s">"my_button"</span><span class="p">)</span>
</code></pre></div></div>

<p>, it turns into a stack with the steps look like approximately the following:</p>

<ol>
  <li>your PHP/Python/whatever code calls Selenium server.</li>
  <li>Selenium remaps the incoming data and calls webdriver server.</li>
  <li>The webdriver reads JSON body and sends corresponding binary commands to the
browser via socket channel.</li>
  <li>The browser performs those actions with some delay. There is no guarantee
about timings, the numbers depend on your OS, number of cores, amount of open
tabs and so on.</li>
  <li>If everything is alright, the data flows in the opposite way: from the
browser to the webdriver, to Selenium and finally to the app.</li>
</ol>

<p>Remember, it was only a simplest API call. More complicated API expand into
series of calls and success only when all of sub-calls managed to finish
successfully.</p>

<h3 id="versioning-hell">Versioning hell</h3>

<p>What exactly may occur during the process? Well, everything.</p>

<p>The most obvious thing is the more software you are trying to work together the
more unstable the system becomes. That might not be a problem when all the
components are under your control. Say, if it was a micro-service architecture
with each node developed by your people. But if fact, they all come from
different companies with different points on the subject. Your testing library
is written by some enthusiasts. Selenium is the second group. The browser is the
third one and they do not listen to anybody, that’s for sure. Developers who
have brought the webdriver are the fourth group.</p>

<p>Now imagine that every product has its own version, release schedule and
roadmap. And the version <code class="language-plaintext highlighter-rouge">4.2.1</code> of this requires at least version <code class="language-plaintext highlighter-rouge">3.2.1</code> of
that. In the release <code class="language-plaintext highlighter-rouge">5.4</code> the feature X doesn’t work, you should use <code class="language-plaintext highlighter-rouge">5.5-beta</code>
instead. And more many of that. These bits of information are never shared in
the documentation, but only in comments on Github.</p>

<p>It reminds me <a href="https://en.wikipedia.org/wiki/Appulse">The Planet Parade</a> sometimes when the system performs
only if some special version’s numbers are set together. Otherwise, it falls
apart.</p>

<h3 id="they-run-for-too-long">They run for too long</h3>

<p>Another issue with integration tests that you might not be aware about is their
long execution time. It becomes new to me after long period of maintaining
server tests that used to pass in a minute or two. Even having a small set of
integration tests, it would take much more time. If we care about running each
tests independently without affecting them each other, you need to turn the app
to its initial state. That involves resetting the database, logging out, wiping
session, preparing local files and so forth. It takes sensible amount time all
together. Be prepared your CI pipeline becomes more time-consuming.</p>

<h3 id="referencing-a-missing-element">Referencing a missing element</h3>

<p>What I’d like to highlight more in that topic is a strange error named “element
stale”. It will definitely rich you when dealing with single page application
(aka SPA). It is so common that the official Selenium site has
a <a href="http://docs.seleniumhq.org/exceptions/stale_element_reference.jsp">dedicated page</a> and an exception
class <a href="https://seleniumhq.github.io/selenium/docs/api/dotnet/html/T_OpenQA_Selenium_StaleElementReferenceException.htm">named after if</a>. The sad thing, those text is quite stingy on
describing what could be the reason of getting such an error. And more
important, how to prevent it appears. Hopefully, after long debugging sessions,
I’ve got answers to both of those questions.</p>

<p>Inside browser, every DOM element has its own unique machinery-wise
identifier. There is no a single standard of representing it. Depending on
browser, you might get either <code class="language-plaintext highlighter-rouge">0.950889431100737-1</code> or
<code class="language-plaintext highlighter-rouge">c1ee22f1-b96e-5245-bd85-9e56e1781cbd</code> for the same button. But it does not
matter. What really does is it’s quite easy to refer an element that has been
removed from the DOM tree when the app page has been re-rendered.</p>

<p>That’s the root of the problem: such modern frameworks as React, Vue or whatever
else continuously update the page components inserting new HTML nodes. Even when
you have a component with a button with unique “id” attribute and it has been
re-rendered, an new DOM element instance will be created. From the browser’s
prospective, it will the another node, completely different to the previous one.</p>

<p>Each modern testing framework has high-level functions to operate on page
elements without knowing their IDs. Consider Python examples:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">driver</span><span class="p">.</span><span class="n">click_on_element</span><span class="p">(</span><span class="s">"my_button"</span><span class="p">)</span>
</code></pre></div></div>

<p>In fact, this API call expands into at leas two low-level Webdriver API calls,
namely:</p>

<ol>
  <li>Try to discover an element ID by the search term.</li>
  <li>Try to click on that element.</li>
</ol>

<p>Looks well, but here is what takes place under the hood. You’ve got a long ID of
a link or a button, that’s great. But in a millisecond before you clicked on it,
the UI has been re-rendered. The reason of that is not so important: maybe, some
event has been triggered, or a user hovered some element when moving mouse to
it. Or maybe, the framework’s internal algorithm just decided somehow the
content should be updated. That means, the original button element you’ve got
the ID for was detached from the DOM thee and moved into a temporary array or
any other kind of data structure to wait before it is wiped completely from
memory. Instead of it, a new DOM node that looks exactly the same took those
place. But willing to click on the button, use send the outdated ID. There is no
sense in clicking on such kind of elements that are almost dead. The browser
returns corresponding error message that expands into Selenium exception.</p>

<p>I wish that paragraph was on those page. It would save me a week maybe or even
more.</p>

<p>A good solution would be to implement some kind of transactions in your
code. Let every complex API be implemented with try/catch clause with some
sensible strategy to re-call it in a case of failure, say a number of times or
by timeouts.</p>

<h3 id="high-hopes">High Hopes</h3>

<p>OK, let’s have some final thoughts on the subject, some kind of summary. Testing
UI is really far from the server-side ideal world. They are unstable, difficult
to develop and maintain. There a lots of undocumented traps you may suffer from
during the journey. But still, there are definitely some good things happening
nowadays.</p>

<p>First, the official <a href="https://www.w3.org/TR/webdriver/">Webdriver protocol</a> is developing actively. This
protocol is subject to substitute the outdated
Selenium <a href="https://github.com/SeleniumHQ/selenium/wiki/JsonWireProtocol">JSONWire protocol</a>. It has become a part of W3C so I hope it
will be developed so forth.</p>

<p>More Selenium-free libraries appear on
Github:
<a href="http://nightwatchjs.org/">Nightwatch</a>, <a href="https://github.com/teamcapybara/capybara">Capybara</a>, <a href="https://github.com/GoogleChrome/puppeteer">Puppeteer</a>… That
is great because having the only one monopolist in such specific area stops the
progress.</p>

<p>But there are lots of things to be done. What I’d like to see at first place is
some kind of cookbook with common advise and good practices on how to test UI
without suffering. Those bits should not depend on specific language or library
although there could be platform-specific sections. I have never met such kind
of a cookbook across the Internet; please correct me if there are any of them.</p>

<p>When writing a library for browser automation, it would be great to not only
cover the low-level calls but also design an abstract layer of high-level API to
make it easy to use by those who are not familiar with all the issues I
mentioned above. Say, a high-level function (or method if we talk on OOP terms)
that clicks on a button should take into account the case when the element is
stale. From my prospectives, such a functional language powered with immutable
data structures and homoiconicity as Clojure (or any Lisp-family one) would be a
great choice.</p>

<p>Ok, let’s finish for now. Thank you for listening out. Next time, I’ll say more
on technical side of testing code.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/en/mozilla/">Mozilla makes me crazy</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2017-11-10T00:00:00+00:00">
        Nov 10, 2017
    </time>

    <a href="/tag/clojure/" rel="tag">clojure</a>, <a href="/tag/mozilla/" rel="tag">mozilla</a>, <a href="/tag/rust/" rel="tag">rust</a>

</div>


            <div class="entry">
                
                    
<p>What I’d like to share with you is my suffering from dealing with browsers. I’m
an author of a <a href="https://github.com/igrishaev/etaoin">Clojure library</a> that automates browsers. Briefly, the
library doesn’t depend on Selenium since it implements
the <a href="https://www.w3.org/TR/webdriver">Webdriver protocol</a> with pure Clojure. It brings flexibility and
freedom in the way you’d like to build your API.</p>

<p>At the same time, everybody who is willing to tame several browsers at once is
doomed to open the Pandora box. There is the <a href="https://www.w3.org/TR/webdriver">official standard</a> I
thought, so definitely everybody will follow it. A naive laddie I was.</p>

<p>I don’t know if there is some kind of curse or black magic, but sometimes
developers cannot just implement the standard as it dictates the things should
be done. For example, it says the server should accept a <code class="language-plaintext highlighter-rouge">value</code>
field. Developers write code that takes <code class="language-plaintext highlighter-rouge">text</code> instead. When I see it, I have
strange feeling of being completely stunned without any understanding of what’s
going on here.</p>

<p>But what exactly I wanted to discuss is how does Mozilla develop their software.</p>

<p>Briefly, they break everything apart moving further. And I don’t know how to
deal with it. Maybe they enjoy coding in Rust so much that their mission to ship
good software has faded away.</p>

<p>I know I’m not a Mozilla engineer and would never be capable of joining them,
but still. As a user of their products, namely Geckodriver and Webdriver
utilities, I consider myself being right when criticizing them.</p>

<p>With each <a href="https://github.com/mozilla/geckodriver/releases">next release</a> of Geckodriver, it behaves worth and
worth. When I first started developing the library (a bit less then 1 year ago),
it was 0.13 version available and it worked fine. I wrote a bunch of unit tests
that all passed. Nowadays, the latest version is 0.19 and it just doesn’t work.</p>

<p>Yes, you heard correct, it does not even respond to any API call:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>~/Downloads&gt; ./geckodriver-0.19.0
1510326430666 geckodriver INFO geckodriver 0.19.0
1510326430680 geckodriver INFO Listening on 127.0.0.1:4444

curl <span class="nt">-X</span> POST <span class="nt">-d</span> <span class="s1">'{"desiredCapabilities": {}}'</span> <span class="s2">"http://127.0.0.1:4444/session"</span>
</code></pre></div></div>

<p>Calling <code class="language-plaintext highlighter-rouge">curl</code> utility throws a long stack trace saying something about sandbox
restrictions without any word on how to fix that or at least where to look for
help.</p>

<p>Here is a <a href="https://github.com/mozilla/geckodriver/issues/706">related issue</a> that confirms I’m not the first one who faced
it. It’s closed! “As I said, this isn’t a problem with geckodriver”, one of
developers says. OK, but I’m still curious about why does the version <code class="language-plaintext highlighter-rouge">0.13</code>
work fine whereas switching on <code class="language-plaintext highlighter-rouge">0.19</code> leads to failure? Proof:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>~/Downloads&gt; ./geckodriver-0.13.0 <span class="nt">--version</span>
geckodriver 0.13.0

~/Downloads&gt; ./geckodriver-0.13.0
1510327215587 geckodriver INFO Listening on 127.0.0.1:4444

curl <span class="nt">-X</span> POST <span class="nt">-d</span> <span class="s1">'{"desiredCapabilities": {}}'</span> <span class="s2">"http://127.0.0.1:4444/session"</span>
<span class="o">&gt;&gt;&gt;</span> <span class="o">{</span><span class="s2">"sessionId"</span>:<span class="s2">"e744bbdd-1b3f-9249-827f-02204bbc81c8"</span>,<span class="s2">"value"</span>:<span class="o">{</span><span class="s2">"acceptInsecureCerts"</span>:...
</code></pre></div></div>

<p>Ok, let’s decrease the version a bit. I downloaded them moving backwards in
time. Again, <code class="language-plaintext highlighter-rouge">0.18</code> still does not work. We need to go deeper. The previous one
numbered with <code class="language-plaintext highlighter-rouge">0.17</code> starts well, but suddenly, I cannot fetch a new session
with my library, it just returns <code class="language-plaintext highlighter-rouge">nil</code> value. That’s strange.</p>

<p>Going down to <code class="language-plaintext highlighter-rouge">0.15</code>. Don’t know why, but I cannot fill any input field, the API
fails with a strange error saying I didn’t pass the “text” field. Hm, I clearly
remember that the API accepts “value” field. That’s what
the <a href="https://www.w3.org/TR/webdriver/#dfn-element-send-keys">W3C standard says</a>. Geckodriver 0.13 follows it, but not the
0.15 release! After fetching the official <a href="https://hg.mozilla.org/mozilla-central/">Mozilla repo</a> and
searching in its history for a while, I found this (truncated):</p>

<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gh">diff -r 225d1faf513b -r b429bf0078c4 testing/webdriver/src/command.rs
</span><span class="gd">--- a/testing/webdriver/src/command.rs	Tue Mar 07 18:50:56 2017 +0000
</span><span class="gi">+++ b/testing/webdriver/src/command.rs	Wed Mar 15 13:54:19 2017 +0000
</span><span class="p">@@ -752,7 +752,7 @@</span>

 #[derive(PartialEq)]
 pub struct SendKeysParameters {
<span class="gd">-    pub value: Vec&lt;char&gt;
</span><span class="gi">+    pub text: String
</span> }

 impl Parameters for SendKeysParameters {
<span class="p">@@ -760,26 +760,14 @@</span>
         let data = try_opt!(body.as_object(),
                             ErrorStatus::InvalidArgument,
<span class="err">...</span>
-            Ok(chars[0])
<span class="gd">-        }).collect::&lt;Result&lt;Vec&lt;_&gt;, _&gt;&gt;());
</span><span class="gi">+        let text = try_opt!(try_opt!(data.get("text"),
</span><span class="err">...</span>
+            text: text.into()
         })
     }
 }
<span class="p">@@ -787,10 +775,7 @@</span>
 impl ToJson for SendKeysParameters {
     fn to_json(&amp;self) -&gt; Json {
         let mut data = BTreeMap::new();
<span class="gd">-        let value_string: Vec&lt;String&gt; = self.value.iter().map(|x| {
-            x.to_string()
-        }).collect();
-        data.insert("value".to_string(), value_string.to_json());
</span><span class="gi">+        data.insert("value".to_string(), self.text.to_json());
</span>         Json::Object(data)
     }
 }

</code></pre></div></div>

<p>Hold on, what was the purpose to change that field? Everything was working,
right? Who asked for that? Did the standard change? No, it’s still the same! Why
have you guys just changed the API? You could easily rewrite the code without
renaming “value” field into “text”.</p>

<p>Listen, I’ve already got three different versions of those API for Chrome,
Firefox and Safari. In addition to that, your force me to switch on version
inside Firefox branch turning my code into if/else hell.</p>

<p>From your perspectives, what’s the difference in processing either “value” or
“text” field? But for me, you’ve broken my software! It doesn’t work anymore.</p>

<p>I could not find a diff that would proof the fact of moving “sessionId” field
because the repo’s history is pretty complicated. But it’s easy to check that.
The version 0.17 returns:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"sessionId"</span><span class="p">:</span><span class="s2">"4decec3e-e564-b349-bb41-b27b5f307e01"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"value"</span><span class="p">:{</span><span class="w">
    </span><span class="nl">"acceptInsecureCerts"</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span><span class="w">
    </span><span class="nl">"browserName"</span><span class="p">:</span><span class="s2">"firefox"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"browserVersion"</span><span class="p">:</span><span class="s2">"52.0
    ...
</span></code></pre></div></div>

<p>whereas 0.13 returns:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="nl">"value"</span><span class="p">:{</span><span class="w">
  </span><span class="nl">"sessionId"</span><span class="p">:</span><span class="s2">"d0dc41f8-9c17-934e-be2b-708c72f0fb9c"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"capabilities"</span><span class="p">:{</span><span class="w">
    </span><span class="nl">"acceptInsecureCerts"</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span><span class="w">
    </span><span class="nl">"browserName"</span><span class="p">:</span><span class="s2">"firefox"</span><span class="p">,</span><span class="w">
    </span><span class="err">...</span><span class="w">
</span></code></pre></div></div>

<p>Look, they just wrapped the whole data into “value” subfield shifting it one
level below. Again, what was the purpose of doing this? Did you think of those
users who have already been using your code for some time?</p>

<p>Thanks to those weird changes, I need to refactor my code just because Mozilla
guys decided to rename something. And more over that, thank you for not sending
back the driver’s version in API responses. It would be not so challenging when
having it.</p>

<p>I wonder why has Chromedriver been working all that time without errors? It’s
written in <a href="https://github.com/bayandin/chromedriver/tree/master/client">C++ and Python</a> and the code is quite simple and
linear. And it’s much stable then its Rust-driven rival.</p>

<p>OK, it’s time to summarize all together. I don’t think that anybody will share
my misery on the subject. The Webdriver spec is quite specific thing, so who
would really care…</p>

<p>But the main point of that talk is you should never break backward capability
even at the gunpoint. Just keep things working, that’s the main priority when
you change something. Extend, but not truncate your product. And really, just
use it sometimes in a way that an ordinary user does.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/dr-video/">Последнее видео с Рефакторинга</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2017-11-07T00:00:00+00:00">
        Nov 7, 2017
    </time>

    <a href="/tag/deep/" rel="tag">deep</a>, <a href="/tag/refactoring/" rel="tag">refactoring</a>, <a href="/tag/video/" rel="tag">video</a>

</div>


            <div class="entry">
                
                    
<p>Клуб Рефакторинга живет и здравствует, хоть я и забываю репостить видео в
блоге. Вот пачка последних выступлений:</p>

<iframe width="640" height="360" src="https://www.youtube.com/embed/ENGUmiVgu9U" gesture="media" allowfullscreen=""></iframe>

<iframe width="640" height="360" src="https://www.youtube.com/embed/ZPH9q6dL7v8" gesture="media" allowfullscreen=""></iframe>

<iframe width="640" height="360" src="https://www.youtube.com/embed/g5NHNwLQpiA" gesture="media" allowfullscreen=""></iframe>

<iframe width="640" height="360" src="https://www.youtube.com/embed/W7hGBngO9bo" gesture="media" allowfullscreen=""></iframe>

<iframe width="640" height="360" src="https://www.youtube.com/embed/KqkkCgJP_80" gesture="media" allowfullscreen=""></iframe>

<p>Ссылки на слайды в описании к каждому видео. Больше записей на нашем
<a href="https://www.youtube.com/c/deeprefactoring">Ютуб-канале</a>.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/en/block/">Silent software</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2017-11-07T00:00:00+00:00">
        Nov 7, 2017
    </time>

    <a href="/tag/blocking/" rel="tag">blocking</a>, <a href="/tag/ad/" rel="tag">ad</a>, <a href="/tag/adblock/" rel="tag">adblock</a>

</div>


            <div class="entry">
                
                    <p>I really value such kind of software that does not interrupt you. It should have
happened to you I believe: you open a notebook when thouthands of notification
balloons appear above the lock screen. Icons are jumping, everything is
blinking. Or you open a program that immediately shows daily tips, asks for
updates and so forth. Once you’ve closed the last tooltip, you start recalling
what were you about to do with that program.</p>

<p>That was the reason I abandoned Firefox. Every its extension, when updated,
opened a new tab with release notes. So every time I opened a browser I had to
close those tabs I didn’t ask to open.</p>

<p>I’ve been fighting with that as I can for a long time. I turn off all the
notifications on both laptop and mobile phone. I cut unwilling elements with
Adblock and dump those patters into private Git repo. If a website doesn’t have
RSS feed I don’t use it. I read long texts only with Kindle.</p>

<p>I cut YouTube interface completely to see only a search bar and the video player
by itself. No recommended sidebar or comment feed.</p>

<p>When I open my laptop willing to send a email but some program prevents me from
that (no matter was is a notification or a sound) it’s a serious reason to stop
using it. If any site sticks a city selection or email subscription dialog
across the whole screen I close it. No worries, I’ll find another one even
better.</p>

<p>A rule of being not interrupted by software as important as a rule of being not
interrupted by other people. Everybody has a right to be alone.</p>

<p>I hope one day that simple thing will occur to those who develop software.</p>

                
            </div>

        </li>
        
    </ul>

    <h4>
        
        <a href="/page22" class="previous">&larr;</a>
        
        <span class="page_number ">Страница 23 из 58</span>
        
        <a href="/page24" class="next">&rarr;</a>
        
    </h4>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Ivan Grishaev's blog</li>
          <li><a href="mailto:ivan@grishaev.me">ivan@grishaev.me</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
            <li><a href="https://github.com/igrishaev">GitHub</a></li>
            <li><a href="tg://resolve?domain=igrishaev_blog">Telegram</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Writing on programming, education, books and negotiations.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
