<!DOCTYPE html>
<html lang="ru">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Ivan Grishaev's blog</title>
  <meta name="description" content="Writing on programming, education, books and negotiations.
">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/custom.css">
  <link rel="canonical" href="https://grishaev.me/page23/">
  <link rel="alternate" type="application/rss+xml" title="Ivan Grishaev's blog" href="https://grishaev.me/feed.xml">

  <link rel="shortcut icon" type="image/x-icon" href="/assets/static/favicons/favicon.ico">

  <script type="text/javascript" src="/assets/typo.js"></script>

</head>


  <body>
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-33533163-2', 'auto');
    ga('send', 'pageview');

</script>

    <header class="site-header">

    <div class="wrapper flex-container">

        <div>
            <a href="/">
                <img src="/assets/static/photo-round-small.png" alt="Ivan Grishaev">
            </a>
        </div>

        <div class="flex-container-vert" style="margin-left: 15px; width: 80%">

            <div class="flex-container full-width">
                <p style="margin-bottom: 5px">Ivan Grishaev's blog</p>
                <div class="flex-huge"></div>
                <div >
<form id="search-form"
      target="_blank"
      style="display: inline"
      method="get"
      action="https://www.google.com/search">

    <input name="sitesearch"
           value="grishaev.me"
           type="hidden">

    <input type="text"
           required="required"
           name="q"
           placeholder="Google search..."
           autocomplete="off">

    <button style="border: none; background-color: transparent; cursor: pointer;"
            type="submit">&#x1f50d;</button>

</form>
</div>
            </div>

            <p><small>Writing on programming, education, books and negotiations.
</small></p>

            <div class="flex-container">
                <a class="menu-item" href="/">Home</a>
                <a class="menu-item" href="/about/">About</a>
                <a class="menu-item" href="/bookshelf/">Bookshelf</a>
                <a class="menu-item" href="/feed.xml">RSS</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor" href="/tag/clojure/">Clojure</a>
                <a class="menu-item minor" href="/tag/emacs/">Emacs</a>
                <a class="menu-item minor" href="/tag/python/">Python</a>
                <a class="menu-item minor" href="/tag/programming/">Programming</a>
                <a class="menu-item minor" href="/interview/">Interview</a>
                <a class="menu-item minor" href="/video/">Video</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor hl" href="/clojure-in-prod/">Книга «Clojure на производстве»</a>
            </div>

        </div>
    </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="home">

    <ul class="post-list">
        
        <li>

            <h2>
                <a class="post-link" href="/meetup13/">Тринадцатая встреча</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2017-01-11T00:00:00+00:00">
        Jan 11, 2017
    </time>

    <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/meetup/" rel="tag">meetup</a>, <a href="/tag/deep-refactoring/" rel="tag">deep-refactoring</a>

</div>


            <div class="entry">
                
                    <p>Провели тринадцатую встречу.</p>

<p>Максим Поправко рассказал о трудностях с нереляционными базами:</p>

<iframe width="640" height="360" src="https://www.youtube.com/embed/28CFzsGj9KM" allowfullscreen=""></iframe>

<p><a href="http://www.slideshare.net/IvanGrishaev/nosql-pain">Слайды</a></p>

<p>Станислав Мехоношин выступил на тему деплоя и Докера:</p>

<iframe width="640" height="360" src="https://www.youtube.com/embed/YJ5uS95NV0s" allowfullscreen=""></iframe>

<p><a href="http://www.slideshare.net/IvanGrishaev/docker-70670637">Слайды</a></p>

<p>Ищем докладчиков на следующую встречу. Хотите выступить – пишите в личку или
<a href="https://telegram.me/deeprefactoring">чат Телеграма</a>.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/read-7/">Что почитать на праздниках №7</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2017-01-03T00:00:00+00:00">
        Jan 3, 2017
    </time>

    <a href="/tag/read/" rel="tag">read</a>, <a href="/tag/life/" rel="tag">life</a>

</div>


            <div class="entry">
                
                    <p>Выкладываю чуть побольше, чтобы хватило на всю неделю.</p>

<ul>
  <li>
    <p><a href="https://medium.com/startup-grind/fuck-you-startup-world-ab6cc72fad0e#.lf7tmvb48">Fuck You Startup World</a></p>

    <p>О том как заебали стартапы.</p>
  </li>
  <li>
    <p><a href="http://artgorbunov.ru/pufiki/proval-eto-horosho/">Провал — это хорошо</a></p>

    <p>Илья Синельников, мастер переговоров, объясняет странный, на первый взгляд,
тезис.</p>
  </li>
  <li>
    <p><a href="http://eax.me/benchmarks/">Почему на самом деле ваш бенчмарк — говно</a></p>

    <p>Александр рассказывает, почему бенчмарки не отражают реальную скорость языка.</p>
  </li>
  <li>
    <p><a href="http://www.yegor256.com/2017/01/03/how-much-you-love-conflicts.html">How Much Do You Love Conflict?</a></p>

    <p>Егор Бугаенко о конфликтах и переговорах.</p>
  </li>
</ul>

<p>Осторожно, Невзоров!</p>

<ul>
  <li>
    <p><a href="https://snob.ru/selected/entry/113577">Хлева и зрелищ, или Новые приключения девочки-верблюда</a></p>

    <p>Я просто оставлю это здесь.</p>
  </li>
</ul>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/2016/">Итоги 2016 года</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2016-12-31T00:00:00+00:00">
        Dec 31, 2016
    </time>

    <a href="/tag/2016/" rel="tag">2016</a>, <a href="/tag/results/" rel="tag">results</a>

</div>


            <div class="entry">
                
                    <p>Подвожу итоги уходящего года: что сделал, что осталось в планах.</p>

<ol>
  <li>
    <p>Блог. За 2016 год я написал 96 постов (включая этот). Если в году 53 недели,
получается почти по 2 поста в неделю. Неплохо держусь.</p>
  </li>
  <li>
    <p>Работа. Весь год я продолжаю работать на европейских заказчиков. На тему
удаленной работы я писал <a href="/remote">большой пост</a>. В Associated Press
<a href="/press">вышла статья</a> с моим скромным участием. В середине лета случилось
непредвиденное: попал в волну сокращений. Провел в поисках месяца три, весь
извелся, зато нашел такое, что лучше не придумаешь. Заодно получил нехилый
опыт поиска работы за рубежом, думаю отдельно написать.</p>

    <p>В середине лета снял клевый офис: светлый, одна из стен сплошное окно,
диванчик, кофе-машина. Всегда рад гостям. Сидим впятером, думаем над
расширением площади.</p>
  </li>
  <li>
    <p>Путешествия. Об увольнении я узнал будучи <a href="/tunisie">в Тунисе</a>. Первый раз в
жизни побывал на африканском континенте.</p>
  </li>
  <li>
    <p>Встречи. За год мы провели 12 встреч
<a href="https://telegram.me/deeprefactoring">Глубокого Рефакторинга</a>. Каждый месяц,
без срывов, переносов. Сколько было митапов в вашей фирме? Один? Два? А у нас
тринадцать.</p>
  </li>
  <li>
    <p>Волонтерство. Проводил слаконары для образовательного проекта
<a href="https://ru.hexlet.io/">Хекслет</a> на тему удаленной работы и Емакса. Слаконар
– это долгое выступление в Слаке на заданную тему с последующими вопросами
читателей. По архивам Слаки я воссоздал два поста: про
<a href="/remote">удаленную работу</a> и про <a href="/emacs-story">Емакс</a>.</p>
  </li>
  <li>
    <p>Опен-сорц. Летом, в перерывах между поисками работы, написал библиотечку <code class="highlighter-rouge">f</code>
для программирования в функциональном стиле на Питоне. Фактически это порт
базовых возможностей Кложи. У библиотеки 100 звезд на Гитхабе и ей никто не
пользуется. Мне было важно пройти весь путь от замысла до пакета на
Pypi. Говоря иначе, просто довести дело до конца. Ссылки:
<a href="https://github.com/igrishaev/f">исходники</a>,
<a href="https://habrahabr.ru/post/305750/">статья</a>,
<a href="https://pypi.python.org/pypi/f">пакет</a>.</p>
  </li>
  <li>
    <p>Гитхаб. Я стараюсь хранить данные в виде обычного текста, поэтому вынес
всякое барахло на Гитхаб. В связи с этим график заметно позеленел:</p>

    <p><img src="/assets/static/gh-chart.png" alt="gh-chart" /></p>
  </li>
  <li>
    <p>ФП. Глубже увлекся функциональным программированием. Написал заметки о
<a href="/code-data">макросах</a>, <a href="/clojure-win">преимуществах Кложи</a>,
<a href="/defmulti">мультиметодах</a>. Решил тестовое задание на
<a href="https://github.com/igrishaev/mars-task-haskell">Хаскеле</a>.</p>
  </li>
  <li>
    <p>Английский. Первую половину года подтягивал английский, случая ролики с
замедленным произношением. Написал пробный пост
<a href="/en/task">на английском языке</a>.</p>
  </li>
  <li>
    <p>Книги. Прочитал далеко не все, что планировал: книги начинают скапливаться
на полках. Осилил всего-то четыре: <a href="/atomic-scala">Atomic Scala</a>,
<a href="/goal-book">Цель</a>, <a href="/business-game">Бизнес как игра</a> и
<a href="/cljs-unraveled">ClojureScript Unraveled</a>.</p>

    <p>Начал вести рубрику “Что почитать на выходных”. Идею стырил у
Бирмана. Сделал 5 выпусков без сбоев, планирую продолжать.</p>

    <p>SICP так и остался недочитанным. Аналогично с альманахом Р. Душкина о
программировании на Хаскеле. Надеюсь добить в 2017.</p>
  </li>
</ol>

<p>Вот как я провел 2016 год. Спасибо всем, кто заходит на эту страничку. С
праздником, увидимся в 2017 году!</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/buy-car/">Покупка авто</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2016-12-30T00:00:00+00:00">
        Dec 30, 2016
    </time>

    <a href="/tag/buy/" rel="tag">buy</a>, <a href="/tag/car/" rel="tag">car</a>

</div>


            <div class="entry">
                
                    <p>Этим летом, будучи безработным, я купил машину, чтобы возить детей. В процессе
покупки набрался полезного опыта, которым хочу поделиться. Поскольку я неопытный
водитель, то искал авто с рук. Ниже – сумбурные заметки о том, как найти
хорошего продавца, провести встречи и оформить сделку.</p>

<p>Критерии обмана</p>

<ol>
  <li>
    <p>В объявлении указана заниженная цена, раза в 1.5-2 ниже рыночной. Продавец
аргументирует тем, что срочно нужны деньги. Не верьте: хорошие машины, как
правило, покупают очень быстро. Автомобилю в исправном состоянии не нужна
такая скидка.</p>
  </li>
  <li>
    <p>При малейших разговорах о предоплате и залоге прекращайте разговор. Деньги –
самый последний этап сделки. Разговорчики о том, что у продавца толпа
покупателей, готовых купить хоть сейчас – лишь способ выжать из вас нужду.</p>

    <p>С этим вообще беда, кстати. Почему-то люди думают, что любой
поинтересовавшийся – без пяти минут покупатель. Один продавец уверял, что
ему звонят каждые 10 минут, так всем нужна его машина. Не сомневаюсь, так и
было, но объявление висело на всех сайтах полгода.</p>

    <p>Возможно, когда продавец говорит, что у него много покупателей, он
действительно в это верит! Охладите его пыл: из ста позвонивших назначат
встечу пять, из этих пяти лишь один дойдет до этапа диагностики, и по ее
результатам, он, ВОЗМОЖНО, подумает, покупать или нет.</p>
  </li>
  <li>
    <p>Продавец отказывается предоставить ПТС. Тут важно следующее: объясните, что
не нужно привозить с собой оригинал, достаточно скинуть по почте или через
любой мессаджер качественный скан или фото документа с обеих сторон. Нет ПТС
– нет дальнейшего сотрудничества, вежливо отказывайтесь.</p>
  </li>
  <li>
    <p>Продавец интересуется, где вы находитесь. Это развод: после вашего ответа он
называет отдаленное место, откуда трудно добираться, и просит перевести на
карту тысячу на бензин.</p>
  </li>
  <li>
    <p>Салоны, организации и перекупы отклоняем. Просто потому, что вам продадут
отполированное битье. С организацией сложности правовые. Машина может быть
оформлена в лизинг, это такой вид кредита для юрлиц. Усложняется проверка
автомобиля. Допускается вариант, когда директор регистрирует машину на себя
как физлицо (или жену, родственника) и только потом вы ее покупаете.</p>
  </li>
  <li>
    <p>Продавец находится не в вашем городе. Междугородная покупка повышает все
риски. Это траты на дорогу, время, нервы. В чужом городе нет прежних связей и
контактов, чтобы обратиться за помощью к друзьям или знакомым. Часто человек
настолько измотан дорогой, что покупает не глядя. Бывает, сам видит, что
машина не стоила предприятия, но покупает, потому что жалко потраченных сил.</p>

    <p>Случаются откровенно бандитские схемы: у приезжего изымают под предлогом
паспорт и банально шантажируют. Совладать с такой ситуацией можно, но сложно:
вы понаехали в Москву, денег мало, скоро вечер, паспорта нет.</p>
  </li>
  <li>
    <p>В объявлении нет комментария продавца. Хороший продавец обязательно напишет
текстовое сопровождение к автомобилю. Пусть там будут тупые ошибки, вагон
смайликов – так даже лучше. Тот, кто действительно ездил на машине и
заботился о ней, не может не добавить слова от себя.</p>
  </li>
  <li>
    <p>При звонке продавец уточняет, насчет какой машины вы звоните. Этим грешат
агенты и перекупы, у которых по 3-4 авто в работе. Логично, что частник, у
которого одна машина, не будет уточнять марку. По этой же причине вы не
называете ее, когда звоните. Просто “я звоню по объявлению”.</p>
  </li>
  <li>
    <p>Продавец очень, очень занят, у него мало времени. Типичный способ вогнать вас
в нужду. Все заняты: и учитель, и директор филиала. Адекватный человек должен
понимать, что продажа авто потребует времени.</p>
  </li>
</ol>

<p>Порядок покупки</p>

<ol>
  <li>
    <p>Позвоните и расспросите все об автомобиле. Не соглашайтесь на отговорки “в
объявлении все написано”. Хороший частник всегда любит почесать языком о
собственном авто. В разговоре часто проскакивают детали, которых не было в
объявлении: царапина здесь, скол там. Вы не перебиваете, пусть говорит пока
не устанет. Бывало, что из откровенного разговора становилось ясно, что
машина – не мой вариант, даже если объявление смотрелось идеально.</p>
  </li>
  <li>
    <p>Если из разговора все норм, попросите скинуть скан ПТС. Желательно должен
быть один владелец не считая автосалона. ПТС не должен быть копией. Да,
всякое бывает: потерял, промочил, жена постирала. Но чаще это означает
прохладные схемы с автомобилем.</p>

    <p>ВИН-номер должен быть четко виден. Этот номер вы пробиваете на сайте
ГИБДД. Не должно быть ДТП, автокредитов, угонов, розысков. В нижней части
страницы находятся ссылки на страховые компании, где по номеру автомобиля
можно пробить схожие данные: кредиты и тд.</p>
  </li>
  <li>
    <p>Если ПТС и ГИБДД не выявили проблем, договаривайтесь о встрече сначала просто
посмотреть, а потом в диагностическом центре. Это не должно быть тем местом,
которое предлагает продавец: у него могут быть связи. Некоторые думают, что
диагностика – это обязательно загон на яму. Вовсе не обязательно: достаточно
много подвохов можно выявить внимательным осмотром.</p>

    <p>Поэтому хороший специалист не спешит лезть под машину. Первичный осмотр
включает в себя проверку документов (ПТС, сервисная книжка), проход
толщинометром по периметру через каждые 10 см (битье, покрас), осмотр стекол,
всех болтов. Болты должны быть залиты краской. Скол краски возле головки
болта означает, что его откручивали, например, меняли дверь. Пальцем
пробуется износ тормозных колодок, он должен соответствовать пробегу.</p>

    <p>Все это должен делать, конечно, специально обученный человек, а не вы. Но
ближе к концу я тоже стал кое-что понимать.</p>
  </li>
  <li>
    <p>Если и первичный осмотр не выявил проблем, садите специалиста в машину и
едете 200-300 метров. Не должно ничего стучать. Если после проезда нет
претензий, ставить авто на яму уже не обязательно: серьезные трудности должны
были быть выявлены заранее. Но можно и загнать, если есть время.</p>
  </li>
  <li>
    <p>Поскольку диагностика стоит денег, логично договориться заранее, кто за нее
платит. В моем случае всегда платил я, потому что именно я в ней
заинтересован. С другой стороны, даже в случае отказа от покупки продавец
получит официальный документ и карту диагностики с печатями, которую можно
будут показать другим покупателям.</p>
  </li>
  <li>
    <p>Неопытный продавец может думать, что диагностика – это быстро. Предупредите,
что потребуется 2-3 часа его времени, так что лучше отпроситься с
работы. Так, с одним продавцом пришлось расстаться, так как он тупо ныл, что
не успевает.</p>
  </li>
  <li>
    <p>Если и диагностика прошла ок, оформляете на нейтральной территории три
договора купли-продажи авто. Это не должна быть фирма-однодневка или приятели
продавца. Это не должен быть какой-то левый бланк, стыренный из
интернета. Договор стоит 1 т.р, расходы пополам. В моем случае договор
составили прямо на диагностике. В договорах ставят печати, но расписываться
нигде не нужно! Сделаете это в момент передачи денег.</p>
  </li>
  <li>
    <p>Никакого нала с собой. Все деньги лежат у вас в Сбербанке. Причем не на
зарплатной карте, а выделенном счете, который не видно в мобильном
банке. Направляетесь в Сбер, берете билетик в кассу, заходите вдвоем. В кассе
пишутся видео и звук. Переводите деньги на счет продавца (счет тут же
откроют, если у него нет). Не выходя из кассы, расписываетесь в договорах и
ПТС. Подпись прежнего владельца в ПТС обязательна, в противном случае
документы не возьмут в ГАИ.</p>
  </li>
</ol>

<p>Ну вот вы и купили авто, поздравляю! Дальнейшие шаги типа регистрации в ГАИ
описывать не буду, потому что статья скорее о покупке и всему, что ей
предшествует.</p>

<p>Хоть я неопытный водитель и брал подержанную машину, описанное выше пригодится и
при покупке нового авто. Потому что никто не застрахован от
случайностей. Директор фирмы, где я проходил диагностику, рассказывал, как
осматривал новую машину. Болты на боковой стойке были скручены. Оказалось, при
разгрузке с поезда помяли дверь и оперативно поменяли на новую с выставочного
образца. Так что в салон тоже нужно брать обученного человека.</p>

<p>Почему-то некоторые думают, что обманывают только лохов и неудачников, а с ними,
такими крутыми и прошаренными, ничего не случится. Но вот что: мой дальний
родственник купил спорткар за миллион, а он угнанный. Изъяли прямо в ГАИ,
продавца не нашли. Недавно ехал в такси, водитель трепался по телефону о том,
как поедет в ночь в Москву покупать родственникам машину. Что он там купит ночью
после 6 часов за рулем?</p>

<p>Может показаться, что пост – сплошное капитанство. Я не ставлю цель кого-то
поучать, всего лишь делюсь полученным опытом. Перечисленные советы я собирал по
отдельности из интернета и практики. Буду рад мнениям из комментариев.</p>

<p>С наступающим!</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/defmulti/">Мультиметоды в Кложе</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2016-12-29T00:00:00+00:00">
        Dec 29, 2016
    </time>

    <a href="/tag/clojure/" rel="tag">clojure</a>

</div>


            <div class="entry">
                
                    <p>Возможно, я упоминал, что недавно сменил проект и теперь пишу на Кложе. Это
современный диалект Лиспа под Джава-машину. Кложа довольно проста, и многие
задачи в ней решаются исключительно функциями и коллекциями. Так, на
собеседованиях в проект я беседовал с разработчиками, которые ничего кроме
словарей и коробочных функций не знали.</p>

<p>Не скажу, чтобы это плохо: язык должен быть простым. Чем меньше правил и
бест-практик нужно помнить, тем легче на нем писать. Однако, есть в Кложе
классные штуки, точечное применение которых сэкономит время и объем кода.</p>

<p>С сегодняшнего для я решил коротко описывать Кложные фишки, на изучение которых
вечно не хватает времени. В сегодняшнем выпуске речь пойдет о мультиметодах. Но
сначала коротко о том, что такое мультиметоды вообще.</p>

<p>Мы знаем, что ООП базируется на инкапсуляции, наследовании и
полиморфизме. Рассмотрим последний. Полиморфизм – это когда у метода может быть
несколько реализаций. Конкретная реализация выбирается в зависимости от типов
параметров.</p>

<p>В классическом ООП нам бы привели такой пример. У класса <code class="highlighter-rouge">Geometry</code> есть метод
square для вычисления фигур. На вход могут подать окружность, квадрат и
треугольник. Запишу на каком-то выдуманном языке:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class Geometry:

    real square(Circle c):
        return Math.PI * c.radius * c.radius;

    real square(Rectangle rect):
        return rect.a * rect.b;

    real square(Triangle tri):
        real p = (tri.a + tri.b + tri.c) / 2;
        return Math.sqrt(p * (p - tri.a) * (p - tri.b) * (p - tri.c))
</code></pre></div></div>

<p>В зависимости от типа фигуры подбирается нужный метод. Не может быть два метода
с одинаковым набором параметров, даже если их имена различаются. Если передать
совершенно другой объект, например, <code class="highlighter-rouge">Rombus</code>, будет ошибка, причем еще на этапе
компиляции.</p>

<p>Уверен, каждый помнит это с университетских времен. Но полиморфизм на типах –
всего лишь частный случай мультиметодов. В отличии от полиморфизма, мультиметоды
не прибиты гвоздями к ООП, а значит, дают б<strong>о</strong>льшую свободу в идеи и
реализации.</p>

<p>Для адептов ООП это, возможно, прозвучит сюпризом, но мультиметоды существуют во
многих языках, в т.ч. в которых объектов не существует. Почти любой
функциональный язык поддерживает множественные <em>клозы (clause)</em> для функций. Но
если в ООП все сводится к типам, то в функциональных языках действует более
мощный механизм подбора основанный на паттерн-матчинге.</p>

<p>Рассмотрим Хаскель. То, что выше я записал на выдуманном языке, в Хаскеле будет
так:</p>

<div class="language-haskell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">data</span> <span class="kt">Circle</span> <span class="o">=</span> <span class="kt">Circle</span> <span class="kt">Float</span>
<span class="kr">data</span> <span class="kt">Rectangle</span> <span class="o">=</span> <span class="kt">Rectangle</span> <span class="kt">Float</span> <span class="kt">Float</span>
<span class="kr">data</span> <span class="kt">Triangle</span> <span class="o">=</span> <span class="kt">Triangle</span> <span class="kt">Float</span> <span class="kt">Float</span> <span class="kt">Float</span>

<span class="n">square</span> <span class="o">::</span> <span class="kt">Circle</span> <span class="o">-&gt;</span> <span class="kt">Float</span>
<span class="n">square</span> <span class="p">(</span><span class="kt">Circle</span> <span class="n">r</span><span class="p">)</span> <span class="o">=</span> <span class="mf">3.1415</span> <span class="o">*</span> <span class="n">r</span> <span class="o">*</span> <span class="n">r</span>

<span class="n">square</span> <span class="o">::</span> <span class="kt">Rectangle</span> <span class="o">-&gt;</span> <span class="kt">Float</span>
<span class="n">square</span> <span class="p">(</span><span class="kt">Rectangle</span> <span class="n">a</span> <span class="n">b</span><span class="p">)</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="n">b</span>

<span class="n">square</span> <span class="o">::</span> <span class="kt">Triangle</span> <span class="o">-&gt;</span> <span class="kt">Float</span>
<span class="n">square</span> <span class="p">(</span><span class="kt">Triangle</span> <span class="n">a</span> <span class="n">b</span> <span class="n">c</span><span class="p">)</span> <span class="o">=</span> <span class="n">sqrt</span> <span class="o">$</span> <span class="n">p</span> <span class="o">*</span> <span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="n">a</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="n">b</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="n">c</span><span class="p">)</span>
<span class="kr">where</span>
  <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="o">+</span> <span class="n">c</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
</code></pre></div></div>

<p>Видно, что функция <code class="highlighter-rouge">square</code> работает с типами окружность, прямоугольник,
треугольник. В любой момент мы можем дополнить ее новой фигурой.</p>

<p>Есть мультиметоды и в классических диалектах Лиспа. Вот, например, копипаста из
Википедии, взятая из кода Астероидов:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(defmethod collide-with ((x asteroid) (y asteroid))
   ;; deal with asteroid hitting asteroid
   )
 (defmethod collide-with ((x asteroid) (y spaceship))
   ;; deal with asteroid hitting spaceship
   )
 (defmethod collide-with ((x spaceship) (y asteroid))
   ;; deal with spaceship hitting asteroid
   )
 (defmethod collide-with ((x spaceship) (y spaceship))
   ;; deal with spaceship hitting spaceship
   )
</code></pre></div></div>

<p>Особенность примера с Лиспом в том, что второй параметр в каждой паре ведет себя
как предикат. В данном случае тип <code class="highlighter-rouge">spaceship</code> срабатывает как проверка того, что
<code class="highlighter-rouge">x</code> – экземпляр космического корабля. Однако, вместо <code class="highlighter-rouge">spaceship</code> можно передать
другие проверки: <code class="highlighter-rouge">integer?</code>, <code class="highlighter-rouge">string?</code>, <code class="highlighter-rouge">even?</code>, словом, любой унарный предикат.</p>

<p>Столь гибкая система мультиметодов позволяет определить разное поведение для
одного и того же типа, но разных значений. Например, для отрицательной суммы
денег одно поведение, для нуля – второе, для положительной – третье. Для даты:
выходной или нет, високосный год или нет и т.д.</p>

<p>Думаю, ясно теперь, чем это выгодней банального полиморфизма на типах.</p>

<p>В Кложе более гибкая система мультиметодов. В рассмотренных выше примерах мы не
могли изменить сам принцип подбора метода, или диспатча. В Кложе, наоборот, <em>вы
обязаны</em> определить диспатч! Рассмотрим пример:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">defmulti</span><span class="w"> </span><span class="n">foo</span><span class="w"> </span><span class="nb">class</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>Данное определение говорит: прежде чем искать реализацию, метод получит класс
аргумента.</p>

<p>Следующее определение <strong>расширяет</strong> мульти-метод реализацией для <code class="highlighter-rouge">Long</code>: если
передано длинное целое, получим строку <code class="highlighter-rouge">"an integer"</code>.</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">&gt;</span><span class="w"> </span><span class="p">(</span><span class="k">defmethod</span><span class="w"> </span><span class="n">foo</span><span class="w"> </span><span class="n">Long</span><span class="w"> </span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="w"> </span><span class="s">"an integer"</span><span class="p">)</span><span class="w">
</span><span class="o">#</span><span class="n">multifn</span><span class="p">[</span><span class="n">foo</span><span class="w"> </span><span class="mi">0</span><span class="n">x478c7d41</span><span class="p">]</span><span class="w">
</span><span class="nb">&gt;</span><span class="w"> </span><span class="p">(</span><span class="nf">foo</span><span class="w"> </span><span class="mi">42</span><span class="p">)</span><span class="w">
</span><span class="s">"an integer"</span><span class="w">
</span></code></pre></div></div>

<p>Добавим для строки:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">&gt;</span><span class="w"> </span><span class="p">(</span><span class="k">defmethod</span><span class="w"> </span><span class="n">foo</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="nf">format</span><span class="w"> </span><span class="s">"%s is a string"</span><span class="w"> </span><span class="n">x</span><span class="p">))</span><span class="w">
</span><span class="o">#</span><span class="n">multifn</span><span class="p">[</span><span class="n">foo</span><span class="w"> </span><span class="mi">0</span><span class="n">x478c7d41</span><span class="p">]</span><span class="w">
</span><span class="nb">&gt;</span><span class="w"> </span><span class="p">(</span><span class="nf">foo</span><span class="w"> </span><span class="s">"test"</span><span class="p">)</span><span class="w">
</span><span class="s">"test is a string"</span><span class="w">
</span></code></pre></div></div>

<p>Если ни одно соответствие не подошло, будет ошибка:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">&gt;</span><span class="w"> </span><span class="p">(</span><span class="nf">foo</span><span class="w"> </span><span class="n">nil</span><span class="p">)</span><span class="w">
</span><span class="n">IllegalArgumentException</span><span class="w"> </span><span class="n">No</span><span class="w"> </span><span class="n">method</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">multimethod</span><span class="w"> </span><span class="ss">'foo</span><span class="o">'</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">dispatch</span><span class="w"> </span><span class="n">value</span><span class="err">:</span><span class="w"> </span><span class="n">null</span><span class="w">
</span><span class="n">clojure.lang.MultiFn.getFn</span><span class="w"> </span><span class="p">(</span><span class="nf">MultiFn.java</span><span class="no">:156</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>Не страшно, добавим реализацию по умолчанию:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">&gt;</span><span class="w"> </span><span class="p">(</span><span class="k">defmethod</span><span class="w"> </span><span class="n">foo</span><span class="w"> </span><span class="no">:default</span><span class="w"> </span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="nf">format</span><span class="w"> </span><span class="s">"you passed %s"</span><span class="w"> </span><span class="n">x</span><span class="p">))</span><span class="w">
</span><span class="nb">&gt;</span><span class="w"> </span><span class="p">(</span><span class="nf">foo</span><span class="w"> </span><span class="n">nil</span><span class="p">)</span><span class="w">
</span><span class="s">"you passed null"</span><span class="w">
</span></code></pre></div></div>

<p>Диспатч может работать самым разным способом, например, проверять на типы все
аргументы. Повторим пример с площадью фигур:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">defmulti</span><span class="w"> </span><span class="n">square</span><span class="w"> </span><span class="p">(</span><span class="k">fn</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="w"> </span><span class="n">args</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="nf">mapv</span><span class="w"> </span><span class="nb">class</span><span class="w"> </span><span class="n">args</span><span class="p">)))</span><span class="w">

</span><span class="c1">;; rectangle</span><span class="w">
</span><span class="p">(</span><span class="k">defmethod</span><span class="w"> </span><span class="n">square</span><span class="w"> </span><span class="p">[</span><span class="n">Long</span><span class="w"> </span><span class="n">Long</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">))</span><span class="w">
</span><span class="p">(</span><span class="nf">square</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="c1">;; 6</span><span class="w">

</span><span class="c1">;; circle</span><span class="w">
</span><span class="p">(</span><span class="k">defmethod</span><span class="w"> </span><span class="n">square</span><span class="w"> </span><span class="p">[</span><span class="n">Double</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="n">r</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">Math/PI</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="n">r</span><span class="p">))</span><span class="w">
</span><span class="p">(</span><span class="nf">square</span><span class="w"> </span><span class="mf">1.1</span><span class="p">)</span><span class="w"> </span><span class="c1">;; 3.8013271108436504</span><span class="w">

</span><span class="c1">;; triangle</span><span class="w">
</span><span class="p">(</span><span class="k">defmethod</span><span class="w"> </span><span class="n">square</span><span class="w"> </span><span class="p">[</span><span class="n">Long</span><span class="w"> </span><span class="n">Long</span><span class="w"> </span><span class="n">Long</span><span class="p">]</span><span class="w">
               </span><span class="p">[</span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="n">c</span><span class="p">]</span><span class="w">
               </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">p</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="mi">2</span><span class="p">)]</span><span class="w">
                 </span><span class="p">(</span><span class="nf">Math/sqrt</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="n">c</span><span class="p">)))))</span><span class="w">
</span><span class="p">(</span><span class="nf">square</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="c1">;; 1.7320508075688772</span><span class="w">
</span></code></pre></div></div>

<p>Замечу, что на самом деле Кложа проверяет значения диспатча и образца не простым
сравнением, а функцией <code class="highlighter-rouge">isa?</code>, что подразумевает иерархию. Так, чтобы проверку
проходили типы <code class="highlighter-rouge">PersistentArrayMap</code> и <code class="highlighter-rouge">PersistentHashMap</code>, достаточно указать
базовый класс <code class="highlighter-rouge">clojure.lang.APersistentMap</code>.</p>

<p>Наконец, проверять можно не только на типы, а банально на значения, диапазоны,
предикаты и тд. В текущем проекте я проверяю последний переданный аргумент. Это
может быть как айдишка, так и запись БД. В зависимости от этого условия
срабатывает разная логика.</p>

<p>Каждый мультиметод может вызвать внутри другой, тогда процесс диспатча начнется
заново.</p>

<p>Мультиметоды в Кложе отличаются еще и тем, что расширяемы извне. Это значит,
если разработчик определил мультиметод для определенных типов, ничто не мешает
расширить его до других типов. И это будет все тот же экземпляр.</p>

<p>Напомню ситуацию с примерами на Джаве и Хаскеле выше. Пусть фукция <code class="highlighter-rouge">square</code> и
класс <code class="highlighter-rouge">Geometry</code> находятся в чужих библиотеах. Тогда вы никак не сможете
изменить их! В лучшем случае вы унаследуете класс <code class="highlighter-rouge">Geometry</code>, добавите свой
метод для ромба. Но если есть еще одна библиотека, которая работает с
<code class="highlighter-rouge">Geometry</code>, <em>вы никак не сможете на это повлиять</em>.</p>

<p>Напротив, идея расширения чужих определений работает в Кложе просто
убийственно. Я нигде не видел ничего подобного.</p>

<p>В Кложе мультиметоды используют когда трудно предугадать, какие типы данных
будут поступать на вход. Это прекрасное решение для абстракций вроде работы с
БД, парсингом данных, декораторов и тд.</p>

<p>Мультиметоды в Лиспах – мощнейшей инструмент, порой в корне меняющий принцип
мышления и разработки.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/read-6/">Что почитать на выходных №6</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2016-12-23T00:00:00+00:00">
        Dec 23, 2016
    </time>

    <a href="/tag/read/" rel="tag">read</a>, <a href="/tag/life/" rel="tag">life</a>, <a href="/tag/python/" rel="tag">python</a>

</div>


            <div class="entry">
                
                    <p>С опозданием, но все же:</p>

<ul>
  <li>
    <p>Вышел Питон
3.6. <a href="https://habrahabr.ru/company/kingservers/blog/318354/">Статья на Хабре</a>
и раздел на
<a href="https://docs.python.org/3.6/whatsnew/3.6.html">официальном сайте</a>. Очень рад
за развитие языка.</p>
  </li>
  <li>
    <p><a href="http://blog.cognitect.com/blog/2016/12/13/the-next-five-years-of-clojurescript">The Next Five Years Of Clojurescript</a></p>

    <p>Небольшая заметка к <a href="https://www.youtube.com/watch?v=mty0RwkPmE8">одноименному видео</a>.</p>
  </li>
  <li>
    <p><a href="http://maximilyahov.ru/blog/all/fearmongering/">Вангующие аналитики и страх</a></p>

    <p>Максим Ильяхов о пользе для читателя. Очень сильная статья. Приятно, когда в
голове вертится, а потом кто-то умный раз – и сформировал.</p>
  </li>
</ul>

<p>И конечно:</p>

<ul>
  <li><a href="https://daily.afisha.ru/relationship/3186-ya-perestal-obschatsya-s-druzyami-chto-delat-esli-porno-meshaet-vam-zhit/">Клуб анонимных порноголиков: что делать, если порнография мешает вам жить</a></li>
</ul>

<p>«Афиша Daily» поговорила с людьми, которые считают себя зависимыми от
порнографии, и расспросила психотерапевтов о том, как порно влияет на нашу жизнь
и как контролировать это влияние.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/cors/">Руководство по кросс-доменным запросам (CORS)</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2016-12-18T00:00:00+00:00">
        Dec 18, 2016
    </time>

    <a href="/tag/cors/" rel="tag">cors</a>, <a href="/tag/html/" rel="tag">html</a>, <a href="/tag/ajax/" rel="tag">ajax</a>, <a href="/tag/json/" rel="tag">json</a>

</div>


            <div class="entry">
                
                    <p>На прошлой неделе я внедрял в проект CORS-запросы – современный способ
кросс-доменного Аякса. По следам прочитанной документации и набитых шишек
подготовил небольшой мануал. Это вольный пересказ англоязычных статей, вопросов
со Стека и скромный личный опыт.</p>

<p>Но сначала короткая предыстория. Я неравнодушен к собеседованиям, как вы,
наверное, знаете. Чаще я собеседовал бекенд, т.к. к фронтенду отношусь
прохладно. Но тема фронтенда обладает огромным потенциалом для оценки уровня
кандидата. Я считаю, что разработчик должен в деталях понимать протокол HTTP и
тонкости работы браузера.</p>

<p>Один из вопросов на тему фронтенда звучит банально: как на клиенте получить
данные с другого домена?</p>

<p>Некоторые кандидаты отвечают, что проблемы нет, достаточно выполнить
Аякс-запрос. И с большим удивлением узнают, что, оказывается, нельзя: сработают
какие-то там политики безопасности.</p>

<p>Один собеседуемый заявил, что в Фаерфоксе это работает, достаточно зайти на
страницу для разработчиков и что-то там переключить. Я не против такого
ответа. Следующий вопрос, как вы заставите всех пользователей установить именно
Фаерфокс и поменять системный флаг?</p>

<p>С понятием JSONP вообще беда – никто не может объяснить, как это
устроено. Разработчики думают, что это обычный Аякс, только с каким-то P на
конце, то ли баг, то ли фича. А это вообще ни разу не Аякс.</p>

<p>Аббревиатура CORS появилась недавно, и спрашивать о ней нет смысла. Этот пробел
восполняет данный мануал.</p>

<p>Разберем вопросы из предыдущих абзацев. Действительно, слать Аякс-запросы к
серверам с другим доменом запрещено на уровне браузера. Однако, в интернете
полно сайтов, где значимая часть контента подгружается со сторонних
серверов. Например, этот блог работает на статичном генераторе
<a href="/jekyll">Jekyll</a>, в котором нет комментариев. Делиться мнениями помогает сервис
<a href="https://disqus.com/">Discuss</a>: лента комментариев встраивается
Джаваскриптом. Получая и отправляя комментарии, вы взаимодействуете с серверами
Discuss, а мой блог вообще ни при чем. Значит, слать запросы Аяксом все же
можно?</p>

<p>Нет, здесь работает JSONP. Аббревиатура значит JSON with Padding (с
подкладкой). Идея основана на лазейке в стандартах: загружать скрипты с других
доменов не запрещено! Скажем, если в файле <code class="highlighter-rouge">example.js</code> на чужом сервере
написано что-то вроде:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">alert</span><span class="p">(</span><span class="s2">"hello!"</span><span class="p">);</span>
</code></pre></div></div>

<p>, то достаточно подгрузить его тегом <code class="highlighter-rouge">&lt;script&gt;</code> на страницу:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"http://example.com/static/example.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
</code></pre></div></div>

<p>и браузер выполнит все, что внутри. В данном случае покажет окошко.</p>

<p>Предположим теперь, что сервер отдает не статичный файл, а генерит его
динамически в зависимости от параметров. Например, мы добавляем на страницу
скрипт с адресом:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;script
</span><span class="na">src=</span><span class="s">"http://example.com/api.js?method=get_user&amp;user_id=42&amp;callback=processUser"</span>
<span class="nt">&gt;&lt;/script&gt;</span>
</code></pre></div></div>

<p>В переменой <code class="highlighter-rouge">method</code> указываем, какое действие требуем от сервера. В данном
случае, получить пользователя по идентификатору. Айдишку передаем следующим
параметром <code class="highlighter-rouge">user_id</code>. Пусть такой пользователь найден на сервере, теперь его
нужно отдать клиенту. Если просто выплюнуть объект:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="nl">name</span><span class="p">:</span> <span class="s2">"Ivan"</span><span class="p">,</span> <span class="nx">age</span><span class="p">:</span> <span class="mi">30</span><span class="p">}</span>
</code></pre></div></div>

<p>, то на клиенте ничего не произойдет: объект просто считается в память. Именно
поэтому передают третий параметр <code class="highlighter-rouge">callback</code> – имя функции, объявленной на
клиенте, в которую нужно завернуть пользователя. С этим параметром ответ станет
другим:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">processUser</span><span class="p">({</span>
    <span class="na">name</span><span class="p">:</span> <span class="s2">"Ivan"</span><span class="p">,</span>
    <span class="na">age</span><span class="p">:</span> <span class="mi">30</span>
<span class="p">});</span>
</code></pre></div></div>

<p>На клиенте отработает код, зашитый в функцию <code class="highlighter-rouge">processUser</code>: вывести данные в
консоль, отрисовать виджет и т.д. Вот как работает JSONP.</p>

<p>Теперь, имея полную картину, нельзя не признать, что технология очень
крива. Прежде всего, это лазейка, костыль. Разработчики стандартов просто не
были настолько хитры, чтобы предугадать динамическое взаимодействие на уровне
скриптов.</p>

<p>Далее, подгрузка скриптов ни разу не безопасней, чем Аякс. Целое семейство
вирусов занимается тем, что добавляет на страницу браузера скрипты для отрисовки
баннеров порно и казино. Когда вы подключаетесь к интернету через мобильных
операторов, обсосы вставляют в HTML-трафик скрипты для отрисовки виджетов (если
соединение не HTTPS).</p>

<p>JSONP работает только методом GET, что сводит на нет возможности
REST-интерфейса. Для REST-сервисов приходится писать прокладки-прокси,
т.е. множить костыли.</p>

<p>Добавив скрипт на страницу, в дальнейшем вы не можете отследить его судьбу. Если
у Аякс-запроса есть специальные коллбеки для основных событий (начало, удачное
завершение, таймаут, неудачное завершение), то у скрипта ничего такого
нет. Загрузился ли он? Ответил ли сервер? Была ли ошибка? Никто не знает.</p>

<p>Ясно, что в 2016 году приложениям на js нужен надежный способ забирать данные с
серверов. Чтобы это была законно, а не по-воровски в обход протоколов и
стандартов. Таким способом стал <code class="highlighter-rouge">CORS</code> – <code class="highlighter-rouge">Cross-Origin Resource Sharing</code>,
кросс-доменные запросы.</p>

<p>Идея проста – пусть клиент шлет Аякс-запрос к чужому серверу. Браузер добавит в
запрос особые заголовки с информацией о том, что запрос с другого домена. На их
основании сервер решит, как обрабатывать такой запрос, и добавит особые
заголовки в ответ. Удобно, правда?</p>

<p>Техническая реализация несколько сложнее. Стандарт CORS различает “простые” и
“сложные” запросы. Простым считается запрос методами:</p>

<ul>
  <li>HEAD</li>
  <li>GET</li>
  <li>POST</li>
</ul>

<p>и заголовками:</p>

<ul>
  <li>Accept</li>
  <li>Accept-Language</li>
  <li>Content-Language</li>
  <li>Last-Event-ID</li>
  <li>Content-Type, <strong>но только со значениями:</strong>
    <ul>
      <li>application/x-www-form-urlencoded</li>
      <li>multipart/form-data</li>
      <li>text/plain</li>
    </ul>
  </li>
</ul>

<p>Если ваш запрос удовлетворяет этим критериям, можно слать Аякс к другому домену
из любого современного браузера. При этом браузер добавит заголовок <code class="highlighter-rouge">Origin</code> с
адресом страницы, откуда инициирован запрос. Подделать заголовок скриптом не
удастся.</p>

<p>Сервер, получив на обработку подобный запрос, должен прочесть Origin и решить,
как его обрабатывать. Заголовок ответа <code class="highlighter-rouge">Access-Control-Allow-Origin</code> регулирует,
с какого домена разрешено запрашивать данные. Это может быть как веб-адрес, так
и знак астерикса (звездочки), если разрешено всем. Несколько разных адресов
через запятую, к сожалению, не поддерживаются.</p>

<p>Пример CORS-запроса:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST /foo/bar HTTP/1.1
Origin: http://foreign.com
Host: test.com
</code></pre></div></div>

<p>и ответа с разрешением на получение данных:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>200 OK HTTP/1.1
Access-Control-Allow-Origin: http://foreign.com
Content-Type: text/html; charset=utf-8

&lt;h1&gt;Welldone&lt;/h1&gt;
</code></pre></div></div>

<p>Обратите внимание на такую вещь: мы намерены использовать CORS, чтобы дергать
чужие API. С вероятностью почти 100% они работают по протоколу <code class="highlighter-rouge">JSON</code>, то есть
принимают и отдают заголовок <code class="highlighter-rouge">Content-Type: application/json</code>. Вроде бы мелочь,
но такой запрос автоматом перестает быть простым и переходит в разряд “сложных”,
где схема взаимодействия иная.</p>

<p>Сложные запросы <strong>проходят в два этапа</strong>. Сначала браузер делает запрос по тому
же урлу, но методом <code class="highlighter-rouge">OPTIONS</code>. Сервер должен ответить: какими другими методами и
дополнительными заголовками (помимо стандартных) можно обращаться к этому
урлу. И только получив разрешение, браузер сделает запрос на основной урл.</p>

<p>При этом браузер не дурак и все запомнит: если разрешили только методы GET и
POST, то PUT и DELETE не сработают. Аналогично с заголовками: если помимо
стандартных разрешено использовать только <code class="highlighter-rouge">Authorization</code>, то нужно передать его
и ничего другого.</p>

<p>Пример сложного запроса:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>OPTIONS /cors HTTP/1.1
Origin: http://api.bob.com
Access-Control-Request-Method: PUT
Access-Control-Request-Headers: X-Custom-Header
Host: api.alice.com
Accept-Language: en-US
Connection: keep-alive
User-Agent: Mozilla/5.0...
</code></pre></div></div>

<p>Клиент хотел отправить Аяксом запрос методом <code class="highlighter-rouge">PUT</code> на урл
<code class="highlighter-rouge">http://api.alice.com/cors</code> с сайта <code class="highlighter-rouge">http://api.bob.com</code>. Поскольку это сложный
запрос, браузер запросил разрешение: типа, хочу сделать PUT на этот урл с особым
заголовком <code class="highlighter-rouge">X-Custom-Header</code>. Сервер ему на это:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>200 OK HTTP/1.1
Access-Control-Allow-Origin: http://api.bob.com
Access-Control-Allow-Methods: GET, POST, PUT
Access-Control-Allow-Headers: X-Custom-Header
Content-Type: text/html; charset=utf-8
</code></pre></div></div>

<p>Или иными слвами: разрешено ходить методами GET, POST, PUT и с заголовком
X-Custom-Header. Это подходит под критерии первоначального запроса. Браузер
делает второй запрос куда мы намеревались вначале.</p>

<p>Первая стадия, когда делается запрос OPTION, официально называется <code class="highlighter-rouge">preflight
request</code>. Надо сказать, такое взаимодействие весьма прозрачно отражается в
браузере. Например, в консоли разработчика в Хроме видны оба запроса со всеми
заголовками.</p>

<p>Вот такие строгости. В нашем проекте API на стороне сервера требует заголовки
Version (версия операции), Authorization (авторизация по токену) и Content-Type
(JSON), поэтому в ответе указываем</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Access-Control-Allow-Headers: Version, Authorization, Content-Type
</code></pre></div></div>

<p>, иначе запрос не пройдет.</p>

<p>Теперь все это можно протестировать. Запускаем локальный сервер, открываем
консоль Хрома и пишем:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">xhr</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">();</span>
<span class="nx">xhr</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s2">"GET"</span><span class="p">,</span> <span class="s2">"http://127.0.0.1:5000/api/users"</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
<span class="nx">xhr</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="s2">"authorization"</span><span class="p">,</span> <span class="s2">"Token xxxxxx"</span><span class="p">);</span>
<span class="nx">xhr</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="s2">"Version"</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">);</span>
<span class="nx">xhr</span><span class="p">.</span><span class="nx">send</span><span class="p">();</span>
<span class="nx">xhr</span><span class="p">.</span><span class="nx">responseText</span>
<span class="o">&gt;&gt;</span> <span class="s2">"{"</span><span class="nx">users</span><span class="s2">":[{name "</span><span class="nx">Ivan</span><span class="s2">"...
</span></code></pre></div></div>

<p>Забавно, что заголовок <code class="highlighter-rouge">Origin</code> в этом случае будет равен <code class="highlighter-rouge">https://google.com</code>,
потому что Хром считает пустой страницей главную Гугла.</p>

<p>Видно теперь, что даже сложная версия стандарта весьма понятна, если
разобраться. На мой взгляд, она все же избыточна: может быть либо один, либо два
запроса. Я бы постарался привести к общему знаменателю. Как этот ад поддерживают
разработчики браузеров, не понимаю.</p>

<p>Несмотря на кажущуюся простоту, реализовать поддержку CORS на сервере требует
времени. Первоначально я хотел использовать чужую библиотеку, но после 10 минут
чтения исходного кода понял, что автор НЕПРАВИЛЬНО понял спецификацию и
реализовал ее с ошибками. Лишний раз убедился, авторы сторонних библиотек – не
боги, а такие же смертные. Они могут тупить, ошибаться. Лучше потратить день на
чтение спеки и сделать все правильно, чем доверять первому встречному решению.</p>

<p>Расскажу теперь о тонкостях, с которыми столкнулся при внедрении CORS в
проекте. Прежде всего, чтобы сократить число preflight-запросов, стоит
либо кешировать эндпоинт <code class="highlighter-rouge">OPTIONS</code> заголовками:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Cache-Control: no-cache, must-revalidate
</code></pre></div></div>

<p>, либо вообще объявить его на уровне Nginx:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>location / {
     if ($request_method = 'OPTIONS') {
        add_header 'Access-Control-Allow-Origin' '*';
        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
        add_header 'Access-Control-Allow-Headers' 'Version, Authorization, Content-Type';
     }
</code></pre></div></div>

<p>Еще одна тонкость: даже если возвращаете ответ с не-положительным статусом,
например, не прошла валидация или нет прав, заголовок
<code class="highlighter-rouge">Access-Control-Allow-Origin</code> обязан присутствовать. Если заголовка нет, браузер
решит, что CORS-запрос запрещен и не прочитает ответ.</p>

<p>В нашем случае это вылилось в следующее: CORS-декоратор оборачивал ответ в заголовки только в
положительном случае. Если не проходила валидация, приложение отсылало ответ еще
до того, как доходила очередь декоратора. Браузер не мог внятно сказать, почему не прошел запрос.
Пришлось поднять декоратор на самый верх стека.</p>

<p>С CORS разобрались, теперь не будет лишним почитать другое руководство <a href="/timezone">про
часовые пояса</a></p>

<p>Ссылки:</p>

<ul>
  <li>
    <p><a href="https://www.html5rocks.com/en/tutorials/cors/">Using CORS</a></p>

    <p>Отличный туториал на английском языке, откуда я подчерпнул большую часть материала.</p>
  </li>
  <li>
    <p><a href="http://enable-cors.org/">Enable CORS</a></p>

    <p>Сайт, целиком посвященный CORS: описание, статьи, конфиги, примеры кода.</p>
  </li>
</ul>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/read-5/">Что почитать на выходных №5</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2016-12-17T00:00:00+00:00">
        Dec 17, 2016
    </time>

    <a href="/tag/read/" rel="tag">read</a>, <a href="/tag/life/" rel="tag">life</a>

</div>


            <div class="entry">
                
                    <p>Поехали, техническое:</p>

<ul>
  <li>
    <p><a href="http://www.yegor256.com/2016/12/13/mvc-vs-oop.html">MVC vs. OOP</a></p>

    <p>Замечания Егора Бугаенко об известных паттернах.</p>
  </li>
  <li>
    <p><a href="http://www.yegor256.com/2016/08/15/what-is-wrong-object-oriented-programming.html">What’s Wrong With Object-Oriented Programming?</a></p>

    <p>У того же автора: подборка цитат известных программистов о том, что ООП отстой.</p>
  </li>
  <li>
    <p><a href="https://www.html5rocks.com/en/tutorials/cors/">Using CORS</a></p>

    <p>Отличный мануал как прикрутить кросс-доменные запросы к серверу и
клиенту. Намереваюсь написать свой туториал по следам недавних изысканий.</p>
  </li>
</ul>

<p>На сладкое:</p>

<ul>
  <li>
    <p><a href="https://snob.ru/selected/entry/117376">Женщины для меня устарели</a></p>

    <p>Что дает человеку секс с роботом.</p>
  </li>
</ul>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/clj-http/">Мой вклад в clj-http</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2016-12-16T00:00:00+00:00">
        Dec 16, 2016
    </time>

    <a href="/tag/clojure/" rel="tag">clojure</a>, <a href="/tag/http/" rel="tag">http</a>

</div>


            <div class="entry">
                
                    
<p>В проект <a href="https://github.com/dakrone/clj-http">clj-http</a> приняли мой
<a href="https://github.com/dakrone/clj-http/pull/343/files">скромный пулл-реквест</a>. Теперь, если запрос был вызван с флагом
<code class="highlighter-rouge">:throw-exceptions true</code> и вернулся плохой ответ (статус не 2хх, 3хх), то во
вбрасываемый словарь добавляеся ключ <code class="highlighter-rouge">:type
:clj-http.client/unexceptional-status</code>. Это на ура работает с библиотекой
<a href="https://github.com/scgilardi/slingshot">Slingshot</a>, потому что отлов исключений по полю <code class="highlighter-rouge">:type</code> стал
негласным стандартом.</p>

<p>Если абзац выше звучит для вас бессмыслецей, расскажу подробней. Изначально в
Кложе идут унылые Java-исключения, которые плохо ложаться на мир структур и
коллекций. Но поскольку Кложа это Лисп, а в Лиспе любая проблема решается его же
силами, умельцы написали библиотеку для альтернативных исключений slingshot.</p>

<p>Библиотека упрощает работу с исключениями до мыслимого предела. Теперь можно
вбрасывать не только объект, унаследованный от Throwable, а вообще что
угодно. Лучше всего подходит словарь. Форма отлова исключения, выброшенного из
slingshot, может иметь разную структуру. Например, предикат, но удобней и короче
будет вектор двух элементов, где первый – ключ, а второй – значение.</p>

<p>Если раньше приходилось передавать неочевидный предикат, который проверял, что в
словаре есть поле <code class="highlighter-rouge">status</code>, и оно числовое:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">catch</span><span class="w">
  </span><span class="p">(</span><span class="k">fn</span><span class="w"> </span><span class="p">[</span><span class="n">response</span><span class="p">]</span><span class="w">
    </span><span class="p">(</span><span class="nb">-&gt;</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="no">:statsus</span><span class="w"> </span><span class="n">integer?</span><span class="p">))</span><span class="w">
  </span><span class="n">...</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>, то теперь достаточно сравнить так:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">catch</span><span class="w"> </span><span class="p">[</span><span class="no">:type</span><span class="w"> </span><span class="no">:clj-http.client/unexceptional-status</span><span class="p">])</span><span class="w">
</span></code></pre></div></div>

<p>Визуально разницы мало, но селектор по ключу <code class="highlighter-rouge">:type</code> открывает новые
горизонты. Например, во врейморке <a href="https://github.com/metosin/compojure-api">Compojure API</a>, на котором
наш проект, обработка исключений целиком работает на этом принципе. В особом
словаре лежат ключи – потенциальные варианты <code class="highlighter-rouge">:type</code>, а значения –
функции-обработчики. Хорошие примеры <a href="https://github.com/metosin/compojure-api/wiki/Exception-handling">в документации</a>.</p>

<p>Пока пулл-реквест не приняли, приходилось писать свой костыль для добавления
ключа. Теперь с этим покончено.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/press/">Статья в Associated Press</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2016-12-14T00:00:00+00:00">
        Dec 14, 2016
    </time>

    <a href="/tag/press/" rel="tag">press</a>, <a href="/tag/ap/" rel="tag">AP</a>

</div>


            <div class="entry">
                
                    <p><img src="/assets/static/ivan.jpg" alt="ivan" /></p>

<p>В издании Associated Press <a href="http://bigstory.ap.org/article/b46a8e42383049ea8a449130cdec0e67/tech-hub-russias-rustbelt-recessions-godsend">опубликована статья</a> об айти-специалистах
Воронежа, в том числе из нашего офиса. Я немного рассказал про удаленку, деньги
и прочие детали, словом, все то, что описывал в посте про
<a href="/remote">удаленную работу</a>. Мой коллега Михаил поделился взглядами на рынок
специалистов и воздействие кризиза на айти.</p>

<p>Фотографии в хорошем качестве и видео на сайте AP доступны только по платной
подписке.</p>


                
            </div>

        </li>
        
    </ul>

    <h4>
        
        <a href="/page22" class="previous">&larr;</a>
        
        <span class="page_number ">Страница 23 из 49</span>
        
        <a href="/page24" class="next">&rarr;</a>
        
    </h4>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Ivan Grishaev's blog</li>
          <li><a href="mailto:ivan@grishaev.me">ivan@grishaev.me</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
            <li><a href="https://github.com/igrishaev">GitHub</a></li>
            <li><a href="tg://resolve?domain=igrishaev_blog">Telegram</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Writing on programming, education, books and negotiations.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
