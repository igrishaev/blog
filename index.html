<!DOCTYPE html>
<html lang="ru">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Ivan Grishaev's blog</title>
  <meta name="description" content="Writing on programming, education, books and negotiations.
">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/custom.css">
  <link rel="canonical" href="https://grishaev.me/">
  <link rel="alternate" type="application/rss+xml" title="Ivan Grishaev's blog" href="https://grishaev.me/feed.xml">

  <link rel="shortcut icon" type="image/x-icon" href="/assets/static/favicons/favicon.ico">

  <script type="text/javascript" src="/assets/typo.js"></script>

</head>


  <body>
    <header class="site-header">

    <div class="wrapper flex-container">

        <div>
            <a href="/">
                <img src="/assets/static/photo-round-small.png" alt="Ivan Grishaev">
            </a>
        </div>

        <div class="flex-container-vert" style="margin-left: 15px; width: 80%">

            <div class="flex-container full-width">
                <p style="margin-bottom: 5px">Ivan Grishaev's blog</p>
                <div class="flex-huge"></div>
                <div >
<form id="search-form"
      target="_blank"
      style="display: inline"
      method="get"
      action="https://www.google.com/search">

    <input name="sitesearch"
           value="grishaev.me"
           type="hidden">

    <input type="text"
           required="required"
           name="q"
           placeholder="Google search..."
           autocomplete="off">

    <button style="border: none; background-color: transparent; cursor: pointer;"
            type="submit">&#x1f50d;</button>

</form>
</div>
            </div>

            <p><small>Writing on programming, education, books and negotiations.
</small></p>

            <div class="flex-container">
                <a class="menu-item" href="/">Home</a>
                <a class="menu-item" href="/about/">About</a>
                <a class="menu-item" href="/bookshelf/">Bookshelf</a>
                <a class="menu-item" href="/feed.xml">RSS</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor" href="/tag/clojure/">Clojure</a>
                <a class="menu-item minor" href="/tag/emacs/">Emacs</a>
                <a class="menu-item minor" href="/tag/python/">Python</a>
                <a class="menu-item minor" href="/tag/programming/">Programming</a>
                <a class="menu-item minor" href="/interview/">Interview</a>
                <a class="menu-item minor" href="/video/">Video</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor hl" href="/clojure-in-prod/">Книга «Clojure на производстве»</a>
            </div>

        </div>
    </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="home">

    <ul class="post-list">
        
        <li>

            <h2>
                <a class="post-link" href="/successful-success/">Десять советов, которые я дал бы себе в молодости</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2023-06-05T00:00:00+00:00">
        Jun 5, 2023
    </time>

    <a href="/tag/life/" rel="tag">life</a>, <a href="/tag/success/" rel="tag">success</a>

</div>


            <div class="entry">
                
                    <p>Есть такой пошлый формат — кто-то успешный дает советы молодой аудитории. Заводи
знакомства, качай софт-скилы, фокусируйся, помни о главном. Вся эта олдовая
мудрость, поучение молодых, вы поняли.</p>

<p>Каждый раз удивляюсь одной вещи. Почему-то никто не спросит докладчика:
милейший, а ты следовал своим советам в 20 лет? Ответ очевиден — конечно нет. Он
просто херачил, шел напролом к цели и вот пришел. Теперь его пригласили
выступать перед публикой.</p>

<p>Как правило, человек плохо оценивает себя. Даже если он видит, что известней и
богаче других, то находит этому нелепые объяснения.  Это ошибка выжившего:
причины успеха вовсе не те, что ты несешь со сцены. Они могут быть сомнительными,
криминальными или вообще неизвестными. Это может быть совпадение времени и
места. Но что-то нужно сказать, и он говорит, хотя все это не имеет смысла.</p>

<p>В самом деле: начните делать то, что советовали Стив Джобс и Билл Гейтс, и ни к
какому успеху вы не придете. Более того, вы же не пойдете с них догонять:
смотри, я делал как ты говорил, но не помогает. Зачем тогда слушать, если нет
гарантий?</p>

<p>Советы успешных людей — это тьфу и растереть. Они пришли к цели без каких-либо
советов, а значит, вы можете так же. Вполне возможно, в зале сидит потенциальный
Билл Гейтс, но вместо того, чтобы идти к мечте, он слушает чью-то блажь.</p>

<p>Сюда же относятся курсы успешного успеха, интервью Дудей, всякие блоггеры и
прочее. Пока вы их слушаете, вы не делаете свое и льете воду на чужую мельницу.</p>

<p>Поэтому один совет, который я могу дать — поменьше слушать чужих мнений. Делай
то, что считаешь нужным и иди с этим правилом через всю жизнь.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/sql-distinct-on/">SQL и DISTINCT ON</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2023-06-03T00:00:00+00:00">
        Jun 3, 2023
    </time>

    <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/sql/" rel="tag">sql</a>, <a href="/tag/postgresql/" rel="tag">postgresql</a>, <a href="/tag/logs/" rel="tag">logs</a>

</div>


            <div class="entry">
                
                    <p>Еще одна полезная штукенция в SQL — это оператор <code class="language-plaintext highlighter-rouge">DISTINCT ON</code>. От обычного <code class="language-plaintext highlighter-rouge">DISTINCT</code> он отличается тем, что определяет уникальность записей не по всем полям, а только указанным. Эта особенность позволяет писать интересные запросы.</p>

<p>Предположим, мы ведем таблицу курсов валют относительно рубля. Вот ее структура:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">create</span> <span class="k">table</span> <span class="n">rates</span> <span class="p">(</span>
  <span class="n">id</span>      <span class="nb">serial</span> <span class="k">primary</span> <span class="k">key</span><span class="p">,</span>
  <span class="n">value</span>   <span class="nb">text</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
  <span class="n">instant</span> <span class="nb">timestamp</span> <span class="k">without</span> <span class="nb">time</span> <span class="k">zone</span> <span class="k">not</span> <span class="k">null</span> <span class="k">default</span> <span class="n">now</span><span class="p">(),</span>
  <span class="n">cost</span>    <span class="nb">bigint</span> <span class="k">not</span> <span class="k">null</span>
<span class="p">);</span>
</code></pre></div></div>

<p>и данные:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">insert</span> <span class="k">into</span> <span class="n">rates</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">cost</span><span class="p">)</span> <span class="k">values</span> <span class="p">(</span><span class="s1">'usd'</span><span class="p">,</span> <span class="mi">7968</span><span class="p">);</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">rates</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">cost</span><span class="p">)</span> <span class="k">values</span> <span class="p">(</span><span class="s1">'usd'</span><span class="p">,</span> <span class="mi">7988</span><span class="p">);</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">rates</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">cost</span><span class="p">)</span> <span class="k">values</span> <span class="p">(</span><span class="s1">'usd'</span><span class="p">,</span> <span class="mi">8031</span><span class="p">);</span>

<span class="k">insert</span> <span class="k">into</span> <span class="n">rates</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">cost</span><span class="p">)</span> <span class="k">values</span> <span class="p">(</span><span class="s1">'eur'</span><span class="p">,</span> <span class="mi">8623</span><span class="p">);</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">rates</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">cost</span><span class="p">)</span> <span class="k">values</span> <span class="p">(</span><span class="s1">'eur'</span><span class="p">,</span> <span class="mi">8581</span><span class="p">);</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">rates</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">cost</span><span class="p">)</span> <span class="k">values</span> <span class="p">(</span><span class="s1">'eur'</span><span class="p">,</span> <span class="mi">8699</span><span class="p">);</span>
</code></pre></div></div>

<p>Величины хранятся целым числом в центах. Все запросы я специально ввел по одному, чтобы у курсов были разные даты.</p>

<p>У подобных таблиц особенность: часто нужны их срезы по датам, например первые или последние на текущий момент. На первый взгляд не ясно, как это делать. До того, как я узнал про <code class="language-plaintext highlighter-rouge">DISTINCT ON</code>, я делал весьма топорно: сперва группировал по валюте, чтобы получить максимальную дату:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="n">value</span><span class="p">,</span> <span class="k">max</span><span class="p">(</span><span class="n">instant</span><span class="p">)</span> <span class="k">as</span> <span class="n">instant</span>
<span class="k">from</span> <span class="n">rates</span>
<span class="k">group</span> <span class="k">by</span> <span class="n">value</span><span class="p">;</span>

 <span class="n">value</span> <span class="o">|</span>          <span class="n">instant</span>
<span class="c1">-------+----------------------------</span>
 <span class="n">eur</span>   <span class="o">|</span> <span class="mi">2023</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">02</span> <span class="mi">22</span><span class="p">:</span><span class="mi">17</span><span class="p">:</span><span class="mi">04</span><span class="p">.</span><span class="mi">902392</span>
 <span class="n">usd</span>   <span class="o">|</span> <span class="mi">2023</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">02</span> <span class="mi">22</span><span class="p">:</span><span class="mi">16</span><span class="p">:</span><span class="mi">57</span><span class="p">.</span><span class="mi">007947</span>
</code></pre></div></div>

<p>, а затем оборачивал это в подзапрос и соединял с основной таблицей по валюте и дате:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="n">rates</span><span class="p">.</span><span class="o">*</span>
  <span class="k">from</span> <span class="n">rates</span>
<span class="k">join</span> <span class="p">(</span>
  <span class="k">select</span> <span class="n">value</span><span class="p">,</span> <span class="k">max</span><span class="p">(</span><span class="n">instant</span><span class="p">)</span> <span class="k">as</span> <span class="n">instant</span>
  <span class="k">from</span> <span class="n">rates</span>
  <span class="k">group</span> <span class="k">by</span> <span class="n">value</span>
<span class="p">)</span> <span class="k">as</span> <span class="n">sub</span>
<span class="k">on</span>
      <span class="n">rates</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">sub</span><span class="p">.</span><span class="n">value</span>
  <span class="k">and</span> <span class="n">rates</span><span class="p">.</span><span class="n">instant</span> <span class="o">=</span> <span class="n">sub</span><span class="p">.</span><span class="n">instant</span><span class="p">;</span>

 <span class="n">id</span> <span class="o">|</span> <span class="n">value</span> <span class="o">|</span>          <span class="n">instant</span>           <span class="o">|</span> <span class="n">cost</span>
<span class="c1">----+-------+----------------------------+------</span>
  <span class="mi">6</span> <span class="o">|</span> <span class="n">usd</span>   <span class="o">|</span> <span class="mi">2023</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">02</span> <span class="mi">22</span><span class="p">:</span><span class="mi">16</span><span class="p">:</span><span class="mi">57</span><span class="p">.</span><span class="mi">007947</span> <span class="o">|</span> <span class="mi">8031</span>
  <span class="mi">9</span> <span class="o">|</span> <span class="n">eur</span>   <span class="o">|</span> <span class="mi">2023</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">02</span> <span class="mi">22</span><span class="p">:</span><span class="mi">17</span><span class="p">:</span><span class="mi">04</span><span class="p">.</span><span class="mi">902392</span> <span class="o">|</span> <span class="mi">8699</span>
</code></pre></div></div>

<p>Это неуклюже и требует индексов для эффективного JOIN.</p>

<p>Гораздо лучше смотрится с <code class="language-plaintext highlighter-rouge">DISTINCT ON</code>. Укажем в запросе, что записи уникальны в разрезе валют. В этом случае в выборке останется одна запись с <code class="language-plaintext highlighter-rouge">usd</code> и одна с <code class="language-plaintext highlighter-rouge">eur</code>, а остальные будут пропущены. Остается отсортировать их так, чтобы первыми шли записи с максимальной датой или минимальной.</p>

<p>Пример с минимальной датой:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="k">distinct</span> <span class="k">on</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">*</span>
<span class="k">from</span> <span class="n">rates</span>
<span class="k">order</span> <span class="k">by</span> <span class="n">value</span><span class="p">,</span> <span class="n">instant</span><span class="p">;</span>

 <span class="n">id</span> <span class="o">|</span> <span class="n">value</span> <span class="o">|</span>          <span class="n">instant</span>           <span class="o">|</span> <span class="n">cost</span>
<span class="c1">----+-------+----------------------------+------</span>
  <span class="mi">7</span> <span class="o">|</span> <span class="n">eur</span>   <span class="o">|</span> <span class="mi">2023</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">02</span> <span class="mi">22</span><span class="p">:</span><span class="mi">16</span><span class="p">:</span><span class="mi">59</span><span class="p">.</span><span class="mi">46867</span>  <span class="o">|</span> <span class="mi">8623</span>
  <span class="mi">4</span> <span class="o">|</span> <span class="n">usd</span>   <span class="o">|</span> <span class="mi">2023</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">02</span> <span class="mi">22</span><span class="p">:</span><span class="mi">16</span><span class="p">:</span><span class="mi">50</span><span class="p">.</span><span class="mi">603444</span> <span class="o">|</span> <span class="mi">7968</span>
</code></pre></div></div>

<p>А это — с максимальной, потому что записи следуют по убываю <code class="language-plaintext highlighter-rouge">instant</code>:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="k">distinct</span> <span class="k">on</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">*</span>
<span class="k">from</span> <span class="n">rates</span>
<span class="k">order</span> <span class="k">by</span> <span class="n">value</span><span class="p">,</span> <span class="n">instant</span> <span class="k">desc</span><span class="p">;</span>

 <span class="n">id</span> <span class="o">|</span> <span class="n">value</span> <span class="o">|</span>          <span class="n">instant</span>           <span class="o">|</span> <span class="n">cost</span>
<span class="c1">----+-------+----------------------------+------</span>
  <span class="mi">9</span> <span class="o">|</span> <span class="n">eur</span>   <span class="o">|</span> <span class="mi">2023</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">02</span> <span class="mi">22</span><span class="p">:</span><span class="mi">17</span><span class="p">:</span><span class="mi">04</span><span class="p">.</span><span class="mi">902392</span> <span class="o">|</span> <span class="mi">8699</span>
  <span class="mi">6</span> <span class="o">|</span> <span class="n">usd</span>   <span class="o">|</span> <span class="mi">2023</span><span class="o">-</span><span class="mi">06</span><span class="o">-</span><span class="mi">02</span> <span class="mi">22</span><span class="p">:</span><span class="mi">16</span><span class="p">:</span><span class="mi">57</span><span class="p">.</span><span class="mi">007947</span> <span class="o">|</span> <span class="mi">8031</span>
</code></pre></div></div>

<p>Обратите внимание, что сортировка <code class="language-plaintext highlighter-rouge">order by</code> начинается с того поля, которое указано в <code class="language-plaintext highlighter-rouge">distinct on</code>. За счет этого база эффективно пропускает дубли без промежуточных списков.</p>

<p>Если записей много, понадобится индекс на поле уникальности и критерий сортировки, в нашем случае <code class="language-plaintext highlighter-rouge">value</code> и <code class="language-plaintext highlighter-rouge">instant</code>:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">CREATE</span><span class="w"> </span><span class="n">INDEX</span><span class="w"> </span><span class="n">rates_last_idx</span><span class="w"> </span><span class="n">ON</span><span class="w"> </span><span class="n">rates</span><span class="w"> </span><span class="p">(</span><span class="nf">value,</span><span class="w"> </span><span class="n">instant</span><span class="w"> </span><span class="n">desc</span><span class="p">)</span><span class="c1">;</span><span class="w">
</span></code></pre></div></div>

<p>Похоже решаются другие задачи, связанные со временем или версиями, например прогноз погоды, версионирование статей или сущностей.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/sql-logs-2/">Логи SQL (2)</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2023-06-02T00:00:00+00:00">
        Jun 2, 2023
    </time>

    <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/sql/" rel="tag">sql</a>, <a href="/tag/postgresql/" rel="tag">postgresql</a>, <a href="/tag/logs/" rel="tag">logs</a>

</div>


            <div class="entry">
                
                    <p>В последнее время я много занимаюсь SQL, поэтому вот еще пара приемов.</p>

<p>Настройка <code class="language-plaintext highlighter-rouge">log_duration = on</code> добавляет в лог длительность каждого запроса. Удобно, потому что избавляет от мусорного кода, который перед каждым запросом запоминает текущее время, выполняет его, находит новое время и печатает разницу в консоль. Postgres берет все это на себя:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>statement: create table table8855 (id integer)
duration: 11.607 ms
statement: BEGIN
duration: 0.046 ms
statement: insert into table8855 values (1), (2)
duration: 0.368 ms
statement: ROLLBACK
duration: 0.052 ms
statement: select * from table8855
duration: 0.414 ms
</code></pre></div></div>

<p>Вторая настройка <code class="language-plaintext highlighter-rouge">log_line_prefix</code> отвечает за информацию, которая показана в логе перед запросом. По умолчанию это время с точностью до миллисекунд и номер процесса:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>2023-06-02 14:45:52.395 MSK [57002] LOG:  statement: BEGIN
</code></pre></div></div>

<p>Я предпочитаю вот что:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>log_line_prefix = '%t [%v]'
</code></pre></div></div>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">%t</code> выводит время без миллисекунд, что короче;</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">%v</code> означает виртуальный номер транзакции. Виртуальный потому, что до ее завершения система не знает, какой номер будет в итоге. Поэтому выводится пара <code class="language-plaintext highlighter-rouge">[tmin/tmax]</code> — диапазон транзакций, доступный запросу в текущий момент.</p>
  </li>
</ul>

<p>Зачем это нужно? Бывают баги, когда разработчик ошибается с транзакциями, например открывает ее, но шлет запросы через старое соединение. Если что-то упадет в процессе, изменения будут частичными, что выливается проблемы на проде.</p>

<p>С логами ниже легко понять, кто на ком стоял. Запросы с меткой <code class="language-plaintext highlighter-rouge">[3/5]</code> относятся к одной транзакции, а <code class="language-plaintext highlighter-rouge">[4/2]</code> — к другой.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[3/4]LOG: create table table8856 (id integer)
[3/5]LOG: BEGIN
[3/5]LOG: SET TRANSACTION ISOLATION LEVEL SERIALIZABLE
[3/5]LOG: insert into table8856 values (1), (2)
[3/5]LOG: select * from table8856
[4/2]LOG: select * from table8856
[3/5]LOG: COMMIT
</code></pre></div></div>

<p>Заодно можно посчитать, сколько было транзакций, насколько они пересекаются и, возможно, разнести их по времени.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/sql-logs/">Логи SQL</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2023-05-26T00:00:00+00:00">
        May 26, 2023
    </time>

    <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/sql/" rel="tag">sql</a>, <a href="/tag/postgresql/" rel="tag">postgresql</a>, <a href="/tag/logs/" rel="tag">logs</a>

</div>


            <div class="entry">
                
                    <p>Расскажу один прием, полезный в разработке.</p>

<p>Если я работаю с PostgreSQL, то включаю логирование всех выражений. В Докере это
делается передачей параметра <code class="language-plaintext highlighter-rouge">-E</code> как в примере ниже:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">version</span><span class="pi">:</span> <span class="s2">"</span><span class="s">3.6"</span>
<span class="na">services</span><span class="pi">:</span>
  <span class="na">postgres</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">postgres:14</span>
    <span class="na">command</span><span class="pi">:</span> <span class="s">-E</span>
</code></pre></div></div>

<p>С ним все запросы видны в терминале, где запущен Докер.</p>

<p>Если база работает нативно, в файлик <code class="language-plaintext highlighter-rouge">postgresql.conf</code> добавляю выражение:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>log_statement = 'all'
</code></pre></div></div>

<p>Оно там есть из коробки, но закомментировано. В отдельной вкладке вызываю вечный <code class="language-plaintext highlighter-rouge">tail</code>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> <span class="nb">tail</span> <span class="nt">-f</span> <span class="s1">'/path/to/postgresql.log'</span>
</code></pre></div></div>

<p>Далее я пишу код, гоняю тесты и посматриваю логи. Зачем? Потому что за много лет
я выявил столько чуши, что просто не описать. Например:</p>

<ul>
  <li>
    <p>запросы <code class="language-plaintext highlighter-rouge">WHERE ID IN</code> на тысячи айдишников;</p>
  </li>
  <li>
    <p>группировка по всем(!) полям таблицы: <code class="language-plaintext highlighter-rouge">GROUP BY id, name, email, etc...</code>;</p>
  </li>
  <li>
    <p>молчаливый откат транзакции без выброса исключения. Запрос упал, но
разработчик молча идет дальше;</p>
  </li>
  <li>
    <p>изменения без транзакции там, где она должна быть;</p>
  </li>
  <li>
    <p>мусорные запросы в <code class="language-plaintext highlighter-rouge">pg_catalog</code> и другие служебные таблицы, потому что
какие-то свойства не заданы в коде;</p>
  </li>
  <li>
    <p>чтение записей поштучно по ID в цикле (200, 500 шагов и больше);</p>
  </li>
  <li>
    <p>просто всякие дикие конструкции.</p>
  </li>
</ul>

<p>Все это я собираю и открывают тикеты. Некоторые даже удается исправить.</p>

<p>Лог базы — своего рода осиное гнездо. Открой его — и почти наверняка уйдешь в
ступор от того, какую дичь генерит ORM или “умная” библиотека. Или разработчик,
вооруженный всем этим добром.</p>

<p>Так и живем.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/pascal-exercises/">Задачник по Паскалю</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2023-05-15T00:00:00+00:00">
        May 15, 2023
    </time>

    <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/pascal/" rel="tag">pascal</a>

</div>


            <div class="entry">
                
                    <p>В сотый раз повторяется одно и то же. Человек учит язык — неважно Питон, Кложу,
что угодно — и спрашивает: посоветуйте задачки. Ему кидают ссылки на Exercism,
Project Euler и похожие сайты. Мой ответ не меняется годами: покупаешь задачник
по Турбо-Паскалю за 300 рублей и решаешь на своей Кложе, Питоне или PHP. Или
просто качаешь из интернета первый попавшийся.</p>

<p>Думаете, кто-то так делает? Конечно, нет. Мало того, поднимается драма: как так,
у нас современные языки, а ты со своим Паскалем! Оставь дерьмо мамонта в покое.</p>

<p>Сколько себя помню, всегда поражала эта избирательность. Эти задачи буду решать,
а эти не буду. Эти современные и хорошие, а эти старые. Иной раз мне доказывают,
мол, концепции Паскаля плохо ложатся на Кложу, поэтому решать их неудобно.</p>

<p>Я аж представил себе. Начальство: Иван, вот тебе задача, надо сделать то и
это. А я такой: ребята, она плохо ложится на концепцию языка, не буду делать. А
они: конечно, дорогой, вот задача получше, а эту делать не будем. Исправим,
чтобы ложилась.</p>

<p>Думаю, ясно, что решать надо все задачи. В том числе те, что в старых
учебниках. А почему именно из учебников, тому следуют пункты.</p>

<ul>
  <li>
    <p>Сразу много задач. Купив сборник, вы получите не две-три интересных задачки, а
две-три сотни.</p>
  </li>
  <li>
    <p>Если это толковый сборник, задачи в нем собраны по разделам: арифметика,
циклы, массивы, связные списки, файлы, графика и так далее. В каждом разделе
задачи идут по нарастанию сложности. Это позволит набить руку в той теме, где
вы плаваете.</p>
  </li>
  <li>
    <p>Поскольку задачи составлены для школьников и студентов, они перекликаются с
учебной программой. Решая задачи, вы заодно ее подтяните.</p>
  </li>
</ul>

<p>Примеры задач, которые можно сделать на любом языке:</p>

<ul>
  <li>
    <p>квадратное уравнение. По коэффициентам a, b, c найти корни или сообщить, что
их нет.</p>
  </li>
  <li>
    <p>игра “угадай число”. Компьютер загадывает число от 0 до 100, ваша задача —
угадать его. На ваши попытки компьютер отвечает “нет, больше”, “нет, меньше”
или “угадал”.</p>
  </li>
  <li>
    <p>пересечение прямоугольников, точки и окружности по их координатам</p>
  </li>
  <li>
    <p>задачи на массивы и связные списки, чтобы лучше понимать коллекции</p>
  </li>
  <li>
    <p>графики, исследование функций.</p>
  </li>
  <li>
    <p>запись данных о сотруднике в файл и их чтение.</p>
  </li>
</ul>

<p>Что из этого плохо ложится на современный язык? Может, за “не хочу” стоит “не
могу” или “лень вспоминать”?</p>

<p>Какой смысл открывать условный Exercism, регистрироваться, подтверждать почту,
отписываться от рассылки? Чтобы что? Я уже накидал задач на неделю, сиди
решай. В учебнике их на год. Что ты хочешь найти? Чего не хватает?</p>

<p>Наконец, еще один пункт в пользу сборника задач — это работа с книгой. Не знаю
как это работает, но бумажная книга эффективней, чем тупление в монитор. Для
меня это совершенно очевидно. Скорей всего, включается другой отдел мозга, но
объяснение не так важно.</p>

<p>Изучать язык тяжело. Красивые сайты пытаются это скрыть или развлечь
пользователя, потому что их цель — донаты и показ рекламы. У задачника этой цели
нет. Это более хардкорный вариант, но тем он и лучше.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/msg-call/">Звонки в мессаджерах</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2023-05-09T00:00:00+00:00">
        May 9, 2023
    </time>

    <a href="/tag/life/" rel="tag">life</a>, <a href="/tag/mobile/" rel="tag">mobile</a>, <a href="/tag/telegram/" rel="tag">telegram</a>

</div>


            <div class="entry">
                
                    <p>Совет — чтобы не бесить людей, звоните на обычный мобильный. Не в Телеграм, не в
Ватсап и не Вайбер. Мало что раздражает так сильно, как звонки в какой-то
программе.</p>

<p>Только что звонил родственник в Телеграме. Это просто п..здец, простите. У меня
три устройства: телефон, ноут, комп. Все три одновременно завыли, на каждом
распахнулось окно. Ощущение, что воздушная тревога. Через две секунды вызов на
телефоне пропал, но продолжился на ноуте. Что происходит?</p>

<p>То же самое с Ватсапом. Сидишь, быдлокодишь под музыку, весь в себе. Внезапно
подскакиваешь от звонка и окна на весь экран. Просто издевательство.</p>

<p>Даже если не обращать на это внимание, есть важный момент. У звонков в Телеграме
и иже с ним ужасное качество. Звук пропадает, сыпется, словом — гораздо хуже
мобильной связи.</p>

<p>Причина в том, как устроены звонки в приложениях. Каждое из них звонит на
местный номер. Там сервер, который заворачивает звук в трафик и шлет куда-то
далеко. Оттуда он направляется в страну получателя, и ему звонят с местного
номера. Получается звонок с местного на местный с целой пропастью
посередине. Даже если собеседники в одном здании, маршрут выходит изрядный.</p>

<p>Конечно, при звонке из России в условную Турцию вариантов не остается — не
платить же опсосу по 70 рублей за минуту. Здесь Телеграм и Ватсап выручают. Но
удивляют нищеброды-соседи или знакомые из твоего города, которые упорно звонят
из приложения. Зачем? Чтобы сэкономить пять минут? Они везде идут пакетами, что
там экономить? Хуже пенсионеров, честное слово.</p>

<p>Раздражает еще то, что на Айфоне последние номера хранятся с учетом
приложения. Например, когда мне звонят с Ватсапа, я сбрасываю и перезваниваю с
мобильного. Но если нажать на последний вызов, выскочит проклятый
Ватсап. Приходится заходить в контакт и жать на тот же номер с мобильным типом.</p>

<p>Раз и навсегда: для связи внутри страны — только мобильная связь. Мессенджеры —
если вы в разных странах или важна приватность, причем по обоюдному согласию. В
остальном звонить из приложения — днище и зашквар. Объясните, пожалуйста, тем,
кто этого не понимает.</p>

<p>PS: в Телеграме можно запретить входящие звонки всем или с учетом контактов. В
других программах, кажется, это невозможно.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/en/pg-lib/">PG: Postgres-related libraries for Clojure</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2023-05-06T00:00:00+00:00">
        May 6, 2023
    </time>

    <a href="/tag/clojure/" rel="tag">clojure</a>, <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/postgres/" rel="tag">postgres</a>

</div>


            <div class="entry">
                
                    
<p>The <a href="https://github.com/igrishaev/pg">PG project</a> holds a set of packages related to PostgreSQL. This is a
breakdown of my unsuccessful attempt to write a PostgreSQL client in pure
Clojure (stored in the <code class="language-plaintext highlighter-rouge">_</code> directory). Although I didn’t achieve the goal, some
parts of the code are now shipped as separated packages and might be useful for
someone.</p>

<p>At the moment, the most interesting modules are <code class="language-plaintext highlighter-rouge">pg-copy</code> and <code class="language-plaintext highlighter-rouge">pg-copy-jdbc</code>
that <code class="language-plaintext highlighter-rouge">COPY</code> the data using the binary Postgres format which is faster than CSV.</p>

<h2 id="table-of-contents">Table of Contents</h2>

<h2>

    

</h2>

<ul id="toc-item-pg-lib-en">
  <li><a href="#table-of-contents" id="toc-item-pg-lib-en-table-of-contents">Table of Contents</a>    <ul>
      <li><a href="#pg-common" id="toc-item-pg-lib-en-pg-common">pg-common</a>        <ul>
          <li><a href="#installation" id="toc-item-pg-lib-en-installation">Installation</a></li>
          <li><a href="#usage" id="toc-item-pg-lib-en-usage">Usage</a></li>
        </ul>
      </li>
      <li><a href="#pg-encode" id="toc-item-pg-lib-en-pg-encode">pg-encode</a>        <ul>
          <li><a href="#installation-1" id="toc-item-pg-lib-en-installation-1">Installation</a></li>
          <li><a href="#usage-1" id="toc-item-pg-lib-en-usage-1">Usage</a></li>
          <li><a href="#type-specific-encoding" id="toc-item-pg-lib-en-type-specific-encoding">Type-specific encoding</a></li>
          <li><a href="#table-of-supported-types-and-oids" id="toc-item-pg-lib-en-table-of-supported-types-and-oids">Table of supported types and OIDs</a></li>
          <li><a href="#extending-the-encoding-rules" id="toc-item-pg-lib-en-extending-the-encoding-rules">Extending the encoding rules</a></li>
          <li><a href="#default-oids" id="toc-item-pg-lib-en-default-oids">Default OIDs</a></li>
        </ul>
      </li>
      <li><a href="#pg-joda-time" id="toc-item-pg-lib-en-pg-joda-time">pg-joda-time</a>        <ul>
          <li><a href="#installation-2" id="toc-item-pg-lib-en-installation-2">Installation</a></li>
          <li><a href="#usage-2" id="toc-item-pg-lib-en-usage-2">Usage</a></li>
          <li><a href="#table-of-types-and-oids" id="toc-item-pg-lib-en-table-of-types-and-oids">Table of Types and OIDs</a></li>
        </ul>
      </li>
      <li><a href="#pg-copy" id="toc-item-pg-lib-en-pg-copy">pg-copy</a>        <ul>
          <li><a href="#installation-3" id="toc-item-pg-lib-en-installation-3">Installation</a></li>
          <li><a href="#usage-3" id="toc-item-pg-lib-en-usage-3">Usage</a></li>
          <li><a href="#oid-hints" id="toc-item-pg-lib-en-oid-hints">OID hints</a></li>
          <li><a href="#hints-in-metadata" id="toc-item-pg-lib-en-hints-in-metadata">Hints in metadata</a></li>
          <li><a href="#working-with-maps" id="toc-item-pg-lib-en-working-with-maps">Working with maps</a></li>
          <li><a href="#other-functions" id="toc-item-pg-lib-en-other-functions">Other functions</a></li>
        </ul>
      </li>
      <li><a href="#pg-copy-jdbc" id="toc-item-pg-lib-en-pg-copy-jdbc">pg-copy-jdbc</a>        <ul>
          <li><a href="#installation-4" id="toc-item-pg-lib-en-installation-4">Installation</a></li>
          <li><a href="#usage-4" id="toc-item-pg-lib-en-usage-4">Usage</a></li>
          <li><a href="#parallel-copy" id="toc-item-pg-lib-en-parallel-copy">Parallel COPY</a></li>
          <li><a href="#measurements" id="toc-item-pg-lib-en-measurements">Measurements</a>            <ul>
              <li><a href="#plain-copy" id="toc-item-pg-lib-en-plain-copy">Plain COPY</a></li>
              <li><a href="#parallel-copy-1" id="toc-item-pg-lib-en-parallel-copy-1">Parallel COPY</a></li>
              <li><a href="#summary" id="toc-item-pg-lib-en-summary">Summary</a></li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>


                    <p><a href="/en/pg-lib/">Read more &rarr;</a></p>
                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/own/">Свое</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2023-05-02T00:00:00+00:00">
        May 2, 2023
    </time>

    <a href="/tag/programming/" rel="tag">programming</a>

</div>


            <div class="entry">
                
                    <p>Иногда в фирме пишут велосипеды даже с учетом того, что есть открытые
библиотеки. Раньше я по-разному к этому относился, а теперь пришел к
компромиссу.</p>

<p>С одной стороны, кустарные поделки напрягают меня как разработчика. Устраиваясь
в фирму, меньше всего хочется встретить свою ORM, свой роутинг или шаблонную
систему. Обычно это глючный код, написанный по принципу “потому что
можем”. Хочется работать с популярными библиотеками, у которых документация,
сообщество, канал в Слаке.</p>

<p>С другой стороны, свои решения продвигают фирму на рынке и в сообществе. Это
привлекает разработчиков, служит рекламой, упрощает найм. В вакансиях можно
указать, что задание должно быть сделано именно на этих библиотеках, потому что
на них построены решения фирмы.</p>

<p>Правда, чтобы это работало, фирма должна как можно раньше выкладывать свои
решения в open source. Это то же самое, что с ребенком: если вечно держать его
взаперти, будет вред. Библиотека должна быть на Гитхабе, должно быть сообщество,
словом — фирма должна как можно сильнее пиарить свой код, чтобы считаться
центром идей в своей области. И программисты будут в нее стремиться.</p>

<p>Удивляет порой, что у фирмы есть неплохие решения, но они киснут в приватных
репозиториях — без документации, без развития. Что бы не выложить их в паблик? Я
вообще не припомню кода, который нельзя было бы опубликовать именно по причине
кражи бизнеса. За любым кодом стоит понимание его командой и видение
будущего. Скачав исходники Яндекса вы не сделаете новый Яндекс. Единственное
опасение — это ошибки и низкий уровень кода, за который стыдно. Именно это и
лечит open source: его код сразу готов к жизненным трудностям.</p>

<p>Бесит, когда делаешь тестовое задание на популярных библиотеках, а в команде
говорят: забудь, чему тебя учили, у нас своя атмосфера. Ребят: свою атмосферу
нужно проталкивать вовне! Задавать стандарты, вовлекать людей, а не держать в
тайне от мира. Вы что-то скрываете, а скрывать нечего.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/prog-level/">Уровень</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2023-04-30T00:00:00+00:00">
        Apr 30, 2023
    </time>

    <a href="/tag/programming/" rel="tag">programming</a>

</div>


            <div class="entry">
                
                    <p>Пока мир сходит с ума по искусственному интеллекту, всплакну о низком уровне
разработчиков. Подкатило, нужно выплеснуть.</p>

<p>Ситуация: разработчик пишет функцию <code class="language-plaintext highlighter-rouge">get-by-id</code>, чтобы достать сущность из
базы. Не моргнув глазом, он передает ее в <code class="language-plaintext highlighter-rouge">map</code> на пять тысяч элементов. Это, на
минутку, один запрос, а запросов может десятки в секунду. Подобные вещи
приходится ловить в code review и объяснять, что один запрос лучше, чем пять
тысяч.</p>

<p>Идет 2023 год, а программисты пишут SQL конкатенацией строк. В порядке вещей код
на два экрана с <code class="language-plaintext highlighter-rouge">format</code>, <code class="language-plaintext highlighter-rouge">str</code> и <code class="language-plaintext highlighter-rouge">join</code>, который ни понять, ни
отладить. Полученный запрос уходит в базу, и дай бог, чтобы оно работало. Если
передать nil или пустой список, получим битый SQL, потому что автор этого не
предусмотрел. И конечно, инъекции во все поля.</p>

<p>Почему-то программисты не могут записать и получить данные из базы. Им нужна
ORM, и чтобы она сразу мапилась на REST. Получается километр глючного кода без
документации и поддержки. Автор ORM отлынивает от задач под видом ее
доработки. Часть команды уходит в партизаны: работают с базой через SELECT и
UPDATE в обход ORM. Так спокойней, главное чтобы автор ORM не зашел в
пулл-реквест.</p>

<p>Разработчики игнорируют линтеры. Проект уже не раз сменил команду, люди пишут в
разных редакторах, и ни у кого он толком не настроен. Кривые отступы, экраны
закомментированного кода, неиспользуемые импорты и переменные. Это в порядке
вещей.</p>

<p>Программисты не доводят дело до конца, хотя в бóльшей степени это упрек
руководству. Например, у кого-то задача, чтобы была документация
Swagger. Человек пишет генератор json-файла, покрывает тестами, все
готово. Осталось захостить, чтобы документацию увидели клиенты. Но прилетает
горящая задача или девопс-инженер уходит в отпуск. В итоге документация есть, но
ее никто не видит. Задача не достигнута, время потрачено зря, но это никого не
смущает. Недостигнутые цели я вижу постоянно.</p>

<p>Сюда же относятся висящие пул-реквесты. Открываешь борду и видишь у кого пять, а
у кого семь пул-реквестов. Зачем программист писал код, если его не принимают?
Если бы он смотрел Ютуб, эффект был бы тот же. Почти во всех системах можно
задать auto-expire, не говоря уж о ботах, которых полно.</p>

<p>Беда с локальным окружением. Программисту лень потратить день на
<code class="language-plaintext highlighter-rouge">docker-compose.yaml</code>, чтобы сервисы работали локально. Приходится объяснять,
что локальный ресурс лучше стейджинга где-то в Амазоне.</p>

<p>Иной программист генерит айдишники для базы вручную. Берет рандом от 0 до 9999 и
густо перчит номером треда, числом миллисекунд и фазой Луны. И это работает в
проде.</p>

<p>Программисты любят кокетничать, что уперлись в базу: терабайты данных, не
вывозит нагрузку, все дела. При этом в базу уходят кривейшие запросы, а сама она
превратилась в свалку, потому что там хранят кэш, логи S3 и черт знает что.</p>

<p>У программистов туго с отладкой. Под отладкой я имею в виду остановку кода на
середине, чтобы выяснить локальные переменные. Это могут единицы. Остальные либо
ставят принты и мотают экраны логов, либо вообще сдаются. Иные заявляют, что в
божественной Кложе отладчик не нужен. Это вообще за гранью.</p>

<p>И наконец, главное: карго-культ. Так писали до нас, так пишем и мы. Кривой
нейминг? Дурацкая организация кода? Ничего, консистенси важнее. И хотя прошлый
разраб видел Кложу второй раз в жизни, все следуют его бредовым начинаниям.</p>

<p>Все это я видел даже когда писал на Дельфи и 1С до прихода в промышленную
разработку. Меняются лица, а косяки остаются с нами. Конечно, я их тоже
совершал, но будучи записанными, они переживаются легче.</p>

<p>Все, отпустило, работаем дальше.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/gpt-help/">Помощь Chat GPT</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2023-04-18T00:00:00+00:00">
        Apr 18, 2023
    </time>

    <a href="/tag/life/" rel="tag">life</a>, <a href="/tag/ai/" rel="tag">ai</a>, <a href="/tag/chat-gpt/" rel="tag">chat-gpt</a>, <a href="/tag/latex/" rel="tag">latex</a>

</div>


            <div class="entry">
                
                    <p>Сегодня я столкнулся с “помощью” Chat GPT, а точнее — его необдуманным применением.</p>

<p>Я немного занимаюсь Латехом, и когда верстал книгу, решал массу технических вопросов. Что-то вышло изящно, а что-то нет: работает, но коробит душу. Хочу закрыть эти недостатки в будущем.</p>

<p>Добрые люди подсказали группу в Телеграме, где тусят любители Латеха. Зашел туда и задал наболевший вопрос про жирный шрифт в minted. Через какое-то время один пользователь (судя по био, женщина), скинула ответ с примером на Латехе. Я горячо поблагодарил и побежал пробовать.</p>

<p>Запускаю — ошибка, что нет такого-то свойства. Ладно, думаю, устарели пакеты. Обновил все под чистую. Запускаю — то же самое. Что же это за свойство? Полез в документацию пакета, а там его вообще нет. Пакет ничего не знает об этом свойстве.</p>

<p>Посмотрел на ответ свежим взглядом и понял — это Chat GPT (вчера вечером мозги были уже не те). Во-первых, в нем повествовательный стиль: “обратите внимание”, “вы можете” и так далее. От первого лица в Телеграме так не пишут. Во-вторых, в копипасте я нашел артефакты, свойственные интерфейсу Chat GPT. В частности, название языка перед участком кода (python, latex). Их всегда забывают вычистить при копировании ответа целиком.</p>

<p>Что тут можно сказать? История не нова. Помните сервисы вопросов и ответов на Яндексе и Мейл.ру? Раньше домохозяйки копировали с Википедии. Теперь то же самое, только научились пользоваться Chat GPT. Понимаю, почему на StackOverflow запретили им пользоваться — можно засрать сервис нерабочим кодом без какой-либо ответственности.</p>

<p>Лишний раз убеждаюсь в том, <a href="/ai/">о чем писал недавно</a>. Chat GPT — это никакой не интеллект. Это языковая модель, которая производит текст, максимально близкий к вопросу. Ей неважно, работает код или нет, у нее другие метрики. А мне, наоборот, важно. Мне платят за код, который не только <strong>выглядит</strong> хорошо, но и <strong>работает</strong> хорошо. Единственный способ проверить код — запустить его и предъявить результат работы. Этого Chat GPT не может, и поэтому мне с ним не по пути.</p>

                
            </div>

        </li>
        
    </ul>

    <h4>
        
        <span class="page_number ">Страница 1 из 62</span>
        
        <a href="/page2" class="next">&rarr;</a>
        
    </h4>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Ivan Grishaev's blog</li>
          <li><a href="mailto:ivan@grishaev.me">ivan@grishaev.me</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
            <li><a href="https://github.com/igrishaev">GitHub</a></li>
            <li><a href="tg://resolve?domain=igrishaev_blog">Telegram</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Writing on programming, education, books and negotiations.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
