<!DOCTYPE html>
<html lang="ru">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Ivan Grishaev's blog</title>
  <meta name="description" content="Writing on programming, education, books and negotiations.
">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/custom.css">
  <link rel="canonical" href="https://grishaev.me/">
  <link rel="alternate" type="application/rss+xml" title="Ivan Grishaev's blog" href="https://grishaev.me/feed.xml">

  <link rel="shortcut icon" type="image/x-icon" href="/assets/static/favicons/favicon.ico">

  <script type="text/javascript" src="/assets/typo.js"></script>

</head>


  <body>
    <header class="site-header">

    <div class="wrapper flex-container">

        <div>
            <a href="/">
                <img id="avatar" src="/assets/static/avatar.jpg" alt="Ivan Grishaev">
            </a>
        </div>

        <div class="flex-container-vert" style="margin-left: 15px; width: 80%">

            <div class="flex-container full-width">
                <p style="margin-bottom: 5px">Ivan Grishaev's blog</p>
                <div class="flex-huge"></div>
                <div >
<form id="search-form"
      target="_blank"
      style="display: inline"
      method="get"
      action="https://www.google.com/search">

    <input name="sitesearch"
           value="grishaev.me"
           type="hidden">

    <input type="text"
           required="required"
           name="q"
           placeholder="Google search..."
           autocomplete="off">

    <button style="border: none; background-color: transparent; cursor: pointer;"
            type="submit">&#x1f50d;</button>

</form>
</div>
            </div>

            <p><small>Writing on programming, education, books and negotiations.
</small></p>

            <div class="flex-container">
                <a class="menu-item" href="/">Home</a>
                <a class="menu-item" href="/about/">About</a>
                <a class="menu-item" href="/bookshelf/">Bookshelf</a>
                <a class="menu-item" href="/feed.xml">RSS</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor" href="/tag/clojure/">Clojure</a>
                <a class="menu-item minor" href="/tag/emacs/">Emacs</a>
                <a class="menu-item minor" href="/tag/python/">Python</a>
                <a class="menu-item minor" href="/tag/programming/">Programming</a>
                <a class="menu-item minor" href="/interview/">Interview</a>
                <a class="menu-item minor" href="/video/">Video</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor hl" href="/clojure-in-prod/">Книга «Clojure на производстве»</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor hl" href="/clojure-in-prod-2/">Книга «Clojure на производстве», второй том</a>
            </div>

        </div>
    </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="home">

    <ul class="post-list">
        
        <li>

            <h2>
                <a class="post-link" href="/three-states/">Три состояния</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2025-04-24T00:00:00+00:00">
        Apr 24, 2025
    </time>

    <a href="/tag/life/" rel="tag">life</a>

</div>


            <div class="entry">
                
                    <p>Упрощая, можно сказать, что человек бывает в трех состояниях: когда он один,
когда с кем-то наедине и когда вокруг двое и более людей. В последнем случае
неважно, сколько именно: два, три или сотня. Разница есть, но
несущественная. Поэтому рассматриваю только варианты 0, 1 и 2+.</p>

<p>В каждом из состояний человек ведет себя по-разному. Фактически это три роли,
между которыми мы часто переключаемся.</p>

<p>Понимание этих переключений помогает в жизни. Если человек хочет побыть один, не
лезь с разговорами. Чтение книги и просмотр фильма относятся сюда же, потому что
оба – про уход в себя.</p>

<p>Если человек в компании, не начинай важный разговор. При свидетелях человек
думает прежде всего о том, как прикрыть свой зад и не опозориться перед
другими. Здравый смысл отодвигается на второй план: репутация важнее.</p>

<p>Все сводится к тому, что любой разговор можно завалить, если начать его с
человеком в неподходящем состоянии. С другой стороны – почти любой разговор
можно завершить успехом, если собеседник в правильном состоянии. Осталось
понять: где, когда и с кем, а остальное просто.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/obsidian/">Про Обсидиан</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2025-04-24T00:00:00+00:00">
        Apr 24, 2025
    </time>

    <a href="/tag/obsidian/" rel="tag">obsidian</a>, <a href="/tag/life/" rel="tag">life</a>, <a href="/tag/notes/" rel="tag">notes</a>

</div>


            <div class="entry">
                
                    <p>Это заметка про Обсидиан, которая не понравится никому. Тем не менее…</p>

<p>В программе Обсидиан ничего плохого нет. Наоборот, это хорошая программа: у нее
даже есть признаки адекватности. С ней можно начать без облачной учетки, хотя
другая программа потребовала бы ее на старте и напоминала бы каждые пять минут:
дорогой, ты не авторизован! Данные пропадут, скорей оформи подписку.</p>

<p>Меня смущает не программа Обсидиан, а ее пользователи. Здесь прямая аналогия с
механическими клавиатурами. В них нет ничего плохого, но есть пользователи,
которые годами крафтят кастомные клавиатуры и годами их обсуждают. Точно так же
пользователи Обсидиана придают много внимание тому, что этого не стоит.</p>

<p>Обсидиан и аналоги создали некую моду: все толковые ребята ведут цифровые
заметки, <a href="/zettelkasten/">аналог Цеттелькассена</a>. Если ты ведешь Обсидиан, ты
профессионально растешь, ты крут, свой чувак. А если нет – фу-фу.</p>

<p>Эта мода сквозит в различных сообществах и Телеграм-каналах; об этом говорят в
комментариях ко всем статьям на тему заметок. Пишут статьи о том, как из набора
сервисов собрать свой “чемодан заметок”. В первом же комментарии упоминают
Обсидиан, и начинается срач.</p>

<p>Обсидиан вывел в тренд некрасивую привычку: показывать всем свой граф
знаний. Подобно владельцу айфона, который только что его купил и открывает без
надобности, пользователь Обсидиана без конца смотрит на граф
заметок. Искусственно наращивает его, добавляет лишние связи, потому что теория
“чемодана” учит, что заметок без связей быть не должно. Стоит ли говорить, что
этот граф – всего лишь ментальный онанизм.</p>

<p>Я не верю, что заметки и граф связей как-то помогают в обучении. Человек на
полном серьезе пишет, что благодаря Обсидиану “выучил” Питон. То есть он
прослушал лекции и для каждого урока составил заметки и связал их. Разумеется,
попади он в первый проект на Питоне, эти заметки пойдут лесом. Важно не
составлять заметки, а практиковать знания и закреплять их практикой. Скажем,
прослушал урок про списки в Питоне – открываешь учебник по Турбо-Паскалю и
прорешиваешь 20 задач, заменяя слово “массив” на “список”. От этого есть польза,
а от цифровой заметки – нет.</p>

<p>То же самое пишет Барбара Оакли в книге “Думай как математик”, а также ее
колеги-преподы. Все они утверждают, что конспектирование – это хорошо, но
гораздо важнее вспоминать и пересказывать материал самому себе, а также скорее
закрепить его практикой. Без этого конспектирование дает лишь видимость изучения
и уподобляется <a href="/no-book-marks/">подчеркиванию в книгах</a>.</p>

<p>Я с трудом представляю, для чего люди ведут заметки в Обсидиане. Изучаешь ты,
например, Питон, пишешь заметки к видеокурсу. Так заведи публичный канал в
Телеграме и пиши туда! – пусть другие тоже видят, комментируют,
поправляют. Всем польза. Для списка ссылок Обсидиан явно избыточен, подойдет
файлик или скрытый канал в Телеграме. Для списка дел и дневника подходит обычный
блокнот. Зачем брать какую-то программу?..</p>

<p>О том, что при работе с бумагой и ручкой мозг работает по-другому, я писал сотню
раз и не буду повторять. Просто попробуйте.</p>

<p>В книге Make Time один из авторов приводит хороший пример. Он подсел на
программу заметок, и после обновления операционки она отвалилась. Автор к тому
времени забил и обновление не выпустил. Вряд ли это случится с Обсидианом, но
тем не менее: не нужно становиться заложником софта.</p>

<p>Верный признак того, что Обсидиан избыточен – это обилие инструментов к
нему. Фирма, которая его пишет, вынуждена тащить все подряд, чтобы удовлетворить
всех. Помните, это как вкладки в браузере? Кому-то вертикальные, кому-то
горизонтальные, по кругу, с предпросмотром, с попапом с данными о потребленной
памяти, с закрытием по таймеру и так далее.</p>

<p>Не за горами час, когда вы обновите свой Обсидиан и обнаружите, что он стал
медленным и появились интеграции с Твиттером, Покетом и бог знает чем – все
потому, что об этом попросили упоротые клиенты, а менеджмент пошел на
поводу. Если вам это ни о чем не говорит, погуглите историю сервиса Evernote.</p>

<p>Еще напомню про Агату Кристи, которая написала 50 томов без Обсидиана. Стивен
Кинг пользовался блокнотом: первая электронная печатная машинка (даже не
компьютер) появилась у него в зрелом возрасте. Чтобы дать что-то миру, вам не
нужна программа электронных заметок. Все уже здесь.</p>

<p>Обсидиан сегодня – это мода. Это забавная программа вроде Майнкрафта, в которую
не зазорно играть взрослым. Строишь свой мирок, наблюдаешь прогресс, делишься
успехом с друзьями. Не возводите его в культ. Не будьте чуваком с картинки
ниже. Это пройдет.</p>

<p><img src="/assets/static/aws/obsidian/1.jpeg" /></p>


                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/no-business/">Программисты и бизнес</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2025-04-24T00:00:00+00:00">
        Apr 24, 2025
    </time>

    <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/business/" rel="tag">business</a>

</div>


            <div class="entry">
                
                    <p>Иные говорящие головы двигают такой тезис: хороший программист по мере развития
все больше приобщается к бизнесу. Думает, как улучшить продукт, повысить
конверсии-воронки и все такое… ходит на совещания с владельцами бизнеса.</p>

<p>Ну… не знаю. Пытался играть в эти игры, но не смог. Мне не интересен
бизнес. Не интересно, сколько пользователей привлекли, сколько уников зашло и
так далее. Не мое это, хоть убейте.</p>

<p>Мне интересен код. Люблю делать задачу максимально просто: поменьше библиотек,
меньше сервисов, без ОРМ. Пишу тесты, добиваюсь, чтобы все случаи покрывались
локально, без облака. В общем-то и все. За это прошу лишь минимальную свободу и
право выбора технологий.</p>

<p>И знаете, кажется, это то, чего от меня ждут. Заказчик хочет, чтобы задача была
сделана быстро и качественно, и чтобы в будущем можно было легко поправить. Это
я и делаю. Не имею понятия, кто и как пользуется моей работой, и бывает, узнаю
об этом через год.</p>

<p>Я совершенно не сочувствую бизнесу, когда дела идут плохо. Это не мое дело. Я
работал в настолько абсурдных стартапах, что искренне недоумевал, что в них
кто-то верит. Их судьба предопределена, единственный вопрос — сколько раундов
инвестиций они протянут. И еще: сколько опыта я унесу с собой после ухода.</p>

<p>Поэтому рассказы про лояльность бизнесу на меня не действуют. Я пишу
качественный код и получаю деньги. Если код не принес прибыли — извините, тут
помочь не могу.</p>

<p>Вряд ли я достойный пример для подражания, но рассказы про бизнес нужно
воспринимать с прохладой. Это лапша.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/limiter/">Вертикальная полоса</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2025-04-24T00:00:00+00:00">
        Apr 24, 2025
    </time>

    <a href="/tag/life/" rel="tag">life</a>, <a href="/tag/monitor/" rel="tag">monitor</a>

</div>


            <div class="entry">
                
                    <p>Как-то сижу, быдлокодю понемножку и замечаю, что в редакторе включена
вертикальная полоса – ограничитель 80 символов. Думаю: странно, не помню, что
ее включал. Я таким не пользуюсь – переношу код согласно внутреннему чутью. Но
пусть будет, тем более что лень искать, как выключить.</p>

<p>А через месяц я подвинул окно и обнаружил, что это не ограничитель, а
вертикальный ряд битых пикселей. Представьте, он не двигается за редактором и
искажает цвет в любой программе.</p>

<p>Может быть, в прошлом я бы устроил внутреннюю истерику: как так, 4к-монитор, 144
герц, и вдруг сдох целый ряд. Но потом я подвинул редактор на место и продолжил
быдлокодить. С тех пор притворяюсь, что это ограничитель.</p>

<p>Чем меньше истерик – как внешних, так и внутренних – тем лучше для
психики. Мне кажется, это правило продлевает жизнь, хоть и доказывать еще рано.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/jsam/">JSAM: a simple JSON writer and reader</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2025-04-24T00:00:00+00:00">
        Apr 24, 2025
    </time>

    <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/clojure/" rel="tag">clojure</a>, <a href="/tag/json/" rel="tag">json</a>, <a href="/tag/jsam/" rel="tag">jsam</a>

</div>


            <div class="entry">
                
                    
<p><a href="https://github.com/igrishaev/jsam">JSam</a> is a lightweight, zero-deps JSON parser and writer. Named after
<a href="https://metalgear.fandom.com/wiki/Samuel_Rodrigues">Jetstream Sam</a>.</p>

<ul>
  <li>Small: only 14 Java files with no extra libraries;</li>
  <li>Not the fastest one but is pretty good (see the chart below);</li>
  <li>Has got its own features, e.g. read and write multiple values;</li>
  <li>Flexible and extendable.</li>
</ul>

<h2 id="installation">Installation</h2>

<p>Requires Java version at least 17. Add a new dependency:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">;; lein</span><span class="w">
</span><span class="p">[</span><span class="n">com.github.igrishaev/jsam</span><span class="w"> </span><span class="s">"0.1.0"</span><span class="p">]</span><span class="w">

</span><span class="c1">;; deps</span><span class="w">
</span><span class="n">com.github.igrishaev/jsam</span><span class="w"> </span><span class="p">{</span><span class="no">:mvn/version</span><span class="w"> </span><span class="s">"0.1.0"</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Import the library:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">ns</span><span class="w"> </span><span class="n">org.some.project</span><span class="w">
  </span><span class="p">(</span><span class="no">:require</span><span class="w">
    </span><span class="p">[</span><span class="n">jsam.core</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">jsam</span><span class="p">]))</span><span class="w">
</span></code></pre></div></div>

<h2 id="reading">Reading</h2>

<p>To read a string:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">jsam/read-string</span><span class="w"> </span><span class="s">"[42.3e-3, 123, \"hello\", true, false, null, {\"some\": \"map\"}]"</span><span class="p">)</span><span class="w">

</span><span class="p">[</span><span class="mf">0.0423</span><span class="w"> </span><span class="mi">123</span><span class="w"> </span><span class="s">"hello"</span><span class="w"> </span><span class="n">true</span><span class="w"> </span><span class="n">false</span><span class="w"> </span><span class="n">nil</span><span class="w"> </span><span class="p">{</span><span class="no">:some</span><span class="w"> </span><span class="s">"map"</span><span class="p">}]</span><span class="w">
</span></code></pre></div></div>

<p>To read any kind of a source: a file, a URL, a socket, an input stream, a
reader, etc:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">jsam/read</span><span class="w"> </span><span class="s">"data.json"</span><span class="p">)</span><span class="w"> </span><span class="c1">;; a file named data.json</span><span class="w">
</span><span class="p">(</span><span class="nf">jsam/read</span><span class="w"> </span><span class="p">(</span><span class="nf">io/input-stream</span><span class="w"> </span><span class="n">...</span><span class="p">))</span><span class="w">
</span><span class="p">(</span><span class="nf">jsam/read</span><span class="w"> </span><span class="p">(</span><span class="nf">io/reader</span><span class="w"> </span><span class="n">...</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<p>Both functions accept an optional map of settings:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">jsam/read-string</span><span class="w"> </span><span class="s">"..."</span><span class="w"> </span><span class="p">{</span><span class="n">...</span><span class="p">})</span><span class="w">
</span><span class="p">(</span><span class="nf">jsam/read</span><span class="w"> </span><span class="p">(</span><span class="nf">io/file</span><span class="w"> </span><span class="n">...</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="n">...</span><span class="p">})</span><span class="w">
</span></code></pre></div></div>

<p>Here is a table of options that affect reading:</p>

<table>
  <thead>
    <tr>
      <th>option</th>
      <th>default</th>
      <th>comment</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:read-buf-size</code></td>
      <td>8k</td>
      <td>Size of a buffer to read</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:temp-buf-scale-factor</code></td>
      <td>2</td>
      <td>Scale factor for an innter buffer</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:temp-buf-size</code></td>
      <td>255</td>
      <td>Inner temp buffer initial size</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:parser-charset</code></td>
      <td>UTF-8</td>
      <td>Must be an instance of <code class="language-plaintext highlighter-rouge">Charset</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:arr-supplier</code></td>
      <td><code class="language-plaintext highlighter-rouge">jsam.core/sup-arr-clj</code></td>
      <td>An object to collect array values</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:obj-supplier</code></td>
      <td><code class="language-plaintext highlighter-rouge">jsam.core/sup-obj-clj</code></td>
      <td>An object to collect key-value pairs</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:bigdec?</code></td>
      <td><code class="language-plaintext highlighter-rouge">false</code></td>
      <td>Use BigDecimal when parsing numbers</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:fn-key</code></td>
      <td><code class="language-plaintext highlighter-rouge">keyword</code></td>
      <td>A function to process keys</td>
    </tr>
  </tbody>
</table>

<p>If you want keys to stay strings, and parse large numbers using <code class="language-plaintext highlighter-rouge">BigDecimal</code> to
avoid infinite values, this is what you pass:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">jsam/read-string</span><span class="w"> </span><span class="s">"..."</span><span class="w"> </span><span class="p">{</span><span class="no">:fn-key</span><span class="w"> </span><span class="nb">identity</span><span class="w"> </span><span class="no">:bigdec?</span><span class="w"> </span><span class="n">true</span><span class="p">})</span><span class="w">
</span></code></pre></div></div>

<p>We will discuss suppliers a bit later.</p>

<h2 id="writing">Writing</h2>

<p>To dump data into a string, use <code class="language-plaintext highlighter-rouge">write-string</code>:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">jsam/write-string</span><span class="w"> </span><span class="p">{</span><span class="no">:hello</span><span class="w"> </span><span class="s">"test"</span><span class="w"> </span><span class="no">:a</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="n">nil</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mf">42.123</span><span class="p">]})</span><span class="w">

</span><span class="s">"{\"hello\":\"test\",\"a\":[1,null,3,42.123]}"</span><span class="w">
</span></code></pre></div></div>

<p>To write into a destination, which might be a file, an output stream, a writer,
etc, use <code class="language-plaintext highlighter-rouge">write</code>:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">jsam/write</span><span class="w"> </span><span class="s">"data2.json"</span><span class="w"> </span><span class="p">{</span><span class="no">:hello</span><span class="w"> </span><span class="s">"test"</span><span class="w"> </span><span class="no">:a</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="n">nil</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mf">42.123</span><span class="p">]})</span><span class="w">

</span><span class="c1">;; or</span><span class="w">

</span><span class="p">(</span><span class="nf">jsam/write</span><span class="w"> </span><span class="p">(</span><span class="nf">io/file</span><span class="w"> </span><span class="n">...</span><span class="p">))</span><span class="w">

</span><span class="c1">;; or</span><span class="w">

</span><span class="p">(</span><span class="nb">with-open</span><span class="w"> </span><span class="p">[</span><span class="n">writer</span><span class="w"> </span><span class="p">(</span><span class="nf">io/writer</span><span class="w"> </span><span class="n">...</span><span class="p">)]</span><span class="w">
  </span><span class="p">(</span><span class="nf">jsam/write</span><span class="w"> </span><span class="n">writer</span><span class="w"> </span><span class="p">{</span><span class="n">...</span><span class="p">}))</span><span class="w">
</span></code></pre></div></div>

<p>Both functions accept a map of options for writing:</p>

<table>
  <thead>
    <tr>
      <th>option</th>
      <th>default</th>
      <th>comment</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:writer-charset</code></td>
      <td>UTF-8</td>
      <td>Must be an instance of <code class="language-plaintext highlighter-rouge">Charset</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:pretty?</code></td>
      <td><code class="language-plaintext highlighter-rouge">false</code></td>
      <td>Use indents and line breaks</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:pretty-indent</code></td>
      <td>2</td>
      <td>Indent growth for each level</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:multi-separator</code></td>
      <td><code class="language-plaintext highlighter-rouge">\n</code></td>
      <td>How to split multiple values</td>
    </tr>
  </tbody>
</table>

<p>This is how you pretty-print data:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">jsam/write</span><span class="w"> </span><span class="s">"data3.json"</span><span class="w">
            </span><span class="p">{</span><span class="no">:hello</span><span class="w"> </span><span class="s">"test"</span><span class="w"> </span><span class="no">:a</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="p">{</span><span class="no">:foo</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="p">[</span><span class="mi">42</span><span class="p">]</span><span class="w"> </span><span class="mi">3</span><span class="p">]}</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mf">42.123</span><span class="p">]}</span><span class="w">
            </span><span class="p">{</span><span class="no">:pretty?</span><span class="w"> </span><span class="n">true</span><span class="w">
             </span><span class="no">:pretty-indent</span><span class="w"> </span><span class="mi">4</span><span class="p">})</span><span class="w">
</span></code></pre></div></div>

<p>This is what you’ll get (maybe needs some further adjustment):</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"hello"</span><span class="p">:</span><span class="w"> </span><span class="s2">"test"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"a"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="mi">1</span><span class="p">,</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"foo"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                </span><span class="mi">1</span><span class="p">,</span><span class="w">
                </span><span class="p">[</span><span class="w">
                    </span><span class="mi">42</span><span class="w">
                </span><span class="p">],</span><span class="w">
                </span><span class="mi">3</span><span class="w">
            </span><span class="p">]</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="mi">3</span><span class="p">,</span><span class="w">
        </span><span class="mf">42.123</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h2 id="handling-multiple-values">Handling Multiple Values</h2>

<p>When you have 10.000.000 of rows of data to dump into JSON, a regular approach
is not developer friendly. It leads to a single array with 10M items that you
read into memory at once. Only few libraries provide facilities to read arrays
lazily.</p>

<p>It’s much better to dump rows one by one into a stream and then read them one by
one without saturating memory. Here is how you do it:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">jsam/write-multi</span><span class="w"> </span><span class="s">"data4.json"</span><span class="w">
                  </span><span class="p">(</span><span class="k">for</span><span class="w"> </span><span class="p">[</span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="nb">range</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">3</span><span class="p">)]</span><span class="w">
                    </span><span class="p">{</span><span class="no">:x</span><span class="w"> </span><span class="n">x</span><span class="p">}))</span><span class="w">
</span></code></pre></div></div>

<p>The second argument is a collection that might be lazy as well. The content of
the file is:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="nl">"x"</span><span class="p">:</span><span class="mi">0</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="nl">"x"</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="nl">"x"</span><span class="p">:</span><span class="mi">2</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Now read it back:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nb">doseq</span><span class="w"> </span><span class="p">[</span><span class="n">item</span><span class="w"> </span><span class="p">(</span><span class="nf">jsam/read-multi</span><span class="w"> </span><span class="s">"data4.json"</span><span class="p">)]</span><span class="w">
  </span><span class="p">(</span><span class="nb">println</span><span class="w"> </span><span class="n">item</span><span class="p">))</span><span class="w">

</span><span class="c1">;; {:x 0}</span><span class="w">
</span><span class="c1">;; {:x 1}</span><span class="w">
</span><span class="c1">;; {:x 2}</span><span class="w">
</span></code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">read-multi</code> function returns a <strong>lazy</strong> iterable object meaning it won’t
read everything at once. Also, both <code class="language-plaintext highlighter-rouge">write-</code> and <code class="language-plaintext highlighter-rouge">read-multi</code> functions are
pretty-print friendly:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">;; write</span><span class="w">
</span><span class="p">(</span><span class="nf">jsam/write-multi</span><span class="w"> </span><span class="s">"data5.json"</span><span class="w">
                  </span><span class="p">(</span><span class="k">for</span><span class="w"> </span><span class="p">[</span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="nb">range</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">3</span><span class="p">)]</span><span class="w">
                    </span><span class="p">{</span><span class="no">:x</span><span class="w"> </span><span class="p">[</span><span class="n">x</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">x</span><span class="p">]})</span><span class="w">
                  </span><span class="p">{</span><span class="no">:pretty?</span><span class="w"> </span><span class="n">true</span><span class="p">})</span><span class="w">

</span><span class="c1">;; read</span><span class="w">
</span><span class="p">(</span><span class="nb">doseq</span><span class="w"> </span><span class="p">[</span><span class="n">item</span><span class="w"> </span><span class="p">(</span><span class="nf">jsam/read-multi</span><span class="w"> </span><span class="s">"data5.json"</span><span class="p">)]</span><span class="w">
  </span><span class="p">(</span><span class="nb">println</span><span class="w"> </span><span class="n">item</span><span class="p">))</span><span class="w">

</span><span class="c1">;; {:x [0 0 0]}</span><span class="w">
</span><span class="c1">;; {:x [1 1 1]}</span><span class="w">
</span><span class="c1">;; {:x [2 2 2]}</span><span class="w">
</span></code></pre></div></div>

<p>The content of the data5.json file:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"x"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="mi">0</span><span class="p">,</span><span class="w">
    </span><span class="mi">0</span><span class="p">,</span><span class="w">
    </span><span class="mi">0</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="w">
  </span><span class="nl">"x"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="mi">1</span><span class="p">,</span><span class="w">
    </span><span class="mi">1</span><span class="p">,</span><span class="w">
    </span><span class="mi">1</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="p">{</span><span class="w">
  </span><span class="nl">"x"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="mi">2</span><span class="p">,</span><span class="w">
    </span><span class="mi">2</span><span class="p">,</span><span class="w">
    </span><span class="mi">2</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h2 id="type-mapping-and-extending">Type Mapping and Extending</h2>

<p>This chapter covers how to control type mapping between Clojure and JSON realms.</p>

<p>Writing is served using a protocol named <code class="language-plaintext highlighter-rouge">jsam.core/IJSON</code> with a single encidng
method:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">defprotocol</span><span class="w"> </span><span class="n">IJSON</span><span class="w">
  </span><span class="p">(</span><span class="nf">-encode</span><span class="w"> </span><span class="p">[</span><span class="n">this</span><span class="w"> </span><span class="n">writer</span><span class="p">]))</span><span class="w">
</span></code></pre></div></div>

<p>The default mapping is the following:</p>

<table>
  <thead>
    <tr>
      <th>Clojure</th>
      <th>JSON</th>
      <th>Comment</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>nil</td>
      <td>null</td>
      <td> </td>
    </tr>
    <tr>
      <td>String</td>
      <td>string</td>
      <td> </td>
    </tr>
    <tr>
      <td>Boolean</td>
      <td>bool</td>
      <td> </td>
    </tr>
    <tr>
      <td>Number</td>
      <td>number</td>
      <td> </td>
    </tr>
    <tr>
      <td>Ratio</td>
      <td>string</td>
      <td>e.g. <code class="language-plaintext highlighter-rouge">(/ 3 2)</code> -&gt; <code class="language-plaintext highlighter-rouge">"3/2"</code></td>
    </tr>
    <tr>
      <td>Atom</td>
      <td>any</td>
      <td>gets <code class="language-plaintext highlighter-rouge">deref</code>-ed</td>
    </tr>
    <tr>
      <td>Ref</td>
      <td>any</td>
      <td>gets <code class="language-plaintext highlighter-rouge">deref</code>-ed</td>
    </tr>
    <tr>
      <td>List</td>
      <td>array</td>
      <td>lazy seqs as well</td>
    </tr>
    <tr>
      <td>Map</td>
      <td>object</td>
      <td>keys coerced to strings</td>
    </tr>
    <tr>
      <td>Keyword</td>
      <td>string</td>
      <td>leading <code class="language-plaintext highlighter-rouge">:</code> is trimmed</td>
    </tr>
  </tbody>
</table>

<p>Anything else gets encoded like a string using the <code class="language-plaintext highlighter-rouge">.toString</code> invocation under
the hood:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">extend-protocol</span><span class="w"> </span><span class="n">IJSON</span><span class="w">
  </span><span class="n">...</span><span class="w">
  </span><span class="n">Object</span><span class="w">
  </span><span class="p">(</span><span class="nf">-encode</span><span class="w"> </span><span class="p">[</span><span class="n">this</span><span class="w"> </span><span class="o">^</span><span class="n">JsonWriter</span><span class="w"> </span><span class="n">writer</span><span class="p">]</span><span class="w">
    </span><span class="p">(</span><span class="nf">.writeString</span><span class="w"> </span><span class="n">writer</span><span class="w"> </span><span class="p">(</span><span class="nb">str</span><span class="w"> </span><span class="n">this</span><span class="p">)))</span><span class="w">
  </span><span class="n">...</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>Here is how you override encoding. Imagine you have a special type <code class="language-plaintext highlighter-rouge">SneakyType</code>:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">deftype</span><span class="w"> </span><span class="n">SneakyType</span><span class="w"> </span><span class="p">[</span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="n">c</span><span class="p">]</span><span class="w">

  </span><span class="c1">;; some protocols...</span><span class="w">

  </span><span class="n">jsam/IJSON</span><span class="w">
  </span><span class="p">(</span><span class="nf">-encode</span><span class="w"> </span><span class="p">[</span><span class="n">this</span><span class="w"> </span><span class="n">writer</span><span class="p">]</span><span class="w">
    </span><span class="p">(</span><span class="nf">jsam/-encode</span><span class="w"> </span><span class="p">[</span><span class="s">"I used to be a SneakyType"</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="n">c</span><span class="p">]</span><span class="w"> </span><span class="n">writer</span><span class="p">)))</span><span class="w">
</span></code></pre></div></div>

<p>Test it:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">data1</span><span class="w"> </span><span class="p">{</span><span class="no">:foo</span><span class="w"> </span><span class="p">(</span><span class="nb">new</span><span class="w"> </span><span class="n">SneakyType</span><span class="w"> </span><span class="no">:a</span><span class="w"> </span><span class="s">"b"</span><span class="w"> </span><span class="mi">42</span><span class="p">)}</span><span class="w">
      </span><span class="n">string</span><span class="w"> </span><span class="p">(</span><span class="nf">jsam/write-string</span><span class="w"> </span><span class="n">data1</span><span class="p">)]</span><span class="w">
  </span><span class="p">(</span><span class="nf">jsam/read-string</span><span class="w"> </span><span class="n">string</span><span class="p">))</span><span class="w">

</span><span class="c1">;; {:foo ["I used to be a SneakyType" "a" "b" 42]}</span><span class="w">
</span></code></pre></div></div>

<p>When reading the data, there is a way to specify how array and object values get
collected. Options <code class="language-plaintext highlighter-rouge">:arr-supplier</code> and <code class="language-plaintext highlighter-rouge">:obj-supplier</code> accept a <code class="language-plaintext highlighter-rouge">Supplier</code>
instance where the <code class="language-plaintext highlighter-rouge">get</code> method returns instances of <code class="language-plaintext highlighter-rouge">IArrayBuilder</code> or
<code class="language-plaintext highlighter-rouge">IObjectBuilder</code> interfaces. Each interface knows how to add a value into a
collection how to finalize it.</p>

<p>Default implementations build Clojure persistent collections like
<code class="language-plaintext highlighter-rouge">PersistentVector</code> or <code class="language-plaintext highlighter-rouge">PersistenHashMap</code>. There is a couple of Java-specific
suppliers that build <code class="language-plaintext highlighter-rouge">ArrayList</code> and <code class="language-plaintext highlighter-rouge">HashMap</code>, respectively. Here is how you
use them:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">jsam/read-string</span><span class="w"> </span><span class="s">"[1, 2, 3]"</span><span class="w">
                  </span><span class="p">{</span><span class="no">:arr-supplier</span><span class="w"> </span><span class="n">jsam/sup-arr-java</span><span class="p">})</span><span class="w">

</span><span class="c1">;; [1 2 3]</span><span class="w">
</span><span class="c1">;; java.util.ArrayList</span><span class="w">

</span><span class="p">(</span><span class="nf">jsam/read-string</span><span class="w"> </span><span class="s">"{\"test\": 42}"</span><span class="w">
                  </span><span class="p">{</span><span class="no">:obj-supplier</span><span class="w"> </span><span class="n">jsam/sup-obj-java</span><span class="p">})</span><span class="w">

</span><span class="c1">;; {:test 42}</span><span class="w">
</span><span class="c1">;; java.util.HashMap</span><span class="w">
</span></code></pre></div></div>

<p>Here are some crazy examples that allow to modify data while you build
collections. For an array:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">arr-supplier</span><span class="w">
      </span><span class="p">(</span><span class="nf">reify</span><span class="w"> </span><span class="n">java.util.function.Supplier</span><span class="w">
        </span><span class="p">(</span><span class="nb">get</span><span class="w"> </span><span class="p">[</span><span class="n">this</span><span class="p">]</span><span class="w">
          </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">state</span><span class="w"> </span><span class="p">(</span><span class="nf">atom</span><span class="w"> </span><span class="p">[])]</span><span class="w">
            </span><span class="p">(</span><span class="nf">reify</span><span class="w"> </span><span class="n">org.jsam.IArrayBuilder</span><span class="w">
              </span><span class="p">(</span><span class="nb">conj</span><span class="w"> </span><span class="p">[</span><span class="n">this</span><span class="w"> </span><span class="n">el</span><span class="p">]</span><span class="w">
                </span><span class="p">(</span><span class="nf">swap!</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="n">clojure.core/conj</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">el</span><span class="w"> </span><span class="mi">10</span><span class="p">)))</span><span class="w">
              </span><span class="p">(</span><span class="nf">build</span><span class="w"> </span><span class="p">[</span><span class="n">this</span><span class="p">]</span><span class="w">
                </span><span class="o">@</span><span class="n">state</span><span class="p">)))))]</span><span class="w">

  </span><span class="p">(</span><span class="nf">jsam/read-string</span><span class="w"> </span><span class="s">"[1, 2, 3]"</span><span class="w">
                    </span><span class="p">{</span><span class="no">:arr-supplier</span><span class="w"> </span><span class="n">arr-supplier</span><span class="p">}))</span><span class="w">

</span><span class="c1">;; [10 20 30]</span><span class="w">
</span></code></pre></div></div>

<p>And for an object:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">obj-supplier</span><span class="w">
      </span><span class="p">(</span><span class="nf">jsam/supplier</span><span class="w">
        </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">state</span><span class="w"> </span><span class="p">(</span><span class="nf">atom</span><span class="w"> </span><span class="p">{})]</span><span class="w">
          </span><span class="p">(</span><span class="nf">reify</span><span class="w"> </span><span class="n">org.jsam.IObjectBuilder</span><span class="w">
            </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="p">[</span><span class="n">this</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="n">v</span><span class="p">]</span><span class="w">
              </span><span class="p">(</span><span class="nf">swap!</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="n">clojure.core/assoc</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="mi">10</span><span class="p">)))</span><span class="w">
            </span><span class="p">(</span><span class="nf">build</span><span class="w"> </span><span class="p">[</span><span class="n">this</span><span class="p">]</span><span class="w">
              </span><span class="o">@</span><span class="n">state</span><span class="p">))))]</span><span class="w">

  </span><span class="p">(</span><span class="nf">jsam/read-string</span><span class="w"> </span><span class="s">"{\"test\": 1}"</span><span class="w">
                    </span><span class="p">{</span><span class="no">:obj-supplier</span><span class="w"> </span><span class="n">obj-supplier</span><span class="p">}))</span><span class="w">

</span><span class="c1">;; {:test 10}</span><span class="w">
</span></code></pre></div></div>

<h2 id="benchmarks">Benchmarks</h2>

<p>Jsam doesn’t try to gain as much performance as possible; tuning JSON reading
and writing is pretty challenging. But so far, the library is not as bad as you
might think! It’s two times slower that Jsonista and slightly slower than
Cheshire. But it’s times faster than data.json which is written in pure Clojure
and thus is so slow.</p>

<p>The chart below renders my measures of reading a 100MB Json file. Then the data
read from this file were dumped into a string. It’s pretty clear that Jsam is
not the best nor the worst one in this competition. I’ll keep the question of
performance for further work.</p>

<p>Measured on MacBook M3 Pro 36Gb.</p>

<p><img src="/assets/static/aws/jsam/1.svg" /></p>

<p>Another benchmark made by <a href="https://github.com/p-himik">Eugene Pakhomov</a>. Reading:</p>

<table>
  <thead>
    <tr>
      <th>size</th>
      <th>jsam mean</th>
      <th>data.json</th>
      <th>cheshire</th>
      <th>jsonista</th>
      <th>jsoniter</th>
      <th>charred</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>10 b</td>
      <td>182 ns</td>
      <td>302 ns</td>
      <td>800 ns</td>
      <td>230 ns</td>
      <td>101 ns</td>
      <td>485 ns</td>
    </tr>
    <tr>
      <td>100 b</td>
      <td>827 ns</td>
      <td>1 µs</td>
      <td>2 µs</td>
      <td>1 µs</td>
      <td>504 ns</td>
      <td>1 µs</td>
    </tr>
    <tr>
      <td>1 kb</td>
      <td>5 µs</td>
      <td>8 µs</td>
      <td>9 µs</td>
      <td>6 µs</td>
      <td>3 µs</td>
      <td>5 µs</td>
    </tr>
    <tr>
      <td>10 kb</td>
      <td>58 µs</td>
      <td>108 µs</td>
      <td>102 µs</td>
      <td>58 µs</td>
      <td>36 µs</td>
      <td>59 µs</td>
    </tr>
    <tr>
      <td>100 kb</td>
      <td>573 µs</td>
      <td>1 ms</td>
      <td>968 µs</td>
      <td>596 µs</td>
      <td>379 µs</td>
      <td>561 µs</td>
    </tr>
  </tbody>
</table>

<p>Writing:</p>

<table>
  <thead>
    <tr>
      <th>size</th>
      <th>jsam mean</th>
      <th>data.json</th>
      <th>cheshire</th>
      <th>jsonista</th>
      <th>jsoniter</th>
      <th>charred</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>10 b</td>
      <td>229 ns</td>
      <td>491 ns</td>
      <td>895 ns</td>
      <td>185 ns</td>
      <td>2 µs</td>
      <td>326 ns</td>
    </tr>
    <tr>
      <td>100 b</td>
      <td>2 µs</td>
      <td>3 µs</td>
      <td>2 µs</td>
      <td>540 ns</td>
      <td>3 µs</td>
      <td>351 ns</td>
    </tr>
    <tr>
      <td>1 kb</td>
      <td>14 µs</td>
      <td>14 µs</td>
      <td>8 µs</td>
      <td>3 µs</td>
      <td>8 µs</td>
      <td>88 ns</td>
    </tr>
    <tr>
      <td>10 kb</td>
      <td>192 µs</td>
      <td>165 µs</td>
      <td>85 µs</td>
      <td>29 µs</td>
      <td>96 µs</td>
      <td>10 µs</td>
    </tr>
    <tr>
      <td>100 kb</td>
      <td>2 ms</td>
      <td>2 ms</td>
      <td>827 µs</td>
      <td>325 µs</td>
      <td>881 µs</td>
      <td>88 µs</td>
    </tr>
  </tbody>
</table>

<p>Measured on i7-9700K.</p>

<h2 id="on-tests">On Tests</h2>

<p>One can be interested in how this library was tested. Although being considered
as a simple format, JSON has got plenty of surprises. Jsam has tree sets of
tests, namely:</p>

<ul>
  <li>basic cases written by me;</li>
  <li>a large test suite borrowed from the <a href="https://github.com/cnuernber/charred">Charred library</a>. Many thanks
to <a href="https://github.com/cnuernber">Chris Nuernberger</a> who allowed me to use his code.</li>
  <li>an extra set of generative tests borrowed from the official
<code class="language-plaintext highlighter-rouge">clojure.data.json</code> library developed by Clojure team.</li>
</ul>

<p>These three, I believe, cover most of the cases. Should you face any weird
behavior, please let me know.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/flyway/">Flyway</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2025-04-24T00:00:00+00:00">
        Apr 24, 2025
    </time>

    <a href="/tag/flyway/" rel="tag">flyway</a>, <a href="/tag/postgres/" rel="tag">postgres</a>

</div>


            <div class="entry">
                
                    <p>Волею судеб я использую джавную библиотеку Flyway для миграций. Должен сказать:
ее писали клоуны.</p>

<p>Вот как это проверить: запускаем миграции на Postgres 15.8, версия Flyway
7.5.4. Все благополучно работает. А если поднять версию до последней 11.7.2,
получим исключение:</p>

<blockquote>
  <p>Unsupported Database: PostgreSQL 15.8</p>
</blockquote>

<p>Не менял абсолютно ничего, никаких настроек, только бампнул версию. И вот
пожалуйста.</p>

<p>Внимание, вопрос: что же такого случилось, что Постгрес 15.8 вдруг не
поддерживается? Почему спустя три мажорных релиза он отвалился? Слишком новый?
Слишком старый? И что делать?</p>

<p>Между прочим, Постгрес 15.8 — относительно свежий релиз (последняя версия, если
что — 17). С каких щщей он попал в немилость?</p>

<p>Что творилось в голове у джавистов, которые писали Flyway, я ума не приложу.</p>

<p>Мне приходилось писать свои миграционные движки, и могу сказать: да, это работа
не на один день, конечно. Хорошенько все потестить, а потом стабилизация. Но
наколбасить 11 мажорных релизов, которые вдобавок тупо не работают — это надо
уметь.</p>

<p>Сюда же относится официальный SDK AWS на Джаве, который я уже
упоминал. Ощущение, что писали студенты или вроде того. Все аргументы
опциональны, все может быть null, в том числе бакет, который читаешь, или файл,
в которых пишешь. В рантайме ловишь сто ошибок, что это не может быть нул, то не
может и так далее. Про обязательные аргументы в Амазоне не слышали.</p>

<p>Выпустили SDK 2, а там те же самые проблемы.</p>

<p>Словом, ты вырос и сказка кончилась. Программист в корпорации X может получать
400 тыс. долларов в год и писать лютейший быдлокод. А нам, потребителям, с этим
жить.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/apple-ai/">Кнопка Summarize</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2025-04-24T00:00:00+00:00">
        Apr 24, 2025
    </time>

    <a href="/tag/apple/" rel="tag">apple</a>, <a href="/tag/ai/" rel="tag">ai</a>

</div>


            <div class="entry">
                
                    <p>Компания Эпл следует тенденции: сует AI в каждую щель. Так, в почтовом
приложении над каждым письмом теперь кнопка “Summarize”, которая, как
предполагается, покажет краткую версию письма.</p>

<p><img src="/assets/static/aws/apple-ai/1.jpeg" /></p>

<p>Разумеется, это полная шляпа. Работает только с английским текстом и
text/plain. Если вам прислали графоманию на русском, и к тому же в виде
HTML-таблиц — кнопка скажет, что “не шмогла”. В целом, эта кнопка скорее не
работает, нежели работает.</p>

<p><img src="/assets/static/aws/apple-ai/2.jpeg" /></p>

<p>Все, что остается пользователю — это отключить кнопку, но не все так просто. Я
снял нужную галку, кнопка пропала, но потом появилась. Может быть, нужно
перезагрузиться, но ситуация уже абсурдна.</p>

<p><img src="/assets/static/aws/apple-ai/3.jpeg" /></p>

<p>Гугл и поддержка Эпла (читай — AI) как дурачки советуют снять эту галку. То, что
это не работает, никого не интересует.</p>

<p><img src="/assets/static/aws/apple-ai/4.jpeg" /></p>

<p><img src="/assets/static/aws/apple-ai/5.jpeg" /></p>

<p>Когда уже мир отпустит? Начинает немного раздражать.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/write-links/">Ссылки должны быть записаны</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2025-04-19T00:00:00+00:00">
        Apr 19, 2025
    </time>

    <a href="/tag/life/" rel="tag">life</a>, <a href="/tag/links/" rel="tag">links</a>

</div>


            <div class="entry">
                
                    <p><a href="/tabs-and-bookmarks/">Прошлую заметку</a> можно выразить другим тезисом, а именно:
каждая ссылка должна быть записана. В файле, в задаче, в заметках, где
угодно. Когда это так, нет смысла хранить ее все время открытой.</p>

<p>Например, мне нужно сделать что-то нетривиальное в Постгресе. Путем гугления я
нашел два ответа на StackOverflow, два раздела документации и пару чьих-то
блогов. Всего шесть ссылок. Можно хранить их открытыми все время, пока работаешь
над задачей. А можно добавить их в задачу и спокойно закрыть.</p>

<p>Почему второй способ лучше? По многим причинам, и самая важная – взрослый,
организованный подход. Вместо того чтобы сидеть на ссылках, как царь Кощей над
златом, мы делимся ими с другими. Возможно, в будущем к этой задаче кто-то
вернется и найдет эти ссылки. Их проще скопировать и переслать. Если работа
основана на сторонних материалах (код, замеры быстродействия), я считаю
правильным ссылаться на источники, чтобы было понятно, откуда решение.</p>

<p>В комментариях кто-то писал: моя задача требует документации, ссылок на то, се,
пятое-десятое плюс макеты в Фигме. Так добавь эти ссылки в задачу! Или ты ждешь,
что каждый участник будет искать эти ссылки? Это же свинство.</p>

<p>Разумеется, так мало кто делает, ровно как мало кто соблюдает сетевой этикет и
правила переписки. Это тот случай, когда нужно не смотреть на других, а самому
ставить нормы поведения. Например, добавлять в задачи ссылки на все нужные
материалы и просить других делать так же. Может быть, кто-то поймет, что это
правильно.</p>

<p>Или ты открыл десяток вкладок и тебя экстренно перекинули на другую задачу, а
она тоже требует 10 вкладок. Так и будешь хранить первые десять? Я понимаю, что
есть разные профили, окна, группировки… но не говорите, что все это работает
как надо, я даже слушать не хочу. Разве не было такого, что браузер вылетел и
все забыл? Или обновился и показывает одинокую вкладку “What’s new”?</p>

<p>Запись ссылок важна даже если работаешь в одиночку. Скажем, пилю я свой клиент к
Постгресу и мне нужны:</p>

<ul>
  <li>ссылки на документацию</li>
  <li>ссылки на исходники Постгреса</li>
  <li>ссылки на чужие клиенты, чтобы подсматривать решения</li>
  <li>вопросы на StackOverflow</li>
  <li>всякие мейл-листы.</li>
</ul>

<p>Поэтому я завожу в репозитории файл <code class="language-plaintext highlighter-rouge">links.md</code> и пишу туда ссылки.</p>

<p>Когда кто-то говорит, что у него пять сотен вкладок, увы, я не верю, что в них
возможен какой-то порядок. Это самообман. Все сводится к принципу: записал –
отпустил. Пока что-то не записано, оно не свободно. И мы тоже от него не
свободны.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/tabs-and-bookmarks/">Табы и закладки</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2025-04-19T00:00:00+00:00">
        Apr 19, 2025
    </time>

    <a href="/tag/browsers/" rel="tag">browsers</a>, <a href="/tag/tabs/" rel="tag">tabs</a>, <a href="/tag/bookmarks/" rel="tag">bookmarks</a>

</div>


            <div class="entry">
                
                    <p>Раз уж заговорили о браузерах, выскажу еще одну мысль.</p>

<p>Меня удивляет, как много обсуждают табы и закладки. Когда выходит какой-нибудь
Вивальди и об этом постят новость, комментари сводятся к табам и
закладкам. Когда будут вертикальные табы? Когда группировка? Когда автозакрытие
как в расширении X? И так далее.</p>

<p>Иногда мне даже жаль разработчиков, потому что сделать так, чтобы понравилось
всем, невозможно. Всегда найдется чудак, которому нужны табы по диагонали, в
крапинку и с синхронизацией через Амазон в докере. Приходится объяснять, что
этого не планируется, а он будет поливать разработчиков дерьмом.</p>

<p>Поэтому расскажу, как управлять табами в любом браузере: будь то Хром, форк
Фаекфокса или что угодно. Записывайте: когда у вас много табов, зажмите клавиши
Ctrl/Command + W. Все табы закроются. После этого откройте табы, что нужны для
текущей задачи. Конец.</p>

<p>Я использую эту схему много лет. Расплодились табы – сношу к чертям и начинаю
сначала. Не нужны расширения и синхронизации, вертикальные-горизонтальные и
прочий бред.</p>

<p>Уже рассказывал: человек шарит экран, и у него в Хроме 30 вкладок. И не вздумай
говорить, что ты ими управляешь!!! Табы сжаты до размеров иконки – как ты
найдешь нужный таб? Только перебором: вот этот таб, ой, не тот, ой, другой, ага,
вот этот. В чем прикол тыкать каждый раз как слепой щенок? Это как набрать в
руки десять предметов и утверждать, что можешь управиться с каждым.</p>

<p>Будь я разработчиком браузера, я бы открыто сказал: ребят, если вы держите 40
вкладок, вам нужно не расширение, а пойти прогуляться.</p>

<p>Сюда же относятся закладки: тратят сотни часов, чтобы найти расширение и
настроить синхронизацию. А потом ноют, что в каком-то андроиде не подсосались
последние ссылки.</p>

<p>Решение простое: храните ссылки в файлике, который синхронизируется через
Dropbox, iCloud или что там у вас. У меня это файлы <code class="language-plaintext highlighter-rouge">music.md</code>, <code class="language-plaintext highlighter-rouge">postgres.md</code> и
другие. Содержимое примерно такое:</p>

<div class="language-markdown highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gh"># Silent Hill 2 Remake OST</span>
https://www.youtube.com/watch?v=UFBq69uB-es&amp;list=PLjvrSyTT3pvSbHUpqC3sSC3b9Fq7NuF6b

<span class="gh"># J. S. Bach - Organ Works - Lionel Rogg - DISC 2/12</span>
https://www.youtube.com/watch?v=rudjAUtfx-g

<span class="gh"># Toccata &amp; Fugue in C Major, BWV 564</span>
https://www.youtube.com/watch?v=kxtJ_av5NHo

<span class="gh"># Pink Floyd - Obscured By Clouds (1972) [Full Album]</span>
https://www.youtube.com/watch?v=Te_-nISxLVI
</code></pre></div></div>

<p>Поскольку это маркдаун в Емаксе, то работают всякие плюшки. Клик на ссылку
открывает ее в браузере, есть быстрый переход по заголовкам, просмотр оглавления
и так далее. Можно делать несколько уровней, например так:</p>

<div class="language-markdown highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gh"># Ambient</span>
<span class="gu">## Portal 2</span>
<span class="gu">## Klaus Schulze</span>
<span class="gh"># Rock</span>
<span class="gu">## Queen</span>
<span class="gu">## Pink Floyd</span>
</code></pre></div></div>

<p>и оно будет красиво отображаться в виде дерева. Но мне достаточно одного
уровня. Схема проста как лопата, в ней нечему ломаться. Обновление браузера и
расширений на нее не влияют. Что еще нужно?</p>

<p>Конечно, кто-то всплакнет, мол, неудобно на телефоне. Ну и пусть – пока ты не
за компом, надо смотреть на солнце, а не тупить в экран. А если не дочитал
статью, то кинь ссылку себе в Телеграм, в чем проблема?</p>

<p>Главная мысль этого поста: не быть рабом своих желаний. Хочется такие-сякие табы
и закладки – перехочется. Бери то, что не сломается ни при каких
обстоятельствах. На долгой дистанции это единственный вариант.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/summer-shift/">Летнее время</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2025-04-19T00:00:00+00:00">
        Apr 19, 2025
    </time>

    <a href="/tag/life/" rel="tag">life</a>, <a href="/tag/time/" rel="tag">time</a>, <a href="/tag/shift/" rel="tag">shift</a>, <a href="/tag/amazon/" rel="tag">amazon</a>

</div>


            <div class="entry">
                
                    <p>Как известно, перевод часов на летнее время несет сплошную пользу. Прямо так
хорошо от него, так хорошо, что аж сам себе завидую. И под это дело потерял день
рабочего времени, и остальные тоже.</p>

<p>На работе я занимаюсь отчетностью. В Амазоне у меня зашедулено много отчетов,
каждый из которых уходит своим потребителям. Большинство из них я сделал прошлой
осенью и зимой, когда у заказчика было время +1. А весной произошло вот что.</p>

<p>Если не указать в Амазоне часовую зону cron-выражения, то по умолчанию берется
UTC. Это хорошо, потому что точка отсчета фиксирована. Но одно и то же время UTC
в зависимости от времени года дает разное локальное время. Например, зимой время
08:00 am UTC будет 9:00 am UTC+1, а летом – 10:00 am UTC+2.</p>

<p>Это значит, что после перевода часов потребители получат отчеты не в 9 часов, а
в 10 по местному времени.</p>

<p>Начались жалобы: что-то подумал, что все сломалось, кто-то не успел предоставить
отчет к созвону, где-то упал скрипт, который перекладывает отчеты в другое
место. Починил так: нужно указать под cron-выражением местную зону, например
<code class="language-plaintext highlighter-rouge">Europe/&lt;City&gt;</code>, и сдвинуть часы так, чтобы они совпадали с зимним временем, по
которому работало раньше. На то, чтобы разобраться, задеплоить и проверить, ушел
день. В первый раз я поднял часы на +2 вместо +1, и пришлось переделывать.</p>

<p>Коснулось и других коллег: Майкл, почему твоя задача запустилась на час позже? И
Майклу предстоит то же самое: считать на бумажке часы, деплоить и проверять.</p>

<p>У меня стойкая ассоциация: каждые полгода страна садится голой задницей на
гвоздь. За полгода рана заживает, и кажется, что в этот раз обойдется без
последствий. Но нет: снова боль, снова проблемы, крики. Никогда такого не было,
и вот опять.</p>

<p>Спрашивается: сколько можно? Сколько еще нужно выбросить времени, денег, нервов,
здоровья, чтобы чиновников отпустило? Десять лет? Сто лет? Уверен, в будущем над
нами будут смеяться: представляете, дети, эти придурки на рубеже тысячелетий
гоняли часы туда-сюда, чтобы сэкономить тысячу долларов на 20 миллионов
человек. Примерно как раньше сжигали людей, чтобы задобрить бога – с таким же
результатом.</p>

<p>Слышал, что за перевод времени люто топил Яков Перельман. Что неудивительно:
более яростного человеконенавистника нужно еще поискать. Может, хватит брать с
него пример?</p>

                
            </div>

        </li>
        
    </ul>

    <h4>
        
        <span class="page_number ">Страница 1 из 93</span>
        
        <a href="/page2" class="next">&rarr;</a>
        
    </h4>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Ivan Grishaev's blog</li>
          <li><a href="mailto:ivan@grishaev.me">ivan@grishaev.me</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
            <li><a href="https://github.com/igrishaev">GitHub</a></li>
            <li><a href="https://t.me/igrishaev_blog">Telegram</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Writing on programming, education, books and negotiations.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
