<!DOCTYPE html>
<html lang="ru">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Ivan Grishaev's blog</title>
  <meta name="description" content="Writing on programming, education, books and negotiations.
">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/custom.css">
  <link rel="canonical" href="https://grishaev.me/page15/">
  <link rel="alternate" type="application/rss+xml" title="Ivan Grishaev's blog" href="https://grishaev.me/feed.xml">

  <link rel="shortcut icon" type="image/x-icon" href="/assets/static/favicons/favicon.ico">

  <script type="text/javascript" src="/assets/typo.js"></script>

</head>


  <body>
    <header class="site-header">

    <div class="wrapper flex-container">

        <div>
            <a href="/">
                <img id="avatar" src="/assets/static/avatar.jpg" alt="Ivan Grishaev">
            </a>
        </div>

        <div class="flex-container-vert" style="margin-left: 15px; width: 80%">

            <div class="flex-container full-width">
                <p style="margin-bottom: 5px"><a href="/">Ivan Grishaev's blog</a></p>
                <div class="flex-huge"></div>
                <div >
<form id="search-form"
      target="_blank"
      style="display: inline"
      method="get"
      action="https://www.google.com/search">

    <input name="sitesearch"
           value="grishaev.me"
           type="hidden">

    <input type="text"
           required="required"
           name="q"
           placeholder="Google search..."
           autocomplete="off">

    <button style="border: none; background-color: transparent; cursor: pointer;"
            type="submit">&#x1f50d;</button>

</form>
</div>
            </div>

            <p><small>Writing on programming, education, books and negotiations.
</small></p>

            <div class="flex-container">
                <a class="menu-item" href="/">Home</a>
                <a class="menu-item" href="/about/">About</a>
                <a class="menu-item" href="/open-source/">Open Source</a>
                <a class="menu-item" href="/bookshelf/">Bookshelf</a>
                <a class="menu-item" href="/feed.xml">RSS</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor" href="/tag/clojure/">Clojure</a>
                <a class="menu-item minor" href="/tag/emacs/">Emacs</a>
                <a class="menu-item minor" href="/tag/python/">Python</a>
                <a class="menu-item minor" href="/tag/programming/">Programming</a>
                <a class="menu-item minor" href="/interview/">Interview</a>
                <a class="menu-item minor" href="/video/">Video</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor hl" href="/clojure-in-prod/">Книга «Clojure на производстве»</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor hl" href="/clojure-in-prod-2/">Книга «Clojure на производстве», второй том</a>
            </div>

        </div>
    </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="home">

    <ul class="post-list">
        
        <li>

            <h2>
                <a class="post-link" href="/boosty/">Бусти и почта</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2024-12-02T00:00:00+00:00">
        Dec 2, 2024
    </time>

    <a href="/tag/boosty/" rel="tag">boosty</a>, <a href="/tag/email/" rel="tag">email</a>, <a href="/tag/google/" rel="tag">google</a>

</div>


            <div class="entry">
                
                    <p>Подписался на одного человека в Бусти — первый раз пользовался этой
платформой. Заодно наблюдал котовасию с подтверждением почты.</p>

<p>Дело было так: захожу через Гугло-учетку, все нормально, пришло письмо
“здравствуй, дорогой Ivan”. А как начал читать, появилась плашка: чел,
<code class="language-plaintext highlighter-rouge">ivan@grishaev.me</code> — это твой емейл?</p>

<p>Вы серьезно? Гугл уже подтвердил, что это моя почта, что вам еще нужно? Как вы
это представляете: зашел через Гугл, а почта не моя? Тыкаю Yes, чтобы
отвязался. Перехожу в соседнюю вкладку, а там вылезла та же плашка. На этот раз
я промахнулся и нажал No. В результате моя почта пропала из профиля, и Бусти
пишет — пока не подтвердишь почту, покоя не дам.</p>

<p>Хоть я и не видел кода Бусти, легко понять, почему так происходит. Когда
создается учетка, у нее стоит флаг “почта не подтверждена” — нормальное
поведение для регистрации по email. Но разработчики не учли, что в случае с
Гуглом почта подтверждается автоматом и выносят мозг подтверждением.</p>

<p>На ровном месте устроили бурю в стакане: подтверди, хотя никакого подтверждения
не нужно. Большой и денежный сервис, а такие косяки.</p>

<p>Интересный факт об авторизации, который я не знаю, куда приткнуть, поэтому пусть
будет здесь. Когда пользователь входит через Фейсбук, он может отказать в
передаче емейла. В результате вам прилетит джейсончик, где всякие
токены-шмокены, а почты нет. Если почта критична (а это чаще всего так),
приходится заворачивать пользователя со словами “не быкуй, галочку не
снимай”. Требует много кода и тестов.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/pg-meetup/">Приглашаю на митап</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2024-11-22T00:00:00+00:00">
        Nov 22, 2024
    </time>

    <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/postgres/" rel="tag">postgres</a>

</div>


            <div class="entry">
                
                    
<p>В следующий четверг (28 ноября) Health Samurai проводят очередной кложурный
митап. Я буду рассказывать про свою библиотеку PG2 — это которая клиент к
Постгресу. Начало в 19:00, нужна регистрация. Ссылка на <a href="https://health-samurai.ru/postgresql-level-up/">страницу
организаторов</a>.</p>

<p>Из анонса может показаться, что доклад будет про библиотеку, но на самом деле я
бы хотел поговорить о другом. Пока я работал над ней, то столкнулся со
спецификой, о которой раньше не думал, и теперь хочу ей поделиться. Кроме самой
библиотеки, расскажу о следующих вещах:</p>

<ul>
  <li>как устроен Postgres Wire Protocol</li>
  <li>зачем браться за свое решение, когда есть другие, проверенные годами</li>
  <li>сопоставление типов Postgresql и Java/Clоjure</li>
  <li>заморочки с парсингом</li>
  <li>мысли об API и дизайне</li>
</ul>

<p>Подойдет всем, кто как-то связан базами данных. Запись на Ютубе будет через
несколько дней после митапа.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/you-may-fix-it/">Можешь поправить</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2024-11-22T00:00:00+00:00">
        Nov 22, 2024
    </time>

    <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/work/" rel="tag">work</a>, <a href="/tag/life/" rel="tag">life</a>

</div>


            <div class="entry">
                
                    <p>Есть одна обидная вещь, я называю ее “можешь поправить”. Это когда находишь
ошибку, которой много лет и которую воспринимают как данность. И когда обращаешь
внимание, тебе отвечают — можешь поправить.</p>

<p>Текст ошибки совершенно нечитаем? Можешь поправить. Сервис делает тысячу
запросов вместо одного? Можешь поправить. Хрупкие билды? Можешь поправить. Не
собирается под твоей операционкой? Можешь поправить. Не работает в Фаерфоксе?
Можешь поправить.</p>

<p>Ну вы поняли: “можешь поправить” — это вежливая форма “е…сь сам”. Ощущение,
что на полу лежит какашка, и все старательно ее обходят, дожидаясь, кто вступит
первым. Как правило, первым вступаю я.</p>

<p>Повторюсь, это очень обидная вещь, и вдобавок тревожный маркер о состоянии
команды. В данном случае нужно править не только технические косяки, но и
отношение к ним в команде.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/url-space/">Пробел в урлах</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2024-11-22T00:00:00+00:00">
        Nov 22, 2024
    </time>

    <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/url/" rel="tag">url</a>, <a href="/tag/space/" rel="tag">space</a>

</div>


            <div class="entry">
                
                    <p>Хотя интернету 55 лет, мы до сих пор не починили пробел в урлах.</p>

<p>На выходных была ситуация: упали крон-джобы, и вообще произошла какая-то
фигня. Файлы в S3 есть, а клиенты жалуются, что нету.</p>

<p>Смотрю — кто-то поменял название папки в S3. Раньше было <code class="language-plaintext highlighter-rouge">Daily_Reports</code>, а
теперь <code class="language-plaintext highlighter-rouge">Daily Reports</code> (с пробелом). Половина клиентов пишет файлы нормально. Но
есть другие клиенты на питоне и баше, которые кодируют урлы дважды. В результате
<code class="language-plaintext highlighter-rouge">Daily Reports</code> становится новой папкой <code class="language-plaintext highlighter-rouge">Daily%20Reports</code> в S3. Один клиент
пишет в <code class="language-plaintext highlighter-rouge">Daily Reports</code> и ему ок. Второй клиент ищет файлы в <code class="language-plaintext highlighter-rouge">Daily%20Reports</code>,
не находит и падает.</p>

<p>Увы, мой быдлокод тоже упал. У меня такая задача: прилетает S3-урл вида</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>s3://some.bucket.com/path/to/file.txt
</code></pre></div></div>

<p>и мне нужно вытащить из него бакет, в данном случае хост. Делаю так:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(-&gt; s3-url java.net.URI. .getHost)
</code></pre></div></div>

<p>Но когда в урле оказался пробел, класс <code class="language-plaintext highlighter-rouge">URI</code> валится — вай, не по стандарту, не
знаю-не могу. Поменял на класс <code class="language-plaintext highlighter-rouge">URL</code> — он парсит урлы с пробелами нормально, но
теперь ему не нравится схема <code class="language-plaintext highlighter-rouge">s3://</code> — опять не по стандарту. Сделал так: беру
урл, меняю схему автозаменой на <code class="language-plaintext highlighter-rouge">http://</code>, оборачиваю в URL и достаю
хост. Обмазал тестами.</p>

<p>“Какая шаткая система, если её может разрушить пригоршня ягод!” (с)</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/env-trap/">О переменных среды</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2024-11-22T00:00:00+00:00">
        Nov 22, 2024
    </time>

    <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/environment/" rel="tag">environment</a>

</div>


            <div class="entry">
                
                    <p>Про переменные среды нужно знать две вещи. Первая — если не было значения по
умолчанию, функция должна бросить исключение, где написано, какой именно
переменной не нашлось. Вторая — нельзя читать переменные посреди
программы. Нужно сделать это один раз на старте. Эти два правила улучшают код на
порядок.</p>

<p>Теперь подробнее. Как правило, если переменная среды не установлена, то попытка
ее прочесть вернет пустую строку или <code class="language-plaintext highlighter-rouge">null</code>. Это неправильно. Должно выскочить
исключение с примерно таким текстом:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>System.getenv("DB_PASSWORD") =&gt;
RuntimeException "env variable DB_PASSWORD is not set"
</code></pre></div></div>

<p>Если вместо исключения будет <code class="language-plaintext highlighter-rouge">null</code>, то он провалится в дальнейшие вычисления,
например, в формирование урла или бакета. Постоянно вижу такое в коде:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>host = "api." + getenv("ENV_PREFIX") + ".acme.com"
</code></pre></div></div>

<p>Если <code class="language-plaintext highlighter-rouge">ENV_PREFIX</code> не задан, то получится <code class="language-plaintext highlighter-rouge">api.null.acme.com</code>. Из-за этого
HTTP-клиент пойдет на левый хост и кинет непонятное исключение. То же самое с
бакетом в S3: Амазон скажет, мол, нет такого бакета, а вы будете рвать волосы.</p>

<p>Простой фикс — написать свою функцию, которая бросит исключение. Потом заменить
все коробочные getenv на ваш. Пример:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(dеfn env!
  ([varname]
   (or (System/getenv varname)
       (throw (new RuntimeError ...))))
  ([varname dеfault]
   (or (System/getenv varname)
       dеfault)))
</code></pre></div></div>

<p>Исключение не кидается, если передан дефолт.</p>

<p>Второе. Чтение переменной среды — это грязная операция. Формально никакого IO не
происходит, потому что переменные уже в памяти программы. Но это сторонняя
зависимость, которую ваш код не контролирует. По факту чтение переменной не
отличается от чтения файла. Нет файла — программа сломается; нет переменной —
тоже.</p>

<p>Поэтому, если уж вы связались с переменными среды, читайте их на старте в
какую-то мапку. Передавайте эту мапку в функции, чтобы они были чистыми. Это
легко тестировать: подал на вход то, это, пятое-десятое. А когда код завязан на
getenv, с ним невозможно работать.</p>

<p>Приходилось работать в проекте, который писали одни чудики. Они прочитали The
Twelve-Factor App и особенно прониклись пунктом насчет переменных
среды. Результат можно описать одним словом: пи…ц. Представьте проект на 600
файлов, где на каждый чих читается переменная среды, да к тому же приводится к
нужному типу. На старте ничего не проверяется: запустил код без переменной —
узнал об этом в продакшене. Какой-то чел добавил глобальный кэш переменных и
целый ворох связанных с ним проблем.</p>

<p>Чудики вынесли настройки в переменные среды, чтобы быть свободными от
конфигурации. Так им сказали в The Twelve-Factor App. А потом написали ENV-файлы
на три экрана. Было несколько ENV-файлов, которые загружались в особом порядке,
переопределяя значения друг друга. Например, сначала базовый энв, потом энв
текущего окружения (тест, прод, стейджинг), потому энв текущей машины. Удачной
отладки.</p>

<p>Из этого вывод: много чего можно прочитать в интернете, но если нет своей
головы, оно не поможет. Нужно делать так, чтобы было удобно, а не как написано в
The Twelve-Factor App или на Хакер-Ньюз.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/best-lang/">Лучший язык</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2024-11-22T00:00:00+00:00">
        Nov 22, 2024
    </time>

    <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/best/" rel="tag">best</a>

</div>


            <div class="entry">
                
                    <p>По мотивам обсуждений во внутреннем чатике, вот вам мысль.</p>

<p>Лучший язык для решения задачи — тот, который знаешь лучше всего. Если это Питон
— пиши на Питоне. Если лучше всего знаешь Джаву — пиши на Джаве. Если это JS или
PHP, то что ж… пиши на них.</p>

<p>Когда вам говорят, что C++ лучше подходит для игр, а R для статистики, не нужно
вестись на эту удочку. Язык-то задаче подходит, а вы подходите языку?</p>

<p>Даже если взять “подходящий” язык, который вы плохо знаете, результат будет
хуже, чем с “неподходящим”, но знакомым языком. Под “знаете” имеются в виду не
основы синтаксиса и курсы, а пять лет опыта и больше.</p>

<p>Простыми словами, если с Питоном вы 10 лет, а на плюсах писали дай бог в
универе, то умножение матриц на Питоне будет медленней, но понятней и проще в
поддержке.</p>

<p>Игры, кстати, хорошо пишутся на C-шарпе в том же Юнити. Полно печатных плат,
которые выполняют быдлокод на Питоне и JS. Если вы знаете Лисп как бог, то не
составит труда написать мини-язык, который собирается в машкоды — так писали
серию игр Crash Bandicoot. В случае с Питоном почти все либы написаны на Си, а
Питон — это клей, чтобы их вызвать.</p>

<p>Поэтому нужно оценивать не язык, а себя. Пишите на том, что знаете лучше
всего. А языки подучивайте в фоне, рассматривая их как инструменты.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/ai-glitch/">AI и новички</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2024-11-22T00:00:00+00:00">
        Nov 22, 2024
    </time>

    <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/ai/" rel="tag">ai</a>

</div>


            <div class="entry">
                
                    <p>В Кложурной слаке в канале для офтопа пошла речь о языковых моделях. Приведу
хорошую цитату оттуда:</p>

<blockquote>
  <p>Library suggestions seems to be one of the areas they’re very weak: they
hallucinate a lot about namespaces and functions so the suggested code looks
feasible but won’t run, and it actually leads to beginners then raising issues
against the suggested library that “gpt suggested this code but it doesn’t
work as expected”</p>
</blockquote>

<p>Прямо в точку. У меня было несколько раз, когда человек копировал выхлоп из GPT
и жаловался, что он не работает. На первый взгляд код правильный, а потом
смотришь: здесь нет двоеточия, здесь левый символ, здесь ссылка на неизвестный
неймспейс. Между кодом — повествовательный стиль изложения: вы можете сделать
то, можете это.</p>

<p>Досадно, что каждый раз человек сливается. Начинаешь объяснять, что не так, а в
ответ — тишина. Видимо, человек рассчитывал, что GPT прав, ошибка на моей
стороне и сейчас я быстро поправлю. Но оказывается не так, нужно думать,
разбираться и вообще — все сложно.</p>

<p>Не советую новичкам пользоваться языковыми моделями для кода. Они как волшебное
зеркало — что-то показывают, но откуда оно, какая гарантия и кто несет
ответственность — неизвестно. В точности противоположно тому, что нужно на
старте.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/ai-everywhere/">Всюду AI</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2024-11-22T00:00:00+00:00">
        Nov 22, 2024
    </time>

    <a href="/tag/ai/" rel="tag">ai</a>, <a href="/tag/life/" rel="tag">life</a>

</div>


            <div class="entry">
                
                    <p>Наиболее раздражающий тренд сегодня — это когда каждая программа подсовывает
AI. Открываешь гугло-док, а сверху плашка: попробуй Gemini at no
cost. Открываешь Feedly — а там AI-анализатор твоих фидов. Открываешь Хром — а
там AI-алгоритм для группировки вкладок.</p>

<p>Все это в выпадашках, выпадашках, выпадашках. Даже если закрыл, покажут через
два дня опять.</p>

<p>Когда-нибудь AI-истерия, конечно, пройдет. Просто иной раз думаешь — почему я
опять должен пережидать очередной вирусняк? Ждать, пока программы отпустит от
блокчейна, BLM, прайда и прочего? Я ведь не просил, оно само пришло.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/ring-jdk-adapter/">Ring JDK Adapter</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2024-11-15T00:00:00+00:00">
        Nov 15, 2024
    </time>

    <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/clojure/" rel="tag">clojure</a>, <a href="/tag/ring/" rel="tag">ring</a>, <a href="/tag/http/" rel="tag">http</a>, <a href="/tag/java/" rel="tag">java</a>

</div>


            <div class="entry">
                
                    
<p><a href="https://github.com/igrishaev/ring-jdk-adapter">Ring JDK Adapter</a> is a small wrapper on top of a built-in HTTP server
available in Java. It’s like Jetty but has no dependencies. It’s almost as fast
as Jetty, too (see benchmars below).</p>

<h2 id="why">Why</h2>

<p>Sometimes you want a local HTTP server in Clojure, e.g. for testing or mocking
purposes. There is a number of adapters for Ring but all of them rely on third
party servers like Jetty, Undertow, etc. Running them means to fetch plenty of
dependencies. This is tolerable to some extent, yet sometimes you really want
something quick and simple.</p>

<p>Since version 9 or 11 (I don’t remember for sure), Java ships its own HTTP
server. The package name is <code class="language-plaintext highlighter-rouge">com.sun.net.httpserver</code> and the module name is
<code class="language-plaintext highlighter-rouge">jdk.httpserver</code>. The library provides an adapter to serve Ring handlers. It’s
completely free from any dependencies.</p>

<p>Ring JDK Adapter is a great choice for local HTTP stubs or mock services that
mimic HTTP services. Despite some people think it’s for development purposes
only, the server is pretty fast! One can use it even in production.</p>

<h2 id="availability">Availability</h2>

<p>It’s worth mentioning that some Java installations may miss the <code class="language-plaintext highlighter-rouge">jdk.httpserver</code>
module. Please ensure the JVM you’re using in production supports it
first. Check out the following links:</p>

<ul>
  <li><a href="https://stackoverflow.com/questions/58764710/is-package-com-sun-net-httpserver-standard">StackOverflow: Is package com.sun.net.httpserver
standard?</a></li>
  <li><a href="https://docs.oracle.com/en/java/javase/21/docs/api/index.html">Java® Platform, Standard Edition &amp; Java Development Kit Version 21 API Specification</a></li>
</ul>

<h2 id="installation">Installation</h2>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">;; lein</span><span class="w">
</span><span class="p">[</span><span class="n">com.github.igrishaev/ring-jdk-adapter</span><span class="w"> </span><span class="s">"0.1.0"</span><span class="p">]</span><span class="w">

</span><span class="c1">;; deps</span><span class="w">
</span><span class="n">com.github.igrishaev/ring-jdk-adapter</span><span class="w"> </span><span class="p">{</span><span class="no">:mvn/version</span><span class="w"> </span><span class="s">"0.1.0"</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Requires Java version at least 16, Clojure at least 1.8.0.</p>

<h2 id="quick-demo">Quick Demo</h2>

<p>Import the namespace, declare a Ring handler as usual:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">ns</span><span class="w"> </span><span class="n">demo</span><span class="w">
  </span><span class="p">(</span><span class="no">:require</span><span class="w">
   </span><span class="p">[</span><span class="n">ring.adapter.jdk</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">jdk</span><span class="p">]))</span><span class="w">

</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">handler</span><span class="w"> </span><span class="p">[</span><span class="n">request</span><span class="p">]</span><span class="w">
  </span><span class="p">{</span><span class="no">:status</span><span class="w"> </span><span class="mi">200</span><span class="w">
   </span><span class="no">:headers</span><span class="w"> </span><span class="p">{</span><span class="s">"Content-Type"</span><span class="w"> </span><span class="s">"text/plain"</span><span class="p">}</span><span class="w">
   </span><span class="no">:body</span><span class="w"> </span><span class="s">"Hello world!"</span><span class="p">})</span><span class="w">
</span></code></pre></div></div>

<p>Pass it into the <code class="language-plaintext highlighter-rouge">server</code> function and check the http://127.0.0.1:8082 page in
your browser:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">server</span><span class="w">
  </span><span class="p">(</span><span class="nf">jdk/server</span><span class="w"> </span><span class="n">handler</span><span class="w"> </span><span class="p">{</span><span class="no">:port</span><span class="w"> </span><span class="mi">8082</span><span class="p">}))</span><span class="w">
</span></code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">server</code> function returns an instance of the <code class="language-plaintext highlighter-rouge">Server</code> class. To stop it,
pass the result into the <code class="language-plaintext highlighter-rouge">jdk/stop</code> or <code class="language-plaintext highlighter-rouge">jdk/close</code> functions:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">jdk/stop</span><span class="w"> </span><span class="n">server</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>Since the <code class="language-plaintext highlighter-rouge">Server</code> class implements <code class="language-plaintext highlighter-rouge">AutoCloseable</code> interface, it’s compatible
with the <code class="language-plaintext highlighter-rouge">with-open</code> macro:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nb">with-open</span><span class="w"> </span><span class="p">[</span><span class="n">server</span><span class="w"> </span><span class="p">(</span><span class="nf">jdk/server</span><span class="w"> </span><span class="n">handler</span><span class="w"> </span><span class="n">opt?</span><span class="p">)]</span><span class="w">
  </span><span class="n">...</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>The server gets closed once you’ve exited the macro. Here is a similar
<code class="language-plaintext highlighter-rouge">with-server</code> macro which acts the same:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">jdk/with-server</span><span class="w"> </span><span class="p">[</span><span class="n">handler</span><span class="w"> </span><span class="n">opt?</span><span class="p">]</span><span class="w">
  </span><span class="n">...</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<h2 id="parameters">Parameters</h2>

<p>The <code class="language-plaintext highlighter-rouge">server</code> function and the <code class="language-plaintext highlighter-rouge">with-server</code> macro accept the second optional map
of the parameters:</p>

<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Default</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:host</code></td>
      <td>127.0.0.1</td>
      <td>Host name to listen</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:port</code></td>
      <td>8080</td>
      <td>Port to listen</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:stop-delay-sec</code></td>
      <td>0</td>
      <td>How many seconds to wait when stopping the server</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:root-path</code></td>
      <td>/</td>
      <td>A path to mount the handler</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:threads</code></td>
      <td>0</td>
      <td>Amount of CPU threads. When &gt; thn 0, a new <code class="language-plaintext highlighter-rouge">FixedThreadPool</code> executor is used</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:executor</code></td>
      <td>null</td>
      <td>A custom instance of <code class="language-plaintext highlighter-rouge">Executor</code>. Might be a virtual executor as well</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:socket-backlog</code></td>
      <td>0</td>
      <td>A numeric value passed into the <code class="language-plaintext highlighter-rouge">HttpServer.create</code> method</td>
    </tr>
  </tbody>
</table>

<p>Example:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">server</span><span class="w">
  </span><span class="p">(</span><span class="nf">jdk/server</span><span class="w"> </span><span class="n">handler</span><span class="w">
              </span><span class="p">{</span><span class="no">:host</span><span class="w"> </span><span class="s">"0.0.0.0"</span><span class="w"> </span><span class="c1">;; listen all addresses</span><span class="w">
               </span><span class="no">:port</span><span class="w"> </span><span class="mi">8800</span><span class="w">      </span><span class="c1">;; a custom port</span><span class="w">
               </span><span class="no">:threads</span><span class="w"> </span><span class="mi">8</span><span class="w">      </span><span class="c1">;; use custom fixed trhead executor</span><span class="w">
               </span><span class="no">:root-path</span><span class="w"> </span><span class="s">"/my/app"</span><span class="p">}))</span><span class="w">
</span></code></pre></div></div>

<p>When run, the handler above is be available by the address
http://127.0.0.1:8800/my/app in the browser.</p>

<h2 id="body-type">Body Type</h2>

<p>JDK adapter supports the following response <code class="language-plaintext highlighter-rouge">:body</code> types:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">java.lang.String</code></li>
  <li><code class="language-plaintext highlighter-rouge">java.io.InputStream</code></li>
  <li><code class="language-plaintext highlighter-rouge">java.io.File</code></li>
  <li><code class="language-plaintext highlighter-rouge">java.lang.Iterable&lt;?&gt;</code> (see below)</li>
  <li><code class="language-plaintext highlighter-rouge">null</code> (nothing gets sent)</li>
</ul>

<p>When the body is <code class="language-plaintext highlighter-rouge">Iterable</code> (might be a lazy seq as well), every item is sent as
a string in UTF-8 encoding. Null values are skipped.</p>

<h2 id="middleware">Middleware</h2>

<p>To gain all the power of Ring (parsed parameters, JSON, sessions, etc), wrap
your handler with the standard middleware:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">ns</span><span class="w"> </span><span class="n">demo</span><span class="w">
  </span><span class="p">(</span><span class="no">:require</span><span class="w">
    </span><span class="p">[</span><span class="n">ring.middleware.params</span><span class="w"> </span><span class="no">:refer</span><span class="w"> </span><span class="p">[</span><span class="n">wrap-params</span><span class="p">]]</span><span class="w">
    </span><span class="p">[</span><span class="n">ring.middleware.keyword-params</span><span class="w"> </span><span class="no">:refer</span><span class="w"> </span><span class="p">[</span><span class="n">wrap-keyword-params</span><span class="p">]]</span><span class="w">
    </span><span class="p">[</span><span class="n">ring.middleware.multipart-params</span><span class="w"> </span><span class="no">:refer</span><span class="w"> </span><span class="p">[</span><span class="n">wrap-multipart-params</span><span class="p">]]))</span><span class="w">

</span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">handler</span><span class="w"> </span><span class="p">(</span><span class="nb">-&gt;</span><span class="w"> </span><span class="n">handler</span><span class="w">
                  </span><span class="n">wrap-keyword-params</span><span class="w">
                  </span><span class="n">wrap-params</span><span class="w">
                  </span><span class="n">wrap-multipart-params</span><span class="p">)]</span><span class="w">
  </span><span class="p">(</span><span class="nf">jdk/server</span><span class="w"> </span><span class="n">handler</span><span class="w"> </span><span class="p">{</span><span class="no">:port</span><span class="w"> </span><span class="mi">8082</span><span class="p">}))</span><span class="w">
</span></code></pre></div></div>

<p>The wrapped handler will receive a <code class="language-plaintext highlighter-rouge">request</code> map with parsed <code class="language-plaintext highlighter-rouge">:query-params</code>,
<code class="language-plaintext highlighter-rouge">:form-params</code>, and <code class="language-plaintext highlighter-rouge">:params</code> fields. These middleware come from the <code class="language-plaintext highlighter-rouge">ring-core</code>
library which you need to add into your dependencies. The same applies to
handling JSON and the <code class="language-plaintext highlighter-rouge">ring-json</code> library.</p>

<h2 id="exception-handling">Exception Handling</h2>

<p>If something gets wrong while handling a request, you’ll get a plain text page
with a short message and a stack trace:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">handler</span><span class="w"> </span><span class="p">[</span><span class="n">request</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="c1">;; !</span><span class="w">
  </span><span class="p">{</span><span class="no">:status</span><span class="w"> </span><span class="mi">200</span><span class="w">
   </span><span class="no">:headers</span><span class="w"> </span><span class="p">{</span><span class="s">"Content-Type"</span><span class="w"> </span><span class="s">"text/plain"</span><span class="p">}</span><span class="w">
   </span><span class="no">:body</span><span class="w"> </span><span class="s">"hello"</span><span class="p">})</span><span class="w">
</span></code></pre></div></div>

<p>This is what you’ll get in the browser:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>failed to execute ring handler
java.lang.ArithmeticException: Divide by zero
	at clojure.lang.Numbers.divide(Numbers.java:190)
	at clojure.lang.Numbers.divide(Numbers.java:3911)
	at bench$handler.invokeStatic(form-init14855917186251843338.clj:8)
	at bench$handler.invoke(form-init14855917186251843338.clj:7)
	at ring.adapter.jdk.Handler.handle(Handler.java:112)
	at jdk.httpserver/com.sun.net.httpserver.Filter$Chain.doFilter(Filter.java:98)
	at jdk.httpserver/sun.net.httpserver.AuthFilter.doFilter(AuthFilter.java:82)
	at jdk.httpserver/com.sun.net.httpserver.Filter$Chain.doFilter(Filter.java:101)
	at jdk.httpserver/sun.net.httpserver.ServerImpl$Exchange$LinkHandler.handle(ServerImpl.java:873)
	at jdk.httpserver/com.sun.net.httpserver.Filter$Chain.doFilter(Filter.java:98)
	at jdk.httpserver/sun.net.httpserver.ServerImpl$Exchange.run(ServerImpl.java:849)
	at jdk.httpserver/sun.net.httpserver.ServerImpl$DefaultExecutor.execute(ServerImpl.java:204)
	at jdk.httpserver/sun.net.httpserver.ServerImpl$Dispatcher.handle(ServerImpl.java:567)
	at jdk.httpserver/sun.net.httpserver.ServerImpl$Dispatcher.run(ServerImpl.java:532)
	at java.base/java.lang.Thread.run(Thread.java:1575)
</code></pre></div></div>

<p>To prevent this data from being leaked to the client, use your own
<code class="language-plaintext highlighter-rouge">wrap-exception</code> middleware, something like this:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">wrap-exception</span><span class="w"> </span><span class="p">[</span><span class="n">handler</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="k">fn</span><span class="w"> </span><span class="p">[</span><span class="n">request</span><span class="p">]</span><span class="w">
    </span><span class="p">(</span><span class="nf">try</span><span class="w">
      </span><span class="p">(</span><span class="nf">handler</span><span class="w"> </span><span class="n">request</span><span class="p">)</span><span class="w">
      </span><span class="p">(</span><span class="nf">catch</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="w">
        </span><span class="p">(</span><span class="nf">log/errorf</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="n">...</span><span class="p">)</span><span class="w">
        </span><span class="p">{</span><span class="no">:status</span><span class="w"> </span><span class="mi">500</span><span class="w">
         </span><span class="no">:headers</span><span class="w"> </span><span class="p">{</span><span class="n">...</span><span class="p">}</span><span class="w">
         </span><span class="no">:body</span><span class="w"> </span><span class="s">"No cigar! Roll again!"</span><span class="p">}))))</span><span class="w">
</span></code></pre></div></div>

<h2 id="benchmarks">Benchmarks</h2>

<p>As mentioned above, the JDK server although though is for dev purposes only, is
not so bad! The chart below proves it’s almost as fast as Jetty. There are five
attempts of <code class="language-plaintext highlighter-rouge">ab -l -n 1000 -c 50 ...</code> made against both Jetty and JDK servers
(1000 requests in total, 50 parallel). The levels of RPS are pretty equal: about
12-13K requests per second.</p>

<p>Measured on Macbook M3 Pro 32Gb, default settings, the same REPL.</p>

<p><img src="/assets/static/aws/ring-jdk-adapter/chart_1.svg" width="100%" height="auto" /></p>


                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/python-warn/">Python Software Foundation</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2024-11-12T00:00:00+00:00">
        Nov 12, 2024
    </time>

    <a href="/tag/programming/" rel="tag">programming</a>

</div>


            <div class="entry">
                
                    <p>По мотивам событий с Линуксом обратим внимание на Питон. Итак, имеем Python
Software Foundation, некоммерческая организация, у которой на уме только добро и
радуга.</p>

<p>Смотрим: <a href="https://en.wikipedia.org/wiki/Python_Software_Foundation">штаб-квартира в США</a>, адрес Wilmington, Delaware, United States.</p>

<p><a href="https://www.python.org/psf/records/staff/">Все руководители</a> из США: на странице персонала выделяем любое имя,
копируем в Гугл и добавляем “linkedin”. Страну видно даже без перехода в
профиль.</p>

<p><a href="https://www.python.org/psf/sponsors/">Ключевые спонсоры</a>: NVidia, Bloomberg, Microsoft, AWS, Red Hat и
другие.</p>

<p>Любой суд признает Питон цифровым продуктом США со всем последствиями. Не то
чтобы я об этом волнуюсь, но нужно иметь в виду: в любой момент разговоры про
опенсорс закончатся, и подключатся юристы.</p>

                
            </div>

        </li>
        
    </ul>

    <h4>
        
        <a href="/page14" class="previous">&larr;</a>
        
        <span class="page_number ">Страница 15 из 100</span>
        
        <a href="/page16" class="next">&rarr;</a>
        
    </h4>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Ivan Grishaev's blog</li>
          <li><a href="mailto:ivan@grishaev.me">ivan@grishaev.me</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
            <li><a href="https://github.com/igrishaev">GitHub</a></li>
            <li><a href="https://t.me/igrishaev_blog">Telegram</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Writing on programming, education, books and negotiations.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
