<!DOCTYPE html>
<html lang="ru">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Ivan Grishaev's blog</title>
  <meta name="description" content="Writing on programming, education, books and negotiations.
">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/custom.css">
  <link rel="canonical" href="https://grishaev.me/page15/">
  <link rel="alternate" type="application/rss+xml" title="Ivan Grishaev's blog" href="https://grishaev.me/feed.xml">

  <link rel="shortcut icon" type="image/x-icon" href="/assets/static/favicons/favicon.ico">

  <script type="text/javascript" src="/assets/typo.js"></script>

</head>


  <body>
    <header class="site-header">

    <div class="wrapper flex-container">

        <div>
            <a href="/">
                <img id="avatar" src="/assets/static/avatar.jpg" alt="Ivan Grishaev">
            </a>
        </div>

        <div class="flex-container-vert" style="margin-left: 15px; width: 80%">

            <div class="flex-container full-width">
                <p style="margin-bottom: 5px"><a href="/">Ivan Grishaev's blog</a></p>
                <div class="flex-huge"></div>
                <div >
<form id="search-form"
      target="_blank"
      style="display: inline"
      method="get"
      action="https://www.google.com/search">

    <input name="sitesearch"
           value="grishaev.me"
           type="hidden">

    <input type="text"
           required="required"
           name="q"
           placeholder="Google search..."
           autocomplete="off">

    <button style="border: none; background-color: transparent; cursor: pointer;"
            type="submit">&#x1f50d;</button>

</form>
</div>
            </div>

            <p><small>Writing on programming, education, books and negotiations.
</small></p>

            <div class="flex-container">
                <a class="menu-item" href="/">Home</a>
                <a class="menu-item" href="/about/">About</a>
                <a class="menu-item" href="/open-source/">Open Source</a>
                <a class="menu-item" href="/bookshelf/">Bookshelf</a>
                <a class="menu-item" href="/feed.xml">RSS</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor" href="/tag/clojure/">Clojure</a>
                <a class="menu-item minor" href="/tag/emacs/">Emacs</a>
                <a class="menu-item minor" href="/tag/python/">Python</a>
                <a class="menu-item minor" href="/tag/programming/">Programming</a>
                <a class="menu-item minor" href="/interview/">Interview</a>
                <a class="menu-item minor" href="/video/">Video</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor hl" href="/clojure-in-prod/">Книга «Clojure на производстве»</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor hl" href="/clojure-in-prod-2/">Книга «Clojure на производстве», второй том</a>
            </div>

        </div>
    </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="home">

    <ul class="post-list">
        
        <li>

            <h2>
                <a class="post-link" href="/euro-officials/">О еврочиновниках</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2025-03-06T00:00:00+00:00">
        Mar 6, 2025
    </time>

    <a href="/tag/cookies/" rel="tag">cookies</a>, <a href="/tag/euroofficials/" rel="tag">euroofficials</a>, <a href="/tag/web/" rel="tag">web</a>

</div>


            <div class="entry">
                
                    <p>Я как-то писал о проблеме, что каждый сайт показывает выпадашку с куками. В
конце обещал рассказать о еврочиновниках, которые все это устроили. Эта заметка
– о них.</p>

<p>В широком смысле еврочиновник не отличается от российского или американского
чиновника. Их главная черта – реактивный стиль управления. “Реактивный”
означает не “быстрый”, а от слова “реакция”. Сперва чиновник реагирует самым
глупым образом, а потом (и если вообще) думает, нужно ли было реагировать.</p>

<p>Пример: если с крыши падает лед, поставим таблички “осторожно, падает лед”. Если
кто-то следит за пользователем при помощи кук, поставим плашку “этот сайт
использует куки”. В обоих случаях главное – выполнить KPI, отчитаться и пойти
дальше. О последствиях чиновник не думает, ему не до таких мелочей.</p>

<p>В результате 99 сайтов из 100 показывают плашки, что сайт исползует куки. Уже
одно оформление говорит о полной неразберихе. На одном сайте это полоска внизу
экрана, а на другом – модалка во весь экран. Где-то одно предложение, где-то
графомания, которая не вмещается по высоте. Кто-то блюрит контент, пока не
нажмешь кнопку.</p>

<p>На фоне неразберихи появляются сервисы, которые берут часть проблем на
себя. Например, Cookiehub внедряет виджет выбора кук. Их клиентов можно понять:
проще платить двадцать евро в месяц, чем попасть по доносу конкурентов на 30
тысяч евро (реальный случай).</p>

<p>Грамотность чиновников, которые принимали закон, сводится к урокам информатики в
школе. Учитель заставлял их открыть сайт в Интернет-Эксплорере, найти файлы
куки, удалить их и убедиться, что сайт не узнает пользователя. Все мы делали это
в школе, и наши европейские сверстники не исключение. Беда в том, что в 40 лет
их компьютерная грамотность осталась на том же уровне. Отслеживать пользователя
можно сотней способов, но у чиновника в голове одно: куки.</p>

<p>Когда смотришь, во что превратился интернет, разве не очевидно следующее? Если
каждый сайт уведомляет о технологии X, это значит, она повсеместна и уведомлять
о ней бессмысленно. Бесконечные плашки превращаются в шум, люди закрывают их
инстиктивно. Блокировщики рекламы уже включают функцию удаления плашек. На одном
конце провода эти плашки продуцируются, на другом – удаляются. Жгутся такты
процессора, выделяется тепло. Зачем? Какая цель?</p>

<p>Давайте пойдем дальше: когда клиент садится в такси, уведомим его, что машина
работает на бензине, а бензин опасен. Когда человек входит в бизнес-центр,
потребудем согласие на то, что в здании используется газ и электричество – тоже
опасные вещи. Пользователь предупрежден, свою задачу мы выполнили.</p>

<p>Почему бы не подвергнуть закон пересмотру? Найти чиновников и спросить: что
хорошего принесли уведомления о куках? Стало ли меньше трекинга и преступлений?
Стал ли интернет безопасней? Было ли хоть раз так, что человек заходит на сайт и
такой: опачки, здесь куки, пойду-ка я на другой сайт? Это просто смешно.</p>

<p>Поэтому я считаю, что любой закон должен приниматься только на определенный
срок. Годен до, так сказать. Когда срок истек, чиновники собираются и решают –
продлить как есть или что-то поменять. Ключевой момент в том, что это будут уже
другие чиновники. Кто-то из прежних перейдет в другие отделы, кто-то в бизнес,
женщины – в декрет. Придут новые ребята и, возможно, поправят бред, принятый по
ошибке десять лет назад. Это даст шанс, что ошибка продлится только несколько
лет, а не сотню-другую.</p>

<p>Искренне не понимаю, почему в Европе не нашлось энтузиастов, которые положили бы
этому конец? Я имею в виду группу экспертов: программистов, опенсорщиков, членов
всяких комитетов. Они бы собрали материалы и факты, организовали бы встречу с
чиновниками и популярно объяснили им, что они натворили. Добились бы частичной
отмены и точных формулировок. Но ничего подобного не видно: все послушно лепят
плашки на сайтах, словно овцы, которых ведут на убой. Всякие Греты Тунберг и
другие отбитые личности собирают толпы, когда речь о борьбе с климатом и
ковиде. А когда что-то важное, то тишина: это для нашей безопасности.</p>

<p>Верю, что плашки с куками не навсегда. Найдутся те, кто скажут: задолбало, мы
этот закон не писали, мы его не уважаем, ставить плашку не будем (я уже
нашелся). Этот бред нужно перетерпеть. Не исключено, что дальше будет хуже, но я
смотрю в будущее с оптимизмом.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/analog-school/">Аналоговое образование</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2025-03-06T00:00:00+00:00">
        Mar 6, 2025
    </time>

    <a href="/tag/school/" rel="tag">school</a>, <a href="/tag/education/" rel="tag">education</a>, <a href="/tag/it/" rel="tag">it</a>

</div>


            <div class="entry">
                
                    <p>Не помню, чтобы кто-нибудь высказывал следующую мысль. Школьное образование
должно быть исключительно аналоговым. Никаких электронных учебников, платформ,
мессаджеров, онлайн-дневников и прочего. Странно, что это мало кто понимает.</p>

<p>Теперь длинно. Российское айти развивается довольно неплохо, и верный признак
этого – компании собирают деньги там, где раньше не могли, а именно в
образовательном секторе. Исторически считалось, что школы бедные и с них нечего
взять. Однако оплату повесили на родителей, и дело пошло. Напоминает фирмы,
которые продают товары детям – аудитории, у которой нет денег – но за них
платят родители.</p>

<p>В образовании айтишный элемент является чистым наркотиком. Это бесплатная первая
доза, когда платформу внедряют якобы бескорыстно, а потом выясняется, что нужно
купить тарифный план. Сайт платформы работает бесплатно только на
десктопе. Мобильное приложение показывает только часть данных, а если хочешь все
– оформляй подписку.</p>

<p>Любая платформа предполагает, что у ребенка есть телефон, электронная почта и
логин. Все эти данные сливаются партнерам в целях рекламы. Я не поленился и
прочитал политику обработки ПД одной из платформ: там указаны восемь фирм,
включая Яндекс.</p>

<p>Некоторые платформы делают вход через другие. Например, чтобы попасть в Я.Класс,
нужно войти через электронный дневник, а вход в него работает через
Госуслуги. Представили длину этой цепи? Сто редиректов, попапы, токены… Как
это можно объяснить ребенку?</p>

<p>Гаджеты и платформы плохо влияют на учителей, они деградируют в профессиональном
плане. Во время ковидной истерии все родители познали дно этой деградации. Ни
один учитель не мог достойно организовать удаленное образование. Ни у кого нет
материалов для распечатки, контрольных, типовых заданий. Учитель не может
составить задание ученикам. Каждое домашнее задание – это ссылка на какую-то
говно-платформу, где нужно регистрироваться и подтверждать учетку телефоном, и
которая работает только в Хроме на винде.</p>

<p>Учителя и школы оказались голыми. Нет никакой базы знаний: офлайн-лекций,
методичек, контрольных работ, которые распечатал и готово. Я как отец трех детей
(двое учатся в школе) просто ох…ал с этого, простите. Когда училка опять
кидает ссылку на образовательный портал, хотелось лупить ее линейкой со словами:
ты учитель или кто? Сядь и составь задание для детей, это же час работы. Тебе же
самой пригодится в дальнейшем. Какого хрена ты тащишь детей в очередной стартап?</p>

<p>Я вообще считаю, что учитель без личной базы лекций, заданий и методичек – это
не учитель. И на проверку большинство учителей оказались такими.</p>

<p>Мне повезло: я учился у преподавателей, которые готовили матералы сами. Конечно,
они опирались на учебник, но изложение было авторское. Исписанный листочек в
руках препода – очень хороший признак. В университете прогульщики искупляли
грехи тем, что набирали эти листочки и печатали методички, которые позже ходили
по рукам.</p>

<p>Айти-компании, которые сегодня захватывают образование, прикрываются благими
целями. Разумеется, все это ложь. Компании важна прибыль, а качество образования
ее нисколько не интересует. Это слишком долгосрочная цель, за это время или
фирмы не останется, или руководство уйдет в другое место. Об образовании должно
думать правительство, но у него другие приоритеты. Вся надежда на родителей.</p>

<p>Классика: все онлайн-штучки на проверку оказываются эфемерны. Что-то лагает, тут
недоступно, сессия истекла, зайдите через сервис Х, браузер не поддерживается, у
вас блокировщик рекламы, введите логин, который ребенок придумал год
назад… словом, привычное нам айтишное дерьмо. Я стерплю, не вопрос, но причем
тут мои дети?</p>

<p>Образовательные платформы, электронные учебники, дневники, видео-курсы, что там
еще… все это замечательно, но не имеет отношения к образованию. Кому-то
нравится – ради бога, пользуйтесь, платите. Но школа должна быть в стороне от
этого. У ребенка должна быть книга, тетрадь, ручка и учитель – вот все, что
нужно для хорошего обучения.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/what-is-disruptor/">Что такое Disruptor?</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2025-03-04T00:00:00+00:00">
        Mar 4, 2025
    </time>

    <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/java/" rel="tag">java</a>, <a href="/tag/disruptor/" rel="tag">disruptor</a>

</div>


            <div class="entry">
                
                    <p><img src="/assets/static/aws/what-is-disruptor/1.jpeg" /></p>

<p>Графомания бывает не только в русском, но и в английском языке. Хороший пример —
страница <a href="https://lmax-exchange.github.io/disruptor/">проекта Disruptor</a>.</p>

<p>Вижу большой заголовок “What is Disruptor?”, но ни один параграф не отвечает на
вопрос, что это такое.</p>

<p>Первый параграф о том, что в такой-то фирме борются за перформанс.</p>

<p>Второй параграф о том, что Disruptor — это результат исследований и тестов. Мы
тестировали кеши процессора и ядра и сделали дружественный к железу фреймворк.</p>

<p>Третий параграф — это не специализированное решение, подойдет всем.</p>

<p>Четвертый параграф — он работает не так как вы привыкли, может быть непривычно.</p>

<p>Далее ссылки и документация, а еще нас залайкал известный чел.</p>

<p><strong>Внимание, вопрос — что такое Disruptor?</strong></p>

<p>Вижу такое постоянно. Автор пишет заголовок, а дальше Остапа понесло: мы
работали, исследовали, у фирмы долгая история, а вот был случай…</p>

<p>Не надо так. Отвечайте на заголовок, который сами же написали.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/macbook-reset/">Вырезалки на Маке</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2025-03-04T00:00:00+00:00">
        Mar 4, 2025
    </time>

    <a href="/tag/mac/" rel="tag">mac</a>, <a href="/tag/web/" rel="tag">web</a>, <a href="/tag/lulu/" rel="tag">lulu</a>

</div>


            <div class="entry">
                
                    <p>У меня тут накладки: вышел из строя личный ноут. Ставить Телеграм и прочие
штучки на рабочий ноут я не рискую, поэтому пару дней потратил вот на что:
достал с антресолей стренький мак 2014 года. Мой первый мак, в котором, как в
греческом корабле, давно заменены все детали. Но я считаю его тем самым маком.</p>

<p>Переустановил ось, накатил софт, и в процессе пришла в голову эта заметка.</p>

<p>На том маке, что сейчас в отключке, я работаю четыре года. Там настроено все:
блокировщик рекламы и вырезалка плашек с куками; отключены все нотификации;
много правил для фаервола Lulu, чтобы программы не лезли в интернет за
обновлениями; Фаерфокс работает с полиси, чтобы не показывать модалки и все
остальное.</p>

<p>В один момент я всего этого лишился. Ощущения ужасные.</p>

<p>Начнем с того, что каждая программа после запуска хочет показывать
нотификации. Неважно какая, неважно зачем. Даже терминал! Уведомления нельзя
отключить всем приложениям сразу и позже настроить исключения. Нужно прокликать
“нет” для каждой приложеньки.</p>

<p>Про то, что каждое приложение лезет в сеть за обновлениями и показывает модалку,
я писал много раз. Приходиться ставить Lulu и затыкать софт.</p>

<p>У меня в системе английский язык, и если заходишь на русскоязычный сайт, во всех
браузерах всплывает модалка с предложением перевести. Нужно везде прокликать
отказ.</p>

<p>Сюда же Телеграм: если в системе английский язык, предлагает перевести русские
каналы. Если русский, то стоит кому-то скопипастить английскую Википедию, как
сразу выпадашка с переводом.</p>

<p>Каждый сайт встречает плашкой о том, что использует куки. Каждый без
исключения. На StackExchage и StackOverflow плашки размером с могильные
плиты. Они не умещаются по высоте, нужно скроллить.</p>

<p>Кроме кук всплывают: выбор города, подписка на емейл-рассылку, телеграм-канал,
вход через гугл-аккаунт. Все это нужно прокликивать или вырезать.</p>

<p>Ну и банальная реклама. Я специально поставил ее на последнее место, потому что
реклама уже не вызывает таких проблем: крутится слева баннер, ну и пусть
крутится. А выпадашки всех мастей закрывают контент и не дают пользоваться
сайтом.</p>

<p>В общем, посмотрел я на современный веб и обалдел. Не представляю, как
пользуются им обычные люди без блокировщиков, вырезалки кук и фаервола. Куда ни
зайди, на тебя кричат уведомлениями и плашками: сделай то, зайди сюда, обновись,
купи премиум, подпишись, установи, оцени товар. И не только веб, но и настольные
приложения и даже операционка.</p>

<p>Вырезаю все это по-новой и думаю: что будет через десять лет?</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/json-scale/">Схемы JSON</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2025-03-04T00:00:00+00:00">
        Mar 4, 2025
    </time>

    <a href="/tag/json/" rel="tag">json</a>, <a href="/tag/ui/" rel="tag">ui</a>

</div>


            <div class="entry">
                
                    
<p>Официальный сайт <a href="https://json.org">json.org</a> удивляет. В масштабе 30% схемы становятся
огромны и заливают весь экран. В масштабе 300% правый бар наезжает на основную
часть, сжимает ее в мышиный хвост, отчего схемы тоже уменьшаются.</p>

<p><img src="/assets/static/aws/json-scale/2.jpeg" /></p>

<p>В результате схема в масштабе 30% процентов выглядит крупнее, чем в
300%. Разница, на минуточку, целый порядок. Такой вот забавный факт.</p>

<p><img src="/assets/static/aws/json-scale/1.jpeg" /></p>

<p>У этих выкрутасов есть объяснения: верстка, плавающие дивы, стили,
пятое-десятое. Но можно сказать проще: это фронтенд.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/emoji-reply/">Ответ с эмодзи</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2025-03-04T00:00:00+00:00">
        Mar 4, 2025
    </time>

    <a href="/tag/life/" rel="tag">life</a>, <a href="/tag/email/" rel="tag">email</a>, <a href="/tag/outlook/" rel="tag">outlook</a>

</div>


            <div class="entry">
                
                    <p>Важная новость: в Microsoft Outlook появились реакции к емейлам. Работает так:
вы написали письмо, отправили, а под ним появляются пальчики, сердечки и
прочее. Пошарить скриншот не могу, поверьте на слово.</p>

<p>Интересно, как это работает? Особая апишка в протоколе Outlook? Или пустое
письмо с заголовком? Или какой-то особый пейлоад? Или если в письме только
эмодзи, оно показывается по-другому?</p>

<p>В любом случае, шлю лучи добра пользователям Аутлука.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/corp-update/">Корпоративные обновления</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2025-03-04T00:00:00+00:00">
        Mar 4, 2025
    </time>

    <a href="/tag/update/" rel="tag">update</a>, <a href="/tag/macos/" rel="tag">macos</a>, <a href="/tag/apple/" rel="tag">apple</a>

</div>


            <div class="entry">
                
                    <p>Когда работаешь на корпоративном ноуте, постигаешь всю беспощадность
обновлений. Ничего нельзя отключить, в фоне работают программы, которые следят
за обновлениями. Раз в несколько дней обновится то Хром, то Idea, и начинаются
выпадашки: Иван, чтобы защитить себя от угроз, поставь обновление! Откладывать
можно фиксированное число раз, и в какой-то момент обновление ставится силой —
конечно, перед релизом или звонком. Поэтому со временем я стал накатывать
обновления на выходных.</p>

<p>Так вот, в который раз попадаюсь на дурацкое поведение Эпла. Вылазит выпадашка:
обновись до Секвойи, тянуть больше нельзя. И кнопочка “Install update”. Я
закрываю все программы, все реплы, докеры и остаюсь с выпадашкой наедине. Жму
кнопку и вижу: отлично, загружаю обновление, осталось 3 часа. Три часа, Карл! Я
мог бы ничего не закрывать и работать чуть ли не полдня, пока качается
обновление!</p>

<p>Нажимая “Install update”, я рассчитываю, что оно уже загружено и я в шаге от
того, чтобы начать установку. А загрузка даже не начиналась! И качать там не три
мегабайта, а 5-7 гигов.</p>

<p>Спрашивается, что мешало скачать обновление в фоне? Если от него нельзя
отделаться, так скачай сам, зачем парить мне мозги?</p>

<p>Дизайнер тоже хорош: если кнопка запускает загрузку обновления, ее нужно назвать
“Download &amp; Install update”. Я ведь хочу самую малость: чтобы на кнопке было
написано то, что она делает на самом деле.</p>

<p>Сюда же относится виджет обновления Эппловских программ. Вылазит окошко поверх
всего, и там кнопка “Обновить”. Нажимаешь, оно начинает загрузку, а потом сто
раз перехватывает форус. Почему нельзя скачать в фоне? Почему нельзя поставить
его в фоне? Зачем тыкать в лицо модалки?</p>

<p>Та же самое с Саблаймом. Поработав минут 20, он начинает показывать модалку с
прогрессбаром: загружаю обновление. Тупица, что мешает скачать обновление в
фоне? Зачем ты показываешь прогресс-бар? Чтобы пользователь смотрел на него?
Других дел у пользователя нет?</p>

<p>В общем, сегодня каждая программа обновляется как не в себя, только нормальные
обновления так и не сделали. На ум приходит только одно исключение — Хром,
который обновляется полностью незаметно. Все остальное — обычные модалки с
прогрес-баром.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/clj-taggie/">Taggie</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2025-02-08T00:00:00+00:00">
        Feb 8, 2025
    </time>

    <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/clojure/" rel="tag">clojure</a>, <a href="/tag/tags/" rel="tag">tags</a>

</div>


            <div class="entry">
                
                    
<p><a href="https://github.com/igrishaev/taggie">Taggie</a> is an experimental library trying find an answer for a strange
question: is it possible to benefit from Clojure tags and readers, and how?</p>

<p>Taggie extends printing methods such that types that could not be read from
their representation now <strong>can</strong> be read. A quick example: if you print an atom,
you’ll get a weird string:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">atom</span><span class="w"> </span><span class="mi">42</span><span class="p">)</span><span class="w">
</span><span class="o">#</span><span class="n">&lt;Atom</span><span class="o">@</span><span class="mi">7</span><span class="n">fea5978</span><span class="err">:</span><span class="w"> </span><span class="mi">42</span><span class="nb">&gt;</span><span class="w">
</span></code></pre></div></div>

<p>Run that string, and REPL won’t understand you:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">#</span><span class="n">&lt;Atom</span><span class="o">@</span><span class="mi">7</span><span class="n">fea5978</span><span class="err">:</span><span class="w"> </span><span class="mi">42</span><span class="nb">&gt;</span><span class="w">
</span><span class="n">Syntax</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">reading</span><span class="w"> </span><span class="n">source</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="p">(</span><span class="nf">REPL</span><span class="no">:962:5</span><span class="p">)</span><span class="nb">.</span><span class="w">
</span><span class="n">Unreadable</span><span class="w"> </span><span class="n">form</span><span class="w">
</span></code></pre></div></div>

<p>But with Taggie, it goes this way:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">atom</span><span class="w"> </span><span class="mi">42</span><span class="p">)</span><span class="w">
</span><span class="o">#</span><span class="n">atom</span><span class="w"> </span><span class="mi">42</span><span class="w"> </span><span class="c1">;; represented with a tag</span><span class="w">
</span></code></pre></div></div>

<p>And vice versa:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">#</span><span class="n">atom</span><span class="w"> </span><span class="mi">42</span><span class="w"> </span><span class="c1">;; run it in repl</span><span class="w">
</span><span class="o">#</span><span class="n">atom</span><span class="w"> </span><span class="mi">42</span><span class="w"> </span><span class="c1">;; the result</span><span class="w">
</span></code></pre></div></div>

<p>The value is an atom indeed, you can check it:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nb">deref</span><span class="w"> </span><span class="o">#</span><span class="n">atom</span><span class="w"> </span><span class="mi">42</span><span class="p">)</span><span class="w">
</span><span class="mi">42</span><span class="w">
</span></code></pre></div></div>

<p>Tags can be nested. Let’s try some madness:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">omg</span><span class="w"> </span><span class="o">#</span><span class="n">atom</span><span class="w"> </span><span class="o">#</span><span class="n">atom</span><span class="w"> </span><span class="o">#</span><span class="n">atom</span><span class="w"> </span><span class="o">#</span><span class="n">atom</span><span class="w"> </span><span class="o">#</span><span class="n">atom</span><span class="w"> </span><span class="o">#</span><span class="n">atom</span><span class="w"> </span><span class="mi">42</span><span class="p">)</span><span class="w">

</span><span class="p">(</span><span class="nb">println</span><span class="w"> </span><span class="n">omg</span><span class="p">)</span><span class="w">
</span><span class="o">#</span><span class="n">atom</span><span class="w"> </span><span class="o">#</span><span class="n">atom</span><span class="w"> </span><span class="o">#</span><span class="n">atom</span><span class="w"> </span><span class="o">#</span><span class="n">atom</span><span class="w"> </span><span class="o">#</span><span class="n">atom</span><span class="w"> </span><span class="o">#</span><span class="n">atom</span><span class="w"> </span><span class="mi">42</span><span class="w">

</span><span class="o">@@@@@@</span><span class="n">omg</span><span class="w">
</span><span class="mi">42</span><span class="w">
</span></code></pre></div></div>

<p>But this is not only about atoms! Taggie extends many types, e.g. refs, native
Java arrays, <code class="language-plaintext highlighter-rouge">File</code>, <code class="language-plaintext highlighter-rouge">URI</code>, <code class="language-plaintext highlighter-rouge">URL</code>, <code class="language-plaintext highlighter-rouge">Date</code>, <code class="language-plaintext highlighter-rouge">java.time.*</code> classes, and something
else. See the corresponding section below.</p>

<h2 id="installation-and-usage">Installation and Usage</h2>

<p>Add this to your project:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">;; lein</span><span class="w">
</span><span class="p">[</span><span class="n">com.github.igrishaev/taggie</span><span class="w"> </span><span class="s">"0.1.0"</span><span class="p">]</span><span class="w">

</span><span class="c1">;; deps</span><span class="w">
</span><span class="n">com.github.igrishaev/taggie</span><span class="w"> </span><span class="p">{</span><span class="no">:mvn/version</span><span class="w"> </span><span class="s">"0.1.0"</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Then import the core namespace:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">ns</span><span class="w"> </span><span class="n">com.acme.server</span><span class="w">
  </span><span class="p">(</span><span class="no">:require</span><span class="w">
    </span><span class="n">taggie.core</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<p>Now type in the repl any of these:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">#</span><span class="n">LocalDate</span><span class="w"> </span><span class="s">"2025-01-01"</span><span class="w">
</span><span class="o">#</span><span class="n">Instant</span><span class="w"> </span><span class="s">"2025-01-01T23:59:59Z"</span><span class="w">
</span><span class="o">#</span><span class="n">File</span><span class="w"> </span><span class="s">"/path/to/a/file.txt"</span><span class="w">
</span><span class="o">#</span><span class="n">URL</span><span class="w"> </span><span class="s">"https://clojure.org"</span><span class="w">
</span><span class="o">#</span><span class="n">bytes</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="n">x00</span><span class="w"> </span><span class="mi">0</span><span class="n">xff</span><span class="p">]</span><span class="w">
</span><span class="o">#</span><span class="n">ints</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="p">]</span><span class="w">
</span><span class="o">#</span><span class="n">floats</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="p">]</span><span class="w">
</span><span class="o">#</span><span class="n">ByteBuffer</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">4</span><span class="p">]</span><span class="w">
</span><span class="n">...</span><span class="w">
</span></code></pre></div></div>

<p>Each expression gives an instance of a corresponding type: a <code class="language-plaintext highlighter-rouge">LocalDate</code>, an
<code class="language-plaintext highlighter-rouge">Instane</code>, a <code class="language-plaintext highlighter-rouge">File</code>, etc… <code class="language-plaintext highlighter-rouge">#bytes</code>, <code class="language-plaintext highlighter-rouge">#ints</code> and similar produce native Java
arrays.</p>

<p>You can pass tagged values into functions as usual:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nb">deref</span><span class="w"> </span><span class="o">#</span><span class="n">atom</span><span class="w"> </span><span class="mi">42</span><span class="p">)</span><span class="w">
</span><span class="mi">42</span><span class="w">

</span><span class="p">(</span><span class="nb">alength</span><span class="w"> </span><span class="o">#</span><span class="n">longs</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="p">])</span><span class="w">
</span><span class="mi">3</span><span class="w">
</span></code></pre></div></div>

<p>To observe what happends under the hood, prepend your expression with a
backtick:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">`</span><span class="p">(</span><span class="nb">alength</span><span class="w"> </span><span class="o">#</span><span class="n">longs</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="p">])</span><span class="w">

</span><span class="p">(</span><span class="nf">clojure.core/alength</span><span class="w"> </span><span class="p">(</span><span class="nf">taggie.readers/__reader-longs-edn</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="p">]))</span><span class="w">
</span></code></pre></div></div>

<p>Internally, all tags expand into an invocation of an EDN reader. Namely, <code class="language-plaintext highlighter-rouge">#longs
items</code> becomes <code class="language-plaintext highlighter-rouge">(taggie.readers/__reader-longs-edn items)</code>, and when evaluated,
it returs a native array of longs.</p>

<h2 id="edn-support">EDN Support</h2>

<p>Taggie provides functions to read and write EDN with tags. They live in the
<code class="language-plaintext highlighter-rouge">taggie.edn</code> namespace. Use it as follows:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">edn-dump</span><span class="w">
  </span><span class="p">(</span><span class="nf">taggie.edn/write-string</span><span class="w"> </span><span class="o">#</span><span class="n">atom</span><span class="w"> </span><span class="p">{</span><span class="no">:test</span><span class="w"> </span><span class="mi">1</span><span class="w">
                                  </span><span class="no">:values</span><span class="w"> </span><span class="o">#</span><span class="n">longs</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="p">]</span><span class="w">
                                  </span><span class="no">:created-at</span><span class="w"> </span><span class="o">#</span><span class="n">LocalDate</span><span class="w"> </span><span class="s">"2025-01-01"</span><span class="p">}))</span><span class="w">

</span><span class="p">(</span><span class="nb">println</span><span class="w"> </span><span class="n">edn-dump</span><span class="p">)</span><span class="w">

</span><span class="c1">;; #atom {:test 1,</span><span class="w">
</span><span class="c1">;;        :values #longs [1, 2, 3],</span><span class="w">
</span><span class="c1">;;        :created-at #LocalDate "2025-01-01"}</span><span class="w">
</span></code></pre></div></div>

<p>It produces a string with custom tags and data being pretty printed. Let’s read
it back:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">taggie.edn/read-string</span><span class="w"> </span><span class="n">edn-dump</span><span class="p">)</span><span class="w">

</span><span class="o">#</span><span class="n">atom</span><span class="w"> </span><span class="p">{</span><span class="no">:test</span><span class="w"> </span><span class="mi">1</span><span class="n">,</span><span class="w">
       </span><span class="no">:values</span><span class="w"> </span><span class="o">#</span><span class="n">longs</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="n">,</span><span class="w"> </span><span class="mi">2</span><span class="n">,</span><span class="w"> </span><span class="mi">3</span><span class="p">]</span><span class="n">,</span><span class="w">
       </span><span class="no">:created-at</span><span class="w"> </span><span class="o">#</span><span class="n">LocalDate</span><span class="w"> </span><span class="s">"2025-01-01"</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">write</code> function writes EDN into a destination which might be a file path, a
file, an output stream, a writer, etc:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">taggie.edn/write</span><span class="w"> </span><span class="p">(</span><span class="nf">clojure.java.io/file</span><span class="w"> </span><span class="s">"data.edn"</span><span class="p">)</span><span class="w">
                  </span><span class="p">{</span><span class="no">:test</span><span class="w"> </span><span class="p">(</span><span class="nf">atom</span><span class="w"> </span><span class="p">(</span><span class="nb">ref</span><span class="w"> </span><span class="p">(</span><span class="nf">atom</span><span class="w"> </span><span class="no">:secret</span><span class="p">)))})</span><span class="w">
</span></code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">read</code> function reads EDN from any kind of source: a file path, a file, in
input stream, a reader, etc. Internally, a source is transformed into the
<code class="language-plaintext highlighter-rouge">PushbackReader</code> instance:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">taggie.edn/read</span><span class="w"> </span><span class="p">(</span><span class="nf">clojure.java.io/file</span><span class="w"> </span><span class="s">"data.edn"</span><span class="p">))</span><span class="w">

</span><span class="p">{</span><span class="no">:test</span><span class="w"> </span><span class="o">#</span><span class="n">atom</span><span class="w"> </span><span class="o">#</span><span class="nb">ref</span><span class="w"> </span><span class="o">#</span><span class="n">atom</span><span class="w"> </span><span class="no">:secret</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Both <code class="language-plaintext highlighter-rouge">read</code> and <code class="language-plaintext highlighter-rouge">read-string</code> accept standard <code class="language-plaintext highlighter-rouge">clojure.edn/read</code> options,
e.g. <code class="language-plaintext highlighter-rouge">:readers</code>, <code class="language-plaintext highlighter-rouge">:eof</code>, etc. The <code class="language-plaintext highlighter-rouge">:readers</code> map gets merged with a global map
of custom tags.</p>

<h2 id="motivation">Motivation</h2>

<p>Aside from jokes, this library might save your day. I often see people dump data
into .edn files, and the data has atoms, regular expressions, exceptions, and
other unreadable types:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">spit</span><span class="w"> </span><span class="s">"data.edn"</span><span class="w">
      </span><span class="p">(</span><span class="nb">with-out-str</span><span class="w">
        </span><span class="p">(</span><span class="nf">clojure.pprint/pprint</span><span class="w">
          </span><span class="p">{</span><span class="no">:regex</span><span class="w"> </span><span class="o">#</span><span class="s">"foobar"</span><span class="w">
           </span><span class="no">:atom</span><span class="w"> </span><span class="p">(</span><span class="nf">atom</span><span class="w"> </span><span class="mi">42</span><span class="p">)</span><span class="w">
           </span><span class="no">:error</span><span class="w"> </span><span class="p">(</span><span class="nf">ex-info</span><span class="w"> </span><span class="s">"boom"</span><span class="w"> </span><span class="p">{</span><span class="no">:test</span><span class="w"> </span><span class="mi">1</span><span class="p">})})))</span><span class="w">

</span><span class="p">(</span><span class="nb">println</span><span class="w"> </span><span class="p">(</span><span class="nb">slurp</span><span class="w"> </span><span class="s">"data.edn"</span><span class="p">))</span><span class="w">

</span><span class="p">{</span><span class="no">:regex</span><span class="w"> </span><span class="o">#</span><span class="s">"foobar"</span><span class="n">,</span><span class="w"> </span><span class="no">:atom</span><span class="w"> </span><span class="o">#</span><span class="n">&lt;Atom</span><span class="o">@</span><span class="mi">4</span><span class="n">f7aa8aa</span><span class="err">:</span><span class="w"> </span><span class="mi">42</span><span class="n">&gt;,</span><span class="w"> </span><span class="no">:error</span><span class="w"> </span><span class="o">#</span><span class="n">error</span><span class="w"> </span><span class="p">{</span><span class="w">
 </span><span class="no">:cause</span><span class="w"> </span><span class="s">"boom"</span><span class="w">
 </span><span class="no">:data</span><span class="w"> </span><span class="p">{</span><span class="no">:test</span><span class="w"> </span><span class="mi">1</span><span class="p">}</span><span class="w">
 </span><span class="no">:via</span><span class="w">
 </span><span class="p">[{</span><span class="no">:type</span><span class="w"> </span><span class="n">clojure.lang.ExceptionInfo</span><span class="w">
   </span><span class="no">:message</span><span class="w"> </span><span class="s">"boom"</span><span class="w">
   </span><span class="no">:data</span><span class="w"> </span><span class="p">{</span><span class="no">:test</span><span class="w"> </span><span class="mi">1</span><span class="p">}</span><span class="w">
   </span><span class="no">:at</span><span class="w"> </span><span class="p">[</span><span class="n">user$eval43373$fn__43374</span><span class="w"> </span><span class="n">invoke</span><span class="w"> </span><span class="s">"form-init6283045849674730121.clj"</span><span class="w"> </span><span class="mi">2248</span><span class="p">]}]</span><span class="w">
 </span><span class="no">:trace</span><span class="w">
 </span><span class="p">[[</span><span class="n">user$eval43373$fn__43374</span><span class="w"> </span><span class="n">invoke</span><span class="w"> </span><span class="s">"form-init6283045849674730121.clj"</span><span class="w"> </span><span class="mi">2248</span><span class="p">]</span><span class="w">
  </span><span class="p">[</span><span class="n">user$eval43373</span><span class="w"> </span><span class="n">invokeStatic</span><span class="w"> </span><span class="s">"form-init6283045849674730121.clj"</span><span class="w"> </span><span class="mi">2244</span><span class="p">]</span><span class="w">
  </span><span class="c1">;; truncated</span><span class="w">
  </span><span class="p">[</span><span class="n">clojure.lang.AFn</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="s">"AFn.java"</span><span class="w"> </span><span class="mi">22</span><span class="p">]</span><span class="w">
  </span><span class="p">[</span><span class="n">java.lang.Thread</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="s">"Thread.java"</span><span class="w"> </span><span class="mi">833</span><span class="p">]]}}</span><span class="w">
</span></code></pre></div></div>

<p>This dump cannot be read back due to:</p>

<ol>
  <li>unknown <code class="language-plaintext highlighter-rouge">#"foobar"</code> tag (EDN doesn’t support regex);</li>
  <li>broken <code class="language-plaintext highlighter-rouge">#&lt;Atom@4f7aa8aa: 42&gt;</code> expression;</li>
  <li>unknown <code class="language-plaintext highlighter-rouge">#error</code> tag.</li>
</ol>

<p>But with Taggie, the same data produces tagged fields that <strong>can</strong> be read back.</p>

<h2 id="supported-types">Supported Types</h2>

<p>In alphabetic order:</p>

<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Example</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">java.nio.ByteBuffer</code></td>
      <td><code class="language-plaintext highlighter-rouge">#ByteBuffer [0 1 2]</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">java.util.Date</code></td>
      <td><code class="language-plaintext highlighter-rouge">#Date "2025-01-06T14:03:23.819Z"</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">java.time.Duration</code></td>
      <td><code class="language-plaintext highlighter-rouge">#Duration "PT72H"</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">java.io.File</code></td>
      <td><code class="language-plaintext highlighter-rouge">#File "/path/to/file.txt"</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">java.time.Instant</code></td>
      <td><code class="language-plaintext highlighter-rouge">#Instant "2025-01-06T14:03:23.819994Z"</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">java.time.LocalDate</code></td>
      <td><code class="language-plaintext highlighter-rouge">#LocalDate "2034-01-30"</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">java.time.LocalDateTime</code></td>
      <td><code class="language-plaintext highlighter-rouge">#LocalDateTime "2025-01-08T11:08:13.232516"</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">java.time.LocalTime</code></td>
      <td><code class="language-plaintext highlighter-rouge">#LocalTime "20:30:56.928424"</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">java.time.MonthDay</code></td>
      <td><code class="language-plaintext highlighter-rouge">#MonthDay "--02-07"</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">java.time.OffsetDateTime</code></td>
      <td><code class="language-plaintext highlighter-rouge">#OffsetDateTime "2025-02-07T20:31:22.513785+04:00"</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">java.time.OffsetTime</code></td>
      <td><code class="language-plaintext highlighter-rouge">#OffsetTime "20:31:39.516036+03:00"</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">java.time.Period</code></td>
      <td><code class="language-plaintext highlighter-rouge">#Period "P1Y2M3D"</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">java.net.URI</code></td>
      <td><code class="language-plaintext highlighter-rouge">#URI "foobar://test.com/path?foo=1"</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">java.net.URL</code></td>
      <td><code class="language-plaintext highlighter-rouge">#URL "https://clojure.org"</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">java.time.Year</code></td>
      <td><code class="language-plaintext highlighter-rouge">#Year "2025"</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">java.time.YearMonth</code></td>
      <td><code class="language-plaintext highlighter-rouge">#YearMonth "2025-02"</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">java.time.ZoneId</code></td>
      <td><code class="language-plaintext highlighter-rouge">#ZoneId "Europe/Paris"</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">java.time.ZoneOffset</code></td>
      <td><code class="language-plaintext highlighter-rouge">#ZoneOffset "-08:00"</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">java.time.ZonedDateTime</code></td>
      <td><code class="language-plaintext highlighter-rouge">#ZonedDateTime "2025-02-07T20:32:33.309294+01:00[Europe/Paris]"</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">clojure.lang.Atom</code></td>
      <td><code class="language-plaintext highlighter-rouge">#atom {:inner 'state}</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">boolean[]</code></td>
      <td><code class="language-plaintext highlighter-rouge">#booleans [true false]</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">byte[]</code></td>
      <td><code class="language-plaintext highlighter-rouge">#bytes [1 2 3]</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">char[]</code></td>
      <td><code class="language-plaintext highlighter-rouge">#chars [\a \b \c]</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">double[]</code></td>
      <td><code class="language-plaintext highlighter-rouge">#doubles [1.1 2.2 3.3]</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">Throwable-&gt;map</code></td>
      <td><code class="language-plaintext highlighter-rouge">#error &lt;result of Throwable-&gt;map&gt;</code> (see below)</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">float[]</code></td>
      <td><code class="language-plaintext highlighter-rouge">#floats [1.1 2.2 3.3]</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">int[]</code></td>
      <td><code class="language-plaintext highlighter-rouge">#ints [1 2 3]</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">long[]</code></td>
      <td><code class="language-plaintext highlighter-rouge">#longs [1 2 3]</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">Object[]</code></td>
      <td><code class="language-plaintext highlighter-rouge">#objects ["test" :foo 42 #atom false]</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">clojure.lang.Ref</code></td>
      <td><code class="language-plaintext highlighter-rouge">#ref {:test true}</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">java.util.regex.Pattern</code></td>
      <td><code class="language-plaintext highlighter-rouge">#regex "vesion: \d+"</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">java.sql.Timestamp</code></td>
      <td><code class="language-plaintext highlighter-rouge">#sql/Timestamp "2025-01-06T14:03:23.819Z"</code></td>
    </tr>
  </tbody>
</table>

<p>The <code class="language-plaintext highlighter-rouge">#error</code> tag is a bit special: it returns a value with no parsing. It
prevents an error when reading the result of printing of an exception:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nb">println</span><span class="w"> </span><span class="p">(</span><span class="nf">ex-info</span><span class="w"> </span><span class="s">"boom"</span><span class="w"> </span><span class="p">{</span><span class="no">:test</span><span class="w"> </span><span class="mi">123</span><span class="p">}))</span><span class="w">

</span><span class="o">#</span><span class="n">error</span><span class="w"> </span><span class="p">{</span><span class="w">
 </span><span class="no">:cause</span><span class="w"> </span><span class="n">boom</span><span class="w">
 </span><span class="no">:data</span><span class="w"> </span><span class="p">{</span><span class="no">:test</span><span class="w"> </span><span class="mi">123</span><span class="p">}</span><span class="w">
 </span><span class="no">:via</span><span class="w">
 </span><span class="p">[{</span><span class="no">:type</span><span class="w"> </span><span class="n">clojure.lang.ExceptionInfo</span><span class="w">
   </span><span class="no">:message</span><span class="w"> </span><span class="n">boom</span><span class="w">
   </span><span class="no">:data</span><span class="w"> </span><span class="p">{</span><span class="no">:test</span><span class="w"> </span><span class="mi">123</span><span class="p">}</span><span class="w">
   </span><span class="no">:at</span><span class="w"> </span><span class="p">[</span><span class="n">taggie.edn$eval9263</span><span class="w"> </span><span class="n">invokeStatic</span><span class="w"> </span><span class="n">form-init2367470449524935680.clj</span><span class="w"> </span><span class="mi">97</span><span class="p">]}]</span><span class="w">
 </span><span class="no">:trace</span><span class="w">
 </span><span class="p">[[</span><span class="n">taggie.edn$eval9263</span><span class="w"> </span><span class="n">invokeStatic</span><span class="w"> </span><span class="n">form-init2367470449524935680.clj</span><span class="w"> </span><span class="mi">97</span><span class="p">]</span><span class="w">
  </span><span class="p">[</span><span class="n">taggie.edn$eval9263</span><span class="w"> </span><span class="n">invoke</span><span class="w"> </span><span class="n">form-init2367470449524935680.clj</span><span class="w"> </span><span class="mi">97</span><span class="p">]</span><span class="w">
  </span><span class="c1">;; truncated</span><span class="w">
  </span><span class="p">[</span><span class="n">java.lang.Thread</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">Thread.java</span><span class="w"> </span><span class="mi">833</span><span class="p">]]}</span><span class="w">
</span></code></pre></div></div>

<p>When reading such data from EDN with Taggie, you’ll get a regular map.</p>

<h2 id="adding-your-types">Adding Your Types</h2>

<p>Imagine you have a custom type and you want Taggie to hande it:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">deftype</span><span class="w"> </span><span class="n">SomeType</span><span class="w"> </span><span class="p">[</span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="n">c</span><span class="p">])</span><span class="w">

</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">some-type</span><span class="w">
  </span><span class="p">(</span><span class="nb">new</span><span class="w"> </span><span class="n">SomeType</span><span class="w"> </span><span class="p">(</span><span class="nf">atom</span><span class="w"> </span><span class="no">:test</span><span class="p">)</span><span class="w">
                </span><span class="p">(</span><span class="nf">LocalDate/parse</span><span class="w"> </span><span class="s">"2023-01-03"</span><span class="p">)</span><span class="w">
                </span><span class="p">(</span><span class="nf">long-array</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="p">])))</span><span class="w">
</span></code></pre></div></div>

<p>To override the way it gets printed, run the <code class="language-plaintext highlighter-rouge">defprint</code> macro:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">taggie.print/defprint</span><span class="w"> </span><span class="n">SomeType</span><span class="w"> </span><span class="o">^</span><span class="n">SomeType</span><span class="w"> </span><span class="n">some-type</span><span class="w"> </span><span class="n">writer</span><span class="w">
  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">a</span><span class="w"> </span><span class="p">(</span><span class="nf">.-a</span><span class="w"> </span><span class="n">some-type</span><span class="p">)</span><span class="w">
        </span><span class="n">b</span><span class="w"> </span><span class="p">(</span><span class="nf">.-b</span><span class="w"> </span><span class="n">some-type</span><span class="p">)</span><span class="w">
        </span><span class="n">c</span><span class="w"> </span><span class="p">(</span><span class="nf">.-c</span><span class="w"> </span><span class="n">some-type</span><span class="p">)]</span><span class="w">
    </span><span class="p">(</span><span class="nf">.write</span><span class="w"> </span><span class="n">writer</span><span class="w"> </span><span class="s">"#SomeType "</span><span class="p">)</span><span class="w">
    </span><span class="p">(</span><span class="nf">print-method</span><span class="w"> </span><span class="p">[</span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="n">c</span><span class="p">]</span><span class="w"> </span><span class="n">writer</span><span class="p">)))</span><span class="w">
</span></code></pre></div></div>

<p>The first argument is a symbol bound to a class. The second is a symbol bound to
the instance of this class (in some cases you’ll need a type hint). The third
symbol is bound to the <code class="language-plaintext highlighter-rouge">Writer</code> instance. Inside the macro, you <code class="language-plaintext highlighter-rouge">.write</code> certain
values into the writer. Avobe, we write the leading <code class="language-plaintext highlighter-rouge">"#SomeType "</code> string, and a
vector of fields <code class="language-plaintext highlighter-rouge">a</code>, <code class="language-plaintext highlighter-rouge">b</code> and <code class="language-plaintext highlighter-rouge">c</code>. Calling <code class="language-plaintext highlighter-rouge">print-method</code> guarantees that all
nested data will be written with their custom tags.</p>

<p>Now if you print <code class="language-plaintext highlighter-rouge">some-type</code> or dump it into EDN, you’ll get:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">#</span><span class="n">SomeType</span><span class="w"> </span><span class="p">[</span><span class="o">#</span><span class="n">atom</span><span class="w"> </span><span class="no">:test</span><span class="w"> </span><span class="o">#</span><span class="n">LocalDate</span><span class="w"> </span><span class="s">"2023-01-03"</span><span class="w"> </span><span class="o">#</span><span class="n">longs</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="p">]]</span><span class="w">
</span></code></pre></div></div>

<p>The opposite step: define readers for <code class="language-plaintext highlighter-rouge">SomeType</code> class:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">taggie.readers/defreader</span><span class="w"> </span><span class="n">SomeType</span><span class="w"> </span><span class="p">[</span><span class="n">vect</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[[</span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="n">c</span><span class="p">]</span><span class="w"> </span><span class="n">vect</span><span class="p">]</span><span class="w">
    </span><span class="p">(</span><span class="nb">new</span><span class="w"> </span><span class="n">SomeType</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="n">c</span><span class="p">)))</span><span class="w">
</span></code></pre></div></div>

<p>It’s quite simple: the vector of fields is already parsed, so you only need to
split it and pass fields into the constructor.</p>

<p>The <code class="language-plaintext highlighter-rouge">defreader</code> mutates a global map of EDN readers. When you read an EDN
string, the <code class="language-plaintext highlighter-rouge">SomeType</code> will be held. But it won’t work in REPL: for example,
running <code class="language-plaintext highlighter-rouge">#SomeType [...]</code> in REPL will throw an error. The thing is, REPL
readers cannot be overriden in runtime.</p>

<p>But you can declare your own readers: in <code class="language-plaintext highlighter-rouge">src</code> directory, create a file called
<code class="language-plaintext highlighter-rouge">data_readers.clj</code> with a map:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="n">SomeType</span><span class="w"> </span><span class="n">some.namespace/__reader-SomeType-clj</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Restart the REPL, and now the tag will be available.</p>

<p>As you might have guessed, the <code class="language-plaintext highlighter-rouge">defreader</code> macro creates two functions:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">__reader-&lt;tag&gt;-clj</code> for a REPL reader;</li>
  <li><code class="language-plaintext highlighter-rouge">__reader-&lt;tag&gt;-edn</code> for an EDN reader.</li>
</ul>

<p>Each <code class="language-plaintext highlighter-rouge">-clj</code> reader relies on a corresponding <code class="language-plaintext highlighter-rouge">-edn</code> reader internally.</p>

<p><strong>Emacs &amp; Cider caveat:</strong> I noticed that <code class="language-plaintext highlighter-rouge">M-x cider-ns-refresh</code> command ruins
loading REPL tags. After this command being run, any attempt to execute
something like <code class="language-plaintext highlighter-rouge">#LocalDate "..."</code> ends up with an error saying “unbound
function”. Thus, if you use Emacs and Cider, avoid this command.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/just-use-postgres/">Просто берите Postgres</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2025-02-01T00:00:00+00:00">
        Feb 1, 2025
    </time>

    <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/postgres/" rel="tag">postgres</a>, <a href="/tag/sql/" rel="tag">sql</a>

</div>


            <div class="entry">
                
                    <p>Несколько месяцев назад завирусилась статья <a href="https://mccue.dev/pages/8-16-24-just-use-postgres">Just Use
Postgres</a>. Она была на всех
площадках, а том числе в переводе на русский. Я чуть было не репостнул ее, но
передумал. На проверку статья оказалось поверхностной: скажем, автор на полном
серьезе сравнивает Postgres с SQLite. Мне показалось, в статье нет глубины, и
тезис из заголовка ничем не подтверждается. И хотя вывод верный — Just Use
Postgres — автор пришел к нему странным способом.</p>

<p>В своей заметке я расскажу, как пришел к аналогичному выводу сам — только
доводов будет больше.</p>

<p>Последний год я занимаюсь Посгресом все активнее. Я мигрировал большую систему с
OpenSearch на Postgres. Это 30 сервисов с большими JSON-документами — от
нескольких тысяч до миллионов в каждом сервисе. Нужен поиск по вложенным полям,
поиск по вхождению, простое ранжирование, а также всякая отчетность. И пока я
все это мигрировал, узнал о Постгресе столько, что хватит на несколько
докладов. В том числе — почему именно Постгрес так хорош.</p>

<p>Я давно понял одну вещь, а миграция только ее укрепила. Хранение данных
определяет разработку. Это фундамент, относительно которого планируешь куда
копать и что возводить. Кто-то считает, что абстракцией можно уравновесить любое
хранилище: сделать так, что get-by-id либо идет в базу, либо качает файл из
S3. Это справедливо в простых случаях. На практике каждое хранилище вносит свои
особенности, с которыми нужно мириться. Если у вас условные OpenSearch или
Cassandra, их особенности будут фонить сквозь код. Избежать этого нельзя. На мой
взгляд, Постгрес фонит меньше всех: с ним у вас будет меньше проблем в
абстракцях.</p>

<p>Но довольно расплывчатых слов, перейдем к конкретике. Начну с того, что Постгрес
легко ставится и работает на любой машине, будь то локальный комп с Виндой,
Маком, Линуксом или сервер. Он есть во всех пакетах. Постгрес написан на Си, и
на выходе бинарный файл, которому не нужна Джава. Помню, как ставил Датомик на
Убунте — это было тяжело. Вроде бы Джава, “compile once, run everywhere (c)” —
но вылетают ошибки о том, что классы не найдены. Оказалось, нужна другая Джава,
которую нужно ставить отдельно. С Постгресом такого не было никогда.</p>

<p>Для Мака есть проект <a href="http://postgres.app/">Postgres.app</a>. Это приложение с
графическим интерфейсом, чтобы запустить Postgres. Можно скачать любую версию по
отдельности; есть убер-приложение со всеми версиями и установленным PostGis. Так
что любой человек может завести Postgres + PostGis в два клика.</p>

<p>Особой похвалы заслуживает <a href="https://hub.docker.com/_/postgres">докерный образ
Postgres</a>. Он очень гибко настраивается:
почти любую опцию можно задать переменной среды, легко прокинуть свою
конфигурацию. У образа убойная фича: папка, куда можно накидать файлы .sql, .sh
и .gz. При запуске образ запустит эти файлы в алфавитном порядке. Если у вас
миграции или посев тестовых данных, смонтируйте файлы в образ, и при запуске
получится готовая база.</p>

<p>По наивности я думал, что так работают образы других баз данных. Оказалось
нет. Запустил образ Кассандры, а она ничего не знает о первичной
настройке. Нужны разделы и таблицы? Создай сам. Нужны топики в Кафке? Создай
сам. Нужна точка обмена в RabbitMQ? Создай сам! После запуска образа нужно
дождаться, пока поднимутся все потроха (обычно это поллинг порта), а потом
создать таблицы и топики. Почему-то в Постгресе подумали над этим, а остальным
безразлично. Считаю, что образ postgres нужно брать за образец.</p>

<p>У документо-ориентированных баз и key-value хранилищ есть преимущество: они
хорошо реплицируются в силу дизайна. Часто говорят: вы со своим Постгресом
упретесь в потолок, когда нужно хранить данные в разных датацентрах, но при этом
иметь легкий доступ из одного центра к другому. Условная Кассандра чувствует
себя лучше в подобных условиях. Но забывают, что реплицировать нужно не все
данные, а только их часть. Например, только базовые сведения о пользователях и
сущностях, чтобы быстро выяснить, в каком дата-центре они лежат и выполнить
запрос там.</p>

<p>Так у нас было устроено в одном облачном хостинге. В каждом дата-центре данные
хранились в MySQL, а пользователи и права доступа дублировались в кластер
Кассанды, который в силу репликации был доступен отовсюду.</p>

<p>Postgres тоже не стоит на месте, и в нем все больше средств репликации и
кластеризации. Есть проекты вроде Debezium, которые читают журнал WAL и стримят
изменения в другие базы, очереди и так далее.</p>

<p>Postgres силен в проекции данных. Бывает, на одни и те же данные нужно смотреть
под разным углом: делать группировки, поворачивать таблицы. Часто нужны левые
соединения: это когда слева находится полный набор данных, а справа — неполный,
и данные слева не должны пропадать. В редких случаях нужно декартово
произведение двух таблиц (каждый по каждому), что тоже делается легко. Есть
много функций, которые разбивают данные на строки (переводят массивы в строки
элементов) и наоборот — агрегируют записи в коллекции.</p>

<p>Postgres силен рекурсивными запросами. Это когда запрос разбивается на две
части: первичный посев и рекурсивная логика, которая принимает предыдущий
результат и порождает новый. Пока он не пустой, строки складываются в итоговую
таблицу. За счет рекурсии прекрасно обходятся таблицы со ссылками на себя,
например структура папок, иерархия сущностей.</p>

<p>В финансах очень важны оконные функции: посчитать нарастающий доход, остаток на
счете, стоимость проекта по неделям и многое другое. Оконные функции слегка
пугают, но достаточно прочитать одну книжку, чтобы овладеть ими (см ниже). Без
оконных функций происходит следующее: человек выгребает из базы массив данных и
проделывает вручную то, что умеет база — только на порядок медленней и с кучей
багов. О похожем случае <a href="/postgres-csv/">я как-то уже писал</a>.</p>

<p>Огромную пользу можно получить из связки materialized view и pg_cron. Напомню,
materialized view — это вьюхи, которые сбрасываются в физическую таблицу. На нее
можно навесить индексы, чтобы ускорить поиск. Польза таких вьюх огромна — это
различные проекции и отчеты. Чтобы каждый раз не гонять огромный запрос, его
“запекают” во вьюху и материализуют, после чего выбирают строки обычным SELECT.</p>

<p>В текущем проекте мы храним огромные JSON-документы. У них сложная структура, но
отчетность должна быть плоской. Сначала я писал запросы со множеством операторов
<code class="language-plaintext highlighter-rouge">#&gt;&gt;</code>, которые извлекают данные из JSON по пути в виде массива. Но со временем
стал делать плоские представления этих документов вьюхами — и дело пошло
лучше. Аналитикам и менеджерам тоже легче: им постоянно нужные данные, и они
пишут запросы сами, чтобы не дергать программистов.</p>

<p>Расширение <a href="https://github.com/citusdata/pg_cron">pg_cron</a> выводит Постгрес на
новый уровень: с его помощью можно выполнить любой скрипт по
расписанию. Расширение использует стандартный синтаксис crontab. У меня
множество крон-задач на материализацию вьюх и прогрев индексов — их
принудительный загон в оперативную память. С <code class="language-plaintext highlighter-rouge">pg_cron</code> база становится полностью
автономной: не нужен сторонний крон, который пинает скрипты. Я недоволен только
одним: <code class="language-plaintext highlighter-rouge">pg_cron</code> — стороннее расширение, и его нет в поставке. Однако облачные
провайдеры вроде Амазона предустанавливают его.</p>

<p>На сегодня Постгрес — лучшая база для работы с JSON-документами. Я не в восторге
от JSON и насколько возможно, храню данные в таблицах. Но порой выбора нет:
бизнес завязан на какие-то стандарты. Пример — медицинский <a href="https://www.hl7.org/fhir/overview.html">формат
FHIR</a>. Это огромные документы тройной и
более вложенности. Раскладывать их по таблицам и собирать джоинами тяжело,
поэтому их хранят в поле jsonb. У меня похожая ситуация : 30 сервисов, каждый
отвечает за свою бизнес-сущность. Это большие JSON-ы, и сервисы гоняют их
туда-сюда; на них завязан фронтенд. Я пытался представить их в плоском виде, но
это очень трудно.</p>

<p>Постгрес предлагает богатные возможности для JSON: доступ ко вложенным полям по
массиву ключей, обновление вложенных полей, слияние словарей, гибкую замену,
индексацию документа целиком или подмножества… Есть даже встроенный язык <a href="https://www.postgresql.org/docs/current/functions-json.html#FUNCTIONS-SQLJSON-PATH">JSON
PATH</a>
для поиска! Да, внутри SQL может быть строка с мини-языком JSON PATH. Я
использую его в сочетании индексами btree по отдельным полям.</p>

<p>В последнем Постгресе 17 появилась функция
<a href="https://www.postgresql.org/docs/current/functions-json.html#FUNCTIONS-SQLJSON-TABLE">JSON_TABLE</a>. По
указанной спеке она переводит JSON в таблицу с выводом типов. Если у вас вектор
мап, то легко получить таблицу. JSON_TABLE поддерживает вложенность, в
результате чего можно развернуть мапу мап в плоскую таблицу. Далее вы
материализуете ее, ставите на крон и готово — можно выбрать плоские данные
селектом.</p>

<p>Для Постгреса создано великое число обучающих материалов: книг, курсов,
самоучителей. Многие из них изначально созданы на русском, то есть не являются
переводами. Российский вендор Postgres Pro не только пишет отличные книги, но и
<a href="https://postgrespro.ru/education/books">выкладывает на сайте</a>
бесплатно. Бесплатно! Я читал некоторые из них, и это не халтура, а
действительно проработанные материалы. Книга Егора Рогова “Postgres изнутри”
описывает устройство базы в мельчайших деталях. Наверное, нет книги лучше, чтобы
понять, как работают современные базы данных.</p>

<p>В Постгресе отличный анализатор запросов: он покажет, какие стратегии выбрал
движок для обхода таблиц и джоинов; какие индексы были использованы и какую их
часть пришлось читать с диска. Да, понадобится время, чтобы понять его вывод. Но
иные базы данных не предлагают вообще ничего! Просто дают рекомендации, а дальше
пробуй сам. Есть расширения, которые фиксируют медленные запросы и их план
выполнения. Расширение pg_stat_statements ведет статистику по всем запросам:
число вызовов, частота, минимальное, максимальное, среднее время выполнения,
ожидание, объем передачи данных и прочее. Все это помогает отлаживать случаи,
когда базе нехорошо.</p>

<p>В Постгресе достойный полнотекстовый поиск. Для начала подойдет <a href="https://www.postgresql.org/docs/current/pgtrgm.html">триграммный
нечеткий поиск</a> по
коэффициенту совпадения. Позже можно добавить ts_vector — вектор лексем и
стемминга. Из коробки есть стемминг для десятка языков, в том числе
русского. Когда заходят разговоры об OpenSearch и других поисковых движках,
оказывается, что на Постгресе можно сделать не хуже и главное — без добавления в
систему нового узла.</p>

<p>У Постгреса обширный тулинг: консольные и графические клиенты — браузерные и
настольные. PGAdmin, DBeaver, DataGrip… стандартная утилита psql покрывает
множество случаев. Она показывает сведения обо всех сущностях, выводит данные
разными способами, умеет импорт-экспорт. Можно редактировать запросы и сущности
во внешнем редакторе, например Emacs или Vim.</p>

<p>Постгрес поддерживает <a href="https://www.postgresql.org/docs/current/sql-copy.html">апишку
COPY</a>, с помощью которой
данные гоняют в обе стороны. Если я хочу слить таблицу в CSV, пишу что-то вроде:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">COPY</span> <span class="n">my_table</span> <span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">email</span><span class="p">)</span> <span class="k">to</span> <span class="k">STDOUT</span>
  <span class="k">with</span> <span class="p">(</span><span class="n">HEADER</span><span class="p">,</span> <span class="n">format</span> <span class="n">CSV</span><span class="p">)</span>
</code></pre></div></div>

<p>и Постгрес выплевывает CSV-шный файл. Можно записать файл на диск или читать
построчно из сети. Это работает и в обратную сторону: если я хочу вставить CSV в
таблицу, то пишу:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">COPY</span> <span class="n">my_table</span> <span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">email</span><span class="p">)</span> <span class="k">from</span> <span class="k">STDIN</span>
  <span class="k">with</span> <span class="p">(</span><span class="n">HEADER</span><span class="p">,</span> <span class="n">format</span> <span class="n">CSV</span><span class="p">)</span>
</code></pre></div></div>

<p>и стримлю в соединение строки CSV. Кроме CSV, Постгрес поддерживает бинарный
формат. Спецификация довольна проста, и на практике он работает на 30% быстрее.</p>

<p>Словом, гонять большие данные в Постгресе очень просто. Я как-то <a href="/pagination/">писал о
том</a>, что источник данных хорош настолько, насколько удобно
забрать из него данные. В том же OpenSearch забор данных превращается в муку:
нужна ручная пагинация по страницам. А Постгрес выплюнет миллион строк и не
моргнет глазом — только успевай их принимать.</p>

<p>Не менее важна генерация данных. Скажем, у вас на проде миллион записей, и нужно
воспроизвести сложный запрос. Если в локальной базе только тысяча записей, он
поведет себя по-другому; нужен именно миллион. Как вы их вставите?</p>

<p>Обычно на этом месте расчехляют Питон и всякие FakeMockGenerator-ы — библиотеки
для генерации случайных данных по спеке. Этот код долго писать, и вставка тоже
будет долгой, потому что мы передаем данные от клиента серверу. Еще нужен
рантайм, то есть среда, где запускается код: какая-то машина, нода, плейбук.</p>

<p>А ведь достаточно написать примерно такой скрипт и выполнить его в PGAdmin:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">insert</span> <span class="k">into</span> <span class="n">documents</span> <span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">document</span><span class="p">)</span>
<span class="k">select</span>
    <span class="n">gen_random_uuid</span><span class="p">()</span> <span class="k">as</span> <span class="n">id</span><span class="p">,</span>
    <span class="n">jsonb_build_object</span><span class="p">(</span>
        <span class="s1">'__generated__'</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span>
        <span class="s1">'meta'</span><span class="p">,</span> <span class="n">jsonb_build_object</span><span class="p">(</span>
            <span class="s1">'eyes'</span><span class="p">,</span> <span class="n">format</span><span class="p">(</span><span class="s1">'color-%s'</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="p">),</span>
        <span class="s1">'attrs'</span><span class="p">,</span> <span class="n">jsonb_build_object</span><span class="p">(</span>
            <span class="s1">'email'</span><span class="p">,</span> <span class="n">format</span><span class="p">(</span><span class="s1">'user-%s@test.com'</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span>
            <span class="s1">'name'</span><span class="p">,</span> <span class="n">format</span><span class="p">(</span><span class="s1">'Test Name %s'</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="p">),</span>
        <span class="s1">'roles'</span><span class="p">,</span> <span class="n">jsonb_build_array</span><span class="p">(</span>
            <span class="s1">'user'</span><span class="p">,</span>
            <span class="s1">'admin'</span>
        <span class="p">)</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">document</span>
<span class="k">from</span>
    <span class="n">generate_series</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span> <span class="k">as</span> <span class="n">x</span>
<span class="n">returning</span>
    <span class="n">id</span><span class="p">;</span>
</code></pre></div></div>

<p>Он вставит в базу столько JSON-документов, сколько указано в функции
generate_series. Хочешь миллион? Да пожалуйста. Важно, что данные генерятся
<strong>сразу на сервере</strong> — мы не гоняем их по сети. Все происходит внутри Постгреса,
и это значительно быстрее. Миллион огромных JSON-ов вставляются за несколько
минут. Этот скрипт легко поправить, чтобы поля высчитывались по-другому. Каждый
может скопировать его и выполнить на свой базе, не прибегая к Питону.</p>

<p>Иные жалуются, что SQL устарел. Мол, это архаичный язык, он плохо
шаблонизируется, и логично выразить его данными, например JSON-ом. Что тут
сказать… Да, SQL со скрипом ложится на всякие ORM. Но сегодня полно библиотек,
которые строят SQL из объектов и коллекций. А во-вторых, мне нравится
самобытность SQL, то, что он остается вещью в себе. Когда пишешь большие
запросы, начинаешь видеть его красоту. Со временем понимаешь, что заменить его
нечем — слишком много ситуаций и выражений.</p>

<p>Я рассматриваю SQL как REPL к данным. Наверное, вы знаете, что программисты на
Лиспе днями сидят в репле. О преимуществе REPL-driven develpoment сказано много,
и нет смысла повторять. По аналогии, SQL — это репл для данных со всеми
преимуществами REPL-driven develpoment. Легко понять, какие данные прилетят в
код, выполнив запрос в базе. Вместо быдлокода, который вынимает тысячи записей,
исправляет их и записывает в базу, можно выполнить один UPDATE. Поймал себя на
том, что целыми днями сижу в PGAdmin, а к коду приступаю в последнюю очередь.</p>

<p>Повторю тезис, который как-то высказывал. Данные — это отдельный домен. Ключевое
свойство домена — его ортогональность другим доменам. Я хочу, чтобы данные не
были привязаны ко всяким Питонам и Джавам. Я хочу управлять ими независимо от
языка или потребителей. Мне не нравятся встраиваемые хранилища или базы, которые
“сливаются” с приложением. Если данные можно извлечь только вызовом метода, я
пас.</p>

<p>Рассказывать о том, как динамично развивается Постгрес, нет смысла. Это видно
всем. Есть классический Постгрес, есть вендорский Postgres Pro, где доступны
различные фичи до того, как они окажутся в классике — правда, за
деньги. Развиваются расширения, появляются новые вендоры, проводят митапы и
конференции, выходят книги, видосы… на любой запрос найдется контент.</p>

<p>Важно, что сообщество Постгреса прошло проверку на адекватность. Как только один
<em>чудак</em> заявил, что нужно выгнать русских разработчиков и откатить их код, ему
быстро объяснили, что к чему. Больше эту тему не поднимали, по крайней мере в
публичном пространстве.</p>

<p>И вот теперь, в конце шестого листа, я говорю: <em>вот поэтому</em> берите Постгрес.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/solid-context/">SOLID и контекст</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2025-01-27T00:00:00+00:00">
        Jan 27, 2025
    </time>

    <a href="/tag/solid/" rel="tag">solid</a>

</div>


            <div class="entry">
                
                    <p>Когда говорят про SOLID, забывают вот о чем. Принцип SOLID — типичный пример,
когда контекст, в котором возникло явление, важнее самого явления.</p>

<p>SOLID возник в момент, когда в ООП-тусовке царил упадок. До повсеместного
перехода на ООП говорили, что объекты решат все проблемы. Достаточно выразить
сущности классами и нарисовать UML-схему — и все станет понятно. Звучит примерно
как “Земля плоская”, но тогда в это верили. И когда ООП-модель стала буксовать,
придумали SOLID, чтобы вдохнуть в нее новую жизнь.</p>

<p>У SOLID есть даже не аналогия, а буквальный пример из жизни. Каждый тренер
знает, что главное у спортсмена — настрой (разумеется, не исключая питание и
тренировки). Если настрой в упадке, есть не совсем честные способы его
поднять. Скажем, когда команда проигрывает всухую, тренер берет таймаут и выдает
“заряженные” клюшки, которыми играли великие спортсмены. Или переставляет
участников местами, говоря, что сейчас будем играть по “секретной”
тактике. Поскольку спортсмены суеверны, это работает.</p>

<p>Та же самая история у военных, полицейских, пожарных. У них есть церемонии
раздачи “заряженных” девайсов, например, касок погибших героев. Надевая такую
каску, боец буквально получает +100 к отваге. Вопрос о том, действительно ли
герой носил эту каску, тактично обойдем стороной.</p>

<p>С принципом SOLID то же самое. Когда стало ясно, что нагромождение классов не
решает прошлых проблем, а только добавляет новых, кто-то придумал SOLID. Посыл в
том, что отныне мы не блуждаем в потемках, а идем к некой цели. Пишем не просто
быдлокод, а по некой методичке. И пусть она спорна и расплывчата, это неважно —
есть ориентир. Спортсмен снова мотивирован и готов брать рубежи.</p>

<p>Поэтому отношение к SOLID у меня спорное. Смысловая составляющая высосана из
пальца, но запал колоссальный. Уже десятки лет люди спорят о том, как писать код
по SOLID правильно. В этом смысле я снимаю перед создателем шляпу, потому что
ведь надо так уметь! — вдохновить толпы народа без какой-либо конкретики.</p>

<p>Но у любой легенды есть запас прочности, и актуальность SOLID подходит к
концу. Я понимаю, когда о нем пишут в рекламных блогах или курсах для
новичков. SOLID — это все и ни о чем, универсальный рецепт, из которого можно
выжать тысячи текстов. Но удивляет, когда кто-то всерьез рассуждает о том, как в
2025 году писать код по SOLID. Здесь можно сказать одно: как бы ни держалась
стюардесса, ее пора закопать.</p>

                
            </div>

        </li>
        
    </ul>

    <h4>
        
        <a href="/page14" class="previous">&larr;</a>
        
        <span class="page_number ">Страница 15 из 104</span>
        
        <a href="/page16" class="next">&rarr;</a>
        
    </h4>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Ivan Grishaev's blog</li>
          <li><a href="mailto:ivan@grishaev.me">ivan@grishaev.me</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
            <li><a href="https://github.com/igrishaev">GitHub</a></li>
            <li><a href="https://t.me/igrishaev_blog">Telegram</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Writing on programming, education, books and negotiations.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
