<!DOCTYPE html>
<html lang="ru">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Ring JDK Adapter</title>
  <meta name="description" content="">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/custom.css">
  <link rel="canonical" href="https://grishaev.me/ring-jdk-adapter/">
  <link rel="alternate" type="application/rss+xml" title="Ivan Grishaev's blog" href="https://grishaev.me/feed.xml">

  <link rel="shortcut icon" type="image/x-icon" href="/assets/static/favicons/favicon.ico">

  <script type="text/javascript" src="/assets/typo.js"></script>

</head>


  <body>
    <header class="site-header">

    <div class="wrapper flex-container">

        <div>
            <a href="/">
                <img id="avatar" src="/assets/static/avatar.jpg" alt="Ivan Grishaev">
            </a>
        </div>

        <div class="flex-container-vert" style="margin-left: 15px; width: 80%">

            <div class="flex-container full-width">
                <p style="margin-bottom: 5px">Ivan Grishaev's blog</p>
                <div class="flex-huge"></div>
                <div >
<form id="search-form"
      target="_blank"
      style="display: inline"
      method="get"
      action="https://www.google.com/search">

    <input name="sitesearch"
           value="grishaev.me"
           type="hidden">

    <input type="text"
           required="required"
           name="q"
           placeholder="Google search..."
           autocomplete="off">

    <button style="border: none; background-color: transparent; cursor: pointer;"
            type="submit">&#x1f50d;</button>

</form>
</div>
            </div>

            <p><small>Writing on programming, education, books and negotiations.
</small></p>

            <div class="flex-container">
                <a class="menu-item" href="/">Home</a>
                <a class="menu-item" href="/about/">About</a>
                <a class="menu-item" href="/bookshelf/">Bookshelf</a>
                <a class="menu-item" href="/feed.xml">RSS</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor" href="/tag/clojure/">Clojure</a>
                <a class="menu-item minor" href="/tag/emacs/">Emacs</a>
                <a class="menu-item minor" href="/tag/python/">Python</a>
                <a class="menu-item minor" href="/tag/programming/">Programming</a>
                <a class="menu-item minor" href="/interview/">Interview</a>
                <a class="menu-item minor" href="/video/">Video</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor hl" href="/clojure-in-prod/">Книга «Clojure на производстве»</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor hl" href="/clojure-in-prod-2/">Книга «Clojure на производстве», второй том</a>
            </div>

        </div>
    </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">

    <h1 class="post-title" itemprop="name headline">Ring JDK Adapter</h1>

    
<div class="post-meta">

    <time class="post-time"
          datetime="2024-11-15T00:00:00+00:00">
        Nov 15, 2024
    </time>

    <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/clojure/" rel="tag">clojure</a>, <a href="/tag/ring/" rel="tag">ring</a>, <a href="/tag/http/" rel="tag">http</a>, <a href="/tag/java/" rel="tag">java</a>

</div>


  </header>

  <div class="post-content" itemprop="articleBody">
    
<p><a href="https://github.com/igrishaev/ring-jdk-adapter">Ring JDK Adapter</a> is a small wrapper on top of a built-in HTTP server
available in Java. It’s like Jetty but has no dependencies. It’s almost as fast
as Jetty, too (see benchmars below).</p>

<h2 id="why">Why</h2>

<p>Sometimes you want a local HTTP server in Clojure, e.g. for testing or mocking
purposes. There is a number of adapters for Ring but all of them rely on third
party servers like Jetty, Undertow, etc. Running them means to fetch plenty of
dependencies. This is tolerable to some extent, yet sometimes you really want
something quick and simple.</p>

<p>Since version 9 or 11 (I don’t remember for sure), Java ships its own HTTP
server. The package name is <code class="language-plaintext highlighter-rouge">com.sun.net.httpserver</code> and the module name is
<code class="language-plaintext highlighter-rouge">jdk.httpserver</code>. The library provides an adapter to serve Ring handlers. It’s
completely free from any dependencies.</p>

<p>Ring JDK Adapter is a great choice for local HTTP stubs or mock services that
mimic HTTP services. Despite some people think it’s for development purposes
only, the server is pretty fast! One can use it even in production.</p>

<h2 id="availability">Availability</h2>

<p>It’s worth mentioning that some Java installations may miss the <code class="language-plaintext highlighter-rouge">jdk.httpserver</code>
module. Please ensure the JVM you’re using in production supports it
first. Check out the following links:</p>

<ul>
  <li><a href="https://stackoverflow.com/questions/58764710/is-package-com-sun-net-httpserver-standard">StackOverflow: Is package com.sun.net.httpserver
standard?</a></li>
  <li><a href="https://docs.oracle.com/en/java/javase/21/docs/api/index.html">Java® Platform, Standard Edition &amp; Java Development Kit Version 21 API Specification</a></li>
</ul>

<h2 id="installation">Installation</h2>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">;; lein</span><span class="w">
</span><span class="p">[</span><span class="n">com.github.igrishaev/ring-jdk-adapter</span><span class="w"> </span><span class="s">"0.1.0"</span><span class="p">]</span><span class="w">

</span><span class="c1">;; deps</span><span class="w">
</span><span class="n">com.github.igrishaev/ring-jdk-adapter</span><span class="w"> </span><span class="p">{</span><span class="no">:mvn/version</span><span class="w"> </span><span class="s">"0.1.0"</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Requires Java version at least 16, Clojure at least 1.8.0.</p>

<h2 id="quick-demo">Quick Demo</h2>

<p>Import the namespace, declare a Ring handler as usual:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">ns</span><span class="w"> </span><span class="n">demo</span><span class="w">
  </span><span class="p">(</span><span class="no">:require</span><span class="w">
   </span><span class="p">[</span><span class="n">ring.adapter.jdk</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">jdk</span><span class="p">]))</span><span class="w">

</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">handler</span><span class="w"> </span><span class="p">[</span><span class="n">request</span><span class="p">]</span><span class="w">
  </span><span class="p">{</span><span class="no">:status</span><span class="w"> </span><span class="mi">200</span><span class="w">
   </span><span class="no">:headers</span><span class="w"> </span><span class="p">{</span><span class="s">"Content-Type"</span><span class="w"> </span><span class="s">"text/plain"</span><span class="p">}</span><span class="w">
   </span><span class="no">:body</span><span class="w"> </span><span class="s">"Hello world!"</span><span class="p">})</span><span class="w">
</span></code></pre></div></div>

<p>Pass it into the <code class="language-plaintext highlighter-rouge">server</code> function and check the http://127.0.0.1:8082 page in
your browser:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">server</span><span class="w">
  </span><span class="p">(</span><span class="nf">jdk/server</span><span class="w"> </span><span class="n">handler</span><span class="w"> </span><span class="p">{</span><span class="no">:port</span><span class="w"> </span><span class="mi">8082</span><span class="p">}))</span><span class="w">
</span></code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">server</code> function returns an instance of the <code class="language-plaintext highlighter-rouge">Server</code> class. To stop it,
pass the result into the <code class="language-plaintext highlighter-rouge">jdk/stop</code> or <code class="language-plaintext highlighter-rouge">jdk/close</code> functions:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">jdk/stop</span><span class="w"> </span><span class="n">server</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>Since the <code class="language-plaintext highlighter-rouge">Server</code> class implements <code class="language-plaintext highlighter-rouge">AutoCloseable</code> interface, it’s compatible
with the <code class="language-plaintext highlighter-rouge">with-open</code> macro:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nb">with-open</span><span class="w"> </span><span class="p">[</span><span class="n">server</span><span class="w"> </span><span class="p">(</span><span class="nf">jdk/server</span><span class="w"> </span><span class="n">handler</span><span class="w"> </span><span class="n">opt?</span><span class="p">)]</span><span class="w">
  </span><span class="n">...</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>The server gets closed once you’ve exited the macro. Here is a similar
<code class="language-plaintext highlighter-rouge">with-server</code> macro which acts the same:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">jdk/with-server</span><span class="w"> </span><span class="p">[</span><span class="n">handler</span><span class="w"> </span><span class="n">opt?</span><span class="p">]</span><span class="w">
  </span><span class="n">...</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<h2 id="parameters">Parameters</h2>

<p>The <code class="language-plaintext highlighter-rouge">server</code> function and the <code class="language-plaintext highlighter-rouge">with-server</code> macro accept the second optional map
of the parameters:</p>

<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Default</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:host</code></td>
      <td>127.0.0.1</td>
      <td>Host name to listen</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:port</code></td>
      <td>8080</td>
      <td>Port to listen</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:stop-delay-sec</code></td>
      <td>0</td>
      <td>How many seconds to wait when stopping the server</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:root-path</code></td>
      <td>/</td>
      <td>A path to mount the handler</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:threads</code></td>
      <td>0</td>
      <td>Amount of CPU threads. When &gt; thn 0, a new <code class="language-plaintext highlighter-rouge">FixedThreadPool</code> executor is used</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:executor</code></td>
      <td>null</td>
      <td>A custom instance of <code class="language-plaintext highlighter-rouge">Executor</code>. Might be a virtual executor as well</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:socket-backlog</code></td>
      <td>0</td>
      <td>A numeric value passed into the <code class="language-plaintext highlighter-rouge">HttpServer.create</code> method</td>
    </tr>
  </tbody>
</table>

<p>Example:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">server</span><span class="w">
  </span><span class="p">(</span><span class="nf">jdk/server</span><span class="w"> </span><span class="n">handler</span><span class="w">
              </span><span class="p">{</span><span class="no">:host</span><span class="w"> </span><span class="s">"0.0.0.0"</span><span class="w"> </span><span class="c1">;; listen all addresses</span><span class="w">
               </span><span class="no">:port</span><span class="w"> </span><span class="mi">8800</span><span class="w">      </span><span class="c1">;; a custom port</span><span class="w">
               </span><span class="no">:threads</span><span class="w"> </span><span class="mi">8</span><span class="w">      </span><span class="c1">;; use custom fixed trhead executor</span><span class="w">
               </span><span class="no">:root-path</span><span class="w"> </span><span class="s">"/my/app"</span><span class="p">}))</span><span class="w">
</span></code></pre></div></div>

<p>When run, the handler above is be available by the address
http://127.0.0.1:8800/my/app in the browser.</p>

<h2 id="body-type">Body Type</h2>

<p>JDK adapter supports the following response <code class="language-plaintext highlighter-rouge">:body</code> types:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">java.lang.String</code></li>
  <li><code class="language-plaintext highlighter-rouge">java.io.InputStream</code></li>
  <li><code class="language-plaintext highlighter-rouge">java.io.File</code></li>
  <li><code class="language-plaintext highlighter-rouge">java.lang.Iterable&lt;?&gt;</code> (see below)</li>
  <li><code class="language-plaintext highlighter-rouge">null</code> (nothing gets sent)</li>
</ul>

<p>When the body is <code class="language-plaintext highlighter-rouge">Iterable</code> (might be a lazy seq as well), every item is sent as
a string in UTF-8 encoding. Null values are skipped.</p>

<h2 id="middleware">Middleware</h2>

<p>To gain all the power of Ring (parsed parameters, JSON, sessions, etc), wrap
your handler with the standard middleware:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">ns</span><span class="w"> </span><span class="n">demo</span><span class="w">
  </span><span class="p">(</span><span class="no">:require</span><span class="w">
    </span><span class="p">[</span><span class="n">ring.middleware.params</span><span class="w"> </span><span class="no">:refer</span><span class="w"> </span><span class="p">[</span><span class="n">wrap-params</span><span class="p">]]</span><span class="w">
    </span><span class="p">[</span><span class="n">ring.middleware.keyword-params</span><span class="w"> </span><span class="no">:refer</span><span class="w"> </span><span class="p">[</span><span class="n">wrap-keyword-params</span><span class="p">]]</span><span class="w">
    </span><span class="p">[</span><span class="n">ring.middleware.multipart-params</span><span class="w"> </span><span class="no">:refer</span><span class="w"> </span><span class="p">[</span><span class="n">wrap-multipart-params</span><span class="p">]]))</span><span class="w">

</span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">handler</span><span class="w"> </span><span class="p">(</span><span class="nb">-&gt;</span><span class="w"> </span><span class="n">handler</span><span class="w">
                  </span><span class="n">wrap-keyword-params</span><span class="w">
                  </span><span class="n">wrap-params</span><span class="w">
                  </span><span class="n">wrap-multipart-params</span><span class="p">)]</span><span class="w">
  </span><span class="p">(</span><span class="nf">jdk/server</span><span class="w"> </span><span class="n">handler</span><span class="w"> </span><span class="p">{</span><span class="no">:port</span><span class="w"> </span><span class="mi">8082</span><span class="p">}))</span><span class="w">
</span></code></pre></div></div>

<p>The wrapped handler will receive a <code class="language-plaintext highlighter-rouge">request</code> map with parsed <code class="language-plaintext highlighter-rouge">:query-params</code>,
<code class="language-plaintext highlighter-rouge">:form-params</code>, and <code class="language-plaintext highlighter-rouge">:params</code> fields. These middleware come from the <code class="language-plaintext highlighter-rouge">ring-core</code>
library which you need to add into your dependencies. The same applies to
handling JSON and the <code class="language-plaintext highlighter-rouge">ring-json</code> library.</p>

<h2 id="exception-handling">Exception Handling</h2>

<p>If something gets wrong while handling a request, you’ll get a plain text page
with a short message and a stack trace:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">handler</span><span class="w"> </span><span class="p">[</span><span class="n">request</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="c1">;; !</span><span class="w">
  </span><span class="p">{</span><span class="no">:status</span><span class="w"> </span><span class="mi">200</span><span class="w">
   </span><span class="no">:headers</span><span class="w"> </span><span class="p">{</span><span class="s">"Content-Type"</span><span class="w"> </span><span class="s">"text/plain"</span><span class="p">}</span><span class="w">
   </span><span class="no">:body</span><span class="w"> </span><span class="s">"hello"</span><span class="p">})</span><span class="w">
</span></code></pre></div></div>

<p>This is what you’ll get in the browser:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>failed to execute ring handler
java.lang.ArithmeticException: Divide by zero
	at clojure.lang.Numbers.divide(Numbers.java:190)
	at clojure.lang.Numbers.divide(Numbers.java:3911)
	at bench$handler.invokeStatic(form-init14855917186251843338.clj:8)
	at bench$handler.invoke(form-init14855917186251843338.clj:7)
	at ring.adapter.jdk.Handler.handle(Handler.java:112)
	at jdk.httpserver/com.sun.net.httpserver.Filter$Chain.doFilter(Filter.java:98)
	at jdk.httpserver/sun.net.httpserver.AuthFilter.doFilter(AuthFilter.java:82)
	at jdk.httpserver/com.sun.net.httpserver.Filter$Chain.doFilter(Filter.java:101)
	at jdk.httpserver/sun.net.httpserver.ServerImpl$Exchange$LinkHandler.handle(ServerImpl.java:873)
	at jdk.httpserver/com.sun.net.httpserver.Filter$Chain.doFilter(Filter.java:98)
	at jdk.httpserver/sun.net.httpserver.ServerImpl$Exchange.run(ServerImpl.java:849)
	at jdk.httpserver/sun.net.httpserver.ServerImpl$DefaultExecutor.execute(ServerImpl.java:204)
	at jdk.httpserver/sun.net.httpserver.ServerImpl$Dispatcher.handle(ServerImpl.java:567)
	at jdk.httpserver/sun.net.httpserver.ServerImpl$Dispatcher.run(ServerImpl.java:532)
	at java.base/java.lang.Thread.run(Thread.java:1575)
</code></pre></div></div>

<p>To prevent this data from being leaked to the client, use your own
<code class="language-plaintext highlighter-rouge">wrap-exception</code> middleware, something like this:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">wrap-exception</span><span class="w"> </span><span class="p">[</span><span class="n">handler</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="k">fn</span><span class="w"> </span><span class="p">[</span><span class="n">request</span><span class="p">]</span><span class="w">
    </span><span class="p">(</span><span class="nf">try</span><span class="w">
      </span><span class="p">(</span><span class="nf">handler</span><span class="w"> </span><span class="n">request</span><span class="p">)</span><span class="w">
      </span><span class="p">(</span><span class="nf">catch</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="w">
        </span><span class="p">(</span><span class="nf">log/errorf</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="n">...</span><span class="p">)</span><span class="w">
        </span><span class="p">{</span><span class="no">:status</span><span class="w"> </span><span class="mi">500</span><span class="w">
         </span><span class="no">:headers</span><span class="w"> </span><span class="p">{</span><span class="n">...</span><span class="p">}</span><span class="w">
         </span><span class="no">:body</span><span class="w"> </span><span class="s">"No cigar! Roll again!"</span><span class="p">}))))</span><span class="w">
</span></code></pre></div></div>

<h2 id="benchmarks">Benchmarks</h2>

<p>As mentioned above, the JDK server although though is for dev purposes only, is
not so bad! The chart below proves it’s almost as fast as Jetty. There are five
attempts of <code class="language-plaintext highlighter-rouge">ab -l -n 1000 -c 50 ...</code> made against both Jetty and JDK servers
(1000 requests in total, 50 parallel). The levels of RPS are pretty equal: about
12-13K requests per second.</p>

<p>Measured on Macbook M3 Pro 32Gb, default settings, the same REPL.</p>

<p><img src="/assets/static/aws/ring-jdk-adapter/chart_1.svg" width="100%" height="auto" /></p>


    
<div class="prev-next">

    <div class="prev-next-left">
    
        <p><small><a href="/python-warn/">&larr; Python Software Foundation</a></small></p>
    
    </div>

    <div class="prev-next-mid">
    </div>

    <div class="prev-next-right">
    
        <p><small><a href="/ai-everywhere/">Всюду AI &rarr;</a></small></p>
    
    </div>

</div>

  </div>

</article>

<center>
    <p>
        <small>Нашли ошибку? Выделите мышкой и нажмите Ctrl/&#8984;+Enter</small>
    </p>
</center>





<center>
    
    Комментариев пока нет
    
    
</center>









<form id="comment-form" method="POST" action="https://functions.yandexcloud.net/d4ehfuf08fjfjr59ivnf">

    <div class="block">
        <p class="comment-form-label"><small>Your name</small></p>
        <input required id="comment-form-author" name="author" type="text">
    </div>

    <div class="block">
        <p class="comment-form-label"><small>Comment (markdown syntax)</small></p>
        <textarea required id="comment-form-comment" name="comment"></textarea>
    </div>

    <input required name="path" type="hidden" value="/ring-jdk-adapter/">
    <input required name="captcha" type="hidden" value="4 &#215; 5">

    <div class="block">
        <span class="comment-form-label"><small>4 &#215; 5 = </small></span>
        <input required id="comment-form-solution" name="solution" type="text">
    </div>

    <div class="block">
        <button id="comment-form-send" type="submit">Send</button>
    </div>

</form>


      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Ivan Grishaev's blog</li>
          <li><a href="mailto:ivan@grishaev.me">ivan@grishaev.me</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
            <li><a href="https://github.com/igrishaev">GitHub</a></li>
            <li><a href="https://t.me/igrishaev_blog">Telegram</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Writing on programming, education, books and negotiations.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
