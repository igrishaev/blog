<!DOCTYPE html>
<html lang="ru">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Ivan Grishaev's blog</title>
  <meta name="description" content="Writing on programming, education, books and negotiations.
">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/custom.css">
  <link rel="canonical" href="https://grishaev.me/page48/">
  <link rel="alternate" type="application/rss+xml" title="Ivan Grishaev's blog" href="https://grishaev.me/feed.xml">

  <link rel="shortcut icon" type="image/x-icon" href="/assets/static/favicons/favicon.ico">

  <script type="text/javascript" src="/assets/typo.js"></script>

</head>


  <body>
    <header class="site-header">

    <div class="wrapper flex-container">

        <div>
            <a href="/">
                <img id="avatar" src="/assets/static/avatar.jpg" alt="Ivan Grishaev">
            </a>
        </div>

        <div class="flex-container-vert" style="margin-left: 15px; width: 80%">

            <div class="flex-container full-width">
                <p style="margin-bottom: 5px">Ivan Grishaev's blog</p>
                <div class="flex-huge"></div>
                <div >
<form id="search-form"
      target="_blank"
      style="display: inline"
      method="get"
      action="https://www.google.com/search">

    <input name="sitesearch"
           value="grishaev.me"
           type="hidden">

    <input type="text"
           required="required"
           name="q"
           placeholder="Google search..."
           autocomplete="off">

    <button style="border: none; background-color: transparent; cursor: pointer;"
            type="submit">&#x1f50d;</button>

</form>
</div>
            </div>

            <p><small>Writing on programming, education, books and negotiations.
</small></p>

            <div class="flex-container">
                <a class="menu-item" href="/">Home</a>
                <a class="menu-item" href="/about/">About</a>
                <a class="menu-item" href="/bookshelf/">Bookshelf</a>
                <a class="menu-item" href="/feed.xml">RSS</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor" href="/tag/clojure/">Clojure</a>
                <a class="menu-item minor" href="/tag/emacs/">Emacs</a>
                <a class="menu-item minor" href="/tag/python/">Python</a>
                <a class="menu-item minor" href="/tag/programming/">Programming</a>
                <a class="menu-item minor" href="/interview/">Interview</a>
                <a class="menu-item minor" href="/video/">Video</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor hl" href="/clojure-in-prod/">Книга «Clojure на производстве»</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor hl" href="/clojure-in-prod-2/">Книга «Clojure на производстве», второй том</a>
            </div>

        </div>
    </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="home">

    <ul class="post-list">
        
        <li>

            <h2>
                <a class="post-link" href="/facebook/">Фейсбук прекрасен</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2017-09-01T00:00:00+00:00">
        Sep 1, 2017
    </time>

    <a href="/tag/idiots/" rel="tag">idiots</a>, <a href="/tag/facebook/" rel="tag">facebook</a>

</div>


            <div class="entry">
                
                    <p>Каждый месяц повторяется печальное событие: мне нужно зайти в ФБ и сделать анонс
митапа. Я тяну время, но часа X не избежать.</p>

<p><img src="/assets/static/facebook.png" alt="facebook" /></p>

<p>Даже не знаю, что может быть хуже Фейсбука: столь тормозной и неорганизованный
сайт еще поискать. При том что денег у них до жопы.</p>

<p>Погрязли в жадности и бюрократизме.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/en/clj-sqlite/">In-Memory SQLite Database In Clojure</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2017-08-22T00:00:00+00:00">
        Aug 22, 2017
    </time>

    <a href="/tag/clojure/" rel="tag">clojure</a>, <a href="/tag/sqlite/" rel="tag">sqlite</a>, <a href="/tag/jdbc/" rel="tag">jdbc</a>

</div>


            <div class="entry">
                
                    <p>Recently, I’ve been working with a SQLite database using Clojure. In this post,
I’d like to share my experience that I’ve got from that challenge.</p>

<p>SQLite is a great tool used almost everywhere. Browsers and mobile devices use
it a lot. A SQLite database is represented by a single file that makes it quite
easy to share, backup and distribute. It supports most of the production-level
databases’ features like triggers, recursive queries and so on.</p>

<p>In addition, SQLite has a killer feature to be run completely in memory. So,
instead of keeping an atom of nested maps, why not to store some temporary data
into well organized tables?</p>

<p>JDBC has SQLite support as well, you only need to install a driver, the
documentation says. But then, I’ve got a problem dealing with in-memory
database:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">spec</span><span class="w">
  </span><span class="p">{</span><span class="no">:classname</span><span class="w">   </span><span class="s">"org.sqlite.JDBC"</span><span class="w">
   </span><span class="no">:subprotocol</span><span class="w"> </span><span class="s">"sqlite"</span><span class="w">
   </span><span class="no">:subname</span><span class="w">     </span><span class="s">":memory:"</span><span class="p">})</span><span class="w">

</span><span class="p">(</span><span class="nf">jdbc/execute!</span><span class="w"> </span><span class="n">spec</span><span class="w"> </span><span class="s">"create table users (id integer)"</span><span class="p">)</span><span class="w">
</span><span class="p">(</span><span class="nf">jdbc/query</span><span class="w"> </span><span class="n">spec</span><span class="w"> </span><span class="s">"select * from users"</span><span class="p">)</span><span class="w">

</span><span class="nb">&gt;</span><span class="w"> </span><span class="n">SQLiteException</span><span class="w"> </span><span class="p">[</span><span class="n">SQLITE_ERROR</span><span class="p">]</span><span class="w"> </span><span class="n">SQL</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="nb">or</span><span class="w"> </span><span class="n">missing</span><span class="w"> </span><span class="n">database</span><span class="w">
</span><span class="nb">&gt;</span><span class="w"> </span><span class="p">(</span><span class="nf">no</span><span class="w"> </span><span class="n">such</span><span class="w"> </span><span class="n">table</span><span class="err">:</span><span class="w"> </span><span class="n">users</span><span class="p">)</span><span class="w">  </span><span class="n">org.sqlite.core.DB.newSQLException</span><span class="w"> </span><span class="p">(</span><span class="nf">DB.java</span><span class="no">:909</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>What the… I’ve just created a table, why cannot you find it? An interesting
note, if I set a proper file name for the <code class="language-plaintext highlighter-rouge">:subname</code> field, everything works
fine. But I needed a in-memory database, not a file.</p>

<p>After some hours of googling and reading the code I’ve found the solution.</p>

<p>The thing is, JDBC does not track DB connections by default. Every time you call
for <code class="language-plaintext highlighter-rouge">(jdbc/*)</code> function, you create a new connection, perform an operation and
close it. For such persistent data storages like Postgres or MySQL that’ fine
although not effective (in our project, we use HikariCP to have a pool of open
connections).</p>

<p>But for in-memory SQLite database, closing a connection to it leads to wiping
the data completely out form the RAM. So you need to track the connection in
more precision way. You will create a connection by yourself and close it when
the work is done.</p>

<p>First, let’s setup your project:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">:dependencies</span><span class="w"> </span><span class="p">[</span><span class="n">...</span><span class="w">
               </span><span class="p">[</span><span class="n">org.xerial/sqlite-jdbc</span><span class="w"> </span><span class="s">"3.20.0"</span><span class="p">]</span><span class="w">
               </span><span class="p">[</span><span class="n">org.clojure/java.jdbc</span><span class="w"> </span><span class="s">"0.7.0"</span><span class="p">]</span><span class="w">
               </span><span class="p">[</span><span class="n">com.layerware/hugsql</span><span class="w"> </span><span class="s">"0.4.7"</span><span class="p">]</span><span class="w">
               </span><span class="p">[</span><span class="n">mount</span><span class="w"> </span><span class="s">"0.1.11"</span><span class="p">]</span><span class="w">
               </span><span class="n">...</span><span class="p">]</span><span class="w">
</span></code></pre></div></div>

<p>and the database module:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">ns</span><span class="w"> </span><span class="n">project.db</span><span class="w">
  </span><span class="p">(</span><span class="no">:require</span><span class="w"> </span><span class="p">[</span><span class="n">mount.core</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">mount</span><span class="p">]</span><span class="w">
            </span><span class="p">[</span><span class="n">hugsql.core</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">hugsql</span><span class="p">]</span><span class="w">
            </span><span class="p">[</span><span class="n">clojure.java.jdbc</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">jdbc</span><span class="p">]))</span><span class="w">
</span></code></pre></div></div>

<p>Declare a database URI as follows:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">db-uri</span><span class="w"> </span><span class="s">"jdbc:sqlite::memory:"</span><span class="w">
</span></code></pre></div></div>

<p>Our database shares two states: when it’s been set up and ready to work and when
it has not. To keep the state, let’s use <code class="language-plaintext highlighter-rouge">mount</code> library:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">declare</span><span class="w"> </span><span class="n">db</span><span class="p">)</span><span class="w">

</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">on-start</span><span class="w"> </span><span class="p">[]</span><span class="w">
  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">spec</span><span class="w"> </span><span class="p">{</span><span class="no">:connection-uri</span><span class="w"> </span><span class="n">db-uri</span><span class="p">}</span><span class="w">
        </span><span class="n">conn</span><span class="w"> </span><span class="p">(</span><span class="nf">jdbc/get-connection</span><span class="w"> </span><span class="n">spec</span><span class="p">)]</span><span class="w">
    </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">spec</span><span class="w"> </span><span class="no">:connection</span><span class="w"> </span><span class="n">conn</span><span class="p">)))</span><span class="w">

</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">on-stop</span><span class="w"> </span><span class="p">[]</span><span class="w">
  </span><span class="p">(</span><span class="nb">-&gt;</span><span class="w"> </span><span class="n">db</span><span class="w"> </span><span class="no">:connection</span><span class="w"> </span><span class="n">.close</span><span class="p">)</span><span class="w">
  </span><span class="n">nil</span><span class="p">)</span><span class="w">

</span><span class="p">(</span><span class="nf">mount/defstate</span><span class="w">
  </span><span class="o">^</span><span class="p">{</span><span class="no">:on-reload</span><span class="w"> </span><span class="no">:noop</span><span class="p">}</span><span class="w">
  </span><span class="n">db</span><span class="w">
  </span><span class="no">:start</span><span class="w"> </span><span class="p">(</span><span class="nf">on-start</span><span class="p">)</span><span class="w">
  </span><span class="no">:stop</span><span class="w"> </span><span class="p">(</span><span class="nf">on-stop</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<p>Once you call <code class="language-plaintext highlighter-rouge">(mount/start #'db)</code>, it becomes a map with the following fields:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="no">:connection-uri</span><span class="w"> </span><span class="s">"jdbc:sqlite::memory:"</span><span class="w">
 </span><span class="no">:connection</span><span class="w"> </span><span class="n">&lt;SomeJavaConnectionObject</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="mi">0</span><span class="n">x0...&gt;</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>When any JDBC function or a method accepts that map, it checks for the
<code class="language-plaintext highlighter-rouge">:connection</code> field. If it’s filled, JDBC uses that connection as well. If it’s
not, a new connection is issued. In my case, every execute/query call created a
new in-memory database and stopped it right after the call ends. That’s why the
second query could not to find <code class="language-plaintext highlighter-rouge">users</code> table: because it was performed within
another database.</p>

<p>Now with the <code class="language-plaintext highlighter-rouge">db</code> started, you are welcome to perform all the standard <code class="language-plaintext highlighter-rouge">jdbc</code>
operations:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">jdbc/execute!</span><span class="w"> </span><span class="n">db</span><span class="w"> </span><span class="s">"create table users (id integer, name text)"</span><span class="p">)</span><span class="w">
</span><span class="p">(</span><span class="nf">jdbc/insert!</span><span class="w"> </span><span class="n">db</span><span class="w"> </span><span class="no">:users</span><span class="w"> </span><span class="p">{</span><span class="no">:id</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="no">:name</span><span class="w"> </span><span class="s">"Ivan"</span><span class="p">})</span><span class="w">
</span><span class="p">(</span><span class="nf">jdbc/get-by-id</span><span class="w"> </span><span class="n">db</span><span class="w"> </span><span class="no">:users</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="c1">;; {:id 1 :name "Ivan"}</span><span class="w">
</span><span class="p">(</span><span class="nf">jdbc/find-by-keys</span><span class="w"> </span><span class="n">db</span><span class="w"> </span><span class="no">:users</span><span class="w"> </span><span class="p">{</span><span class="no">:name</span><span class="w"> </span><span class="s">"Ivan"</span><span class="p">})</span><span class="w"> </span><span class="c1">;; ({:id 1 :name "Ivan"})</span><span class="w">
</span></code></pre></div></div>

<p>Finally, you stop the db calling <code class="language-plaintext highlighter-rouge">(mount/stop #'db)</code>. The connection stops, the
data disappears completely.</p>

<p>For more complicated queries with joins, HugSQL library would be a good
choice. Create a file <code class="language-plaintext highlighter-rouge">queries.sql</code> in your <code class="language-plaintext highlighter-rouge">resources</code> folder. Say, you want to
write a complex query that filters a result by some values that probably are not
set. Here is an example of what you should put into <code class="language-plaintext highlighter-rouge">queries.sql</code> file:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- :name get-user-visits :?</span>
<span class="k">select</span>
    <span class="n">v</span><span class="p">.</span><span class="n">mark</span><span class="p">,</span>
    <span class="n">v</span><span class="p">.</span><span class="n">visited_at</span><span class="p">,</span>
    <span class="n">l</span><span class="p">.</span><span class="n">place</span>
<span class="k">from</span> <span class="n">visits</span> <span class="n">v</span>
<span class="k">join</span> <span class="n">locations</span> <span class="n">l</span> <span class="k">on</span> <span class="n">v</span><span class="p">.</span><span class="k">location</span> <span class="o">=</span> <span class="n">l</span><span class="p">.</span><span class="n">id</span>
<span class="k">where</span>
    <span class="n">v</span><span class="p">.</span><span class="k">user</span> <span class="o">=</span> <span class="p">:</span><span class="n">user_id</span>
    <span class="cm">/*~ (when (:fromDate params) */</span>
    <span class="k">and</span> <span class="n">v</span><span class="p">.</span><span class="n">visited_at</span> <span class="o">&gt;</span> <span class="p">:</span><span class="n">fromDate</span>
    <span class="cm">/*~ ) ~*/</span>
    <span class="cm">/*~ (when (:toDate params) */</span>
    <span class="k">and</span> <span class="n">v</span><span class="p">.</span><span class="n">visited_at</span> <span class="o">&lt;</span> <span class="p">:</span><span class="n">toDate</span>
    <span class="cm">/*~ ) ~*/</span>
    <span class="cm">/*~ (when (:toDistance params) */</span>
    <span class="k">and</span> <span class="n">l</span><span class="p">.</span><span class="n">distance</span> <span class="o">&lt;</span> <span class="p">:</span><span class="n">toDistance</span>
    <span class="cm">/*~ ) ~*/</span>
    <span class="cm">/*~ (when (:country params) */</span>
    <span class="k">and</span> <span class="n">l</span><span class="p">.</span><span class="n">country</span> <span class="o">=</span> <span class="p">:</span><span class="n">country</span>
    <span class="cm">/*~ ) ~*/</span>
<span class="k">order</span> <span class="k">by</span>
    <span class="n">v</span><span class="p">.</span><span class="n">visited_at</span><span class="p">;</span>
</code></pre></div></div>

<p>In your database module, put the following on the top level:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">hugsql/def-db-fns</span><span class="w"> </span><span class="s">"queries.sql"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>Now, every SQL template has become a plain Clojure function that takes a
database and a map of additional parameters. To get all the visits in our
application, we do:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">get-user-visits</span><span class="w"> </span><span class="n">db</span><span class="w"> </span><span class="p">{</span><span class="no">:user_id</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="no">:fromDate</span><span class="w"> </span><span class="mi">123456789</span><span class="w"> </span><span class="no">:country</span><span class="w"> </span><span class="s">"SomePlace"</span><span class="p">})</span><span class="w">
</span><span class="nb">&gt;</span><span class="w"> </span><span class="n">...gives</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="nb">seq</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">maps...</span><span class="w">
</span></code></pre></div></div>

<p>Hope this article will help those who’ve got stuck with SQLite.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/5years/">Пять лет блогу</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2017-08-21T00:00:00+00:00">
        Aug 21, 2017
    </time>

    <a href="/tag/blog/" rel="tag">blog</a>

</div>


            <div class="entry">
                
                    
<p>То, что я давненько ничего не писал, связано с тем, что залип в
конкурсе <a href="https://highloadcup.ru/">Highload Cup</a>. Две недели ни о чем другом думать не мог, все
пытался улучшить решение. И тут вспомнил, что у блога юбилей: первая запись была
сделана пять лет назад, 8 августа 2012 года.</p>

<p>Речь идет о наивной заметке под названием <a href="http://grishaev.me/2012/08/08/1/">“Рассылка смс в Питоне”</a>. Там я
популярно рассказываю, как слать смс через апишку уже несуществующего сервиса. В
те дни я работал в читинском Энергосбыте, писал на 1С, Дельфях и Питоне, а лиспы
и ФП были влажными мечтами.</p>

<p>Пять лет по меркам интернета все-таки срок. Много ребят, которых я читал, со
временем забили на блоги, не продлили домены. А мне нравится: блог стал
настоящим хобби, которое, надеюсь, продлится всю жизнь.</p>

<p>За прошедшее время я написал 320 постов. Не так много, но я не гонюсь за
количеством. Некоторые заметки, первоначально задуманные как пара абацев,
разрастались до нескольких экранов.</p>

<p>В один момент я поймал себя на мысли, что злоупотребляю низкими приемами:
жалуюсь на сервисы, высмеиваю тех, кто не согласен со мной. Это работает, но не
в том направлении, в котором бы мне хотелось. Теперь стараюсь писать только на
важные темы: программирование, образование, карьера, книги.</p>

<p>Было неприятно видеть, как любимые мной блоги вырождались в комментарии
политических новостей. Эту тему я тоже решил пресечь.</p>

<p>Решил двигаться в сторону англоязычной аудитории. В России на Кложе пишут три с
половиной анонимуса, поэтому нет смысла писать о ней на русском.</p>

<p>Технические заметки на английском порой дают сильный отклик. После
публикации статьи о миграции с Постргреса на Датомик в первый же день ко мне
зашли 9000 янглоязычных посетителей.</p>

<p>После нескольких удачных статей про Кложу меня добавили в агрегатор Планета
Кложи. Если в посте будет слово “Кложа” на английском, статья попадет в
агрегатор. Поэтому если я не хочу, чтобы такое случилось, пишу на русском.</p>

<p>В планах сделать на сайте теги, рубрикацию и прочие ништяки. Благо, блог
статичный на Руби-движке, исходники на Гитхабе, и я знаю, у кого можно
накопипастить. А пока вот просто список постов, заслуживающих внимания:</p>

<ul>
  <li><a href="/en/concept">Conceptual languages</a></li>
  <li><a href="/en/edu-startups">Educational startups</a></li>
  <li><a href="/en/pg-to-datomic">Migration from Postgres to Datomic</a></li>
  <li><a href="/en/dos-and-donts">Do’s and Don’ts</a></li>
  <li><a href="/en/english">English</a></li>
  <li><a href="/en/russian-communities">Thoughts on Russian-speaking communities</a></li>
  <li><a href="/cors">Руководство по кросс-доменным запросам (CORS)</a></li>
  <li><a href="/remote">Про удаленную работу</a></li>
  <li><a href="/emacs-story">Рассказ о Емаксе</a></li>
</ul>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/en/concept/">Conceptual languages</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2017-08-03T00:00:00+00:00">
        Aug 3, 2017
    </time>

    <a href="/tag/clojure/" rel="tag">clojure</a>, <a href="/tag/lisp/" rel="tag">lisp</a>, <a href="/tag/erlang/" rel="tag">erlang</a>, <a href="/tag/concept/" rel="tag">concept</a>

</div>


            <div class="entry">
                
                    <p>This is a short note on what I’m thinking about programming languages.</p>

<p>Briefly, I reckon some languages as being conceptual. In a conceptual language,
every part of it obeys some global idea. This idea forms design of a language,
the way it behaves and develops. If affects libraries, community and ecosystem.</p>

<p>Take Lisp, for example. The idea is, when we store our code as data, it brings
incredible possibilities to process code as data or turn the data into code. No
other language may offer something like that, only Lisp does.</p>

<p>In Erlang, every task is solved within a cascade of lightweight processes named
actors. Two actors may communicate directly being run on different
servers. Actors do not create Unix threads. They are managed by OTP rather than
operation system.</p>

<p>With Haskell, you’ve got quite strong and flexible type system. Types are the
most important part of a typical Haskell program. Once it compiles, it will work
for sure.</p>

<p>Clojure, a modern Lisp dialect, provides immutable data structures and powerful
abstractions for concurrency.</p>

<p>Respectively, non-conceptual languages do not have such a global approach. They
try to implement as many features as possible to satisfy every domain: OOP,
anonymous functions (lambdas), lazy evaluation, etc. As a result, we’ve got
everything but nothing: each part of such a language is not as powerful as its
analogies form those ones I mentioned above.</p>

<p>Take Python, for example. Although it has such basic functional blocks as map,
reduce and lambdas, programming with it in a functional way would be a mess.</p>

<p>Every part of classical Javascript is just ugly.</p>

<p>Java, a language with static type system, allows you to pass Null instead of any
object and end up with NPE exception.</p>

<p>Although conceptual languages are not perfect, they seem to be easier for me to
learn because they have some common rules that could not be broken. Say, in
Haskell, you just do not have plain Null value. In Clojure, you cannot modify a
dictionary, and so on.</p>

<p>They cannot be substituted with other languages. Really, how can you substitute
Lisp or Erlang? There aren’t any alternatives for them.</p>

<p>I believe, the future is about conceptual languages. To develop AI or
distributed systems, we need something more sensible than yet another language
with classes and syntactic sugar.</p>

<p>I’m not sure it could be Lisp, but something that borrows most of its features.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/en/read-28/">Weekly links #28</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2017-07-31T00:00:00+00:00">
        Jul 31, 2017
    </time>

    <a href="/tag/read/" rel="tag">read</a>, <a href="/tag/life/" rel="tag">life</a>

</div>


            <div class="entry">
                
                    
<ul>
  <li>
    <p><a href="https://medium.freecodecamp.org/rest-apis-are-rest-in-peace-apis-long-live-graphql-d412e559d8e4">REST APIs are REST-in-Peace APIs. Long Live GraphQL.</a></p>

    <p>Well, although the title is provoking a bit, the main idea is true. We really
need something more suitable than REST. It has been great for the last decade,
but now it’s time to move on.</p>
  </li>
  <li>
    <p><a href="http://blog.korny.info/2014/03/08/xml-for-fun-and-profit.html">XML manipulation in Clojure</a></p>

    <p>Great article on XML, trees and zippers in Clojure. For a long time, I was
considering parsing XML as a sort of black magic. With Clojure, the process is
transparent and easy to understand.</p>
  </li>
  <li>
    <p><a href="https://www.scientificamerican.com/article/students-are-better-off-without-a-laptop-in-the-classroom/">Students are Better Off without a Laptop in the Classroom</a></p>

    <p>Thoughts on using laptops by students in a classroom. Again, the profit of IT
industry and “smart” devices is overestimated. As
I <a href="/en/edu-startups">mentioned it earlier</a>, books and people are the only way
to learn effectively.</p>
  </li>
  <li>
    <p><a href="http://martintrojer.github.io/beyond-clojure/2016/04/21/beyond-clojure-haskell">Beyond Clojure: Haskell</a></p>

    <p>Comparing Haskell to Clojure: syntax, types, code snippets, etc.</p>
  </li>
</ul>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/en/read-27/">Weekly links #27</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2017-07-23T00:00:00+00:00">
        Jul 23, 2017
    </time>

    <a href="/tag/read/" rel="tag">read</a>, <a href="/tag/life/" rel="tag">life</a>

</div>


            <div class="entry">
                
                    
<p>I’ve just returned from <a href="http://2017.euroclojure.org/">EuroClojure</a>, it was amazing! Thank you everybody
who brought it to us.</p>

<p>Here are some interesting links I found on Medium:</p>

<ul>
  <li>
    <p><a href="https://medium.com/ai-society/the-lisp-approach-to-ai-part-1-a48c7385a913">The Lisp approach to AI (Part 1)</a></p>

    <p>Some thoughts on role of Lisp in discovering AI systems.</p>
  </li>
  <li>
    <p><a href="https://m.signalvnoise.com/avoiding-not-solving-a1b37e46baaf">Show me a business problem and I’ll do my best to avoid it</a></p>

    <p>Jason Fried, a founder of Basecamp, shares his notes on dealing with problems.</p>
  </li>
  <li>
    <p><a href="https://notamonadtutorial.com/a-pythonist-finds-a-new-home-at-clojure-land-761ad8612b47">A Pythonist finds a new home at Clojure land</a></p>

    <p>The title shares the idea as well.</p>
  </li>
  <li>
    <p><a href="https://m.oursky.com/why-i-chose-clojure-over-javascript-24f045daab7e">Why I chose ClojureScript over JavaScript</a></p>

    <p>So do I.</p>
  </li>
</ul>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/berlin/">Берлин. Городские детали</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2017-07-23T00:00:00+00:00">
        Jul 23, 2017
    </time>

    <a href="/tag/berlin/" rel="tag">berlin</a>, <a href="/tag/city/" rel="tag">city</a>

</div>


            <div class="entry">
                
                    <p>Побывал на Евро-Кложе в Берлине и хочу рассказать про город. Я не ахти какой
путешественник: езжу мало, не особо наблюдателен. Читая Лебедева или Варламова,
я долгое время не понимал, зачем они без конца пишут про урны и
тротуары. Подумаешь, плитка лучше – и у нас можно пройти!</p>

<p>А в этот раз меня проперло на городскую среду. Гулял по городу и офигевал с
того, как классно устроен город. Еще больше я недоумевал, как раньше не понимал
разницы между плохой городской средой и хорошей. Видимо, после тридцати все-таки
проснулась черточка.</p>

<p>Прежде всего, великолепно уложены тротуары. Это может быть плитка, массивные
плиты, булыжник или мелкие камешки, но идти по ним и любоваться паттерном можно
бесконечно. Все детали пригнаны как в лего, все по паттерну. Когда плитка не
квадратная (или если ее кладут под углом), крайние плитки не режут, а
изготавливают специальной формы, чтобы стыковаться с соседними поверхностями.</p>

<p><img src="/assets/static/berlin/IMG_3292_2.JPG" alt="" /></p>

<p>Далее, нигде нет открытой земли. О вреде открытых клумб те же Варламов с
Лебедевым писали сто раз. Любой клочок земли, необходимый растениям, во-первых,
утоплен ниже уровня тротуара, а во-вторых, накрыт сеткой или замурован
галькой. У нас же с тротуаров и клумб круглый год сыпется грязь и песок, а
дворники соскребают обратно на клумбу.</p>

<p><img src="/assets/static/berlin/IMG_3320.JPG" alt="" /></p>

<p>Шокировало, что нет борюров. Тротуар полностью бесшовный. Меняется размер и
паттерн плитки, булыжник чередуется с плитами, но уровень нигде не
перепадает. На дорожных переходах, в выездах с прилегающих территорий, рядом с
подъездами, словом – нет бордюров. Я прошел в одном направлении восемь
кварталов и не встретил ни одного на пути.</p>

<p><img src="/assets/static/berlin/IMG_3283_2.JPG" alt="" /></p>

<p>Все дома вровень с землей. Я не знаю, в чем загадка, но в России не бывает
дверей без крыльца. Вход в любой магазин, офис или подъезд начинается со
ступеней. А рядом пандус с углом в 60 градусов. Почему нельзя вырыть котлован
еще на метр глубже? В каких стандартах прописано, что дверь должна быть в метре
от земли?</p>

<p>Это бизнес-центр:</p>

<p><img src="/assets/static/berlin/IMG_3317.JPG" alt="" /></p>

<p>А это жилой подъезд:</p>

<p><img src="/assets/static/berlin/IMG_3306.JPG" alt="" /></p>

<p>Если не ясно, в чем вред от бордюров, одолжите инвалидную коляску. Сядьте в нее
дома и попробуйте добраться до магазина. Или в обычную коляску уложите ребенка,
в нижнюю корзину продукты и вперед через подземный переход, я на вас посмотрю.</p>

<p>На фотографии ниже видно, что порой действительно случается перепад между
тротуаром и зданием. Но оцените, как плавно сделали переход! Высота в 20
сантиметров приходится на длину в 15 метров, угол градусов пять. И как красиво
получилось.</p>

<p><img src="/assets/static/berlin/IMG_3318.JPG" alt="" /></p>

<p>Это тот случай, когда инвалид <em>действительно</em> сможет заехать на коляске, а
человек с больным сердцем – подняться без учащения пульса.</p>

<p>Теперь урны. То ли меня Лебедев укусил, то ли что, но в каждой урне кроется сто
важных мелочей, теперь я это понял. В районе, где я жил, урны одинаковы, имеют
те же габариты и цвет. Срабатывает визуальное распознавание: чтобы найти урну,
достаточно окинуть взором пространство, и где-то обязательно мелькнет оранжевое
пятно. В каждой точке видна хотя бы одна урна. Ни разу не было так, чтобы мне
понадобилось, а вокруг нет.</p>

<p>Далее, урна не стоит на земле, а закреплена на столбе на уровне метра. Это
позволит увидеть урону на большом расстоянии или в толпе. Отверстие не как у
ведра, а меньше и под углом. Здесь тоже умыслел: в такое отверстие не затечет
дождь, невозможно заткнуть урну пакетом мусора, как у нас порой делают ленивые
уроды.</p>

<p><img src="/assets/static/berlin/IMG_3315.JPG" alt="" /></p>

<p>В такую урну невозможно что-то кидать, нужно подойти и положить. Это резко
снижает желание швырять окурки или бутылки ради понтов. У нас же как: офисный
планктон курит на высоком крыльце, где-то внизу ведро. Каждый бросает окурок,
это такой вид спорта. Вокруг урны Хи-квадрат-распределение бычков и плевков.</p>

<p>А попробуй кинь, когда урна на уровне груди. Можно попасть в кого-то и нарваться
на неприятности.</p>

<p>Урны очень аккуратны и чисты, покрашены в оранжевый. В первый раз я принял их за
почтовые ящики. Урны никогда не стоят рядом с лавочками, их всегда отделяет
метров десять минимум. Пример с автобусной остановкой:</p>

<p><img src="/assets/static/berlin/IMG_3319.JPG" alt="" /></p>

<p>Странные люди эти немцы, почему не хотят сидеть рядом с урной, как принято у
нас? Чтобы справа девушка, а слева мусорное ведро. Удобно же, все рядом.</p>

<p>В середине дорожных переходов островки безопасности, где пешеход может переждать
красный сигнал не рискуя быть сбитым. Островки огорожены бордюрами. Тот редкий
случай, когда они действительно нужны.</p>

<p><img src="/assets/static/berlin/IMG_3321.JPG" alt="" /></p>

<p>Люки преимущественно квадратные. Ливневые решетки спроектированы так, чтобы туда
не попало колесо велика или коляски. Направление щелей для воды перпендикулярно
движению на этом участке. Если место проходное, делают просто круглые дыры.</p>

<p><img src="/assets/static/berlin/IMG_3316.JPG" alt="" /></p>

<p>Везде велодорожки и велопарковки, на великах ездят от мала до велика, даже
беременные и пенсионеры. У меня нет статистики, но полагаю, это резко снижает
дорожный трафик. К примеру, на небольшом пятачке возле магазина припарковано 15
велосипедов. Теперь представим, что каждый приехал на машине. Сколько места
понадобиться? В десять раз больше, плюс трафик.</p>

<p>Дорожные пробки смехотворны по сравнению с нашими. 26 километров по городу от
центра до аэропорта – свободно, остановки только на светофорах. В будни после
обеда, Карл.</p>

<p>Многие женщины ходят без лифчика. Не поголовно, конечно, но больше, чем у
нас. Часто видно татуировки. Это не фрики с пирсингом, просто небольшие узоры
или надписи. Наряжаются кто как хочет, порой провакационно, всем пофиг.</p>

<p>И это я только про урны и про тратуары. А еще же парки, скверы, дворы и миллион
других вещей. Можно днями гулять и выпитывать. В плане городской среды Берлин на
высоте.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/en/edu-startups/">Educational startups</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2017-07-11T00:00:00+00:00">
        Jul 11, 2017
    </time>

    <a href="/tag/education/" rel="tag">education</a>, <a href="/tag/startups/" rel="tag">startups</a>

</div>


            <div class="entry">
                
                    <p>Today, educational startups are everywhere. The number of them is growing
daily. There hardly might be a week when no new HTML/CSS/Javascript educational
site appears on the Internet.</p>

<p>Sorry if I offend someone, but I don’t believe in remote education through
special sites that offer video lessons. More precisely, there might be some
effect of course but quite poorer than standard education with people and books.</p>

<p>About ten years ago, the Internet was full of paid video courses on DVDs. These
were home-made lessons made by students where they spoke on basics of
PHP+HTML. Today, the startups remind me those DVDs. The only difference is you
do not need to order a disk anymore but watch lessons online right after you
have paid.</p>

<p>I’m not running an educational site. I also don’t want to reduce someone’s
reputation or business. Let’s just discuss some points that seem important to
me.</p>

<p>Let’s switch to a browser right now and google for “educational startup”
phrase. For me, the first link
is <a href="https://www.forbes.com/sites/rodberger/2017/01/19/are-education-start-ups-the-new-dot-com/#35bdf8f01029">“Are Education Startups The New Dot Com?”</a> In that article,
there is another link titled <a href="https://techcrunch.com/2016/08/13/edtech-is-the-next-fintech/">“Edtech Is The Next Fintech”</a>. Read them,
they highlight my concerns.</p>

<p>Below, there is a bunch of list-like posts titled “N best educational startups”:</p>

<ul>
  <li><a href="https://www.inc.com/ilan-mochari/16-startups-that-will-disrupt-the-education-market.html">16 Startups Poised to Disrupt the Education Market</a></li>
  <li><a href="https://yourstory.com/2016/07/edtech-startup-competition-startedu-finalists/">10 emerging edtech startups of India - YourStory.com</a></li>
  <li><a href="www.iamwire.com/2017/01/10-indian-education-startups-2017/148036">10 Indian Education Startups to Look Out for in 2017</a></li>
  <li><a href="https://www.goodcall.com/news/techcrunch-disrupt-2016-7-edtech-startups-changing-education-industry-06688">TechCrunch Disrupt 2016 - 7 EdTech Startups</a></li>
  <li><a href="https://www.techinasia.com/26-edtech-startups-southeast-asia">29 edtech startups in Southeast Asia</a></li>
</ul>

<p>And so on. It was only the two first pages. Let’s check
for <a href="https://angel.co/education">Angel List</a> then:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>14,615 COMPANIES    2,646 INVESTORS    19,127 FOLLOWERS    2,675 JOBS
</code></pre></div></div>

<p>14615 companies. There are about 250 countries in the world. I’ll take rather
200 due to wars or lack of development in some of them. Dividing a number of
educational startups on the number of counties gives 14615 / 200 = 73 per
country.</p>

<p>Don’t you think it’s bit more than we need?</p>

<p>Look, we have about 3 search engines to find anything on the Internet. There are
probably 2-5 mobile operators in your country. We’ve got one Wikipedia. But
there are 14615 educational companies who want to make money on educational
market.</p>

<h1 id="i-really-doubt-they-are-about-real-education">I really doubt they are about real education</h1>

<p>In fact, there is one goal that a startup tries to reach. It forces users to buy
lessons making them think it could really raise their level. Site developers
bring challenging factors to manipulate users. These are top-ranked tables, a
scale of education decorated as a route with milestones and a crown or a goblet
in the end. Any startup brings a chat-room to let users share their success to
feel proud.</p>

<p>I’ve seen several educational sites and must confess they don’t bring any
revolutionary ideas. Yes, some of them provide smart environment when you have
an IDE into a browser. But the truth is there are only two ways of education
that really work. These are people and books.</p>

<p>Sometimes, people ask me how to improve their experience. Usually they’ve spent
some time solving educational tasks but they cannot start a real project. I
always answer the same: join a project where professionals work. Being in a team
of high-qualified people, you will grow up in a quite short term.</p>

<p>Reading books helps you to systematize fragments of random knowledge that you’ve
got from Twitter, StakOverflow, Wired and so on. Everything that educational
sites try to sell you has already been published in books. Really, there are
tons of books about PHP, HTML, Java, Python or whatever. You may borrow them for
free.</p>

<p>On the internet, you can by any used book for several dollars. A lesson is
usually paid for subscription. In a month, you will lose your access unless you
pay again. The book will be yours forever.</p>

<p>Yes, reading a book is a bit more difficult than watching a video. It’s hard and
boring. You even need to interpret code in mind. There is no widgets and chats.
Although, it really works.</p>

<p>A book is really important today since our knowledge is not arranged. We are
getting random fragments missing important details. I may compare a book with an
asphalt paver that moves slowly but removes any roughness and holes in your
mind.</p>

<h1 id="people-and-books-are-the-only-way-to-learn">People and books are the only way to learn</h1>

<p>Recently, I finished reading <a href="https://pragprog.com/book/dswdcloj2/web-development-with-clojure-second-edition">“Web-development with Clojure”</a>
book. Although I thought I knew Clojure pretty well, the book turned into
discovery for me. I’ve got plenty of hints and technics that I’m willing to try
in the future.</p>

<p>Education in wide meaning is hard process. Educational startups make you think
it has become easy. That is wrong.</p>

<p>Once I finished reading my first Clojure book, I could solve any primitive task
like sorting or finding min/max element in a list using recursion. But it took
huge effort to write an HTTP server that manages database connection, renders
templates, writes logs, calls Twitter API and so on.</p>

<p>The reason was all the lessons and tutorials miss some special knowledge about
how to manage with complexity. Hot to connect parts of your application
together.</p>

<p>A computer is not a best tool for education. It’s a great tool but also an
entertainment center. Ideally, you should turn off all the messagers, close
YouTube, Twitter… On your laptop, there a lot of things may interrupt
you. Being tired, your brain can always find a pretext to switch on something
funny.</p>

<p>IT-education is not about coding, it also includes negotiations. Sometimes, you
might be 100% right but would not be able to deliver your ideas. You may offend
your customer with non-suitable manner of speaking. Only people who work close
to you may correct that mistakes, not online lessons. By the way, I have never
seen a lesson that highlights anything from those mentioned above.</p>

<p>Of course, I do not blame startups for spreading across the Internet. The reason
it happens is a lack of professionals. This is reaction of market. Did you want
more programmers? Here you’ve got them. Young people know that IT companies are
interested in hiring more people. Oftenly, watching just several videos enough
to get PHP/Wordpress job paid in US dollars.</p>

<p>Universities are not in charge of your further employment. There is a common
situation when you’ve just finished the last course but cannot find a job
because the industry changes so fast. Nor the government will support
you. Education seems to be the last thing they are interested in. Today, my
country wages two wars, plays geopolitics and eradicates imported cheese while
education level goes down-wise year after year.</p>

<p>Educational sites might be a hope. But they devalue the real meaning of
education.</p>

<h1 id="the-process-of-self-education-is-hard-only-you-is-interested-in-it-not-startups">The process of self-education is hard. Only you is interested in it, not startups</h1>

<p>OK I’m about to finish and I’ve got a question. I heard, the most powerful
language is Lisp. At least Alan Kay said so (a guy who invented OOP). So did
Stallman, Dijkstra and other great programmers. Do you know any educational site
which offers Lisp lessons?</p>

<p>I googled for a bit to find any. Nothing on Coursera – the most known lesson
hub. Nothing on Netology. At least Hexlet has <a href="https://ru.hexlet.io/courses/sicp">SICP section</a> where they
retell it in Russian (see my note on books).</p>

<p>No, they won’t teach you the most powerful language. So what is the final goal
then?  Do we need more Python or Java programmers? We have already got lots of
them but we still suffer from weird interfaces and buggy applications. It won’t
work in such a way.</p>

<p>Let me summarize.</p>

<ol>
  <li>I’m not against someone’s business. I even believe some people who watched
those videos really made progress in their career. Maybe, they could not find
proper books or their brain feels good with such a way of education.</li>
  <li>But I’d like to name things properly. Educational startups are the business
by themselves. The goal of the business is to make money but not to make you
cleverer. Instead, the longer you keep your monthly subscription active, the
better a startup develops.</li>
  <li>There is definitely overheat on the educational market. It seems to be like a
bubble.</li>
  <li>Startups tell you the education is easy and funny. It’s not.</li>
  <li>People and books help a lot. Online lessons – well, yes but quite less.</li>
</ol>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/en/read-26/">Weekly links #26</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2017-07-10T00:00:00+00:00">
        Jul 10, 2017
    </time>

    <a href="/tag/read/" rel="tag">read</a>, <a href="/tag/life/" rel="tag">life</a>

</div>


            <div class="entry">
                
                    <ul>
  <li>
    <p><a href="https://juxt.pro/blog/posts/clojure-job-market.html">The Clojure Job Market</a></p>

    <p>Good news for those who are afraid of being not employed with Clojure.</p>
  </li>
  <li>
    <p><a href="https://juxt.pro/blog/posts/clojure-in-health-unlocked.html">Clojure In London: Healthunlocked</a></p>

    <blockquote>
      <p>Originally HealthUnlocked was built on top of .NET, but over the last few
years they have migrated to a Microservice based architecture featuring
Clojure.</p>
    </blockquote>
  </li>
  <li>
    <p><a href="https://news.ycombinator.com/item?id=14714696">Postgres to Datomic on Hacker News</a></p>

    <p>Nice comments there. By the way, thank you everybody who has read
my <a href="/en/pg-to-datomic">previous post</a>.</p>
  </li>
  <li>
    <p><a href="http://www.timesofisrael.com/russian-internet-pioneer-anton-nosik-dies-at-51/">Russian Internet Pioneer Anton Nosik Dies At 51</a></p>

    <p>Goodbye Anton and thank you. Your contribution is invaluable.</p>
  </li>
</ul>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/en/pg-to-datomic/">Migration from Postgres to Datomic</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2017-07-04T00:00:00+00:00">
        Jul 4, 2017
    </time>

    <a href="/tag/clojure/" rel="tag">clojure</a>, <a href="/tag/migration/" rel="tag">migration</a>, <a href="/tag/postgres/" rel="tag">postgres</a>, <a href="/tag/datomic/" rel="tag">datomic</a>, <a href="/tag/database/" rel="tag">database</a>

</div>


            <div class="entry">
                
                    
<p>Recently, I migrated my Clojure-driven pet project from PostgreSQL to
Datomic. This is <a href="https://queryfeed.net/">Queryfeed</a>, a web application to fetch data from
social networks. I’ve been running it for several years considering it as a
playground for some experiments. Long ago, it was written in Python, then I
ported it to Clojure.</p>

<p>It was a great experience when I just finished
reading <a href="http://www.braveclojure.com/">“Clojure for True and Brave”</a> book and was full of
desire to apply new knowledge to something practical rather than
solving <a href="https://projecteuler.net/">Euler problems</a> in vain.</p>

<p>This time, I’ve made another effort to switch the database backend to
Datomic. Datomic is a modern, fact-driven database developed
in <a href="https://cognitect.com">Cognitect</a> to be used in conjunction with Clojure. It really
differs for classical RDBS such as MySQL or PostgreSQL. For a long time, I’ve
been thinking whether I should try it. Meanwhile, more and more Clojure/conj
talks have been publishing on <a href="https://www.youtube.com/user/ClojureTV">YouTube</a>. At my work, we use vast
PostgreSQL database and the code base is tied to close to it. There is no an
option to perform a switch on weekends. So I decided to port my pet project to
Datomic in my spare time.</p>

<p>Surely, before doing this, I googled for a while and was really wondered about
how few information I found on the Internet. There were just three posts that
did not cover the subject in details. So I decided to share my experience
here. Maybe it would help somebody with their migration duties.</p>

<p>Of cause, I cannot guarantee the steps described below will meet your
requirements as well. Each database is different, so it’s impossible to develop
a final tool that could handle all the cases. But at least you may borrow some
of those.</p>

<h2>

    Table of Contents

</h2>

<ul id="toc-item-pg-to-datomic">
  <li><a href="#introduction" id="toc-item-pg-to-datomic-introduction">Introduction</a></li>
  <li><a href="#dump-postgres-database" id="toc-item-pg-to-datomic-dump-postgres-database">Dump Postgres database</a></li>
  <li><a href="#adding-datomic-into-your-project" id="toc-item-pg-to-datomic-adding-datomic-into-your-project">Adding Datomic into your project</a></li>
  <li><a href="#loading-the-data-into-datomic" id="toc-item-pg-to-datomic-loading-the-data-into-datomic">Loading the data into Datomic</a>    <ul>
      <li><a href="#avoid-nils" id="toc-item-pg-to-datomic-avoid-nils">Avoid nils</a></li>
      <li><a href="#shrink-your-tables" id="toc-item-pg-to-datomic-shrink-your-tables">Shrink your tables</a></li>
      <li><a href="#use-enums" id="toc-item-pg-to-datomic-use-enums">Use enums</a></li>
      <li><a href="#json-data" id="toc-item-pg-to-datomic-json-data">JSON data</a></li>
      <li><a href="#foreign-keys" id="toc-item-pg-to-datomic-foreign-keys">Foreign keys</a></li>
    </ul>
  </li>
  <li><a href="#update-the-code" id="toc-item-pg-to-datomic-update-the-code">Update the code</a></li>
  <li><a href="#html-templates" id="toc-item-pg-to-datomic-html-templates">HTML templates</a></li>
  <li><a href="#remove-jdbcpostgres" id="toc-item-pg-to-datomic-remove-jdbcpostgres">Remove JDBC/Postgres</a></li>
  <li><a href="#update-unit-test" id="toc-item-pg-to-datomic-update-unit-test">Update unit test</a></li>
  <li><a href="#infrastructure-final-touches" id="toc-item-pg-to-datomic-infrastructure-final-touches">Infrastructure (final touches)</a>    <ul>
      <li><a href="#setting-up-production-postgres-driven-backend" id="toc-item-pg-to-datomic-setting-up-production-postgres-driven-backend">Setting up production Postgres-driven backend</a></li>
      <li><a href="#running-the-transactor" id="toc-item-pg-to-datomic-running-the-transactor">Running the transactor</a></li>
      <li><a href="#console" id="toc-item-pg-to-datomic-console">Console</a></li>
      <li><a href="#backups" id="toc-item-pg-to-datomic-backups">Backups</a></li>
      <li><a href="#backups-as-a-way-to-deploy-the-data" id="toc-item-pg-to-datomic-backups-as-a-way-to-deploy-the-data">Backups as a way to deploy the data</a></li>
    </ul>
  </li>
  <li><a href="#conclusion" id="toc-item-pg-to-datomic-conclusion">Conclusion</a></li>
</ul>

<h2 id="introduction">Introduction</h2>

<p>Before we begin, let’s talk about what is the reason to switch to Datomic. That
question cannot be answered just in one or two points. Before Datomic, I’ve been
working with PostgreSQL for several years and reckon it as a great
software. There is no such a task that Postgres cannot deal with. Here are just
some of them:</p>

<ul>
  <li>streaming replication, smart sharding;</li>
  <li>geo-spatial data, PostGIS;</li>
  <li>full-text search, trigrams;</li>
  <li>JSON(b) data structures;</li>
  <li>typed arrays;</li>
  <li>recursive queries;</li>
  <li>and tons of other benefits.</li>
</ul>

<p>So if Postgres is really so great, why switching then? In my point of view, it
brings the following benefits into a project:</p>

<ol>
  <li>Datomic is simple. In fact, it has only two operations: read (querying) and
write (transaction).</li>
  <li>It supports joins as well. Once you have a reference, it can be resolved into
a nested map. References may be recursive. In PostgreSQL or any other RDBS,
you always have a plain result with possibly duplicated rows. The ORM logic
that may deal with parsing raw SQL response might be too complicated to
understand.</li>
  <li>Datomic was developed in the same terms as Clojure was. These are simplicity,
immutability and declarative style. Datomic shares Clojure’s values.</li>
  <li>It accumulates changes through time like Git or any other control version
system. With Datomic, you may always roll-back in time to get a history of an
order or collect audit logs.</li>
</ol>

<p>Let’s highlight some general steps we should pass through to complete the
migration. These are:</p>

<ul>
  <li>dump you Postgres data;</li>
  <li>add Datomic into your project;</li>
  <li>load the data into Datomic;</li>
  <li>rewrite the code that operates on data;</li>
  <li>rewrite your HTML templates;</li>
  <li>update or add unit tests;</li>
  <li>remote JDBC/Postgres from your project;</li>
  <li>setup infrastructure (backups, console, etc)</li>
</ul>

<p>As you see, it is not as simple as it could be thought even for a small
project. In my case, migrating Queryfeed took about a week working by nights. It
includes:</p>

<ul>
  <li>two days to read the whole <a href="http://docs.datomic.com/">Datomic documentation</a>;</li>
  <li>one day to migrate the data;</li>
  <li>two days to fix the business logic code and templates;</li>
  <li>two days to deploy everything to the server.</li>
</ul>

<p>Regarding to the documentation, I highly recommend you to read it first before
doing anything. Please do not rely on random Stack Overflow snippets. Datomic is
completely different than classical SQL databases, so your long-term Postgres or
MySQL experience won’t work.</p>

<p>Quick tip here, since it could be difficult to read lots of text from a screen,
I just download any page I wish to read into my Kindle using the official
Amazon <a href="https://chrome.google.com/webstore/detail/send-to-kindle-for-google/cgdjpilhipecahhcilnafpblkieebhea?hl=en">extension for Chrome</a>. The paper appears on my Kindle in a
minute and I read it.</p>

<p>Once you’ve finished with the docs, feel free to the next step: dumping your
PostgreSQL data.</p>

<h2 id="dump-postgres-database">Dump Postgres database</h2>

<p>Exporting you data into a set of files won’t be so difficult I believe. I may
guess your project has <code class="language-plaintext highlighter-rouge">projectname.db</code> module that handles the most of database
stuff. It should have <code class="language-plaintext highlighter-rouge">clojure.java.jdbc</code> module imported and <code class="language-plaintext highlighter-rouge">*db*</code> or
<code class="language-plaintext highlighter-rouge">db-spec</code> variables declared. Your goal is for every table you have in the
database, run a query something like <code class="language-plaintext highlighter-rouge">select * from &lt;table_name&gt;</code> against it and
save the result into a file.</p>

<p>What file format to use depends on your own preferences, but I highly recommend
the standard <code class="language-plaintext highlighter-rouge">EDN</code> files rather than JSON, CSV or whatever. The main point in
favor of <code class="language-plaintext highlighter-rouge">EDN</code> is it handles extended data types such as dates and UUIDs. In my
case, every table has at least one date field, for example <code class="language-plaintext highlighter-rouge">created_at</code> that is
not null and is set with the current time automatically. When using JSON or
YAML, the dates will be just strings so you need to write extra code to restore
a native <code class="language-plaintext highlighter-rouge">java.util.Date</code> class from a string. So are unique identifiers, UUIDs.</p>

<p>In addition, since <code class="language-plaintext highlighter-rouge">EDN</code> files represent native Clojure data structures, you
don’t need to add <code class="language-plaintext highlighter-rouge">org.clojure/data.json</code> dependency into your
project. Everything can be made with out-from-the-box functions. The next
snippet dumps all the users from your Postgres database into a <code class="language-plaintext highlighter-rouge">users.edn</code> file:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w">
</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">*db*</span><span class="w"> </span><span class="p">{</span><span class="n">...</span><span class="w"> </span><span class="n">your</span><span class="w"> </span><span class="n">JDBC</span><span class="w"> </span><span class="n">spec</span><span class="w"> </span><span class="n">map...</span><span class="p">})</span><span class="w">

</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="p">(</span><span class="nb">partial</span><span class="w"> </span><span class="n">jdbc/query</span><span class="w"> </span><span class="n">db-spec</span><span class="p">))</span><span class="w">

</span><span class="p">(</span><span class="nf">spit</span><span class="w"> </span><span class="s">"users.edn"</span><span class="w"> </span><span class="p">(</span><span class="nb">with-out-str</span><span class="w"> </span><span class="p">(</span><span class="nb">-&gt;</span><span class="w"> </span><span class="s">"select * from users"</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="nb">prn</span><span class="p">)))</span><span class="w">

</span></code></pre></div></div>

<p>And that is! With only one line of code, you’ve just dumped the whole table into
a file. Repeat it several times substituting a name of an <code class="language-plaintext highlighter-rouge">*.edn</code> file and a
table. If you have many tables, wrap it with a function:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">dump</span><span class="w"> </span><span class="p">[</span><span class="n">table</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nf">spit</span><span class="w"> </span><span class="p">(</span><span class="nf">format</span><span class="w"> </span><span class="s">"%s.edn"</span><span class="w"> </span><span class="n">table</span><span class="p">)</span><span class="w">
    </span><span class="p">(</span><span class="nb">with-out-str</span><span class="w"> </span><span class="p">(</span><span class="nb">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="nf">format</span><span class="w"> </span><span class="s">"select * from %s"</span><span class="w"> </span><span class="n">table</span><span class="p">)</span><span class="w">
                      </span><span class="n">query</span><span class="w">
                      </span><span class="nb">prn</span><span class="p">))))</span><span class="w">
</span></code></pre></div></div>

<p>Then run it against a vector of table names but not a set since an order is
important. For example, if you have a user has a foreign key to <code class="language-plaintext highlighter-rouge">orders</code> table,
it should be loaded first.</p>

<p>To check whether your dump is correct, try to restore it from a file as follows:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nb">-&gt;</span><span class="w"> </span><span class="s">"users.edn"</span><span class="w"> </span><span class="nb">slurp</span><span class="w"> </span><span class="n">read-string</span><span class="w"> </span><span class="nb">first</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>Again, it is so simple to perform such things in Clojure. Within one line of
code, you have just read the file, restored the Clojure data from it and took
the first map from a list. In REPL, you should see something like:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="no">:id</span><span class="w"> </span><span class="mi">1</span><span class="w">
 </span><span class="no">:name</span><span class="w"> </span><span class="s">"Ivan"</span><span class="w">
 </span><span class="no">:email</span><span class="w"> </span><span class="s">"test@test.com"</span><span class="w">
 </span><span class="n">...</span><span class="w"> </span><span class="n">other</span><span class="w"> </span><span class="n">fields</span><span class="w">
 </span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>That means the dump step was done as well.</p>

<h2 id="adding-datomic-into-your-project">Adding Datomic into your project</h2>

<p>Here, I won’t discuss on that step so long since it is highlighted as well in
the official documentation. Briefly, you need to:</p>

<ol>
  <li><a href="https://my.datomic.com/">register</a> on Datomic site, it is free;</li>
  <li>set up your <a href="https://github.com/technomancy/leiningen/blob/master/doc/GPG.md">GPG credentials</a>;</li>
  <li>add Datomic repository and <a href="http://docs.datomic.com/integrating-peer-lib.html">the library</a> into your project;</li>
  <li>(optional) if you use Postgres-driven backend for
Datomic, <a href="http://docs.datomic.com/storage.html#sql-database">create a new Postgres</a> database using SQL scripts from
<code class="language-plaintext highlighter-rouge">sql</code> folder. Then <a href="http://docs.datomic.com/run-transactor.html">run a transactor</a>.</li>
</ol>

<p>Below, here is a brief example of my setup:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">;; project.clj</span><span class="w">
</span><span class="p">(</span><span class="nf">defproject</span><span class="w"> </span><span class="n">my-project</span><span class="w"> </span><span class="s">"0.x.x"</span><span class="w">
  </span><span class="n">...</span><span class="w">
  </span><span class="no">:repositories</span><span class="w"> </span><span class="p">{</span><span class="s">"my.datomic.com"</span><span class="w"> </span><span class="p">{</span><span class="no">:url</span><span class="w"> </span><span class="s">"https://my.datomic.com/repo"</span><span class="w">
                                   </span><span class="no">:creds</span><span class="w"> </span><span class="no">:gpg</span><span class="p">}}</span><span class="w">

  </span><span class="no">:dependencies</span><span class="w"> </span><span class="p">[</span><span class="n">...</span><span class="w">
                 </span><span class="p">[</span><span class="n">com.datomic/datomic-pro</span><span class="w"> </span><span class="s">"0.9.5561.50"</span><span class="p">]</span><span class="w">
                 </span><span class="n">...</span><span class="p">]</span><span class="w">
  </span><span class="n">...</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>Run <code class="language-plaintext highlighter-rouge">lein deps</code> to download the library. You will be probably prompted to input
your GPG key.</p>

<p>A quick try in REPL:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">require</span><span class="w"> </span><span class="o">'</span><span class="p">[</span><span class="n">datomic.api</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">d</span><span class="p">])</span><span class="w">
</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="p">(</span><span class="nf">d/connect</span><span class="w"> </span><span class="s">"datomic:mem://test-db"</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<h2 id="loading-the-data-into-datomic">Loading the data into Datomic</h2>

<p>In this step, we will load the previously dumped data into your Datomic
installation.</p>

<p>First, we need to prepare the schema before loading the data. A schema is a
collection of attributes. Each attribute by itself is a small piece of
information, for example a <code class="language-plaintext highlighter-rouge">:user/name</code> attribute keeps a string value and
indicates a user’s name.</p>

<p>An entity is a set of attributes linked together by system identifier. Thinking
in RDBS terms, an attribute is a DB column whereas an entity is a row of a
table. That really differs Datomic from such schema-less databases as MongoDB for
example. In Mongo, every entity may have any structure you wish even across the
same collection. In Datomic, you cannot write a string value into a number or a
boolean into a date. One note, an entity may own an arbitrary number of
attributes.</p>

<p>For example, in Postgres if you did not set default values for a column and it
is not null, you just cannot skip it when inserting a row. In Datomic, you may
submit as many attributes as you want when performing a transaction. Imagine we
have a user model with ten attributes: a name, email, etc. When creating a user,
I may pass only a name and there won’t be an error. So pay attention you submit
all the required attributes.</p>

<p>Datomic schema is represented by native Clojure data structures: maps, keywords
and vectors. That’s why they are stored in EDN files as well. A typical initial
schema for fresh Datomic installation may look as follows:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="w">
 </span><span class="c1">;; Enums</span><span class="w">
 </span><span class="p">{</span><span class="no">:db/ident</span><span class="w"> </span><span class="no">:user.gender/male</span><span class="p">}</span><span class="w">
 </span><span class="p">{</span><span class="no">:db/ident</span><span class="w"> </span><span class="no">:user.gender/female</span><span class="p">}</span><span class="w">

 </span><span class="p">{</span><span class="no">:db/ident</span><span class="w"> </span><span class="no">:user.source/twitter</span><span class="p">}</span><span class="w">
 </span><span class="p">{</span><span class="no">:db/ident</span><span class="w"> </span><span class="no">:user.source/facebook</span><span class="p">}</span><span class="w">

 </span><span class="c1">;; Users</span><span class="w">

 </span><span class="p">{</span><span class="no">:db/ident</span><span class="w">       </span><span class="no">:user/pg-id</span><span class="w">
  </span><span class="no">:db/valueType</span><span class="w">   </span><span class="no">:db.type/long</span><span class="w">
  </span><span class="no">:db/cardinality</span><span class="w"> </span><span class="no">:db.cardinality/one</span><span class="w">
  </span><span class="no">:db/unique</span><span class="w">      </span><span class="no">:db.unique/identity</span><span class="p">}</span><span class="w">

 </span><span class="p">{</span><span class="no">:db/ident</span><span class="w">       </span><span class="no">:user/source</span><span class="w">
  </span><span class="no">:db/valueType</span><span class="w">   </span><span class="no">:db.type/ref</span><span class="w">
  </span><span class="no">:db/cardinality</span><span class="w"> </span><span class="no">:db.cardinality/one</span><span class="w">
  </span><span class="no">:db/isComponent</span><span class="w"> </span><span class="n">true</span><span class="p">}</span><span class="w">

 </span><span class="p">{</span><span class="no">:db/ident</span><span class="w">       </span><span class="no">:user/source-id</span><span class="w">
  </span><span class="no">:db/valueType</span><span class="w">   </span><span class="no">:db.type/string</span><span class="w">
  </span><span class="no">:db/cardinality</span><span class="w"> </span><span class="no">:db.cardinality/one</span><span class="p">}</span><span class="w">
 </span><span class="n">...</span><span class="w">
</span><span class="p">]</span><span class="w">
</span></code></pre></div></div>

<p>The first four ones are special attributes that are proposed as enum values. I
will discuss more on them later.</p>

<p>Again, check for the official documentation that
describes <a href="http://docs.datomic.com/schema.html">schema usage</a>.</p>

<p>Now that we prepared a schema, let add some boilerate code in our <code class="language-plaintext highlighter-rouge">db</code>
namespace:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">ns</span><span class="w"> </span><span class="n">project.db</span><span class="w">
  </span><span class="p">(</span><span class="no">:require</span><span class="w"> </span><span class="p">[</span><span class="n">clojure.java.io</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">io</span><span class="p">]</span><span class="w">
            </span><span class="p">[</span><span class="n">datomic.api</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">d</span><span class="p">]))</span><span class="w">

</span><span class="c1">;; in-memory database for test purposes</span><span class="w">
</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">db-uri</span><span class="w"> </span><span class="s">"datomic:mem://test-db"</span><span class="p">)</span><span class="w">

</span><span class="c1">;; global Datomic connection wrapped in atom</span><span class="w">
</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">*conn</span><span class="w"> </span><span class="p">(</span><span class="nf">atom</span><span class="w"> </span><span class="n">nil</span><span class="p">))</span><span class="w">

</span><span class="c1">;; A function to initiate the global state</span><span class="w">
</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">init-db</span><span class="w"> </span><span class="p">[]</span><span class="w">
  </span><span class="p">(</span><span class="nf">d/create-database</span><span class="w"> </span><span class="n">db-uri</span><span class="p">)</span><span class="w">
  </span><span class="p">(</span><span class="nf">reset!</span><span class="w"> </span><span class="n">*conn</span><span class="w"> </span><span class="p">(</span><span class="nf">d/connect</span><span class="w"> </span><span class="n">db-uri</span><span class="p">)))</span><span class="w">

</span><span class="c1">;; reads an EDN file located in `resources` folder</span><span class="w">
</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">read-edn</span><span class="w">
  </span><span class="p">[</span><span class="n">filename</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nb">-&gt;</span><span class="w"> </span><span class="n">filename</span><span class="w">
      </span><span class="n">io/resource</span><span class="w">
      </span><span class="nb">slurp</span><span class="w">
      </span><span class="n">read-string</span><span class="p">))</span><span class="w">

</span><span class="c1">;; reads and loads a schema from EDN file</span><span class="w">
</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">load-schema</span><span class="w">
  </span><span class="p">[</span><span class="n">filename</span><span class="p">]</span><span class="w">
  </span><span class="o">@</span><span class="p">(</span><span class="nf">d/transact</span><span class="w"> </span><span class="o">@</span><span class="n">*conn</span><span class="w"> </span><span class="p">(</span><span class="nf">read-edn</span><span class="w"> </span><span class="n">filename</span><span class="p">)))</span><span class="w">
</span></code></pre></div></div>

<p>I hope the comments highlight the meaning of the code as well. I just declared a
database URL, a global connection, a function to connect to the DB and two
helper functions.</p>

<p>The first function rust reads a <code class="language-plaintext highlighter-rouge">EDN</code> file and returns a data structure. Since
our files a stored in resources folder, there is a <code class="language-plaintext highlighter-rouge">io/resource</code> wrapper here in
the threading chain.</p>

<p>The second function also read a file but also performs a Datomic transaction
passing data as a schema.</p>

<p>The <code class="language-plaintext highlighter-rouge">db-uri</code> variable is represented with URL-like string. Currently, we use
in-memory storage for test purposes. I really doubt you can load the data
directly to SQL-driven storage without errors so let’s just practice for a
while. Later, when the import step will be ready, we will just switch <code class="language-plaintext highlighter-rouge">db-uri</code>
variable to production-ready URL.</p>

<p>With the code above, we are ready to load the schema. I put my initial schema
into a file <code class="language-plaintext highlighter-rouge">resources/schema/0001-init.edn</code> so I may load it as follows:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">init-db</span><span class="p">)</span><span class="w">
</span><span class="p">(</span><span class="nf">load-schema</span><span class="w"> </span><span class="s">"schema/0001-init.edn"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>Now that we have a schema, let’s load the previously saved Postgres data. We
need to add more boilerate code. Unfortunately, there cannot be a common
function that may map your Postgres fields into Datomic attributes. The
functions to convert your data might look a bit ugly, but they are
one-time-purpose only so please don’t mind.</p>

<p>For each EDN file that contains data of a specific table, we should:</p>

<ol>
  <li>read a proper file, get a list of maps;</li>
  <li>convert each PostgreSQL map into Datomic map;</li>
  <li>perform Datomic transaction passing a vector of Datomic maps.</li>
</ol>

<p>Below, here is an example of my <code class="language-plaintext highlighter-rouge">pg-user-to-datomic</code> function that accepts a
Postgres-driven map and turns it into a set of Datomic attributes:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">pg-user-to-datomic</span><span class="w">
  </span><span class="p">[{</span><span class="no">:keys</span><span class="w"> </span><span class="p">[</span><span class="n">email</span><span class="w">
           </span><span class="n">first_name</span><span class="w">
           </span><span class="n">timezone</span><span class="w">
           </span><span class="n">source_url</span><span class="w">
           </span><span class="n">locale</span><span class="w">
           </span><span class="nb">name</span><span class="w">
           </span><span class="n">access_token</span><span class="w">
           </span><span class="n">access_secret</span><span class="w">
           </span><span class="n">source</span><span class="w">
           </span><span class="n">token</span><span class="w">
           </span><span class="n">status</span><span class="w">
           </span><span class="n">id</span><span class="w">
           </span><span class="n">access_expires</span><span class="w">
           </span><span class="n">last_name</span><span class="w">
           </span><span class="n">gender</span><span class="w">
           </span><span class="n">source_id</span><span class="w">
           </span><span class="n">is_subscribed</span><span class="w">
           </span><span class="n">created_at</span><span class="p">]}]</span><span class="w">

  </span><span class="p">{</span><span class="no">:user/pg-id</span><span class="w"> </span><span class="n">id</span><span class="w">
   </span><span class="no">:user/email</span><span class="w"> </span><span class="p">(</span><span class="nb">or</span><span class="w"> </span><span class="n">email</span><span class="w"> </span><span class="s">""</span><span class="p">)</span><span class="w">
   </span><span class="no">:user/first-name</span><span class="w"> </span><span class="p">(</span><span class="nb">or</span><span class="w"> </span><span class="n">first_name</span><span class="w"> </span><span class="s">""</span><span class="p">)</span><span class="w">
   </span><span class="no">:user/timezone</span><span class="w"> </span><span class="p">(</span><span class="nb">or</span><span class="w"> </span><span class="n">timezone</span><span class="w"> </span><span class="s">""</span><span class="p">)</span><span class="w">
   </span><span class="no">:user/source-url</span><span class="w"> </span><span class="p">(</span><span class="nf">URI.</span><span class="w"> </span><span class="n">source_url</span><span class="p">)</span><span class="w">
   </span><span class="no">:user/locale</span><span class="w"> </span><span class="p">(</span><span class="nb">or</span><span class="w"> </span><span class="n">locale</span><span class="w"> </span><span class="s">""</span><span class="p">)</span><span class="w">
   </span><span class="no">:user/name</span><span class="w"> </span><span class="p">(</span><span class="nb">or</span><span class="w"> </span><span class="nb">name</span><span class="w"> </span><span class="s">""</span><span class="p">)</span><span class="w">
   </span><span class="no">:user/access-token</span><span class="w"> </span><span class="p">(</span><span class="nb">or</span><span class="w"> </span><span class="n">access_token</span><span class="w"> </span><span class="s">""</span><span class="p">)</span><span class="w">
   </span><span class="no">:user/access-secret</span><span class="w"> </span><span class="p">(</span><span class="nb">or</span><span class="w"> </span><span class="n">access_secret</span><span class="w"> </span><span class="s">""</span><span class="p">)</span><span class="w">

   </span><span class="no">:user/source</span><span class="w"> </span><span class="p">(</span><span class="nf">case</span><span class="w"> </span><span class="n">source</span><span class="w">
                       </span><span class="s">"facebook"</span><span class="w"> </span><span class="no">:user.source/facebook</span><span class="w">
                       </span><span class="s">"twitter"</span><span class="w"> </span><span class="no">:user.source/twitter</span><span class="p">)</span><span class="w">

   </span><span class="no">:user/source-id</span><span class="w"> </span><span class="n">source_id</span><span class="w">

   </span><span class="no">:user/token</span><span class="w"> </span><span class="p">(</span><span class="nf">UUID/fromString</span><span class="w"> </span><span class="n">token</span><span class="p">)</span><span class="w">
   </span><span class="no">:user/status</span><span class="w"> </span><span class="p">(</span><span class="nf">case</span><span class="w"> </span><span class="n">status</span><span class="w">
                  </span><span class="s">"normal"</span><span class="w"> </span><span class="no">:user.status/normal</span><span class="w">
                  </span><span class="s">"pro"</span><span class="w"> </span><span class="no">:user.status/pro</span><span class="p">)</span><span class="w">

   </span><span class="no">:user/access-expires</span><span class="w"> </span><span class="p">(</span><span class="nb">or</span><span class="w"> </span><span class="n">access_expires</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w">
   </span><span class="no">:user/last-name</span><span class="w"> </span><span class="p">(</span><span class="nb">or</span><span class="w"> </span><span class="n">last_name</span><span class="w"> </span><span class="s">""</span><span class="p">)</span><span class="w">
   </span><span class="no">:user/gender</span><span class="w"> </span><span class="p">(</span><span class="nf">case</span><span class="w"> </span><span class="n">gender</span><span class="w">
                  </span><span class="s">"male"</span><span class="w"> </span><span class="no">:user.gender/male</span><span class="w">
                  </span><span class="s">"female"</span><span class="w"> </span><span class="no">:user.gender/female</span><span class="p">)</span><span class="w">

   </span><span class="no">:user/is-subscribed</span><span class="w"> </span><span class="p">(</span><span class="nb">or</span><span class="w"> </span><span class="n">is_subscribed</span><span class="w"> </span><span class="n">false</span><span class="p">)</span><span class="w">
   </span><span class="no">:user/created-at</span><span class="w"> </span><span class="p">(</span><span class="nb">or</span><span class="w"> </span><span class="n">created_at</span><span class="w"> </span><span class="p">(</span><span class="nf">Date.</span><span class="p">))})</span><span class="w">
</span></code></pre></div></div>

<p>Yes, it looks ugly a bit annoying, but you have to write something like this for
every table your have.</p>

<p>Here is the code to load a table into Datomic:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">-&gt;&gt;</span><span class="w"> </span><span class="s">"users.edn"</span><span class="w"> </span><span class="nb">slurp</span><span class="w"> </span><span class="n">read-string</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="n">pg-user-to-datomic</span><span class="p">)</span><span class="w"> </span><span class="n">transact!</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>Before we go further, let’s discuss some important notes on importing the data.</p>

<h3 id="avoid-nils">Avoid nils</h3>

<p>Datomic does not support nil values for attributes. When you do not have a value
for an attribute, you should either skip it or pass an empty value: a zero, an
empty string, etc. That’s why the most of expressions have <code class="language-plaintext highlighter-rouge">(or "")</code> at the end
of threading macro.</p>

<h3 id="shrink-your-tables">Shrink your tables</h3>

<p>Migrating to the new datastore backend is a good chance to refactor your
schema. For those who has spent years working with relational database it is not
a secret that typical SQL applications suffer from lots of tables. In SQL, it is
not enough to keep just “entities” tables: users, orders, etc. Often, you need
to associate a product with colors, a blog post with tags or a user with
permissions. That leads to <code class="language-plaintext highlighter-rouge">product_colors</code>, <code class="language-plaintext highlighter-rouge">post_tags</code> and other bridge
tables. You join them in a query to “go through” from a user to their orders,
for example.</p>

<p>Datomic is free from bridge tables. It supports reference attributes that are
linked to any other entity. In addition, each attribute may carry multiple
values. For example, if we want to link a blog post with a set of tags, we’d
rather declare the following schema:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="w">
 </span><span class="c1">;; Tag</span><span class="w">

 </span><span class="p">{</span><span class="no">:db/ident</span><span class="w">       </span><span class="no">:tag/name</span><span class="w">
  </span><span class="no">:db/valueType</span><span class="w">   </span><span class="no">:db.type/string</span><span class="w">
  </span><span class="no">:db/cardinality</span><span class="w"> </span><span class="no">:db.cardinality/one</span><span class="w">
  </span><span class="no">:db/unique</span><span class="w">      </span><span class="no">:db.unique/identity</span><span class="p">}</span><span class="w">

 </span><span class="c1">;; Post</span><span class="w">

 </span><span class="p">{</span><span class="no">:db/ident</span><span class="w">       </span><span class="no">:post/title</span><span class="w">
  </span><span class="no">:db/valueType</span><span class="w">   </span><span class="no">:db.type/string</span><span class="w">
  </span><span class="no">:db/cardinality</span><span class="w"> </span><span class="no">:db.cardinality/one</span><span class="p">}</span><span class="w">

 </span><span class="p">{</span><span class="no">:db/ident</span><span class="w">       </span><span class="no">:post/text</span><span class="w">
  </span><span class="no">:db/valueType</span><span class="w">   </span><span class="no">:db.type/string</span><span class="w">
  </span><span class="no">:db/cardinality</span><span class="w"> </span><span class="no">:db.cardinality/one</span><span class="p">}</span><span class="w">

 </span><span class="p">{</span><span class="no">:db/ident</span><span class="w">       </span><span class="no">:post/tags</span><span class="w">
  </span><span class="no">:db/valueType</span><span class="w">   </span><span class="no">:db.type/ref</span><span class="w">
  </span><span class="no">:db/cardinality</span><span class="w"> </span><span class="no">:db.cardinality/many</span><span class="p">}</span><span class="w">
</span><span class="p">]</span><span class="w">
</span></code></pre></div></div>

<p>In Postgres, you will need <code class="language-plaintext highlighter-rouge">post_tags</code> bridge table with <code class="language-plaintext highlighter-rouge">post_id</code> and <code class="language-plaintext highlighter-rouge">tag_id</code>
foreign keys. In datomic, you simply pass a vector of IDs in <code class="language-plaintext highlighter-rouge">:post/tags</code> field
when creating a post.</p>

<p>Migrating to Datomic is a great chance to get rid of those tables.</p>

<h3 id="use-enums">Use enums</h3>

<p>Both Postgres and Datomic provide support of enum types. A enum type is a set of
values. An instance of enum type may have only one of those values.</p>

<p>In Postgres, I use enum types a lot. They are fast, reliable and provide strong
consistency of you data. For example, if you have an order with possible “new”,
“pending” and “paid” states, please don’t use <code class="language-plaintext highlighter-rouge">varchar</code> type for that. Somehow
you may write something wrong there, for example mix up the register or make a
misprint. So you’d better to declare the schema as follows:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">create</span> <span class="k">type</span> <span class="n">order_state</span> <span class="k">as</span> <span class="nb">enum</span> <span class="p">(</span>
  <span class="s1">'order_state/new'</span><span class="p">,</span>
  <span class="s1">'order_state/pending'</span><span class="p">,</span>
  <span class="s1">'order_state/paid'</span>
<span class="p">);</span>

<span class="k">create</span> <span class="k">table</span> <span class="n">orders</span> <span class="p">(</span>
  <span class="n">id</span> <span class="nb">serial</span> <span class="k">primary</span> <span class="k">key</span><span class="p">,</span>
  <span class="k">state</span> <span class="n">order_state</span> <span class="k">not</span> <span class="k">null</span> <span class="k">default</span> <span class="s1">'order_state/new'</span><span class="p">::</span><span class="n">order_state</span><span class="p">,</span>
  <span class="p">...</span>
<span class="p">);</span>
</code></pre></div></div>

<p>Now you cannot submit an unknown state for an order.</p>

<p>Although Postgres enums are great, JDBC library makes our life a bit more
difficult by forcing us to wrap enum values into <code class="language-plaintext highlighter-rouge">PGObject</code> when querying or
inserting data. For example, to submit a new state for an order, you cannot just
pass a string <code class="language-plaintext highlighter-rouge">"order_state/paid"</code>. You’ll get an error saying you are trying to
submit a string for <code class="language-plaintext highlighter-rouge">order_state</code> type column. So you have to wrap your string
into a special object:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">get-pg-obj</span><span class="w"> </span><span class="p">[</span><span class="n">type</span><span class="w"> </span><span class="n">value</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nb">doto</span><span class="w"> </span><span class="p">(</span><span class="nf">PGobject.</span><span class="p">)</span><span class="w">
    </span><span class="p">(</span><span class="nf">.setType</span><span class="w"> </span><span class="n">type</span><span class="p">)</span><span class="w">
    </span><span class="p">(</span><span class="nf">.setValue</span><span class="w"> </span><span class="n">value</span><span class="p">)))</span><span class="w">

</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">get-order-state</span><span class="w">
  </span><span class="p">(</span><span class="nb">partial</span><span class="w"> </span><span class="n">get-pg-obj</span><span class="w"> </span><span class="s">"order_state"</span><span class="p">))</span><span class="w">

</span><span class="c1">;; now, composing parameters for a query</span><span class="w">
</span><span class="p">{</span><span class="no">:order_id</span><span class="w"> </span><span class="mi">42</span><span class="w">
 </span><span class="no">:state</span><span class="w"> </span><span class="p">(</span><span class="nf">get-order-state</span><span class="w"> </span><span class="s">"order_state/paid"</span><span class="p">)}</span><span class="w">
</span></code></pre></div></div>

<p>Another disadvantage here is inconsistency between select and insert
queries. When you just read the data, you get the enum value as a string. But
when you pass a enum as a parameter, you still need to wrap it with
PGObject. That is a bit annoying.</p>

<p>Datomic also has nice support of enums. There is no a special syntax for
them. Enums are special attributes that do not have values but only
names. Above, I have already highlighted them:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="w">
 </span><span class="p">{</span><span class="no">:db/ident</span><span class="w"> </span><span class="no">:user.gender/male</span><span class="p">}</span><span class="w">
 </span><span class="p">{</span><span class="no">:db/ident</span><span class="w"> </span><span class="no">:user.gender/female</span><span class="p">}</span><span class="w">

 </span><span class="p">{</span><span class="no">:db/ident</span><span class="w"> </span><span class="no">:user.source/twitter</span><span class="p">}</span><span class="w">
 </span><span class="p">{</span><span class="no">:db/ident</span><span class="w"> </span><span class="no">:user.source/facebook</span><span class="p">}</span><span class="w">
</span><span class="p">]</span><span class="w">
</span></code></pre></div></div>

<p>Later, you may reference a enum value passing just a keyword
<code class="language-plaintext highlighter-rouge">:user.source/twitter</code>. It’s quite simple, fast and keeps your database
consistent.</p>

<h3 id="json-data">JSON data</h3>

<p>Personally, I try to avoid using JSON in Postgres as long as it is
possible. Adding JSON fields everywhere turns your Postgres installation into
MongoDB. It becomes quite easy to make a mistake or corrupt the data and fall
into a situation when one half or your JSON data has a particular key and the
rest half does not.</p>

<p>Sometimes you really need to keep JSON in your DB. A good example might
be <a href="https://developer.paypal.com/docs/classic/products/instant-payment-notification/">Paypal Instant Notifications</a>. These are HTTP requests that Paypal
sends to your server when a customer buys something. IPN’s body keeps about 30
fields and its structure may vary depending on transaction type. Splitting that
data into separate fields and storing all of them across separate columns will
be a mess. A solution will be to fetch only the most sensible ones (date, email,
sum, order number) and write the rest data into a <code class="language-plaintext highlighter-rouge">jsonb</code> column. Then, once you
need to fetch any additional information from an IPN, for example a tax sum, you
may query it as well:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span>
  <span class="k">data</span><span class="o">-&gt;</span><span class="s1">'tax_sum'</span><span class="p">::</span><span class="nb">numeric</span> <span class="k">as</span> <span class="n">tax</span>
<span class="k">from</span>
  <span class="n">ipn</span>
<span class="k">where</span>
  <span class="n">order_number</span> <span class="o">=</span> <span class="s1">'123456'</span><span class="p">;</span>
</code></pre></div></div>

<p>In Datomic, there is no JSON type for attributes. I’m not sure I made a proper
decision, but I just put those JSON data into a text attribute. Sure, where is
no a way to access separate fields in a datalog query or apply roles to
them. But at least I can restore the data when selecting a single entity:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">;; local handler to parse JSON with keywords in keys</span><span class="w">
</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">parse-json</span><span class="w"> </span><span class="p">[</span><span class="n">value</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nf">json/parse-string</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="n">true</span><span class="p">))</span><span class="w">

</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">get-last-ipn</span><span class="w"> </span><span class="p">[</span><span class="n">user-id</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">query</span><span class="w"> </span><span class="o">'</span><span class="p">[</span><span class="no">:find</span><span class="w"> </span><span class="p">[(</span><span class="nf">pull</span><span class="w"> </span><span class="n">?ipn</span><span class="w"> </span><span class="p">[</span><span class="nb">*</span><span class="p">])</span><span class="w"> </span><span class="n">...</span><span class="p">]</span><span class="w">
                </span><span class="no">:in</span><span class="w"> </span><span class="n">$</span><span class="w"> </span><span class="n">?user</span><span class="w">
                </span><span class="no">:where</span><span class="w">
                </span><span class="p">[</span><span class="n">?ipn</span><span class="w"> </span><span class="no">:ipn/user</span><span class="w"> </span><span class="n">?user</span><span class="p">]]</span><span class="w">

        </span><span class="n">result</span><span class="w"> </span><span class="p">(</span><span class="nf">d/q</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="p">(</span><span class="nf">d/db</span><span class="w"> </span><span class="o">@</span><span class="n">*conn</span><span class="p">)</span><span class="w"> </span><span class="n">user-id</span><span class="p">)]</span><span class="w">

    </span><span class="p">(</span><span class="nb">when</span><span class="w"> </span><span class="p">(</span><span class="nf">not-empty</span><span class="w"> </span><span class="n">result</span><span class="p">)</span><span class="w">
      </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">item</span><span class="w"> </span><span class="p">(</span><span class="nb">last</span><span class="w"> </span><span class="p">(</span><span class="nb">sort-by</span><span class="w"> </span><span class="no">:ipn/emitted-at</span><span class="w"> </span><span class="n">result</span><span class="p">))]</span><span class="w">
        </span><span class="p">(</span><span class="nf">update</span><span class="w"> </span><span class="n">item</span><span class="w"> </span><span class="no">:ipn/data</span><span class="w"> </span><span class="n">parse-json</span><span class="p">)))))</span><span class="w">
</span></code></pre></div></div>

<h3 id="foreign-keys">Foreign keys</h3>

<p>In RDBS, a typical table has auto-incremental <code class="language-plaintext highlighter-rouge">id</code> field that marks a unique
number of that row. When you need to refer to another table, an order or a
user’s profile, you declare a foreign key that just keeps a value for those
id. Since they are auto-generated, you should never bother on their real values,
but only consistency.</p>

<p>In Datomic, you do not have possibility to have auto-incremented values. When
you import your data, it’s important to handle foreign keys (or references in
terms of Datomic) properly. During the import, we populate <code class="language-plaintext highlighter-rouge">:&lt;entity&gt;/pg-id</code>
field that holds the legacy Postgres value. Once you import a table with foreign
keys, you may resolve a reference as follows:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="n">...</span><span class="w"> </span><span class="c1">;; other order fields</span><span class="w">
 </span><span class="no">:order/user</span><span class="w"> </span><span class="p">[</span><span class="no">:user/pg-id</span><span class="w"> </span><span class="n">user_id</span><span class="p">]}</span><span class="w">
</span></code></pre></div></div>

<p>A reference attribute may be represented as vector of two where the first value
is an attribute name and the second is its value.</p>

<p>For new entities created in production after migration to Datomic, you do not
need to submit <code class="language-plaintext highlighter-rouge">.../pg-id</code> value. You may either delete it (retract) once the
migration process has been finished or just keep it in the database as an
indicator that marks legacy data.</p>

<h2 id="update-the-code">Update the code</h2>

<p>This step would be the most boring, I believe. You need to scan the whole
project and fix those fragments where you access the data from the database.</p>

<p>Since it is a good practice to prepend attributes with a namespace, the most
common change would be attribute renaming I believe:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">;; before</span><span class="w">
</span><span class="p">(</span><span class="nb">println</span><span class="w"> </span><span class="p">(</span><span class="no">:name</span><span class="w"> </span><span class="n">user</span><span class="p">))</span><span class="w">

</span><span class="c1">;; after</span><span class="w">
</span><span class="p">(</span><span class="nb">println</span><span class="w"> </span><span class="p">(</span><span class="no">:user/name</span><span class="w"> </span><span class="n">user</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<p>You will face less problems by organizing special functions that wraps the
underlying logic. A good example might be to add <code class="language-plaintext highlighter-rouge">get-user-by-id</code>,
<code class="language-plaintext highlighter-rouge">get-orders-by-user-id</code> and so on.</p>

<p>If you use <a href="https://github.com/layerware/hugsql">HugSQL</a> or <a href="https://github.com/krisajenkins/yesql">YeSQL</a> Clojure libraries than you already
have such functions created dynamically from <code class="language-plaintext highlighter-rouge">*.sql</code> files. That is quite better
than having naked SQL everywhere. Porting such a project to Datomic will be much
easier.</p>

<h2 id="html-templates">HTML templates</h2>

<p>Another dull step that cannot be automated is to scan your Selmer templates (if
you have them in your project, of course) and to update those fragments where
you touch entities’ attributes. For example:</p>

<pre><code class="language-HTML">
;; before
&lt;p&gt;{{ user.first_name}} {{ user.last_name}}&lt;/p&gt;

;; after
&lt;p&gt;{{ user.user/first-name}} {{ user.user/last-name}}&lt;/p&gt;

</code></pre>

<p>You may access nested entities as well. Imagine a user has a reference to their
social profile:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="nt">&lt;p&gt;</span>{{ user.user/profile.profile/name }}<span class="nt">&lt;/p&gt;</span> ;; "twitter", "facebook" etc

</code></pre></div></div>

<p>Datomic encourages us to use enums which values are just keywords. Sometimes,
you need to implement <code class="language-plaintext highlighter-rouge">case...then</code> pattern in your Selmer template and render
any content depending on enum value. This may be a bit tricky since Selmer does
not support keyword literals. In the example above, a user has <code class="language-plaintext highlighter-rouge">:user/source</code>
attribute that references a enum with possible values <code class="language-plaintext highlighter-rouge">:user.source/twitter</code> or
<code class="language-plaintext highlighter-rouge">:user.source/facebook</code>. Here is how I figured out switching on them:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
{% ifequal request.user.user/source.db/ident|str ":user.source/twitter" %}
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"https://twitter.com/{{ user.user/username }}"</span><span class="nt">&gt;</span>Twitter page<span class="nt">&lt;/a&gt;</span>
{% endifequal %}
{% ifequal request.user.user/source.db/ident|str ":user.source/facebook" %}
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"{{ user.user/profile-url }}"</span><span class="nt">&gt;</span>Facebook page<span class="nt">&lt;/a&gt;</span>
{% endifequal %}

</code></pre></div></div>

<p>In the example above, we have to turn a keyword into a string using <code class="language-plaintext highlighter-rouge">|str</code>
filter to compare both values as strings.</p>

<p>To find all the Selmer variables or operators in Selmer, just grep your
templates folder by <code class="language-plaintext highlighter-rouge">{{</code> or <code class="language-plaintext highlighter-rouge">{%</code>
literals.</p>

<h2 id="remove-jdbcpostgres">Remove JDBC/Postgres</h2>

<p>Now that your project is Datomic-powered and does not need JDBC drivers anymore,
you may either remove them from the project or at least decrease them to the
<code class="language-plaintext highlighter-rouge">dev</code> dependencies needed only for development purposes.</p>

<p>Scan you project grepping it with <code class="language-plaintext highlighter-rouge">jdbc</code>, <code class="language-plaintext highlighter-rouge">postgres</code> terms to find those
namespaces that still use legacy DB backend. Remove any that still present. Open
your root <code class="language-plaintext highlighter-rouge">project.clj</code> file, remove <code class="language-plaintext highlighter-rouge">jdbc</code> and <code class="language-plaintext highlighter-rouge">postgresql</code> packages from
<code class="language-plaintext highlighter-rouge">:dependencies</code> vector. Ensure you may run and build the application and unit
tests as well.</p>

<h2 id="update-unit-test">Update unit test</h2>

<p>Datomic is a great tool in those aspect you may use in-memory backend when
running tests. That makes them pass quite faster and without needing setting up
Postgres installation on you machine.</p>

<p>I believe your project is able to detect whether it is in <code class="language-plaintext highlighter-rouge">dev</code>, <code class="language-plaintext highlighter-rouge">test</code> or <code class="language-plaintext highlighter-rouge">prod</code>
mode. If it’s not, take a look at <a href="http://www.luminusweb.net/">Luminus framework</a>. It’s done quite
well in that meaning. For each type of environment, you specify its own database
URL. For test, it will be in-memory storage.</p>

<p>Using the standard <code class="language-plaintext highlighter-rouge">clojure.test</code> namespace, you wrap each test with a fixture
that does the following steps:</p>

<ol>
  <li>creates a new database in memory and connects to it;</li>
  <li>runs all the schemas against it (migrations);</li>
  <li>populates it with predefined test data (users, orders etc; also know as
“fixtures”);</li>
  <li>runs the test itself</li>
  <li>drops the database and closes and disconnects from it.</li>
</ol>

<p>These steps should be run for each test. In that case, we can guarantee what
every test has its own environment and does not depend on other tests. It’s a
good practice when a test accepts a fresh installation not being touched by
previous tests.</p>

<p>Some preparation steps are:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">ns</span><span class="w"> </span><span class="n">your-project.test.users</span><span class="w">
  </span><span class="p">(</span><span class="no">:require</span><span class="w"> </span><span class="p">[</span><span class="n">clojure.test</span><span class="w"> </span><span class="no">:refer</span><span class="w"> </span><span class="no">:all</span><span class="p">]</span><span class="w">
            </span><span class="p">[</span><span class="n">your-project.db</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">db</span><span class="p">]))</span><span class="w">

</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">migrate</span><span class="w"> </span><span class="p">[]</span><span class="w">
  </span><span class="s">"Loads all the migrations"</span><span class="w">
  </span><span class="p">(</span><span class="nb">doseq</span><span class="w"> </span><span class="p">[</span><span class="n">file</span><span class="w"> </span><span class="p">[</span><span class="s">"schema/0001-init.edn"</span><span class="w">
                </span><span class="s">"schema/0002-user-updated.edn"</span><span class="p">]]</span><span class="w">
    </span><span class="p">(</span><span class="nf">db/load-schema</span><span class="w"> </span><span class="n">file</span><span class="p">))</span><span class="w">

</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">load-fixtures</span><span class="w"> </span><span class="p">[]</span><span class="w">
  </span><span class="s">"Loads all the fixtures"</span><span class="w">
  </span><span class="p">(</span><span class="nf">db/load-schema</span><span class="w"> </span><span class="s">"fixtures/test-data.edn"</span><span class="p">))</span><span class="w">

</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">test-fixture</span><span class="w"> </span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nf">db/init</span><span class="p">)</span><span class="w"> </span><span class="c1">;; this function reads the config,</span><span class="w">
            </span><span class="c1">;; creates the DB and populates</span><span class="w">
            </span><span class="c1">;; the global Datomic connection</span><span class="w">

  </span><span class="p">(</span><span class="nf">migrate</span><span class="p">)</span><span class="w">
  </span><span class="p">(</span><span class="nf">load-fixtures</span><span class="p">)</span><span class="w">
  </span><span class="p">(</span><span class="nf">f</span><span class="p">)</span><span class="w">         </span><span class="c1">;; the test is run here</span><span class="w">
  </span><span class="p">(</span><span class="nf">db/delete</span><span class="p">)</span><span class="w"> </span><span class="c1">;; deletes a database</span><span class="w">
  </span><span class="p">(</span><span class="nf">db/stop</span><span class="p">))</span><span class="w">  </span><span class="c1">;; stops the connection</span><span class="w">

</span><span class="p">(</span><span class="nf">use-fixtures</span><span class="w">
  </span><span class="no">:each</span><span class="w">
  </span><span class="n">test-fixture</span><span class="p">)</span><span class="w">

</span></code></pre></div></div>

<p>Now you may write your tests as well:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w">
</span><span class="p">(</span><span class="nf">deftest</span><span class="w"> </span><span class="n">user-may-login</span><span class="w">
  </span><span class="n">...</span><span class="p">)</span><span class="w">

</span><span class="p">(</span><span class="nf">deftest</span><span class="w"> </span><span class="n">user-proceed-checkout</span><span class="w">
  </span><span class="n">...</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>For every test, you will have a database running with all the migrations and
test data loaded.</p>

<p>If you still do not have any tests in your project, I urge you to add them
soon. Without tests, you cannot be sure you do not break anything when changing
the code.</p>

<h2 id="infrastructure-final-touches">Infrastructure (final touches)</h2>

<p>In the final section, I will highlight several important points that relate to
the server management.</p>

<h3 id="setting-up-production-postgres-driven-backend">Setting up production Postgres-driven backend</h3>

<p>Running in-memory Datomic database is fun since it really costs nothing. In
production, you would better set up more reliable backend. Datomic supports
Postgres storage system out from the box. To prepare the database, run the
following SQL scripts:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>su postgres <span class="c"># switch to postgres user</span>
<span class="nb">cd</span> /path/to/datomic/bin/sql
psql &lt; postgres-user.sql
psql &lt; postgres-db.sql
psql datomic &lt; postgres-table.sql
</code></pre></div></div>

<p>The scripts above create a user <code class="language-plaintext highlighter-rouge">datomic</code> with the password <code class="language-plaintext highlighter-rouge">datomic</code>, then the
database <code class="language-plaintext highlighter-rouge">datomic</code> with the owner <code class="language-plaintext highlighter-rouge">datomic</code>. The last script creates a special
table to keep Datomic blocks.</p>

<p>Please do not forget to change the standard <code class="language-plaintext highlighter-rouge">datomic</code> password to something more
complicated.</p>

<h3 id="running-the-transactor">Running the transactor</h3>

<p>The following page describes how to <a href="http://docs.datomic.com/run-transactor.html">run a transactor</a> needed by
peer library when you use non-memory data storage. I’m not going to retell it
here. Instead, I will share a bit of config to run it automatically using the
standard <code class="language-plaintext highlighter-rouge">init.d</code> Linux daemon.</p>

<p>Create a file named <code class="language-plaintext highlighter-rouge">datomic.conf</code> in your <code class="language-plaintext highlighter-rouge">my-project/conf</code> directory. Put a
symlink to <code class="language-plaintext highlighter-rouge">/etc/init.d/</code> folder that references that file. Add the following
lines into it:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>description "Datomic transactor"

start on runlevel startup
stop on runlevel shutdown

respawn

setuid &lt;your user here&gt;
setgid &lt;your group here&gt;

chdir /path/to/datomic

script
    exec bin/transactor sql-project.properties
end script
</code></pre></div></div>

<p>There, <code class="language-plaintext highlighter-rouge">/path/to/datomic</code> is a directory where unzipped Datomic installation is
located. <code class="language-plaintext highlighter-rouge">sql-project.properties</code> is a transactor configuration file where you
should specify your Datomic key sent to your email.</p>

<p>Now that you have put a symlink, try the following commands:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>start datomic

status datomic
<span class="c"># datomic start/running, process 5281</span>

<span class="nb">sudo </span>stop datomic
</code></pre></div></div>

<h3 id="console">Console</h3>

<p>Most of RDBS have UI applications to manage the data. Datomic comes with
built-in console that is run as web application. Within those console, you can
examine the schema, perform queries and transactions.</p>

<p>The following template runs a console:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/path/to/datomic/bin/console <span class="nt">-p</span> 8088 &lt;some-alias&gt; &lt;datomic-url-without-db&gt;
</code></pre></div></div>

<p>In my example, the command is:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="si">$(</span>DATOMIC_HOME<span class="si">)</span>/bin/console <span class="nt">-p</span> 8888 datomic <span class="se">\</span>
<span class="s2">"datomic:sql://?jdbc:postgresql://localhost:5432/datomic?user=xxxxx&amp;password=xxxxx"</span>
</code></pre></div></div>

<p>Opening a browser at <code class="language-plaintext highlighter-rouge">http://your-domain:8888/browser</code> will show you a
dashboard.</p>

<p>Some security issues may be mentioned here. The console does not support any
login/password authentication, so it is quite unsafe to run the console on
production server as-is. Implement at least some of the following steps:</p>

<ol>
  <li>Proxy the console with Nginx. It must not be reachable by itself.</li>
  <li>Limit access by a list of IPs. These may be your office or your home only.</li>
  <li>There should be only secure SSL connection allowed, no plain HTTP. Let’s
encrypt would be a great choice (see my <a href="/en/letsencrypt">recent post</a>).</li>
  <li>Add basic/digest authentication to your Nginx config.</li>
</ol>

<p>To run a console as a service, create another <code class="language-plaintext highlighter-rouge">console.conf</code> file in
<code class="language-plaintext highlighter-rouge">/etc/init.d/</code> directory. Use the <code class="language-plaintext highlighter-rouge">datomic.conf</code> file as template. Substitute
the primary command with those one shown above. Now you can run the console only
when you really need it:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>start console
</code></pre></div></div>

<h3 id="backups">Backups</h3>

<p>Making backups regularly is highly important. Datomic installation carries a
special utility to take care of it. You won’t need to make your backups manually
by running <code class="language-plaintext highlighter-rouge">pgdump</code> against Postgres backend. Datomic provides a high-level
backing up algorithm that performs in several threads. In addition, it
supports <a href="https://aws.amazon.com/s3">AWS S3</a> service as a destination point.</p>

<p>A typical backup command looks as follows:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/path/to/datomic/bin/datomic <span class="nt">-Xmx4g</span> <span class="nt">-Xms4g</span> backup-db &lt;datomic-url&gt; &lt;destination&gt;
</code></pre></div></div>

<p>To access AWS servers, you need to export both <code class="language-plaintext highlighter-rouge">AWS_ACCESS_KEY_ID</code> and
<code class="language-plaintext highlighter-rouge">AWS_SECRET_KEY</code> variables first or prepend a command with them. In my case, the
full command looks something like:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">AWS_ACCESS_KEY_ID</span><span class="o">=</span>xxxxxx <span class="nv">AWS_SECRET_KEY</span><span class="o">=</span>xxxxxxx <span class="se">\</span>
/path/to/datomic/bin/datomic <span class="nt">-Xmx4g</span> <span class="nt">-Xms4g</span> backup-db <span class="se">\</span>
datomic:sql://xxxxxxxx?jdbc:postgresql://localhost:5432/datomic?user<span class="o">=</span>xxxxxx&amp;password<span class="o">=</span>xxxxxxx<span class="s2">" </span><span class="se">\</span><span class="s2">
s3://secret-bucket/datomic/2017/07/04
</span></code></pre></div></div>

<p>The date part in the end is substituted automatically using <code class="language-plaintext highlighter-rouge">$(shell date
+\%Y/\%m/\%d)</code> expression in Makefile or the following in bash:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">date_path</span><span class="o">=</span><span class="sb">`</span><span class="nb">date</span> +<span class="se">\%</span>Y/<span class="se">\%</span>m/<span class="se">\%</span>d<span class="sb">`</span> <span class="c"># 2017/07/04</span>
</code></pre></div></div>

<p>Add that command into your crontab file to make backups regularly.</p>

<h3 id="backups-as-a-way-to-deploy-the-data">Backups as a way to deploy the data</h3>

<p>The good news are backup’s structure does not depend on the backend type. No
matter you dump in-memory storage or Postgres cluster, the backup can be
restored everywhere as well. It gives us possibility to migrate the data on our
local machine, make a backup and then restore it into production database.</p>

<p>Once you finished migrating you data, launch the backup command described
above. The backup should go to S3. On the server, run the <code class="language-plaintext highlighter-rouge">restore</code> command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">AWS_ACCESS_KEY_ID</span><span class="o">=</span>xxxxx <span class="nv">AWS_SECRET_KEY</span><span class="o">=</span>xxxxx
/path/to/datomic/bin/datomic <span class="nt">-Xmx4g</span> <span class="nt">-Xms4g</span> restore-db <span class="se">\</span>
s3://secret-bucket/datomic/2017/07/04 <span class="se">\</span>
<span class="s2">"datomic:sql://xxxxxxx?jdbc:postgresql://localhost:5432/datomic?user=xxxx&amp;password=xxxxx"</span>
</code></pre></div></div>

<p>When everything is done without mistakes, the server will catch the new data.</p>

<h2 id="conclusion">Conclusion</h2>

<p>After spending about a week on moving from Postgres to Datomic I can say it
really worths it. Although Datomic does not support most of the Postgres smart
features like geo-spatial data or JSON structures, it is much closer to Clojue
after all. Since it was made by the same authors, Datomic looks like as a
continuation of Clojure. And that is a huge benefit that may overweight
disadvantages mentioned above.</p>

<p>Surfing the Internet, I found the next links that may also be helpful:</p>

<ul>
  <li><a href="http://jkk.github.io/minor-victory-datomic">A Minor Victory with Datomic</a></li>
  <li><a href="http://mcramm.com/post/datomic-setup/">Datomic Setup</a></li>
  <li><a href="https://blog.clubhouse.io/using-datomic-heres-how-to-move-from-postgresql-to-dynamodb-local-79ad32dae97f">Using Datomic? Here’s How to Move from PostgreSQL to DynamoDB Local</a></li>
</ul>

<p>I hope you enjoyed reading this material. You are welcome to share your thoughts
in the commentary section.</p>

                
            </div>

        </li>
        
    </ul>

    <h4>
        
        <a href="/page47" class="previous">&larr;</a>
        
        <span class="page_number ">Страница 48 из 80</span>
        
        <a href="/page49" class="next">&rarr;</a>
        
    </h4>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Ivan Grishaev's blog</li>
          <li><a href="mailto:ivan@grishaev.me">ivan@grishaev.me</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
            <li><a href="https://github.com/igrishaev">GitHub</a></li>
            <li><a href="tg://resolve?domain=igrishaev_blog">Telegram</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Writing on programming, education, books and negotiations.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
