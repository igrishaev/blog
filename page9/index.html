<!DOCTYPE html>
<html lang="ru">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Ivan Grishaev's blog</title>
  <meta name="description" content="Writing on programming, education, books and negotiations.
">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/custom.css">
  <link rel="canonical" href="https://grishaev.me/page9/">
  <link rel="alternate" type="application/rss+xml" title="Ivan Grishaev's blog" href="https://grishaev.me/feed.xml">

  <link rel="shortcut icon" type="image/x-icon" href="/assets/static/favicons/favicon.ico">

  <script type="text/javascript" src="/assets/typo.js"></script>

</head>


  <body>
    <header class="site-header">

    <div class="wrapper flex-container">

        <div>
            <a href="/">
                <img id="avatar" src="/assets/static/avatar.jpg" alt="Ivan Grishaev">
            </a>
        </div>

        <div class="flex-container-vert" style="margin-left: 15px; width: 80%">

            <div class="flex-container full-width">
                <p style="margin-bottom: 5px">Ivan Grishaev's blog</p>
                <div class="flex-huge"></div>
                <div >
<form id="search-form"
      target="_blank"
      style="display: inline"
      method="get"
      action="https://www.google.com/search">

    <input name="sitesearch"
           value="grishaev.me"
           type="hidden">

    <input type="text"
           required="required"
           name="q"
           placeholder="Google search..."
           autocomplete="off">

    <button style="border: none; background-color: transparent; cursor: pointer;"
            type="submit">&#x1f50d;</button>

</form>
</div>
            </div>

            <p><small>Writing on programming, education, books and negotiations.
</small></p>

            <div class="flex-container">
                <a class="menu-item" href="/">Home</a>
                <a class="menu-item" href="/about/">About</a>
                <a class="menu-item" href="/bookshelf/">Bookshelf</a>
                <a class="menu-item" href="/feed.xml">RSS</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor" href="/tag/clojure/">Clojure</a>
                <a class="menu-item minor" href="/tag/emacs/">Emacs</a>
                <a class="menu-item minor" href="/tag/python/">Python</a>
                <a class="menu-item minor" href="/tag/programming/">Programming</a>
                <a class="menu-item minor" href="/interview/">Interview</a>
                <a class="menu-item minor" href="/video/">Video</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor hl" href="/clojure-in-prod/">Книга «Clojure на производстве»</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor hl" href="/clojure-in-prod-2/">Книга «Clojure на производстве», второй том</a>
            </div>

        </div>
    </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="home">

    <ul class="post-list">
        
        <li>

            <h2>
                <a class="post-link" href="/truth/">Правда</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2024-03-10T00:00:00+00:00">
        Mar 10, 2024
    </time>

    <a href="/tag/life/" rel="tag">life</a>, <a href="/tag/truth/" rel="tag">truth</a>

</div>


            <div class="entry">
                
                    <p>Есть фееричное по своей глупости выражение: на правду не обижаются. Это верно:
обижаются не на правду, а на бестактность, грубость, фамильярность, непрошенное
мнение и все то, что сопутствует правде.</p>

<p>Если собеседник обижается на правду, стоит подумать, как лучше ее донести и
вообще — стоит ли ее доносить.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/slack-update/">Дело раскрыто</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2024-03-10T00:00:00+00:00">
        Mar 10, 2024
    </time>

    <a href="/tag/slack/" rel="tag">slack</a>, <a href="/tag/updates/" rel="tag">updates</a>

</div>


            <div class="entry">
                
                    
<p>Однажды я писал о том, что <a href="/slack-outdated/">Слак отказался работать</a> с
интересной формулировкой: устарела операционная система. Я обновил приложение,
но не помогло. Очевидно, Слак захотел доступ к какой-то функции, которой нет в
текущей операционке. Я решил, что эта функция нужна маркетингу или “более
удобным” обновлениям.</p>

<p>Так и вышло!</p>

<p>На ноуте, которым я пользуюсь реже всего, я обновился по самые помидоры, чтобы
знать, к чему готовиться. Накатил операционку, Слак и прочий хлам. И вот что
происходит: когда Слак находит обновление, он хочет поставить его автоматом. Но
не хватает прав, и выскакивает такая модалка:</p>

<p><img src="/assets/static/aws/slack-outdated/1.jpeg" /></p>

<p>Приложи пальчик, а дальше я сама.</p>

<p>Эта модалка действует на всю систему. Она вылазит не в Слаке, а на уровне
операционки. Если бы пишете код, шарите экран, смотрите ютучик — будте готовы,
что в любой момент она вылезет и потребует реакции.</p>

<p>На минуточку: она загораживает все! Вот такой прикол. Через час после закрытия
Слак проделает то же самое, и модалка вылезет опять.</p>

<p>Разумеется, никаких настроек, чтобы это отключить, нет. С трудом нахожу слова в
адрес людей, кто программировал эту дичь. Взята новая высота — или, скорее,
пробито дно.</p>

<p>Но есть способ. Помните я писал про <a href="/firewall/">фаервол Lulu</a>? С его помощью я
отбираю у программ доступ в сеть, в том числе — к обновлениям. Оказалось, нужно
добавить запрет как на картинке, и готово — доступа к обновлениям нет, модалка
не появляется.</p>

<p><img src="/assets/static/aws/slack-outdated/2.jpeg" /></p>

<p>Все довольны, все смеются. Но блядским Слаком все равно стараюсь пользоваться
реже.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/services/">Сервисы</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2024-03-10T00:00:00+00:00">
        Mar 10, 2024
    </time>

    <a href="/tag/services/" rel="tag">services</a>, <a href="/tag/programming/" rel="tag">programming</a>

</div>


            <div class="entry">
                
                    <p>Приходилось работать в проекте со множеством сервисов. Решил пожаловаться, какое
же это неблагодарное дело — выскребать данные по углам, чтобы собрать конфету.</p>

<p>Ощущение, что сервисы делают люди, лишенные эмпатии. Например, есть метод
<code class="language-plaintext highlighter-rouge">get-by-id</code>, чтобы взять сущность по айдишке. Угадайте, сколько сервисов
поддерживают <code class="language-plaintext highlighter-rouge">get-by-idS</code> — получить список по айдишкам? В лучшем случае
половина. У оставшейся половины <code class="language-plaintext highlighter-rouge">get-by-ids</code> возвращает сущности порциями по
сто. Тебе нужно 250? Пиши обертку с пагинацией, <code class="language-plaintext highlighter-rouge">next-page</code>, <code class="language-plaintext highlighter-rouge">limit/offset</code>, вот
это все.</p>

<p>Вызывал сервис несколько тысяч раз? Начинаются разборки “кто нас
дидосит”. Вызывай редко, не больше десяти раз, а еще лучше никогда. И везде
проблемы с сообщением об ошибке. Передал что-то не то — иди смотри логи.</p>

<p>Я согласен с тем, что логику нужно разносить по сервисам. Но сервисы должны
использовать общую шину данных: базу, очередь сообщений, файлы в S3 в конце
концов. Гонять друг другу JSON выглядит хорошо в теории, но на практике — фу.</p>

<p>Условный Постгрес выплюнет миллион записей за доли секунды. Забрать этот же
миллион из другого сервиса — приключение на неделю. Тут и метрики, лимиты,
квоты, сетевые спайки, etc… А когда таких запросов несколько, сервис ложится
спать.</p>

<p>Эти сервисы напоминают современного айтишника: хрупкого, тряпковатого мужчину 25
лет, который чуть что — выгорает. У которого все токсичны и вообще — отстаньте.</p>

<p>Удивляет, что подобные архитектуры строятся намеренно, и их создателям платят
большие деньги. При этом опция “легкий доступ к данным” в архитектуру не входит.</p>

<p>А мне разгребать.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/kargo-2/">Карго-культ (2)</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2024-03-10T00:00:00+00:00">
        Mar 10, 2024
    </time>

    <a href="/tag/kargo/" rel="tag">kargo</a>, <a href="/tag/cult/" rel="tag">cult</a>, <a href="/tag/monkeys/" rel="tag">monkeys</a>

</div>


            <div class="entry">
                
                    <p>В комментариях к <a href="/kargo-1/">прошлой заметке</a> один из читателей заметил, что
эксперимент с обезьянами — выдумка и никогда не проводился. Похоже, он прав!</p>

<p>Впервые эксперимент упоминется в книге <a href="https://www.amazon.com/dp/0875847161">Competing for the Future</a> by Gary
Hamel and C. K. Prahalad. Вот дословная цитата:</p>

<blockquote>
  <p>4 monkeys in a room. In the center of the room is a tall pole with a bunch of
bananas suspended from the top. One of the four monkeys scampers up the pole and
grabs the bananas. Just as he does, he is hit with a torrent of cold water from
an overhead shower. He runs like hell back down the pole without the
bananas. Eventually, the other three try it with the same outcome. Finally, they
just sit and don’t even try again. To hell with the damn bananas. But then, they
remove one of the four monkeys and replace him with a new one. The new monkey
enters the room, spots the bananas and decides to go for it. Just as he is about
to scamper up the pole, the other three reach out and drag him back down. After
a while, he gets the message. There is something wrong, bad or evil that happens
if you go after those bananas. So, they kept replacing an existing monkey with a
new one and each time, none of the new monkeys ever made it to the top. They
each got the same message. Don’t climb that pole. None of them knew exactly why
they shouldn’t climb the pole, they just knew not to. They all respected the
well established precedent. EVEN AFTER THE SHOWER WAS REMOVED!</p>
</blockquote>

<p>Эксперимент зашел публике, и его стали широко использовать. Позже несколько
людей пытались узнать подробности: кто и когда проводил этот эксперимент. Но
один из авторов умер, а второй отвечал отписками через секретаря. Самое
интересное, что удалось из него выжать:</p>

<blockquote>
  <p>Our apologies, but Professor Hamel does not have the original source
information at hand in terms of your request.</p>
</blockquote>

<p>Похоже, эксперимент был выдуман авторами, чтобы придать вес другой
идее. Возможно, они слышали что-то краем уха от зоологов, а остальное
додумали. Надо иметь в виду, что книга написана в 1996 году, когда интернет был
убогим, и проверить информацию было невозможно.</p>

<p>Напоминает историю про 25 кадр, который, в отличие от обезьян, был полностью
развенчан.</p>

<p>Я получил урок, что все популярные истории нужно проверять. Не так уж и трудно
было погуглить несколько минут. Александру, который написал об этом, больше
спасибо.</p>

<p>См. обсуждение на <a href="https://skeptics.stackexchange.com/questions/6828/was-the-experiment-with-five-monkeys-a-ladder-a-banana-and-a-water-spray-condu">Stack Exchange</a>.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/kargo-1/">Карго-культ (1)</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2024-03-10T00:00:00+00:00">
        Mar 10, 2024
    </time>

    <a href="/tag/kargo/" rel="tag">kargo</a>, <a href="/tag/cult/" rel="tag">cult</a>, <a href="/tag/monkeys/" rel="tag">monkeys</a>

</div>


            <div class="entry">
                
                    <p>Возможно, не все знают, как работает карго-культ у обезьян. А это очень
интересно.</p>

<p>В вольер с обезьянами вешают приманку: всякие сласти и ништяки. Если к ней
притронуться, обезьян обливают холодной водой. Из-за своей физиологии им это
очень неприятно, гораздо неприятней, чем людям.</p>

<p>Обезьяны быстро понимают, что приманку трогать нельзя. Когда в вольер
подсаживают новую обезьяну, старожилы запрещают ей приближаться к приманке.</p>

<p>Дальше самое интересное: постепенно из вольера убирают обезьян, которых
обливали. Остаются те, которым только запрещали трогать приманку, но которые не
знают последствий. И все равно: они рьяно запрещают подходить к приманке
новичкам.</p>

<p>Мораль — команда не должна быть обезьянами в вольере. Все запреты нужно время от
времени пересматривать, чтобы не растить карго-культ. Удивляет, как часто я
слышу объяснение в духе “мы делаем так, потому что мы так делаем”. Пусть не все,
но некоторое из этого нужно сесть и пересмотреть.</p>

<p>Сказанное не значит, что нужно быть бунтарем и расшатывать основы. Здоровый
баланс между крайностями — вот что нужно соблюдать.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/google-look/">Лук</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2024-03-10T00:00:00+00:00">
        Mar 10, 2024
    </time>

    <a href="/tag/google/" rel="tag">google</a>, <a href="/tag/interface/" rel="tag">interface</a>, <a href="/tag/io/" rel="tag">io</a>

</div>


            <div class="entry">
                
                    <p><img src="/assets/static/aws/google-look/1.jpeg" /></p>

<p>Что ж, таки подъехал новый лук от Гугла. И не соврали: современный и
прочувственный, что бы это ни значило.</p>

<p>Главное, теперь мы знаем: форму даже с одним импутом можно растянуть на 80
процентов площади. Дизайнерам воздушных интерфейсов взять на заметку.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/ff-update/">Firefox и обновления</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2024-03-10T00:00:00+00:00">
        Mar 10, 2024
    </time>

    <a href="/tag/firefox/" rel="tag">firefox</a>, <a href="/tag/updates/" rel="tag">updates</a>

</div>


            <div class="entry">
                
                    <p>У меня сложные отношения с Firefox. Все как в песне: мое тело говорит да, но мое
сердце говорит нет. Иногда я пытаюсь начать с чистого листа, но Firefox делает
все, чтобы этого не случилось.</p>

<p>Когда вышел Хром, он поразил меня отладочной консолью. Сегодня это норма, но
тогда, десять лет назад, нигде не было такого легкого доступа к сетевым
запросам, логам и реплу Javascript. В FF было что-то на голову ниже, но в виде
плагина, а тут — из коробки. Пока писал, вспомнил — Firebug, вот как он
назывался.</p>

<p>Когда FF догнал Хром плане консоли, я пользовался им какое-то время. Потом
устроился в фирму, где были токены Yubikey. В Хроме они работали из коробки, а
что в FF? Надо скачать и поставить OpenSCP, затем добавить девайс в FF и
прописать путь к бинарнику. Сам он не может. В итоге худо-бедно работало, но с
перебоями и перезапуском браузера. Вернулся в Хром.</p>

<p>Сегодня я работаю в фирме, где тоже выдают Yubikey. Я открыл FF, и он сходу
кидает модалку, которая просит пароль к токену. Минуточку, кто тебя просил? Нет
ни одной вкладки, которая просит авторизации. Зачем кидаешь модалку? Тем более
что токен нужен bash-скрипту для VPN, а в браузере он не используется. Какой-то
бред.</p>

<p><img src="/assets/static/aws/ff-updates/1.jpeg" /></p>

<p>Ладно, стерпим и это. Но с какой-то версии FF запретил опцию “не ставить
обновления”. Либо они ставятся автоматом, либо браузер долбит мозг постоянной
плашкой “вышел апдейт, поставь немедленно”. А у меня пунктик — если программа
кричит об обновлениях, я либо отключаю их, либо не пользуюсь программой. И
отключить никак не выходит.</p>

<p><img src="/assets/static/aws/ff-updates/2.jpeg" /></p>

<p>Я пошел в <code class="language-plaintext highlighter-rouge">about://config</code> и прошелся по всем атрибутам, содержащим “update” в
названии. Таковых нашлось штук двадцать. Менял так и этак, ставил 0, -1 и false
— ничего не помогает. Проклятая плашка регулярно вылазит.</p>

<p>Похоже, опять не судьба выстроить отношения с FF, но я все-таки спрошу. Как в FF
ставить обновления по требованию? Чтобы я нажал “install update” и оно
обновилось, а до этого молчало? Неужели Firefox, наше все, звезда опенсорса и все
такое, больше на это не способен?</p>

<p>Верю, что способен. Вам слово.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/ff-policy/">Firefox и полиси</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2024-03-10T00:00:00+00:00">
        Mar 10, 2024
    </time>

    <a href="/tag/firefox/" rel="tag">firefox</a>, <a href="/tag/policy/" rel="tag">policy</a>, <a href="/tag/updates/" rel="tag">updates</a>

</div>


            <div class="entry">
                
                    <p>На выходных посидел с Firefox. Понял, как заблокировать обновления, а также
много чего другого.</p>

<p>Если коротко: демократия закончилась. Начиная с какой-то версии Firefox перешел
на систему полиси для расширенных настроек. Редактор about:config по-прежнему
работает, но нужно понимать: многие опции теперь — бутафория. Можете до
посинения что-то включать и выключать, эффекта не будет.</p>

<p>Теперь Firefox работает с полиси. Это JSON-файл с директивами, которые включают
ту или иную функцию. По сравнению с about:config преимущество в коллекциях: в
полиси можно задать массив объектов, например, для настройки расширений или
mime-типов, а в <code class="language-plaintext highlighter-rouge">about:config</code> все было плоским.</p>

<p>Полиси описаны в формате JSON, но на Маке используется яблочный формат plist.
Может быть, JSON тоже можно, но я не проверял.</p>

<p>Преимущество полиси в том, что можно задать поведение браузера до последних
мелочей. И все это — в текстовом файле, который хранится в Github. Не нужна
облачная учетка для синхронизации — вы сами решаете, как раскидывать файл по
машинам. Я положил в приватный dotfiles, но приведу копию ниже.</p>

<p>Firefox не пытается оспорить то, что указано в полиси. Если сказано не ставить
обновления — он не ставит. Сказано не проверять браузер по умолчанию — не
проверяет. Никаких попапов, бейджей, нотификаций, алертов, всплывающих полосок и
прочей ахинеи.</p>

<p>Теперь технические шаги. Все примеры будут под мак; на другие системы, думаю,
переложить будет не трудно.</p>

<p>Firefox ищет полиси в разных местах, но самое очевидное — файл <code class="language-plaintext highlighter-rouge">~/Library/
Preferences/org.mozilla.firefox.plist</code>. Опция <code class="language-plaintext highlighter-rouge">EnterprisePoliciesEnabled</code>
означает, использовать ли полиси или пропускать их. Установите ее в истину
командой:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>defaults write ~/Library/Preferences/org.mozilla.firefox EnterprisePoliciesEnabled -bool  TRUE
</code></pre></div></div>

<p>Обратите внимание, что расширение <code class="language-plaintext highlighter-rouge">.plist</code> указывать не нужно.</p>

<p>Чтобы выключить обновления, задайте <code class="language-plaintext highlighter-rouge">DisableAppUpdate</code> в истину:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>defaults write ~/Library/Preferences/org.mozilla.firefox DisableAppUpdate -bool true
</code></pre></div></div>

<p>Перезапустите браузер и откройте About Firefox или настройки — там будет
следующее:</p>

<p><img src="/assets/static/aws/ff-policy/1.jpeg" /></p>

<p><img src="/assets/static/aws/ff-policy/2.jpeg" /></p>

<p>Обновления запрещены, никто не пройдет.</p>

<p>Список полиси можно посмотреть во вкладке <code class="language-plaintext highlighter-rouge">about:policies</code>. Выглядит так:</p>

<p><img src="/assets/static/aws/ff-policy/3.jpeg" /></p>

<p>Назревает два вопроса. Первый: как узнать, какие полиси есть в принципе и их
значения? Второй: ты предлагаешь вводить их в консоли вручную?</p>

<p>Полный список полиси находится <a href="https://mozilla.github.io/policy-templates/">на этой странице</a>, и он довольно
велик. Проще скачать заголовку под вашу систему и поправить руками. Названия
директив говорят сами за себя.</p>

<p>По второму пункту — разумеется, нужно создать файл в редакторе, но в случае с
plist есть нюанс. Файлы plist бывают двух форматов: текстовый и бинарный. В
первом случае это XML с тегами <code class="language-plaintext highlighter-rouge">&lt;plist&gt;</code>, <code class="language-plaintext highlighter-rouge">&lt;dict&gt;</code> и <code class="language-plaintext highlighter-rouge">&lt;key&gt;</code>. Во втором случае
там байты вперемешку с текстом.</p>

<p>Беда в том, что Firefox работает только с бинарным plist: если положить
текстовый, он его игнорирует. Бинарник можно поправить в XCode, но это неудобно:
не станете же вы хранить бинарь в Github и редактировать программой, которой
нужно 15 гигов. К счастью, утилита plutil умеет импорт-экспорт, а заодно
проверяет формат на корректность.</p>

<p>У меня получилась папка в dotfiles со следующими файлами. Прежде всего это
org.mozilla.firefox.plist, который я <a href="https://gist.github.com/igrishaev/4e0603f0129a62c335f2f38676059753">выложил в Gist</a>. Вот неполный список
того, что он делает:</p>

<ul>
  <li>отключает обновления</li>
  <li>отключает проверку браузера по умолчанию</li>
  <li>отключает менеджер паролей, мастер-пароль</li>
  <li>отключает Pocket</li>
  <li>убирает партнерские ссылки, top-sites и прочий шлак на главной</li>
  <li>открывает PDF-файлы в Preview.app. Для меня это важно, потому что встроенные
открывашки PDF, как правило, убогие</li>
  <li>отключает всякий трекинг и фингерпринт</li>
  <li>включает запросы нотификаций, локации</li>
  <li>блокирует попапы</li>
  <li>отключает “что новенького”, рекомендованные расширения, фичи.</li>
</ul>

<p>Второй файл — конфиг Make, чтобы управлять конфигурацией. Он короткий,
приведу полностью:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>DOMAIN = ~/Library/Preferences/org.mozilla.firefox.plist
SOURCE = org.mozilla.firefox.plist

policy-import: policy-check
 defaults import ${DOMAIN} ${SOURCE}

policy-false:
 defaults write ${DOMAIN} EnterprisePoliciesEnabled -bool FALSE

policy-true:
 defaults write ${DOMAIN} EnterprisePoliciesEnabled -bool TRUE

policy-check:
 plutil ${SOURCE}
</code></pre></div></div>

<p>Команда <code class="language-plaintext highlighter-rouge">policy-import</code> переносит настройки из текстового .plist-файла в бинарный в
домашней папке. Она зависит от <code class="language-plaintext highlighter-rouge">policy-check</code>, которая проверяет конфигурацию на
корректность.</p>

<p>Команды <code class="language-plaintext highlighter-rouge">policy-false</code> и <code class="language-plaintext highlighter-rouge">policy-true</code> отключают и включают полиси. Дело в том,
что пока они включены, вы не можете обновиться даже если захотите — функция
запрещена. Чтобы это сделать, отключите полиси, перезапустите браузер,
обновитесь, затем снова включите. На короткое время ужаснитесь тому, как жили
раньше: браузер выплюнет сто попапов, что пора обновиться, сделать его главным
по умолчанию, а вот здесь у нас новая менюшка, а вот новое расширение, ну и все
такое.</p>

<p>В общем, разобраться с полиси было полезно. По аналогии с Емаксом и прочими
утилитами, я храню конфиг в дотфайлах и синхронизирую через Гитхаб. Опасение
вызывает лишь то, что полиси все еще на этапе разработки. Не ровен час,
обновишься — и все слетит.</p>

<p>Вроде бы хороший конец, но все равно — с толикой грусти. Эта борьба вызвана тем,
что некие придурки спрятали опции из интерфейса. Не будь придурков — не было бы
суеты, конфигов и прочего. Энтропия и трение — вот есть то, что здесь описано.</p>

<p>Напоследок — ссылки:</p>

<ul>
  <li><a href="https://mozilla.github.io/policy-templates/">Официальный список полиси</a></li>
  <li><a href="https://github.com/mozilla/policy-templates/blob/master/mac/org.mozilla.firefox.plist">Готовые шаблоны</a></li>
  <li><a href="https://gist.github.com/igrishaev/4e0603f0129a62c335f2f38676059753">Мой конфиг</a></li>
</ul>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/foles-mac-to-win/">Файлы с мака на винду</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2024-03-10T00:00:00+00:00">
        Mar 10, 2024
    </time>

    <a href="/tag/mac/" rel="tag">mac</a>, <a href="/tag/windows/" rel="tag">windows</a>, <a href="/tag/fat32/" rel="tag">fat32</a>

</div>


            <div class="entry">
                
                    <p>Небольшая заметка, чтобы в будущем не искать в интернете.</p>

<p>Предположим, нужно перенести большой файл с мака на виндоуз. Сеть не настроена,
файлы не пошарены, настроить все это займет час. В распоряжении есть флешка
большой емкости, но вот засада:</p>

<ul>
  <li>
    <p>файловая система NTFS на маке работает только для чтения;</p>
  </li>
  <li>
    <p>яблочная файловая система APFS не видна в винде;</p>
  </li>
  <li>
    <p>файловая система FAT32 работает в обоих средах, но не поддерживает файлы
больше двух гигабайт.</p>
  </li>
</ul>

<p>Что же делать? Можно поставить продвинутый архиватор с поддержкой
мульти-архивов. Это когда архив делится на тома foobar.zip.01, 02 и так далее
заданной величины. Но ставить софт очень не хочется.</p>

<p>Оказывается, все утилиты есть в коробке. На маке делаем так:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>split -b 2024m SomeMovie.mkv SomeMovie.mkv.
</code></pre></div></div>

<p>Последний аргумент с точкой — шаблон нарезанных кусков. К ним будут добавлены
строки aa, ab, ac и так далее для правильной сортировки. Если исходный файл был
5 гигабайтов, получатся файлы <code class="language-plaintext highlighter-rouge">SomeMovie.mkv.aa</code>, <code class="language-plaintext highlighter-rouge">SomeMovie.mkv.ab</code> и
<code class="language-plaintext highlighter-rouge">SomeMovie.mkv.ac</code>.</p>

<p>Скидываем все добро на флешку, и теперь с FAT32 не будет проблем, потому что
каждый кусок не превышает два гига. Чтобы собрать файл на винде, запускаем
команду:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>copy /b SomeMovie.mkv.* SomeMovie.mkv
</code></pre></div></div>

<p>Очевидно, это нужно делать не на флешке, а на жестком диске. Можно положить
рядом батник, если собирать будете не вы.</p>

<p>Польза способа в том, что не нужен сторонний софт, права администратора и прочая
ахинея. Просто работает.</p>

<p><strong>UPD</strong>: в комментариях к написли про exFat, а я про него как-то
забыл. Действительно, с ним все работает. Поэтому все, что описано выше,
пригодится, если флешка мала. Например, когда нужно перетащить файл на 16 гигов,
а флешка только два.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/aws-3/">AWS, история третья. Разрывы</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2024-03-10T00:00:00+00:00">
        Mar 10, 2024
    </time>

    <a href="/tag/aws/" rel="tag">aws</a>, <a href="/tag/cloud/" rel="tag">cloud</a>, <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/athena/" rel="tag">athena</a>, <a href="/tag/s3/" rel="tag">s3</a>

</div>


            <div class="entry">
                
                    <p>Все статьи из цикла AWS</p>

<ul>
  <li><a href="/aws-0/">Амазон</a></li>
  <li><a href="/aws-1/">AWS, история первая. Внезапный мегабайт</a></li>
  <li><a href="/aws-2/">AWS, история вторая. Афина прекрасная</a></li>
  <li><a href="/aws-3/">AWS, история третья. Разрывы</a></li>
  <li><a href="/aws-4/">AWS, история четвертая. Когда null не совсем null</a></li>
</ul>

<p>В третьей истории расскажу, как я страдал от сетевых проблем в Амазоне. Как
абонент Уральский: раньше не было разрывов, а теперь есть разрывы.</p>

<p>У нас в проекте много лямбд, и каждая вызывает другие. При таком раскладе
невыгодно передавать результат напрямую. Можно использовать S3 как шину
данных. Например, одна лямбда вызывает другую и говорит: положи результат в
такой-то бакет и файл. Затем опрашивает файл, пока он не появится.</p>

<p>Это удобно, когда результат огромен: иные лямбды производят CSV-шки по нескольку
гигабайт. Не гонять же их напрямую между лямбдами. Но файлы привносят хаос: не
всегда очевидно, кто произвел файл и кто его потребители. Если изменить путь,
через день придет коллега из другого сервиса и скажет: мы каждый день забираем
файл из этой папки, куда он делся? Или наоборот: ты обнаружил, что некий сервис
производит удобный файл, в котором все есть. Через месяц он перестал появляться,
потому что они переехали на что-то другое. Мы вам ничего не обещали.</p>

<p>Файлы CSV удобно стримить прямо из S3. Послал GET-запрос, получил InputStream.
Передал его в парсер и готово: получается ленивая коллекция кортежей. Навесил на
нее map/filter, все обработалось как нужно, красота. Не нужно сохранять файл на
диск.</p>

<p>То же самое с форматом JSONL, где каждая строка — отдельный объект JSON. Из
стрима получаешь Reader, из него ленивый line-seq, и пошел колбасить.</p>

<p>Неожиданно это схема перестала работать с большими файлами. Где-то на середине
цикл обрывается с IOException. Чего я только не пробовал: оборачивал стрим в
BufferedInputStream с разным размером, засекал время обработки, передавал опции
в к S3… ничего не помогло. Запросы в Гугл тоже ничего внятного выдали.</p>

<p>У меня подозрение, что дело в неравномерном чтении. Когда вы читаете файл,
Амазон определяет скорость забора байтиков. Поскольку мы читаем и обрабатываем
стрим в одном потоке, чтение чередуется с простоем на обработку данных. В
больших файлах я нашел записи, которые больше других во много раз.  Возможно,
что когда обработка доходила до них, ожидание было больше среднего, и Амазон
закрывал соединение.</p>

<p>Я пытался повторить это на публичных файлах S3: читал в цикле N байтов и где-то
на середине ставил длинный Thread/sleep. Но S3 покорно ждал аж две минуты, и
эксперимент провалился.</p>

<p>Словом, я так и не выяснил, почему вылазит IOException, но смог это исправить в
два шага.</p>

<p>Первый — файл S3 тупо записывается во временный файл, и дальше с ним работаешь
локально. Перенос стрима делается одним методом <code class="language-plaintext highlighter-rouge">InputStream.transferTo</code>. Во
время переноса ошибки связи не возникают.</p>

<p>Второй — иные агрегаты достигают 3.5 гигабайтов, а у лямбды ограничение на 10
гигабайтов места. Скачал три агрегата — и привет, out of disk space. Поэтому при
записи файл кодируется Gzip-ом, а при чтении — декодируется обратно.</p>

<p>Все вместе дало мне функцию, которая:</p>

<ul>
  <li>посылает запрос к S3, получает стрим</li>
  <li>создает временный файл</li>
  <li>переносит стрим в файл, попутно сжимая Gzip-ом</li>
  <li>возвращает <code class="language-plaintext highlighter-rouge">GzipInputStream</code> из файла</li>
</ul>

<p>Со стороны кажется, что вызвал <code class="language-plaintext highlighter-rouge">get-s3-reader</code> — и байтики потекли, делов-то. А
внутри вот какие штучки.</p>

<p>Примечательно, что в одном проекте я сам спровоцировал
<code class="language-plaintext highlighter-rouge">IOException</code>. Разработчик до меня позаботился о переносе файла S3 во временный
файл. Я подумал, что он просто не знает, как обработать данные из сети и убрал
запись на диск. Возможно, он что-то знал, но не оставил комментария. А надо
было!</p>

<p>Из этой истории следует: никогда не обрабатывайте файл S3 сразу из сети.
Сохраните его во временный файл и потом читайте локально — так надежней. Рано
или поздно вы схватите <code class="language-plaintext highlighter-rouge">IOException</code>, а на расследование будет времени. Чтобы
сэкономить диск, оберните файл в Gzip.</p>

<hr />

<p>На этом я закончу истории про Амазон. У меня есть еще несколько, но они не такие
интересные и сводятся к тезису “думал так, а оно эдак”. Ну и обсасывать одну и
ту же тему уже не хочется.</p>

<p>Думаю, вы поняли, что в Амазоне хватает странностей. Это не баги, потому что все
они описаны в документации. Примерно как в Javascript: никто не знает, почему
<code class="language-plaintext highlighter-rouge">{} + [] = 0</code>, а <code class="language-plaintext highlighter-rouge">[] + {} = [object Object]</code>. Да, в стандарте описано, но кому
от этого легче?  Выбирая Амазон, закладывайте время и деньги на подобные
непонятки.</p>

                
            </div>

        </li>
        
    </ul>

    <h4>
        
        <a href="/page8" class="previous">&larr;</a>
        
        <span class="page_number ">Страница 9 из 81</span>
        
        <a href="/page10" class="next">&rarr;</a>
        
    </h4>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Ivan Grishaev's blog</li>
          <li><a href="mailto:ivan@grishaev.me">ivan@grishaev.me</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
            <li><a href="https://github.com/igrishaev">GitHub</a></li>
            <li><a href="https://t.me/igrishaev_blog">Telegram</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Writing on programming, education, books and negotiations.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
