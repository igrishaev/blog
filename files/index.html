<!DOCTYPE html>
<html lang="ru">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Возня с файлами</title>
  <meta name="description" content="">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/custom.css">
  <link rel="canonical" href="https://grishaev.me/files/">
  <link rel="alternate" type="application/rss+xml" title="Ivan Grishaev's blog" href="https://grishaev.me/feed.xml">

  <link rel="shortcut icon" type="image/x-icon" href="/assets/static/favicons/favicon.ico">

  <script type="text/javascript" src="/assets/typo.js"></script>

</head>


  <body>
    <header class="site-header">

    <div class="wrapper flex-container">

        <div>
            <a href="/">
                <img id="avatar" src="/assets/static/avatar.jpg" alt="Ivan Grishaev">
            </a>
        </div>

        <div class="flex-container-vert" style="margin-left: 15px; width: 80%">

            <div class="flex-container full-width">
                <p style="margin-bottom: 5px">Ivan Grishaev's blog</p>
                <div class="flex-huge"></div>
                <div >
<form id="search-form"
      target="_blank"
      style="display: inline"
      method="get"
      action="https://www.google.com/search">

    <input name="sitesearch"
           value="grishaev.me"
           type="hidden">

    <input type="text"
           required="required"
           name="q"
           placeholder="Google search..."
           autocomplete="off">

    <button style="border: none; background-color: transparent; cursor: pointer;"
            type="submit">&#x1f50d;</button>

</form>
</div>
            </div>

            <p><small>Writing on programming, education, books and negotiations.
</small></p>

            <div class="flex-container">
                <a class="menu-item" href="/">Home</a>
                <a class="menu-item" href="/about/">About</a>
                <a class="menu-item" href="/bookshelf/">Bookshelf</a>
                <a class="menu-item" href="/feed.xml">RSS</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor" href="/tag/clojure/">Clojure</a>
                <a class="menu-item minor" href="/tag/emacs/">Emacs</a>
                <a class="menu-item minor" href="/tag/python/">Python</a>
                <a class="menu-item minor" href="/tag/programming/">Programming</a>
                <a class="menu-item minor" href="/interview/">Interview</a>
                <a class="menu-item minor" href="/video/">Video</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor hl" href="/clojure-in-prod/">Книга «Clojure на производстве»</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor hl" href="/clojure-in-prod-2/">Книга «Clojure на производстве», второй том</a>
            </div>

        </div>
    </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">

    <h1 class="post-title" itemprop="name headline">Возня с файлами</h1>

    
<div class="post-meta">

    <time class="post-time"
          datetime="2022-03-20T00:00:00+00:00">
        Mar 20, 2022
    </time>

    <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/files/" rel="tag">files</a>, <a href="/tag/s3/" rel="tag">s3</a>, <a href="/tag/yandex/" rel="tag">yandex</a>, <a href="/tag/amazon/" rel="tag">amazon</a>

</div>


  </header>

  <div class="post-content" itemprop="articleBody">
    
<p>В одной из прошлых заметок <a href="/cron-mail/">я рассказал</a>, как настроить cron с отправкой почты на свой ящик. В завершении обещал уточнить, для каких конкретно целей я использую крон, но не сделал этого. Исправляюсь.</p>

<p>Если коротко, с помощью крона я бекаплю файловый архив. До недавнего времени пользовался S3, но из-за последних событий вынужден переезжать. Ниже — мои изыскания на тему хранения файлов.</p>

<p>Полагаю, у каждого из нас есть архив личных файлов. Как правило, это фотографии с первой мыльницы, код с прошлых проектов или просто файлы, которые приятно иной раз посмотреть. Например, сделанный своими руками ролик про университет, первые работы в рекламе или в типографии.</p>

<p>Кроме фоток, крайне важны сканы документов. Паспорт, загран, снилс, ИНН и так далее. Все то же самое для жены и троих детей, плюс свидетельства о рождении. Полноценный скан документа (именно скан, а не фотка) неистово полезен. Распечатать его на принтере занимает минуту, а поход в ближайший копицентр — двадцать минут. Когда после рождения третьей дочки бегал по инстанциям, идею со сканами я просто боготворил: в каждую дверь нужно сдать пачку копий, а таких дверей десятки.</p>

<p>Из-за уникальности файлов возникает вопрос, где их хранить. Техника недолговечна: нельзя доверять даже жестким дискам, не то что флешкам. Если архив лежит в нескольких местах, должна быть синхронизация, иначе убьешся синхронизировать вручную.</p>

<p>До недавнего времени вопрос не стоял остро: бери любое облачное хранилище и вперед: дропбокс, яндекс-драйв, гугло-драйв, айклауд. Но даже до “спецоперации” и отвала русских пользователей ни один из этих сервисов мне не подошел. Все они намертво завязаны на конкретный бренд и любят выкручивать мозг. О деградации того же дропбокса я писал неоднократно (<a href="/dropbox-ui/">раз</a>, <a href="/design-dropbox/">два</a>), и аналоги ничуть не лучше.</p>

<p>Основная претензия с синхронизаторам файлов — интерфейс, точнее желание его не видеть. Хочется, чтобы ни при каких условиях не вылазил попап или окошко на электроне. Чтобы в углу не маячили уведомления, которые забыл выключить. Чтобы не оценивать сервис по десятибалльной шкале. Словом — настроил и забыл.</p>

<p>Я попробовал AWS S3, и неожиданно понравилось: все происходит молча, разве что в раз в месяц получаю счет. Настроить просто: ставим <a href="https://aws.amazon.com/cli/">питонячий AWS CLI</a>. Далее прописываем креды и настройки в файлах:</p>

<div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ~/.aws/config
</span>
<span class="nn">[default]</span>
<span class="py">region</span> <span class="p">=</span> <span class="s">us-east-1</span>
<span class="py">output</span> <span class="p">=</span> <span class="s">json</span>

<span class="c"># ~/.aws/credentials
</span>
<span class="nn">[default]</span>
<span class="py">aws_access_key_id</span> <span class="p">=</span> <span class="s">...</span>
<span class="py">aws_secret_access_key</span> <span class="p">=</span> <span class="s">...</span>
</code></pre></div></div>

<p>Если теперь выполнить команду <code class="language-plaintext highlighter-rouge">s3 sync</code>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>aws s3 <span class="nb">sync </span>my-bucket s3://my-bucket <span class="nt">--delete</span>
</code></pre></div></div>

<p>, то произойдет синхронизация файлов из первого источника (папки) во второй (бакет). Флаг <code class="language-plaintext highlighter-rouge">--delete</code> означает, что файлы, которых нет в источнике, будут удалены в удаленном хранилище. Другими словами, если удалили локальный файл, то при синхронизации он будет удален и в S3. Без флага происходит простое слияние файлов.</p>

<p>Вот как оформить все это дело в кронтаб:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">BUCKET</span><span class="o">=</span>my-bucket

0 <span class="k">*</span>/3 <span class="k">*</span> <span class="k">*</span> <span class="k">*</span> <span class="nb">cd</span> /Users/ivan/s3 <span class="o">&amp;&amp;</span> aws s3 <span class="nb">sync</span> <span class="k">${</span><span class="nv">BUCKET</span><span class="k">}</span> s3://<span class="k">${</span><span class="nv">BUCKET</span><span class="k">}</span> <span class="nt">--exclude</span> <span class="s1">'*.DS_Store'</span> <span class="nt">--delete</span> <span class="o">&amp;&amp;</span> <span class="nb">echo </span>OK
</code></pre></div></div>

<p>Для удобства я назвал локальную папку так же, что и бакет, чтобы ссылаться на переменную.</p>

<p>Вопрос в том, насколько часто запускать синхронизацию. Раньше я делал это каждые три часа (<code class="language-plaintext highlighter-rouge">0 */3 ...</code>), но со временем понял, что это слишком часто. На практике хватает двух раз в день: в обед и вечером (<code class="language-plaintext highlighter-rouge">0 12,22 ...</code>).</p>

<p>О результатах синхронизации я узнаю по письму следующего содержания:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Subject: Cron &lt;ivan@ivan&gt; cd /Users/ivan/s3 &amp;&amp; aws s3 sync ...

Completed 60.5 KiB/~60.5 KiB (34.3 KiB/s) with ~1 file(s) remaining (calculating...)
upload: my-bucket/docs/text/links.md to s3://my-bucket/docs/text/links.md
Completed 60.5 KiB/~60.5 KiB (34.3 KiB/s) with ~0 file(s) remaining (calculating...)

OK
</code></pre></div></div>

<p>Про деньги: хранение 130 гигабайт с синхронизацией каждые 3 часа стоит 4.6 доллара в месяц. Это дешевле дропбокса и и аналогов с интерфейсом. Важное преимущество в том, что платишь в точности за те ресурсы, что потребляешь. Никаких обрыдлых подписок.</p>

<p>С началом “не-войны” Амазон начал вести себя странно. Файлы по-прежнему доступны, но теперь я не могу войти в консоль управления. Амазон требует ввести код, отправленный на телефон, но сообщения не приходят. Не работают и другие способы его получить, например голосовым звонком робота. Запросил восстановление двухфакторной авторизации, но что-то Амазон не спешит.</p>

<p>Написали бы прямо: не работаем с проклятыми фашистами и агрессорами, и я бы все понял. Не дожидаясь отвала файлов, решил мигрировать, тем более что все равно нельзя оплатить российской картой.</p>

<p>Приятная вещь: S3 уже давно не монополист в области хранения файлов, и многие фирмы выкатили свои решения. Которые, кстати, работают по протоколу S3. Файловые хранилища предлагают DigitalOcean, Exoscale, Яндекс.Облако. Будучи в Exoscale, я, хоть и немного, но работал над хранилищем.</p>

<p>Миграция сводится к тому, чтобы перенацелить клиент AWS на другой сервис. По понятным причинам выбрал Яндекс — западные партнеры сейчас не подходят. Регистрируемся на <code class="language-plaintext highlighter-rouge">cloud.yandex.ru</code>, переходим в Object Storage. Создаем бакет. Советую холодный тип хранения, потому что читать файлы вы будете редко, а синхронизация работает по методу HEAD — через метаданные.</p>

<p>Когда бакет создан, понадобится пара открытый-закрытый ключ. Как слепой щенок, долго я мыкался по интерфейсу, пока не нашел “сервисные аккаунты”. Создайте новую пару и сохраните ключи. Добавьте в настройки клиента AWS секции:</p>

<div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ~/.aws/config
</span>
<span class="nn">[ya]</span>
<span class="py">region</span> <span class="p">=</span> <span class="s">ru-central1</span>
<span class="py">output</span> <span class="p">=</span> <span class="s">json</span>

<span class="c"># ~/.aws/credentials
</span>
<span class="nn">[ya]</span>
<span class="py">aws_access_key_id</span> <span class="p">=</span> <span class="s">...</span>
<span class="py">aws_secret_access_key</span> <span class="p">=</span> <span class="s">...</span>
</code></pre></div></div>

<p>Теперь выполните:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>aws <span class="nt">--profile</span> ya <span class="nt">--endpoint-url</span><span class="o">=</span>https://storage.yandexcloud.net s3 <span class="nb">sync</span> ...
</code></pre></div></div>

<p>, и файлы польются в Яндекс. К сожалению, в настройких нельзя задать свой <code class="language-plaintext highlighter-rouge">endpoint-url</code>, поэтому приходится таскать его за собой в командной строке. Народные умельцы сделали <a href="https://github.com/wbingli/awscli-plugin-endpoint">плагин</a>, который это фиксит, но я не проверял.</p>

<p>Как закончится синхронизация, удалите старые файлы из Амазона:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>aws s3 <span class="nb">rm </span>s3://my-bucket <span class="nt">--recursive</span>
</code></pre></div></div>

<p>Поздравляю, вы переехали. Осталось только исправить <code class="language-plaintext highlighter-rouge">crontab</code>, чтобы синхронизация стала регулярной.</p>

<p>У питонячьего AWS-клиента есть недочет: при синхронизации он оставляет на сервере пустые папки. Предположим, вы удалили папку “photos”, и AWS CLI честно выполнит DELETE для каждого файла:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>DELETE photos/IMG_001.jpeg
DELETE photos/IMG_002.jpeg
DELETE photos/IMG_003.jpeg
...
</code></pre></div></div>

<p>Что касается пути “photos/”, то он благополучно останется на сервере. Ясное дело, что со временем накопится масса таких пустышек, и скачав файлы с S3, вы обнаружите папки, удаленные давным давно. На эту тему <em>пять лет назад</em> создан <a href="https://github.com/aws/aws-cli/issues/2685">issue</a>, в котором отметился и ваш покорный слуга. Каждый месяц я получаю письма с комментариями +1 и пальчиком кверху, но исправлять его никто не спешит.</p>

<p>Впрочем, удалить пустые папки можно командой</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>find <span class="nb">.</span> <span class="nt">-type</span> d <span class="nt">-empty</span> <span class="nt">-delete</span>
</code></pre></div></div>

<p>, что не такая уж и проблема.</p>

<p>Согласно <a href="https://cloud.yandex.ru/prices">калькулятору Яндекса</a>, хранение 150 гигов обойдется в 215 рублей в месяц, что, прямо скажем, по-божески. По текущему курсу это два доллара, дешевле даже представить нельзя.</p>

<p>Во время изысканий я в том числе пробовал программу <a href="https://syncthing.net/">SyncThing</a>. Кто не знает, это программа для анонимной синхронизации файлов. Никаких регистраций: поставил у себя и на удаленной машине, обменялся QR-кодами, и процесс пошел. Работает как часы. Висит в трее, настройки через браузер на локальном хосте.</p>

<p>На мой взгляд, SyncThing подходит в тех случаях, когда файлы постоянно меняются, и изменений ждут на обоих концах. Например, обмен документами между группой лиц или торрент-трекер, ожидающий файлы в нужной папке. Перекинуть файл с макбука на игровой комп — тот еще челендж, если настраивать сеть по правилам. А со SyncThing работает прекрасно. Словом, замена старому доброму Дропбоксу.</p>

<p>А вот делать бекапы через SyncThing как-то не зашло. Для этого нужно поднимать VPS и ставить там SyncThing. Виртуалки с большим диском нынче от 700 рублей в месяц. Не катастрофа, но выбор между 200 и 700 рублями в месяц очевиден. Да и заморачиваться не охота.</p>

<p>В общем, вот как я синхронизирую файлы. Слово читателям: расскажите, как делаете это вы.</p>

<p><strong>UPD:</strong> <a href="/files2/">продолжение</a>.</p>

  </div>

</article>

<center>
    <p>
        <small>Нашли ошибку? Выделите мышкой и нажмите Ctrl/&#8984;+Enter</small>
    </p>
</center>






<center>Комментарии</center>

<div id="comments">
  
    <div id="comment-5798625738" class="comment-block">
      <p class="comment-lead">
        <small>
          <em>
            Dmitry Pronin,
            21st Mar 2022,
            <a href="#comment-5798625738">link</a>
            
          </em>
        </small>
      </p>
      <div><p>Когда синхронизировал файлы Android - Mac - PC с помощью SyncThing, обнаружил критичные баги, связанные с  именами файлов. Точно проблему не вспомню. Вроде есть issue, проблема не нова. Так что с SyncThing надо быть осторожнее.</p>
<p>Кстати, для андроида использую FolderSync + WebDAV от Яндекс. Своя база знаний, мемы и markdown заметки всегда под рукой.</p>
</div>
    </div>
  
    <div id="comment-5798646423" class="comment-block">
      <p class="comment-lead">
        <small>
          <em>
            Ivan Grishaev,
            21st Mar 2022,
            <a href="#comment-5798646423">link</a>
            , <a href="#comment-5798625738">parent</a>
          </em>
        </small>
      </p>
      <div><p>Спасибо, буду знать про SyncThing. WebDAV тоже пользовался, и кстати, огромный плюс в том, что его можно подключить как сетевой диск. Вот только помню, что в таком режиме он порой сильно тормозил. Прямо каноничный пример текущей абстракции по Спольски (у него как раз пример с сетевым диском).</p>
</div>
    </div>
  
    <div id="comment-5798652538" class="comment-block">
      <p class="comment-lead">
        <small>
          <em>
            Viktor,
            21st Mar 2022,
            <a href="#comment-5798652538">link</a>
            
          </em>
        </small>
      </p>
      <div><p>По описанию SyncThing похожа на "Resilio Sync Home" (пользуюсь время от времени).</p>
</div>
    </div>
  
    <div id="comment-5806802078" class="comment-block">
      <p class="comment-lead">
        <small>
          <em>
            Andy,
            26th Mar 2022,
            <a href="#comment-5806802078">link</a>
            
          </em>
        </small>
      </p>
      <div><p>I admire your pragmatism but it is actually a real war.</p>
<p>Don't know if you can read this source but this is the "not-war" you talk about.</p>
<p><a href="https://www.theguardian.com/world/2022/mar/25/mariupol-diary-entries-besieged-ukraine" rel="nofollow noopener" title="https://www.theguardian.com/world/2022/mar/25/mariupol-diary-entries-besieged-ukraine">https://www.theguardian.com...</a></p>
</div>
    </div>
  
    <div id="comment-5807137978" class="comment-block">
      <p class="comment-lead">
        <small>
          <em>
            Paul,
            26th Mar 2022,
            <a href="#comment-5807137978">link</a>
            
          </em>
        </small>
      </p>
      <div><p>Для бэкапов использую restic. Он умеет работать с rclone в качестве бэкенда, что позволяет сделать шифрованные бэкапы на множество бесплатных и не очень облаков. Rclone сам по себе тоже штука очень полезная, может шифрованные директории в облаках организовать.<br />А для синхронизации ПК и телефона Syncthing. В последних версиях он научился в так называемые untrusted remotes, так что можно любой vps для более надёжной синхронизации добавить.</p>
</div>
    </div>
  
    <div id="comment-5807261642" class="comment-block">
      <p class="comment-lead">
        <small>
          <em>
            Ivan Grishaev,
            26th Mar 2022,
            <a href="#comment-5807261642">link</a>
            , <a href="#comment-5807137978">parent</a>
          </em>
        </small>
      </p>
      <div><p>Точно, про restic знал, но как-то забыл. Судя по докам, он без проблем бекапит в S3-совместимые сервисы. Как-нибудь попробую.</p>
</div>
    </div>
  
    <div id="comment-5807272564" class="comment-block">
      <p class="comment-lead">
        <small>
          <em>
            Ivan Grishaev,
            26th Mar 2022,
            <a href="#comment-5807272564">link</a>
            , <a href="#comment-5806802078">parent</a>
          </em>
        </small>
      </p>
      <div><p>Andy, you're missing some context that my Russian readers are aware about. In Russia, it's strictly prohibited to name the Ukrainian events as "war". Instead, our government proposes such terms as "tactical operation" and like this. People who against the war cannot use that noun directly, so they put the "right terms" in quotes, e.g. "not-war", "operation" and so forth. What is meant by this, "you know I'm talking about the war and I'm agains this".</p>
</div>
    </div>
  
    <div id="comment-5807299616" class="comment-block">
      <p class="comment-lead">
        <small>
          <em>
            Ivan Grishaev,
            26th Mar 2022,
            <a href="#comment-5807299616">link</a>
            , <a href="#comment-5807137978">parent</a>
          </em>
        </small>
      </p>
      <div><p>Спрошу здесь: судя по всему, restic создает какую-то свою структуру папок, где файлы запрятаны под машинными именами. Что как-то не очень, потому что хочется видеть оригинальные имена, папки и остальное. Или я не так понял?</p>
</div>
    </div>
  
    <div id="comment-5807380937" class="comment-block">
      <p class="comment-lead">
        <small>
          <em>
            Shiva the Destroyer,
            26th Mar 2022,
            <a href="#comment-5807380937">link</a>
            
          </em>
        </small>
      </p>
      <div><p>Локального шифрования перед заливом еще не хватает в этом сетапе. Я использую borg (для любителей GUI есть vorta - обертка над ним) - правда с обычной впской. S3 обычно дешевле если много файлов но если нет то удобно. По сравнению с решением в статье есть история, гибкая настройка сколько хранить в месяц/год/последние дни. Есть варик примаунтить конкретную версию как папку через fuse.</p>
</div>
    </div>
  
    <div id="comment-5807861460" class="comment-block">
      <p class="comment-lead">
        <small>
          <em>
            Ivan Grishaev,
            27th Mar 2022,
            <a href="#comment-5807861460">link</a>
            , <a href="#comment-5807380937">parent</a>
          </em>
        </small>
      </p>
      <div><p>Не знаю, мне кажется шифрование тут лишнее. Усложняет процесс, если экстренно понадобится скачать на другой машине.</p>
</div>
    </div>
  
    <div id="comment-1673306851226" class="comment-block">
      <p class="comment-lead">
        <small>
          <em>
            Viktor,
            9th Jan 2023,
            <a href="#comment-1673306851226">link</a>
            
          </em>
        </small>
      </p>
      <div><p>Основная фишка <code class="language-plaintext highlighter-rouge">Borg</code>, для меня, это <em>дедупликация</em>. 
Можно перемещать/переименовывать папки/файлы и <code class="language-plaintext highlighter-rouge">Borg</code> не будет создавать копии уже имеющихся файлов. 
Из-за этого бэкапы очень быстрые.</p>

<p>Насчёт шифрофание, да это усложняет процесс (по сравнению c простым <code class="language-plaintext highlighter-rouge">rsync</code>).
Но с другой стороны, чужая VPS - это всегда риск.
Шифрофание этот риск смягчает/уменьшает.</p>

<p>Referer: https://grishaev.me/files2/</p>
</div>
    </div>
  
</div>









<form id="comment-form" method="POST" action="https://functions.yandexcloud.net/d4ehfuf08fjfjr59ivnf">

    <div class="block">
        <p class="comment-form-label"><small>Your name</small></p>
        <input required id="comment-form-author" name="author" type="text">
    </div>

    <div class="block">
        <p class="comment-form-label"><small>Comment (markdown syntax)</small></p>
        <textarea required id="comment-form-comment" name="comment"></textarea>
    </div>

    <input required name="path" type="hidden" value="/files/">
    <input required name="captcha" type="hidden" value="4 &#215; 5">

    <div class="block">
        <span class="comment-form-label"><small>4 &#215; 5 = </small></span>
        <input required id="comment-form-solution" name="solution" type="text">
    </div>

    <div class="block">
        <button id="comment-form-send" type="submit">Send</button>
    </div>

</form>


      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Ivan Grishaev's blog</li>
          <li><a href="mailto:ivan@grishaev.me">ivan@grishaev.me</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
            <li><a href="https://github.com/igrishaev">GitHub</a></li>
            <li><a href="tg://resolve?domain=igrishaev_blog">Telegram</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Writing on programming, education, books and negotiations.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
