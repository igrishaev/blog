<!DOCTYPE html>
<html lang="ru">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Ivan Grishaev's blog</title>
  <meta name="description" content="Writing on programming, education, books and negotiations.
">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/custom.css">
  <link rel="canonical" href="https://grishaev.me/page42/">
  <link rel="alternate" type="application/rss+xml" title="Ivan Grishaev's blog" href="https://grishaev.me/feed.xml">

  <link rel="shortcut icon" type="image/x-icon" href="/assets/static/favicons/favicon.ico">

  <script type="text/javascript" src="/assets/typo.js"></script>

</head>


  <body>
    <header class="site-header">

    <div class="wrapper flex-container">

        <div>
            <a href="/">
                <img src="/assets/static/photo-round-small.png" alt="Ivan Grishaev">
            </a>
        </div>

        <div class="flex-container-vert" style="margin-left: 15px; width: 80%">

            <div class="flex-container full-width">
                <p style="margin-bottom: 5px">Ivan Grishaev's blog</p>
                <div class="flex-huge"></div>
                <div >
<form id="search-form"
      target="_blank"
      style="display: inline"
      method="get"
      action="https://www.google.com/search">

    <input name="sitesearch"
           value="grishaev.me"
           type="hidden">

    <input type="text"
           required="required"
           name="q"
           placeholder="Google search..."
           autocomplete="off">

    <button style="border: none; background-color: transparent; cursor: pointer;"
            type="submit">&#x1f50d;</button>

</form>
</div>
            </div>

            <p><small>Writing on programming, education, books and negotiations.
</small></p>

            <div class="flex-container">
                <a class="menu-item" href="/">Home</a>
                <a class="menu-item" href="/about/">About</a>
                <a class="menu-item" href="/bookshelf/">Bookshelf</a>
                <a class="menu-item" href="/feed.xml">RSS</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor" href="/tag/clojure/">Clojure</a>
                <a class="menu-item minor" href="/tag/emacs/">Emacs</a>
                <a class="menu-item minor" href="/tag/python/">Python</a>
                <a class="menu-item minor" href="/tag/programming/">Programming</a>
                <a class="menu-item minor" href="/interview/">Interview</a>
                <a class="menu-item minor" href="/video/">Video</a>
            </div>

            <div class="flex-container">
                <a class="menu-item minor hl" href="/clojure-in-prod/">Книга «Clojure на производстве»</a>
            </div>

        </div>
    </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="home">

    <ul class="post-list">
        
        <li>

            <h2>
                <a class="post-link" href="/potato/">Картофельный мап</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2016-04-07T00:00:00+00:00">
        Apr 7, 2016
    </time>

    <a href="/tag/potato/" rel="tag">potato</a>, <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/map/" rel="tag">map</a>, <a href="/tag/fp/" rel="tag">fp</a>

</div>


            <div class="entry">
                
                    <p>По следам прошлого поста о <a href="/map">функции <code class="language-plaintext highlighter-rouge">Map</code></a>.</p>

<p>Вам дали задачу – смоделировать процесс приготовлении картошки. Имеем
набор картофелин. Каждая должна пройти стадию чистки, мойки, резки и
варки.</p>

<p>Не вопрос, отвечет программист:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Potato</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">wash</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">cut</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">cook</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

<span class="n">potatos</span> <span class="o">=</span> <span class="p">[</span><span class="n">Potato</span><span class="p">(),</span> <span class="n">Potato</span><span class="p">(),</span> <span class="p">...]</span>

<span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">potatos</span><span class="p">:</span>
    <span class="n">p</span><span class="p">.</span><span class="n">clean</span><span class="p">()</span>
    <span class="n">p</span><span class="p">.</span><span class="n">wash</span><span class="p">()</span>
    <span class="n">p</span><span class="p">.</span><span class="n">cut</span><span class="p">()</span>
    <span class="n">p</span><span class="p">.</span><span class="n">cook</span><span class="p">()</span>
</code></pre></div></div>

<p>Вроде ОК? Нет, все развалится.</p>

<p>Сперва попросят добавить временные задержки. Чистка – 10 секунд,
мойка и резка – 5 секунд, варка – 15 минут (900 секунд). Впишем
<code class="language-plaintext highlighter-rouge">time.sleep(N)</code> в нужные методы.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="p">...</span>
    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
    <span class="p">...</span>
</code></pre></div></div>

<p>Запустим код и убедимся, что 10 картошек варятся 150 минут! Конечно,
ведь каждая картошка обрабатывается отдельно. Мы варим картошку
поштучно. Так никто не делает.</p>

<p>Выходит, варить картошку в цикле нельзя. Должен быть особый код,
который сварит картошки вне цикла. Класс картофелины не должен знать о
технике варки. Значет, будет некий менеджер
<code class="language-plaintext highlighter-rouge">CookManager.cook(potatos)</code>.</p>

<p>Теперь скажут, что картошку готовы чистить два человека. В цикле выше
это никак не предусмотрено. Придется заворачивать цикл в функцию и
передавать часть списка:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">potatos</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">potatos</span><span class="p">:</span>
        <span class="p">...</span>

<span class="n">potatos</span> <span class="o">=</span> <span class="p">[</span><span class="n">Potato</span><span class="p">(),</span> <span class="n">Potato</span><span class="p">(),</span> <span class="p">...]</span>

<span class="n">process</span><span class="p">(</span><span class="n">potatos</span><span class="p">[:</span><span class="n">n</span><span class="p">])</span>
<span class="n">process</span><span class="p">(</span><span class="n">potatos</span><span class="p">[</span><span class="n">n</span><span class="p">:])</span>

<span class="n">CookManager</span><span class="p">.</span><span class="n">cook</span><span class="p">(</span><span class="n">potatos</span><span class="p">)</span>
</code></pre></div></div>

<p>Поделили. Но код никак не учитывает, что в процессе чистки может
подключиться еще один человек. Или наоборот, уйти. Перестроить списки
в процессе невозможно.</p>

<p>Есть проблема серьезней: процесс мойки делить между людьми
нельзя. Потому что мойка одна. Это значит, нужно выдергивать из цикла
операцию <code class="language-plaintext highlighter-rouge">p.wash()</code>, и как-то все перетасовать. И не забыть про варку
в конце.</p>

<p>Короче, я к тому, что нужно сразу делать правильно:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Potato</span><span class="p">:</span>
    <span class="p">...</span>

<span class="n">potatos</span> <span class="o">=</span> <span class="p">[...]</span>

<span class="nb">map</span><span class="p">(</span><span class="n">Potato</span><span class="p">.</span><span class="n">clean</span><span class="p">,</span> <span class="n">potatos</span><span class="p">)</span>
<span class="nb">map</span><span class="p">(</span><span class="n">Potato</span><span class="p">.</span><span class="n">wash</span><span class="p">,</span> <span class="n">potatos</span><span class="p">)</span>
<span class="nb">map</span><span class="p">(</span><span class="n">Potato</span><span class="p">.</span><span class="n">cut</span><span class="p">,</span> <span class="n">potatos</span><span class="p">)</span>
<span class="nb">map</span><span class="p">(</span><span class="n">Potato</span><span class="p">.</span><span class="n">cook</span><span class="p">,</span> <span class="n">potatos</span><span class="p">)</span>
</code></pre></div></div>

<p>Правильно – значит, оставлять потенциал для абстракций. Пока что код
выше технически не отличается от цикла. Картошка тоже вариться 150
минут. Но это легко исправить:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">map_threaded</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">seq</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">multiprocessing.dummy</span> <span class="kn">import</span> <span class="n">Pool</span>
    <span class="n">pool</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">seq</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">pool</span><span class="p">.</span><span class="nb">map</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">seq</span><span class="p">)</span>

<span class="p">...</span>

<span class="n">map_threaded</span><span class="p">(</span><span class="n">Potato</span><span class="p">.</span><span class="n">cook</span><span class="p">,</span> <span class="n">potatos</span><span class="p">)</span>
</code></pre></div></div>

<p>Здесь мы определяем мап в тредах. Число тредов равно числу
картошек. Это значит, все они будут готовиться параллельно, как в
реальности в одной кастрюле. Питонячьи треды переключаются при
<code class="language-plaintext highlighter-rouge">time.sleep()</code>. Засыпание равносильно IO-ожиданию. Поэтому все
картошки приготовятся за 15 минут.</p>

<p>Теперь чистка. Это будет мап на очередях. Воркеры –
люди. Конфигурация очереди никак не влияет на код, поэтому можем
подключить два, три и более воркеров со своими приоритетами и
весами. Захотим, отключим воркер в процессе работы. Мап будет примерно
такой:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">map_queued</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">seq</span><span class="p">):</span>
    <span class="n">task</span> <span class="o">=</span> <span class="n">celery</span><span class="p">.</span><span class="n">task</span><span class="p">(</span><span class="n">func</span><span class="p">)(</span><span class="o">&lt;</span><span class="n">task</span> <span class="n">options</span><span class="p">...</span><span class="o">&gt;</span><span class="p">)</span>
    <span class="n">res_id_list</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">task</span><span class="p">.</span><span class="n">apply_async</span><span class="p">,</span> <span class="n">seq</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">map</span><span class="p">(</span><span class="n">task</span><span class="p">.</span><span class="n">get_result</span><span class="p">,</span> <span class="n">res_id_list</span><span class="p">)</span>

<span class="n">map_queued</span><span class="p">(</span><span class="n">Potato</span><span class="p">.</span><span class="n">clean</span><span class="p">,</span> <span class="n">potatos</span><span class="p">)</span>
</code></pre></div></div>

<p>Мойку параллелить нельзя, оставляем обычный мап. Все вместе:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Potato</span><span class="p">:</span>
    <span class="p">...</span>

<span class="n">potatos</span> <span class="o">=</span> <span class="p">[...]</span>

<span class="n">map_queued</span><span class="p">(</span><span class="n">Potato</span><span class="p">.</span><span class="n">clean</span><span class="p">,</span> <span class="n">potatos</span><span class="p">)</span>
<span class="nb">map</span><span class="p">(</span><span class="n">Potato</span><span class="p">.</span><span class="n">wash</span><span class="p">,</span> <span class="n">potatos</span><span class="p">)</span>
<span class="n">map_queued</span><span class="p">(</span><span class="n">Potato</span><span class="p">.</span><span class="n">cut</span><span class="p">,</span> <span class="n">potatos</span><span class="p">)</span>
<span class="n">map_threaded</span><span class="p">(</span><span class="n">Potato</span><span class="p">.</span><span class="n">cook</span><span class="p">,</span> <span class="n">potatos</span><span class="p">)</span>
</code></pre></div></div>

<p>Смысловая часть кода осталась неизменной. Мы просто поменяли один мап
на другой. Всегда можем вернуть старый мап, если что-то пойдет не
так. Функции map, filter, reduce, eval, apply – фундамент
абстракций. Абстракции делают код открытым к изменеиям.</p>

<p>В идеале следует избавиться от классов, чтобы не хранить состояние
картошки. Заменить методы на функции и пробрасывать результат
предыдущего мапа в следующий.</p>

<iframe width="640" height="360" src="https://www.youtube.com/embed/-MDLrCBEKto" allowfullscreen=""></iframe>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/kindle/">Впечатления от электронной читалки Kindle</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2016-04-06T00:00:00+00:00">
        Apr 6, 2016
    </time>

    <a href="/tag/kindle/" rel="tag">kindle</a>, <a href="/tag/books/" rel="tag">books</a>, <a href="/tag/reading/" rel="tag">reading</a>

</div>


            <div class="entry">
                
                    
<p><strong>UPD продолжение:</strong> <a href="/kindle2">впечатления два года спустя</a>.</p>

<p>Месяц-два назад заказал читалку Kindle Paperwhite. Очень доволен
покупкой. Прочел пару книг, делюсь впечатлениями.</p>

<p>Читалка классная. Компактная, удобно читать, носить. От нее почти не
устают глаза. Если читаешь вечером, утром не чуствуешь последствий. От
айпада или монитора, наоборот, ощущения, что глаза засыпали песком. На
солнце все видно без проблем.</p>

<p>Забавно, что дневной свет экономит питание электронной читалки, а на
айпадах, наоборот, заставляет выкручивать яркость на максимум.</p>

<p>Заказывал в магазине www.elektrokniga.net. Контора напоминает шарашку.
Например, вы не оплачиваете товар, а переводите деньги физлицу на
карту. Но обошлось, доставили оперативно. Слали по два письма в день о
том, что с моим заказом и где он едет.</p>

<p>Какие преимущества читалки перед настольной книгой вообще? Я выделяю
следующие:</p>

<ul>
  <li>
    <p>Удобство. Для чтения бумажной книги нужен стол, свет, чистые
руки. Для меня все три сразу – как парад планет. С читалкой можно
бухнуться на диван или залипнуть в очереди в Сбербанке.</p>
  </li>
  <li>
    <p>Таскать бумажную книгу накладно. Лишний вес, книга теряет товарный
вид от трения в сумке. Или таскаешь весь день, а шанс почитать так и
не выпал.</p>
  </li>
  <li>
    <p>С ценой на зарубежные книги еще можно смириться. Но доставка в два
месяца, равная цене книги… нет, я не миллионер, платить 100
долларов за книгу в мягкой обложке.</p>
  </li>
  <li>
    <p>Кое-что достать в бумажном виде уже не реально.</p>
  </li>
</ul>

<p>Теперь преимущества конкретно Киндла:</p>

<ul>
  <li>
    <p>Очень высокое качество сборки. Ничто не скрипит, пластик пригнан,
щелей нет. Обложка, хоть и не оригинал, тоже на уровне. Магнитик на
обложке погружает книгу в сон, если закрыть.</p>
  </li>
  <li>
    <p>Девайс действительно создан для комфортного чтения. Очень четкий
экран, ощущение, что читаешь с бумаги. Глубокий контраст,
равномерная подсветка. Специально подобранные шрифты.</p>
  </li>
  <li>
    <p>В прошивке только то, что нужно. Нет тяжелого наследия
Андроида. Интерфейс минимальный, настройки простые.</p>
  </li>
  <li>
    <p>В поставке идут словари. Читаешь книжку на английском, например,
нажал на слово – всплывают две плашки. В одной – выдержка из
Оксфордского словаря, в другой – поиск в Википедии. В словаре не
просто перевод, а описание термина в разных контекстах.</p>
  </li>
  <li>
    <p>Амазон дает емейл <code class="language-plaintext highlighter-rouge">username@kindle.com</code>. Шлешь на него книгу – и
через минуту она скачалась в читалку. Не надо заморачиваться с
проводами.</p>
  </li>
  <li>
    <p>Книжки хранятся в облаке. При утрате двайса все легко
восстановится. Удалил случайно книжку – всегда можно закачать
обратно из облака.</p>
  </li>
  <li>
    <p>Качественная интеграция с сервисом Амазона. Покупаешь прямо в
интерфейсе читалки. Все элементы адаптированы под специфичный экран.</p>
  </li>
</ul>

<p>Конечно, есть и минусы.</p>

<ul>
  <li>
    <p>Девайс обновляется сам по себе, когда Амазон сочтет
нужным. Отключить обновление прошивки нельзя, либо опция запрятана
так, что найти не реально. При этом не все изменения мне по
душе. Например, в последнем апдейте, чтобы отрегулировать подсветку,
теперь нужно три клика, а раньше два. А ведь это самое важное при
чтении.</p>
  </li>
  <li>
    <p>Читалка не поддерживает популярные форматы ebup и fb2. Не такой уж
минус, полно утилит для конвертации. Но немного раздражает.</p>
  </li>
  <li>
    <p>Я прекрасно понимаю, что устройство полностью контролируется
Амазоном. Информация о моих книгах используется, чтобы показывать
мне рекламу. Пользоваться Киндлом я смогу ровно столько, сколько
позволит Амазон. <a href="https://stallman.org/amazon.html">Столлман прав.</a></p>
  </li>
</ul>

<p>Следует победить юношеские комплексы и брать читалку не по размеру, а
качеству экрана. Сейчас самый крутой – 6’ 300 dpi Carta. Он стоит в
последних Киндлах и некоторых Ониксах, например, в модели
Дарвин. Однако, в Дарвине щели такие, что ноготь пролазит, а по цене
почти одинаково.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/map/">Map как замена циклу</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2016-04-03T18:58:00+00:00">
        Apr 3, 2016
    </time>

    <a href="/tag/map/" rel="tag">map</a>, <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/abstraction/" rel="tag">abstraction</a>, <a href="/tag/cycle/" rel="tag">cycle</a>

</div>


            <div class="entry">
                
                    <p>Я нашел, что отказ от циклов в пользу <code class="language-plaintext highlighter-rouge">map</code> улучшает код сразу по
нескольким критериям, а заодно вправляет мозги. Код с мапами короче,
меньше подвержен ошибкам, его легче поддерживать.</p>

<p><a href="https://en.wikipedia.org/wiki/Map_(higher-order_function)">Функция <code class="language-plaintext highlighter-rouge">map</code></a> родом из мира функционального
программирования (далее ФП). Почти любой язык имеет ее аналог в
стандартной поставке. Map может быть как функцией, так и методом
коллекции.</p>

<p>Map принимает функцию и коллекцию. Функция обрабатывает один
элемент. Результат <code class="language-plaintext highlighter-rouge">map</code> – коллекция результатов функции на множестве
входных данных.</p>

<p>Map призван заменить циклы и ручную итерацию с накоплением
результатов. ФП в российских вузах либо не преподают, либо касаются
факультативно. Студенты мыслят циклами и переносят привычки во
взрослую жизнь.</p>

<p>Мышление циклами – плохая штука. Цикл – примитивная, не
регламентированная конструкция, которая быстро выходит из-под контроля
и превращает код в лапшу. <code class="language-plaintext highlighter-rouge">Map</code> лучше цикла по следующим пунктам.</p>

<h3 id="меньше-кода">Меньше кода</h3>

<p>Пусть определена функция <code class="language-plaintext highlighter-rouge">do_stuff(item)</code>, ее тело не важно. Это
штучный обработчик объекта. Сравним два фрагмента кода:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">results</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">do_stuff</span><span class="p">,</span> <span class="n">my_data_list</span><span class="p">)</span>
</code></pre></div></div>

<p>и</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">my_data_list</span><span class="p">:</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">do_stuff</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">results</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
</code></pre></div></div>

<p>Очевидно, первый вариант короче и не засоряет пространство лишними
переменными. Строку с промежуточным результатом <code class="language-plaintext highlighter-rouge">res</code> можно опустить,
но тогда следующая строка <code class="language-plaintext highlighter-rouge">results.append(do_stuff(x))</code> станет
сложнее. Две операции на одну строку – не желательно.</p>

<h3 id="сдвиг-кода-и-логические-прыжки">Сдвиг кода и логические прыжки</h3>

<p>Цикл – это дополнительный сдвиг кода. ООП уже дает сдвиги для классов
и методов, а тут еще циклы. При этом нужно бегать глазами к
переменным-спискам, объявленным до цикла. Map не делает сдвига и
создает переменные по требованию.</p>

<h3 id="декларативный-код-безопасней">Декларативный код безопасней</h3>

<p><code class="language-plaintext highlighter-rouge">Map</code> – это декларативная операция. Это значит, я говорю что именно
хочу получить, а не как. За счет автоматизации ручных действий,
декларативный код очень легко поддерживать и в нем меньше
багов. Бывает, баг кроется именно в неверной итерации или ручной
сборке списка. Но из-за кажущейся тривиальности проверяешь это место в
последнюю очередь.</p>

<h3 id="дополнительный-уровень-абстракции">Дополнительный уровень абстракции</h3>

<p>Map несет большой потенциал для построения абстракций. Скажем, в
обычном языке <code class="language-plaintext highlighter-rouge">map</code> – это банальный прогон функции по элементам в
цикле. Но в других языках <code class="language-plaintext highlighter-rouge">map</code> обретает преимущества, недоступные
обычным циклам.</p>

<p>Если у нас неизменяемые коллекции и транзакционная память,
интерпретатор раскидает задачу по ядрам. Имея 1000 элементов и 4 ядра,
получим по 250 итераций на одно ядро. Описать это циклом –
нетривиальная задача. Насколько я знаю, Clojure и некоторые реализации
Haskell параллелят <code class="language-plaintext highlighter-rouge">map</code> при заданных флагах компиляции.</p>

<p><code class="language-plaintext highlighter-rouge">Map</code> очень круто параллелит запросы в сеть. Например, нужно дернуть
100 урлов, при этом сервера находятся в разных полушариях, и время
отклика ожидаемо велико. Отклик в 10 секунд на запрос из Европы в
Сингапур – нормальное дело. Важно понять, что хоть у вас
супер-кластер, он будет висеть 10 секунд в цикле, ожидая блокирующий
запрос. По меркам машинного времени это целая вечность.</p>

<p><code class="language-plaintext highlighter-rouge">Map</code> легко перестоит одну схему исполнения в другую. Вот обычный
подход, аналогичный циклу:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">url_list</span> <span class="o">=</span> <span class="p">[</span><span class="s">"http://foo1.com"</span><span class="p">,</span> <span class="s">"http://foo2.com"</span><span class="p">,</span> <span class="p">...]</span>

<span class="k">def</span> <span class="nf">get_data</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">).</span><span class="n">json</span><span class="p">()</span>

<span class="n">data_list</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">get_data</span><span class="p">,</span> <span class="n">url_list</span><span class="p">)</span>
</code></pre></div></div>

<p>Теперь напишем свой map с использованием тредов:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">multiprocessing.dummy</span> <span class="kn">import</span> <span class="n">Pool</span>

<span class="k">def</span> <span class="nf">map_threaded</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">seq</span><span class="p">):</span>
    <span class="n">pool</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pool</span><span class="p">.</span><span class="nb">map</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">seq</span><span class="p">)</span>

<span class="n">data_list</span> <span class="o">=</span> <span class="n">map_threaded</span><span class="p">(</span><span class="n">get_data</span><span class="p">,</span> <span class="n">url_list</span><span class="p">)</span>
</code></pre></div></div>

<p>Всего лишь поменяли <code class="language-plaintext highlighter-rouge">map</code> на <code class="language-plaintext highlighter-rouge">map_threaded</code>, но какая большая разница
в реализации! Был цикл, а стали треды, но сигнатуры одинаковые. Теперь
на всю операцию понадобится время, равное самому долгому запросу.</p>

<p>(Да, это пул тредов не смотря на название модуля.)</p>

<p>Мощь абстракции <code class="language-plaintext highlighter-rouge">map</code> очень велика. Мы можем использовать любой другой
метод распределения задач. Например, процессы вместо тредов. Или
подключить фреймворк вроде <code class="language-plaintext highlighter-rouge">Celery</code>, который шлет задания воркерам,
собирает ответы и отдает список.</p>

<p>Мощь Гугла – это комбинация функций
<a href="https://ru.wikipedia.org/wiki/MapReduce">Map и Reduce</a>. Инженеры Гугла дробят задачи на
подзадачи и эффективно исполняют их на тысячах серверов. Технология
работает в масштабах планеты. Под капотом может быть скучный ООП-код
на Java, но <code class="language-plaintext highlighter-rouge">Map</code> и <code class="language-plaintext highlighter-rouge">Reduce</code> – абстракция высочайшего
порядка. Благодаря им Гугл стал тем, что есть сейчас.</p>

<h3 id="контроль-за-разрастанием-цикла">Контроль за разрастанием цикла</h3>

<p>Проблема цикла в том, что код внутри никак не регламентирован. Тело
цикла бесконтрольно разрастается. Сперва кажется, что в цикле все
ясно. Но меняются бизнес-требования, нужны фичи, и ясность быстро
уходит.</p>

<p>Добавили <code class="language-plaintext highlighter-rouge">if</code>, затем еще один, затем <code class="language-plaintext highlighter-rouge">continue</code> по условию, а потом
вообще залепили вложенный цикл. В этой ветке пишем в результирующий
список, а в этой нет. Логику накопления результатов отследить трудно.</p>

<p>Бывает, мы добавляем костыли в цикл, потому что на носу релиз, и
возиться некогда. Часто в ревью мы видим пару строчек:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
<span class="o">+</span>     <span class="k">if</span> <span class="ow">not</span> <span class="n">item</span><span class="p">.</span><span class="n">check_foo</span><span class="p">():</span>
<span class="o">+</span>         <span class="k">continue</span>
  <span class="p">...</span>
</code></pre></div></div>

<p>которые ни у кого не вызывают подозрений. Ну, пропускаешь шаг, все
понятно.</p>

<p>Это плохо.</p>

<p>Ближайшая аналогия – растение морской желудь. Он разрастается по дну
судна. Если планово не счищать, скорость судна и потребление горючего
падают и возрастают соответственно на 40%.</p>

<p>Отрефакторить цикл, в котором полно <code class="language-plaintext highlighter-rouge">if</code>, <code class="language-plaintext highlighter-rouge">continue</code>, <code class="language-plaintext highlighter-rouge">try/catch</code>
очень трудно. Все завязано на глобальные списки, объявленные до входа
в цикл. Оператор <code class="language-plaintext highlighter-rouge">continue</code> я считаю дурным тоном. Мы должны отделять
котлеты от мух до входа в итерацию.</p>

<p><code class="language-plaintext highlighter-rouge">Map</code> исключает условия и пропуск элементов. Целевая функция не может
сказать “этот обработать не могу, дай-ка лучше следующий”. Список
следует предварительно очистить функцией <code class="language-plaintext highlighter-rouge">filter</code>.</p>

<h3 id="неверное-прохождение-слоев-бизнес-логики">Неверное прохождение слоев бизнес-логики</h3>

<p>Мы часто работаем со списками объектов. Типичная задача – извлечь
данные из базы и выполнить для каждого ряд действий. Например,
<code class="language-plaintext highlighter-rouge">действие1</code>, <code class="language-plaintext highlighter-rouge">действие2</code> и <code class="language-plaintext highlighter-rouge">действие3</code>.</p>

<p>Итерируясь вручную, программист выполняет все три для первого объекта,
затем для второго, и так далее. И забывает, что противоположный обход
– сначала для всех выполнить <code class="language-plaintext highlighter-rouge">действие1</code>, затем для всех <code class="language-plaintext highlighter-rouge">действие2</code>
и т.д. – выгодней по следующим причинам:</p>

<ul>
  <li>для очередного действия может потребоваться какой-то ресурс: файл,
сеть, авторизация. Логично открыть его, прогнать объекты, закрыть
ресурс и переходить к следующей стадии. В цикле придется держать
ресурсы открытыми все время.</li>
  <li>если мы лажанулись уже в начале, открывать некоторые ресурсы не
понадобиться вообще.</li>
  <li>описанный подход – это проход бизнес-логики по слоям, что ближе к
реальному положению дел. Например, вы прошли два действия, но третье
не вышло – нет сети или файла. Можно сдампить результаты в файл и
несложным хаком вернуться в состояние, когда результаты двух первых
стадий есть, а третьей – нет. В случае ошибки на середине цикла
контекст будет намного сложней, а вернуться на конкретный шаг
итерации – невозможно.</li>
</ul>

<h3 id="повышенные-требования-к-коду">Повышенные требования к коду</h3>

<p><code class="language-plaintext highlighter-rouge">Map</code> заставляет писать код качественней. <code class="language-plaintext highlighter-rouge">Map</code> не имеет встроенной
защиты от не пойманных исключений. Если упадет первый элемент, не
выполнятся остальные 999. Поэтому передавая функцию в мап, программист
должен подписаться, что функция не подведет.</p>

<p>Не каждый готов дать эту гарантию. Часто мы видим такое:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">process_item</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">process_data</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">result</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="p">.</span><span class="k">except</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">continue</span>
</code></pre></div></div>

<p>Этот код ужасен. Он беззуб и неуклюж. Функции написаны криво и бросают
ошибки. Смысловая часть уехала на два отступа. На выходе из цикла не
ясно, с какими элементами случилась ошибка. Смешались в кучу итерация,
отлов исключений, логирование.</p>

<p>А ведь достаточно завернуть целевую функцию в декоратор или другую
функцию, которая отдаст пару <code class="language-plaintext highlighter-rouge">(err, result)</code> и прогнать через
<code class="language-plaintext highlighter-rouge">map</code>. После прогона отделить хорошие результаты от плохих. Ошибки
залогировать отдельным шагом. Хорошие результаты отправить в следующий
слой бизнес-логики.</p>

<p>Хорошая новость в том, что мы уже в двух шагах от монад, но пока не
будем о них.</p>

<h3 id="вместо-заключения">Вместо заключения</h3>

<p>Отказ от циклов сокращает код, делает его яснее и легче в
поддержке. Map не позволит воткнуть в середине условие или переход к
следующей итерации. Ручное накопление списка чревато багами, поэтому
лучше доверить это надежной функции.</p>


                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/meetup4/">Записи докладов с четвертой встречи любителей рефакторить</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2016-04-03T15:00:00+00:00">
        Apr 3, 2016
    </time>

    <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/meetup/" rel="tag">meetup</a>, <a href="/tag/deep-refactoring/" rel="tag">deep-refactoring</a>

</div>


            <div class="entry">
                
                    <p>Провели четвертую встречу!</p>

<p>Роман Гребенников выступил с докладом о распределенных системах:</p>

<iframe width="854" height="480" src="https://www.youtube.com/embed/6ZQ-3NmpXOs" allowfullscreen=""></iframe>

<p>Евгений Рыжков рассказал о тонкостях манипуляций:</p>

<iframe width="854" height="480" src="https://www.youtube.com/embed/M2oryEQkYbQ" allowfullscreen=""></iframe>

<p><a href="http://www.slideshare.net/IvanGrishaev/project-management-60404921">Слайды</a></p>

<p>Напомню, сообщество тусит в <a href="https://www.facebook.com/groups/deeprefactoring/">группе Фейсбука</a>. Скоро
анонс пятой встречи, принимаем заявки на доклады.</p>


                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/npm/">Идиотизм вокруг NPM</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2016-03-30T00:00:00+00:00">
        Mar 30, 2016
    </time>

    <a href="/tag/npm/" rel="tag">npm</a>, <a href="/tag/idiots/" rel="tag">idiots</a>

</div>


            <div class="entry">
                
                    <p>Как и другие разработчики, я с интересом наблюдаю за скандалом вокруг
экосистемы Node.js и пакетного менеджера NPM.</p>

<p>Если вы не в курсе дела, смотрите ссылки в конце поста. А я напомню,
что у Node-разработчиков прошлая неделя прошла в боли и
страданиях. Программист Азер Кочулу удалил из NPM свои 100500 пакетов,
том числе один аж на 11 строк. Без него не смогли собраться React,
Babel и куча всего.</p>

<p>Азер удалил код потому, что администрация NPM в одностороннем порядке
передала права на пакет Kik от Азера к представителям одноименной
компании. Якобы юристы Kik запугали патентами и торговой маркой.</p>

<p>Развязка: Азер перенес все пакеты в Гитхаб, администрация NPM
запретила удалять пакеты по истечении 24 часов в момента
публикации. Азер на коне, он весь такой Д’Артаньян в белых перчатках,
в Твиттере пафосные картинки.</p>

<p>Страсти спадают, и теперь, после недели хаоса, следует подумать, кто в
это ситуации был мудаком.</p>

<p>Имеем три стороны – Азер, администрация NPM и юристы компании
Kik. Кто неправ в этой истории?</p>

<p>Первые два. Объясню с конца.</p>

<p>Юристы Kik действуют в своих интересах. Они стараются расширить
экспансию вверенного им продукта. Совершенно естественно, что их цель
– захватить имя Kik разных его проявлениях.</p>

<p>Поскольку под именем Kik размещен левый пакет, а компания хочет
предоставить разработчикам API, юристы начали переговоры о передаче
прав на пакет.</p>

<p>Азер обозвал их мудаками и послал на хуй (как было, так и перевел). А
в начале написал “Ха-ха”. Кто-то сомневается в неадекватности
пациента? Взрослый же человек, просто откажи, зачем оскорблять людей?</p>

<p>Увидев, что собеседник в неадеквате, юристы пишут администрации NPM. Я
бы тоже так поступил на их месте. Тут NPM жидко сливаются, передав
права без каких-либо документов и согласований. Да, пусть этот Азер
хамло, но права пользователей надо уважать.</p>

<p>Кто-то думает, что NPM зассали перед патентом на торговую марку “Kik”,
а на самом деле все просто – одни из основателей NPM работал в Kik
раньше. Это банальный блат, работает не только в России.</p>

<p>Поэтому администрация NPM – тоже мудаки.</p>

<p>Далее Айзер включил бунтаря и удалил все 250 пакетов, что успел к тому
времени наплодить. Многие из них успели стать зависимостями в других
пакетах. Айзер, прекрасно осознавая что делает, испортил жизнь тысячам
людей по всему земному шару.</p>

<p>Когда валютные вкладчики приковывают себя наручниками к дверям банка,
то и это не тот градус шизофрении, что ученил Азер. Это детская нужда
стать нужным. Послать миру весть, что без него нельзя обойтись.</p>

<p>Администрация NPM, к их чести, вынесла правильный урок. Теперь
запрещено удалять пакеты, с момента публикаций которых прошло больше
24 часов. Это правильно, потому что если разработчик выложил код, то
значит, он предлагает его другим, верно? Иначе зачем выкладывать,
ставь из приватного репозитория.</p>

<p>Не хочешь поддерживать – ставишь галку, что ищешь мейнтейнера,
передаешь права. Удалять – это нонсенс. Что будет, если каждый
разработчик, поругавшись в подружкой, начнет удалять модули? Это
строительство дома из пивных банок.</p>

<p>Давайте окинем быстрым взглядом 250 пакетов Азера. Двести пятьдесят,
Карл, как пишут в интернете.</p>

<ul>
  <li><a href="https://github.com/azer/run-paralelly">run-paralelly</a> – 11 комитов, 46 строк.</li>
  <li><a href="https://github.com/azer/left-pad">left-pad</a>, из-за которого сломался интернет. 11 комитов,
11 значимых строк. 660 звезд.</li>
  <li><a href="https://github.com/azer/flat-glob">flat-glob</a> – 6 комитов, 49 строк. Прогресс.</li>
  <li><a href="https://github.com/azer/get-object-path">get-object-path</a> – 9 комитов, 21 строка.</li>
  <li><a href="https://github.com/azer/rnd">rnd</a> – 1 комит, 8 строк.</li>
  <li><a href="https://github.com/azer/random-color">random-color</a> – 7 комитов, 8 строк.</li>
  <li><a href="https://github.com/azer/route-map">route-map</a> – 6 комитов, 55 строк.</li>
</ul>

<p>Ну ты понел.</p>

<p>В интернете точно пошутили, что чуваку нужен не Гитхаб, а
Твиттер. Каждый твит – новый пакет. Большая часть уместится в 140
символов, если переменные укоротить. А “тяжелые” проекты на 50 строк и
больше декомпозировать и подключить зависимостями.</p>

<p>Блин, у него декларация <code class="language-plaintext highlighter-rouge">package.json</code> занимает больше места, чем код.</p>

<p>Что мешает этому Азеру создать пакет <code class="language-plaintext highlighter-rouge">azer-tools</code> и наполнять его
утилитами? Принцип “один пакет – одна функция” это не глупость, a рак
мозга. Я не видел такого ни в одном другом языке.</p>

<p>Ничего удивительного, что подобное произошло. Странно, как такое до
сих пор не случилось, учитывая идиотизм разработчиков вроде
Азера. Когда ты строишь дом из пивных банок, всегда найдется тот, кто
выдернет самую нижнюю, потому что на дне еще осталось. И все упадет.</p>

<p>А ведь я помню поток статей в духе “Node.js спасет мир” пять лет
назад. 2016 на дворе, а в сообществе сканалы на уровне Дома-2.</p>

<p>На закуску – статья Теда Дзюбы
<a href="http://widgetsandshit.com/teddziuba/2011/10/node-js-is-cancer.html">“Node.Js Is Cancer”</a>. На Хабре был перевод.</p>

<p>Ссылки:</p>

<ul>
  <li><a href="https://meduza.io/feature/2016/03/28/kak-slomat-internet">Новость на Медузе</a></li>
  <li><a href="https://medium.com/@mproberts/a-discussion-about-the-breaking-of-the-internet-3d4d2a83aa4d">Переписка Азера</a></li>
  <li><a href="https://medium.com/@azerbike/i-ve-just-liberated-my-modules-9045c06be67c">Сообщение Азера о переносе модулей</a></li>
  <li><a href="https://habrahabr.ru/post/280099/">Что-то с Хабра</a></li>
</ul>


                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/code-data/">Что значит код как данные</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2016-03-26T00:00:00+00:00">
        Mar 26, 2016
    </time>

    <a href="/tag/code/" rel="tag">code</a>, <a href="/tag/data/" rel="tag">data</a>, <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/lisp/" rel="tag">lisp</a>, <a href="/tag/macros/" rel="tag">macros</a>

</div>


            <div class="entry">
                
                    <p>Про Лисп говорят, что код это данные, а данные – код. Пока не
поработаешь с Лиспом, понять смысл кода как данных трудно. Ниже – моя
попытка объяснить простыми словами.</p>

<p>Предположим, кто-то осваивает Лисп и делает задачки вроде факториала и
рекурсии. Частенько приходится записывать числовые выражения вроде
<code class="language-plaintext highlighter-rouge">(x + y) * (a / b)</code>. В Лиспе пишут польской нотацией, то есть
выражение выглядит так:</p>

<div class="language-lisp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nb">*</span> <span class="p">(</span><span class="nb">+</span> <span class="nv">x</span> <span class="nv">y</span><span class="p">)</span>
   <span class="p">(</span><span class="nb">/</span> <span class="nv">a</span> <span class="nv">b</span><span class="p">))</span>
</code></pre></div></div>

<p>Не очень привычно. Было бы здорово, думает студент, написать функцию,
которая принимает выражение как удобно мне, а возвращала то, что нужно
Лиспу. Начинает писать функцию <code class="language-plaintext highlighter-rouge">expr</code>, что-то вроде <code class="language-plaintext highlighter-rouge">(expr (x + y) *
(a / b))</code>.</p>

<p>Ничто не предвещает беды. Но вот облом: Лисп, как и другие ЯП,
вычисляет аргументы функции до входа в нее. А выражение <code class="language-plaintext highlighter-rouge">(x + y)...</code>
ошибочно с точки зрения и семантики, и синтаксиса, поэтому даже до
вызова функции <code class="language-plaintext highlighter-rouge">expr</code> дело не дойдет. Что же делать?</p>

<p>Помогут макросы.</p>

<p>Макрос похож на функцию, но с важным отличием. Выражение, переданное в
макрос, НЕ вычисляется. Вместо этого макрос получает список
лексем. Задача макроса – перестоить список в правильную Лисп-форму и
вернуть ее, НЕ вычисляя. Интерпретатор сам вычислит ее, получив из
макроса.</p>

<p>Короткими словами, макросу можно скормить полную дичь:
крестики-нолики, математическое выражение, кусок кода на любом языке,
asii-арт. Внутри макроса это станет списком. Задача макроса –
перестроить дичь в правильный список, который вычислит Лисп.</p>

<p>Именно в этот момент срабатывает срабатывает принцип
код-как-данные. Когда мы пишем <code class="language-plaintext highlighter-rouge">(expr (x + y) * (a / b))</code>, для нас это
код. Но внутри макроса это список! Нулевой элемент списка –
открывающая скобочка, первый – символ x, затем символ плюсика, и так
до последней закрывающей скобочки.</p>

<p>Рассмотрим макрос для вычисления выражений из двух операндов. Он
вычислит простейшие вещи вроде <code class="language-plaintext highlighter-rouge">3 + 2</code>, <code class="language-plaintext highlighter-rouge">2 * 10</code>, <code class="language-plaintext highlighter-rouge">-3 / 2</code>:</p>

<div class="language-lisp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nb">defmacro</span> <span class="nv">expr</span> <span class="nv">[v1</span> <span class="nv">op</span> <span class="nv">v2]</span>
  <span class="o">`</span><span class="p">(</span><span class="nv">~op</span> <span class="nv">~v1</span> <span class="nv">~v2</span><span class="p">))</span>

<span class="p">(</span><span class="nv">expr</span> <span class="mi">2</span> <span class="nb">+</span> <span class="mi">2</span><span class="p">)</span>
<span class="nv">&gt;&gt;&gt;</span> <span class="mi">4</span>
<span class="p">(</span><span class="nv">expr</span> <span class="mi">2</span> <span class="nb">/</span> <span class="mi">2</span><span class="p">)</span>
<span class="nv">&gt;&gt;&gt;</span> <span class="mi">1</span>
</code></pre></div></div>

<p>Видно что в макросе <code class="language-plaintext highlighter-rouge">expr</code> я поменял элементы списка
местами. Выражения длиней трех лексем макрос не примет. Для
проивольного выражения понадобятся разбор и рекурсивный спуск, что
выходит за рамки разговора.</p>

<p>Вот почему Лисп – программируемый язык программирования. Любой
участок кода может быть обработан как список, что делает язык
невероятно мощным. Лисп разрешает любой недостаток своими же
средствами. ООП-системы, средства обработки исключений и многие другие
фундаментальные вещи – всего лишь пакеты с макросами.</p>

<p>PS: Кроме Лиспа, я знаю только один язык со схожим поведенем. Это Tcl
(Тикль) – в котором, грубо говоря, все является строкой. Тикль до сих
пор популярен на производстве: заводах, CAD-системах. Нефтяные
платформы Shell работают под управлением системы, написанной на Тикле.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/tz/">О техзадании</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2016-03-24T00:00:00+00:00">
        Mar 24, 2016
    </time>

    <a href="/tag/tz/" rel="tag">tz</a>, <a href="/tag/programming/" rel="tag">programming</a>, <a href="/tag/fail/" rel="tag">fail</a>

</div>


            <div class="entry">
                
                    <p>Когда программист на первой же встрече просит техзадание, знайте, что
это плохой программист. То есть, он может быть хорошим техническим
специалистом, но плохим исполнителем. Скорей всего, он сделает не то,
что нужно было заказчику. Сотрудничество окажется непродуктивным.</p>

<p>Теперь длинное объяснение.</p>

<p>Что такое ТЗ? Это документ, в котором бизнес-требования описаны
техническим языком. Упоминаются протоколы, стандарты, меры
безопасности. Четко описаны процессы обмена данными.</p>

<p>Когда программист просит ТЗ, он не понимает, что требует
невозможного. У заказчика не может быть правильно составленного
технического документа. Все, что у него есть – это обрывки идей
будущего бизнеса.</p>

<p>Задача программиста – помочь оформить бизнес-идеи в техническую
форму. Заказчик не может сделать это сам. Он не знает разницу между
<code class="language-plaintext highlighter-rouge">HTTP</code> и <code class="language-plaintext highlighter-rouge">HTTPS</code>, <code class="language-plaintext highlighter-rouge">GET</code> и <code class="language-plaintext highlighter-rouge">POST</code>, и чем стандартная авторизация
отличается от <code class="language-plaintext highlighter-rouge">OAuth 2.0</code>.</p>

<p>Если программист отказывается составлять ТЗ, это значит, он не
разработчик, а кодер, фрилансер, которому можно доверить только самую
примитивную работу.</p>

<p>Заказчик с готовым ТЗ это редкость. Если есть готовое ТЗ, скорее
всего, над ним уже работал технический специалист. Зачем тогда уходить
к другому? Или найти помощника через того, кто составлял ТЗ.</p>

<p>Поэтому первая фаза встречи программиста и заказчика – это
много-много вопросов. Исполнитель имеет право брать за это деньги,
если гарантирует, что на выходе получится ТЗ, максимально полно
отражающее бизнес-требования.</p>

<p>Программисты-невежды думают, что заказчику составить ТЗ будет
легко. Предлагаю обмен ролями: пусть заказчик напишет ТЗ, а
программист – бизнес-план проекта на будущий год. Затем каждая
сторона оценит результаты другой.</p>

<p>Описанное выше можно изобразить на графике. Вот как протекает
сотрудничество во времени. Программист думает:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>|ТЗ       |код       |код        |код     |код      |код         |готово
&gt;------------------------------------------------------------------------&gt;
                                 время
</code></pre></div></div>

<p>На самом деле:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>|вопросы    |вопросы   |вопросы   |ТЗ     |код    |код   |код     |готово
&gt;------------------------------------------------------------------------&gt;
                                 время
</code></pre></div></div>

<p>Когда основные вопросы решены и ТЗ составлено, настает время решать,
стоит ли работать над проектом. Возможно, начальные идеи выродятся во
что-то другое.</p>

<p>А вот что будет, если следовать первому графику.</p>

<p>ТЗ – это документ. Однако, напрасно программист думает, что ТЗ как
золотой щит спасет от всех разногласий. Помимо проекта, который описан
в ТЗ, есть еще одна его версия, которая живет в голове заказчика.</p>

<p>В идеале они совпадают, и второй график учит, как этого
достичь. Неудовлетворенные ожидания – это очень плохо, и даже при
самом строгом ТЗ заказчик найдет способ или разорвать контракт, или не
выплатить сумму целиком, или еще что-то.</p>

<ul>
  <li><em>Заказчик:</em> Форма авторизации как-то не очень…</li>
  <li><em>Программист:</em> Все сделано по техзаданию.</li>
  <li><em>Заказчик:</em> Да, но нет авторизации через соцсети.</li>
  <li><em>Программист:</em> Этого не было в ТЗ.</li>
  <li><em>Заказчик:</em> Не было, потому что сейчас это везде, я думал, вы
догадаетесь.</li>
  <li><em>Программист:</em> Вы не отразили это техзадании.</li>
  <li><em>Заказчик:</em> Что вы все с техзаданием! У нас будет меньше
пользователей!</li>
  <li><em>Программист (мысленно):</em> Вот мудак, не знает, что хочет.</li>
  <li><em>Заказчик (думает):</em> Послал же бог дурака. Только по бумажке
работает, мозга ноль.</li>
</ul>

<p>И так до следующей встречи. С новым заказчиком и исполнителем. Драмы и
плач на форумах.</p>

<p><strong>Выводы</strong></p>

<p>Хороший исполнитель не берется за проект пока досконально не изучит
предмет. Он долго задает вопросы. Техническое задание фиксирует итог
совместных исследований. ТЗ максимально точно соответствует ожиданиям
заказчика. Документ не поможет, если реализация не оправдала надежд.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/destructuring/">Деструктивный синтаксис в функциях</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2016-03-22T00:00:00+00:00">
        Mar 22, 2016
    </time>

    <a href="/tag/python/" rel="tag">python</a>, <a href="/tag/fp/" rel="tag">fp</a>, <a href="/tag/destructuring/" rel="tag">destructuring</a>, <a href="/tag/syntax/" rel="tag">syntax</a>

</div>


            <div class="entry">
                
                    <p>С удивлением обнаружил, что в Питоне редко пользуются деструктивным
синтаксисом в сигнатурах функций. Рассмотрим, какие преимущества он
дает.</p>

<p>Деструктивный синтаксис пришел, как все лучшее, из мира
функционального программирования. В Питоне он известен как “распаковка
кортежа” на составные переменные.</p>

<p>Распаковывать можно не только кортеж, но и списки и вообще все
итерируемые коллекции. Правда, для множеств и словарей не определен
порядок итерации, что может привести к багам.</p>

<p>Простой пример:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">point</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">point</span>
</code></pre></div></div>

<p>Данные часто собираются в группы. Например, точка – это два числа,
которые удобно хранить и передавать вместе. Результат функции тоже
может быть парой – флаг успеха и результат. В кортежи удобно собирать
права доступа, табличные данные.</p>

<p>Некоторые программисты теряются на этом месте и пишут классы, чтобы
группировать данные. Переход к классам уводит нас в противоположную
сторону от коллекций и всех их преимуществ. Лучше хранить данные в
коллекциях насколько это возможно.</p>

<p>Например, работаем с точками. Есть две точки, нужно вычислить
декартово расстояние. Решение в лоб:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">point1</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">point2</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">distance</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">):</span>
    <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="n">p1</span>
    <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">p2</span>
    <span class="p">...</span>

<span class="k">print</span> <span class="n">distance</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">)</span>
</code></pre></div></div>

<p>Хорошо, но лишние строки на распаковку. Решение в ООП-стиле:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Point</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">y</span>

    <span class="k">def</span> <span class="nf">distance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="c1"># use self.x, self.y, other.x, other.y
</span>        <span class="c1"># to refer variables
</span>        <span class="p">...</span>

<span class="n">p1</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">p2</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="k">print</span> <span class="n">p1</span><span class="p">.</span><span class="n">distance</span><span class="p">(</span><span class="n">p2</span><span class="p">)</span>
</code></pre></div></div>

<p>Лишние строки на класс. К тому же, я забыл добавить метод <code class="language-plaintext highlighter-rouge">__str__</code> и
во время дебага увижу что-то вроде <code class="language-plaintext highlighter-rouge">&lt;object Point at 0x523fw523&gt;</code>
вместо чисел. Матерясь, полезу дописывать метод и только увеличу
энтропию.</p>

<p>Самая простая, и потому лучшая реализация:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">point1</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">point2</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">distance</span><span class="p">((</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">),</span> <span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">)):</span>
    <span class="p">...</span>

<span class="k">print</span> <span class="n">distance</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">)</span>
</code></pre></div></div>

<p>Видим, что распаковка происходит на уровне сигнатуры. Это значит, в
теле функции уже доступны компоненты точек и остается только посчитать
значение.</p>

<p>Такая функция лучше защищена от неправильных аргументов. Если передать
кортеж не с двумя, а тремя компонентами, ошибка распаковки случится
раньше, еще до входа в функцию.</p>

<p>Деструктивный синтаксис следует принципу “явное лучше неявного”. Он
избавляет от долгих описаний вроде “аргумент <code class="language-plaintext highlighter-rouge">permission</code> – это
кортеж, где первый элемент то, второй се, третий…”. Сигнатура с
распаковкой скажет сама за себя.</p>

<p>Распаковывать кортежи можно и в лямбдах. Я пользуюсь этим для
обработки словарей, когда нужна пара ключ-значение:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s">'foo'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'bar'</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s">'baz'</span><span class="p">:</span> <span class="mi">3</span><span class="p">}</span>
<span class="n">process</span> <span class="o">=</span> <span class="k">lambda</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span> <span class="s">'key: %s, value: %d'</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
<span class="k">print</span> <span class="nb">map</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">data</span><span class="p">.</span><span class="n">iteritems</span><span class="p">())</span>
<span class="o">&gt;&gt;&gt;</span> <span class="p">[</span><span class="s">'key: baz, value: 3'</span><span class="p">,</span> <span class="s">'key: foo, value: 1'</span><span class="p">,</span> <span class="s">'key: bar, value: 2'</span><span class="p">]</span>
</code></pre></div></div>

<p>Деструктивный синтаксис сокращает код, делает его декларативным, а
значит, удобным в сопровождении.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/poverty/">О нищенском мышлении</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2016-03-14T00:00:00+00:00">
        Mar 14, 2016
    </time>

    <a href="/tag/poverty/" rel="tag">poverty</a>, <a href="/tag/credits/" rel="tag">credits</a>

</div>


            <div class="entry">
                
                    <p>На днях жена спросила, что такое нищенское мышление. Оказывается, на
одном сайте была дискуссия. Я почитал мнения и составил ответ. Он не
уместился в одно предложение. Вопрос заслуживает отдельного поста.</p>

<p>Ошибка считать, что нищий человек это тот, кто стремиться купить
дешевое. Это верно лишь отчасти. Я не считаю себя нищим, но не куплю
вещь только потому, что она дороже.</p>

<p>Например, недавно не купил одну вещь за 1700 рублей потому, что в
другом магазине видел за 400. В современной экономике подобный размах
цен вполне нормален.</p>

<p>Экономия свойственна не только бедным. Приведу в пример известных
людей. Билл Гейтц очень неприхотлив в одежде. Он как-то признался, что
каждая вещь в его гардеробе не дороже 10 долларов. Стив Джобс не
вылезал из водолазки и пары джинс. У Обамы дешевые часы. У Марка
Закерберга бюджетное авто.</p>

<p>Западный человек вообще по-другому обходится с деньгами и думает о
них. Деньги, как бы это выразить лучше, направлены внутрь него. Он
может зарабатывать много, но не стремиться показать это внешне
дорогими вещами. Думает, платить или нет лишний доллар.</p>

<p>Русский человек, только вчера вырвавшийся из советской нищеты, еще не
впитал культуру обращения с деньгами. Отсюда эти гротескные русские
туристы, сорящие деньгами. Они хотят показать, что денег много. При
этом на родине их финансовое положение может быть не таким уж
беспечным.</p>

<p>На мой взгляд, нищенское мышление – это такой ход мыслей, когда
человек остается бедным бесконечно долгое время.</p>

<p>С этим определением все становится на места. Но каким образом мыслит
нищий человек? Какие ошибки он совершает?</p>

<p>Раньше всего, это неспособность к финансовуму планированию. Нищий
человек знает план трат только на текущий месяц. К концу срока денег
нет, снова экономия до получки. И так до пенсии.</p>

<p>Упрощая, можно сказать, что беден тот, кто не накапливает денег. Даже
если человек зарабатывает в месяц миллион и все отдает на кредиты, он
остается бедным, потому что работает в ноль.</p>

<p>В защиту бедного гражданина можно сказать лишь то, что косвенно в этом
виновато и государство. Власти не выгодно, чтобы у граждан
накапливались деньги сразу по двум причинам.</p>

<p>Обеспеченный человек обладает иммунитетом против социального и
финансового давления. С ним сложнее договориться. С бедными не
разговаривают – приказывают.</p>

<p>Массовое сдерживание денег губительно для экономики. Чтобы граждане не
прятали деньги в матрас, искусственно создается инфляция. Неси в банк,
или через год потеряешь десятую часть сбережений.</p>

<p>Вот молодой человек окончил вуз. Жил на стипендию, помогали
родители. Начал работать, получает мало.  Через пять лет поднялся в
должности, стал откладывать, но женился. Свадьба, отпуск, денег
нет. Работает дальше, деньги уходят на обустройство, бытовую технику,
ремонт. Все купили, но рождаются дети. Теперь все деньги уходят на
врачей, сады, секции, школу, университет. Наконец, поднял детей, уже
начальник, а здоровье уже не то, угасли интересы.</p>

<p>Обвинять этого гипотетического гражданина мы не в праве, тем более что
он может быть честным, добрым, начитанным. Но факт в том, что прожил
он бедно.</p>

<p>Второе – это кредиты. Они тянут на финансовое дно и в перспективе
сделают бедным любого. Кредит для малоимущего – это как доза
наркоману со стажем.</p>

<p>Сегодня, когда население России стремительно нищает, как грибы после
дождя открываются сервисы микрозаймов. Это займы 600% годовых и распри
с коллекторами. Царапины на машинах, перерезанные провода, поджог
колясок. Люди на все это идут добровольно.</p>

<p>Кредит коррелирует с нищетой, это неизбежно. Рядом с каждым
объявлением о займе висит другое с оформлением банкротсва физлица. Это
переуступка долга, если кто не знал. Платишь за то, чтобы теперь быть
должным другому коллектору.</p>

<p>Когда иду по городу, вспоминаю Ильфа и Петрова. В уздном городе N были
только цирюльни и погребальные конторы, словно граждане рождались за
тем, чтобы побриться и умереть. А в крупных городах люди живут чтобы
брать кредиты, терпеть беспредел коллекторов и становиться банкротами.</p>

<p>Мы с Аленой поженились рано и первое время жили, так сказать,
скромно. У нее зарплата 8 тысяч, а у меня, бывало, еще меньше. Почти
все уходило на еду и редкие развлечения. При этом мы стабильно
откладывали 2-3 тысячи. В год набегало 25. Раз в несколько месяцев
покупали технику: микроволновку, фотоаппарат. И когда нам советовали
кредит, крутили пальцем у виска. Мы что, миллионеры, платить двойную
стоимость?</p>

<p>В школах нет уроков финансовой грамотности. И вообще этому нигде не
учат. Взрослые в отношении денег ведут себя как дети. Минутный восторг
от вещи им важней кредитной кабалы, под которой подписываются в
трезвом уме.</p>

<p>Вот что такое нищенское мышление. Давить его из себя беспощадно.</p>

                
            </div>

        </li>
        
        <li>

            <h2>
                <a class="post-link" href="/raml/">Что такое RAML и как он помогает проекту</a>
            </h2>

            
<div class="post-meta">

    <time class="post-time"
          datetime="2016-03-10T00:00:00+00:00">
        Mar 10, 2016
    </time>

    <a href="/tag/raml/" rel="tag">raml</a>, <a href="/tag/programming/" rel="tag">programming</a>

</div>


            <div class="entry">
                
                    <p>Расскажу об интересной штуке под названием <a href="http://raml.org/">RAML</a>. Использую
в текущем проекте и очень доволен. Технология молодая, информации в
сети мало, на русском вообще не попадалось.</p>

<p>Предположим, несколько сервисов сообщаются по HTTP API. Авторизация,
история операций, бизнес-транзакции. Сервисы принимают и отдают JSON,
сигнализируют об ошибках правильными статусами ответа. Нет
пользователя – 404, нет прав – 403, кривые данные
– 400. Классический рест.</p>

<p>Как составить документацию? Нужно перечислить все урлы. Указать
правила авторизации, заголовки, как правильно их составить. Для
каждого урла перечислить методы GET, POST, etc. Описать структуру
входных данных. Структуру ошибочных ответов. Добавить человеческое
описание каждого метода. И все это поддерживать в актуальном
состоянии.</p>

<p>Возможно, есть специалисты, которые ведут документацию правильно,
чтобы все было описано по пунктам и ничего не расползалось. Не нужно
уточнять детали, ответ сервера в точности такой, как написано. И
группа людей соблюдает все соглашения о ведении документации.</p>

<p>На практике я вижу обратное. Документация отстает от разработки. Текст
пишут в вики в ужасной разметке. Каждый человек придерживается особых
правил. На ретроспективе холиварят о том, как документировать
правильно.</p>

<p>RAML решает эти проблемы. Название означает REST API Markup
Language. Технически это YAML-документ с набором фич. Стандарт задает
жесткую структуру для описания рестовых апих. Разработчики держат этот
файл в гите и наполняют вместе с кодом. Во время билда особая утилита
переводит документ в формат HTML.</p>

<p>Перечислю достоинста технологии:</p>

<ol>
  <li>
    <p><strong>Структура.</strong> RAML – это стандарт, поэтому отсебятены в документе
быть не может. В группе разработчиков не будет конфликтов, как
описать схему запроса или входные параметры.</p>
  </li>
  <li>
    <p><strong>Формат YAML.</strong> Это лучший формат для конфигураций. Краток, удобен
для чтения. Поддерживает основные типы. Имеет списки,
словари. Поддерживает многострочные данные. Разрешает
комментарии. Не падает из-за лишней запятой на конце, как JSON.</p>
  </li>
  <li>
    <p><strong>Поддержка markdown.</strong> Описание к каждой сущности пишется в
маркдауне. Это самый простой язык разметки. Очень подходит для
вставки кода, простейшей структуры (заголовки, подзаголовки).</p>
  </li>
  <li>
    <p><strong>Инклуды.</strong> Большой файл легко декомпозировать на составные части
и подключать по частям директивой <code class="language-plaintext highlighter-rouge">include</code>. Более того, инклуд
поощрается стандартом, чтобы не дублировать сущности. Например,
любой <code class="language-plaintext highlighter-rouge">list</code>-метод (список сущностей методом <code class="language-plaintext highlighter-rouge">GET</code>) принимает
параметры <code class="language-plaintext highlighter-rouge">limit</code> и <code class="language-plaintext highlighter-rouge">offset</code>. Создаем отдельный файл с их
описанием, примерами. Подключаем к нужным методам инклуд,
компилируем. На выходе у каждого метода идентичное описание этих
параметров.</p>

    <p>Инклуды позволяют комбинировать документацию для разных
целей. Например, есть публичные апи, а есть внутренние. Описываем
каждую в отдельном файле. Создаем два документа. Первый для
заказчика, с инклудами только публичных апих. Второй для внутренних
нужд – только с инклудами внутренних.</p>
  </li>
  <li>
    <p><strong>Утилиты и экспорт.</strong> Документацию в RAML легко обрабатывать
машинным способом, потому что это стандарт, протокол. Уже
существует <a href="http://raml.org/projects/projects">пачка утилит</a> для работы с
форматом. Визуальные редакторы, генерация кода по заданным урлам,
плагины к редакторам и ИДЕ, и конечно, тулза для экспорта в
markdown и HTML.</p>
  </li>
  <li>
    <p><strong>JSON-схемы.</strong> Схема – лучший способ описать структуру
данных. Она заменит долгие списки и абзацы человеческого
языка. Схема декларативна – сложные структуры могут быть
представлены как ссылки на схемы проще. RAML поддерживает инклуд
схем.</p>
  </li>
  <li>
    <p><strong>Поддержка HTTP/REST.</strong> Стандарт знает все о заголовках и статусах
ответа. Красиво, когда документация покажет не только тело ответа,
но и статус с описанием, примеры заголовков.</p>
  </li>
</ol>

<p>Существует два версии формата: 0.8 и 1.0. Вторая предлагает больше
полей и возможностей для описания. Я пока что пользуюсь 0.8.</p>

<p>Рассмотрим простой пример. Пусть есть простая апиха. Вот что мы
напишем в заголовке файла <code class="language-plaintext highlighter-rouge">example.raml</code>:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#%RAML 0.8</span>
<span class="na">title</span><span class="pi">:</span> <span class="s">Some Title</span>
<span class="na">version</span><span class="pi">:</span> <span class="s">v3</span>
<span class="na">baseUri</span><span class="pi">:</span> <span class="s">https://example.com/api/v1/</span>
</code></pre></div></div>

<p>Добавим вводную документацию. Для каждого раздела укажем
подзаголовок. Ниже:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">documentation</span><span class="pi">:</span>
 <span class="pi">-</span> <span class="na">title</span><span class="pi">:</span> <span class="s">Main Title</span>
   <span class="na">content</span><span class="pi">:</span> <span class="pi">|</span>
     <span class="s">common notes on this document.</span>

 <span class="pi">-</span> <span class="na">title</span><span class="pi">:</span> <span class="s">Authorization</span>
   <span class="na">content</span><span class="pi">:</span> <span class="pi">|</span>
     <span class="s">Some text to describe HTTP headers to access data.</span>
     <span class="s">~~~</span>
     <span class="s">code goes here...</span>
     <span class="s">~~~</span>
</code></pre></div></div>

<p>Задекларируем правила авторизации. У нас в проекте это обычная базовая
авторизация по протоколу HTTPS. Стандарт RAML знает, что это такое:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">securitySchemes</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">Basic Authentication</span><span class="pi">:</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">Basic Authentication</span>
</code></pre></div></div>

<p>Теперь, описывая урл, можем просто состаться на этот тип
авторизации. В скомпилированном HTML-документе напротив урла будет
стоять замочек, а по клику откроется окошко с описанием правил
авторизации.</p>

<p>Начнем описывать урлы:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">/api/v1/user</span><span class="pi">:</span>
  <span class="na">securedBy</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">Basic Authentication</span><span class="pi">]</span>
  <span class="na">get</span><span class="pi">:</span>
    <span class="na">description</span><span class="pi">:</span> <span class="pi">|</span>
      <span class="s">Retrieves a list of users.</span>
      <span class="s">### Syntax</span>
      <span class="s">~~~</span>
      <span class="s">GET /api/v1/user/</span>
      <span class="s">Host: {host}</span>
      <span class="s">Authorization: {authorization}</span>
      <span class="s">~~~</span>
    <span class="na">queryParameters</span><span class="pi">:</span>
      <span class="kt">!include</span> <span class="s">user_list_params.raml</span>
    <span class="na">responses</span><span class="pi">:</span>
      <span class="na">200</span><span class="pi">:</span>
        <span class="na">body</span><span class="pi">:</span>
          <span class="s">application/json</span><span class="pi">:</span>
            <span class="na">example</span><span class="pi">:</span> <span class="kt">!include</span> <span class="s">examples/user_list_response.json</span>
            <span class="na">schema</span><span class="pi">:</span> <span class="kt">!include</span> <span class="s">schemas/user_list_response.json</span>
</code></pre></div></div>

<p>Все просто. Мы декларируем апиху, которая отдает список юзеров. Доступ
защищен базовой авторизацией. В описании пример запроса. Файл
<code class="language-plaintext highlighter-rouge">user_list_params.raml</code> содержит парамеры командной строки: лимит,
смещение, сортировка.</p>

<p>Схема ответа может быть большой, поэтому инклуд. В файле
<code class="language-plaintext highlighter-rouge">examples/user_list_response.json</code> лежит схема, примерно такая:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"$schema"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://json-schema.org/draft-04/schema#"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"additionalProperties"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
    </span><span class="nl">"definitions"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"item"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"additionalProperties"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
            </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                    </span><span class="nl">"minimum"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
                    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"integer"</span><span class="w">
                </span><span class="p">},</span><span class="w">
                </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                    </span><span class="nl">"maxLength"</span><span class="p">:</span><span class="w"> </span><span class="mi">64</span><span class="p">,</span><span class="w">
                    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w">
                </span><span class="p">}</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="nl">"required"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                </span><span class="s2">"id"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"name"</span><span class="w">
            </span><span class="p">],</span><span class="w">
            </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"object"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"count"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"minimum"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
            </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"integer"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"results"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"items"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nl">"$ref"</span><span class="p">:</span><span class="w"> </span><span class="s2">"#/definitions/item"</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"array"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"required"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"count"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"results"</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"object"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Смотрите, как удобно: в начале схемы декларируется тип юзера. Конечный
ответ – это массив таких сущностей.</p>

<p>Дальше документ очень удобно развивать. Добавлять методы (POST, PUT,
DELETE), ссылаться на уже определенные структуры, выносить повторы в
инклуды.</p>

<p>Скомпилируем документ в файл. Утилита <a href="https://github.com/raml2html/raml2html">raml2html</a>
написана на node.js и ставиться через npm. Компилим:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>raml2html example.raml &gt; example.html
</code></pre></div></div>

<p>Не нравится дефолтный шаблон? Можно передать свой:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>raml2html -t custom-templates/template.nunjucks -i example.raml -o example.html
</code></pre></div></div>

<p>В результате получим HTML-документ (<strong>UPD</strong> документ по ссылке удалили).</p>

<p>RAML действительно экономит время на составление документации. Технология
молода, но очень перспективна. Советую использовать уже сейчас.</p>


                
            </div>

        </li>
        
    </ul>

    <h4>
        
        <a href="/page41" class="previous">&larr;</a>
        
        <span class="page_number ">Страница 42 из 60</span>
        
        <a href="/page43" class="next">&rarr;</a>
        
    </h4>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Ivan Grishaev's blog</li>
          <li><a href="mailto:ivan@grishaev.me">ivan@grishaev.me</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
            <li><a href="https://github.com/igrishaev">GitHub</a></li>
            <li><a href="tg://resolve?domain=igrishaev_blog">Telegram</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Writing on programming, education, books and negotiations.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
